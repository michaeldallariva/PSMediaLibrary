; Script generated by the Inno Setup Script Wizard.
; SEE THE DOCUMENTATION FOR DETAILS ON CREATING INNO SETUP SCRIPT FILES!
; Non-commercial use only

#define MyAppName "NexusM Media Management"
#define MyAppVersion "0.92"
#define MyAppPublisher "NexusM Project"
#define MyAppURL "https://nexusm.org"

[Setup]
AppId={{26EF526E-3579-4D07-96DE-130EF76C3B83}
AppName={#MyAppName}
AppVersion={#MyAppVersion}
AppPublisher={#MyAppPublisher}
AppPublisherURL={#MyAppURL}
AppSupportURL={#MyAppURL}
AppUpdatesURL={#MyAppURL}

VersionInfoVersion={#MyAppVersion}.0
VersionInfoTextVersion={#MyAppVersion}
VersionInfoCompany={#MyAppPublisher}
VersionInfoDescription={#MyAppName} Setup
VersionInfoProductName={#MyAppName}

DefaultDirName={sd}\NexusM
DefaultGroupName={#MyAppName}
DisableProgramGroupPage=yes

PrivilegesRequired=admin
PrivilegesRequiredOverridesAllowed=dialog

OutputDir=C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM
OutputBaseFilename=nexusm_installer
SetupIconFile=C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\favicon.ico
SolidCompression=yes
DisableDirPage=no
WizardStyle=modern dark
WizardImageFile=C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\installer_banner.png


[UninstallDelete]
Type: filesandordirs; Name: "{app}"

[Languages]
Name: "english"; MessagesFile: "compiler:Default.isl"


[Files]
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\assets\*"; DestDir: "{app}\assets"; Flags: ignoreversion recursesubdirs createallsubdirs
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\templates\*"; DestDir: "{app}\templates"; Flags: ignoreversion recursesubdirs createallsubdirs
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\NexusM.ps1"; DestDir: "{app}"; Flags: ignoreversion
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\changelog.txt"; DestDir: "{app}"; Flags: ignoreversion
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\credit.txt"; DestDir: "{app}"; Flags: ignoreversion
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\instructions.txt"; DestDir: "{app}"; Flags: ignoreversion
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\favicon.ico"; DestDir: "{app}"; Flags: ignoreversion
Source: "C:\Users\Mick\Desktop\Powershell scripts\PSMediaLibrary\InnoSetup\NexusM\Files\version.txt"; DestDir: "{app}"; Flags: ignoreversion


[Run]
Filename: "{cmd}"; \
Parameters: "/c start """" /wait pwsh -NoProfile -ExecutionPolicy Bypass -Command ""Start-Process pwsh -Verb RunAs -ArgumentList '-NoProfile -ExecutionPolicy Bypass -File ""{app}\NexusM.ps1""'"""; \
WorkingDir: "{app}"; \
Description: "Finish NexusM setup (administrator rights required)"; \
Flags: postinstall waituntilterminated skipifsilent


[Code]

var
  PSPage: TWizardPage;
  PSLink: TNewStaticText;


procedure PSLinkClick(Sender: TObject);
var
  ResultCode: Integer;
begin
  ShellExec(
    'open',
    'https://learn.microsoft.com/en-us/powershell/scripting/install/install-powershell-on-windows',
    '',
    '',
    SW_SHOWNORMAL,
    ewNoWait,
    ResultCode
  );
end;


procedure InitializeWizard();
begin
  PSPage := CreateCustomPage(
    wpWelcome,
    'PowerShell Requirement',
    'NexusM requires PowerShell 7 to run'
  );

  with TNewStaticText.Create(PSPage) do
  begin
    Parent := PSPage.Surface;
    Caption :=
      'NexusM is built on PowerShell and requires PowerShell 7 or newer.'#13#10#13#10 +
      'If you do not have it installed yet, you can download it from Microsoft below:'#13#10;
    Top := ScaleY(10);
    Left := ScaleX(0);
    Width := PSPage.SurfaceWidth;
    WordWrap := True;
  end;

  PSLink := TNewStaticText.Create(PSPage);
  with PSLink do
  begin
    Parent := PSPage.Surface;
    Caption := 'ðŸ‘‰ Install PowerShell for Windows (Microsoft)';
    Font.Style := [fsUnderline];
    Font.Color := clBlue;
    Cursor := crHand;
    Top := ScaleY(80);
    Left := ScaleX(0);
    OnClick := @PSLinkClick;
  end;
end;


function BackupExistingInstall(): Boolean;
var
  SrcDir, BakDir: string;
begin
  Result := False;

  SrcDir := ExpandConstant('{app}');
  BakDir := SrcDir + '.bak';

  if DirExists(BakDir) then
  begin
    if not DelTree(BakDir, True, True, True) then
    begin
      MsgBox(
        'An existing backup folder (nexusm.bak) could not be removed.'#13#10 +
        'Please close any programs using it and try again.',
        mbCriticalError,
        MB_OK
      );
      Exit;
    end;
  end;

  if RenameFile(SrcDir, BakDir) then
    Result := True
  else
  MsgBox(
    'NexusM was detected but could not be backed up.'#13#10#13#10 +
    'The installer will continue by installing over the existing files.'#13#10 +
    'Please ensure NexusM is not running.',
    mbInformation,
    MB_OK
  );
end;


function PrepareToInstall(var NeedsRestart: Boolean): String;
var
  InstallDir: string;
  Choice: Integer;
begin
  Result := '';
  InstallDir := ExpandConstant('{app}');

  if DirExists(InstallDir) then
  begin
    Choice := MsgBox(
      'An existing NexusM installation was detected:'#13#10#13#10 +
      InstallDir + #13#10#13#10 +
      'YES  â†’ Backup existing folder (rename to nexusm.bak) and install fresh'#13#10 +
      'NO   â†’ Install on top of existing files'#13#10 +
      'CANCEL â†’ Abort installation',
      mbConfirmation,
      MB_YESNOCANCEL
    );

    case Choice of
      IDYES:
        begin
          if not BackupExistingInstall() then
            Result := 'Installation cancelled.';
        end;

      IDNO:
        begin
          { install over existing files }
        end;

      IDCANCEL:
        begin
          Result := 'Installation cancelled by user.';
        end;
    end;
  end;
end;

