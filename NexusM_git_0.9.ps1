<#
.SYNOPSIS
    NexusM - Advanced Media Library Manager with Web Interface and User Management
.DESCRIPTION
    A PowerShell-based media library management system with SQLite database,
    web interface, metadata fetching, intelligent media analysis, and multi-user support.
.EXAMPLES
    .\NexusM.ps1 ### Full manual prompt mode
    .\NexusM_v7_77.ps1 -Silent ### Just start without any prompt
    .\NexusM_v7_77.ps1 -NoScan -NoPosters -NoAlbumArt -NoPDFThumbnails -StartServer ### Just start and do nothing on Startup but you can mix
    .\NexusM_v7_77.ps1 -AutoScan -FetchPosters -ExtractAlbumArt -GeneratePDFThumbnails -StartServer ### Does everything on Startup
.NOTES
    Requires: PowerShell 7.x, PSSQLite module, Pode module, Ghostscript, ffmpeg, epub.min.js, jszip.min.js, video.min.js, video-js.min.css
    Author: Michael DALLA RIVA with the help of some AI / Blog : https://lafrenchaieti.com/
    Official NexusM Website : https://nexusm.org/
    Version: Beta v0.9 - Public Preview
    Release date : January 21, 2026
    License : See https://nexusm.org/ -- Commercial use prohibited!
#>


#Requires -Version 7.0

[CmdletBinding()]
param(
    [Parameter(HelpMessage="Automatically scan media folders on startup")]
    [switch]$AutoScan,
    
    [Parameter(HelpMessage="Skip media scan (explicit no-scan)")]
    [switch]$NoScan,
    
    [Parameter(HelpMessage="Automatically fetch movie posters from TMDB")]
    [switch]$FetchPosters,
    
    [Parameter(HelpMessage="Skip poster fetching (explicit no-fetch)")]
    [switch]$NoPosters,
    
    [Parameter(HelpMessage="Automatically extract album artwork from music files")]
    [switch]$ExtractAlbumArt,
    
    [Parameter(HelpMessage="Skip album art extraction (explicit no-extract)")]
    [switch]$NoAlbumArt,
    
    [Parameter(HelpMessage="Automatically generate eBook preview thumbnails")]
    [switch]$GeneratePDFThumbnails,
    
    [Parameter(HelpMessage="Skip PDF thumbnail generation (explicit no-generate)")]
    [switch]$NoPDFThumbnails,
    
    [Parameter(HelpMessage="Automatically start the web server")]
    [switch]$StartServer,
    
    [Parameter(HelpMessage="Skip web server startup (explicit no-start)")]
    [switch]$NoServer,
    
    [Parameter(HelpMessage="Run in silent mode (no prompts, start server only)")]
    [switch]$Silent
)

if ([string]::IsNullOrWhiteSpace($PSScriptRoot)) {
    Write-Host "[FATAL] PSScriptRoot is empty - script must be run from a file, not pasted into console" -ForegroundColor Red
    Write-Host "[INFO] Please run the script using: .\NexusM_v7_03.ps1" -ForegroundColor Yellow
    exit 1
}

# Store the script root early for use throughout the script
$Global:ScriptRootPath = $PSScriptRoot


$Global:NexusMLogPath = Join-Path $PSScriptRoot "logs\nexusm.log"

function Initialize-NexusMLog {
    $logsFolder = Join-Path $PSScriptRoot "logs"
    
    # Create logs folder if it doesn't exist
    if (-not (Test-Path $logsFolder)) {
        New-Item -ItemType Directory -Path $logsFolder -Force | Out-Null
    }
    
    # Check if log file exists and is older than 24 hours
    if (Test-Path $Global:NexusMLogPath) {
        $logAge = (Get-Date) - (Get-Item $Global:NexusMLogPath).LastWriteTime
        if ($logAge.TotalHours -ge 24) {
            # Reset the log file
            Remove-Item -Path $Global:NexusMLogPath -Force -ErrorAction SilentlyContinue
        }
    }
    
    # Write session header
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $header = @"
================================================================================
NexusM Log Session Started: $timestamp
================================================================================
"@
    Add-Content -Path $Global:NexusMLogPath -Value $header -Encoding UTF8
}

function Write-NexusMLog {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Message,
        
        [Parameter(Mandatory=$false)]
        [ValidateSet("INFO", "DEBUG", "WARNING", "ERROR")]
        [string]$Level = "INFO"
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] $Message"
    
    try {
        Add-Content -Path $Global:NexusMLogPath -Value $logEntry -Encoding UTF8
    }
    catch {
        # Silently fail if log file cannot be written
    }
}

# Initialize log on script load
Initialize-NexusMLog


# Global transcode log path
$Global:TranscodeLogPath = Join-Path $PSScriptRoot "logs\transcode.log"

function Initialize-TranscodeLog {

    $logsFolder = Join-Path $PSScriptRoot "logs"
    
    # Create logs folder if it doesn't exist
    if (-not (Test-Path $logsFolder)) {
        New-Item -ItemType Directory -Path $logsFolder -Force | Out-Null
    }
    
    # Check if log file exists and is older than 24 hours
    if (Test-Path $Global:TranscodeLogPath) {
        $logAge = (Get-Date) - (Get-Item $Global:TranscodeLogPath).LastWriteTime
        if ($logAge.TotalHours -ge 24) {
            # Reset the log file
            Remove-Item -Path $Global:TranscodeLogPath -Force -ErrorAction SilentlyContinue
        }
    }
}

function Write-TranscodeLog {

    param(
        [Parameter(Mandatory=$true)]
        [string]$Message,
        
        [Parameter(Mandatory=$false)]
        [ValidateSet("INFO", "DEBUG", "WARNING", "ERROR", "FFMPEG")]
        [string]$Level = "INFO",
        
        [Parameter(Mandatory=$false)]
        [switch]$NewSession
    )
    
    # Get log path - handle Pode runspace where global might not be set
    $logPath = $Global:TranscodeLogPath
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        # Try Pode state
        try {
            $logPath = Get-PodeState -Name 'TranscodeLogPath'
        } catch {
            $logPath = $null
        }
    }
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        # Try to construct path from Pode state MediaConfig first
        try {
            $podeConfig = Get-PodeState -Name 'MediaConfig'
            if ($podeConfig -and $podeConfig.ScriptRoot) {
                $logPath = Join-Path $podeConfig.ScriptRoot "logs\transcode.log"
            }
        } catch {
            $logPath = $null
        }
    }
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        # Try to construct path from CONFIG or PSScriptRoot
        $scriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { 
            $Global:CONFIG.ScriptRoot 
        } elseif ($PSScriptRoot) { 
            $PSScriptRoot 
        } else { 
            $null
        }
        if (-not [string]::IsNullOrWhiteSpace($scriptRoot)) {
            $logPath = Join-Path $scriptRoot "logs\transcode.log"
        }
    }
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        # Final fallback - return silently without logging
        return
    }
    
    # Ensure logs directory exists
    $logsDir = Split-Path -Parent $logPath
    if (-not (Test-Path $logsDir)) {
        New-Item -ItemType Directory -Path $logsDir -Force -ErrorAction SilentlyContinue | Out-Null
    }
    
    # Check for 24h rotation
    if (Test-Path $logPath) {
        try {
            $logAge = (Get-Date) - (Get-Item $logPath -ErrorAction SilentlyContinue).LastWriteTime
            if ($logAge.TotalHours -ge 24) {
                Remove-Item -Path $logPath -Force -ErrorAction SilentlyContinue
            }
        } catch { }
    }
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    
    try {
        # Build the log entry
        $logEntry = if ($Level -eq "FFMPEG") {
            "    FFmpeg: $Message"
        } else {
            "[$timestamp] [$Level] $Message"
        }
        
        # If new session, add separator first
        if ($NewSession) {
            $separator = @"

================================================================================
TRANSCODE SESSION: $timestamp
================================================================================
"@
            Add-Content -Path $logPath -Value $separator -Encoding UTF8 -ErrorAction SilentlyContinue
        }
        
        # Append to file (simpler and more reliable than prepending)
        Add-Content -Path $logPath -Value $logEntry -Encoding UTF8 -ErrorAction SilentlyContinue
    }
    catch {
        # Silently fail if log file cannot be written
    }
}

function Write-TranscodeLogAppend {

    param(
        [Parameter(Mandatory=$true)]
        [string]$Message,
        
        [Parameter(Mandatory=$false)]
        [ValidateSet("INFO", "DEBUG", "WARNING", "ERROR", "FFMPEG")]
        [string]$Level = "FFMPEG"
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    
    # Get log path - handle Pode runspace where global might not be set
    $logPath = $Global:TranscodeLogPath
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        try {
            $logPath = Get-PodeState -Name 'TranscodeLogPath'
        } catch {
            $logPath = $null
        }
    }
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        try {
            $podeConfig = Get-PodeState -Name 'MediaConfig'
            if ($podeConfig -and $podeConfig.ScriptRoot) {
                $logPath = Join-Path $podeConfig.ScriptRoot "logs\transcode.log"
            }
        } catch {
            $logPath = $null
        }
    }
    if ([string]::IsNullOrWhiteSpace($logPath)) {
        return  # Can't log without a valid path
    }
    
    try {
        $logEntry = if ($Level -eq "FFMPEG") {
            "    FFmpeg: $Message"
        } else {
            "[$timestamp] [$Level] $Message"
        }
        
        Add-Content -Path $logPath -Value $logEntry -Encoding UTF8
    }
    catch {
        # Silently fail
    }
}

# Initialize transcode log on script load
Initialize-TranscodeLog


$Global:UserSessions = [System.Collections.Concurrent.ConcurrentDictionary[string,object]]::new()
$Global:CurrentUser = $null


function Get-EncryptedPIN {
    param(
        [Parameter(Mandatory=$true)]
        [string]$PIN,
        
        [Parameter(Mandatory=$false)]
        [string]$Salt
    )
    
    if ([string]::IsNullOrWhiteSpace($Salt)) {
        # Generate random salt
        $saltBytes = New-Object byte[] 32
        $rng = [System.Security.Cryptography.RandomNumberGenerator]::Create()
        $rng.GetBytes($saltBytes)
        $Salt = [Convert]::ToBase64String($saltBytes)
    }
    
    $saltedPIN = $PIN + $Salt
    $sha256 = [System.Security.Cryptography.SHA256]::Create()
    $hashBytes = $sha256.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($saltedPIN))
    $hash = [Convert]::ToBase64String($hashBytes)
    
    return @{
        Hash = $hash
        Salt = $Salt
    }
}


function Test-PINCode {
    param(
        [Parameter(Mandatory=$true)]
        [string]$PIN,
        
        [Parameter(Mandatory=$true)]
        [string]$Hash,
        
        [Parameter(Mandatory=$true)]
        [string]$Salt
    )
    
    $encrypted = Get-EncryptedPIN -PIN $PIN -Salt $Salt
    return $encrypted.Hash -eq $Hash
}


function Initialize-UsersDatabase {
    param(
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath
    )
    
    try {
        # Create users directory if it doesn't exist
        $usersDir = Split-Path -Parent $DatabasePath
        if (-not (Test-Path $usersDir)) {
            New-Item -Path $usersDir -ItemType Directory -Force | Out-Null
        }
        
        # Create users table
        $createTableQuery = @"
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    pin_hash TEXT NOT NULL,
    pin_salt TEXT NOT NULL,
    user_type TEXT NOT NULL CHECK(user_type IN ('admin', 'guest')),
    created_date TEXT NOT NULL,
    last_login TEXT,
    is_active INTEGER DEFAULT 1,
    display_name TEXT,
    avatar_path TEXT
);
"@
        
        Invoke-SqliteQuery -DataSource $DatabasePath -Query $createTableQuery
        
        # Check if admin user exists
        $adminCheck = Invoke-SqliteQuery -DataSource $DatabasePath -Query "SELECT COUNT(*) as count FROM users WHERE user_type = 'admin'"
        
        if ($adminCheck.count -eq 0) {
            Write-Host "[i] No admin user found. Creating default admin user..." -ForegroundColor Yellow
            
            # Create default admin user with PIN: 000000
            $adminPIN = "000000"
            $encrypted = Get-EncryptedPIN -PIN $adminPIN
            
            $insertQuery = @"
INSERT INTO users (username, pin_hash, pin_salt, user_type, created_date, display_name)
VALUES ('admin', @pin_hash, @pin_salt, 'admin', @created_date, 'Administrator');
"@
            
            $params = @{
                pin_hash = $encrypted.Hash
                pin_salt = $encrypted.Salt
                created_date = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            }
            
            Invoke-SqliteQuery -DataSource $DatabasePath -Query $insertQuery -SqlParameters $params
            
            Write-Host "[✓] Default admin user created" -ForegroundColor Green
            Write-Host "    Username: admin" -ForegroundColor Cyan
            Write-Host "    PIN: 000000" -ForegroundColor Cyan
            Write-Host "    ⚠️  Please change this PIN immediately!" -ForegroundColor Yellow
            
            # Initialize admin's user database
            Initialize-UserDatabase -Username "admin"
        }
        
        # Verbose logging disabled:
        # Write-Host "[✓] Users database initialized: $DatabasePath" -ForegroundColor Green
        
    } catch {
        Write-Host "[✗] Failed to initialize users database: $_" -ForegroundColor Red
        throw
    }
}


$Global:ConnectedNetworkShares = @{}

function Protect-NetworkCredential {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Credential,
        
        [Parameter(Mandatory=$false)]
        [string]$Salt
    )
    
    try {
        if ([string]::IsNullOrWhiteSpace($Salt)) {
            $saltBytes = New-Object byte[] 32
            $rng = [System.Security.Cryptography.RandomNumberGenerator]::Create()
            $rng.GetBytes($saltBytes)
            $Salt = [Convert]::ToBase64String($saltBytes)
        }
        
        # Create machine-specific key
        $machineKey = $env:COMPUTERNAME + $env:USERNAME + $Salt
        $sha256 = [System.Security.Cryptography.SHA256]::Create()
        $keyBytes = $sha256.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($machineKey))
        
        # Generate IV
        $ivBytes = New-Object byte[] 16
        $rng = [System.Security.Cryptography.RandomNumberGenerator]::Create()
        $rng.GetBytes($ivBytes)
        $iv = [Convert]::ToBase64String($ivBytes)
        
        # Encrypt using AES-256
        $aes = [System.Security.Cryptography.Aes]::Create()
        $aes.Key = $keyBytes
        $aes.IV = $ivBytes
        
        $encryptor = $aes.CreateEncryptor()
        $credentialBytes = [System.Text.Encoding]::UTF8.GetBytes($Credential)
        $encryptedBytes = $encryptor.TransformFinalBlock($credentialBytes, 0, $credentialBytes.Length)
        $encrypted = [Convert]::ToBase64String($encryptedBytes)
        
        return @{
            Encrypted = $encrypted
            Salt = $Salt
            IV = $iv
        }
    }
    catch {
        Write-Host "[ERROR] Failed to encrypt credential: $_" -ForegroundColor Red
        return $null
    }
}

function Unprotect-NetworkCredential {
    param(
        [Parameter(Mandatory=$true)]
        [string]$EncryptedCredential,
        
        [Parameter(Mandatory=$true)]
        [string]$Salt,
        
        [Parameter(Mandatory=$true)]
        [string]$InitVector
    )
    
    try {
        # Recreate machine-specific key
        $machineKey = $env:COMPUTERNAME + $env:USERNAME + $Salt
        $sha256 = [System.Security.Cryptography.SHA256]::Create()
        $keyBytes = $sha256.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($machineKey))
        
        # Decrypt using AES-256
        $aes = [System.Security.Cryptography.Aes]::Create()
        $aes.Key = $keyBytes
        $aes.IV = [Convert]::FromBase64String($InitVector)
        
        $decryptor = $aes.CreateDecryptor()
        $encryptedBytes = [Convert]::FromBase64String($EncryptedCredential)
        $decryptedBytes = $decryptor.TransformFinalBlock($encryptedBytes, 0, $encryptedBytes.Length)
        $decrypted = [System.Text.Encoding]::UTF8.GetString($decryptedBytes)
        
        return $decrypted
    }
    catch {
        Write-Host "[ERROR] Failed to decrypt credential: $_" -ForegroundColor Red
        return $null
    }
}

function Initialize-SharesDatabase {
    param(
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath
    )
    
    try {
        # Create data directory if it doesn't exist
        $dataDir = Split-Path -Parent $DatabasePath
        if (-not (Test-Path $dataDir)) {
            New-Item -Path $dataDir -ItemType Directory -Force | Out-Null
        }
        
        $createTableQuery = @"
CREATE TABLE IF NOT EXISTS network_shares (
    share_id INTEGER PRIMARY KEY AUTOINCREMENT,
    share_name TEXT NOT NULL UNIQUE,
    share_type TEXT NOT NULL CHECK(share_type IN ('movies', 'music', 'pictures', 'pdfs', 'musicvideos')),
    share_path TEXT NOT NULL,
    username TEXT,
    password_encrypted TEXT,
    password_salt TEXT,
    password_iv TEXT,
    enabled INTEGER DEFAULT 1,
    created_date TEXT NOT NULL,
    last_tested TEXT,
    last_test_status TEXT
);
"@
        
        Invoke-SqliteQuery -DataSource $DatabasePath -Query $createTableQuery
        # Write-Host "[✓] Shares database initialized: $DatabasePath" -ForegroundColor Green
        return $true
    }
    catch {
        Write-Host "[ERROR] Failed to initialize shares database: $_" -ForegroundColor Red
        return $false
    }
}

function Migrate-SharesToNewDatabase {
    param(
        [Parameter(Mandatory=$true)]
        [string]$OldDatabasePath,
        
        [Parameter(Mandatory=$true)]
        [string]$NewDatabasePath
    )
    
    try {
        # Check if old database exists and has network_shares table
        if (-not (Test-Path $OldDatabasePath)) {
            return $false
        }
        
        # Check if network_shares table exists in old database
        $tableCheck = Invoke-SqliteQuery -DataSource $OldDatabasePath -Query @"
SELECT name FROM sqlite_master WHERE type='table' AND name='network_shares';
"@
        
        if (-not $tableCheck) {
            # No old shares table to migrate
            return $false
        }
        
        # Get all shares from old database
        $oldShares = Invoke-SqliteQuery -DataSource $OldDatabasePath -Query "SELECT * FROM network_shares"
        
        if (-not $oldShares -or $oldShares.Count -eq 0) {
            Write-NexusMLog "No shares found in old database to migrate"
            # Clean up empty table
            Invoke-SqliteQuery -DataSource $OldDatabasePath -Query "DROP TABLE IF EXISTS network_shares"
            return $false
        }
        
        Write-NexusMLog "Found $($oldShares.Count) shares in users.db - migrating to shares.db..."
        
        # Check if new database already has shares (avoid duplicate migration)
        $newShares = Invoke-SqliteQuery -DataSource $NewDatabasePath -Query "SELECT share_id FROM network_shares LIMIT 1" -ErrorAction SilentlyContinue
        
        if ($newShares) {
            Write-NexusMLog "shares.db already contains data - skipping migration"
            # Still clean up old table since migration was already done
            Invoke-SqliteQuery -DataSource $OldDatabasePath -Query "DROP TABLE IF EXISTS network_shares"
            Write-Host "[✓] Cleaned up old network_shares table from users.db" -ForegroundColor Green
            return $true
        }
        
        # Migrate each share
        $migrated = 0
        foreach ($share in $oldShares) {
            try {
                $insertQuery = @"
INSERT INTO network_shares (share_name, share_type, share_path, username, password_encrypted, password_salt, password_iv, enabled, created_date, last_tested, last_test_status)
VALUES (@share_name, @share_type, @share_path, @username, @password_encrypted, @password_salt, @password_iv, @enabled, @created_date, @last_tested, @last_test_status)
"@
                
                $params = @{
                    share_name = $share.share_name
                    share_type = $share.share_type
                    share_path = $share.share_path
                    username = $share.username
                    password_encrypted = $share.password_encrypted
                    password_salt = $share.password_salt
                    password_iv = $share.password_iv
                    enabled = $share.enabled
                    created_date = $share.created_date
                    last_tested = $share.last_tested
                    last_test_status = $share.last_test_status
                }
                
                Invoke-SqliteQuery -DataSource $NewDatabasePath -Query $insertQuery -SqlParameters $params
                $migrated++
            }
            catch {
                Write-Host "[!] Failed to migrate share '$($share.share_name)': $_" -ForegroundColor Yellow
            }
        }
        
        Write-Host "[✓] Migrated $migrated shares to shares.db" -ForegroundColor Green
        
        # Clean up old table from users.db
        Invoke-SqliteQuery -DataSource $OldDatabasePath -Query "DROP TABLE IF EXISTS network_shares"
        Write-Host "[✓] Cleaned up old network_shares table from users.db" -ForegroundColor Green
        
        return $true
    }
    catch {
        Write-Host "[ERROR] Migration failed: $_" -ForegroundColor Red
        return $false
    }
}

function Initialize-NetworkSharesTable {
    param(
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath
    )
    
    return Initialize-SharesDatabase -DatabasePath $DatabasePath
}

function Get-NetworkShares {
    param(
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath,
        
        [Parameter(Mandatory=$false)]
        [string]$ShareType,
        
        [Parameter(Mandatory=$false)]
        [switch]$EnabledOnly
    )
    
    try {
        $query = "SELECT * FROM network_shares WHERE 1=1"
        
        if ($ShareType) {
            $query += " AND share_type = @sharetype"
        }
        
        if ($EnabledOnly) {
            $query += " AND enabled = 1"
        }
        
        $query += " ORDER BY share_type, share_name"
        
        $params = @{}
        if ($ShareType) {
            $params['sharetype'] = $ShareType
        }
        
        $shares = Invoke-SqliteQuery -DataSource $DatabasePath -Query $query -SqlParameters $params
        return $shares
    }
    catch {
        Write-Host "[ERROR] Failed to get network shares: $_" -ForegroundColor Red
        return @()
    }
}

function Test-NetworkShareConnection {
    param(
        [Parameter(Mandatory=$true)]
        [string]$SharePath,
        
        [Parameter(Mandatory=$false)]
        [string]$Username,
        
        [Parameter(Mandatory=$false)]
        [string]$Password,
        
        [Parameter(Mandatory=$false)]
        [int]$TimeoutSeconds = 5
    )
    
    try {
        # Check if this is a UNC path (network share)
        $isNetworkPath = $SharePath -match '^\\\\' -or $SharePath -match '^//'
        
        if ($isNetworkPath -and (-not [string]::IsNullOrWhiteSpace($Username)) -and (-not [string]::IsNullOrWhiteSpace($Password))) {
            $null = & net use $SharePath /delete /y 2>&1
            
            # Now connect with credentials
            $connectResult = & net use $SharePath /user:$Username $Password 2>&1
            
            if ($LASTEXITCODE -eq 0) {
                # Connection successful, verify the path is accessible with timeout
                $testJob = Start-Job -ScriptBlock { param($p) Test-Path $p } -ArgumentList $SharePath
                $completed = Wait-Job $testJob -Timeout $TimeoutSeconds
                if ($completed) {
                    $pathExists = Receive-Job $testJob
                    Remove-Job $testJob -Force
                    if ($pathExists) {
                        return @{
                            Success = $true
                            Message = "Share is accessible (authenticated)"
                        }
                    } else {
                        return @{
                            Success = $false
                            Message = "Connected but path not accessible"
                        }
                    }
                } else {
                    Stop-Job $testJob
                    Remove-Job $testJob -Force
                    return @{
                        Success = $false
                        Message = "Connection timeout - share not responding"
                    }
                }
            } else {
                # Connection failed
                $errorMsg = ($connectResult | Out-String).Trim()
                return @{
                    Success = $false
                    Message = "Connection failed: $errorMsg"
                }
            }
        }
        else {
            if ($isNetworkPath) {
                $testJob = Start-Job -ScriptBlock { param($p) Test-Path $p } -ArgumentList $SharePath
                $completed = Wait-Job $testJob -Timeout $TimeoutSeconds
                if ($completed) {
                    $pathExists = Receive-Job $testJob
                    Remove-Job $testJob -Force
                    if ($pathExists) {
                        return @{
                            Success = $true
                            Message = "Share is accessible"
                        }
                    }
                } else {
                    Stop-Job $testJob
                    Remove-Job $testJob -Force
                    return @{
                        Success = $false
                        Message = "Connection timeout - share not responding"
                    }
                }
            } else {
                # Local path - Test-Path is safe
                if (Test-Path $SharePath) {
                    return @{
                        Success = $true
                        Message = "Share is accessible"
                    }
                }
            }
            
            return @{
                Success = $false
                Message = "Share not accessible"
            }
        }
    }
    catch {
        return @{
            Success = $false
            Message = "Error: $_"
        }
    }
}

function Ensure-NetworkShareConnected {
    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath,
        
        [Parameter(Mandatory=$false)]
        [string]$DatabasePath
    )
    
    # Check if this is a UNC path
    if (-not ($FilePath -match '^\\\\([^\\]+)\\([^\\]+)')) {
        return $true  # Local path, no connection needed
    }
    
    # Extract the share root (\\server\share)
    $server = $matches[1]
    $shareName = $matches[2]
    $shareRoot = "\\$server\$shareName"
    
    # Check if already connected in this session
    if ($Global:ConnectedNetworkShares.ContainsKey($shareRoot)) {
        $lastConnected = $Global:ConnectedNetworkShares[$shareRoot]
        # Re-authenticate if more than 30 minutes since last connection
        if ((Get-Date) - $lastConnected -lt [TimeSpan]::FromMinutes(30)) {
            return $true
        }
    }
    
    # Check if path is already accessible without credentials
    try {
        if (Test-Path $shareRoot -ErrorAction SilentlyContinue) {
            $Global:ConnectedNetworkShares[$shareRoot] = Get-Date
            return $true
        }
    }
    catch {
        # Path not accessible, continue to try with credentials
    }
    
    # Need to authenticate - find credentials from database
    if (-not $DatabasePath) {
        $DatabasePath = $CONFIG.SharesDB
    }
    
    if (-not $DatabasePath -or -not (Test-Path $DatabasePath)) {
        return $false
    }
    
    try {
        # Find a share that matches this path
        $shares = Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
SELECT * FROM network_shares WHERE enabled = 1 AND share_path LIKE @pathPattern
"@ -SqlParameters @{ pathPattern = "$shareRoot%" }
        
        if (-not $shares) {
            return $false
        }
        
        $share = if ($shares -is [System.Array]) { $shares[0] } else { $shares }
        
        # Decrypt password if exists
        if ($share.password_encrypted -and $share.password_salt -and $share.password_iv) {
            $password = Unprotect-NetworkCredential `
                -EncryptedCredential $share.password_encrypted `
                -Salt $share.password_salt `
                -InitVector $share.password_iv
            
            if ($share.username -and $password) {
                # Establish connection
                $null = & net use $shareRoot /delete /y 2>&1
                $connectResult = & net use $shareRoot /user:$($share.username) $password 2>&1
                
                if ($LASTEXITCODE -eq 0) {
                    $Global:ConnectedNetworkShares[$shareRoot] = Get-Date
                    Write-Host "  [✓] Connected to network share: $shareRoot" -ForegroundColor Green
                    return $true
                } else {
                    Write-Host "  [✗] Failed to connect to $shareRoot : $connectResult" -ForegroundColor Red
                    return $false
                }
            }
        }
        
        return $false
    }
    catch {
        Write-Host "  [✗] Error connecting to network share: $_" -ForegroundColor Red
        return $false
    }
}

function Test-AllMediaSharesStatus {
    param(
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath
    )
    
    Write-Host "`n=== Checking Media Share Status ===" -ForegroundColor Cyan
    
    # Initialize global status hashtable
    $Global:MediaShareStatus = @{
        movies = @{ Online = $false; Path = ""; Message = "Not configured" }
        music = @{ Online = $false; Path = ""; Message = "Not configured" }
        pictures = @{ Online = $false; Path = ""; Message = "Not configured" }
        pdfs = @{ Online = $false; Path = ""; Message = "Not configured" }
        musicvideos = @{ Online = $false; Path = ""; Message = "Not configured" }
        LastChecked = Get-Date
    }
    
    try {
        # Get all enabled shares
        $shares = Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
SELECT * FROM network_shares WHERE enabled = 1 ORDER BY share_type
"@
        
        if (-not $shares) {
            Write-Host "  [i] No enabled media shares found" -ForegroundColor Yellow
            return $Global:MediaShareStatus
        }
        
        # Ensure it's an array
        if ($shares -isnot [System.Array]) {
            $shares = @($shares)
        }
        
        foreach ($share in $shares) {
            $shareType = $share.share_type
            $sharePath = $share.share_path
            $shareName = $share.share_name
            
            # Map share_type to friendly display name
            $shareTypeDisplay = switch ($shareType) {
                'movies' { 'movies' }
                'music' { 'music' }
                'pictures' { 'pictures' }
                'pdfs' { 'ebooks' }
                'musicvideos' { 'musicvideos' }
                default { $shareType }
            }
            
            Write-Host "  Testing $shareName ($shareTypeDisplay): $sharePath" -ForegroundColor Gray -NoNewline
            
            # Decrypt password if exists
            $password = $null
            if ($share.password_encrypted -and $share.password_salt -and $share.password_iv) {
                try {
                    $password = Unprotect-NetworkCredential `
                        -EncryptedCredential $share.password_encrypted `
                        -Salt $share.password_salt `
                        -InitVector $share.password_iv
                }
                catch {
                    Write-Host " [!] Failed to decrypt credentials" -ForegroundColor Yellow
                }
            }
            
            # Test the connection
            $testResult = Test-NetworkShareConnection -SharePath $sharePath -Username $share.username -Password $password
            
            # Update global status
            $Global:MediaShareStatus[$shareType] = @{
                Online = $testResult.Success
                Path = $sharePath
                Message = $testResult.Message
                ShareName = $shareName
            }
            
            # Update database with test results
            $testTime = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
            try {
                Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
UPDATE network_shares 
SET last_tested = @testTime, last_test_status = @status 
WHERE share_id = @shareId
"@ -SqlParameters @{
                    testTime = $testTime
                    status = $testResult.Message
                    shareId = $share.share_id
                }
            }
            catch {
                # Silently continue if database update fails
            }
            
            # Display result
            if ($testResult.Success) {
                Write-Host " ✓ ONLINE" -ForegroundColor Green
            } else {
                Write-Host " ✗ OFFLINE" -ForegroundColor Red
            }
        }
        
        Write-Host ""
        return $Global:MediaShareStatus
    }
    catch {
        Write-Host "  [✗] Error testing media shares: $_" -ForegroundColor Red
        return $Global:MediaShareStatus
    }
}


function Get-MediaShareStatusHtml {
    $statusHtml = ""
    
    if (-not $Global:MediaShareStatus) {
        return ""
    }
    
    $mediaTypes = @(
        @{ Key = 'movies'; Label = 'Videos' }
        @{ Key = 'music'; Label = 'Music' }
        @{ Key = 'pictures'; Label = 'Pictures' }
        @{ Key = 'pdfs'; Label = 'PDFs' }
        @{ Key = 'musicvideos'; Label = 'Music Videos' }
    )
    
    foreach ($type in $mediaTypes) {
        $status = $Global:MediaShareStatus[$type.Key]
        if ($status) {
            if ($status.Online) {
                $statusHtml += "$($type.Label) - <span style='color: #22c55e !important; font-weight: 600;'>ONLINE</span><br/>"
            } else {
                $statusHtml += "$($type.Label) - <span style='color: #ef4444 !important; font-weight: 600;'>OFFLINE</span><br/>"
            }
        }
    }
    
    return $statusHtml
}

function Initialize-DefaultMediaPaths {
    param(
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath
    )
    
    try {
        # Define default paths for each media category
        $defaultPaths = @(
            @{ Type = 'pictures'; Path = 'D:\Share'; Name = 'PicturesFolder'; Description = 'Folder containing pictures/images' }
            @{ Type = 'movies'; Path = 'D:\Share'; Name = 'MoviesFolder'; Description = 'Folder containing video files' }
            @{ Type = 'music'; Path = 'D:\Share'; Name = 'MusicFolder'; Description = 'Folder containing music files' }
            @{ Type = 'pdfs'; Path = 'D:\Share'; Name = 'eBooksFolder'; Description = 'Folder containing eBooks documents' }
            @{ Type = 'musicvideos'; Path = 'D:\Share'; Name = 'MusicVideosFolder'; Description = 'Folder containing music video files' }
        )
        
        $created = 0
        
        foreach ($item in $defaultPaths) {
            # Check if ANY path for this category already exists in database
            $existing = Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
SELECT share_id FROM network_shares WHERE share_type = @type
"@ -SqlParameters @{ type = $item.Type }
            
            if ($existing) {
                continue
            }
            
            # Add default path to database
            Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
INSERT INTO network_shares (share_name, share_type, share_path, enabled, created_date, last_test_status)
VALUES (@name, @type, @path, 1, @created, @status)
"@ -SqlParameters @{
                name = $item.Name
                type = $item.Type
                path = $item.Path
                created = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
                status = "Default path - modify in Settings"
            }
            
            Write-Host "  [✓] Created default: $($item.Name) → $($item.Path)" -ForegroundColor Green
            $created++
        }
        
        return $created
    }
    catch {
        Write-Host "[ERROR] Failed to initialize default media paths: $_" -ForegroundColor Red
        return 0
    }
}

function Get-AllMediaPaths {
    param(
        [Parameter(Mandatory=$true)]
        [string]$MediaType,
        
        [Parameter(Mandatory=$true)]
        [string]$DatabasePath
    )
    
    try {
        $shares = Get-NetworkShares -DatabasePath $DatabasePath -ShareType $MediaType -EnabledOnly
        
        if ($null -eq $shares -or $shares.Count -eq 0) {
            return @()
        }
        
        # Ensure array
        if ($shares -isnot [System.Array]) {
            $shares = @($shares)
        }
        
        # Return just the paths
        $paths = @()
        foreach ($share in $shares) {
            if (-not [string]::IsNullOrWhiteSpace($share.share_path)) {
                $paths += $share.share_path
            }
        }
        
        return $paths
    }
    catch {
        Write-Host "[ERROR] Failed to get media paths: $_" -ForegroundColor Red
        return @()
    }
}

function Initialize-UserDatabase {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Username
    )
    
    try {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$Username.db"
        
        # Create watch progress table for videos
        $createVideoProgressQuery = @"
CREATE TABLE IF NOT EXISTS video_progress (
    progress_id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id INTEGER,
    video_path TEXT NOT NULL UNIQUE,
    video_title TEXT,
    poster_url TEXT,
    media_type TEXT DEFAULT 'movie',
    last_position_seconds REAL DEFAULT 0,
    duration_seconds REAL,
    percent_watched REAL DEFAULT 0,
    watch_count INTEGER DEFAULT 0,
    last_watched TEXT,
    completed INTEGER DEFAULT 0,
    manually_marked INTEGER DEFAULT 0
);
"@
        
        # Create music listening history
        $createMusicHistoryQuery = @"
CREATE TABLE IF NOT EXISTS music_history (
    history_id INTEGER PRIMARY KEY AUTOINCREMENT,
    music_path TEXT NOT NULL UNIQUE,
    artist TEXT,
    title TEXT,
    album TEXT,
    play_count INTEGER DEFAULT 0,
    last_played TEXT,
    total_play_time_seconds REAL DEFAULT 0,
    FOREIGN KEY (music_path) REFERENCES music(path)
);
"@
        
        # Create radio listening history
        $createRadioHistoryQuery = @"
CREATE TABLE IF NOT EXISTS radio_history (
    history_id INTEGER PRIMARY KEY AUTOINCREMENT,
    radio_url TEXT NOT NULL UNIQUE,
    radio_name TEXT,
    listen_count INTEGER DEFAULT 0,
    last_listened TEXT,
    total_listen_time_seconds REAL DEFAULT 0
);
"@
        
        # Create favorites table (v3.8 - expanded for all media types)
        $createFavoritesQuery = @"
CREATE TABLE IF NOT EXISTS favorites (
    favorite_id INTEGER PRIMARY KEY AUTOINCREMENT,
    media_type TEXT NOT NULL CHECK(media_type IN ('movie', 'tv', 'musicvideo', 'music', 'picture', 'pdf', 'radio', 'tvchannel')),
    media_id INTEGER,
    filepath TEXT,
    title TEXT,
    poster_url TEXT,
    added_date TEXT NOT NULL,
    UNIQUE(media_type, media_id),
    UNIQUE(media_type, filepath)
);
"@
        
        # Create watched table (v3.8 - track watched status for movies, tv, music videos)
        $createWatchedQuery = @"
CREATE TABLE IF NOT EXISTS watched (
    watched_id INTEGER PRIMARY KEY AUTOINCREMENT,
    media_type TEXT NOT NULL CHECK(media_type IN ('movie', 'tv', 'musicvideo')),
    media_id INTEGER,
    filepath TEXT,
    title TEXT,
    watched_date TEXT NOT NULL,
    UNIQUE(media_type, media_id),
    UNIQUE(media_type, filepath)
);
"@
        
        # Create user preferences
        $createPreferencesQuery = @"
CREATE TABLE IF NOT EXISTS preferences (
    pref_key TEXT PRIMARY KEY,
    pref_value TEXT
);
"@
        
        # Create playlists table
        $createPlaylistsQuery = @"
CREATE TABLE IF NOT EXISTS playlists (
    playlist_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    created_date TEXT NOT NULL,
    modified_date TEXT NOT NULL,
    track_count INTEGER DEFAULT 0
);
"@
        
        # Create playlist tracks table
        $createPlaylistTracksQuery = @"
CREATE TABLE IF NOT EXISTS playlist_tracks (
    track_id INTEGER PRIMARY KEY AUTOINCREMENT,
    playlist_id INTEGER NOT NULL,
    music_id INTEGER NOT NULL,
    music_path TEXT NOT NULL,
    title TEXT,
    artist TEXT,
    album TEXT,
    track_order INTEGER NOT NULL,
    added_date TEXT NOT NULL,
    FOREIGN KEY (playlist_id) REFERENCES playlists(playlist_id) ON DELETE CASCADE
);
"@
        
        # Execute all table creations
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createVideoProgressQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createMusicHistoryQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createRadioHistoryQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createFavoritesQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createWatchedQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createPreferencesQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createPlaylistsQuery
        Invoke-SqliteQuery -DataSource $userDbPath -Query $createPlaylistTracksQuery
        
        # Migrate favorites table if needed (v3.8 schema update)
        try {
            $favColumns = Invoke-SqliteQuery -DataSource $userDbPath -Query "PRAGMA table_info(favorites)"
            $favColumnNames = $favColumns | ForEach-Object { $_.name }
            
            # Check if old schema (has item_type instead of media_type)
            if ($favColumnNames -contains 'item_type') {
                Write-NexusMLog "Migrating favorites table to v3.8 schema..."
                # Rename old table, create new, migrate data
                Invoke-SqliteQuery -DataSource $userDbPath -Query "ALTER TABLE favorites RENAME TO favorites_old"
                Invoke-SqliteQuery -DataSource $userDbPath -Query $createFavoritesQuery
                # Note: Old data won't migrate cleanly due to schema changes, but that's OK for favorites
                Invoke-SqliteQuery -DataSource $userDbPath -Query "DROP TABLE IF EXISTS favorites_old"
                Write-Host "[✓] Favorites table migrated to v3.8 schema" -ForegroundColor Green
            }
            
            # Add poster_url column if missing
            if ($favColumnNames -notcontains 'poster_url' -and $favColumnNames -contains 'media_type') {
                Invoke-SqliteQuery -DataSource $userDbPath -Query "ALTER TABLE favorites ADD COLUMN poster_url TEXT"
                Write-NexusMLog "Added poster_url column to favorites"
            }
        } catch {
            # Table doesn't exist or other error, ignore
        }
        
        # Migrate existing video_progress table if needed (add new columns for older databases)
        try {
            $columns = Invoke-SqliteQuery -DataSource $userDbPath -Query "PRAGMA table_info(video_progress)"
            $columnNames = $columns | ForEach-Object { $_.name }
            
            if ($columnNames -notcontains 'video_id') {
                Invoke-SqliteQuery -DataSource $userDbPath -Query "ALTER TABLE video_progress ADD COLUMN video_id INTEGER"
                Write-NexusMLog "Added video_id column to video_progress"
            }
            if ($columnNames -notcontains 'poster_url') {
                Invoke-SqliteQuery -DataSource $userDbPath -Query "ALTER TABLE video_progress ADD COLUMN poster_url TEXT"
                Write-NexusMLog "Added poster_url column to video_progress"
            }
            if ($columnNames -notcontains 'media_type') {
                Invoke-SqliteQuery -DataSource $userDbPath -Query "ALTER TABLE video_progress ADD COLUMN media_type TEXT DEFAULT 'movie'"
                Write-NexusMLog "Added media_type column to video_progress"
            }
            if ($columnNames -notcontains 'manually_marked') {
                Invoke-SqliteQuery -DataSource $userDbPath -Query "ALTER TABLE video_progress ADD COLUMN manually_marked INTEGER DEFAULT 0"
                Write-NexusMLog "Added manually_marked column to video_progress"
            }
            
            $indexes = Invoke-SqliteQuery -DataSource $userDbPath -Query "PRAGMA index_list(video_progress)"
            $hasUniqueIndex = $false
            foreach ($idx in $indexes) {
                if ($idx.unique -eq 1) {
                    $idxInfo = Invoke-SqliteQuery -DataSource $userDbPath -Query "PRAGMA index_info('$($idx.name)')"
                    if ($idxInfo -and $idxInfo.name -eq 'video_path') {
                        $hasUniqueIndex = $true
                        break
                    }
                }
            }
            
            # Also check table definition for inline UNIQUE constraint
            $tableInfo = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT sql FROM sqlite_master WHERE type='table' AND name='video_progress'"
            $hasInlineUnique = $tableInfo.sql -match 'video_path\s+TEXT\s+[^,]*UNIQUE'
            
            if (-not $hasUniqueIndex -and -not $hasInlineUnique) {
                Write-NexusMLog "Migrating video_progress table to enforce UNIQUE constraint on video_path..."
                
                # Step 1: Remove duplicates, keeping only the most recently watched entry for each video_path
                $removeDuplicatesQuery = @"
DELETE FROM video_progress 
WHERE progress_id NOT IN (
    SELECT progress_id FROM (
        SELECT progress_id, video_path, 
               ROW_NUMBER() OVER (PARTITION BY video_path ORDER BY last_watched DESC, progress_id DESC) as rn
        FROM video_progress
    ) WHERE rn = 1
);
"@
                try {
                    Invoke-SqliteQuery -DataSource $userDbPath -Query $removeDuplicatesQuery
                    $remainingCount = (Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT COUNT(*) as count FROM video_progress").count
                    Write-Host "[i] Removed duplicate video_progress entries (kept most recent). Remaining: $remainingCount" -ForegroundColor Yellow
                } catch {
                    # ROW_NUMBER might not be available in older SQLite versions, use alternative approach
                    Write-Host "[i] Using alternative duplicate removal method..." -ForegroundColor Yellow
                    $altRemoveDuplicatesQuery = @"
DELETE FROM video_progress 
WHERE progress_id NOT IN (
    SELECT MAX(progress_id) FROM video_progress GROUP BY video_path
);
"@
                    Invoke-SqliteQuery -DataSource $userDbPath -Query $altRemoveDuplicatesQuery
                    $remainingCount = (Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT COUNT(*) as count FROM video_progress").count
                    Write-Host "[i] Removed duplicate video_progress entries. Remaining: $remainingCount" -ForegroundColor Yellow
                }
                
                # Step 2: Create a unique index to prevent future duplicates
                try {
                    Invoke-SqliteQuery -DataSource $userDbPath -Query "CREATE UNIQUE INDEX IF NOT EXISTS idx_video_progress_path ON video_progress(video_path)"
                    Write-Host "[✓] Created UNIQUE index on video_progress.video_path" -ForegroundColor Green
                } catch {
                    Write-Host "[!] Could not create unique index (may already exist or still have duplicates): $_" -ForegroundColor Yellow
                }
            }
        } catch {
            # Migration errors are non-fatal
            Write-Host "[!] Migration warning: $_" -ForegroundColor Yellow
        }
        
        # Verbose logging disabled:
        # Write-Host "[✓] User database initialized for: $Username" -ForegroundColor Green
        
    } catch {
        Write-Host "[✗] Failed to initialize user database for $Username : $_" -ForegroundColor Red
        throw
    }
}

function New-UserAccount {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Username,
        
        [Parameter(Mandatory=$true)]
        [string]$PIN,
        
        [Parameter(Mandatory=$true)]
        [ValidateSet('admin', 'guest')]
        [string]$UserType,
        
        [Parameter(Mandatory=$false)]
        [string]$DisplayName
    )
    
    try {
        # Validate PIN format (6 digits, numbers only)
        if ($PIN -notmatch '^\d{6}$') {
            throw "PIN must be exactly 6 digits (numbers only)"
        }
        
        # Check if username already exists
        $existingUser = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT COUNT(*) as count FROM users WHERE username = @username" -SqlParameters @{ username = $Username }
        
        if ($existingUser.count -gt 0) {
            throw "Username '$Username' already exists"
        }
        
        # Encrypt PIN
        $encrypted = Get-EncryptedPIN -PIN $PIN
        
        # Use username as display name if not provided
        if ([string]::IsNullOrWhiteSpace($DisplayName)) {
            $DisplayName = $Username
        }
        
        # Insert new user
        $insertQuery = @"
INSERT INTO users (username, pin_hash, pin_salt, user_type, created_date, display_name)
VALUES (@username, @pin_hash, @pin_salt, @user_type, @created_date, @display_name);
"@
        
        $params = @{
            username = $Username
            pin_hash = $encrypted.Hash
            pin_salt = $encrypted.Salt
            user_type = $UserType
            created_date = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            display_name = $DisplayName
        }
        
        Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query $insertQuery -SqlParameters $params
        
        # Initialize user's database
        Initialize-UserDatabase -Username $Username
        
        Write-Host "[✓] User '$Username' created successfully" -ForegroundColor Green
        return $true
        
    } catch {
        Write-Host "[✗] Failed to create user: $_" -ForegroundColor Red
        return $false
    }
}

function Invoke-UserAuthentication {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Username,
        
        [Parameter(Mandatory=$true)]
        [string]$PIN
    )
    
    try {
        # Get user from database
        $user = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
SELECT user_id, username, pin_hash, pin_salt, user_type, display_name, is_active
FROM users
WHERE username = @username AND is_active = 1
"@ -SqlParameters @{ username = $Username }
        
        if (-not $user) {
            return $null
        }
        
        # Validate PIN
        if (Test-PINCode -PIN $PIN -Hash $user.pin_hash -Salt $user.pin_salt) {
            # Update last login
            Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
UPDATE users SET last_login = @last_login WHERE user_id = @user_id
"@ -SqlParameters @{
                user_id = $user.user_id
                last_login = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            }
            
            # Create session object
            $session = @{
                UserId = $user.user_id
                Username = $user.username
                UserType = $user.user_type
                DisplayName = $user.display_name
                AvatarPath = $user.avatar_path
                LoginTime = Get-Date
                SessionId = [Guid]::NewGuid().ToString()
                UserDbPath = Join-Path $CONFIG.UsersDBPath "$($user.username).db"
            }
            
            return $session
        }
        
        return $null
        
    } catch {
        Write-Host "[✗] Authentication error: $_" -ForegroundColor Red
        return $null
    }
}

function Update-VideoProgress {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VideoPath,
        
        [Parameter(Mandatory=$true)]
        [double]$PositionSeconds,
        
        [Parameter(Mandatory=$false)]
        [double]$DurationSeconds,
        
        [Parameter(Mandatory=$false)]
        [string]$VideoTitle,
        
        [Parameter(Mandatory=$false)]
        $VideoId,
        
        [Parameter(Mandatory=$false)]
        [string]$PosterUrl,
        
        [Parameter(Mandatory=$false)]
        [string]$MediaType = 'movie',
        
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    if (-not $UserSession) {
        Write-Host "[!] No user session for video progress tracking" -ForegroundColor Yellow
        return
    }
    
    try {
        $percentWatched = 0
        if ($DurationSeconds -gt 0) {
            $percentWatched = [math]::Min(100, ($PositionSeconds / $DurationSeconds) * 100)
        }
        
        $completed = if ($percentWatched -ge 90) { 1 } else { 0 }
        
        # Convert VideoId to int if it's a string
        $videoIdInt = if ($VideoId) { [int]$VideoId } else { $null }
        
    
        $upsertQuery = @"
INSERT INTO video_progress (video_id, video_path, video_title, poster_url, media_type, last_position_seconds, duration_seconds, percent_watched, watch_count, last_watched, completed)
VALUES (@video_id, @video_path, @video_title, @poster_url, @media_type, @position, @duration, @percent, 1, @timestamp, @completed)
ON CONFLICT(video_path) DO UPDATE SET
    video_id = COALESCE(@video_id, video_id),
    last_position_seconds = @position,
    duration_seconds = @duration,
    percent_watched = @percent,
    watch_count = CASE WHEN @completed = 1 AND completed = 0 THEN watch_count + 1 ELSE watch_count END,
    last_watched = @timestamp,
    completed = CASE WHEN manually_marked = 1 THEN completed ELSE @completed END,
    video_title = COALESCE(@video_title, video_title),
    poster_url = COALESCE(@poster_url, poster_url),
    media_type = COALESCE(@media_type, media_type);
"@
        
        $params = @{
            video_id = $videoIdInt
            video_path = $VideoPath
            video_title = $VideoTitle
            poster_url = $PosterUrl
            media_type = $MediaType
            position = $PositionSeconds
            duration = $DurationSeconds
            percent = [math]::Round($percentWatched, 2)
            timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            completed = $completed
        }
        
        Invoke-SqliteQuery -DataSource $UserSession.UserDB -Query $upsertQuery -SqlParameters $params
        
    } catch {
        Write-Host "[✗] Failed to update video progress: $_" -ForegroundColor Red
    }
}

function Update-MusicHistory {
    param(
        [Parameter(Mandatory=$true)]
        [string]$MusicPath,
        
        [Parameter(Mandatory=$false)]
        [string]$Artist,
        
        [Parameter(Mandatory=$false)]
        [string]$Title,
        
        [Parameter(Mandatory=$false)]
        [string]$Album,
        
        [Parameter(Mandatory=$false)]
        [double]$PlayTimeSeconds = 0,
        
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    if (-not $UserSession) {
        return
    }
    
    try {
        $upsertQuery = @"
INSERT INTO music_history (music_path, artist, title, album, play_count, last_played, total_play_time_seconds)
VALUES (@music_path, @artist, @title, @album, 1, @timestamp, @play_time)
ON CONFLICT(music_path) DO UPDATE SET
    play_count = play_count + 1,
    last_played = @timestamp,
    total_play_time_seconds = total_play_time_seconds + @play_time,
    artist = COALESCE(@artist, artist),
    title = COALESCE(@title, title),
    album = COALESCE(@album, album);
"@
        
        $params = @{
            music_path = $MusicPath
            artist = $Artist
            title = $Title
            album = $Album
            timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            play_time = $PlayTimeSeconds
        }
        
        Invoke-SqliteQuery -DataSource $UserSession.UserDB -Query $upsertQuery -SqlParameters $params
        
    } catch {
        Write-Host "[✗] Failed to update music history: $_" -ForegroundColor Red
    }
}

function Update-RadioHistory {
    param(
        [Parameter(Mandatory=$true)]
        [string]$RadioUrl,
        
        [Parameter(Mandatory=$false)]
        [string]$RadioName,
        
        [Parameter(Mandatory=$false)]
        [double]$ListenTimeSeconds = 0,
        
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    if (-not $UserSession) {
        return
    }
    
    try {
        $upsertQuery = @"
INSERT INTO radio_history (radio_url, radio_name, listen_count, last_listened, total_listen_time_seconds)
VALUES (@radio_url, @radio_name, 1, @timestamp, @listen_time)
ON CONFLICT(radio_url) DO UPDATE SET
    listen_count = listen_count + 1,
    last_listened = @timestamp,
    total_listen_time_seconds = total_listen_time_seconds + @listen_time,
    radio_name = COALESCE(@radio_name, radio_name);
"@
        
        $params = @{
            radio_url = $RadioUrl
            radio_name = $RadioName
            timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
            listen_time = $ListenTimeSeconds
        }
        
        Invoke-SqliteQuery -DataSource $UserSession.UserDB -Query $upsertQuery -SqlParameters $params
        
    } catch {
        Write-Host "[✗] Failed to update radio history: $_" -ForegroundColor Red
    }
}

function Get-UserTopMusic {
    param(
        [Parameter(Mandatory=$false)]
        [int]$Limit = 10,
        
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    if (-not $UserSession) {
        return @()
    }
    
    try {
        $query = @"
SELECT 
    music_path,
    artist,
    title,
    album,
    play_count,
    last_played,
    total_play_time_seconds
FROM music_history
ORDER BY play_count DESC, last_played DESC
LIMIT @limit;
"@
        
        $result = Invoke-SqliteQuery -DataSource $UserSession.UserDB -Query $query -SqlParameters @{ limit = $Limit }
        return $result
        
    } catch {
        Write-Host "[✗] Failed to get top music: $_" -ForegroundColor Red
        return @()
    }
}


function Get-UserTopRadios {
    param(
        [Parameter(Mandatory=$false)]
        [int]$Limit = 10,
        
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    if (-not $UserSession) {
        return @()
    }
    
    try {
        $query = @"
SELECT 
    radio_url,
    radio_name,
    listen_count,
    last_listened,
    total_listen_time_seconds
FROM radio_history
ORDER BY listen_count DESC, last_listened DESC
LIMIT @limit;
"@
        
        $result = Invoke-SqliteQuery -DataSource $UserSession.UserDB -Query $query -SqlParameters @{ limit = $Limit }
        return $result
        
    } catch {
        Write-Host "[✗] Failed to get top radios: $_" -ForegroundColor Red
        return @()
    }
}


function Get-UserWatchedMovies {
    param(
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    if (-not $UserSession) {
        return @()
    }
    
    try {
        $query = @"
SELECT 
    video_path,
    video_title,
    last_position_seconds,
    duration_seconds,
    percent_watched,
    watch_count,
    last_watched,
    completed
FROM video_progress
ORDER BY last_watched DESC;
"@
        
        $result = Invoke-SqliteQuery -DataSource $UserSession.UserDB -Query $query
        return $result
        
    } catch {
        Write-Host "[✗] Failed to get watched movies: $_" -ForegroundColor Red
        return @()
    }
}

function Show-UserManagementMenu {
    if (-not $Global:CurrentUser -or $Global:CurrentUser.UserType -ne 'admin') {
        Write-Host "`n[✗] Access denied. Admin privileges required." -ForegroundColor Red
        return
    }
    
    while ($true) {
        Write-Host "`n╔════════════════════════════════════════╗" -ForegroundColor Cyan
        Write-Host "║      USER MANAGEMENT MENU              ║" -ForegroundColor Cyan
        Write-Host "╠════════════════════════════════════════╣" -ForegroundColor Cyan
        Write-Host "║  1. List All Users                     ║" -ForegroundColor White
        Write-Host "║  2. Create New User                    ║" -ForegroundColor White
        Write-Host "║  3. Delete User                        ║" -ForegroundColor White
        Write-Host "║  4. Change User PIN                    ║" -ForegroundColor White
        Write-Host "║  5. Change User Type (Admin/Guest)     ║" -ForegroundColor White
        Write-Host "║  6. Disable/Enable User                ║" -ForegroundColor White
        Write-Host "║  7. View User Statistics               ║" -ForegroundColor White
        Write-Host "║  0. Back to Main Menu                  ║" -ForegroundColor Yellow
        Write-Host "╚════════════════════════════════════════╝" -ForegroundColor Cyan
        
        $choice = Read-Host "`nSelect option"
        
        switch ($choice) {
            '1' {
                # List all users
                $users = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
SELECT user_id, username, display_name, user_type, created_date, last_login, is_active
FROM users
ORDER BY user_type DESC, username;
"@
                
                Write-Host "`n=== All Users ===" -ForegroundColor Cyan
                foreach ($user in $users) {
                    $status = if ($user.is_active -eq 1) { "Active" } else { "Disabled" }
                    $statusColor = if ($user.is_active -eq 1) { "Green" } else { "Red" }
                    
                    Write-Host "`n  ID: $($user.user_id)" -ForegroundColor Gray
                    Write-Host "  Username: $($user.username)" -ForegroundColor White
                    Write-Host "  Display Name: $($user.display_name)" -ForegroundColor White
                    Write-Host "  Type: $($user.user_type)" -ForegroundColor $(if ($user.user_type -eq 'admin') { 'Yellow' } else { 'Cyan' })
                    Write-Host "  Status: $status" -ForegroundColor $statusColor
                    Write-Host "  Created: $($user.created_date)" -ForegroundColor Gray
                    Write-Host "  Last Login: $($user.last_login)" -ForegroundColor Gray
                }
            }
            
            '2' {
                # Create new user
                Write-Host "`n=== Create New User ===" -ForegroundColor Cyan
                $newUsername = Read-Host "Enter username"
                
                if ([string]::IsNullOrWhiteSpace($newUsername)) {
                    Write-Host "[✗] Username cannot be empty" -ForegroundColor Red
                    continue
                }
                
                $newDisplayName = Read-Host "Enter display name (press Enter to use username)"
                if ([string]::IsNullOrWhiteSpace($newDisplayName)) {
                    $newDisplayName = $newUsername
                }
                
                Write-Host "`nUser Types:" -ForegroundColor Yellow
                Write-Host "  1. Admin (full access)" -ForegroundColor Cyan
                Write-Host "  2. Guest (read-only settings)" -ForegroundColor Cyan
                $typeChoice = Read-Host "Select user type (1/2)"
                
                $newUserType = switch ($typeChoice) {
                    '1' { 'admin' }
                    '2' { 'guest' }
                    default { 'guest' }
                }
                
                $newPIN = Read-Host "Enter 6-digit PIN (numbers only)"
                
                if ($newPIN -notmatch '^\d{6}$') {
                    Write-Host "[✗] PIN must be exactly 6 digits" -ForegroundColor Red
                    continue
                }
                
                $confirmPIN = Read-Host "Confirm PIN"
                
                if ($newPIN -ne $confirmPIN) {
                    Write-Host "[✗] PINs do not match" -ForegroundColor Red
                    continue
                }
                
                New-UserAccount -Username $newUsername -PIN $newPIN -UserType $newUserType -DisplayName $newDisplayName
            }
            
            '3' {
                # Delete user
                Write-Host "`n=== Delete User ===" -ForegroundColor Cyan
                $deleteUsername = Read-Host "Enter username to delete"
                
                # Prevent deleting current user
                if ($deleteUsername -eq $Global:CurrentUser.Username) {
                    Write-Host "[✗] Cannot delete currently logged in user" -ForegroundColor Red
                    continue
                }
                
                # Prevent deleting last admin
                $adminCount = (Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT COUNT(*) as count FROM users WHERE user_type = 'admin' AND is_active = 1").count
                $targetUser = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT user_type FROM users WHERE username = @username" -SqlParameters @{ username = $deleteUsername }
                
                if ($targetUser.user_type -eq 'admin' -and $adminCount -le 1) {
                    Write-Host "[✗] Cannot delete the last admin user" -ForegroundColor Red
                    continue
                }
                
                $confirm = Read-Host "Are you sure you want to delete user '$deleteUsername'? (yes/no)"
                
                if ($confirm -eq 'yes') {
                    try {
                        # Delete user from database
                        Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "DELETE FROM users WHERE username = @username" -SqlParameters @{ username = $deleteUsername }
                        
                        # Delete user's database file
                        $userDbPath = Join-Path $CONFIG.UsersDBPath "$deleteUsername.db"
                        if (Test-Path $userDbPath) {
                            Remove-Item -Path $userDbPath -Force
                        }
                        
                        Write-Host "[✓] User '$deleteUsername' deleted successfully" -ForegroundColor Green
                        
                    } catch {
                        Write-Host "[✗] Failed to delete user: $_" -ForegroundColor Red
                    }
                }
            }
            
            '4' {
                # Change user PIN
                Write-Host "`n=== Change User PIN ===" -ForegroundColor Cyan
                $targetUsername = Read-Host "Enter username"
                
                $newPIN = Read-Host "Enter new 6-digit PIN (numbers only)"
                
                if ($newPIN -notmatch '^\d{6}$') {
                    Write-Host "[✗] PIN must be exactly 6 digits" -ForegroundColor Red
                    continue
                }
                
                $confirmPIN = Read-Host "Confirm new PIN"
                
                if ($newPIN -ne $confirmPIN) {
                    Write-Host "[✗] PINs do not match" -ForegroundColor Red
                    continue
                }
                
                try {
                    $encrypted = Get-EncryptedPIN -PIN $newPIN
                    
                    Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
UPDATE users SET pin_hash = @pin_hash, pin_salt = @pin_salt
WHERE username = @username
"@ -SqlParameters @{
                        username = $targetUsername
                        pin_hash = $encrypted.Hash
                        pin_salt = $encrypted.Salt
                    }
                    
                    Write-Host "[✓] PIN updated successfully for user '$targetUsername'" -ForegroundColor Green
                    
                } catch {
                    Write-Host "[✗] Failed to update PIN: $_" -ForegroundColor Red
                }
            }
            
            '5' {
                # Change user type
                Write-Host "`n=== Change User Type ===" -ForegroundColor Cyan
                $targetUsername = Read-Host "Enter username"
                
                # Prevent changing current user's type
                if ($targetUsername -eq $Global:CurrentUser.Username) {
                    Write-Host "[✗] Cannot change your own user type" -ForegroundColor Red
                    continue
                }
                
                Write-Host "`nUser Types:" -ForegroundColor Yellow
                Write-Host "  1. Admin (full access)" -ForegroundColor Cyan
                Write-Host "  2. Guest (read-only settings)" -ForegroundColor Cyan
                $typeChoice = Read-Host "Select new user type (1/2)"
                
                $newType = switch ($typeChoice) {
                    '1' { 'admin' }
                    '2' { 'guest' }
                    default { $null }
                }
                
                if ($newType) {
                    # Check if changing last admin to guest
                    $targetUser = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT user_type FROM users WHERE username = @username" -SqlParameters @{ username = $targetUsername }
                    $adminCount = (Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT COUNT(*) as count FROM users WHERE user_type = 'admin' AND is_active = 1").count
                    
                    if ($targetUser.user_type -eq 'admin' -and $newType -eq 'guest' -and $adminCount -le 1) {
                        Write-Host "[✗] Cannot change the last admin to guest" -ForegroundColor Red
                        continue
                    }
                    
                    try {
                        Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
UPDATE users SET user_type = @user_type WHERE username = @username
"@ -SqlParameters @{
                            username = $targetUsername
                            user_type = $newType
                        }
                        
                        Write-Host "[✓] User type updated successfully for '$targetUsername'" -ForegroundColor Green
                        
                    } catch {
                        Write-Host "[✗] Failed to update user type: $_" -ForegroundColor Red
                    }
                }
            }
            
            '6' {
                # Disable/Enable user
                Write-Host "`n=== Disable/Enable User ===" -ForegroundColor Cyan
                $targetUsername = Read-Host "Enter username"
                
                # Prevent disabling current user
                if ($targetUsername -eq $Global:CurrentUser.Username) {
                    Write-Host "[✗] Cannot disable currently logged in user" -ForegroundColor Red
                    continue
                }
                
                $user = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT is_active, user_type FROM users WHERE username = @username" -SqlParameters @{ username = $targetUsername }
                
                if ($user) {
                    # Prevent disabling last admin
                    $adminCount = (Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT COUNT(*) as count FROM users WHERE user_type = 'admin' AND is_active = 1").count
                    
                    if ($user.user_type -eq 'admin' -and $user.is_active -eq 1 -and $adminCount -le 1) {
                        Write-Host "[✗] Cannot disable the last active admin user" -ForegroundColor Red
                        continue
                    }
                    
                    $newStatus = if ($user.is_active -eq 1) { 0 } else { 1 }
                    $action = if ($newStatus -eq 1) { "enable" } else { "disable" }
                    
                    $confirm = Read-Host "Are you sure you want to $action user '$targetUsername'? (yes/no)"
                    
                    if ($confirm -eq 'yes') {
                        try {
                            Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
UPDATE users SET is_active = @is_active WHERE username = @username
"@ -SqlParameters @{
                                username = $targetUsername
                                is_active = $newStatus
                            }
                            
                            Write-Host "[✓] User '$targetUsername' ${action}d successfully" -ForegroundColor Green
                            
                        } catch {
                            Write-Host "[✗] Failed to $action user: $_" -ForegroundColor Red
                        }
                    }
                }
                else {
                    Write-Host "[✗] User not found" -ForegroundColor Red
                }
            }
            
            '7' {
                # View user statistics
                Write-Host "`n=== User Statistics ===" -ForegroundColor Cyan
                $targetUsername = Read-Host "Enter username (or press Enter for all users)"
                
                if ([string]::IsNullOrWhiteSpace($targetUsername)) {
                    # Show stats for all users
                    $users = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT username FROM users WHERE is_active = 1 ORDER BY username"
                    
                    foreach ($user in $users) {
                        Show-UserStats -Username $user.username
                    }
                }
                else {
                    Show-UserStats -Username $targetUsername
                }
            }
            
            '0' {
                return
            }
            
            default {
                Write-Host "`n[✗] Invalid option" -ForegroundColor Red
            }
        }
        
        Read-Host "`nPress Enter to continue"
    }
}

function Show-UserStats {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Username
    )
    
    $userDbPath = Join-Path $CONFIG.UsersDBPath "$Username.db"
    
    if (-not (Test-Path $userDbPath)) {
        Write-Host "`n[!] No statistics available for user '$Username'" -ForegroundColor Yellow
        return
    }
    
    try {
        Write-Host "`n┌─────────────────────────────────────────┐" -ForegroundColor Cyan
        Write-Host "│ Statistics for: $($Username.PadRight(24)) │" -ForegroundColor Cyan
        Write-Host "└─────────────────────────────────────────┘" -ForegroundColor Cyan
        
        # Video stats
        $videoStats = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as total_watched,
    SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed_count,
    SUM(watch_count) as total_plays,
    AVG(percent_watched) as avg_completion
FROM video_progress
"@
        
        Write-Host "`n📹 Video Statistics:" -ForegroundColor Yellow
        Write-Host "   Videos Watched: $($videoStats.total_watched)" -ForegroundColor White
        Write-Host "   Completed: $($videoStats.completed_count)" -ForegroundColor White
        Write-Host "   Total Plays: $($videoStats.total_plays)" -ForegroundColor White
        Write-Host "   Avg Completion: $([math]::Round($videoStats.avg_completion, 1))%" -ForegroundColor White
        
        # Music stats
        $musicStats = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as unique_tracks,
    SUM(play_count) as total_plays,
    SUM(total_play_time_seconds) as total_time
FROM music_history
"@
        
        Write-Host "`n🎵 Music Statistics:" -ForegroundColor Yellow
        Write-Host "   Unique Tracks: $($musicStats.unique_tracks)" -ForegroundColor White
        Write-Host "   Total Plays: $($musicStats.total_plays)" -ForegroundColor White
        $musicHours = [math]::Round($musicStats.total_time / 3600, 1)
        Write-Host "   Total Listen Time: $musicHours hours" -ForegroundColor White
        
        # Radio stats
        $radioStats = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as unique_stations,
    SUM(listen_count) as total_listens,
    SUM(total_listen_time_seconds) as total_time
FROM radio_history
"@
        
        Write-Host "`n📻 Radio Statistics:" -ForegroundColor Yellow
        Write-Host "   Unique Stations: $($radioStats.unique_stations)" -ForegroundColor White
        Write-Host "   Total Listens: $($radioStats.total_listens)" -ForegroundColor White
        $radioHours = [math]::Round($radioStats.total_time / 3600, 1)
        Write-Host "   Total Listen Time: $radioHours hours" -ForegroundColor White
        
        # Top 5 music tracks
        $topMusic = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT artist, title, play_count
FROM music_history
ORDER BY play_count DESC
LIMIT 5
"@
        
        if ($topMusic) {
            Write-Host "`n🎼 Top 5 Music Tracks:" -ForegroundColor Yellow
            $rank = 1
            foreach ($track in $topMusic) {
                $artistTitle = if ($track.artist -and $track.title) {
                    "$($track.artist) - $($track.title)"
                } elseif ($track.title) {
                    $track.title
                } else {
                    "(Unknown)"
                }
                Write-Host "   $rank. $artistTitle ($($track.play_count) plays)" -ForegroundColor White
                $rank++
            }
        }
        
    } catch {
        Write-Host "`n[✗] Error retrieving stats: $_" -ForegroundColor Red
    }
}

# Global variables for async streaming
$Global:RunspacePool = $null
$Global:ActiveStreams = [System.Collections.Concurrent.ConcurrentDictionary[string,object]]::new()
$Global:StreamCleanupTimer = $null

function Initialize-AsyncStreaming {
    if ($null -eq $Global:RunspacePool) {
        $Global:RunspacePool = [runspacefactory]::CreateRunspacePool(1, 10)
        $Global:RunspacePool.ApartmentState = "MTA"
        $Global:RunspacePool.Open()
        
        # Start cleanup timer for orphaned streams
        if ($null -eq $Global:StreamCleanupTimer) {
            $Global:StreamCleanupTimer = [System.Timers.Timer]::new(30000)
            
            Register-ObjectEvent -InputObject $Global:StreamCleanupTimer -EventName Elapsed -Action {
                try {
                    $now = Get-Date
                    $toRemove = @()
                    
                    foreach ($kvp in $Global:ActiveStreams.GetEnumerator()) {
                        $stream = $kvp.Value
                        
                        if ($stream.PSObject.Properties.Name -contains 'StartTime') {
                            $age = ($now - $stream.StartTime).TotalMinutes
                            if ($age -gt 5) {
                                $toRemove += $kvp.Key
                            }
                        }
                        
                        if ($stream.PSObject.Properties.Name -contains 'PowerShell') {
                            if ($stream.PowerShell.InvocationStateInfo.State -eq 'Completed' -or 
                                $stream.PowerShell.InvocationStateInfo.State -eq 'Failed') {
                                $toRemove += $kvp.Key
                            }
                        }
                    }
                    
                    foreach ($key in $toRemove) {
                        $removed = $null
                        if ($Global:ActiveStreams.TryRemove($key, [ref]$removed)) {
                            try {
                                if ($removed.PowerShell) {
                                    $removed.PowerShell.Stop()
                                    $removed.PowerShell.Dispose()
                                }
                                
                                if ($removed.TempDir -and (Test-Path $removed.TempDir)) {
                                    Remove-Item -Path $removed.TempDir -Recurse -Force -ErrorAction SilentlyContinue
                                }
                            } catch {}
                        }
                    }
                    
                    $tempBase = Join-Path $env:TEMP "PSMediaLibrary_Stream_*"
                    Get-ChildItem -Path $tempBase -Directory -ErrorAction SilentlyContinue | ForEach-Object {
                        if ((Get-Date) - $_.CreationTime -gt [TimeSpan]::FromMinutes(10)) {
                            Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
                        }
                    }
                    
                    # Clean up old HLS transcoding directories
                    $hlsBase = Join-Path $PSScriptRoot "hls_temp"
                    if (Test-Path $hlsBase) {
                        Get-ChildItem -Path $hlsBase -Directory -ErrorAction SilentlyContinue | ForEach-Object {
                            # Check if transcode is still active
                            $dirName = $_.Name
                            $isActive = $Global:ActiveTranscodes.ContainsKey($dirName)
                            
                            if (-not $isActive) {
                                # Check age - remove if older than 10 minutes
                                if ((Get-Date) - $_.CreationTime -gt [TimeSpan]::FromMinutes(10)) {
                                    Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
                                }
                            }
                            # NOTE: Removed segment cleanup for active transcodes
                            # We keep ALL segments for EVENT-type HLS to allow seeking
                        }
                    }
                    
                } catch {}
            } | Out-Null
            
            $Global:StreamCleanupTimer.Start()
        }
        
    }
}

function Cleanup-AsyncStreaming {
    # Stop cleanup timer
    if ($null -ne $Global:StreamCleanupTimer) {
        $Global:StreamCleanupTimer.Stop()
        $Global:StreamCleanupTimer.Dispose()
        $Global:StreamCleanupTimer = $null
    }
    
    if ($null -ne $Global:RunspacePool) {
        Write-NexusMLog "Stopping async streams..."
        foreach ($kvp in $Global:ActiveStreams.GetEnumerator()) {
            try {
                $kvp.Value.PowerShell.Stop()
                $kvp.Value.PowerShell.Dispose()
                
                # Clean up temp files
                if ($kvp.Value.TempDir -and (Test-Path $kvp.Value.TempDir)) {
                    Remove-Item -Path $kvp.Value.TempDir -Recurse -Force -ErrorAction SilentlyContinue
                }
            } catch {}
        }
        
        $Global:RunspacePool.Close()
        $Global:RunspacePool.Dispose()
        $Global:RunspacePool = $null
        $Global:ActiveStreams.Clear()
    }
}

# Global transcoding configuration - ADD TO YOUR CONFIG SECTION
$Global:TranscodingConfig = @{
    # FFmpeg path
    FFmpegPath = Join-Path $PSScriptRoot "tools\ffmpeg\bin\ffmpeg.exe"
    FFprobePath = Join-Path $PSScriptRoot "tools\ffmpeg\bin\ffprobe.exe"
    
    # Hardware acceleration settings
    EnableHardwareAccel = $true
    PreferredEncoder = "auto"  # Options: "auto", "nvenc", "qsv", "amf", "software"
    # NOTE: "auto" will detect your GPU and test hardware encoders
    #       Auto-detection priority: NVENC (NVIDIA) > QSV (Intel) > AMF (AMD) > Software
    #       Set to "software" to force CPU encoding (most compatible)
    
    # Transcoding quality settings
    VideoCodec = "h264"  # Output codec
    VideoPreset = "veryfast"  # For software: ultrafast, superfast, veryfast, faster, fast, medium, slow
    # Using "veryfast" for better real-time performance
    VideoCRF = 23  # Constant Rate Factor (18-28, lower = better quality, 23 is default)
    VideoMaxrate = "5M"  # Max bitrate for hardware encoding
    VideoBufsize = "10M"  # Buffer size for hardware encoding
    
    # Audio settings - optimized for downmixing surround to stereo
    AudioCodec = "aac"
    AudioBitrate = "192k"  # Increased from 128k for better quality when downmixing 5.1 to stereo
    AudioChannels = 2
    
    # Performance settings
    ThreadCount = 0  # 0 = auto-detect optimal thread count
    MaxConcurrentTranscodes = 2  # Max simultaneous transcoding sessions
    FFmpegCPULimit = 0  # CPU usage limit (0-100 percent, 0=no limit)
    LookaheadThreads = 0  # x264 lookahead threads (0=auto based on thread count, 1-16 for manual control)
    
    TranscodeMaxHeight = 0  # 0 = no limit (keep original), 1080 = limit to 1080p, 720 = limit to 720p
    
    VerboseTranscodeLog = $true
    
    # HTS (HTTP Live Streaming) settings - OPTIMIZED
    HTSSegmentDuration = 4      # Seconds per segment (reduced for faster startup)
    HTSMaxSegments = 5          # Maximum segments to keep (prevents temp file buildup!)
    HTSBufferSize = 8192        # Buffer size for file I/O (8KB chunks for smooth streaming)
    HTSPlaylistMaxEntries = 10  # Max entries in m3u8 playlist
    
    # HLS Cache Settings (v3.6 - Plex-style persistent cache)
    HLSCacheEnabled = $true         # Enable persistent caching
    HLSCacheMaxSizeGB = 100         # Maximum cache size in GB
    HLSCacheRetentionDays = 90      # Days to keep cached segments
    HLSCachePath = $null            # Set during initialization (hls_cache folder)
    
    # Formats that need transcoding (MP4/M4V are handled via codec checking)
    TranscodeFormats = @('.mkv', '.avi', '.wmv', '.flv', '.mov', '.mpg', '.mpeg', '.vob', '.ts', '.webm', '.divx', '.3gp')
}

# Active transcoding processes
$Global:ActiveTranscodes = [System.Collections.Concurrent.ConcurrentDictionary[string,object]]::new()
$Global:FFmpegCapabilities = $null
$Global:DetectedGPU = $null
$Global:HLSCacheDB = $null  # SQLite connection for HLS cache metadata
$Global:TranscodeSemaphore = $null


function Initialize-HLSCacheDatabase {
    param(
        [string]$ScriptRoot = $PSScriptRoot
    )
    
    # Set cache path
    $cachePath = Join-Path $ScriptRoot "hls_cache"
    $Global:TranscodingConfig.HLSCachePath = $cachePath
    
    # Create cache directory if it doesn't exist
    if (-not (Test-Path $cachePath)) {
        New-Item -ItemType Directory -Path $cachePath -Force | Out-Null
        Write-Host "[✓] Created HLS cache directory: $cachePath" -ForegroundColor Green
    }
    
    # Database path
    $dbPath = Join-Path $cachePath "hls_cache.db"
    
    try {
        # Create/open database
        $createTableSQL = @"
CREATE TABLE IF NOT EXISTS hls_cache (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    video_id TEXT NOT NULL,
    video_path TEXT NOT NULL,
    transcode_id TEXT NOT NULL UNIQUE,
    cache_folder TEXT NOT NULL,
    playlist_file TEXT,
    segment_count INTEGER DEFAULT 0,
    total_size_bytes INTEGER DEFAULT 0,
    video_duration REAL DEFAULT 0,
    created_at TEXT NOT NULL,
    last_accessed TEXT NOT NULL,
    completed INTEGER DEFAULT 0,
    encoder_used TEXT,
    resolution TEXT,
    -- Source file validation fields (v3.6.1)
    source_file_size INTEGER DEFAULT 0,
    source_file_modified TEXT,
    source_video_codec TEXT,
    source_audio_codec TEXT,
    transcode_crf INTEGER DEFAULT 23,
    transcode_preset TEXT
);

CREATE INDEX IF NOT EXISTS idx_hls_video_id ON hls_cache(video_id);
CREATE INDEX IF NOT EXISTS idx_hls_last_accessed ON hls_cache(last_accessed);
CREATE INDEX IF NOT EXISTS idx_hls_created_at ON hls_cache(created_at);
"@
        
        Invoke-SqliteQuery -DataSource $dbPath -Query $createTableSQL -ErrorAction Stop
        
        Write-Host "[✓] HLS cache database initialized: $dbPath" -ForegroundColor Green
        Write-NexusMLog "HLS cache database ready at: $dbPath"
        
        # Store database path for later use
        $Global:HLSCacheDBPath = $dbPath
        
        $maxConcurrent = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.MaxConcurrentTranscodes) {
            $Global:TranscodingConfig.MaxConcurrentTranscodes
        } else {
            2  # Default to 2 concurrent transcodes
        }
        $Global:TranscodeSemaphore = New-Object System.Threading.SemaphoreSlim($maxConcurrent, $maxConcurrent)
        Write-Host "[✓] Transcode concurrency limit: $maxConcurrent simultaneous transcodes" -ForegroundColor Green
        Write-NexusMLog "Transcode semaphore initialized (max: $maxConcurrent concurrent)"
        
        return $true
    }
    catch {
        Write-Host "[!] Failed to initialize HLS cache database: $_" -ForegroundColor Red
        Write-NexusMLog "HLS cache database error: $_" -Level "ERROR"
        return $false
    }
}

function Test-HLSCacheComplete {

    param(
        [Parameter(Mandatory=$true)]
        [string]$CacheFolder,
        [string]$TranscodeId = ""
    )
    
    try {
        # Check 1: Cache folder exists
        if (-not (Test-Path $CacheFolder)) {
            Write-NexusMLog "Cache validation failed: folder missing - $CacheFolder" -Level "WARNING"
            return $false
        }
        
        # Check 2: Playlist exists
        $playlistPath = Join-Path $CacheFolder "playlist.m3u8"
        if (-not (Test-Path $playlistPath)) {
            Write-NexusMLog "Cache validation failed: playlist.m3u8 missing - $TranscodeId" -Level "WARNING"
            return $false
        }
        
        # Check 3: Playlist contains ENDLIST (FFmpeg finished)
        $playlistContent = Get-Content -Path $playlistPath -Raw -ErrorAction SilentlyContinue
        if (-not $playlistContent -or $playlistContent -notmatch '#EXT-X-ENDLIST') {
            Write-NexusMLog "Cache validation failed: playlist missing #EXT-X-ENDLIST - $TranscodeId" -Level "WARNING"
            return $false
        }
        
        # Check 4: init.mp4 exists (fMP4 mode) or segments exist
        $initPath = Join-Path $CacheFolder "init.mp4"
        $hasInit = Test-Path $initPath
        
        # Get segment files (fMP4 .m4s or legacy .ts)
        $segments = Get-ChildItem -Path $CacheFolder -Filter "*.m4s" -ErrorAction SilentlyContinue
        if (-not $segments -or $segments.Count -eq 0) {
            $segments = Get-ChildItem -Path $CacheFolder -Filter "*.ts" -ErrorAction SilentlyContinue
        }
        
        $segmentCount = if ($segments) { $segments.Count } else { 0 }
        
        if (-not $hasInit -and $segmentCount -eq 0) {
            Write-NexusMLog "Cache validation failed: no segments found - $TranscodeId" -Level "WARNING"
            return $false
        }
        

        $expectedSegments = ([regex]::Matches($playlistContent, '#EXTINF')).Count
        
        if ($expectedSegments -gt 0 -and $segmentCount -lt ($expectedSegments - 1)) {
            Write-NexusMLog "Cache validation failed: segment count mismatch - expected ~$expectedSegments, found $segmentCount - $TranscodeId" -Level "WARNING"
            return $false
        }
        
        # Minimum segment sanity check (a valid transcode should have at least 3 segments)
        if ($segmentCount -lt 3 -and $expectedSegments -ge 3) {
            Write-NexusMLog "Cache validation failed: too few segments ($segmentCount) - $TranscodeId" -Level "WARNING"
            return $false
        }
        
        # All checks passed
        Write-NexusMLog "Cache validation passed: $TranscodeId (ENDLIST, $segmentCount/$expectedSegments segments, $(if ($hasInit) { 'fMP4' } else { 'MPEG-TS' }))"
        return $true
    }
    catch {
        Write-NexusMLog "Cache validation error: $_ - $TranscodeId" -Level "ERROR"
        return $false
    }
}

function Get-HLSCacheEntry {
    param(
        [Parameter(Mandatory=$true)]
        [string]$VideoId,
        [Parameter(Mandatory=$true)]
        [string]$VideoPath,
        [Parameter(Mandatory=$false)]
        [switch]$RequireComplete
    )
    
    # v7.15 FIX: Get HLSCacheDBPath from Pode state if global not set (runspace isolation fix)
    if (-not $Global:HLSCacheDBPath) {
        try {
            $Global:HLSCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $Global:HLSCacheDBPath = $null
        }
    }
    
    if (-not $Global:HLSCacheDBPath -or -not (Test-Path $Global:HLSCacheDBPath)) {
        return $null
    }
    
    # Get source file info for validation
    if (-not (Test-Path -LiteralPath $VideoPath)) {
        return $null
    }
    
    $sourceFile = Get-Item -LiteralPath $VideoPath -ErrorAction SilentlyContinue
    if (-not $sourceFile) {
        return $null
    }
    
    try {
        $query = "SELECT * FROM hls_cache WHERE video_id = @video_id ORDER BY last_accessed DESC LIMIT 1"
        $result = Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $query -SqlParameters @{
            video_id = $VideoId
        } -ErrorAction Stop
        
        if ($result) {
            # Validate source file hasn't changed (v3.6.1)
            $cacheValid = $true
            $invalidReason = ""
            
            # Check file size
            if ($result.source_file_size -and $result.source_file_size -gt 0) {
                if ($sourceFile.Length -ne $result.source_file_size) {
                    $cacheValid = $false
                    $invalidReason = "File size changed ($($result.source_file_size) -> $($sourceFile.Length))"
                }
            }
            
            # Check file modified date
            if ($cacheValid -and $result.source_file_modified) {
                $cachedModified = [datetime]$result.source_file_modified
                $currentModified = $sourceFile.LastWriteTime
                # Allow 2 second tolerance for filesystem timestamp precision
                if ([Math]::Abs(($currentModified - $cachedModified).TotalSeconds) -gt 2) {
                    $cacheValid = $false
                    $invalidReason = "File modified date changed"
                }
            }
            
            if (-not $cacheValid) {
                Write-Host "[!] HLS cache invalid: $invalidReason - re-transcoding" -ForegroundColor Yellow
                Write-NexusMLog "HLS cache invalid for video $VideoId - $invalidReason"
                Remove-HLSCacheEntry -TranscodeId $result.transcode_id
                return $null
            }
            
            $cacheFolder = $result.cache_folder
            if (-not (Test-Path $cacheFolder)) {
                Write-Host "[!] HLS cache folder missing: $cacheFolder - will recreate on next transcode" -ForegroundColor Yellow
                Write-NexusMLog "HLS cache folder missing: $cacheFolder - removing DB entry to allow fresh transcode"
                # Remove only the DB entry (folder is already gone)
                $deleteQuery = "DELETE FROM hls_cache WHERE transcode_id = @transcode_id"
                Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $deleteQuery -SqlParameters @{
                    transcode_id = $result.transcode_id
                } -ErrorAction SilentlyContinue
                return $null
            }
            
            # v7.30: If RequireComplete is specified, check the completed flag
            if ($RequireComplete -and $result.completed -ne 1) {
                Write-NexusMLog "HLS cache entry exists but transcoding not complete for video $VideoId"
                return $null
            }
            
            # Cache is valid - update last accessed time
            $updateQuery = "UPDATE hls_cache SET last_accessed = @accessed WHERE id = @id"
            Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $updateQuery -SqlParameters @{
                accessed = (Get-Date).ToString("o")
                id = $result.id
            } -ErrorAction SilentlyContinue
            
            return $result
        }
        
        return $null
    }
    catch {
        Write-NexusMLog "Error retrieving HLS cache entry: $_" -Level "WARNING"
        return $null
    }
}

function Add-HLSCacheEntry {

    param(
        [Parameter(Mandatory=$true)]
        [string]$VideoId,
        [Parameter(Mandatory=$true)]
        [string]$VideoPath,
        [Parameter(Mandatory=$true)]
        [string]$TranscodeId,
        [Parameter(Mandatory=$true)]
        [string]$CacheFolder,
        [string]$PlaylistFile = "",
        [int]$SegmentCount = 0,
        [long]$TotalSizeBytes = 0,
        [double]$VideoDuration = 0,
        [bool]$Completed = $false,
        [string]$EncoderUsed = "",
        [string]$Resolution = "",
        [string]$SourceVideoCodec = "",
        [string]$SourceAudioCodec = "",
        [int]$TranscodeCRF = 23,
        [string]$TranscodePreset = "veryfast"
    )
    
    # v7.15 FIX: Get HLSCacheDBPath from Pode state if global not set (runspace isolation fix)
    if (-not $Global:HLSCacheDBPath) {
        try {
            $Global:HLSCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $Global:HLSCacheDBPath = $null
        }
    }
    
    if (-not $Global:HLSCacheDBPath) {
        Write-NexusMLog "Add-HLSCacheEntry: HLSCacheDBPath not available" -Level "WARNING"
        return $false
    }
    
    # Get source file metadata for cache validation
    $sourceFileSize = 0
    $sourceFileModified = ""
    if (Test-Path -LiteralPath $VideoPath) {
        $sourceFile = Get-Item -LiteralPath $VideoPath -ErrorAction SilentlyContinue
        if ($sourceFile) {
            $sourceFileSize = $sourceFile.Length
            $sourceFileModified = $sourceFile.LastWriteTime.ToString("o")
        }
    }
    
    try {
        $now = (Get-Date).ToString("o")
        
        # Use INSERT OR REPLACE to handle duplicates
        $query = @"
INSERT OR REPLACE INTO hls_cache 
(video_id, video_path, transcode_id, cache_folder, playlist_file, segment_count, 
 total_size_bytes, video_duration, created_at, last_accessed, completed, encoder_used, resolution,
 source_file_size, source_file_modified, source_video_codec, source_audio_codec, transcode_crf, transcode_preset)
VALUES 
(@video_id, @video_path, @transcode_id, @cache_folder, @playlist_file, @segment_count,
 @total_size_bytes, @video_duration, @created_at, @last_accessed, @completed, @encoder_used, @resolution,
 @source_file_size, @source_file_modified, @source_video_codec, @source_audio_codec, @transcode_crf, @transcode_preset)
"@
        
        Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $query -SqlParameters @{
            video_id = $VideoId
            video_path = $VideoPath
            transcode_id = $TranscodeId
            cache_folder = $CacheFolder
            playlist_file = $PlaylistFile
            segment_count = $SegmentCount
            total_size_bytes = $TotalSizeBytes
            video_duration = $VideoDuration
            created_at = $now
            last_accessed = $now
            completed = if ($Completed) { 1 } else { 0 }
            encoder_used = $EncoderUsed
            resolution = $Resolution
            source_file_size = $sourceFileSize
            source_file_modified = $sourceFileModified
            source_video_codec = $SourceVideoCodec
            source_audio_codec = $SourceAudioCodec
            transcode_crf = $TranscodeCRF
            transcode_preset = $TranscodePreset
        } -ErrorAction Stop
        
        Write-NexusMLog "HLS cache entry added: $TranscodeId for video $VideoId (size: $sourceFileSize bytes)"
        return $true
    }
    catch {
        Write-NexusMLog "Error adding HLS cache entry: $_" -Level "WARNING"
        return $false
    }
}

function Update-HLSCacheEntry {

    param(
        [Parameter(Mandatory=$true)]
        [string]$TranscodeId,
        [int]$SegmentCount = -1,
        [long]$TotalSizeBytes = -1,
        [bool]$Completed = $false
    )
    
    # v7.15 FIX: Get HLSCacheDBPath from Pode state if global not set (runspace isolation fix)
    if (-not $Global:HLSCacheDBPath) {
        try {
            $Global:HLSCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $Global:HLSCacheDBPath = $null
        }
    }
    
    if (-not $Global:HLSCacheDBPath) {
        return $false
    }
    
    try {
        $updates = @("last_accessed = @accessed")
        $params = @{
            transcode_id = $TranscodeId
            accessed = (Get-Date).ToString("o")
        }
        
        if ($SegmentCount -ge 0) {
            $updates += "segment_count = @segment_count"
            $params['segment_count'] = $SegmentCount
        }
        
        if ($TotalSizeBytes -ge 0) {
            $updates += "total_size_bytes = @total_size_bytes"
            $params['total_size_bytes'] = $TotalSizeBytes
        }
        
        if ($Completed) {
            $updates += "completed = 1"
        }
        
        $query = "UPDATE hls_cache SET $($updates -join ', ') WHERE transcode_id = @transcode_id"
        Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $query -SqlParameters $params -ErrorAction Stop
        
        return $true
    }
    catch {
        Write-NexusMLog "Error updating HLS cache entry: $_" -Level "WARNING"
        return $false
    }
}

function Remove-HLSCacheEntry {
    param(
        [Parameter(Mandatory=$true)]
        [string]$TranscodeId
    )
    
    # v7.15 FIX: Get HLSCacheDBPath from Pode state if global not set (runspace isolation fix)
    if (-not $Global:HLSCacheDBPath) {
        try {
            $Global:HLSCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $Global:HLSCacheDBPath = $null
        }
    }
    
    if (-not $Global:HLSCacheDBPath) {
        return $false
    }
    
    try {
        # Get cache folder first
        $query = "SELECT cache_folder FROM hls_cache WHERE transcode_id = @transcode_id"
        $result = Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $query -SqlParameters @{
            transcode_id = $TranscodeId
        } -ErrorAction SilentlyContinue
        
        # Delete from database
        $deleteQuery = "DELETE FROM hls_cache WHERE transcode_id = @transcode_id"
        Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $deleteQuery -SqlParameters @{
            transcode_id = $TranscodeId
        } -ErrorAction Stop
        
        # Delete files if folder exists
        if ($result -and $result.cache_folder -and (Test-Path $result.cache_folder)) {
            Remove-Item -Path $result.cache_folder -Recurse -Force -ErrorAction SilentlyContinue
            Write-NexusMLog "Removed HLS cache folder: $($result.cache_folder)"
        }
        
        return $true
    }
    catch {
        Write-NexusMLog "Error removing HLS cache entry: $_" -Level "WARNING"
        return $false
    }
}

function Get-HLSCacheStats {

    if (-not $Global:HLSCacheDBPath) {
        try {
            $Global:HLSCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $Global:HLSCacheDBPath = $null
        }
    }
    
    if (-not $Global:HLSCacheDBPath -or -not (Test-Path $Global:HLSCacheDBPath)) {
        return @{
            TotalEntries = 0
            TotalSizeGB = 0
            CompletedEntries = 0
            OldestEntry = $null
            NewestEntry = $null
        }
    }
    
    try {
        $statsQuery = @"
SELECT 
    COUNT(*) as total_entries,
    SUM(total_size_bytes) as total_bytes,
    SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed_entries,
    MIN(created_at) as oldest,
    MAX(created_at) as newest
FROM hls_cache
"@
        
        $stats = Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $statsQuery -ErrorAction Stop
        
        return @{
            TotalEntries = [int]$stats.total_entries
            TotalSizeGB = [math]::Round(([long]$stats.total_bytes) / 1GB, 2)
            TotalSizeBytes = [long]$stats.total_bytes
            CompletedEntries = [int]$stats.completed_entries
            OldestEntry = $stats.oldest
            NewestEntry = $stats.newest
        }
    }
    catch {
        return @{
            TotalEntries = 0
            TotalSizeGB = 0
            TotalSizeBytes = 0
            CompletedEntries = 0
            OldestEntry = $null
            NewestEntry = $null
        }
    }
}

function Invoke-HLSCacheCleanup {

    param(
        [int]$RetentionDays = 90,
        [int]$MaxSizeGB = 100
    )
    
    # v7.15 FIX: Get HLSCacheDBPath from Pode state if global not set (runspace isolation fix)
    if (-not $Global:HLSCacheDBPath) {
        try {
            $Global:HLSCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $Global:HLSCacheDBPath = $null
        }
    }
    
    if (-not $Global:HLSCacheDBPath -or -not (Test-Path $Global:HLSCacheDBPath)) {
        return
    }
    
    Write-Host "[i] Running HLS cache cleanup..." -ForegroundColor Cyan
    Write-NexusMLog "HLS cache cleanup started (RetentionDays: $RetentionDays, MaxSizeGB: $MaxSizeGB)"
    
    $removedCount = 0
    $freedBytes = 0
    
    try {
        # Step 1: Remove entries older than retention period
        $cutoffDate = (Get-Date).AddDays(-$RetentionDays).ToString("o")
        
        # Get old entries
        $oldEntriesQuery = "SELECT transcode_id, cache_folder, total_size_bytes FROM hls_cache WHERE last_accessed < @cutoff"
        $oldEntries = Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $oldEntriesQuery -SqlParameters @{
            cutoff = $cutoffDate
        } -ErrorAction SilentlyContinue
        
        foreach ($entry in $oldEntries) {
            if ($entry.cache_folder -and (Test-Path $entry.cache_folder)) {
                Remove-Item -Path $entry.cache_folder -Recurse -Force -ErrorAction SilentlyContinue
            }
            $freedBytes += [long]$entry.total_size_bytes
            $removedCount++
        }
        
        # Delete old entries from database
        $deleteOldQuery = "DELETE FROM hls_cache WHERE last_accessed < @cutoff"
        Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $deleteOldQuery -SqlParameters @{
            cutoff = $cutoffDate
        } -ErrorAction SilentlyContinue
        
        if ($removedCount -gt 0) {
            Write-Host "[i] Removed $removedCount expired cache entries (freed $([math]::Round($freedBytes / 1GB, 2)) GB)" -ForegroundColor Yellow
        }
        
        # Step 2: Check current size and apply LRU eviction if needed
        $stats = Get-HLSCacheStats
        $maxSizeBytes = [long]$MaxSizeGB * 1GB
        
        if ($stats.TotalSizeBytes -gt $maxSizeBytes) {
            Write-Host "[i] Cache size ($($stats.TotalSizeGB) GB) exceeds limit ($MaxSizeGB GB), applying LRU eviction..." -ForegroundColor Yellow
            
            # Get entries sorted by last accessed (oldest first)
            $lruQuery = "SELECT transcode_id, cache_folder, total_size_bytes FROM hls_cache ORDER BY last_accessed ASC"
            $allEntries = Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $lruQuery -ErrorAction Stop
            
            $currentSize = $stats.TotalSizeBytes
            $targetSize = [long]($maxSizeBytes * 0.9)  # Target 90% of max to give headroom
            
            foreach ($entry in $allEntries) {
                if ($currentSize -le $targetSize) {
                    break
                }
                
                # Remove entry
                if ($entry.cache_folder -and (Test-Path $entry.cache_folder)) {
                    Remove-Item -Path $entry.cache_folder -Recurse -Force -ErrorAction SilentlyContinue
                }
                
                $deleteQuery = "DELETE FROM hls_cache WHERE transcode_id = @transcode_id"
                Invoke-SqliteQuery -DataSource $Global:HLSCacheDBPath -Query $deleteQuery -SqlParameters @{
                    transcode_id = $entry.transcode_id
                } -ErrorAction SilentlyContinue
                
                $currentSize -= [long]$entry.total_size_bytes
                $freedBytes += [long]$entry.total_size_bytes
                $removedCount++
            }
            
            Write-Host "[i] LRU eviction complete. Current cache size: $([math]::Round($currentSize / 1GB, 2)) GB" -ForegroundColor Green
        }
        
        Write-NexusMLog "HLS cache cleanup completed. Removed: $removedCount entries, Freed: $([math]::Round($freedBytes / 1GB, 2)) GB"
        
    }
    catch {
        Write-Host "[!] Error during HLS cache cleanup: $_" -ForegroundColor Red
        Write-NexusMLog "HLS cache cleanup error: $_" -Level "ERROR"
    }
}

function Get-HLSCacheFolderForVideo {

    param(
        [Parameter(Mandatory=$true)]
        [string]$TranscodeId
    )
    
    if (-not $Global:TranscodingConfig) {
        try {
            $Global:TranscodingConfig = Get-PodeState -Name 'TranscodingConfig'
        } catch {
            $Global:TranscodingConfig = $null
        }
    }
    
    $cachePath = if ($Global:TranscodingConfig) { $Global:TranscodingConfig.HLSCachePath } else { $null }
    if (-not $cachePath) {
        # Fallback: try to get ScriptRoot from CONFIG
        $scriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { $Global:CONFIG.ScriptRoot } else { $PSScriptRoot }
        $cachePath = Join-Path $scriptRoot "hls_cache"
    }
    
    $videoCache = Join-Path $cachePath $TranscodeId
    
    if (-not (Test-Path $videoCache)) {
        New-Item -ItemType Directory -Path $videoCache -Force | Out-Null
    }
    
    return $videoCache
}

function Get-SystemGPUInfo {
    
    Write-NexusMLog "Detecting system GPU(s)..."
    
    $gpuInfo = @{
        DetectedGPUs = @()
        RecommendedEncoder = "software"
        NVIDIA = @{ Present = $false; Name = ""; SupportsNVENC = $false }
        Intel = @{ Present = $false; Name = ""; SupportsQSV = $false }
        AMD = @{ Present = $false; Name = ""; SupportsAMF = $false }
    }
    
    try {
        # Get all video controllers using CIM (more reliable than WMI)
        $videoControllers = Get-CimInstance -ClassName Win32_VideoController -ErrorAction SilentlyContinue
        
        if (-not $videoControllers) {
            Write-NexusMLog "Could not detect video controllers" -Level "WARNING"
            return $gpuInfo
        }
        
        foreach ($gpu in $videoControllers) {
            $gpuName = $gpu.Name
            $gpuStatus = $gpu.Status
            $gpuDriverVersion = $gpu.DriverVersion
            $gpuVRAM = [math]::Round($gpu.AdapterRAM / 1GB, 2)
            
            # Skip Microsoft Basic Display Adapter and similar
            if ($gpuName -match "Microsoft Basic|Generic|Standard VGA") {
                continue
            }
            
            $gpuEntry = @{
                Name = $gpuName
                Status = $gpuStatus
                DriverVersion = $gpuDriverVersion
                VRAM_GB = $gpuVRAM
                Vendor = "Unknown"
                EncoderType = "none"
            }
            
            # Detect NVIDIA GPUs
            if ($gpuName -match "NVIDIA|GeForce|Quadro|Tesla|RTX|GTX") {
                $gpuEntry.Vendor = "NVIDIA"
                $gpuInfo.NVIDIA.Present = $true
                $gpuInfo.NVIDIA.Name = $gpuName
                
                # Check NVENC support (GTX 600 series and newer, all RTX)
                # NVENC is supported on Kepler (600 series) and newer
                if ($gpuName -match "RTX|GTX [6-9]\d{2}|GTX 1\d{3}|Quadro|Tesla") {
                    $gpuInfo.NVIDIA.SupportsNVENC = $true
                    $gpuEntry.EncoderType = "nvenc"
                    Write-NexusMLog "NVIDIA GPU: $gpuName (NVENC capable)"
                }
                else {
                    Write-NexusMLog "NVIDIA GPU: $gpuName (NVENC may not be supported)" -Level "WARNING"
                }
            }
            # Detect Intel GPUs (including Arc)
            elseif ($gpuName -match "Intel|Arc|Iris|UHD|HD Graphics") {
                $gpuEntry.Vendor = "Intel"
                $gpuInfo.Intel.Present = $true
                $gpuInfo.Intel.Name = $gpuName
                
                # Intel Arc GPUs (A-series) have excellent QSV support
                if ($gpuName -match "Arc A\d{3}|Arc") {
                    $gpuInfo.Intel.SupportsQSV = $true
                    $gpuEntry.EncoderType = "qsv"
                    Write-NexusMLog "Intel Arc GPU: $gpuName (QSV capable - High Performance)"
                }
                # Intel integrated graphics (6th gen / Skylake and newer have good QSV)
                elseif ($gpuName -match "UHD|Iris|HD Graphics [5-6]\d{2}|HD Graphics [7-9]\d{2}") {
                    $gpuInfo.Intel.SupportsQSV = $true
                    $gpuEntry.EncoderType = "qsv"
                    Write-NexusMLog "Intel GPU: $gpuName (QSV capable)"
                }
                else {
                    Write-NexusMLog "Intel GPU: $gpuName (QSV may have limited support)" -Level "WARNING"
                }
            }
            # Detect AMD GPUs
            elseif ($gpuName -match "AMD|Radeon|RX|Vega") {
                $gpuEntry.Vendor = "AMD"
                $gpuInfo.AMD.Present = $true
                $gpuInfo.AMD.Name = $gpuName
                
                # AMD VCE/VCN support (GCN and newer, RX 400 series+)
                if ($gpuName -match "RX [4-7]\d{2}|RX \d{4}|Vega|VII|RDNA") {
                    $gpuInfo.AMD.SupportsAMF = $true
                    $gpuEntry.EncoderType = "amf"
                    Write-NexusMLog "AMD GPU: $gpuName (AMF capable)"
                }
                else {
                    Write-NexusMLog "AMD GPU: $gpuName (AMF may not be fully supported)" -Level "WARNING"
                }
            }
            else {
                Write-NexusMLog "Unknown GPU: $gpuName"
            }
            
            $gpuInfo.DetectedGPUs += $gpuEntry
        }
        
        # Determine recommended encoder based on priority: NVENC > QSV > AMF > Software
        # Priority is based on encoding quality and compatibility
        if ($gpuInfo.NVIDIA.SupportsNVENC) {
            $gpuInfo.RecommendedEncoder = "nvenc"
            Write-NexusMLog "Recommended encoder: NVENC (NVIDIA)"
        }
        elseif ($gpuInfo.Intel.SupportsQSV) {
            $gpuInfo.RecommendedEncoder = "qsv"
            Write-NexusMLog "Recommended encoder: QSV (Intel)"
        }
        elseif ($gpuInfo.AMD.SupportsAMF) {
            $gpuInfo.RecommendedEncoder = "amf"
            Write-NexusMLog "Recommended encoder: AMF (AMD)"
        }
        else {
            Write-NexusMLog "No hardware encoder detected, will use software (CPU)" -Level "WARNING"
        }
    }
    catch {
        Write-NexusMLog "Error detecting GPUs: $_" -Level "ERROR"
    }
    
    return $gpuInfo
}

function Test-HardwareEncoder {

    param(
        [Parameter(Mandatory=$true)]
        [ValidateSet("nvenc", "qsv", "amf")]
        [string]$EncoderType,
        
        [Parameter(Mandatory=$true)]
        [string]$FFmpegPath
    )
    
    if (-not (Test-Path $FFmpegPath)) {
        Write-NexusMLog "FFmpeg not found at: $FFmpegPath" -Level "ERROR"
        return $false
    }
    
    Write-NexusMLog "Testing $EncoderType encoder..."
    
    # Pre-check: Verify FFmpeg has this encoder compiled in
    $encoderName = switch ($EncoderType) {
        "nvenc" { "h264_nvenc" }
        "qsv"   { "h264_qsv" }
        "amf"   { "h264_amf" }
    }
    
    $encodersOutput = & $FFmpegPath -hide_banner -encoders 2>&1 | Out-String
    if ($encodersOutput -notmatch $encoderName) {
        Write-Host "    [✗] $EncoderType encoder not found in FFmpeg build" -ForegroundColor Yellow
        Write-NexusMLog "$EncoderType encoder not present in this FFmpeg build" -Level "WARNING"
        return $false
    }
    Write-NexusMLog "  Pre-check: $encoderName found in FFmpeg"
    
    # Define test configurations
    # v7.67: Using 256x256 resolution (NVENC minimum is 128x128, this gives safe margin)
    # Removed problematic tests: -hwaccel cuda (decoder flag), -gpu 0 (can fail on multi-GPU)
    $testConfigs = switch ($EncoderType) {
        "nvenc" {
            @(
                # Test 1: Default settings (works with most FFmpeg builds)
                @("-hide_banner", "-y", "-f", "lavfi", "-i", "color=black:s=256x256:d=1", "-c:v", "h264_nvenc", "-f", "null", "-"),
                # Test 2: With p4 preset (for newer FFmpeg with NVENC SDK 11.0+)
                @("-hide_banner", "-y", "-f", "lavfi", "-i", "color=black:s=256x256:d=1", "-c:v", "h264_nvenc", "-preset", "p4", "-f", "null", "-")
            )
        }
        "qsv" {
            @(
                # Single test - QSV detection works reliably
                @("-hide_banner", "-y", "-f", "lavfi", "-i", "color=black:s=256x256:d=1", "-c:v", "h264_qsv", "-f", "null", "-")
            )
        }
        "amf" {
            @(
                # Test 1: Default AMF settings
                @("-hide_banner", "-y", "-f", "lavfi", "-i", "color=black:s=256x256:d=1", "-c:v", "h264_amf", "-f", "null", "-"),
                # Test 2: With quality setting
                @("-hide_banner", "-y", "-f", "lavfi", "-i", "color=black:s=256x256:d=1", "-c:v", "h264_amf", "-quality", "balanced", "-f", "null", "-")
            )
        }
    }
    
    $testSuccess = $false
    $lastError = ""
    $testNum = 0
    
    foreach ($testArgs in $testConfigs) {
        $testNum++
        $argsString = $testArgs -join " "
        Write-NexusMLog "  Test $testNum`: ffmpeg $argsString"
        
        try {
            # Use direct invocation with & operator - most reliable on Windows
            $errorOutput = $null
            $result = & $FFmpegPath @testArgs 2>&1
            $exitCode = $LASTEXITCODE
            
            # Capture any error output
            $errorOutput = ($result | Where-Object { $_ -is [System.Management.Automation.ErrorRecord] }) -join "`n"
            if (-not $errorOutput) {
                $errorOutput = ($result | Out-String)
            }
            
            if ($exitCode -eq 0) {
                $testSuccess = $true
                Write-Host "    [✓] $EncoderType encoder test PASSED (test $testNum)" -ForegroundColor Green
                Write-NexusMLog "$EncoderType encoder test PASSED with test config $testNum"
                break
            }
            else {
                $lastError = $errorOutput
                # Log abbreviated error for debugging
                $errorSnippet = if ($lastError.Length -gt 300) { $lastError.Substring(0, 300) + "..." } else { $lastError }
                Write-NexusMLog "  Test $testNum failed (exit code $exitCode): $errorSnippet" -Level "DEBUG"
            }
        }
        catch {
            $lastError = $_.Exception.Message
            Write-NexusMLog "  Test $testNum exception: $lastError" -Level "DEBUG"
        }
    }
    
    if (-not $testSuccess) {
        Write-Host "    [✗] $EncoderType encoder test FAILED (all $testNum tests)" -ForegroundColor Yellow
        
        # Provide helpful diagnostic info based on error type
        if ($lastError) {
            # Classify the error
            $friendlyReason = ""
            
            if ($lastError -match "Frame Dimension less than|invalid param.*Frame|minimum supported value") {
                # This should NOT happen with 256x256, but catch it just in case
                $friendlyReason = "Test configuration issue (resolution too small for encoder)"
                Write-NexusMLog "$EncoderType failed - parameter error (unexpected with 256x256). Error: $lastError" -Level "WARNING"
            }
            elseif ($lastError -match "Cannot load nvcuda|CUDA_ERROR|cuda driver|failed to load CUDA") {
                $friendlyReason = "CUDA/NVIDIA driver issue - ensure latest NVIDIA drivers are installed"
                Write-NexusMLog "$EncoderType failed - CUDA driver issue. Error: $lastError" -Level "WARNING"
            }
            elseif ($lastError -match "No capable devices found|No NVENC capable devices|OpenEncodeSessionEx failed|cannot open") {
                $friendlyReason = "GPU may not support NVENC or is in use by another process"
                Write-NexusMLog "$EncoderType failed - no capable device. Error: $lastError" -Level "WARNING"
            }
            elseif ($lastError -match "Driver does not support|out of memory|resources|nvenc API version") {
                $friendlyReason = "Driver version too old or GPU resources unavailable"
                Write-NexusMLog "$EncoderType failed - driver/resource issue. Error: $lastError" -Level "WARNING"
            }
            elseif ($lastError -match "Unknown option|Unrecognized option|Invalid option|Option .* not found") {
                $friendlyReason = "FFmpeg build may not fully support this encoder's options"
                Write-NexusMLog "$EncoderType failed - FFmpeg option issue. Error: $lastError" -Level "WARNING"
            }
            elseif ($lastError -match "Encoder .* not found|Unknown encoder|encoder not found") {
                $friendlyReason = "FFmpeg was not compiled with $EncoderType support"
                Write-NexusMLog "$EncoderType failed - encoder not in FFmpeg build. Error: $lastError" -Level "WARNING"
            }
            
            if ($friendlyReason) {
                Write-Host "        Reason: $friendlyReason" -ForegroundColor Gray
            }
            else {
                # Show a snippet of the actual error
                $shortError = if ($lastError.Length -gt 100) { $lastError.Substring(0, 100) + "..." } else { $lastError }
                Write-Host "        Error: $shortError" -ForegroundColor Gray
                Write-NexusMLog "$EncoderType test failed with error: $lastError" -Level "WARNING"
            }
        }
    }
    
    return $testSuccess
}

function Get-AutoDetectedEncoder {
    param(
        [Parameter(Mandatory=$true)]
        [string]$FFmpegPath
    )
    
    Write-NexusMLog "Auto-detecting best encoder..."
    
    # First, detect system GPUs
    $gpuInfo = Get-SystemGPUInfo
    $Global:DetectedGPU = $gpuInfo
    
    # If no hardware GPU detected, use software immediately
    if (-not ($gpuInfo.NVIDIA.Present -or $gpuInfo.Intel.Present -or $gpuInfo.AMD.Present)) {
        Write-NexusMLog "No dedicated GPU detected, using software encoding" -Level "WARNING"
        return "software"
    }
    
    # Check if FFmpeg has the encoder compiled in AND the hardware works
    Write-NexusMLog "Verifying hardware encoder functionality..."
    
    # Check FFmpeg encoder support
    $encodersOutput = & $FFmpegPath -hide_banner -encoders 2>&1 | Out-String
    
    # Test encoders in priority order: NVENC > QSV > AMF
    $testOrder = @()
    
    # Build test order based on detected hardware
    if ($gpuInfo.NVIDIA.SupportsNVENC -and ($encodersOutput -match 'h264_nvenc')) {
        $testOrder += "nvenc"
    }
    if ($gpuInfo.Intel.SupportsQSV -and ($encodersOutput -match 'h264_qsv')) {
        $testOrder += "qsv"
    }
    if ($gpuInfo.AMD.SupportsAMF -and ($encodersOutput -match 'h264_amf')) {
        $testOrder += "amf"
    }
    
    # Test each encoder
    foreach ($encoder in $testOrder) {
        if (Test-HardwareEncoder -EncoderType $encoder -FFmpegPath $FFmpegPath) {
            Write-Host "[✓] Auto-selected encoder: $encoder" -ForegroundColor Green
            return $encoder
        }
    }
    
    # No hardware encoder worked
    Write-NexusMLog "No working hardware encoder found, using software (CPU)" -Level "WARNING"
    return "software"
}

function Initialize-FFmpegTranscoding {
    
    Write-Host "`n=== FFmpeg Transcoding Setup ===" -ForegroundColor Cyan
    
    $ffmpegPath = $Global:TranscodingConfig.FFmpegPath
    $ffprobePath = $Global:TranscodingConfig.FFprobePath
    
    Write-NexusMLog "Configured FFmpeg path: $ffmpegPath"
    Write-NexusMLog "PSScriptRoot: $PSScriptRoot"
    
    # Check FFmpeg exists at configured path
    if (-not (Test-Path $ffmpegPath)) {
        Write-Host "[!] FFmpeg not found at configured path" -ForegroundColor Yellow
        Write-NexusMLog "Searching for FFmpeg in common locations..."
        
        # Get the script directory more reliably
        $scriptDir = if ($PSScriptRoot) { $PSScriptRoot } else { Split-Path -Parent $MyInvocation.MyCommand.Path }
        if (-not $scriptDir) { $scriptDir = Get-Location }
        
        Write-NexusMLog "Script directory: $scriptDir"
        
        # Common FFmpeg locations to search
        $searchPaths = @(
            # Script-relative paths (most likely)
            (Join-Path $scriptDir "tools\ffmpeg\bin\ffmpeg.exe"),
            (Join-Path $scriptDir "tools\ffmpeg\ffmpeg.exe"),
            (Join-Path $scriptDir "ffmpeg\bin\ffmpeg.exe"),
            (Join-Path $scriptDir "ffmpeg\ffmpeg.exe"),
            (Join-Path $scriptDir "bin\ffmpeg.exe"),
            (Join-Path $scriptDir "ffmpeg.exe"),
            # Hardcoded common paths
            "C:\nexusm\tools\ffmpeg\bin\ffmpeg.exe",
            "D:\nexusm\tools\ffmpeg\bin\ffmpeg.exe",
            "C:\ffmpeg\bin\ffmpeg.exe",
            "C:\ffmpeg\ffmpeg.exe",
            "C:\Program Files\ffmpeg\bin\ffmpeg.exe",
            "C:\Program Files (x86)\ffmpeg\bin\ffmpeg.exe",
            # User paths
            "$env:USERPROFILE\ffmpeg\bin\ffmpeg.exe",
            "$env:LOCALAPPDATA\ffmpeg\bin\ffmpeg.exe",
            # Package manager paths
            "C:\ProgramData\chocolatey\bin\ffmpeg.exe",
            "$env:USERPROFILE\scoop\shims\ffmpeg.exe"
        )
        
        $foundPath = $null
        foreach ($path in $searchPaths) {
            if ($path -and (Test-Path $path)) {
                $foundPath = $path
                Write-Host "[✓] Found FFmpeg at: $path" -ForegroundColor Green
                break
            }
        }
        
        # Also try to find via system PATH
        if (-not $foundPath) {
            try {
                $pathFFmpeg = Get-Command ffmpeg.exe -ErrorAction SilentlyContinue
                if ($pathFFmpeg) {
                    $foundPath = $pathFFmpeg.Source
                    Write-Host "[✓] Found FFmpeg in PATH: $foundPath" -ForegroundColor Green
                }
            }
            catch {}
        }
        
        if ($foundPath) {
            $ffmpegPath = $foundPath
            # Derive ffprobe path from ffmpeg path
            $ffprobeDir = Split-Path $foundPath -Parent
            $ffprobePath = Join-Path $ffprobeDir "ffprobe.exe"
            
            # Update global config with found paths
            $Global:TranscodingConfig.FFmpegPath = $ffmpegPath
            $Global:TranscodingConfig.FFprobePath = $ffprobePath
            
            Write-NexusMLog "Updated FFmpeg path to: $ffmpegPath"
            Write-NexusMLog "Updated FFprobe path to: $ffprobePath"
        }
        else {
            Write-Host "[✗] FFmpeg not found in any common location!" -ForegroundColor Red
            Write-Host "[!] Please install FFmpeg and either:" -ForegroundColor Yellow
            Write-Host "    1. Add it to your system PATH" -ForegroundColor Yellow
            Write-Host "    2. Place it in: tools\ffmpeg\bin\ (relative to script)" -ForegroundColor Yellow
            Write-Host "[!] Transcoding/REMUX for MKV/AVI files will NOT work!" -ForegroundColor Red
            return $false
        }
    }
    else {
        Write-Host "[✓] FFmpeg found at: $ffmpegPath" -ForegroundColor Green
    }
    
    # Verify ffprobe exists
    if (-not (Test-Path $ffprobePath)) {
        Write-Host "[!] FFprobe not found at: $ffprobePath" -ForegroundColor Yellow
        $ffmpegDir = Split-Path $ffmpegPath -Parent
        $ffprobePath = Join-Path $ffmpegDir "ffprobe.exe"
        if (Test-Path $ffprobePath) {
            Write-Host "[✓] Found FFprobe at: $ffprobePath" -ForegroundColor Green
            $Global:TranscodingConfig.FFprobePath = $ffprobePath
        }
        else {
            Write-Host "[!] FFprobe not found - codec detection will use filename fallback" -ForegroundColor Yellow
        }
    }
    else {
        Write-Host "[✓] FFprobe found at: $ffprobePath" -ForegroundColor Green
    }
    
    # Test FFmpeg actually works
    Write-NexusMLog "Testing FFmpeg execution..."
    try {
        $versionOutput = & $ffmpegPath -version 2>&1 | Select-Object -First 1
        if ($versionOutput -match 'ffmpeg version') {
            Write-Host "[✓] $versionOutput" -ForegroundColor Green
        }
        else {
            Write-Host "[!] FFmpeg returned unexpected output: $versionOutput" -ForegroundColor Yellow
        }
    } 
    catch {
        Write-Host "[✗] Error running FFmpeg: $_" -ForegroundColor Red
        return $false
    }
    
    # If software encoding is preferred, skip hardware detection entirely
    if ($Global:TranscodingConfig.PreferredEncoder -eq "software") {
        Write-NexusMLog "Software encoding selected - using libx264 (CPU)"
        
        $Global:FFmpegCapabilities = @{
            FFmpegPath = $ffmpegPath
            FFprobePath = $ffprobePath
            HWEncoders = @{
                NVENC = $false
                QSV = $false
                AMF = $false
                VAAPI = $false
                VideoToolbox = $false
            }
            AutoDetectedEncoder = "software"
        }
        
        Write-Host "[✓] FFmpeg transcoding initialized successfully!" -ForegroundColor Green
        return $true
    }
    
    # AUTO-DETECTION MODE: Detect GPU and test hardware encoders (v7.04)
    if ($Global:TranscodingConfig.PreferredEncoder -eq "auto") {
        Write-NexusMLog "Auto-detection mode enabled - detecting best encoder..."
        
        # Run full auto-detection (GPU detection + encoder testing)
        $autoEncoder = Get-AutoDetectedEncoder -FFmpegPath $ffmpegPath
        
        # Set up capabilities based on auto-detection
        $hwEncoders = @{
            NVENC = ($autoEncoder -eq "nvenc")
            QSV = ($autoEncoder -eq "qsv")
            AMF = ($autoEncoder -eq "amf")
            VAAPI = $false
            VideoToolbox = $false
        }
        
        $Global:FFmpegCapabilities = @{
            FFmpegPath = $ffmpegPath
            FFprobePath = $ffprobePath
            HWEncoders = $hwEncoders
            AutoDetectedEncoder = $autoEncoder
        }
        
        # Update the PreferredEncoder to the detected value for Get-OptimalFFmpegEncoder
        $Global:TranscodingConfig.PreferredEncoder = $autoEncoder
        
        $selectedEncoder = Get-OptimalFFmpegEncoder
        Write-Host "`n[✓] Auto-detection complete!" -ForegroundColor Green
        Write-Host "[✓] Selected encoder: $($selectedEncoder.Name) ($($selectedEncoder.Type))" -ForegroundColor Green
        Write-Host "[✓] FFmpeg transcoding initialized successfully!" -ForegroundColor Green
        
        return $true
    }
    
    try {
        Write-NexusMLog "Verifying specified encoder: $($Global:TranscodingConfig.PreferredEncoder)..."
        $encodersOutput = & $ffmpegPath -hide_banner -encoders 2>&1 | Out-String
        
        $hwEncoders = @{
            NVENC = ($encodersOutput -match 'h264_nvenc')
            QSV = ($encodersOutput -match 'h264_qsv')
            AMF = ($encodersOutput -match 'h264_amf')
            VAAPI = ($encodersOutput -match 'h264_vaapi')
            VideoToolbox = ($encodersOutput -match 'h264_videotoolbox')
        }
        
        Write-NexusMLog "Hardware Encoder Support detection..."
        Write-Host "    NVIDIA NVENC:  $(if ($hwEncoders.NVENC) { '✓ Available' } else { '✗ Not Available' })" -ForegroundColor $(if ($hwEncoders.NVENC) { 'Green' } else { 'Gray' })
        Write-Host "    Intel QSV:     $(if ($hwEncoders.QSV) { '✓ Available' } else { '✗ Not Available' })" -ForegroundColor $(if ($hwEncoders.QSV) { 'Green' } else { 'Gray' })
        Write-Host "    AMD AMF:       $(if ($hwEncoders.AMF) { '✓ Available' } else { '✗ Not Available' })" -ForegroundColor $(if ($hwEncoders.AMF) { 'Green' } else { 'Gray' })
        
        # Test if the specified encoder actually works
        $specifiedEncoder = $Global:TranscodingConfig.PreferredEncoder
        $encoderWorks = $false
        
        if ($specifiedEncoder -in @("nvenc", "qsv", "amf")) {
            Write-NexusMLog "Testing specified encoder: $specifiedEncoder..."
            $encoderWorks = Test-HardwareEncoder -EncoderType $specifiedEncoder -FFmpegPath $ffmpegPath
            
            if (-not $encoderWorks) {
                Write-Host "[!] Specified encoder '$specifiedEncoder' failed testing, falling back to software" -ForegroundColor Yellow
                $Global:TranscodingConfig.PreferredEncoder = "software"
                $hwEncoders = @{
                    NVENC = $false
                    QSV = $false
                    AMF = $false
                    VAAPI = $false
                    VideoToolbox = $false
                }
            }
        }
        
        $Global:FFmpegCapabilities = @{
            FFmpegPath = $ffmpegPath
            FFprobePath = $ffprobePath
            HWEncoders = $hwEncoders
        }
        
        # Determine which encoder will be used
        $selectedEncoder = Get-OptimalFFmpegEncoder
        Write-Host "[✓] Selected encoder: $($selectedEncoder.Name) ($($selectedEncoder.Type))" -ForegroundColor Green
        Write-Host "[✓] FFmpeg transcoding initialized successfully!" -ForegroundColor Green
        
        return $true
    }
    catch {
        Write-Host "[!] Error detecting FFmpeg capabilities: $_" -ForegroundColor Yellow
        
        # Still set up basic capabilities so transcoding can work
        $Global:FFmpegCapabilities = @{
            FFmpegPath = $ffmpegPath
            FFprobePath = $ffprobePath
            HWEncoders = @{
                NVENC = $false
                QSV = $false
                AMF = $false
                VAAPI = $false
                VideoToolbox = $false
            }
        }
        Write-NexusMLog "Falling back to software encoding" -Level "WARNING"
        return $true
    }
}

function Get-OptimalFFmpegEncoder {
    
    $preferred = $Global:TranscodingConfig.PreferredEncoder
    $hwEncoders = $Global:FFmpegCapabilities.HWEncoders
    
    Write-NexusMLog "Get-OptimalFFmpegEncoder called with preferred=$preferred"
    
    # ALWAYS use software if that's the preference - don't even check hardware
    if ($preferred -eq "software") {
        Write-NexusMLog "Using software encoder (libx264) as configured"
        return @{
            Name = "libx264"
            Type = "Software (CPU)"
            Encoder = "libx264"
            HWAccel = $null
            Preset = $Global:TranscodingConfig.VideoPreset
            UsesCRF = $true
        }
    }
    
    # Encoder preference mapping
    $encoderMap = @{
        "nvenc" = @{
            Name = "NVIDIA NVENC"
            Type = "Hardware (NVIDIA GPU)"
            Encoder = "h264_nvenc"
            HWAccel = "cuda"
            Preset = "p4"
            Available = $hwEncoders.NVENC
        }
        "qsv" = @{
            Name = "Intel QuickSync"
            Type = "Hardware (Intel GPU)"
            Encoder = "h264_qsv"
            HWAccel = "qsv"
            Preset = "medium"
            Available = $hwEncoders.QSV
        }
        "amf" = @{
            Name = "AMD AMF"
            Type = "Hardware (AMD GPU)"
            Encoder = "h264_amf"
            HWAccel = "d3d11va"
            Preset = "balanced"
            Available = $hwEncoders.AMF
        }
        "vaapi" = @{
            Name = "VAAPI"
            Type = "Hardware (Linux)"
            Encoder = "h264_vaapi"
            HWAccel = "vaapi"
            Preset = "medium"
            Available = $hwEncoders.VAAPI
        }
        "videotoolbox" = @{
            Name = "VideoToolbox"
            Type = "Hardware (macOS)"
            Encoder = "h264_videotoolbox"
            HWAccel = "videotoolbox"
            Preset = "medium"
            Available = $hwEncoders.VideoToolbox
        }
    }
    
    if ($preferred -ne "auto" -and $encoderMap.ContainsKey($preferred)) {
        Write-NexusMLog "Forcing encoder: $preferred (user configured)"
        $encoder = $encoderMap[$preferred]
        # Override the Available flag since user explicitly requested it
        return @{
            Name = $encoder.Name
            Type = $encoder.Type
            Encoder = $encoder.Encoder
            HWAccel = $encoder.HWAccel
            Preset = $encoder.Preset
            UsesCRF = $false
        }
    }
    
    $autoOrder = @("nvenc", "qsv", "amf")
    
    foreach ($encoderType in $autoOrder) {
        if ($encoderMap[$encoderType].Available) {
            # Verbose logging disabled:
            # Write-Host "[i] Auto-selected hardware encoder: $encoderType" -ForegroundColor Cyan
            return $encoderMap[$encoderType] + @{ UsesCRF = $false }
        }
    }
    
    return @{
        Name = "libx264"
        Type = "Software (CPU)"
        Encoder = "libx264"
        HWAccel = $null
        Preset = $Global:TranscodingConfig.VideoPreset
        UsesCRF = $true
    }
}

function Send-StreamedFileResponse {

    param(
        [Parameter(Mandatory=$true)]
        $WebEvent,
        [Parameter(Mandatory=$true)]
        [string]$FilePath,
        [Parameter(Mandatory=$true)]
        [string]$ContentType,
        [Parameter(Mandatory=$false)]
        [int]$BufferSize = 524288  # 512KB default
    )
    
    $fileInfo = Get-Item -LiteralPath $FilePath
    $fileSize = $fileInfo.Length
    
    # Parse Range header (RFC 7233 compliant)
    $rangeHeader = $WebEvent.Request.Headers['Range']
    $startByte = 0
    $endByte = $fileSize - 1
    $isRangeRequest = $false
    
    if ($rangeHeader -and $rangeHeader -match '^bytes=(.+)$') {
        $rangeSpec = $matches[1]
        $isRangeRequest = $true
        
        # Handle suffix range: bytes=-N (last N bytes) - CRITICAL for MP4 moov atom!
        if ($rangeSpec -match '^-(\d+)$') {
            $suffixLength = [long]$matches[1]
            if ($suffixLength -gt $fileSize) {
                $startByte = 0
            } else {
                $startByte = $fileSize - $suffixLength
            }
            $endByte = $fileSize - 1
        }
        # Handle standard range: bytes=N- or bytes=N-M
        elseif ($rangeSpec -match '^(\d+)-(\d*)$') {
            $startByte = [long]$matches[1]
            $endByte = if ($matches[2]) { [long]$matches[2] } else { $fileSize - 1 }
        }
        else {
            # Invalid range format
            $isRangeRequest = $false
        }
        
        # Validate range (RFC 7233 Section 4.4)
        if ($isRangeRequest) {
            # Start must be less than file size
            if ($startByte -ge $fileSize) {
                # 416 Range Not Satisfiable
                Set-PodeResponseStatus -Code 416
                Add-PodeHeader -Name 'Content-Range' -Value "bytes */$fileSize"
                return
            }
            
            # Clamp end to file size - 1
            if ($endByte -ge $fileSize) {
                $endByte = $fileSize - 1
            }
            
            # Start must not exceed end
            if ($startByte -gt $endByte) {
                Set-PodeResponseStatus -Code 416
                Add-PodeHeader -Name 'Content-Range' -Value "bytes */$fileSize"
                return
            }
        }
    }
    
    $contentLength = $endByte - $startByte + 1
    
    # Set response headers
    Add-PodeHeader -Name 'Accept-Ranges' -Value 'bytes'
    Add-PodeHeader -Name 'Content-Type' -Value $ContentType
    Add-PodeHeader -Name 'Content-Length' -Value $contentLength.ToString()
    Add-PodeHeader -Name 'Cache-Control' -Value 'public, max-age=3600'
    
    if ($isRangeRequest) {
        Set-PodeResponseStatus -Code 206
        Add-PodeHeader -Name 'Content-Range' -Value "bytes $startByte-$endByte/$fileSize"
    }
    
    # Stream the file with buffered I/O
    try {
        $fileStream = [System.IO.File]::OpenRead($FilePath)
        try {
            if ($startByte -gt 0) {
                [void]$fileStream.Seek($startByte, [System.IO.SeekOrigin]::Begin)
            }
            
            $buffer = New-Object byte[] $BufferSize
            $remainingBytes = $contentLength
            $outputStream = $WebEvent.Response.OutputStream
            
            while ($remainingBytes -gt 0) {
                $bytesToRead = [Math]::Min($BufferSize, $remainingBytes)
                $bytesRead = $fileStream.Read($buffer, 0, $bytesToRead)
                
                if ($bytesRead -le 0) { break }
                
                $outputStream.Write($buffer, 0, $bytesRead)
                $remainingBytes -= $bytesRead
            }
            
            $outputStream.Flush()
        }
        finally {
            $fileStream.Close()
            $fileStream.Dispose()
        }
    }
    catch {
        # Client likely disconnected - this is normal for video streaming
    }
}

function Get-VideoStreamingMode {

    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath
    )
    
    $extension = [System.IO.Path]::GetExtension($FilePath).ToLower()
    $videoInfo = Get-VideoInfo -FilePath $FilePath
    
    if (-not $videoInfo) {
        Write-Host "[!] Could not detect codecs via FFprobe - checking file extension" -ForegroundColor Yellow
        
        # Fallback: Use file extension and naming conventions to guess codec
        $fileName = Split-Path -Leaf $FilePath
        
        # Check for common codec indicators in filename
        $isHEVC = $fileName -match '(?i)(hevc|h\.?265|x265|h265)'
        $isH264 = $fileName -match '(?i)(h\.?264|x264|h264|avc)'
        $isAV1 = $fileName -match '(?i)(av1)'
        $isVP9 = $fileName -match '(?i)(vp9)'
        
        # Check for audio codec indicators
        $hasEAC3 = $fileName -match '(?i)(eac3|ddp|dolby|atmos)'
        $hasDTS = $fileName -match '(?i)(dts|truehd)'
        
        if ($isAV1 -or $isVP9) {
            Write-NexusMLog "TRANSCODE MODE - Filename suggests incompatible codec (AV1/VP9)"
            return "transcode"
        }
        elseif ($isHEVC) {
            # HEVC/x265 - MUST transcode for Chrome/Firefox compatibility
            Write-NexusMLog "TRANSCODE MODE - Filename suggests HEVC/x265 (browsers need H.264)"
            return "transcode"
        }
        elseif ($isH264 -and $extension -in @('.mkv', '.avi', '.mov', '.wmv', '.flv')) {
            # H.264 in non-MP4 container - try remux first
            if ($hasEAC3 -or $hasDTS) {
                Write-NexusMLog "REMUX+AUDIO MODE - Filename suggests H.264 + EAC3/DTS"
                return "remux-audio"
            } else {
                Write-NexusMLog "REMUX MODE - Filename suggests H.264, trying container remux"
                return "remux"
            }
        }
        elseif ($extension -in @('.mp4', '.m4v')) {
            # MP4 container - assume direct play (most MP4s are H.264+AAC)
            Write-NexusMLog "DIRECT MODE (assumed) - MP4 container, assuming H.264+AAC"
            return "direct"
        }
        else {
            # Unknown codec in non-MP4 container - transcode to be safe
            Write-NexusMLog "TRANSCODE MODE (fallback) - Unknown codec in $extension"
            return "transcode"
        }
    }
    
    $videoCodec = if ($videoInfo.VideoCodec) { $videoInfo.VideoCodec.ToLower() } else { "unknown" }
    $audioCodec = if ($videoInfo.AudioCodec) { $videoInfo.AudioCodec.ToLower() } else { "unknown" }
    $containerFormat = if ($videoInfo.ContainerFormat) { $videoInfo.ContainerFormat.ToLower() } else { "" }
    
    Write-NexusMLog "Detected - Video: $videoCodec, Audio: $audioCodec, Container: $extension (format: $containerFormat)"
    
    # Browser-compatible video codecs for direct play/remux (no re-encoding needed)
    # H.264/AVC works in ALL browsers via HTML5 video
    $h264Compatible = @('h264', 'avc', 'avc1')
    
    # HEVC/H.265 codecs - NOTE: HEVC is NOT universally supported in browsers!
    # Only Safari (Mac/iOS) and Edge (with HEVC Video Extensions) support HEVC
    # Chrome and Firefox do NOT support HEVC playback at all
    # Therefore, HEVC files must be TRANSCODED to H.264 for universal browser playback
    # The fast remux to MP4 only works for native apps/VLC, not web browsers
    $hevcCodecs = @('hevc', 'h265', 'hev1')
    
    # Browser-compatible audio codecs for direct play
    # AAC and MP3 are universally supported in browsers
    $browserCompatibleAudio = @('aac', 'mp3', 'mp4a', 'mp4a-latm')
    
    # Audio codecs that can be remuxed into HLS fMP4 without transcoding (for H.264 video)
    $hlsCompatibleAudio = @('aac', 'mp3')
    
    # Audio codecs that need transcoding to AAC for universal browser playback
    $audioNeedsTranscode = @('ac3', 'eac3', 'dts', 'truehd', 'flac', 'alac', 'opus', 'vorbis', 'pcm_s16le', 'pcm_s24le')
    
    # ACTUAL container formats that browsers can play directly (based on ffprobe format_name)
    # Key insight: file extension can lie! A .mp4 file might actually be MPEG-TS inside
    # mov,mp4,m4a,3gp,3g2,mj2 = true MP4/MOV container (direct playable)
    # mpegts = MPEG Transport Stream (NOT directly playable by browsers, needs remux)
    $directPlayFormats = @('mov,mp4,m4a,3gp,3g2,mj2', 'mp4', 'mov', 'm4a')
    
    # Formats that definitely need remuxing (not directly playable by browsers)
    $remuxRequiredFormats = @('matroska,webm', 'matroska', 'webm', 'avi', 'mpegts', 'mpeg', 'asf', 'wmv', 'flv')
    
    # Known incompatible video codecs that MUST be transcoded for browsers
    # HEVC is included here because browsers (except Safari) cannot decode it!
    $incompatibleVideo = @('hevc', 'h265', 'hev1', 'av1', 'av01', 'vp9', 'vp8', 'mpeg2video', 'mpeg4', 'wmv3', 'vc1', 'theora', 'msmpeg4v3', 'msmpeg4v2', 'divx', 'xvid')
    
    # Check codec compatibility
    $isH264 = $h264Compatible -contains $videoCodec
    $isHEVC = $hevcCodecs -contains $videoCodec
    $audioOkDirect = $browserCompatibleAudio -contains $audioCodec
    $audioOkHLS = $hlsCompatibleAudio -contains $audioCodec
    $audioNeedsConvert = $audioNeedsTranscode -contains $audioCodec
    $videoIncompatible = $incompatibleVideo -contains $videoCodec
    
    # Check if container is actually browser-compatible (use ffprobe format, not extension!)
    # This catches cases like .mp4 files that are actually MPEG-TS inside
    $containerOk = $false
    foreach ($fmt in $directPlayFormats) {
        if ($containerFormat -like "*$fmt*") {
            $containerOk = $true
            break
        }
    }
    
    # Check if container definitely needs remuxing
    $containerNeedsRemux = $false
    foreach ($fmt in $remuxRequiredFormats) {
        if ($containerFormat -like "*$fmt*") {
            $containerNeedsRemux = $true
            break
        }
    }
    
    # Log container detection (to log file, not console)
    if ($containerNeedsRemux) {
        Write-NexusMLog "Container '$containerFormat' needs remuxing (not directly playable)"
    }
    
    if ($isH264 -and $audioOkDirect -and $containerOk -and -not $containerNeedsRemux) {
        Write-NexusMLog "DIRECT MODE - True MP4 container with $videoCodec + $audioCodec (no FFmpeg needed)"
        return "direct"
    }
    
    if ($isH264 -and $audioOkHLS -and ($containerNeedsRemux -or -not $containerOk)) {
        Write-NexusMLog "REMUX MODE - H.264 + $audioCodec in $containerFormat -> HLS (fast, ~0% CPU)"
        return "remux"
    }
    
    # 3. REMUX H.264 + AUDIO: H.264 OK but audio needs transcoding (EAC3, DTS, AC3, etc.)
    if ($isH264 -and ($audioNeedsConvert -or -not $audioOkHLS)) {
        Write-NexusMLog "REMUX+AUDIO MODE - H.264 OK, $audioCodec -> AAC (low CPU)"
        return "remux-audio"
    }
    
    if ($isHEVC) {
        Write-NexusMLog "TRANSCODE MODE - HEVC/x265 detected (Chrome/Firefox cannot play HEVC) - transcoding to H.264"
        return "transcode"
    }
    
    # 5. FULL TRANSCODE: Other incompatible video codecs (VP9, AV1, MPEG2, etc.)
    if ($videoIncompatible) {
        Write-NexusMLog "TRANSCODE MODE - Incompatible video: $videoCodec (high CPU)"
        return "transcode"
    }
    
    # 6. Unknown video codec - transcode to be safe
    Write-NexusMLog "TRANSCODE MODE - Unrecognized video codec: $videoCodec (high CPU)"
    return "transcode"
}

function Test-VideoNeedsTranscoding {
    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath
    )
    
    $mode = Get-VideoStreamingMode -FilePath $FilePath
    
    # Only "direct" means no processing needed
    return ($mode -ne "direct")
}

function Get-VideoInfo {
    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath
    )
    
    if (-not $Global:FFmpegCapabilities) {
        Write-Host "[!] FFmpegCapabilities not initialized" -ForegroundColor Yellow
        return $null
    }
    
    $ffprobePath = $Global:FFmpegCapabilities.FFprobePath
    
    if (-not $ffprobePath -or -not (Test-Path $ffprobePath)) {
        Write-Host "[!] FFprobe not found at: $ffprobePath" -ForegroundColor Yellow
        return $null
    }
    
    # Check if file exists
    if (-not (Test-Path -LiteralPath $FilePath)) {
        Write-Host "[!] Video file not found: $FilePath" -ForegroundColor Yellow
        return $null
    }
    
    try {
        
        $processArgs = "-v quiet -print_format json -show_format -show_streams `"$FilePath`""
        
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = $ffprobePath
        $psi.Arguments = $processArgs
        $psi.UseShellExecute = $false
        $psi.RedirectStandardOutput = $true
        $psi.RedirectStandardError = $true
        $psi.CreateNoWindow = $true
        
        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $psi
        $process.Start() | Out-Null
        
        $jsonOutput = $process.StandardOutput.ReadToEnd()
        $errorOutput = $process.StandardError.ReadToEnd()
        $process.WaitForExit(30000) # 30 second timeout
        
        if ($process.ExitCode -ne 0) {
            Write-Host "[!] FFprobe failed with exit code: $($process.ExitCode)" -ForegroundColor Yellow
            if ($errorOutput) {
                Write-Host "[!] FFprobe error: $errorOutput" -ForegroundColor Yellow
            }
            return $null
        }
        
        if ([string]::IsNullOrWhiteSpace($jsonOutput)) {
            Write-Host "[!] FFprobe returned empty output" -ForegroundColor Yellow
            return $null
        }
        
        $info = $jsonOutput | ConvertFrom-Json
        
        if (-not $info.streams -or $info.streams.Count -eq 0) {
            Write-Host "[!] FFprobe found no streams in file" -ForegroundColor Yellow
            return $null
        }
        
        $videoStream = $info.streams | Where-Object { $_.codec_type -eq "video" } | Select-Object -First 1
        $audioStreams = $info.streams | Where-Object { $_.codec_type -eq "audio" }
        
        # Get first audio stream for backwards compatibility
        $audioStream = $audioStreams | Select-Object -First 1
        
        # Extract audio track information (language, codec, channels)
        $audioTracksInfo = @()
        $trackIndex = 0
        foreach ($audio in $audioStreams) {
            # Try to get language from tags
            $language = if ($audio.tags.language) { $audio.tags.language } else { $null }
            
            # If no language tag, try to parse from title
            if (-not $language -or $language -eq "und") {
                $title = if ($audio.tags.title) { $audio.tags.title } else { "" }
                
                # Check if title contains language info
                if ($title -match "english|eng") { $language = "eng" }
                elseif ($title -match "french|fra|fre") { $language = "fra" }
                elseif ($title -match "spanish|spa|esp") { $language = "spa" }
                elseif ($title -match "german|ger|deu") { $language = "deu" }
                elseif ($title -match "italian|ita") { $language = "ita" }
                elseif ($title -match "portuguese|por") { $language = "por" }
                elseif ($title -match "japanese|jpn") { $language = "jpn" }
                elseif ($title -match "chinese|chi|zho") { $language = "zho" }
                elseif ($title -match "korean|kor") { $language = "kor" }
                elseif ($title -match "russian|rus") { $language = "rus" }
                # If still unknown and this is the first audio track, assume English
                elseif ($trackIndex -eq 0) { $language = "eng" }
                else { $language = "und" }
            }
            
            $title = if ($audio.tags.title) { $audio.tags.title } else { "" }
            $channels = if ($audio.channels) { $audio.channels } else { 2 }
            $codec = if ($audio.codec_name) { $audio.codec_name } else { "unknown" }
            
            $audioTracksInfo += @{
                index = $trackIndex
                language = $language
                title = $title
                codec = $codec
                channels = $channels
            }
            $trackIndex++
        }
        
        # Convert audio tracks to JSON string for storage
        # Force array output even for single track using @() wrapper
        $audioTracksJson = if ($audioTracksInfo.Count -gt 0) { 
            if ($audioTracksInfo.Count -eq 1) {
                # Single track - wrap in array to ensure consistent JSON format
                ConvertTo-Json -InputObject @($audioTracksInfo) -Compress
            } else {
                # Multiple tracks
                $audioTracksInfo | ConvertTo-Json -Compress
            }
        } else { 
            $null 
        }
        
        return @{
            Duration = [double]$info.format.duration
            Size = [long]$info.format.size
            VideoCodec = $videoStream.codec_name
            VideoWidth = $videoStream.width
            VideoHeight = $videoStream.height
            AudioCodec = $audioStream.codec_name
            AudioTracks = $audioTracksJson
            Bitrate = [long]$info.format.bit_rate
            ContainerFormat = $info.format.format_name  # e.g., "matroska,webm", "mov,mp4,m4a,3gp,3g2,mj2", "mpegts"
        }
    }
    catch {
        Write-Host "[!] Error getting video info: $_" -ForegroundColor Yellow
        return $null
    }
}

function Start-VideoTranscode {

    param(
        [Parameter(Mandatory=$true)]
        [string]$InputFile,
        [Parameter(Mandatory=$true)]
        [int]$VideoId,
        [Parameter(Mandatory=$false)]
        [int]$AudioTrackIndex = 0,
        [Parameter(Mandatory=$false)]
        [string]$Mode = "auto"  # "auto", "remux", "remux-audio", or "transcode"
    )
    
    # Validate FFmpeg is available
    if (-not $Global:FFmpegCapabilities) {
        Write-TranscodeLog "FFmpegCapabilities not initialized - cannot transcode" -Level "ERROR"
        return $null
    }
    
    $ffmpegPath = $Global:FFmpegCapabilities.FFmpegPath
    if (-not $ffmpegPath -or -not (Test-Path $ffmpegPath)) {
        Write-TranscodeLog "FFmpeg not found at: $ffmpegPath" -Level "ERROR"
        return $null
    }
    
    # Validate input file exists
    if (-not (Test-Path -LiteralPath $InputFile)) {
        Write-TranscodeLog "Input file not found: $InputFile" -Level "ERROR"
        return $null
    }
    
    # v7.15: Use VideoId as transcodeId instead of random GUID
    # This makes cache folders predictable and easier to manage (one folder per video)
    $transcodeId = "video-$VideoId"
    $fileName = Split-Path -Leaf $InputFile
    
    Write-NexusMLog "Starting transcode process for: $fileName (transcodeId: $transcodeId)"
    Write-NexusMLog "FFmpeg path: $ffmpegPath"
    
    # Determine mode if auto
    if ($Mode -eq "auto") {
        $Mode = Get-VideoStreamingMode -FilePath $InputFile
        if ($Mode -eq "direct") {
            # Shouldn't happen, but fallback to remux
            Write-NexusMLog "Mode was 'direct' but transcode requested - using remux" -Level "WARNING"
            $Mode = "remux"
        }
    }
    
    $modeDisplay = switch ($Mode) {
        "remux"            { "REMUX (H.264+AAC copy, ~0% CPU)" }
        "remux-audio"      { "REMUX+AUDIO (H.264 copy, audio transcode, low CPU)" }
        "transcode"        { "TRANSCODE (full re-encode to H.264, uses GPU when available, otherwise CPU)" }
        default            { $Mode }
    }
    
    # v7.15: Log transcode start to transcode.log (new session)
    Write-TranscodeLog "HLS $transcodeId START [$modeDisplay]: $fileName" -Level "INFO" -NewSession
    Write-TranscodeLog "Input file: $InputFile" -Level "INFO"
    # Also show brief message on console
    Write-Host "[→] HLS $transcodeId START [$modeDisplay]: $fileName" -ForegroundColor Magenta
    
    # Get video duration using ffprobe for proper seeking support
    $videoDuration = 0
    try {
        $ffprobePath = $Global:FFmpegCapabilities.FFprobePath
        if ($ffprobePath -and (Test-Path $ffprobePath)) {
            $probeResult = & $ffprobePath -v quiet -print_format json -show_format $InputFile 2>&1
            $probeJson = $probeResult | ConvertFrom-Json
            if ($probeJson.format.duration) {
                $videoDuration = [double]$probeJson.format.duration
                Write-NexusMLog "Video duration: $([math]::Round($videoDuration, 1)) seconds"
            }
        }
    }
    catch {
        Write-TranscodeLog "Could not determine video duration: $_" -Level "WARNING"
    }
    
    $scriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { 
        $Global:CONFIG.ScriptRoot 
    } elseif ($PSScriptRoot) { 
        $PSScriptRoot 
    } else { 
        "C:\nexusm"  # Fallback
    }
    
    $hlsCacheDBPath = $Global:HLSCacheDBPath
    if (-not $hlsCacheDBPath) {
        try {
            $hlsCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
        } catch {
            $hlsCacheDBPath = $null
        }
    }
    
    # Also get TranscodingConfig from Pode state if needed
    $transcodingConfig = $Global:TranscodingConfig
    if (-not $transcodingConfig) {
        try {
            $transcodingConfig = Get-PodeState -Name 'TranscodingConfig'
        } catch {
            $transcodingConfig = @{ HLSCacheEnabled = $false }
        }
    }
    
    $useCache = $transcodingConfig.HLSCacheEnabled -and $hlsCacheDBPath
    if ($useCache) {
        # Set the global for Get-HLSCacheFolderForVideo to use
        if (-not $Global:HLSCacheDBPath) {
            $Global:HLSCacheDBPath = $hlsCacheDBPath
        }
        if (-not $Global:TranscodingConfig) {
            $Global:TranscodingConfig = $transcodingConfig
        }
        $hlsDir = Get-HLSCacheFolderForVideo -TranscodeId $transcodeId
        Write-TranscodeLog "Using HLS CACHE directory: $hlsDir" -Level "INFO"
        Write-NexusMLog "Using HLS cache directory: $hlsDir"
    }
    else {
        $hlsDir = Join-Path $scriptRoot "hls_temp\$transcodeId"
        Write-TranscodeLog "Using HLS TEMP directory: $hlsDir" -Level "INFO"
        Write-NexusMLog "Using HLS temp directory: $hlsDir"
    }
    
    try {
        if (-not (Test-Path $hlsDir)) {
            New-Item -ItemType Directory -Path $hlsDir -Force | Out-Null
        }
        Write-TranscodeLog "HLS directory created/verified" -Level "INFO"
    }
    catch {
        Write-TranscodeLog "Failed to create HLS directory: $_" -Level "ERROR"
        return $null
    }
    
    # Build FFmpeg arguments based on mode
    Write-NexusMLog "Building FFmpeg arguments for mode: $Mode"
    $ffmpegArgs = @()
    
    $verboseLog = if ($Global:TranscodingConfig -and $null -ne $Global:TranscodingConfig.VerboseTranscodeLog) {
        $Global:TranscodingConfig.VerboseTranscodeLog
    } else {
        $true  # Default to verbose for new installs
    }
    
    if ($verboseLog) {
        $ffmpegArgs += @("-loglevel", "info", "-stats")
        Write-NexusMLog "FFmpeg logging: Verbose (fps/speed stats enabled)"
    } else {
        $ffmpegArgs += @("-loglevel", "warning")
        Write-NexusMLog "FFmpeg logging: Minimal (warnings only)"
    }
    
    $hwAccelArgs = @()
    if ($Mode -eq "transcode") {
        $encoderConfig = Get-OptimalFFmpegEncoder
        if ($encoderConfig.HWAccel) {
            Write-NexusMLog "Hardware acceleration: $($encoderConfig.HWAccel)"
            switch ($encoderConfig.HWAccel) {
                "cuda" {
                    $hwAccelArgs = @("-hwaccel", "cuda")
                }
                "qsv" {
                    $hwAccelArgs = @("-init_hw_device", "qsv=hw", "-filter_hw_device", "hw")
                    Write-NexusMLog "Intel QSV: Full hardware pipeline (QSV decode + QSV encode)"
                }
                "d3d11va" {
                    # AMD: Use D3D11VA for decoding
                    $hwAccelArgs = @("-hwaccel", "d3d11va")
                }
            }
        }
    }
    
    $ffmpegArgs += @("-analyzeduration", "200M")   # Analyze more of the file for accurate duration
    $ffmpegArgs += @("-probesize", "1G")           # Read more data for better stream detection
    $ffmpegArgs += @("-fflags", "+genpts")         # Generate presentation timestamps if missing
    
    # Add hardware acceleration before input if applicable
    if ($hwAccelArgs.Count -gt 0) {
        $ffmpegArgs += $hwAccelArgs
    }
    
    # Input file - use proper quoting for paths with special chars
    $ffmpegArgs += @("-i", $InputFile)
    
    # Map video and selected audio track, exclude subtitles for HLS
    $ffmpegArgs += @("-map", "0:v:0")
    $ffmpegArgs += @("-map", "0:a:$AudioTrackIndex")
    $ffmpegArgs += @("-map", "-0:s")               # Exclude subtitle streams
    
    $audioCodec = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.AudioCodec) { $Global:TranscodingConfig.AudioCodec } else { "aac" }
    $audioBitrate = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.AudioBitrate) { $Global:TranscodingConfig.AudioBitrate } else { "128k" }
    $audioChannels = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.AudioChannels) { $Global:TranscodingConfig.AudioChannels } else { 2 }
    
    Write-TranscodeLog "Audio settings: codec=$audioCodec, bitrate=$audioBitrate, channels=$audioChannels" -Level "INFO"
    
    try {
        switch ($Mode) {
            "remux" {
                # Pure H.264 remux - copy both video and audio (instant, no CPU)
                # MPEG-TS compatible: No special bitstream filters needed
                $ffmpegArgs += @("-c:v", "copy")
                $ffmpegArgs += @("-c:a", "copy")
                
                Write-NexusMLog "H.264 + AAC remux to MPEG-TS HLS (video.js compatible)"
            }
            "remux-audio" {
                # H.264 copy, transcode audio only (for EAC3, DTS, AC3, etc.)
                $ffmpegArgs += @("-c:v", "copy")
                $ffmpegArgs += @("-c:a", $audioCodec)
                $ffmpegArgs += @("-b:a", $audioBitrate)
                $ffmpegArgs += @("-ac", $audioChannels.ToString())
                
                Write-NexusMLog "H.264 copy + Audio transcode to $audioCodec ($audioBitrate)"
            }
            "transcode" {
                # Full transcode - re-encode everything
                # Note: encoderConfig was already retrieved above for hwaccel flags
                if (-not $encoderConfig) {
                    Write-NexusMLog "Getting optimal encoder..."
                    $encoderConfig = Get-OptimalFFmpegEncoder
                }
                Write-NexusMLog "Encoder config: $($encoderConfig.Encoder) ($($encoderConfig.Type))"
                
                $cpuLimit = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.FFmpegCPULimit) { $Global:TranscodingConfig.FFmpegCPULimit } else { 0 }
                $calculatedThreadCount = 0
                $isHardwareEncoder = $encoderConfig.Encoder -in @("h264_qsv", "h264_nvenc", "h264_amf")
                
                if (-not $isHardwareEncoder) {
                    # Software encoding - apply thread limits
                    if ($cpuLimit -gt 0 -and $cpuLimit -le 100) {
                        $cpuCount = [Environment]::ProcessorCount
                        $calculatedThreadCount = [Math]::Max(1, [Math]::Floor($cpuCount * $cpuLimit / 100))
                        $ffmpegArgs += @("-threads", $calculatedThreadCount.ToString())
                        $ffmpegArgs += @("-filter_threads", $calculatedThreadCount.ToString())
                        Write-TranscodeLog "CPU limit: $calculatedThreadCount of $cpuCount threads ($cpuLimit%)" -Level "INFO"
                    } else {
                        $ffmpegArgs += @("-threads", "0")
                        Write-TranscodeLog "CPU: unlimited threads" -Level "INFO"
                    }
                    
                    $maxHeight = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.TranscodeMaxHeight) { 
                        $Global:TranscodingConfig.TranscodeMaxHeight 
                    } else { 
                        0  # 0 = no limit
                    }
                    
                    $videoFilters = @()
                    
                    if ($maxHeight -gt 0) {
                        $videoFilters += "scale=-2:'min(ih,$maxHeight)'"
                        Write-TranscodeLog "Resolution limit: max ${maxHeight}p (software encoding)" -Level "INFO"
                        Write-Host "[i] Downscaling to max ${maxHeight}p for faster software transcoding" -ForegroundColor Yellow
                    }
                    
                    $videoFilters += "format=yuv420p"
                    
                    if ($videoFilters.Count -gt 0) {
                        $filterChain = $videoFilters -join ","
                        $ffmpegArgs += @("-vf", $filterChain)
                        Write-TranscodeLog "Video filters: $filterChain" -Level "INFO"
                    }
                } else {
                    Write-NexusMLog "Hardware encoder - thread settings not applicable"
                }
                
                # Video encoding
                $ffmpegArgs += @("-c:v", $encoderConfig.Encoder)
                
                # Encoder-specific preset handling
                if ($encoderConfig.Encoder -eq "libx264") {
                    # Software x264 - use configured preset
                    $videoPreset = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.VideoPreset) { $Global:TranscodingConfig.VideoPreset } else { "veryfast" }
                    $ffmpegArgs += @("-preset", $videoPreset)
                    # Note: pix_fmt is set via -vf filter chain above for software encoding
                }
                elseif ($encoderConfig.Encoder -eq "h264_qsv") {
                    # Intel QSV (including Arc GPUs) - optimized settings
                    # Arc firmware is unstable with lookahead, so disable it
                    $ffmpegArgs += @("-preset", "medium")      # QSV presets: veryfast, faster, fast, medium, slow
                    $ffmpegArgs += @("-profile:v", "high")     # High profile for browser compatibility
                    $ffmpegArgs += @("-level", "4.1")          # Level 4.1 for 1080p compatibility
                    $ffmpegArgs += @("-look_ahead", "0")       # CRITICAL: Disable lookahead for Arc stability
                    $ffmpegArgs += @("-pix_fmt", "nv12")       # Required by QSV
                    Write-NexusMLog "Using Intel QSV hardware encoder (GPU accelerated)"
                }
                elseif ($encoderConfig.Encoder -eq "h264_nvenc") {
                    # NVIDIA NVENC - use NVENC-specific preset
                    $ffmpegArgs += @("-preset", "p4")      # NVENC presets: p1-p7 (p4 is balanced)
                    $ffmpegArgs += @("-pix_fmt", "yuv420p")
                    Write-NexusMLog "Using NVIDIA NVENC hardware encoder"
                }
                elseif ($encoderConfig.Encoder -eq "h264_amf") {
                    # AMD AMF - use AMF-specific preset
                    $ffmpegArgs += @("-quality", "balanced")  # AMF: speed, balanced, quality
                    $ffmpegArgs += @("-pix_fmt", "nv12")
                    Write-NexusMLog "Using AMD AMF hardware encoder"
                }
                else {
                    # Fallback
                    $videoPreset = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.VideoPreset) { $Global:TranscodingConfig.VideoPreset } else { "veryfast" }
                    $ffmpegArgs += @("-preset", $videoPreset)
                    $ffmpegArgs += @("-pix_fmt", "yuv420p")
                }
                
                # Encoder-specific thread limiting for libx264 only (v2.0, v7.50)
                if ($calculatedThreadCount -gt 0 -and $encoderConfig.Encoder -eq "libx264") {
                    # v7.50: Configurable lookahead threads - 0 = auto (half of main threads), otherwise use configured value
                    $lookaheadThreads = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.LookaheadThreads -gt 0) { 
                        $Global:TranscodingConfig.LookaheadThreads 
                    } else { 
                        # Auto: use half of calculated threads (min 1, max 16 per x264 limit)
                        [Math]::Min(16, [Math]::Max(1, [Math]::Floor($calculatedThreadCount / 2)))
                    }
                    $ffmpegArgs += @("-x264opts", "threads=$calculatedThreadCount`:lookahead_threads=$lookaheadThreads")
                    Write-TranscodeLog "x264 threads: $calculatedThreadCount main, $lookaheadThreads lookahead" -Level "INFO"
                }
                
                # Quality settings
                if ($encoderConfig.UsesCRF) {
                    $videoCRF = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.VideoCRF) { $Global:TranscodingConfig.VideoCRF } else { 23 }
                    $ffmpegArgs += @("-crf", $videoCRF.ToString())
                } else {
                    $videoMaxrate = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.VideoMaxrate) { $Global:TranscodingConfig.VideoMaxrate } else { "5M" }
                    $videoBufsize = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.VideoBufsize) { $Global:TranscodingConfig.VideoBufsize } else { "10M" }
                    $ffmpegArgs += @("-b:v", $videoMaxrate)
                    $ffmpegArgs += @("-maxrate", $videoMaxrate)
                    $ffmpegArgs += @("-bufsize", $videoBufsize)
                    
                    # Encoder-specific rate control (only for non-bitrate modes)
                    # NOTE: For QSV with bitrate control, do NOT add -global_quality (they conflict!)
                    if ($encoderConfig.Encoder -eq "h264_nvenc") {
                        $ffmpegArgs += @("-rc", "vbr", "-cq", "23")
                    }
                    elseif ($encoderConfig.Encoder -eq "h264_amf") {
                        $ffmpegArgs += @("-rc", "cqp", "-qp_i", "23", "-qp_p", "23", "-qp_b", "23")
                    }
                    # h264_qsv: bitrate control is sufficient, no additional params needed
                }
                
                # Audio encoding
                # v7.40: Use aresample filter to fix timestamp issues with complex audio (HDR content often has problematic audio timestamps)
                $ffmpegArgs += @("-c:a", $audioCodec)
                $ffmpegArgs += @("-b:a", $audioBitrate)
                $ffmpegArgs += @("-ac", $audioChannels.ToString())
                # Fix audio timestamp discontinuities that cause MEDIA_ERR_DECODE in browsers
                $ffmpegArgs += @("-af", "aresample=async=1:first_pts=0")
                
                Write-NexusMLog "Full transcode: $($encoderConfig.Encoder), Audio: $audioCodec"
            }
            default {
                Write-TranscodeLog "Unknown mode: $Mode - defaulting to transcode" -Level "WARNING"
                $ffmpegArgs += @("-c:v", "libx264", "-preset", "veryfast", "-crf", "23")
                $ffmpegArgs += @("-c:a", "aac", "-b:a", "128k", "-ac", "2")
            }
        }
        Write-TranscodeLog "Mode-specific arguments added" -Level "INFO"
    }
    catch {
        Write-TranscodeLog "Error building mode arguments: $_" -Level "ERROR"
        Write-TranscodeLog "Stack: $($_.ScriptStackTrace)" -Level "ERROR"
        return $null
    }
    
    $ffmpegArgs += @("-map_metadata", "-1")
    $ffmpegArgs += @("-map_chapters", "-1")
    
    $ffmpegArgs += @("-avoid_negative_ts", "make_zero")
    $ffmpegArgs += @("-max_muxing_queue_size", "2048")
    
    $segmentDuration = if ($Global:TranscodingConfig -and $Global:TranscodingConfig.HLSSegmentDuration) { 
        $Global:TranscodingConfig.HLSSegmentDuration 
    } else { 
        3 
    }
    

    $segmentPattern = "$transcodeId%d.m4s"
    $initFilename = "init.mp4"
    
    $ffmpegArgs += @(
        "-f", "hls"
        "-hls_time", $segmentDuration.ToString()
        "-hls_segment_type", "fmp4"                        # fMP4/CMAF for better seeking
        "-hls_fmp4_init_filename", $initFilename           # Init segment with codec info
        "-start_number", "0"
        "-hls_segment_filename", $segmentPattern           # Relative - FFmpeg writes to working dir
        "-hls_playlist_type", "event"                      # EVENT = playlist written immediately!
        "-hls_list_size", "0"                              # Keep all segments in playlist
        "-hls_flags", "independent_segments+program_date_time"  # Enables seeking during transcode
        "-y"
        "playlist.m3u8"                                    # Relative - output playlist
    )
    
    $script:CurrentSegmentPattern = $segmentPattern
    
    $argList = @()
    foreach ($arg in $ffmpegArgs) {
        if ($arg -match '\s' -or $arg -match '\\') {
            $argList += "`"$arg`""
        } else {
            $argList += $arg
        }
    }
    
    $ffmpegExePath = if ($Global:FFmpegCapabilities -and $Global:FFmpegCapabilities.FFmpegPath) {
        $Global:FFmpegCapabilities.FFmpegPath
    } else {
        # Fallback to common location
        "C:\nexusm\tools\ffmpeg\bin\ffmpeg.exe"
    }
    
    # Log command
    $cmdLine = $ffmpegExePath + " " + ($argList -join ' ')
    Write-TranscodeLog "Full Command:" -Level "INFO"
    Write-TranscodeLog "    $cmdLine" -Level "DEBUG"
    Write-NexusMLog "HLS directory: $hlsDir"
    
    # Store transcode info
    $transcodeInfo = @{
        TranscodeId = $transcodeId
        VideoId = $VideoId
        HLSDirectory = $hlsDir
        StartTime = Get-Date
        Duration = $videoDuration
        Mode = $Mode
        Process = $null
        ErrorOutput = [System.Collections.Concurrent.ConcurrentBag[string]]::new()
        SegmentPattern = $segmentPattern       # e.g., "abc123%d.ts" (MPEG-TS)
    }
    
    try {
        # Start FFmpeg process
        $psi = New-Object System.Diagnostics.ProcessStartInfo
        $psi.FileName = $ffmpegExePath
        $psi.Arguments = $argList -join ' '
        $psi.UseShellExecute = $false
        $psi.RedirectStandardOutput = $true
        $psi.RedirectStandardError = $true
        $psi.CreateNoWindow = $true
        $psi.WorkingDirectory = $hlsDir  # CRITICAL: init.mp4 is written relative to working dir
        
        Write-NexusMLog "Starting FFmpeg: $ffmpegExePath"
        Write-NexusMLog "Working directory: $hlsDir"
        
        $process = New-Object System.Diagnostics.Process
        $process.StartInfo = $psi
        
        # Register stderr handler - v7.15: Log to transcode.log instead of console
        # NOTE: Event handlers run in separate runspace, so we pass the log path directly
        $transcodeLogPath = $Global:TranscodeLogPath
        if (-not $transcodeLogPath) {
            # Try Pode state
            try {
                $transcodeLogPath = Get-PodeState -Name 'TranscodeLogPath'
            } catch { }
        }
        if (-not $transcodeLogPath) {
            # Construct path
            $logScriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { $Global:CONFIG.ScriptRoot } else { $scriptRoot }
            $transcodeLogPath = Join-Path $logScriptRoot "logs\transcode.log"
        }
        
        # Ensure logs directory exists
        $logsDir = Split-Path -Parent $transcodeLogPath
        if (-not (Test-Path $logsDir)) {
            New-Item -ItemType Directory -Path $logsDir -Force -ErrorAction SilentlyContinue | Out-Null
        }
        
        $stderrHandler = Register-ObjectEvent -InputObject $process -EventName ErrorDataReceived -Action {
            param($sender, $e)
            if (-not [string]::IsNullOrEmpty($e.Data)) {
                # Write directly to transcode log file (can't call functions from event handler runspace)
                $logPath = $Event.MessageData
                if ($logPath) {
                    try {
                        $logEntry = "    FFmpeg: $($e.Data)"
                        Add-Content -Path $logPath -Value $logEntry -Encoding UTF8 -ErrorAction SilentlyContinue
                    } catch { }
                }
            }
        } -MessageData $transcodeLogPath
        
        # Start process
        $process.Start() | Out-Null
        
        if ($Mode -eq "transcode" -and $Global:TranscodingConfig.FFmpegCPULimit -gt 0) {
            $cpuLimit = $Global:TranscodingConfig.FFmpegCPULimit
            if ($cpuLimit -gt 0 -and $cpuLimit -le 100) {
                try {

                    if ($cpuLimit -le 50) {
                        $process.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::BelowNormal
                        Write-TranscodeLog "Process priority: BelowNormal (CPU limit ≤50%)" -Level "INFO"
                    } else {
                        $process.PriorityClass = [System.Diagnostics.ProcessPriorityClass]::Normal
                        Write-TranscodeLog "Process priority: Normal (CPU limit >50%)" -Level "INFO"
                    }
                    
                    $cpuCount = [Environment]::ProcessorCount
                    $allowedCores = [Math]::Max(1, [Math]::Floor($cpuCount * $cpuLimit / 100))
                    $affinityMask = [long]0
                    for ($i = 0; $i -lt $allowedCores; $i++) {
                        $affinityMask = $affinityMask -bor ([long]1 -shl $i)
                    }
                    $process.ProcessorAffinity = [IntPtr]$affinityMask
                    Write-TranscodeLog "CPU affinity: $allowedCores of $cpuCount cores ($cpuLimit%)" -Level "INFO"
                }
                catch {
                    Write-TranscodeLog "Could not set process priority/affinity: $_" -Level "WARNING"
                }
            }
        }
        
        # Begin async reads
        $process.BeginErrorReadLine()
        $process.BeginOutputReadLine()
        
        $transcodeInfo.Process = $process
        $transcodeInfo.ProcessId = $process.Id
        
        Write-TranscodeLog "FFmpeg started (PID: $($process.Id)) - Mode: $Mode" -Level "INFO"
        Write-TranscodeLog "HLS playlist: /hls/$transcodeId/playlist.m3u8" -Level "INFO"
        Write-TranscodeLog "Segment pattern: $segmentPattern" -Level "INFO"
        Write-NexusMLog "HLS playlist (MPEG-TS EVENT): /hls/$transcodeId/playlist.m3u8"
        # Keep brief console message
        Write-Host "[✓] FFmpeg started (PID: $($process.Id)) - Mode: $Mode" -ForegroundColor Green
        
        Start-Sleep -Milliseconds 1500
        
        # Check if process already exited (error)
        if ($process.HasExited) {
            Write-TranscodeLog "FFmpeg exited immediately (exit code: $($process.ExitCode))" -Level "ERROR"
            Write-TranscodeLog "Check transcode.log for FFmpeg output details" -Level "ERROR"
            
            # Cleanup
            if (Test-Path $hlsDir) {
                Remove-Item -Path $hlsDir -Recurse -Force -ErrorAction SilentlyContinue
            }
            return $null
        }
        
        # Store in active transcodes
        $Global:ActiveTranscodes.TryAdd($transcodeId, $transcodeInfo) | Out-Null
        
        if ($useCache) {
            $encoderUsed = if ($encoderConfig) { $encoderConfig.Encoder } else { "libx264" }
            $cacheResult = Add-HLSCacheEntry -VideoId $VideoId.ToString() -VideoPath $InputFile `
                -TranscodeId $transcodeId -CacheFolder $hlsDir `
                -VideoDuration $videoDuration -EncoderUsed $encoderUsed `
                -Completed $false
            
            if ($cacheResult) {
                Write-TranscodeLog "HLS cache entry created for video $VideoId (folder: $transcodeId)" -Level "INFO"
                Write-NexusMLog "HLS cache entry created for video $VideoId (transcodeId: $transcodeId)"
            } else {
                Write-TranscodeLog "Failed to create HLS cache entry for video $VideoId" -Level "WARNING"
                Write-NexusMLog "Failed to create HLS cache entry for video $VideoId" -Level "WARNING"
            }
        }
        
        # Return transcode info
        return @{
            TranscodeId = $transcodeId
            HLSDirectory = $hlsDir
            PlaylistPath = "$hlsDir\playlist.m3u8"
            Mode = $Mode
        }
    }
    catch {
        Write-TranscodeLog "Failed to start transcode: $_" -Level "ERROR"
        
        # Cleanup
        if (Test-Path $hlsDir) {
            Remove-Item -Path $hlsDir -Recurse -Force -ErrorAction SilentlyContinue
        }
        
        return $null
    }
}

function Stop-AllTranscodes {
    
    if ($Global:ActiveTranscodes.Count -eq 0) {
        return
    }
    
    $semaphore = $Global:TranscodeSemaphore
    if (-not $semaphore) {
        try {
            $semaphore = Get-PodeState -Name 'TranscodeSemaphore'
        } catch {
            $semaphore = $null
        }
    }
    
    $releasedCount = 0
    foreach ($kvp in $Global:ActiveTranscodes.GetEnumerator()) {
        try {
            $transcodeInfo = $kvp.Value
            $processKilled = $false
            $hadRunningProcess = $false
            
            # Check if this entry had a running process (not just a cache reference)
            if ($transcodeInfo.Process -or $transcodeInfo.ProcessId) {
                $hadRunningProcess = $true
            }
            
            if ($transcodeInfo.ProcessId) {
                $pid = $transcodeInfo.ProcessId
                try {
                    Write-Host "    Stopping: $($kvp.Key) (PID: $pid)" -ForegroundColor Gray
                    $processKilled = $true
                } catch { }
            }
            
            # Fallback to Process object if taskkill didn't work
            if (-not $processKilled -and $transcodeInfo.Process -and -not $transcodeInfo.Process.HasExited) {
                Write-Host "    Stopping: $($kvp.Key) via .Kill()" -ForegroundColor Gray
                $transcodeInfo.Process.Kill()
                $transcodeInfo.Process.WaitForExit(2000) | Out-Null
                $transcodeInfo.Process.Dispose()
            }
            
            if ($hadRunningProcess -and $transcodeInfo.FromCache -ne $true -and $semaphore) {
                try {
                    $semaphore.Release()
                    $releasedCount++
                } catch { }
            }
            
            if ($transcodeInfo.HLSDirectory -and (Test-Path $transcodeInfo.HLSDirectory)) {
                # Check if this is a cache folder (in hls_cache) or temp folder (in hls_temp)
                $isCache = $transcodeInfo.HLSDirectory -match '[/\\]hls_cache[/\\]'
                $fromCache = $transcodeInfo.FromCache -eq $true
                
                if (-not $isCache -and -not $fromCache) {
                    Start-Sleep -Milliseconds 500  # Give FFmpeg time to release files
                    Remove-Item -Path $transcodeInfo.HLSDirectory -Recurse -Force -ErrorAction SilentlyContinue
                    Write-NexusMLog "Cleaned up temp HLS directory: $($transcodeInfo.HLSDirectory)"
                } else {
                    Write-NexusMLog "Preserved cache HLS directory: $($transcodeInfo.HLSDirectory)"
                }
            }
        }
        catch {
            Write-Host "    [!] Error: $_" -ForegroundColor Yellow
        }
    }
    
    $Global:ActiveTranscodes.Clear()
    
    if ($releasedCount -gt 0) {
        Write-NexusMLog "Released $releasedCount transcode semaphore slot(s)"
    }
    
    # Clean up orphaned HLS directories in hls_temp only (NOT hls_cache!)
    $hlsBase = Join-Path $PSScriptRoot "hls_temp"
    if (Test-Path $hlsBase) {
        Get-ChildItem -Path $hlsBase -Directory -ErrorAction SilentlyContinue | ForEach-Object {
            Remove-Item -Path $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
        }
    }
    
    Write-Host "[✓] All transcodes stopped and temp files cleaned" -ForegroundColor Green
}

function Stop-OrphanedFFmpegProcesses {
    
    # First, stop all tracked transcodes
    if ($Global:ActiveTranscodes -and $Global:ActiveTranscodes.Count -gt 0) {
        Stop-AllTranscodes
    }
    
    try {
        $ffmpegProcesses = Get-Process -Name "ffmpeg" -ErrorAction SilentlyContinue
        if ($ffmpegProcesses) {
            $scriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { $Global:CONFIG.ScriptRoot } else { $PSScriptRoot }
            $hlsCacheDir = Join-Path $scriptRoot "hls_cache"
            $hlsTempDir = Join-Path $scriptRoot "hls_temp"
            
            foreach ($proc in $ffmpegProcesses) {
                try {
                    $cmdLine = ""
                    try {
                        $wmiProc = Get-CimInstance Win32_Process -Filter "ProcessId = $($proc.Id)" -ErrorAction SilentlyContinue
                        if ($wmiProc) {
                            $cmdLine = $wmiProc.CommandLine
                        }
                    } catch { }
                    
                    # If we can't get the command line, check the working directory
                    $isOurProcess = $false
                    if ($cmdLine) {
                        $isOurProcess = ($cmdLine -match [regex]::Escape($hlsCacheDir)) -or 
                                        ($cmdLine -match [regex]::Escape($hlsTempDir)) -or
                                        ($cmdLine -match "hls_cache") -or 
                                        ($cmdLine -match "hls_temp")
                    }
                    
                    if ($isOurProcess) {
                        Write-Host "[i] Killing orphaned FFmpeg process (PID: $($proc.Id))" -ForegroundColor Yellow
                        # Use taskkill for forceful termination
                    }
                } catch {
                    # Process may have already exited
                }
            }
        }
    } catch {
        # Get-Process failed - no ffmpeg processes running
    }
}

$Global:TranscodeCleanupRegistered = $false

function Register-TranscodeCleanupHandlers {

    
    if ($Global:TranscodeCleanupRegistered) {
        return
    }
    
    # Register for PowerShell engine stopping (Ctrl+C, script exit)
    $null = Register-EngineEvent -SourceIdentifier PowerShell.Exiting -Action {
        Write-Host "`n[i] Cleaning up transcoding processes..." -ForegroundColor Yellow
        Stop-OrphanedFFmpegProcesses
    } -SupportEvent
    
    # Also register for console Ctrl+C specifically
    [Console]::TreatControlCAsInput = $false
    
    $Global:TranscodeCleanupRegistered = $true
    Write-NexusMLog "Transcode cleanup handlers registered for script termination"
}

function Get-TranscodingStatus {
    
    $status = @()
    
    foreach ($kvp in $Global:ActiveTranscodes.GetEnumerator()) {
        $info = $kvp.Value
        $duration = ((Get-Date) - $info.StartTime).TotalSeconds
        
        $status += @{
            TranscodeId = $kvp.Key
            InputFile = Split-Path -Leaf $info.InputFile
            Encoder = $info.Encoder
            Duration = [math]::Round($duration, 1)
            PID = $info.Process.Id
        }
    }
    
    return $status
}


function Get-SmartVideoStream {

    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath,
        [Parameter(Mandatory=$true)]
        [int]$VideoId,
        [Parameter(Mandatory=$false)]
        [int]$AudioTrackIndex = 0
    )
    
    # Check if file exists
    if (-not (Test-Path -LiteralPath $FilePath)) {
        Write-Host "[✗] Video file not found: $FilePath" -ForegroundColor Red
        return $null
    }
    
    $fileName = Split-Path -Leaf $FilePath
    $extension = [System.IO.Path]::GetExtension($FilePath).ToLower()
    
    # Get streaming mode
    $mode = Get-VideoStreamingMode -FilePath $FilePath
    
    Write-NexusMLog "Smart Stream: $fileName | Extension: $extension | Mode: $mode | FFmpeg: $(if ($Global:FFmpegCapabilities) { 'Available' } else { 'Not Found' })"
    
    $browserIncompatibleContainers = @('.mkv', '.avi', '.wmv', '.flv', '.webm', '.ts', '.m2ts')
    $requiresHLS = $browserIncompatibleContainers -contains $extension
    
    if ($mode -eq "direct" -and -not $requiresHLS) {
        # Direct streaming - no processing needed
        Write-NexusMLog "DIRECT STREAMING: $fileName"
        return @{
            Type = "Direct"
            StreamURL = "/stream/$VideoId"
            Mode = "direct"
        }
    }
    
    # Need FFmpeg for remux or transcode
    if (-not $Global:FFmpegCapabilities) {
        if ($requiresHLS) {
            Write-Host "[✗] FFmpeg required for $extension files but not available!" -ForegroundColor Red
            Write-Host "    Install FFmpeg to stream this file format" -ForegroundColor Yellow
            return $null  # Return null instead of broken direct stream
        }
        
        Write-Host "[!] FFmpeg not available - falling back to direct stream" -ForegroundColor Yellow
        return @{
            Type = "Direct"
            StreamURL = "/stream/$VideoId"
            Mode = "direct-fallback"
        }
    }
    
    if ($requiresHLS -and $mode -eq "direct") {
        Write-Host "[!] Container $extension requires HLS - forcing remux mode" -ForegroundColor Yellow
        $mode = "remux"
    }
    
    $hlsCacheDBPath = $Global:HLSCacheDBPath
    if (-not $hlsCacheDBPath) {
        try {
            $hlsCacheDBPath = Get-PodeState -Name 'HLSCacheDBPath'
            if ($hlsCacheDBPath) {
                $Global:HLSCacheDBPath = $hlsCacheDBPath
            }
        } catch {
            $hlsCacheDBPath = $null
        }
    }
    
    $transcodingConfig = $Global:TranscodingConfig
    if (-not $transcodingConfig) {
        try {
            $transcodingConfig = Get-PodeState -Name 'TranscodingConfig'
            if ($transcodingConfig) {
                $Global:TranscodingConfig = $transcodingConfig
            }
        } catch {
            $transcodingConfig = @{ HLSCacheEnabled = $false }
        }
    }
    
    if ($transcodingConfig.HLSCacheEnabled -and $hlsCacheDBPath) {
        $cachedEntry = Get-HLSCacheEntry -VideoId $VideoId.ToString() -VideoPath $FilePath
        
        if ($cachedEntry) {
            # Verify the cached playlist still exists and is valid
            $cachedPlaylist = Join-Path $cachedEntry.cache_folder "playlist.m3u8"
            $cacheFolder = $cachedEntry.cache_folder
            
            $dbMarkedComplete = $cachedEntry.completed -eq 1
            $actuallyComplete = Test-HLSCacheComplete -CacheFolder $cacheFolder -TranscodeId $cachedEntry.transcode_id
            $hasPlaylist = (Test-Path $cacheFolder) -and (Test-Path $cachedPlaylist)
            
            if ($dbMarkedComplete -and -not $actuallyComplete) {
                Write-Host "[!] Cache marked complete but validation failed - will re-transcode" -ForegroundColor Yellow
                Write-NexusMLog "Cache validation mismatch for $($cachedEntry.transcode_id): DB=complete, actual=incomplete"
                # Update DB to reflect actual state
                try {
                    $fixQuery = "UPDATE hls_cache SET completed = 0 WHERE transcode_id = @transcode_id"
                    Invoke-SqliteQuery -DataSource $hlsCacheDBPath -Query $fixQuery -SqlParameters @{
                        transcode_id = $cachedEntry.transcode_id
                    } -ErrorAction SilentlyContinue
                } catch { }
                $dbMarkedComplete = $false
            }
            
            if ($hasPlaylist -and $actuallyComplete) {
                # CASE 1: Completed cache - use as-is (NO FFMPEG NEEDED!)
                Write-Host "[✓] Using COMPLETED CACHED HLS session: $($cachedEntry.transcode_id)" -ForegroundColor Green
                Write-Host "    Cache age: $([math]::Round(((Get-Date) - [datetime]$cachedEntry.created_at).TotalDays, 1)) days" -ForegroundColor Gray
                Write-NexusMLog "HLS cache hit (validated complete) for video $VideoId - serving from cache $($cachedEntry.transcode_id)"
                
                if (-not $dbMarkedComplete) {
                    Write-Host "[i] Updating stale DB record to mark as complete..." -ForegroundColor Cyan
                    Write-NexusMLog "Fixing stale DB record: $($cachedEntry.transcode_id) - marking as complete"
                    try {
                        # Calculate actual segment count and size from disk
                        $segments = Get-ChildItem -Path $cacheFolder -Filter "*.m4s" -ErrorAction SilentlyContinue
                        if (-not $segments) {
                            $segments = Get-ChildItem -Path $cacheFolder -Filter "*.ts" -ErrorAction SilentlyContinue
                        }
                        $segmentCount = if ($segments) { $segments.Count } else { 0 }
                        $totalSize = (Get-ChildItem -Path $cacheFolder -File -ErrorAction SilentlyContinue | 
                                      Measure-Object -Property Length -Sum).Sum
                        if (-not $totalSize) { $totalSize = 0 }
                        
                        $updateQuery = "UPDATE hls_cache SET completed = 1, segment_count = @segment_count, total_size_bytes = @total_size WHERE transcode_id = @transcode_id"
                        Invoke-SqliteQuery -DataSource $hlsCacheDBPath -Query $updateQuery -SqlParameters @{
                            transcode_id = $cachedEntry.transcode_id
                            segment_count = $segmentCount
                            total_size = $totalSize
                        } -ErrorAction Stop
                        
                        Write-Host "[✓] DB updated: $segmentCount segments, $([math]::Round($totalSize / 1MB, 1)) MB" -ForegroundColor Green
                        Write-NexusMLog "DB record fixed: $($cachedEntry.transcode_id) - $segmentCount segments, $([math]::Round($totalSize / 1MB, 1)) MB"
                    }
                    catch {
                        Write-NexusMLog "Failed to update DB record: $_" -Level "WARNING"
                    }
                }
                
                # Re-register in ActiveTranscodes for this session (for route handlers)
                $activeTranscodes = $Global:ActiveTranscodes
                if (-not $activeTranscodes) {
                    try {
                        $activeTranscodes = Get-PodeState -Name 'ActiveTranscodes'
                    } catch {
                        $activeTranscodes = $null
                    }
                }
                
                if ($activeTranscodes -and -not $activeTranscodes.ContainsKey($cachedEntry.transcode_id)) {
                    $activeTranscodes[$cachedEntry.transcode_id] = @{
                        TranscodeId = $cachedEntry.transcode_id
                        VideoId = $VideoId
                        HLSDirectory = $cachedEntry.cache_folder
                        StartTime = [datetime]$cachedEntry.created_at
                        Duration = $cachedEntry.video_duration
                        Mode = $mode
                        Process = $null  # No process - using cached files
                        FromCache = $true
                        IsComplete = $true  # v7.45: Validated complete with ENDLIST
                    }
                }
                
                # v7.45: Return immediately - do NOT start any FFmpeg process!
                return @{
                    Type = "HLS"
                    PlaylistURL = "/hls/$($cachedEntry.transcode_id)/playlist.m3u8"
                    TranscodeId = $cachedEntry.transcode_id
                    Mode = "$mode (cached)"
                }
            }
            elseif ($hasPlaylist -and -not $actuallyComplete) {
                Write-Host "[!] Found INCOMPLETE cached HLS session: $($cachedEntry.transcode_id)" -ForegroundColor Yellow
                Write-Host "    Starting fresh transcode (incomplete cache will be replaced)..." -ForegroundColor Cyan
                Write-NexusMLog "HLS cache incomplete for video $VideoId - restarting transcode $($cachedEntry.transcode_id)"
                
                # Remove the old incomplete DB entry - Start-VideoTranscode will create a fresh one
                $deleteQuery = "DELETE FROM hls_cache WHERE transcode_id = @transcode_id"
                Invoke-SqliteQuery -DataSource $hlsCacheDBPath -Query $deleteQuery -SqlParameters @{
                    transcode_id = $cachedEntry.transcode_id
                } -ErrorAction SilentlyContinue
                
                # v7.30: Also remove from ActiveTranscodes if present (stale entry from previous session)
                $activeTranscodes = $Global:ActiveTranscodes
                if (-not $activeTranscodes) {
                    try {
                        $activeTranscodes = Get-PodeState -Name 'ActiveTranscodes'
                    } catch {
                        $activeTranscodes = $null
                    }
                }
                if ($activeTranscodes -and $activeTranscodes.ContainsKey($cachedEntry.transcode_id)) {
                    $activeTranscodes.TryRemove($cachedEntry.transcode_id, [ref]$null) | Out-Null
                    Write-NexusMLog "Removed stale ActiveTranscodes entry: $($cachedEntry.transcode_id)"
                }
                
                if (Test-Path $cacheFolder) {
                    try {
                        Remove-Item -Path $cacheFolder -Recurse -Force -ErrorAction Stop
                        Write-NexusMLog "Removed incomplete cache folder for fresh transcode: $cacheFolder"
                    }
                    catch {
                        Write-NexusMLog "Could not remove incomplete cache folder: $_" -Level "WARNING"
                        # Try to at least remove individual files
                        try {
                            Get-ChildItem -Path $cacheFolder -File | Remove-Item -Force -ErrorAction SilentlyContinue
                            Write-NexusMLog "Removed files from incomplete cache folder"
                        }
                        catch {}
                    }
                }
                
                # Fall through to start fresh transcode below
            }
            elseif (-not $hasPlaylist -and (Test-Path $cacheFolder)) {
                # CASE 2b: Cache folder exists but no playlist (FFmpeg crashed early)
                Write-Host "[!] Found corrupted cache folder (no playlist): $($cachedEntry.transcode_id)" -ForegroundColor Yellow
                Write-Host "    Cleaning up and starting fresh..." -ForegroundColor Cyan
                Write-NexusMLog "HLS cache corrupted (no playlist) for video $VideoId - cleaning up"
                
                # Remove DB entry
                $deleteQuery = "DELETE FROM hls_cache WHERE transcode_id = @transcode_id"
                Invoke-SqliteQuery -DataSource $hlsCacheDBPath -Query $deleteQuery -SqlParameters @{
                    transcode_id = $cachedEntry.transcode_id
                } -ErrorAction SilentlyContinue
                
                # Remove from ActiveTranscodes
                $activeTranscodes = $Global:ActiveTranscodes
                if (-not $activeTranscodes) {
                    try {
                        $activeTranscodes = Get-PodeState -Name 'ActiveTranscodes'
                    } catch {
                        $activeTranscodes = $null
                    }
                }
                if ($activeTranscodes -and $activeTranscodes.ContainsKey($cachedEntry.transcode_id)) {
                    $activeTranscodes.TryRemove($cachedEntry.transcode_id, [ref]$null) | Out-Null
                }
                
                # Delete corrupted folder
                try {
                    Remove-Item -Path $cacheFolder -Recurse -Force -ErrorAction Stop
                    Write-NexusMLog "Removed corrupted cache folder: $cacheFolder"
                }
                catch {
                    Write-NexusMLog "Could not remove corrupted cache folder: $_" -Level "WARNING"
                }
                
                # Fall through to start fresh transcode below
            }
            else {
                # CASE 3: Cache entry exists but folder/files missing - remove stale entry
                Write-Host "[!] Cached HLS files missing - removing stale cache entry" -ForegroundColor Yellow
                Write-NexusMLog "HLS cache files missing for video $VideoId - removing stale entry"
                
                # Remove DB entry (folder is already gone or invalid)
                $deleteQuery = "DELETE FROM hls_cache WHERE transcode_id = @transcode_id"
                Invoke-SqliteQuery -DataSource $hlsCacheDBPath -Query $deleteQuery -SqlParameters @{
                    transcode_id = $cachedEntry.transcode_id
                } -ErrorAction SilentlyContinue
                
                # Fall through to start fresh transcode below
            }
        }
    }
    
    # Check for existing active process for this video (in-memory, current session)
    $existingTranscode = $null
    foreach ($kvp in $Global:ActiveTranscodes.GetEnumerator()) {
        if ($kvp.Value.VideoId -eq $VideoId) {
            $existingTranscode = $kvp
            break
        }
    }
    
    if ($existingTranscode) {
        # Verify the existing transcode is still valid
        $transcodeValid = $false
        $transcodeKey = $existingTranscode.Key
        $transcodeValue = $existingTranscode.Value
        
        # Check if HLS directory exists and has playlist
        $playlistPath = Join-Path $transcodeValue.HLSDirectory "playlist.m3u8"
        $hlsDirExists = Test-Path $transcodeValue.HLSDirectory
        $playlistExists = Test-Path $playlistPath
        
        # Check if process is still running (if it was a transcode, not remux)
        $processRunning = $false
        if ($transcodeValue.Process) {
            try {
                $processRunning = -not $transcodeValue.Process.HasExited
            }
            catch {
                $processRunning = $false
            }
        }
        
      
        if ($processRunning) {
            $transcodeValid = $true
            Write-NexusMLog "Using existing HLS session: $transcodeKey (process running, PID: $($transcodeValue.Process.Id))"
        }
        elseif ($transcodeValue.IsComplete -eq $true) {
            # Explicitly marked as complete
            if ($hlsDirExists -and $playlistExists) {
                $transcodeValid = $true
                Write-NexusMLog "Using existing HLS session: $transcodeKey (marked complete)"
            }
        }
        elseif ($transcodeValue.FromCache -eq $true) {
            # Came from cache - check if it was a complete cache entry
            # If we got here, the cache was supposed to be complete when loaded
            if ($hlsDirExists -and $playlistExists) {
                $transcodeValid = $true
                Write-NexusMLog "Using existing HLS session: $transcodeKey (from completed cache)"
            }
        }
        
        if (-not $transcodeValid) {
            # Stale session - remove it from active transcodes
            Write-Host "[!] Removing stale HLS session: $transcodeKey" -ForegroundColor Yellow
            Write-NexusMLog "Removing stale HLS session: $transcodeKey (process not running, not marked complete)"
            $Global:ActiveTranscodes.TryRemove($transcodeKey, [ref]$null) | Out-Null
            
            # v7.30: For stale cache directories, delete them to allow fresh start
            # This prevents the "empty init.mp4" problem
            if ($hlsDirExists) {
                $isCache = $transcodeValue.HLSDirectory -match '[/\\]hls_cache[/\\]'
                
                if ($isCache) {
                    # It's a cache directory - delete it for fresh start
                    try {
                        Remove-Item -Path $transcodeValue.HLSDirectory -Recurse -Force -ErrorAction SilentlyContinue
                        Write-NexusMLog "Removed stale cache HLS directory for fresh start: $($transcodeValue.HLSDirectory)"
                    }
                    catch {
                        Write-NexusMLog "Could not remove stale cache directory: $_" -Level "WARNING"
                    }
                } else {
                    # It's a temp directory - delete it
                    try {
                        Remove-Item -Path $transcodeValue.HLSDirectory -Recurse -Force -ErrorAction SilentlyContinue
                        Write-NexusMLog "Cleaned up stale temp HLS directory: $($transcodeValue.HLSDirectory)"
                    }
                    catch {}
                }
            }
            $existingTranscode = $null
        }
        
        if ($transcodeValid) {
            return @{
                Type = "HLS"
                PlaylistURL = "/hls/$transcodeKey/playlist.m3u8"
                TranscodeId = $transcodeKey
                Mode = $transcodeValue.Mode
            }
        }
    }
    
    $semaphore = $Global:TranscodeSemaphore
    if (-not $semaphore) {
        try {
            $semaphore = Get-PodeState -Name 'TranscodeSemaphore'
        } catch {
            $semaphore = $null
        }
    }
    
    $acquiredSemaphore = $false
    $transcodeStartedSuccessfully = $false
    
    try {
        if ($semaphore) {
            # Try to acquire semaphore immediately (non-blocking check)
            $acquired = $semaphore.Wait(0)
            if (-not $acquired) {
                # Semaphore is full - max concurrent transcodes reached
                Write-Host "[!] Maximum concurrent transcodes reached - waiting for slot..." -ForegroundColor Yellow
                Write-NexusMLog "Transcode queue: waiting for semaphore (max concurrent reached)"
                
                # Wait up to 30 seconds for a slot
                $acquired = $semaphore.Wait(30000)
                if (-not $acquired) {
                    Write-Host "[✗] Transcode queue timeout - server busy, please try again" -ForegroundColor Red
                    Write-NexusMLog "Transcode queue timeout after 30s - returning busy error" -Level "WARNING"
                    return @{
                        Type = "Error"
                        Message = "Server busy - maximum transcodes in progress. Please try again in a moment."
                    }
                }
            }
            $acquiredSemaphore = $true
            Write-NexusMLog "Transcode semaphore acquired - starting FFmpeg"
        }
        
        $hlsInfo = Start-VideoTranscode -InputFile $FilePath -VideoId $VideoId -AudioTrackIndex $AudioTrackIndex -Mode $mode
        
        if ($hlsInfo) {
            $transcodeStartedSuccessfully = $true
            return @{
                Type = "HLS"
                PlaylistURL = "/hls/$($hlsInfo.TranscodeId)/playlist.m3u8"
                TranscodeId = $hlsInfo.TranscodeId
                Mode = $mode
            }
        }
        else {
            Write-Host "[✗] Failed to start HLS session" -ForegroundColor Red
            return $null
        }
    }
    catch {
        Write-Host "[✗] Error starting HLS session: $_" -ForegroundColor Red
        Write-NexusMLog "Exception in Get-SmartVideoStream: $_" -Level "ERROR"
        return $null
    }
    finally {
        if ($acquiredSemaphore -and -not $transcodeStartedSuccessfully -and $semaphore) {
            try {
                $semaphore.Release()
                Write-NexusMLog "Transcode semaphore released (FFmpeg failed to start)"
            } catch {
                Write-NexusMLog "Failed to release semaphore: $_" -Level "WARNING"
            }
        }
    }
}


function Show-TranscodingConfig {
    
    Write-Host "`n=== Transcoding Configuration ===" -ForegroundColor Cyan
    Write-Host "Hardware Acceleration: $(if ($Global:TranscodingConfig.EnableHardwareAccel) { 'Enabled' } else { 'Disabled' })" -ForegroundColor $(if ($Global:TranscodingConfig.EnableHardwareAccel) { 'Green' } else { 'Yellow' })
    Write-Host "Preferred Encoder: $($Global:TranscodingConfig.PreferredEncoder)" -ForegroundColor Cyan
    Write-Host "Video Quality (CRF): $($Global:TranscodingConfig.VideoCRF)" -ForegroundColor Cyan
    Write-Host "Max Bitrate: $($Global:TranscodingConfig.VideoMaxrate)" -ForegroundColor Cyan
    Write-Host "Audio Bitrate: $($Global:TranscodingConfig.AudioBitrate)" -ForegroundColor Cyan
    Write-Host "Max Concurrent Transcodes: $($Global:TranscodingConfig.MaxConcurrentTranscodes)" -ForegroundColor Cyan
    
    if ($Global:FFmpegCapabilities) {
        $encoder = Get-OptimalFFmpegEncoder
        Write-Host "`nActive Encoder: $($encoder.Name) ($($encoder.Type))" -ForegroundColor Green
    }
}

function Set-TranscodingConfig {
    
    Write-Host "`n=== Configure Transcoding ===" -ForegroundColor Cyan
    
    # Hardware acceleration
    $hwChoice = Read-Host "Enable hardware acceleration? (Y/N) [Current: $(if ($Global:TranscodingConfig.EnableHardwareAccel) { 'Y' } else { 'N' })]"
    if ($hwChoice -match '^[YyNn]$') {
        $Global:TranscodingConfig.EnableHardwareAccel = ($hwChoice -match '^[Yy]$')
    }
    
    # Encoder preference
    Write-Host "`nEncoder options: auto, nvenc (NVIDIA), qsv (Intel), amf (AMD), software"
    $encoderChoice = Read-Host "Preferred encoder? [Current: $($Global:TranscodingConfig.PreferredEncoder)]"
    if ($encoderChoice) {
        $validEncoders = @('auto', 'nvenc', 'qsv', 'amf', 'vaapi', 'videotoolbox', 'software')
        if ($validEncoders -contains $encoderChoice.ToLower()) {
            $Global:TranscodingConfig.PreferredEncoder = $encoderChoice.ToLower()
        }
    }
    
    # Quality
    $crfChoice = Read-Host "Video quality CRF (18-28, lower=better) [Current: $($Global:TranscodingConfig.VideoCRF)]"
    if ($crfChoice -match '^\d+$' -and [int]$crfChoice -ge 18 -and [int]$crfChoice -le 28) {
        $Global:TranscodingConfig.VideoCRF = [int]$crfChoice
    }
    
    Write-Host "`n[✓] Configuration updated" -ForegroundColor Green
    Show-TranscodingConfig
}


Write-NexusMLog "FFmpeg Transcoding Module Loaded"

# Initialize debug log with rotation (keep logs for 7 days)
function Initialize-DebugLog {
    $logPath = Join-Path $PSScriptRoot "debug.log"
    
    # Check if log file exists and is older than 7 days
    if (Test-Path $logPath) {
        $logAge = (Get-Date) - (Get-Item $logPath).LastWriteTime
        if ($logAge.Days -ge 7) {
            # Archive old log
            $archiveName = "debug_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
            $archivePath = Join-Path $PSScriptRoot $archiveName
            Move-Item -Path $logPath -Destination $archivePath -Force
            
            # Delete archives older than 30 days
            Get-ChildItem -Path $PSScriptRoot -Filter "debug_*.log" | 
                Where-Object { $_.LastWriteTime -lt (Get-Date).AddDays(-30) } | 
                Remove-Item -Force
        }
    }
    
    # Create/clear log for new session
    "=== PSMediaLibrary Debug Log ===" | Out-File -FilePath $logPath
    "Session started: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath $logPath -Append
    "" | Out-File -FilePath $logPath -Append
}

# Initialize log
Initialize-DebugLog

function Initialize-ConfigFile {
    
    $configPath = Join-Path $PSScriptRoot "NexusM.conf"
    
    
    "[DEBUG] Config file path: $configPath" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    "[DEBUG] Config file exists: $(Test-Path $configPath)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    
    if (Test-Path $configPath) {
        Write-NexusMLog "Loading configuration from NexusM.conf..."
        "[i] Loading configuration from NexusM.conf..." | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
        
        try {
            # Load configuration from CSV file
            $configData = Import-Csv -Path $configPath
            
            
            # Create hashtable from CSV data
            $loadedConfig = @{}
            
            foreach ($item in $configData) {
                $key = $item.Setting
                $value = $item.Value
                
                # Debug output for our specific settings
                if ($key -in @('GhostscriptInstalled', 'FFmpegInstalled')) {
                }
                
                # Parse different value types
                switch ($key) {
                    # Arrays (comma-separated values)
                    { $_ -in @('IPWhitelist', 'VideoExtensions', 'AudioExtensions', 'ImageExtensions', 'PDFExtensions') } {
                        if ([string]::IsNullOrWhiteSpace($value) -or $value -eq '()') {
                            $loadedConfig[$key] = @()
                        } else {
                            $loadedConfig[$key] = $value -split ',' | ForEach-Object { $_.Trim() }
                        }
                    }
                    # Integers
                    { $_ -in @('ServerPort', 'LowQualityVideoThreshold', 'LowQualityAudioThreshold', 'VideoCRF', 'MaxConcurrentTranscodes', 'FFmpegCPULimit', 'LookaheadThreads', 'TranscodeMaxHeight', 'PODEThreads', 'PODESessionTimeout', 'PODERequestTimeout', 'MusicScanFactor', 'VideoScanFactor', 'PDFScanFactor', 'AlbumArtFactor') } {
                        $loadedConfig[$key] = [int]$value
                    }
                    # Booleans (Yes/No or True/False)
                    { $_ -in @('GhostscriptInstalled', 'FFmpegInstalled', 'TranscodingEnabled', 'SecurityByPin', 'MusicVideos', 'Radio', 'InternetTV', 'Pictures', 'Ebooks') } {
                        $loadedConfig[$key] = ($value -eq 'Yes' -or $value -eq 'yes' -or $value -eq 'Y' -or $value -eq 'y' -or $value -eq 'True' -or $value -eq 'true')
                    }
                    # Strings (default)
                    default {
                        $loadedConfig[$key] = $value
                    }
                }
            }
            
           
            "[✓] Configuration loaded successfully" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
            
            # Migration: Add SecurityByPin if not present in existing config
            if (-not $loadedConfig.ContainsKey('SecurityByPin')) {
                Write-NexusMLog "Adding SecurityByPin setting to config file..."
                try {
                    # Read existing config
                    $existingConfig = Import-Csv -Path $configPath
                    
                    # Add new setting
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "SecurityByPin"
                        Value = "True"
                        Description = "Require PIN authentication (True/False). Set to False to auto-login as admin."
                    }
                    
                    # Combine and save
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    # Add to loaded config
                    $loadedConfig['SecurityByPin'] = $true
                    
                    Write-NexusMLog "SecurityByPin setting added to NexusM.conf"
                }
                catch {
                    Write-NexusMLog "Could not add SecurityByPin to config: $_" -Level "WARNING"
                    # Default to true if migration fails
                    $loadedConfig['SecurityByPin'] = $true
                }
            }
            
# Migration: Add ServerHost if not present in existing config (for PODE compatibility)
            if (-not $loadedConfig.ContainsKey('ServerHost')) {
                Write-NexusMLog "Adding ServerHost setting to config file..."
                try {
                    # Read existing config
                    $existingConfig = Import-Csv -Path $configPath
                    
                    # Add new setting with default value of "+"
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "ServerHost"
                        Value = "+"
                        Description = "Server host binding (+ for all interfaces, localhost for local only, or specific IP)"
                    }
                    
                    # Combine and save
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    # Add to loaded config
                    $loadedConfig['ServerHost'] = "+"
                    
                    Write-NexusMLog "ServerHost setting added to NexusM.conf (default: +)"
                }
                catch {
                    Write-NexusMLog "Could not add ServerHost to config: $_" -Level "WARNING"
                    # Default to "+" if migration fails
                    $loadedConfig['ServerHost'] = "+"
                }
            }
            
            # Migration: Add HTTPLoggingLevel if not present in existing config (v7.6 - PODE file logging)
            if (-not $loadedConfig.ContainsKey('HTTPLoggingLevel')) {
                Write-NexusMLog "Adding HTTPLoggingLevel setting to config file..."
                try {
                    # Read existing config
                    $existingConfig = Import-Csv -Path $configPath
                    
                    # Add new setting with default value of "Error"
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "HTTPLoggingLevel"
                        Value = "Error"
                        Description = "PODE HTTP logging level: Error, Warning, Informational, Verbose, Debug, or All"
                    }
                    
                    # Combine and save
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    # Add to loaded config
                    $loadedConfig['HTTPLoggingLevel'] = "Error"
                    
                    Write-NexusMLog "HTTPLoggingLevel setting added to NexusM.conf (default: Error)"
                }
                catch {
                    Write-NexusMLog "Could not add HTTPLoggingLevel to config: $_" -Level "WARNING"
                    # Default to Error if migration fails
                    $loadedConfig['HTTPLoggingLevel'] = "Error"
                }
            }
            
            # Migration: Add PODE and Scanner performance settings if not present (v7.9)
            $performanceSettings = @(
                @{ Name = 'PODEThreads'; Default = 8; Desc = 'Number of PODE web server threads (default: 8)' }
                @{ Name = 'PODESessionTimeout'; Default = 28800; Desc = 'PODE session timeout in seconds (28800 = 8 hours)' }
                @{ Name = 'PODERequestTimeout'; Default = 300; Desc = 'PODE request timeout in seconds for large file operations' }
                @{ Name = 'MusicScanFactor'; Default = 50; Desc = 'Parallel processing throttle limit for music scanning (default: 50)' }
                @{ Name = 'VideoScanFactor'; Default = 10; Desc = 'Parallel processing throttle limit for video scanning (default: 10)' }
                @{ Name = 'PDFScanFactor'; Default = 10; Desc = 'Parallel processing throttle limit for eBook processing (default: 10)' }
                @{ Name = 'AlbumArtFactor'; Default = 10; Desc = 'Parallel processing throttle limit for album artwork extraction (default: 10)' }
            )
            
            $needsUpdate = $false
            $existingConfig = $null
            
            foreach ($setting in $performanceSettings) {
                if (-not $loadedConfig.ContainsKey($setting.Name)) {
                    if (-not $existingConfig) {
                        $existingConfig = Import-Csv -Path $configPath
                        $needsUpdate = $true
                    }
                    
                    # Add new setting
                    $newSetting = [PSCustomObject]@{ 
                        Setting = $setting.Name
                        Value = $setting.Default.ToString()
                        Description = $setting.Desc
                    }
                    $existingConfig = @($existingConfig) + @($newSetting)
                    $loadedConfig[$setting.Name] = $setting.Default
                }
            }
            
            if ($needsUpdate) {
                try {
                    $existingConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    Write-NexusMLog "Performance settings added to NexusM.conf (v7.9)"
                }
                catch {
                    Write-NexusMLog "Could not add performance settings to config: $_" -Level "WARNING"
                }
            }
            
            $musicVideosSettings = @(
                @{ Name = 'MusicVideos'; Default = 'False'; Desc = 'Enable or Disable the Music Videos menu (True/False)' }
            )
            
            $needsMusicVideosUpdate = $false
            $existingConfigMV = $null
            
            foreach ($setting in $musicVideosSettings) {
                if (-not $loadedConfig.ContainsKey($setting.Name)) {
                    if (-not $existingConfigMV) {
                        $existingConfigMV = Import-Csv -Path $configPath
                        $needsMusicVideosUpdate = $true
                    }
                    
                    # Add new setting
                    $newSetting = [PSCustomObject]@{ 
                        Setting = $setting.Name
                        Value = $setting.Default
                        Description = $setting.Desc
                    }
                    $existingConfigMV = @($existingConfigMV) + @($newSetting)
                    
                    # Set default value in loaded config
                    if ($setting.Name -eq 'MusicVideos') {
                        $loadedConfig[$setting.Name] = $false
                    } else {
                        $loadedConfig[$setting.Name] = $setting.Default
                    }
                }
            }
            
            if ($needsMusicVideosUpdate) {
                try {
                    $existingConfigMV | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    Write-NexusMLog "Music Videos settings added to NexusM.conf (v7.10)"
                }
                catch {
                    Write-NexusMLog "Could not add Music Videos settings to config: $_" -Level "WARNING"
                }
            }
            
            $menuVisibilitySettings = @(
                @{ Name = 'Radio'; Default = 'True'; Desc = 'Enable or Disable the Radio menu (True/False)' }
                @{ Name = 'InternetTV'; Default = 'True'; Desc = 'Enable or Disable the Internet TV menu (True/False)' }
                @{ Name = 'Pictures'; Default = 'True'; Desc = 'Enable or Disable the Pictures menu (True/False)' }
                @{ Name = 'Ebooks'; Default = 'True'; Desc = 'Enable or Disable the eBooks menu (True/False)' }
            )
            
            $needsMenuVisibilityUpdate = $false
            $existingConfigMenuVis = $null
            
            foreach ($setting in $menuVisibilitySettings) {
                if (-not $loadedConfig.ContainsKey($setting.Name)) {
                    if (-not $existingConfigMenuVis) {
                        $existingConfigMenuVis = Import-Csv -Path $configPath
                        $needsMenuVisibilityUpdate = $true
                    }
                    
                    # Add new setting
                    $newSetting = [PSCustomObject]@{ 
                        Setting = $setting.Name
                        Value = $setting.Default
                        Description = $setting.Desc
                    }
                    $existingConfigMenuVis = @($existingConfigMenuVis) + @($newSetting)
                    
                    # Set default value in loaded config (default is True for these menus)
                    $loadedConfig[$setting.Name] = $true
                }
            }
            
            if ($needsMenuVisibilityUpdate) {
                try {
                    $existingConfigMenuVis | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    Write-NexusMLog "Menu visibility settings (Radio, InternetTV, Pictures, Ebooks) added to NexusM.conf (v7.19)"
                }
                catch {
                    Write-NexusMLog "Could not add menu visibility settings to config: $_" -Level "WARNING"
                }
            }
            
            # Migration: Add FFmpegCPULimit setting if not present in existing config (v2.0)
            if (-not $loadedConfig.ContainsKey('FFmpegCPULimit')) {
                Write-NexusMLog "Adding FFmpegCPULimit setting to config file..."
                try {
                    # Read existing config
                    $existingConfig = Import-Csv -Path $configPath
                    
                    # Add new setting
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "FFmpegCPULimit"
                        Value = "50"
                        Description = "Limit FFmpeg CPU usage (0-100 percent, 0=no limit). Reduces CPU load during transcoding."
                    }
                    
                    # Combine and save
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    # Add to loaded config
                    $loadedConfig['FFmpegCPULimit'] = 50
                    
                    Write-NexusMLog "FFmpegCPULimit setting added to NexusM.conf"
                }
                catch {
                    Write-NexusMLog "Could not add FFmpegCPULimit to config: $_" -Level "WARNING"
                    # Default to 50 if migration fails
                    $loadedConfig['FFmpegCPULimit'] = 50
                }
            }
            
            if (-not $loadedConfig.ContainsKey('TranscodeMaxHeight')) {
                Write-NexusMLog "Adding TranscodeMaxHeight setting to config file..."
                try {
                    $existingConfig = Import-Csv -Path $configPath
                    
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "TranscodeMaxHeight"
                        Value = "1080"
                        Description = "Max resolution for software transcoding (0=no limit, 1080=limit to 1080p, 720=limit to 720p). Recommended: 1080 for CPU-only systems."
                    }
                    
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    $loadedConfig['TranscodeMaxHeight'] = 1080
                    
                    Write-NexusMLog "TranscodeMaxHeight setting added to NexusM.conf (default: 1080p)"
                    Write-NexusMLog "Added TranscodeMaxHeight=1080 to NexusM.conf (4K will be downscaled to 1080p for software transcoding)"
                }
                catch {
                    Write-NexusMLog "Could not add TranscodeMaxHeight to config: $_" -Level "WARNING"
                    $loadedConfig['TranscodeMaxHeight'] = 1080
                }
            }
            
            if (-not $loadedConfig.ContainsKey('LookaheadThreads')) {
                Write-NexusMLog "Adding LookaheadThreads setting to config file..."
                try {
                    $existingConfig = Import-Csv -Path $configPath
                    
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "LookaheadThreads"
                        Value = "0"
                        Description = "x264 lookahead threads (0=auto/half of CPU threads, 1-16=manual). Higher=faster but more CPU. Default: 0 (auto)"
                    }
                    
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    $loadedConfig['LookaheadThreads'] = 0
                    
                    Write-NexusMLog "LookaheadThreads setting added to NexusM.conf (default: 0/auto)"
                }
                catch {
                    Write-NexusMLog "Could not add LookaheadThreads to config: $_" -Level "WARNING"
                    $loadedConfig['LookaheadThreads'] = 0
                }
            }
            
            # Migration: Add HLS Cache settings if not present (v3.6)
            if (-not $loadedConfig.ContainsKey('HLSCacheEnabled')) {
                Write-NexusMLog "Adding HLS Cache settings to config file..."
                try {
                    $existingConfig = Import-Csv -Path $configPath
                    
                    $newSettings = @(
                        [PSCustomObject]@{ Setting = "HLSCacheEnabled"; Value = "True"; Description = "Enable persistent HLS segment caching (True/False)" }
                        [PSCustomObject]@{ Setting = "HLSCacheMaxSizeGB"; Value = "100"; Description = "Maximum HLS cache size in GB (default: 100)" }
                        [PSCustomObject]@{ Setting = "HLSCacheRetentionDays"; Value = "90"; Description = "Days to keep cached segments before cleanup (default: 90)" }
                    )
                    
                    $updatedConfig = @($existingConfig) + $newSettings
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    $loadedConfig['HLSCacheEnabled'] = "True"
                    $loadedConfig['HLSCacheMaxSizeGB'] = "100"
                    $loadedConfig['HLSCacheRetentionDays'] = "90"
                    
                    Write-NexusMLog "HLS Cache settings added to NexusM.conf (v3.6)"
                }
                catch {
                    Write-NexusMLog "Could not add HLS Cache settings to config: $_" -Level "WARNING"
                    $loadedConfig['HLSCacheEnabled'] = "True"
                    $loadedConfig['HLSCacheMaxSizeGB'] = "100"
                    $loadedConfig['HLSCacheRetentionDays'] = "90"
                }
            }
            
            if (-not $loadedConfig.ContainsKey('VerboseTranscodeLog')) {
                Write-NexusMLog "Adding VerboseTranscodeLog setting to config file..."
                try {
                    $existingConfig = Import-Csv -Path $configPath
                    
                    $newSetting = [PSCustomObject]@{ 
                        Setting = "VerboseTranscodeLog"
                        Value = "True"
                        Description = "Show detailed FFmpeg progress (fps, speed) in transcode.log. True=detailed stats, False=warnings only"
                    }
                    
                    $updatedConfig = @($existingConfig) + @($newSetting)
                    $updatedConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
                    
                    $loadedConfig['VerboseTranscodeLog'] = "True"
                    
                    Write-NexusMLog "VerboseTranscodeLog setting added to NexusM.conf (default: True)"
                }
                catch {
                    Write-NexusMLog "Could not add VerboseTranscodeLog to config: $_" -Level "WARNING"
                    $loadedConfig['VerboseTranscodeLog'] = "True"
                }
            }
            
            # Debug: Show if manual installation flags are set
            if ($loadedConfig.ContainsKey('GhostscriptInstalled')) {
                Write-NexusMLog "GhostscriptInstalled value from config: '$($loadedConfig.GhostscriptInstalled)'"
                "[i] GhostscriptInstalled = $($loadedConfig.GhostscriptInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
            } else {
                "[DEBUG] GhostscriptInstalled NOT in hashtable" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
                "[DEBUG] Keys: $($loadedConfig.Keys -join ', ')" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
            }
            if ($loadedConfig.ContainsKey('FFmpegInstalled')) {
                Write-NexusMLog "FFmpegInstalled value from config: '$($loadedConfig.FFmpegInstalled)'"
                "[i] FFmpegInstalled = $($loadedConfig.FFmpegInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
            }
            
            return $loadedConfig
        }
        catch {
            Write-NexusMLog "Error loading configuration file: $_" -Level "WARNING"
            Write-NexusMLog "Using default configuration values" -Level "WARNING"
            return $null
        }
    }
    else {
        Write-NexusMLog "NexusM.conf not found. Creating new configuration file..."
        
        $defaultConfig = @(
            [PSCustomObject]@{ Setting = "MusicVideos"; Value = "False"; Description = "Enable or Disable the Music Videos menu (True/False)" }
            [PSCustomObject]@{ Setting = "Radio"; Value = "True"; Description = "Enable or Disable the Radio menu (True/False)" }
            [PSCustomObject]@{ Setting = "InternetTV"; Value = "True"; Description = "Enable or Disable the Internet TV menu (True/False)" }
            [PSCustomObject]@{ Setting = "Pictures"; Value = "True"; Description = "Enable or Disable the Pictures menu (True/False)" }
            [PSCustomObject]@{ Setting = "Ebooks"; Value = "True"; Description = "Enable or Disable the eBooks menu (True/False)" }
            [PSCustomObject]@{ Setting = "ServerPort"; Value = "8182"; Description = "Web server port number" }
            [PSCustomObject]@{ Setting = "ServerHost"; Value = "+"; Description = "Server host binding (+ for all interfaces)" }
            [PSCustomObject]@{ Setting = "IPWhitelist"; Value = ""; Description = "Allowed IP addresses (comma-separated, empty for all)" }
            [PSCustomObject]@{ Setting = "SecurityByPin"; Value = "True"; Description = "Require PIN authentication (True/False). Set to False to auto-login as admin." }
            [PSCustomObject]@{ Setting = "TMDB_APIKey"; Value = ""; Description = "TheMovieDB API key for movie posters" }
            [PSCustomObject]@{ Setting = "LastFM_APIKey"; Value = ""; Description = "Last.fm API key for music album art" }
            [PSCustomObject]@{ Setting = "LowQualityVideoThreshold"; Value = "720"; Description = "Video resolution threshold (height in pixels)" }
            [PSCustomObject]@{ Setting = "LowQualityAudioThreshold"; Value = "128"; Description = "Audio bitrate threshold (kbps)" }
            [PSCustomObject]@{ Setting = "VideoExtensions"; Value = ".mp4,.mkv,.avi,.mov,.wmv,.flv,.webm,.m4v"; Description = "Supported video file extensions" }
            [PSCustomObject]@{ Setting = "AudioExtensions"; Value = ".mp3,.flac,.wav,.m4a,.aac,.ogg,.wma,.opus"; Description = "Supported audio file extensions" }
            [PSCustomObject]@{ Setting = "ImageExtensions"; Value = ".jpg,.jpeg,.png,.gif,.bmp,.webp,.tiff"; Description = "Supported image file extensions" }
            [PSCustomObject]@{ Setting = "PDFExtensions"; Value = ".pdf"; Description = "Supported PDF file extensions" }
            [PSCustomObject]@{ Setting = "GhostscriptInstalled"; Value = "No"; Description = "Set to 'Yes' if Ghostscript is manually installed (for eBook previews)" }
            [PSCustomObject]@{ Setting = "FFmpegInstalled"; Value = "No"; Description = "Set to 'Yes' if FFmpeg is manually installed (for album artwork extraction)" }
            
            # Transcoding settings (v4.9)
            [PSCustomObject]@{ Setting = "TranscodingEnabled"; Value = "Yes"; Description = "Enable FFmpeg transcoding for MKV/AVI/etc (Yes/No)" }
            [PSCustomObject]@{ Setting = "PreferredEncoder"; Value = "auto"; Description = "Encoder: auto, nvenc (NVIDIA), qsv (Intel), amf (AMD), software (CPU)" }
            [PSCustomObject]@{ Setting = "VideoPreset"; Value = "veryfast"; Description = "Software encoding speed: ultrafast, veryfast, fast, medium, slow" }
            [PSCustomObject]@{ Setting = "VideoCRF"; Value = "23"; Description = "Video quality (18-28, lower=better, 23=default)" }
            [PSCustomObject]@{ Setting = "VideoMaxrate"; Value = "5M"; Description = "Max video bitrate for hardware encoding" }
            [PSCustomObject]@{ Setting = "AudioBitrate"; Value = "128k"; Description = "Audio bitrate for transcoding" }
            [PSCustomObject]@{ Setting = "MaxConcurrentTranscodes"; Value = "2"; Description = "Max simultaneous transcoding sessions" }
            [PSCustomObject]@{ Setting = "FFmpegCPULimit"; Value = "80"; Description = "Limit FFmpeg CPU usage (0-100 percent, 0=no limit). Reduces CPU load during transcoding." }
            [PSCustomObject]@{ Setting = "LookaheadThreads"; Value = "6"; Description = "x264 lookahead threads (0=auto/half of CPU threads, 1-16=manual). Higher=faster but more CPU. Default: 0 (auto)" }
            [PSCustomObject]@{ Setting = "TranscodeMaxHeight"; Value = "1080"; Description = "Max resolution for software transcoding (0=no limit, 1080=limit to 1080p, 720=limit to 720p). Recommended: 1080 for CPU-only systems." }
            [PSCustomObject]@{ Setting = "VerboseTranscodeLog"; Value = "True"; Description = "Show detailed FFmpeg progress (fps, speed) in transcode.log. True=detailed stats, False=warnings only" }
            
            # HTTP Logging settings (v7.6)
            [PSCustomObject]@{ Setting = "HTTPLoggingLevel"; Value = "Error"; Description = "PODE HTTP logging level: Error, Warning, Informational, Verbose, Debug, or All" }
            
            # PODE Performance Settings (v7.9)
            [PSCustomObject]@{ Setting = "PODEThreads"; Value = "8"; Description = "Number of PODE web server threads (default: 8)" }
            [PSCustomObject]@{ Setting = "PODESessionTimeout"; Value = "28800"; Description = "PODE session timeout in seconds (28800 = 8 hours)" }
            [PSCustomObject]@{ Setting = "PODERequestTimeout"; Value = "300"; Description = "PODE request timeout in seconds for large file operations" }
            
            # Media Scanner Parallel Processing Settings (v7.9)
            [PSCustomObject]@{ Setting = "MusicScanFactor"; Value = "50"; Description = "Parallel processing throttle limit for music scanning (default: 50)" }
            [PSCustomObject]@{ Setting = "VideoScanFactor"; Value = "10"; Description = "Parallel processing throttle limit for video scanning (default: 10)" }
            [PSCustomObject]@{ Setting = "PDFScanFactor"; Value = "10"; Description = "Parallel processing throttle limit for eBook processing (default: 10)" }
            [PSCustomObject]@{ Setting = "AlbumArtFactor"; Value = "10"; Description = "Parallel processing throttle limit for album artwork extraction (default: 10)" }
            
            [PSCustomObject]@{ Setting = "HLSCacheEnabled"; Value = "True"; Description = "Enable persistent HLS segment caching (True/False)" }
            [PSCustomObject]@{ Setting = "HLSCacheMaxSizeGB"; Value = "100"; Description = "Maximum HLS cache size in GB (default: 100)" }
            [PSCustomObject]@{ Setting = "HLSCacheRetentionDays"; Value = "90"; Description = "Days to keep cached segments before cleanup (default: 90)" }
            
        )
        
        try {
            # Export to CSV
            $defaultConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
            
            Write-NexusMLog "Created NexusM.conf with default settings"
            Write-NexusMLog "You can edit this file to customize your configuration"
            
            return $null  # Return null to use hardcoded defaults for first run
        }
        catch {
            Write-NexusMLog "Error creating configuration file: $_" -Level "ERROR"
            Write-NexusMLog "Using default configuration values" -Level "WARNING"
            return $null
        }
    }
}

function Update-ServerHostInConfig {
    param(
        [Parameter(Mandatory=$true)]
        [string]$NewServerHost
    )
    
    $configPath = Join-Path $PSScriptRoot "NexusM.conf"
    
    if (Test-Path $configPath) {
        try {
            # Read existing config
            $existingConfig = Import-Csv -Path $configPath
            
            # Find and update ServerHost setting
            $serverHostFound = $false
            foreach ($item in $existingConfig) {
                if ($item.Setting -eq "ServerHost") {
                    $item.Value = $NewServerHost
                    $serverHostFound = $true
                    break
                }
            }
            
            # If ServerHost doesn't exist, add it
            if (-not $serverHostFound) {
                $newSetting = [PSCustomObject]@{ 
                    Setting = "ServerHost"
                    Value = $NewServerHost
                    Description = "Server host binding (+ for all interfaces, localhost for local only, or specific IP)"
                }
                $existingConfig = @($existingConfig) + @($newSetting)
            }
            
            # Save updated config
            $existingConfig | Export-Csv -Path $configPath -NoTypeInformation -Encoding UTF8
            
            Write-Host "[✓] ServerHost updated to '$NewServerHost' in NexusM.conf" -ForegroundColor Green
            return $true
        }
        catch {
            Write-Host "[✗] Failed to update ServerHost in config: $_" -ForegroundColor Red
            return $false
        }
    }
    else {
        Write-Host "[!] Config file not found at: $configPath" -ForegroundColor Yellow
        return $false
    }
}


# Load configuration from file or create default
"[DEBUG] About to call Initialize-ConfigFile" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
$LoadedConfig = Initialize-ConfigFile
"[DEBUG] LoadedConfig is null: $($null -eq $LoadedConfig)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
if ($LoadedConfig) {
    "[DEBUG] LoadedConfig type: $($LoadedConfig.GetType().Name)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    "[DEBUG] LoadedConfig has $($LoadedConfig.Count) items" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
}


# Define Radio Stations array
$RadioStationsArray = @(
    # ========== NORTH AMERICA - USA ==========
    @{ Name = "NPR News"; Country = "USA"; Genre = "News"; URL = "https://npr-ice.streamguys1.com/live.mp3"; Description = "National Public Radio - News & Talk"; Logo = "radiologos/USA/npr.png" }
    @{ Name = "KEXP Seattle"; Country = "USA"; Genre = "Alternative Rock"; URL = "https://kexp-mp3-128.streamguys1.com/kexp128.mp3"; Description = "Independent alternative music from Seattle"; Logo = "radiologos/USA/kexp.png" }
    @{ Name = "181.FM Fusion Jazz"; Country = "USA"; Genre = "Jazz"; URL = "https://listen.181fm.com/181-fusionjazz_128k.mp3"; Description = "Fusion jazz hits" ; Logo = "radiologos/USA/14344.v3.png"}
    @{ Name = "WNYC New York"; Country = "USA"; Genre = "News/Talk"; URL = "https://fm939.wnyc.org/wnycfm"; Description = "New York Public Radio"; Logo = "radiologos/USA/wnyc.png" }
    @{ Name = "Radio Paradise"; Country = "USA"; Genre = "Eclectic Rock"; URL = "https://stream.radioparadise.com/aac-320"; Description = "Commercial-free eclectic music"; Logo = "radiologos/USA/radioparadise.png" }
    @{ Name = "SomaFM Groove Salad"; Country = "USA"; Genre = "Ambient/Downtempo"; URL = "https://ice1.somafm.com/groovesalad-128-mp3"; Description = "Ambient/downtempo grooves"; Logo = "radiologos/USA/groovesalad-400.png" }
    @{ Name = "SomaFM Defcon"; Country = "USA"; Genre = "Hacker/Electronic"; URL = "https://ice1.somafm.com/defcon-128-mp3"; Description = "Music for hacking"; Logo = "radiologos/USA/defcon400.png" }
    @{ Name = "181.FM The Rock"; Country = "USA"; Genre = "Classic Rock"; URL = "https://listen.181fm.com/181-rock_128k.mp3"; Description = "Classic rock hits"; Logo = "radiologos/USA/181_logo_300.webp" }
    @{ Name = "NPR National Live"; Country = "USA"; Genre = "News/Talk"; URL = "https://npr-ice.streamguys1.com/live.mp3"; Description = "National Public Radio live stream"; Logo = "radiologos/USA/npr.png" }
    @{ Name = "181.FM Energy 93"; Country = "USA"; Genre = "Top 40/Dance"; URL = "https://listen.181fm.com/181-energy93_128k.mp3"; Description = "Top 40 & dance hits"; Logo = "radiologos/USA/14344.v3.png" }
    @{ Name = "181.FM Classical Guitar"; Country = "USA"; Genre = "Classical"; URL = "https://listen.181fm.com/181-classicalguitar_128k.mp3"; Description = "Relaxing classical guitar"; Logo = "radiologos/USA/14344.v3.png" }
    @{ Name = "SomaFM Secret Agent"; Country = "USA"; Genre = "Lounge/Chill"; URL = "https://ice2.somafm.com/secretagent-128-mp3"; Description = "Spy-themed downtempo grooves"; Logo = "radiologos/USA/secret.png" }
    @{ Name = "SomaFM Indie Pop Rocks"; Country = "USA"; Genre = "Indie Pop"; URL = "https://ice2.somafm.com/indiepop-128-mp3"; Description = "Indie pop & alt rock"; Logo = "radiologos/USA/somaindie.png" }
   
    # ========== EUROPE - UK ==========
    # NOTE: Most BBC stations are geo-restricted to UK only (except World Service)
    @{ Name = "BBC Radio 1"; Country = "UK"; Genre = "Pop/Dance"; URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_one"; Description = "BBC's flagship pop music station"; Logo = "radiologos/Uk/bbc-radio-1-logo-png_seeklogo-314493.png" }
    @{ Name = "BBC Radio 2"; Country = "UK"; Genre = "Pop/Rock"; URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_two"; Description = "Popular music and culture"; Logo = "radiologos/Uk/bbc-radio-2-logo-png_seeklogo-314524.png" }
    @{ Name = "BBC Radio 3"; Country = "UK"; Genre = "Classical"; URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_three"; Description = "Classical music and culture"; Logo = "radiologos/Uk/bbc-radio-3-logo-png_seeklogo-314577.png" }
    @{ Name = "BBC Radio 4"; Country = "UK"; Genre = "News/Talk"; URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourfm"; Description = "News, drama and documentaries"; Logo = "radiologos/Uk/bbc-radio-4-logo-png_seeklogo-314491.png" }
    @{ Name = "BBC Radio 6 Music"; Country = "UK"; Genre = "Alternative"; URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_6music"; Description = "Alternative music"; Logo = "radiologos/Uk/bbc-radio-6-music-logo-png_seeklogo-314590.png" }
    @{ Name = "BBC World Service"; Country = "UK"; Genre = "World News"; URL = "https://stream.live.vc.bbcmedia.co.uk/bbc_world_service"; Description = "International news and analysis"; Logo = "radiologos/Uk/BBC_World_Service.png" }
    @{ Name = "Heart UK"; Country = "UK"; Genre = "Pop"; URL = "https://media-ice.musicradio.com/HeartLondonMP3"; Description = "Feel good music from London"; Logo = "radiologos/Uk/heart.webp" }
    @{ Name = "Smooth Chill UK"; Country = "UK"; Genre = "Chill"; URL = "https://media-ice.musicradio.com/SmoothChillMP3"; Description = "Relaxing smooth chill vibes"; Logo = "radiologos/Uk/SMOOTH-CHILL.png" }
    
    
    # ========== EUROPE - FRANCE ==========
    @{ Name = "FIP Radio"; Country = "France"; Genre = "Eclectic"; URL = "https://direct.fipradio.fr/live/fip-midfi.mp3"; Description = "Eclectic French music discovery"; Logo = "radiologos/France/fip.webp" }
    @{ Name = "France Musique"; Country = "France"; Genre = "Classical"; URL = "https://direct.francemusique.fr/live/francemusique-midfi.mp3"; Description = "French classical music"; Logo = "radiologos/France/france-musique.webp" }
    @{ Name = "France Info"; Country = "France"; Genre = "News"; URL = "https://direct.franceinfo.fr/live/franceinfo-midfi.mp3"; Description = "24/7 French news"; Logo = "radiologos/France/france-info.png" }
    @{ Name = "France Bleu"; Country = "France"; Genre = "Local/Pop"; URL = "https://direct.francebleu.fr/live/fb1071-midfi.mp3"; Description = "French local radio"; Logo = "radiologos/France/france-bleu.webp" }
    @{ Name = "Europe 1"; Country = "France"; Genre = "News/Talk"; URL = "http://stream.europe1.fr/europe1.mp3"; Description = "French news and information"; Logo = "radiologos/France/europe.webp" }
    @{ Name = "RTL France"; Country = "France"; Genre = "News/Talk"; URL = "http://streaming.radio.rtl.fr/rtl-1-44-128"; Description = "French news and talk"; Logo = "radiologos/France/rtl.webp" }
    @{ Name = "RTL2 France"; Country = "France"; Genre = "Pop/Rock"; URL = "http://streaming.radio.rtl2.fr/rtl2-1-44-128"; Description = "French pop and rock"; Logo = "radiologos/France/rtl2.webp" }
    @{ Name = "Fun Radio"; Country = "France"; Genre = "Dance/Electronic"; URL = "http://streaming.radio.funradio.fr/fun-1-44-128"; Description = "French dance music"; Logo = "radiologos/France/fun.webp" }
    @{ Name = "Skyrock"; Country = "France"; Genre = "Hip-Hop/R&B"; URL = "https://icecast.skyrock.net/s/natio_mp3_128k"; Description = "French hip-hop and R&B"; Logo = "radiologos/France/skyrock.webp" }
    @{ Name = "TSF Jazz"; Country = "France"; Genre = "Jazz"; URL = "http://tsfjazz.ice.infomaniak.ch/tsfjazz-high.mp3"; Description = "French jazz radio"; Logo = "radiologos/France/jazz.webp" }
    @{ Name = "MFM Radio"; Country = "France"; Genre = "Pop"; URL = "http://mfm.ice.infomaniak.ch/mfm-128.mp3"; Description = "French pop hits"; Logo = "radiologos/France/mfm.webp" }
    @{ Name = "Generations FM"; Country = "France"; Genre = "Urban"; URL = "http://generationfm.ice.infomaniak.ch/generationfm-high.mp3"; Description = "French urban music"; Logo = "radiologos/France/generations.webp" }
    
    # ========== EUROPE - GERMANY ==========
    @{ Name = "1Live"; Country = "Germany"; Genre = "Pop/Rock"; URL = "https://wdr-1live-live.icecastssl.wdr.de/wdr/1live/live/mp3/128/stream.mp3"; Description = "German contemporary music"; Logo = "radiologos/Germany/eins-live.png" }
    @{ Name = "WDR 2"; Country = "Germany"; Genre = "Pop"; URL = "https://wdr-wdr2-ruhrgebiet.icecastssl.wdr.de/wdr/wdr2/ruhrgebiet/mp3/128/stream.mp3"; Description = "German popular radio"; Logo = "radiologos/Germany/wdr2.webp" }
    @{ Name = "WDR 5"; Country = "Germany"; Genre = "News/Culture"; URL = "https://wdr-wdr5-live.icecastssl.wdr.de/wdr/wdr5/live/mp3/128/stream.mp3"; Description = "German news and culture"; Logo = "radiologos/Germany/wdr5.png" }
    @{ Name = "Antenne Bayern"; Country = "Germany"; Genre = "Pop/Rock"; URL = "https://mp3channels.webradio.antenne.de/antenne"; Description = "Bavarian hit radio"; Logo = "radiologos/Germany/antenne.png" }
    @{ Name = "Radio BOB!"; Country = "Germany"; Genre = "Rock"; URL = "https://streams.radiobob.de/bob-national/mp3-192/streams.radiobob.de/"; Description = "German rock station"; Logo = "radiologos/Germany/bob.webp" }
    @{ Name = "FFH"; Country = "Germany"; Genre = "Pop"; URL = "https://mp3.ffh.de/radioffh/hqlivestream.mp3"; Description = "Hit Radio FFH"; Logo = "radiologos/Germany/ffh.webp" }
    @{ Name = "JAM FM"; Country = "Germany"; Genre = "R&B/Hip-Hop"; URL = "https://stream.jam.fm/jamfm-live/mp3-128"; Description = "Berlin urban music"; Logo = "radiologos/Germany/jam-fm.webp" }
    @{ Name = "Kiss FM Berlin"; Country = "Germany"; Genre = "Dance/Electronic"; URL = "https://stream.kissfm.de/kissfm/mp3-128"; Description = "Berlin dance music"; Logo = "radiologos/Germany/kiss-berlin.webp" }
    @{ Name = "Sunshine Live"; Country = "Germany"; Genre = "Dance/Electronic"; URL = "https://stream.sunshine-live.de/live/mp3-192"; Description = "Mannheim dance radio"; Logo = "radiologos/Germany/sunshine-mannheim.webp" }
    @{ Name = "SAW Magdeburg"; Country = "Germany"; Genre = "Pop/Rock"; URL = "https://stream.saw-musikwelt.de/saw/mp3-128"; Description = "Saxony-Anhalt hits"; Logo = "radiologos/Germany/saw-magdeburg.webp" }
    @{ Name = "Musik Club"; Country = "Germany"; Genre = "Dance"; URL = "https://streams.deltaradio.de/musik-club/mp3-192"; Description = "German dance club hits"; Logo = "radiologos/Germany/musik-club.webp" }
    @{ Name = "Blackbeats FM"; Country = "Germany"; Genre = "Urban"; URL = "https://stream.blackbeats.fm/live"; Description = "German urban station"; Logo = "radiologos/Germany/blackbeats.png" }
    
    # ========== EUROPE - NETHERLANDS ==========
    @{ Name = "NPO Radio 1"; Country = "Netherlands"; Genre = "News/Talk"; URL = "https://icecast.omroep.nl/radio1-bb-mp3"; Description = "Dutch news and talk"; Logo = "radiologos/Netherlands/npo-1.webp" }
    @{ Name = "NPO Radio 2"; Country = "Netherlands"; Genre = "Pop"; URL = "https://icecast.omroep.nl/radio2-bb-mp3"; Description = "Dutch popular music"; Logo = "radiologos/Netherlands/npo-2.webp" }
    @{ Name = "Radio 538"; Country = "Netherlands"; Genre = "Pop/Dance"; URL = "https://22723.live.streamtheworld.com/RADIO538.mp3"; Description = "Dutch hit music"; Logo = "radiologos/Netherlands/538.webp" }
    @{ Name = "100% NL"; Country = "Netherlands"; Genre = "Dutch Pop"; URL = "https://stream.100p.nl/100pctnl.mp3"; Description = "Only Dutch music"; Logo = "radiologos/Netherlands/100-nl.webp" }
    @{ Name = "Radio Veronica"; Country = "Netherlands"; Genre = "Rock/Pop"; URL = "https://25293.live.streamtheworld.com/VERONICA.mp3"; Description = "Dutch rock and pop"; Logo = "radiologos/Netherlands/veronica.webp" }
    @{ Name = "Sky Radio"; Country = "Netherlands"; Genre = "Love Songs"; URL = "https://25293.live.streamtheworld.com/SKYRADIO.mp3"; Description = "Dutch love songs"; Logo = "radiologos/Netherlands/sky-lovesongs.png" }
    @{ Name = "Radio NL"; Country = "Netherlands"; Genre = "Dutch Hits"; URL = "https://stream.radionl.fm/radionl"; Description = "Dutch hits station"; Logo = "radiologos/Netherlands/radionl.webp" }
    @{ Name = "Classic FM Netherlands"; Country = "Netherlands"; Genre = "Classical"; URL = "https://icecast.omroep.nl/radio4-bb-mp3"; Description = "Dutch classical music"; Logo = "radiologos/Netherlands/classic-fm.webp" }
    @{ Name = "Arrow Classic Rock"; Country = "Netherlands"; Genre = "Classic Rock"; URL = "https://stream.gal.io/arrow"; Description = "Dutch classic rock"; Logo = "radiologos/Netherlands/arrow-classic-rock.png" }
    @{ Name = "FunX"; Country = "Netherlands"; Genre = "Hip-Hop"; URL = "https://icecast.omroep.nl/funx-bb-mp3"; Description = "Dutch hip-hop station"; Logo = "radiologos/Netherlands/funx-hiphop.png" }
    
    # ========== EUROPE - ITALY ==========
    @{ Name = "RAI Radio 2"; Country = "Italy"; Genre = "Pop/Rock"; URL = "https://icestreaming.rai.it/2.mp3"; Description = "Italian contemporary music"; Logo = "radiologos/Italy/rai-2.webp" }
    @{ Name = "Radio Kiss Kiss"; Country = "Italy"; Genre = "Pop"; URL = "https://ice07.fluidstream.net/KissKiss.mp3"; Description = "Italian pop hits"; Logo = "radiologos/Italy/kiss-kiss.webp" }
    @{ Name = "Virgin Radio Italy"; Country = "Italy"; Genre = "Rock"; URL = "https://icy.unitedradio.it/Virgin.mp3"; Description = "Italian rock station"; Logo = "radiologos/Italy/virgin.webp" }
    @{ Name = "Radio Monte Carlo"; Country = "Italy"; Genre = "Pop/Rock"; URL = "https://icy.unitedradio.it/RMC.mp3"; Description = "Italian entertainment radio"; Logo = "radiologos/Italy/monte-carlo.webp" }
    @{ Name = "Radio 105"; Country = "Italy"; Genre = "Pop/Rock"; URL = "https://icy.unitedradio.it/Radio105.mp3"; Description = "Italian contemporary hits"; Logo = "radiologos/Italy/piu-brescia.webp" }
    
    # ========== EUROPE - BELGIUM ==========
    @{ Name = "VRT Radio 1"; Country = "Belgium"; Genre = "News/Talk"; URL = "http://icecast.vrtcdn.be/radio1-high.mp3"; Description = "Flemish news and talk"; Logo = "radiologos/Belgium/vrt-1.webp" }
    @{ Name = "Studio Brussel"; Country = "Belgium"; Genre = "Alternative"; URL = "http://icecast.vrtcdn.be/stubru-high.mp3"; Description = "Belgian alternative music"; Logo = "radiologos/Belgium/studio-brussel.webp" }
    @{ Name = "Klara Continuo"; Country = "Belgium"; Genre = "Classical"; URL = "http://icecast.vrtcdn.be/klara-high.mp3"; Description = "Flemish classical music"; Logo = "radiologos/Belgium/klara-continuo.webp" }
    @{ Name = "Classic 21"; Country = "Belgium"; Genre = "Rock"; URL = "https://radios.rtbf.be/classic21-128.mp3"; Description = "Belgian rock station"; Logo = "radiologos/Belgium/rtbf-classic-21.webp" }
    @{ Name = "Bel RTL"; Country = "Belgium"; Genre = "News/Talk"; URL = "https://belrtl.ice.infomaniak.ch/belrtl-mp3-128.mp3"; Description = "Belgian news and talk"; Logo = "radiologos/Belgium/bel-rtl.png" }
    @{ Name = "Joe FM"; Country = "Belgium"; Genre = "Pop/Rock"; URL = "https://playerservices.streamtheworld.com/api/livestream-redirect/JOE.mp3"; Description = "Belgian popular music"; Logo = "radiologos/Belgium/joefm.webp" }
    @{ Name = "NRJ Belgium"; Country = "Belgium"; Genre = "Dance/Pop"; URL = "https://playerservices.streamtheworld.com/api/livestream-redirect/NRJBELGIE.mp3"; Description = "Belgian dance and pop"; Logo = "radiologos/Belgium/nrj.webp" }
    
    # ========== EUROPE - IRELAND ==========
    @{ Name = "RTÉ 2FM"; Country = "Ireland"; Genre = "Pop/Rock"; URL = "https://icecast.rte.ie/2fm"; Description = "Irish contemporary music"; Logo = "radiologos/Ireland/rte-2fm.webp" }
    @{ Name = "RTÉ Gold"; Country = "Ireland"; Genre = "Oldies"; URL = "https://icecast.rte.ie/gold"; Description = "Irish classic hits"; Logo = "radiologos/Ireland/rte-gold.webp" }
    @{ Name = "Today FM"; Country = "Ireland"; Genre = "Music/Talk"; URL = "https://edge.audioxi.com/TDAAC"; Description = "Irish music and talk"; Logo = "radiologos/Ireland/today-fm.webp" }
    
    # ========== EUROPE - SWITZERLAND ==========
    @{ Name = "SRF 1"; Country = "Switzerland"; Genre = "Pop/News"; URL = "http://stream.srg-ssr.ch/m/rsp/mp3_128"; Description = "Swiss German radio"; Logo = "radiologos/Schweiz/srf-1-zurich-schaffhausen.png" }
    @{ Name = "SRF 2 Kultur"; Country = "Switzerland"; Genre = "Culture/Classical"; URL = "http://stream.srg-ssr.ch/m/rsc_de/mp3_128"; Description = "Swiss culture radio"; Logo = "radiologos/Schweiz/srf-2-kultur.png" }
    @{ Name = "SRF Musikwelle"; Country = "Switzerland"; Genre = "Folk/Oldies"; URL = "http://stream.srg-ssr.ch/m/regi_ag_so/mp3_128"; Description = "Swiss folk music"; Logo = "radiologos/Schweiz/srf-musikwelle.webp" }
    @{ Name = "Radio Swiss Jazz"; Country = "Switzerland"; Genre = "Jazz"; URL = "http://stream.srg-ssr.ch/m/rsj/mp3_128"; Description = "24/7 Swiss jazz"; Logo = "radiologos/Schweiz/swiss-pop.webp" }
    @{ Name = "Radio Swiss Classic"; Country = "Switzerland"; Genre = "Classical"; URL = "http://stream.srg-ssr.ch/m/rsc_de/mp3_128"; Description = "24/7 Swiss classical"; Logo = "radiologos/Schweiz/1.webp" }
    @{ Name = "Radio Swiss Pop"; Country = "Switzerland"; Genre = "Pop"; URL = "http://stream.srg-ssr.ch/m/rsp/mp3_128"; Description = "24/7 Swiss pop hits"; Logo = "radiologos/Schweiz/swiss-pop.webp" }
    @{ Name = "Energy Zürich"; Country = "Switzerland"; Genre = "Dance/Pop"; URL = "https://energyzuerich.ice.infomaniak.ch/energyzuerich-high.mp3"; Description = "Zurich dance hits"; Logo = "radiologos/Schweiz/energy-zurich.png" }
    @{ Name = "RTS Couleur 3"; Country = "Switzerland"; Genre = "Alternative"; URL = "http://stream.srg-ssr.ch/m/couleur3/mp3_128"; Description = "Swiss French alternative"; Logo = "radiologos/Schweiz/rts-couleur-3.webp" }
)


function Import-M3UPlaylist {

    param(
        [Parameter(Mandatory=$true)]
        [string]$Path,
        
        [string]$DefaultCountry = "International"
    )
    
    $channels = @()
    
    if (-not (Test-Path $Path)) {
        Write-NexusMLog "M3U file not found: $Path" -Level "WARNING"
        return $channels
    }
    
    try {
        $lines = Get-Content $Path -Encoding UTF8
        $currentInfo = $null
        
        foreach ($line in $lines) {
            $line = $line.Trim()
            
            # Skip empty lines and M3U header
            if ([string]::IsNullOrWhiteSpace($line) -or $line -eq '#EXTM3U') {
                continue
            }
            
            # Parse EXTINF line
            if ($line.StartsWith('#EXTINF:')) {
                
                $currentInfo = @{
                    Name = ""
                    Country = $DefaultCountry
                    Genre = "TV"
                    Logo = ""
                    Description = ""
                }
                
                # Extract channel name (after the last comma)
                if ($line -match ',([^,]+)$') {
                    $currentInfo.Name = $matches[1].Trim()
                    # Clean up resolution info from name for description
                    if ($currentInfo.Name -match '\((\d+p)\)') {
                        $currentInfo.Description = "Quality: $($matches[1])"
                    }
                }
                
                # Extract tvg-logo
                if ($line -match 'tvg-logo="([^"]*)"') {
                    $currentInfo.Logo = $matches[1]
                }
                
                # Extract group-title (often contains country or category)
                if ($line -match 'group-title="([^"]*)"') {
                    $groupTitle = $matches[1]
                    # Try to detect if it's a country or genre
                    $knownCountries = @('France', 'USA', 'UK', 'Germany', 'Spain', 'Italy', 'Netherlands', 'Belgium', 'Switzerland', 'Canada', 'Australia', 'Japan', 'China', 'India', 'Brazil', 'Mexico', 'Russia', 'Poland', 'Turkey', 'Arabic', 'Qatar', 'UAE')
                    
                    $matchedCountry = $knownCountries | Where-Object { $groupTitle -like "*$_*" } | Select-Object -First 1
                    if ($matchedCountry) {
                        $currentInfo.Country = $matchedCountry
                    } else {
                        # Use group-title as genre if not a country
                        $currentInfo.Genre = $groupTitle
                    }
                }
                
                # Extract tvg-country if present
                if ($line -match 'tvg-country="([^"]*)"') {
                    $currentInfo.Country = $matches[1]
                }
                
                # Try to detect country from tvg-id (e.g., "BFMTV.fr@SD" -> France)
                if ($line -match 'tvg-id="[^"]*\.([a-z]{2})[@"]' -and $currentInfo.Country -eq $DefaultCountry) {
                    $countryCode = $matches[1].ToUpper()
                    $countryMap = @{
                        'FR' = 'France'
                        'US' = 'USA'
                        'GB' = 'UK'
                        'UK' = 'UK'
                        'DE' = 'Germany'
                        'ES' = 'Spain'
                        'IT' = 'Italy'
                        'NL' = 'Netherlands'
                        'BE' = 'Belgium'
                        'CH' = 'Switzerland'
                        'CA' = 'Canada'
                        'AU' = 'Australia'
                        'JP' = 'Japan'
                        'CN' = 'China'
                        'IN' = 'India'
                        'BR' = 'Brazil'
                        'MX' = 'Mexico'
                        'RU' = 'Russia'
                        'PL' = 'Poland'
                        'TR' = 'Turkey'
                        'QA' = 'Qatar'
                        'AE' = 'UAE'
                    }
                    if ($countryMap.ContainsKey($countryCode)) {
                        $currentInfo.Country = $countryMap[$countryCode]
                    }
                }
                
                continue
            }
            
            # URL line (not starting with #)
            if (-not $line.StartsWith('#') -and $currentInfo) {
                # This is the stream URL
                if ($line -match '^https?://') {
                    $channel = @{
                        Name        = $currentInfo.Name
                        Country     = $currentInfo.Country
                        Genre       = $currentInfo.Genre
                        URL         = $line
                        Description = $currentInfo.Description
                        Logo        = $currentInfo.Logo
                        Source      = "M3U"
                    }
                    $channels += $channel
                }
                $currentInfo = $null
            }
        }
        
        Write-NexusMLog "Parsed $($channels.Count) channels from M3U: $(Split-Path -Leaf $Path)"
    }
    catch {
        Write-NexusMLog "Error parsing M3U file $Path : $_" -Level "WARNING"
    }
    
    return $channels
}

function Get-TVChannelsFromConfig {
    
    $tvConfigPath = Join-Path $PSScriptRoot "tvchannels.conf"
    $tvPlaylistsFolder = Join-Path $PSScriptRoot "assets\tvplaylists"
    
    # If config file doesn't exist, create default
    if (-not (Test-Path $tvConfigPath)) {
        Write-NexusMLog "Creating default tvchannels.conf..."
        
        $defaultContent = @"
# NexusM Internet TV Channels Configuration
# Format: Name,Country,Genre,URL,Description,Logo
# Maximum: 10 countries, 30 channels per country displayed per page
# Logo: Optional - can be local path (tvlogos/country/file.png) or URL
# Lines starting with # are comments
#
# TIP: You can also drop .m3u/.m3u8 playlist files into the 'assets\tvplaylists' folder
#      and they will be automatically imported!
#
# ========== FRANCE ==========
France 24 French,France,News,https://live.france24.com/hls/live/2037179/F24_FR_HI_HLS/master_5000.m3u8,French international news,tvlogos/France/france24.png
France 24 English,France,News,https://live.france24.com/hls/live/2037218/F24_EN_HI_HLS/master_5000.m3u8,International news in English,tvlogos/France/france24.png
Euronews French,France,News,https://rakuten-euronews-2-fr.samsung.wurl.tv/manifest/playlist.m3u8,European news coverage,tvlogos/France/euronews.png
TV5Monde Info,France,News,https://ott.tv5monde.com/Content/HLS/Live/channel(info)/variant.m3u8,Francophone world news,tvlogos/France/tv5monde.png
#
# ========== USA ==========
ABC News Live,USA,News,https://content.uplynk.com/channel/3324f2467c414329b3b0cc5cd987b6be.m3u8,ABC News 24/7 coverage,tvlogos/USA/abc.png
CBS News,USA,News,https://cbsnews.akamaized.net/hls/live/2020607/cbsnlineup_8/master.m3u8,CBS News live stream,tvlogos/USA/cbs.png
NBC News NOW,USA,News,https://nbcnews.akamaized.net/hls/live/2028003/nbcnews/master.m3u8,NBC News streaming,tvlogos/USA/nbc.png
Bloomberg TV,USA,Business,https://www.bloomberg.com/media-manifest/streams/us.m3u8,Business and financial news,tvlogos/USA/bloomberg.png
Newsy,USA,News,https://content.uplynk.com/channel/5fc43140a4fc4e2087b4f9db70dbb5bd.m3u8,Independent news coverage,tvlogos/USA/newsy.png
#
# ========== UK ==========
Sky News,UK,News,https://linear418-gb-hls1-prd-ak.cdn.skycdp.com/100e/Content/HLS_001_1080_30/Live/channel(skynews)/index.m3u8,UK and world news,tvlogos/UK/skynews.png
GB News,UK,News,https://live-manifest.tubi.io/live/gbnews/playlist.m3u8,British news channel,tvlogos/UK/gbnews.png
#
# ========== GERMANY ==========
DW News,Germany,News,https://dwamdstream104.akamaized.net/hls/live/2015530/dwstream104/index.m3u8,German international news,tvlogos/Germany/dw.png
DW Deutsch,Germany,News,https://dwamdstream102.akamaized.net/hls/live/2015525/dwstream102/index.m3u8,Deutsche Welle German,tvlogos/Germany/dw.png
Tagesschau24,Germany,News,https://tagesschau.akamaized.net/hls/live/2020115/tagesschau/tagesschau_1/master.m3u8,German daily news,tvlogos/Germany/tagesschau.png
#
# ========== SPAIN ==========
RTVE 24h,Spain,News,https://rtvelivestream.akamaized.net/24h_dvr/24h_dvr_720.m3u8,Spanish 24h news,tvlogos/Spain/rtve.png
Euronews Spanish,Spain,News,https://rakuten-euronews-2-es.samsung.wurl.tv/manifest/playlist.m3u8,European news in Spanish,tvlogos/Spain/euronews.png
#
# ========== ITALY ==========
Rai News 24,Italy,News,https://mediapolis.rai.it/relinker/relinkerServlet.htm?cont=1,Italian 24h news,tvlogos/Italy/rainews.png
#
# ========== MIDDLE EAST ==========
Al Jazeera English,Qatar,News,https://live-hls-web-aje.getaj.net/AJE/index.m3u8,International news from Qatar,tvlogos/MiddleEast/aljazeera.png
Al Jazeera Arabic,Qatar,News,https://live-hls-web-aja.getaj.net/AJA/index.m3u8,Arabic news channel,tvlogos/MiddleEast/aljazeera.png
#
# ========== ASIA ==========
CGTN,China,News,https://live.cgtn.com/1000/prog_index.m3u8,Chinese global television,tvlogos/Asia/cgtn.png
NHK World Japan,Japan,News,https://nhkworld.webcdn.stream.ne.jp/www11/nhkworld-tv/domestic/263942/live.m3u8,Japanese international news,tvlogos/Asia/nhk.png
Arirang TV,South Korea,News,https://amdlive-ch01-ctnd-com.akamaized.net/arirang_1ch/smil:arirang_1ch.smil/playlist.m3u8,Korean international channel,tvlogos/Asia/arirang.png
#
# ========== INTERNATIONAL ==========
Euronews English,International,News,https://rakuten-euronews-2-gb.samsung.wurl.tv/manifest/playlist.m3u8,European news English,tvlogos/International/euronews.png
TRT World,International,News,https://tv-trtworld.medya.trt.com.tr/master.m3u8,Turkish international news,tvlogos/International/trt.png
"@
        
        $defaultContent | Out-File -FilePath $tvConfigPath -Encoding UTF8
        Write-NexusMLog "Default tvchannels.conf created"
    }
    
    # Create assets\tvplaylists folder if it doesn't exist
    if (-not (Test-Path $tvPlaylistsFolder)) {
        New-Item -ItemType Directory -Path $tvPlaylistsFolder -Force | Out-Null
        # Verbose logging disabled:
        # Write-Host "[i] Created assets\tvplaylists folder - drop .m3u files here to import channels" -ForegroundColor Cyan
    }
    
    # Read and parse the CSV file
    $tvChannels = @()
    
    try {
        $lines = Get-Content $tvConfigPath -Encoding UTF8
        
        foreach ($line in $lines) {
            # Skip comments and empty lines
            if ([string]::IsNullOrWhiteSpace($line) -or $line.TrimStart().StartsWith('#')) {
                continue
            }
            
            # Parse CSV line (Name,Country,Genre,URL,Description,Logo)
            $parts = $line.Split(',')
            
            if ($parts.Count -ge 5) {
                $channel = @{
                    Name        = $parts[0].Trim()
                    Country     = $parts[1].Trim()
                    Genre       = $parts[2].Trim()
                    URL         = $parts[3].Trim()
                    Description = $parts[4].Trim()
                    Logo        = if ($parts.Count -ge 6) { $parts[5].Trim() } else { "" }
                    Source      = "CSV"
                }
                $tvChannels += $channel
            }
        }
        
        Write-NexusMLog "Loaded $($tvChannels.Count) TV channels from tvchannels.conf"
    }
    catch {
        Write-NexusMLog "Error reading tvchannels.conf: $_" -Level "WARNING"
    }
    
    # Load M3U playlists from tvplaylists folder
    $m3uFiles = Get-ChildItem -Path $tvPlaylistsFolder -Filter "*.m3u*" -ErrorAction SilentlyContinue
    
    foreach ($m3uFile in $m3uFiles) {
        # Verbose logging disabled:
        # Write-Host "[i] Importing M3U playlist: $($m3uFile.Name)..." -ForegroundColor Cyan
        
        # Try to detect country from filename (e.g., "fr.m3u" -> France)
        $defaultCountry = "International"
        $fileBaseName = [System.IO.Path]::GetFileNameWithoutExtension($m3uFile.Name).ToLower()
        
        $filenameCountryMap = @{
            'fr' = 'France'
            'france' = 'France'
            'us' = 'USA'
            'usa' = 'USA'
            'uk' = 'UK'
            'gb' = 'UK'
            'de' = 'Germany'
            'germany' = 'Germany'
            'es' = 'Spain'
            'spain' = 'Spain'
            'it' = 'Italy'
            'italy' = 'Italy'
            'nl' = 'Netherlands'
            'be' = 'Belgium'
            'ch' = 'Switzerland'
            'ca' = 'Canada'
            'au' = 'Australia'
            'jp' = 'Japan'
            'cn' = 'China'
            'in' = 'India'
            'br' = 'Brazil'
            'mx' = 'Mexico'
            'ru' = 'Russia'
            'pl' = 'Poland'
            'tr' = 'Turkey'
        }
        
        foreach ($key in $filenameCountryMap.Keys) {
            if ($fileBaseName -like "*$key*" -or $fileBaseName -like "*_$key*" -or $fileBaseName -like "*-$key*") {
                $defaultCountry = $filenameCountryMap[$key]
                break
            }
        }
        
        $m3uChannels = Import-M3UPlaylist -Path $m3uFile.FullName -DefaultCountry $defaultCountry
        $tvChannels += $m3uChannels
    }
    
    # Remove duplicates based on URL
    $uniqueChannels = @()
    $seenUrls = @{}
    
    foreach ($channel in $tvChannels) {
        if (-not $seenUrls.ContainsKey($channel.URL)) {
            $seenUrls[$channel.URL] = $true
            $uniqueChannels += $channel
        }
    }
    
    if ($tvChannels.Count -ne $uniqueChannels.Count) {
        Write-NexusMLog "Removed $($tvChannels.Count - $uniqueChannels.Count) duplicate channels"
    }
    
    Write-NexusMLog "Total TV channels available: $($uniqueChannels.Count)"
    
    return $uniqueChannels
}

# Load TV channels
$Global:TVChannels = Get-TVChannelsFromConfig

# Build CONFIG based on whether config file was loaded
"[DEBUG] About to build CONFIG. LoadedConfig is null: $($null -eq $LoadedConfig)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append

if ($LoadedConfig) {
    "*** USING LOADED CONFIG FROM FILE ***" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    
    # Debug: Check what's in LoadedConfig before transferring
    "[DEBUG] LoadedConfig.ContainsKey('GhostscriptInstalled'): $($LoadedConfig.ContainsKey('GhostscriptInstalled'))" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    if ($LoadedConfig.ContainsKey('GhostscriptInstalled')) {
        "[DEBUG] LoadedConfig.GhostscriptInstalled value: $($LoadedConfig.GhostscriptInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
        "[DEBUG] LoadedConfig.GhostscriptInstalled type: $($LoadedConfig.GhostscriptInstalled.GetType().Name)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    }
    
    # Use loaded configuration from file
    # NOTE (v1.7): Media folder paths now come from admin.db network_shares table, not config file
    $CONFIG = @{
        # Media Folders - Placeholders only, actual paths loaded from database at scan time (v1.7)
        PicturesFolder = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        MoviesFolder   = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        MusicFolder    = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        PDFFolder      = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        
        # Server Settings (from config file)
        ServerPort     = $LoadedConfig.ServerPort
        ServerHost     = if ($LoadedConfig.ContainsKey('ServerHost')) { $LoadedConfig.ServerHost } else { "+" }
        
        # IP Whitelist (from config file)
        IPWhitelist    = $LoadedConfig.IPWhitelist
        
        # Security Settings (from config file)
        SecurityByPin  = if ($LoadedConfig.ContainsKey('SecurityByPin')) { $LoadedConfig.SecurityByPin } else { $true }
        
        # Metadata API Keys (from config file)
        TMDB_APIKey    = $LoadedConfig.TMDB_APIKey
        LastFM_APIKey  = $LoadedConfig.LastFM_APIKey
        
        # Media Quality Thresholds (from config file)
        LowQualityVideoThreshold = $LoadedConfig.LowQualityVideoThreshold
        LowQualityAudioThreshold = $LoadedConfig.LowQualityAudioThreshold
        
        # File Extensions (from config file)
        VideoExtensions = $LoadedConfig.VideoExtensions
        AudioExtensions = $LoadedConfig.AudioExtensions
        ImageExtensions = $LoadedConfig.ImageExtensions
        PDFExtensions   = $LoadedConfig.PDFExtensions
        
        # Manual installation flags (from config file)
        GhostscriptInstalled = if ($LoadedConfig.ContainsKey('GhostscriptInstalled')) { $LoadedConfig.GhostscriptInstalled } else { $false }
        FFmpegInstalled = if ($LoadedConfig.ContainsKey('FFmpegInstalled')) { $LoadedConfig.FFmpegInstalled } else { $false }
        
        # HTTP Logging settings (v7.6)
        HTTPLoggingLevel = if ($LoadedConfig.ContainsKey('HTTPLoggingLevel')) { $LoadedConfig.HTTPLoggingLevel } else { "Error" }
        LogsFolder = "$PSScriptRoot\logs"
        
        # PODE Performance Settings (v7.9)
        PODEThreads = if ($LoadedConfig.ContainsKey('PODEThreads')) { $LoadedConfig.PODEThreads } else { 8 }
        PODESessionTimeout = if ($LoadedConfig.ContainsKey('PODESessionTimeout')) { $LoadedConfig.PODESessionTimeout } else { 28800 }
        PODERequestTimeout = if ($LoadedConfig.ContainsKey('PODERequestTimeout')) { $LoadedConfig.PODERequestTimeout } else { 300 }
        
        # Media Scanner Parallel Processing Settings (v7.9)
        MusicScanFactor = if ($LoadedConfig.ContainsKey('MusicScanFactor')) { $LoadedConfig.MusicScanFactor } else { 50 }
        VideoScanFactor = if ($LoadedConfig.ContainsKey('VideoScanFactor')) { $LoadedConfig.VideoScanFactor } else { 10 }
        PDFScanFactor = if ($LoadedConfig.ContainsKey('PDFScanFactor')) { $LoadedConfig.PDFScanFactor } else { 10 }
        AlbumArtFactor = if ($LoadedConfig.ContainsKey('AlbumArtFactor')) { $LoadedConfig.AlbumArtFactor } else { 10 }
        
        # Music Videos Feature (v7.10, updated v1.7)
        MusicVideosEnabled = if ($LoadedConfig.ContainsKey('MusicVideos')) { $LoadedConfig.MusicVideos } else { $false }
        MusicVideosFolder = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path (v1.7)
        MusicVideosDB = "$PSScriptRoot\data\musicvideos.db"
        
        # Menu Visibility Settings (v7.19)
        RadioEnabled = if ($LoadedConfig.ContainsKey('Radio')) { $LoadedConfig.Radio } else { $true }
        InternetTVEnabled = if ($LoadedConfig.ContainsKey('InternetTV')) { $LoadedConfig.InternetTV } else { $true }
        PicturesEnabled = if ($LoadedConfig.ContainsKey('Pictures')) { $LoadedConfig.Pictures } else { $true }
        EbooksEnabled = if ($LoadedConfig.ContainsKey('Ebooks')) { $LoadedConfig.Ebooks } else { $true }
        
        # HLS Cache Settings (v3.6 - Plex-style persistent cache)
        HLSCacheEnabled = if ($LoadedConfig.ContainsKey('HLSCacheEnabled')) { $LoadedConfig.HLSCacheEnabled -eq "True" } else { $true }
        HLSCacheMaxSizeGB = if ($LoadedConfig.ContainsKey('HLSCacheMaxSizeGB')) { [int]$LoadedConfig.HLSCacheMaxSizeGB } else { 100 }
        HLSCacheRetentionDays = if ($LoadedConfig.ContainsKey('HLSCacheRetentionDays')) { [int]$LoadedConfig.HLSCacheRetentionDays } else { 90 }
        
        # Database Files (always relative to script directory)
        MoviesDB       = "$PSScriptRoot\data\movies.db"
        MusicDB        = "$PSScriptRoot\data\music.db"
        PicturesDB     = "$PSScriptRoot\data\pictures.db"
        PDFDB          = "$PSScriptRoot\data\ebooks.db"
        SharesDB       = "$PSScriptRoot\data\shares.db"
        
        # User Management Databases
        UsersDB        = "$PSScriptRoot\users\users.db"
        UsersDBPath    = "$PSScriptRoot\users"
        AvatarFolder   = "$PSScriptRoot\assets\avatars"
        
        # Poster Cache (always relative to script directory)
        PosterCacheFolder = "$PSScriptRoot\assets\posters"
        AlbumArtCacheFolder = "$PSScriptRoot\assets\albumart"
        PDFPreviewCacheFolder = "$PSScriptRoot\assets\ebookcovers"
        EPUBCoverCacheFolder = "$PSScriptRoot\assets\ebookcovers"
        EbookCoverCacheFolder = "$PSScriptRoot\assets\ebookcovers"
        RadioLogoCacheFolder = "$PSScriptRoot\assets\radiologos"
        MusicVideoThumbsFolder = "$PSScriptRoot\assets\mvthumbs"
        PictureThumbsFolder = "$PSScriptRoot\assets\thumbs"
        
        # Tools Folder (always relative to script directory)
        ToolsFolder = "$PSScriptRoot\tools"
        
        # Internet Radio Stations (hardcoded - not in config file)
        RadioStations = $RadioStationsArray
        
        # Internet TV Channels (loaded from tvchannels.conf CSV file)
        TVChannels = $Global:TVChannels
        TVLogoCacheFolder = "$PSScriptRoot\assets\tvlogos"
        
        # Script Root (for PODE routes that need access)
        ScriptRoot = $PSScriptRoot
    }
    
    Write-NexusMLog "Configuration loaded from NexusM.conf"
    
    "[✓] CONFIG object created from loaded config" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    "[DEBUG] CONFIG.GhostscriptInstalled = $($CONFIG.GhostscriptInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    "[DEBUG] CONFIG.GhostscriptInstalled type = $($CONFIG.GhostscriptInstalled.GetType().Name)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    "[DEBUG] CONFIG.FFmpegInstalled = $($CONFIG.FFmpegInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    "[DEBUG] CONFIG has GhostscriptInstalled key: $($CONFIG.ContainsKey('GhostscriptInstalled'))" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    
    # Apply transcoding settings from config file (v4.9, updated v7.04)
    if ($LoadedConfig.ContainsKey('PreferredEncoder')) {
        $Global:TranscodingConfig.PreferredEncoder = $LoadedConfig.PreferredEncoder
        Write-NexusMLog "PreferredEncoder from config: $($LoadedConfig.PreferredEncoder)"
    }
    
    # v7.04: Removed safety override - let auto-detection and config work properly
    # Hardware encoding is now properly tested before use
    
    if ($LoadedConfig.ContainsKey('VideoPreset')) {
        $Global:TranscodingConfig.VideoPreset = $LoadedConfig.VideoPreset
    }
    if ($LoadedConfig.ContainsKey('VideoCRF')) {
        $Global:TranscodingConfig.VideoCRF = $LoadedConfig.VideoCRF
    }
    if ($LoadedConfig.ContainsKey('VideoMaxrate')) {
        $Global:TranscodingConfig.VideoMaxrate = $LoadedConfig.VideoMaxrate
    }
    if ($LoadedConfig.ContainsKey('AudioBitrate')) {
        $Global:TranscodingConfig.AudioBitrate = $LoadedConfig.AudioBitrate
    }
    if ($LoadedConfig.ContainsKey('MaxConcurrentTranscodes')) {
        $Global:TranscodingConfig.MaxConcurrentTranscodes = $LoadedConfig.MaxConcurrentTranscodes
    }
    if ($LoadedConfig.ContainsKey('FFmpegCPULimit')) {
        $Global:TranscodingConfig.FFmpegCPULimit = $LoadedConfig.FFmpegCPULimit
        if ($LoadedConfig.FFmpegCPULimit -gt 0) {
            Write-NexusMLog "FFmpeg CPU limit set to $($LoadedConfig.FFmpegCPULimit)%"
        }
    }
    # v7.50: Load LookaheadThreads setting for x264 encoder parallelism
    if ($LoadedConfig.ContainsKey('LookaheadThreads')) {
        $Global:TranscodingConfig.LookaheadThreads = [int]$LoadedConfig.LookaheadThreads
        if ($LoadedConfig.LookaheadThreads -gt 0) {
            Write-NexusMLog "x264 lookahead threads: $($LoadedConfig.LookaheadThreads)"
        } else {
            Write-NexusMLog "x264 lookahead threads: auto (half of encoding threads)"
        }
    }
    # v7.40: Load TranscodeMaxHeight setting for resolution limiting
    if ($LoadedConfig.ContainsKey('TranscodeMaxHeight')) {
        $Global:TranscodingConfig.TranscodeMaxHeight = $LoadedConfig.TranscodeMaxHeight
        if ($LoadedConfig.TranscodeMaxHeight -gt 0) {
            Write-NexusMLog "Transcode resolution limit: max $($LoadedConfig.TranscodeMaxHeight)p"
        }
    }
    # v7.58: Load VerboseTranscodeLog setting for detailed FFmpeg output
    if ($LoadedConfig.ContainsKey('VerboseTranscodeLog')) {
        $verboseValue = $LoadedConfig.VerboseTranscodeLog
        # Handle string "True"/"False" or actual boolean
        if ($verboseValue -is [string]) {
            $Global:TranscodingConfig.VerboseTranscodeLog = ($verboseValue -eq "True" -or $verboseValue -eq "1")
        } else {
            $Global:TranscodingConfig.VerboseTranscodeLog = [bool]$verboseValue
        }
        Write-NexusMLog "Verbose transcode logging: $($Global:TranscodingConfig.VerboseTranscodeLog)"
    }
    if ($LoadedConfig.ContainsKey('TranscodingEnabled') -and -not $LoadedConfig.TranscodingEnabled) {
        Write-NexusMLog "Transcoding disabled in NexusM.conf" -Level "WARNING"
    }
    
}
else {
    
    # Use hardcoded defaults (first run or error loading config)
    # NOTE (v1.7): Media folder paths now come from admin.db network_shares table
    $CONFIG = @{
        # Media Folders - Placeholders only, actual paths loaded from database at scan time (v1.7)
        PicturesFolder = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        MoviesFolder   = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        MusicFolder    = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        PDFFolder      = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path
        
        # Server Settings
        ServerPort     = 8182
        ServerHost     = "+"
        
        # IP Whitelist - Only these IPs can access the server
        # Use @() for empty array to allow all IPs
        IPWhitelist    = @(
            "",       # Trusted device IP 1
            "",       # Trusted device IP 2
            ""        # Trusted device IP 3
        )
        
        # Security Settings
        SecurityByPin  = $true  # Require PIN authentication (set to $false to auto-login as admin)
        
        # Database Files (relative to script directory)
        MoviesDB       = "$PSScriptRoot\data\movies.db"
        MusicDB        = "$PSScriptRoot\data\music.db"
        PicturesDB     = "$PSScriptRoot\data\pictures.db"
        PDFDB          = "$PSScriptRoot\data\ebooks.db"
        SharesDB       = "$PSScriptRoot\data\shares.db"
        
        # User Management Databases
        UsersDB        = "$PSScriptRoot\users\users.db"
        UsersDBPath    = "$PSScriptRoot\users"
        
        # Poster Cache (relative to script directory)
        PosterCacheFolder = "$PSScriptRoot\assets\posters"
        AlbumArtCacheFolder = "$PSScriptRoot\assets\albumart"
        PDFPreviewCacheFolder = "$PSScriptRoot\assets\ebookcovers"
        EPUBCoverCacheFolder = "$PSScriptRoot\assets\ebookcovers"
        EbookCoverCacheFolder = "$PSScriptRoot\assets\ebookcovers"
        RadioLogoCacheFolder = "$PSScriptRoot\assets\radiologos"
        MusicVideoThumbsFolder = "$PSScriptRoot\assets\mvthumbs"
        PictureThumbsFolder = "$PSScriptRoot\assets\thumbs"
        
        # Tools Folder (for downloaded utilities like ffmpeg)
        ToolsFolder = "$PSScriptRoot\tools"
        
        # Metadata API Keys (Optional - add your own API keys)
        TMDB_APIKey = ""  # For movie posters
        LastFM_APIKey  = ""  # For music album art
        
        # Media Quality Thresholds
        LowQualityVideoThreshold = 720  # Resolution height (720p)
        LowQualityAudioThreshold = 128  # Bitrate in kbps
        
        # File Extensions
        VideoExtensions = @('.mp4', '.mkv', '.avi', '.mov', '.wmv', '.flv', '.webm', '.m4v')
        AudioExtensions = @('.mp3', '.flac', '.wav', '.m4a', '.aac', '.ogg', '.wma', '.opus')
        ImageExtensions = @('.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.tiff')
        PDFExtensions = @('.pdf')
        
        # Manual installation flags (not installed by default)
        GhostscriptInstalled = $false
        FFmpegInstalled = $false
        
        # HTTP Logging settings (v7.6)
        HTTPLoggingLevel = "Error"
        LogsFolder = "$PSScriptRoot\logs"
        
        # PODE Performance Settings (v7.9)
        PODEThreads = 8
        PODESessionTimeout = 28800  # 8 hours in seconds
        PODERequestTimeout = 300    # 5 minutes for large file operations
        
        # Media Scanner Parallel Processing Settings (v7.9)
        MusicScanFactor = 50
        VideoScanFactor = 10
        PDFScanFactor = 10
        AlbumArtFactor = 10
        
        # Music Videos Feature (v7.10, updated v1.7)
        MusicVideosEnabled = $false
        MusicVideosFolder = "D:\Share"  # Placeholder - use Get-AllMediaPaths for actual path (v1.7)
        MusicVideosDB = "$PSScriptRoot\data\musicvideos.db"
        
        # Menu Visibility Settings (v7.19) - default all enabled
        RadioEnabled = $true
        InternetTVEnabled = $true
        PicturesEnabled = $true
        EbooksEnabled = $true
        
        # Internet Radio Stations
        RadioStations = $RadioStationsArray
        
        # Internet TV Channels (loaded from tvchannels.conf CSV file)
        TVChannels = $Global:TVChannels
        TVLogoCacheFolder = "$PSScriptRoot\assets\tvlogos"
        
        # Script Root (for PODE routes that need access)
        ScriptRoot = $PSScriptRoot
    }
    
    Write-NexusMLog "Using default configuration"
}

# ============================================================================
# GLOBAL VARIABLES
# ============================================================================

$Global:ServerRunning = $false
$Global:FFmpegPath = $null  # NEW: Path to ffmpeg executable
$Global:MediaStats = @{
    TotalVideos = 0
    TotalMusic = 0
    TotalPictures = 0
    TotalPDFs = 0
    TotalMusicVideos = 0
    TotalSizeGB = 0
    VideoSizeGB = 0
    MusicSizeGB = 0
    PicturesSizeGB = 0
    PDFSizeGB = 0
    MusicVideosSizeGB = 0
    LastScanDate = $null
}

# ============================================================================
# MODULE DEPENDENCY CHECK
# ============================================================================

function Test-PSSQLiteModule {
    Write-Host "`n=== Checking Dependencies ===" -ForegroundColor Cyan
    
    if (-not (Get-Module -ListAvailable -Name PSSQLite)) {
        Write-Host "`n[!] PSSQLite module is not installed." -ForegroundColor Yellow
        Write-Host "    This module is required for database operations." -ForegroundColor Gray
        
        $install = Read-Host "`nWould you like to install it now? (Y/N)"
        
        if ($install -eq 'Y' -or $install -eq 'y') {
            try {
                Write-Host "`nInstalling PSSQLite module..." -ForegroundColor Cyan
                Install-Module -Name PSSQLite -Scope CurrentUser -Force -AllowClobber
                Write-Host "[✓] PSSQLite installed successfully!" -ForegroundColor Green
                Import-Module PSSQLite
                return $true
            }
            catch {
                Write-Host "[✗] Failed to install PSSQLite: $_" -ForegroundColor Red
                return $false
            }
        }
        else {
            Write-Host "`n[✗] Cannot continue without PSSQLite module." -ForegroundColor Red
            Write-Host "    Install manually with: Install-Module PSSQLite -Scope CurrentUser" -ForegroundColor Gray
            return $false
        }
    }
    else {
        Import-Module PSSQLite -ErrorAction SilentlyContinue
        Write-Host "[✓] PSSQLite module is available" -ForegroundColor Green
        return $true
    }
}

function Test-PodeModule {
    Write-Host "`n=== Checking Pode Module ===" -ForegroundColor Cyan
    
    if (-not (Get-Module -ListAvailable -Name Pode)) {
        Write-Host "`n[!] Pode module is not installed." -ForegroundColor Yellow
        Write-Host "    Pode is required for the web server with HTTPS support." -ForegroundColor Gray
        Write-Host "    More info: https://badgerati.github.io/Pode/" -ForegroundColor Gray
        
        $install = Read-Host "`nWould you like to install it now? (Y/N)"
        
        if ($install -eq 'Y' -or $install -eq 'y') {
            try {
                Write-Host "`nInstalling Pode module..." -ForegroundColor Cyan
                Install-Module -Name Pode -Scope CurrentUser -Force -AllowClobber
                Write-Host "[✓] Pode installed successfully!" -ForegroundColor Green
                Import-Module Pode
                return $true
            }
            catch {
                Write-Host "[✗] Failed to install Pode: $_" -ForegroundColor Red
                return $false
            }
        }
        else {
            Write-Host "`n[✗] Cannot continue without Pode module." -ForegroundColor Red
            Write-Host "    Install manually with: Install-Module Pode -Scope CurrentUser" -ForegroundColor Gray
            return $false
        }
    }
    else {
        $podeVersion = (Get-Module -ListAvailable -Name Pode | Select-Object -First 1).Version
        Import-Module Pode -ErrorAction SilentlyContinue
        Write-Host "[✓] Pode module is available (v$podeVersion)" -ForegroundColor Green
        return $true
    }
}

function Get-MediaConfig {
    return $CONFIG
}


function Get-MediaDB {
    param(
        [Parameter(Mandatory=$true)]
        [ValidateSet('movies', 'music', 'pictures', 'pdfs', 'users')]
        [string]$Type
    )
    
    switch ($Type) {
        'movies'   { return $CONFIG.MoviesDB }
        'music'    { return $CONFIG.MusicDB }
        'pictures' { return $CONFIG.PicturesDB }
        'pdfs'     { return $CONFIG.PDFDB }
        'users'    { return $CONFIG.UsersDB }
    }
}


function Test-FFmpegAvailability {
    
    # First check if user has marked it as installed in config file
    if ($CONFIG.ContainsKey('FFmpegInstalled') -and $CONFIG.FFmpegInstalled -eq $true) {
        
        # Try to find it anyway for the global path
        $ffmpegInPath = Get-Command ffmpeg -ErrorAction SilentlyContinue
        if ($ffmpegInPath) {
            $Global:FFmpegPath = $ffmpegInPath.Source
        } else {
            $localFFmpegExe = Join-Path $CONFIG.ToolsFolder "ffmpeg\bin\ffmpeg.exe"
            if (Test-Path $localFFmpegExe) {
                $Global:FFmpegPath = $localFFmpegExe
            } else {
                # Assume it's installed but we can't find it - user will need to add to PATH
                $Global:FFmpegPath = "ffmpeg"  # Will use system PATH
            }
        }
        return $true
    }
    
    # Check if ffmpeg is in PATH
    $ffmpegInPath = Get-Command ffmpeg -ErrorAction SilentlyContinue
    if ($ffmpegInPath) {
        $Global:FFmpegPath = $ffmpegInPath.Source
        
        # Check if it has AMF support (FULL build)
        try {
            $encoders = & $Global:FFmpegPath -encoders 2>&1 | Out-String
            if ($encoders -notmatch "h264_amf") {
                Write-Host ""
                Write-Host "[!] WARNING: Current FFmpeg doesn't have AMF hardware encoding support!" -ForegroundColor Yellow
                Write-Host "    Your FFmpeg appears to be the essentials build." -ForegroundColor Gray
                Write-Host "    For AMD GPU hardware encoding, you need the FULL build." -ForegroundColor Gray
                Write-Host ""
                $upgradeChoice = Read-Host "Would you like to replace it with the FULL build (with AMF)? (Y/N)"
                
                if ($upgradeChoice -eq 'Y' -or $upgradeChoice -eq 'y') {
                    # Remove old ffmpeg if it's in our tools folder
                    $localFFmpegFolder = Join-Path $CONFIG.ToolsFolder "ffmpeg"
                    if (Test-Path $localFFmpegFolder) {
                        Write-Host "Removing old FFmpeg from tools folder..." -ForegroundColor Yellow
                        Remove-Item $localFFmpegFolder -Recurse -Force
                    }
                    return Install-FFmpeg
                }
            }
        }
        catch {
            # If we can't check, just continue
        }
        
        return $true
    }
    
    # Check if we have it in local tools folder
    $localFFmpegExe = Join-Path $CONFIG.ToolsFolder "ffmpeg\bin\ffmpeg.exe"
    if (Test-Path $localFFmpegExe) {

        $Global:FFmpegPath = $localFFmpegExe
        
        # Check if it has AMF support (FULL build)
        try {
            $encoders = & $Global:FFmpegPath -encoders 2>&1 | Out-String
            if ($encoders -notmatch "h264_amf") {
                Write-Host ""
                Write-Host "[!] WARNING: Current FFmpeg doesn't have AMF hardware encoding support!" -ForegroundColor Yellow
                Write-Host "    Your FFmpeg appears to be the essentials build." -ForegroundColor Gray
                Write-Host "    For AMD GPU hardware encoding, you need the FULL build." -ForegroundColor Gray
                Write-Host ""
                $upgradeChoice = Read-Host "Would you like to replace it with the FULL build (with AMF)? (Y/N)"
                
                if ($upgradeChoice -eq 'Y' -or $upgradeChoice -eq 'y') {
                    Write-Host "Removing old FFmpeg..." -ForegroundColor Yellow
                    $localFFmpegFolder = Join-Path $CONFIG.ToolsFolder "ffmpeg"
                    Remove-Item $localFFmpegFolder -Recurse -Force
                    return Install-FFmpeg
                }
            }
        }
        catch {
            # If we can't check, just continue
        }
        
        return $true
    }
    
    # ffmpeg not found - keep essential warning
    Write-Host "[!] ffmpeg not installed - album artwork extraction disabled" -ForegroundColor Yellow
    
    $install = Read-Host "`nWould you like to download ffmpeg now? (Y/N)"
    
    if ($install -eq 'Y' -or $install -eq 'y') {
        return Install-FFmpeg
    }
    else {
        Write-Host "`n[i] Continuing without ffmpeg. Album artwork will be disabled." -ForegroundColor Gray
        Write-Host "    You can download it later from: https://ffmpeg.org/download.html" -ForegroundColor Gray
        return $false
    }
}

function Install-FFmpeg {
    Write-Host "`n=== Downloading FFmpeg ===" -ForegroundColor Cyan
    
    try {
        # Create tools folder
        $ffmpegFolder = Join-Path $CONFIG.ToolsFolder "ffmpeg"
        if (-not (Test-Path $ffmpegFolder)) {
            New-Item -ItemType Directory -Path $ffmpegFolder -Force | Out-Null
        }
        
        # Detect OS - Use runtime check instead of assignment
        $onWindows = ($PSVersionTable.PSVersion.Major -ge 6 -and $IsWindows) -or ($PSVersionTable.PSVersion.Major -lt 6)
        $onLinux = $PSVersionTable.PSVersion.Major -ge 6 -and $IsLinux
        $onMacOS = $PSVersionTable.PSVersion.Major -ge 6 -and $IsMacOS
        
        if ($onWindows) {
            Write-Host "Detected Windows OS" -ForegroundColor Cyan
            
            # Download ffmpeg FULL build for Windows (includes AMF hardware encoding support)
            $downloadUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full.7z"
            $archivePath = Join-Path $env:TEMP "ffmpeg.7z"
            
            Write-Host "Downloading from: $downloadUrl" -ForegroundColor Gray
            Write-Host "This may take a few minutes (~180 MB for FULL build with AMF support)..." -ForegroundColor Gray
            Write-Host "Note: FULL build includes AMD AMF, NVIDIA NVENC, and Intel QSV hardware encoding" -ForegroundColor Cyan
            
            # Try wget first, fallback to Invoke-WebRequest
            try {
                if (Get-Command wget -ErrorAction SilentlyContinue) {
                    Write-Host "Using wget for download..." -ForegroundColor Gray
                    wget $downloadUrl -O $archivePath
                } else {
                    throw "wget not available"
                }
            }
            catch {
                Write-Host "wget not found - using Invoke-WebRequest..." -ForegroundColor Gray
                $ProgressPreference = 'SilentlyContinue'  # Faster download
                Invoke-WebRequest -Uri $downloadUrl -OutFile $archivePath -UseBasicParsing
                $ProgressPreference = 'Continue'
            }
            
            if (-not (Test-Path $archivePath)) {
                Write-Host "[✗] Download failed" -ForegroundColor Red
                return $false
            }
            
            Write-Host "[✓] Download complete!" -ForegroundColor Green
            
            # Extract 7z archive
            Write-Host "Extracting ffmpeg..." -ForegroundColor Cyan
            
            # Check if 7-Zip is available
            $7zPaths = @(
                "$env:ProgramFiles\7-Zip\7z.exe",
                "${env:ProgramFiles(x86)}\7-Zip\7z.exe",
                "$env:ProgramW6432\7-Zip\7z.exe"
            )
            
            $7zExe = $null
            foreach ($path in $7zPaths) {
                if (Test-Path $path) {
                    $7zExe = $path
                    break
                }
            }
            
            if ($7zExe) {
                Write-Host "Using 7-Zip to extract..." -ForegroundColor Gray
                & $7zExe x "$archivePath" "-o$env:TEMP" -y | Out-Null
            }
            else {
                Write-Host "7-Zip not found. Attempting PowerShell extraction..." -ForegroundColor Yellow
                try {
                    # Try to use Expand-Archive (may not work with 7z files)
                    Expand-Archive -Path $archivePath -DestinationPath $env:TEMP -Force -ErrorAction Stop
                }
                catch {
                    Write-Host ""
                    Write-Host "[✗] ERROR: Cannot extract .7z file without 7-Zip" -ForegroundColor Red
                    Write-Host "    Please install 7-Zip from: https://www.7-zip.org/" -ForegroundColor Yellow
                    Write-Host "    Or download FFmpeg manually from: https://www.gyan.dev/ffmpeg/builds/" -ForegroundColor Gray
                    Remove-Item $archivePath -ErrorAction SilentlyContinue
                    return $false
                }
            }
            
            # Find the extracted folder (it has a version number in the name)
            $extractedFolder = Get-ChildItem -Path $env:TEMP -Directory | 
                Where-Object { $_.Name -like "ffmpeg-*-full_build" } | 
                Select-Object -First 1
            
            if ($extractedFolder) {
                # Copy to our tools folder
                Copy-Item -Path "$($extractedFolder.FullName)\*" -Destination $ffmpegFolder -Recurse -Force
                
                # Clean up
                Remove-Item $archivePath -Force -ErrorAction SilentlyContinue
                Remove-Item $extractedFolder.FullName -Recurse -Force -ErrorAction SilentlyContinue
                
                # Verify installation
                $ffmpegExe = Join-Path $ffmpegFolder "bin\ffmpeg.exe"
                if (Test-Path $ffmpegExe) {
                    $Global:FFmpegPath = $ffmpegExe
                    Write-Host "[✓] ffmpeg FULL build installed successfully!" -ForegroundColor Green
                    Write-Host "    Location: $ffmpegExe" -ForegroundColor Gray
                    
                    # Verify AMF support
                    Write-Host "    Verifying hardware encoding support..." -ForegroundColor Cyan
                    try {
                        $encoders = & $ffmpegExe -encoders 2>&1 | Out-String
                        $hasAMF = $encoders -match "h264_amf"
                        $hasNVENC = $encoders -match "h264_nvenc"
                        $hasQSV = $encoders -match "h264_qsv"
                        
                        if ($hasAMF) { Write-Host "      ✓ AMD AMF support detected" -ForegroundColor Green }
                        if ($hasNVENC) { Write-Host "      ✓ NVIDIA NVENC support detected" -ForegroundColor Green }
                        if ($hasQSV) { Write-Host "      ✓ Intel QSV support detected" -ForegroundColor Green }
                        
                        if (-not ($hasAMF -or $hasNVENC -or $hasQSV)) {
                            Write-Host "      [!] Warning: No hardware encoders detected in build" -ForegroundColor Yellow
                        }
                    }
                    catch {
                        Write-Host "      [!] Could not verify encoders" -ForegroundColor Yellow
                    }
                    
                    return $true
                }
            }
            
            Write-Host "[✗] Failed to extract ffmpeg" -ForegroundColor Red
            return $false
        }
        elseif ($onLinux) {
            Write-Host "Detected Linux OS" -ForegroundColor Cyan
            Write-Host "[!] Please install ffmpeg using your package manager:" -ForegroundColor Yellow
            Write-Host "    Ubuntu/Debian: sudo apt-get install ffmpeg" -ForegroundColor Gray
            Write-Host "    Fedora: sudo dnf install ffmpeg" -ForegroundColor Gray
            Write-Host "    Arch: sudo pacman -S ffmpeg" -ForegroundColor Gray
            return $false
        }
        elseif ($onMacOS) {
            Write-Host "Detected macOS" -ForegroundColor Cyan
            Write-Host "[!] Please install ffmpeg using Homebrew:" -ForegroundColor Yellow
            Write-Host "    brew install ffmpeg" -ForegroundColor Gray
            return $false
        }
        else {
            Write-Host "[!] Could not detect OS. Please install ffmpeg manually." -ForegroundColor Yellow
            Write-Host "    Download from: https://ffmpeg.org/download.html" -ForegroundColor Gray
            return $false
        }
    }
    catch {
        Write-Host "[✗] Failed to download/install ffmpeg: $_" -ForegroundColor Red
        Write-Host "    You can download it manually from: https://ffmpeg.org/download.html" -ForegroundColor Gray
        return $false
    }
}

# ============================================================================
# GHOSTSCRIPT DEPENDENCY CHECK (FOR PDF PREVIEW GENERATION)
# ============================================================================

function Test-GhostscriptAvailability {
    Write-Host "`n=== Checking Ghostscript (for eBook Preview Generation) ===" -ForegroundColor Cyan
    
    "[Test-GhostscriptAvailability] Function called" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    
    # Debug: Show what we have in CONFIG
    if ($CONFIG.PSObject.Properties.Name -contains 'GhostscriptInstalled') {
        "[DEBUG] CONFIG has GhostscriptInstalled via PSObject: $($CONFIG.GhostscriptInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    } else {
        "[DEBUG] CONFIG does NOT have GhostscriptInstalled via PSObject" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    }
    
    # Also check with ContainsKey (for hashtables)
    if ($CONFIG.ContainsKey('GhostscriptInstalled')) {
        "[DEBUG] CONFIG.ContainsKey('GhostscriptInstalled') = True" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
        "[DEBUG] CONFIG.GhostscriptInstalled = $($CONFIG.GhostscriptInstalled)" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    } else {
        "[DEBUG] CONFIG.ContainsKey('GhostscriptInstalled') = False" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
    }
    
    # First check if user has marked it as installed in config file
    if ($CONFIG.ContainsKey('GhostscriptInstalled') -and $CONFIG.GhostscriptInstalled -eq $true) {
        Write-Host "[✓] Ghostscript marked as installed in NexusM.conf" -ForegroundColor Green
        Write-Host "    Skipping automatic detection as per configuration file" -ForegroundColor Gray
        "[✓] Ghostscript marked as installed - skipping detection" | Out-File -FilePath "$PSScriptRoot\debug.log" -Append
        return $true
    }
    
    # Check if Ghostscript is in PATH
    $gsCmd = Get-Command gs -ErrorAction SilentlyContinue
    if (-not $gsCmd) {
        $gsCmd = Get-Command gswin64c -ErrorAction SilentlyContinue
    }
    if (-not $gsCmd) {
        $gsCmd = Get-Command gswin32c -ErrorAction SilentlyContinue
    }
    
    if ($gsCmd) {
        Write-Host "[✓] Ghostscript found in system PATH" -ForegroundColor Green
        try {
            $version = & $gsCmd.Source --version 2>&1
            Write-Host "    Version: Ghostscript $version" -ForegroundColor Gray
        } catch {
            Write-Host "    Version: Ghostscript (installed)" -ForegroundColor Gray
        }
        return $true
    }
    
    # Ghostscript not found
    Write-Host "`n[!] Ghostscript is not installed (or not in PATH)." -ForegroundColor Yellow
    Write-Host "    Ghostscript is OPTIONAL but required for eBook preview thumbnails." -ForegroundColor Gray
    Write-Host "    Without it, eBooks will display with placeholder icons." -ForegroundColor Gray
    Write-Host "    An interpreter for the PostScript language and for PDF." -ForegroundColor Gray
    Write-Host "`n    If you have installed Ghostscript manually:" -ForegroundColor Cyan
    Write-Host "    Edit NexusM.conf and set: GhostscriptInstalled,Yes" -ForegroundColor Cyan
    
    $install = Read-Host "`nWould you like to install Ghostscript now? (Y/N)"
    
    if ($install -eq 'Y' -or $install -eq 'y') {
        return Install-Ghostscript
    }
    else {
        Write-Host "`n[i] Continuing without Ghostscript. eBook thumbnails will be disabled." -ForegroundColor Gray
        Write-Host "    You can install it later with: winget install Ghostscript.Ghostscript" -ForegroundColor Gray
        return $false
    }
}

function Install-Ghostscript {
    Write-Host "`n=== Installing Ghostscript ===" -ForegroundColor Cyan
    
    try {
        # Detect OS
        $onWindows = ($PSVersionTable.PSVersion.Major -ge 6 -and $IsWindows) -or ($PSVersionTable.PSVersion.Major -lt 6)
        $onLinux = $PSVersionTable.PSVersion.Major -ge 6 -and $IsLinux
        $onMacOS = $PSVersionTable.PSVersion.Major -ge 6 -and $IsMacOS
        
        if ($onWindows) {
            Write-Host "Detected Windows OS" -ForegroundColor Cyan
            
            # Try winget first (recommended)
            $wingetAvailable = Get-Command winget -ErrorAction SilentlyContinue
            
            if ($wingetAvailable) {
                Write-Host "`nUsing Windows Package Manager (winget)..." -ForegroundColor Cyan
                Write-Host "Running: winget install Ghostscript.Ghostscript" -ForegroundColor Gray
                Write-Host ""
                
                try {
                    $wingetResult = winget install Ghostscript.Ghostscript --accept-package-agreements --accept-source-agreements 2>&1
                    
                    if ($LASTEXITCODE -eq 0 -or $wingetResult -match "Successfully installed") {
                        Write-Host "`n[✓] Ghostscript installed successfully via winget!" -ForegroundColor Green
                        Write-Host "    You may need to restart PowerShell for PATH changes to take effect." -ForegroundColor Yellow
                        Write-Host "    eBook previews will work after restart." -ForegroundColor Green
                        
                        # Try to refresh PATH in current session
                        $env:PATH = [System.Environment]::GetEnvironmentVariable("Path", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path", "User")
                        
                        # Check if gs command is now available
                        $gsTest = Get-Command gs -ErrorAction SilentlyContinue
                        if (-not $gsTest) { $gsTest = Get-Command gswin64c -ErrorAction SilentlyContinue }
                        if (-not $gsTest) { $gsTest = Get-Command gswin32c -ErrorAction SilentlyContinue }
                        
                        if ($gsTest) {
                            Write-Host "    ✓ Ghostscript command is now available!" -ForegroundColor Green
                        }
                        else {
                            Write-Host "    Note: Please restart PowerShell to use Ghostscript" -ForegroundColor Yellow
                        }
                        
                        return $true
                    }
                    else {
                        Write-Host "[!] winget installation may have failed" -ForegroundColor Yellow
                        Write-Host "    Please install manually from: https://www.ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
                        return $false
                    }
                }
                catch {
                    Write-Host "[!] winget installation failed: $_" -ForegroundColor Yellow
                    Write-Host "    Please install manually from: https://www.ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
                    return $false
                }
            }
            else {
                Write-Host "[i] winget not available" -ForegroundColor Gray
                Write-Host "    Please install Ghostscript manually:" -ForegroundColor Yellow
                Write-Host "    1. Go to: https://www.ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
                Write-Host "    2. Download 'Ghostscript GPL Release' for Windows (64-bit)" -ForegroundColor Gray
                Write-Host "    3. Run the installer" -ForegroundColor Gray
                Write-Host "    4. Restart PowerShell" -ForegroundColor Gray
                return $false
            }
        }
        elseif ($onLinux) {
            Write-Host "Detected Linux OS" -ForegroundColor Cyan
            Write-Host "[!] Please install Ghostscript using your package manager:" -ForegroundColor Yellow
            Write-Host "    Ubuntu/Debian: sudo apt-get install ghostscript" -ForegroundColor Gray
            Write-Host "    Fedora: sudo dnf install ghostscript" -ForegroundColor Gray
            Write-Host "    Arch: sudo pacman -S ghostscript" -ForegroundColor Gray
            return $false
        }
        elseif ($onMacOS) {
            Write-Host "Detected macOS" -ForegroundColor Cyan
            Write-Host "[!] Please install Ghostscript using Homebrew:" -ForegroundColor Yellow
            Write-Host "    brew install ghostscript" -ForegroundColor Gray
            return $false
        }
        else {
            Write-Host "[!] Could not detect OS. Please install Ghostscript manually." -ForegroundColor Yellow
            Write-Host "    Windows: winget install Ghostscript.Ghostscript" -ForegroundColor Gray
            Write-Host "    Or download from: https://www.ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
            return $false
        }
    }
    catch {
        Write-Host "[✗] Failed to install Ghostscript: $_" -ForegroundColor Red
        Write-Host "    Please install manually: winget install Ghostscript.Ghostscript" -ForegroundColor Gray
        Write-Host "    Or download from: https://www.ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
        return $false
    }
}

# ============================================================================
# VIDEO.JS DEPENDENCY CHECK (FOR OFFLINE VIDEO PLAYER)
# ============================================================================

function Test-VideoJSAvailability {
    Write-Host "`n=== Checking Video.js (for Enhanced Video Player) ===" -ForegroundColor Cyan
    
    # Check if Video.js files exist in local folder
    $videojsFolder = Join-Path $CONFIG.ToolsFolder "videojs"
    $videojsCss = Join-Path $videojsFolder "video-js.min.css"
    $videojsJs = Join-Path $videojsFolder "video.min.js"
    
    if ((Test-Path $videojsCss) -and (Test-Path $videojsJs)) {
        Write-Host "[✓] Video.js found in local tools folder" -ForegroundColor Green
        return $true
    }
    
    # Video.js not found
    Write-Host "`n[!] Video.js is not installed locally." -ForegroundColor Yellow
    Write-Host "    Video.js provides enhanced video playback features." -ForegroundColor Gray
    Write-Host "    Without it, basic HTML5 player will be used (limited features)." -ForegroundColor Gray
    Write-Host "    Size: ~1 MB download" -ForegroundColor Gray
    
    $install = Read-Host "`nWould you like to download Video.js now for offline use? (Y/N)"
    
    if ($install -eq 'Y' -or $install -eq 'y') {
        return Install-VideoJS
    }
    else {
        Write-Host "`n[i] Continuing without Video.js. Basic HTML5 player will be used." -ForegroundColor Gray
        Write-Host "    Enhanced features (playback speed, better controls) will be unavailable." -ForegroundColor Gray
        return $false
    }
}

function Install-VideoJS {
    Write-Host "`n=== Downloading Video.js ===" -ForegroundColor Cyan
    
    try {
        # Create videojs folder
        $videojsFolder = Join-Path $CONFIG.ToolsFolder "videojs"
        if (-not (Test-Path $videojsFolder)) {
            New-Item -ItemType Directory -Path $videojsFolder -Force | Out-Null
        }
        
        # Download Video.js CSS
        $cssUrl = "https://vjs.zencdn.net/8.10.0/video-js.min.css"
        $cssPath = Join-Path $videojsFolder "video-js.min.css"
        
        Write-Host "Downloading Video.js CSS..." -ForegroundColor Cyan
        $ProgressPreference = 'SilentlyContinue'
        Invoke-WebRequest -Uri $cssUrl -OutFile $cssPath -UseBasicParsing
        
        # Download Video.js JavaScript
        $jsUrl = "https://vjs.zencdn.net/8.10.0/video.min.js"
        $jsPath = Join-Path $videojsFolder "video.min.js"
        
        Write-Host "Downloading Video.js JavaScript..." -ForegroundColor Cyan
        Invoke-WebRequest -Uri $jsUrl -OutFile $jsPath -UseBasicParsing
        $ProgressPreference = 'Continue'
        
        # Verify installation
        if ((Test-Path $cssPath) -and (Test-Path $jsPath)) {
            Write-Host "[✓] Video.js installed successfully!" -ForegroundColor Green
            Write-Host "    Location: $videojsFolder" -ForegroundColor Gray
            return $true
        }
        else {
            Write-Host "[✗] Failed to download Video.js files" -ForegroundColor Red
            return $false
        }
    }
    catch {
        Write-Host "[✗] Failed to download Video.js: $_" -ForegroundColor Red
        Write-Host "    Will fall back to basic HTML5 player." -ForegroundColor Gray
        return $false
    }
}

# ============================================================================
# EPUB.JS DEPENDENCY CHECK (FOR EBOOK READER)
# ============================================================================

function Test-EpubjsAvailability {
    Write-Host "`n=== Checking Epub.js (for Enhanced eBook Reader) ===" -ForegroundColor Cyan
    
    # Check if Epub.js files exist in local folder (rootfolder\tools\epubjs)
    $epubjsFolder = Join-Path $CONFIG.ToolsFolder "epubjs"
    $epubjsJs = Join-Path $epubjsFolder "epub.min.js"
    
    if (Test-Path $epubjsJs) {
        Write-Host "[✓] Epub.js found in local tools folder" -ForegroundColor Green
        Write-Host "    Location: $epubjsFolder" -ForegroundColor Gray
        return $true
    }
    
    # Epub.js not found
    Write-Host "`n[!] Epub.js is not installed locally." -ForegroundColor Yellow
    Write-Host "    Epub.js provides enhanced eBook reading features for EPUB files." -ForegroundColor Gray
    Write-Host "    Without it, basic browser rendering will be used (limited features)." -ForegroundColor Gray
    Write-Host "    Size: ~300 KB download" -ForegroundColor Gray
    
    $install = Read-Host "`nWould you like to download Epub.js now for offline use? (Y/N)"
    
    if ($install -eq 'Y' -or $install -eq 'y') {
        return Install-Epubjs
    }
    else {
        Write-Host "`n[i] Continuing without Epub.js. Basic eBook viewer will be used." -ForegroundColor Gray
        Write-Host "    Enhanced features (TOC navigation, themes, bookmarks) will be unavailable." -ForegroundColor Gray
        return $false
    }
}

function Install-Epubjs {
    Write-Host "`n=== Downloading Epub.js ===" -ForegroundColor Cyan
    
    try {
        # Create epubjs folder in tools directory
        $epubjsFolder = Join-Path $CONFIG.ToolsFolder "epubjs"
        if (-not (Test-Path $epubjsFolder)) {
            New-Item -ItemType Directory -Path $epubjsFolder -Force | Out-Null
        }
        
        # Download Epub.js library (using CDN version)
        $jsUrl = "https://cdn.jsdelivr.net/npm/epubjs@0.3.93/dist/epub.min.js"
        $jsPath = Join-Path $epubjsFolder "epub.min.js"
        
        Write-Host "Downloading Epub.js library..." -ForegroundColor Cyan
        Write-Host "From: $jsUrl" -ForegroundColor Gray
        
        # Try wget first, fallback to Invoke-WebRequest
        try {
            if (Get-Command wget -ErrorAction SilentlyContinue) {
                Write-Host "Using wget for download..." -ForegroundColor Gray
                wget $jsUrl -O $jsPath
            } else {
                throw "wget not available"
            }
        }
        catch {
            Write-Host "wget not found - using Invoke-WebRequest..." -ForegroundColor Gray
            $ProgressPreference = 'SilentlyContinue'
            Invoke-WebRequest -Uri $jsUrl -OutFile $jsPath -UseBasicParsing
            $ProgressPreference = 'Continue'
        }
        
        # Verify installation
        if (Test-Path $jsPath) {
            Write-Host "[✓] Epub.js installed successfully!" -ForegroundColor Green
            Write-Host "    Location: $epubjsFolder" -ForegroundColor Gray
            return $true
        }
        else {
            Write-Host "[✗] Failed to download Epub.js files" -ForegroundColor Red
            return $false
        }
    }
    catch {
        Write-Host "[✗] Failed to download Epub.js: $_" -ForegroundColor Red
        Write-Host "    Will fall back to basic eBook viewer." -ForegroundColor Gray
        return $false
    }
}

# ============================================================================
# DATABASE INITIALIZATION
# ============================================================================

function Initialize-Database {
    param(
        [string]$DatabasePath,
        [string]$Type  # "movies", "music", "pictures", or "ebooks"
    )
    
    Write-NexusMLog "Initializing $Type database: $DatabasePath"
    
    if ($Type -eq "movies") {
        Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
CREATE TABLE IF NOT EXISTS videos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename TEXT NOT NULL,
    filepath TEXT NOT NULL UNIQUE,
    title TEXT,
    year INTEGER,
    duration INTEGER,
    size_bytes INTEGER,
    format TEXT,
    resolution TEXT,
    width INTEGER,
    height INTEGER,
    codec TEXT,
    bitrate INTEGER,
    poster_url TEXT,
    backdrop_path TEXT,
    backdrop_url TEXT,
    tmdb_id INTEGER,
    media_type TEXT DEFAULT 'movie',
    genre TEXT,
    rating REAL,
    overview TEXT,
    director TEXT,
    cast TEXT,
    runtime INTEGER,
    audio_tracks TEXT,
    quality_score INTEGER,
    is_low_quality BOOLEAN DEFAULT 0,
    needs_metadata BOOLEAN DEFAULT 1,
    manually_edited BOOLEAN DEFAULT 0,
    date_added DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_modified DATETIME,
    last_played DATETIME
);

CREATE INDEX IF NOT EXISTS idx_videos_title ON videos(title);
CREATE INDEX IF NOT EXISTS idx_videos_year ON videos(year);
CREATE INDEX IF NOT EXISTS idx_videos_filepath ON videos(filepath);
CREATE INDEX IF NOT EXISTS idx_videos_quality ON videos(is_low_quality);
CREATE INDEX IF NOT EXISTS idx_videos_metadata ON videos(needs_metadata);
CREATE INDEX IF NOT EXISTS idx_videos_media_type ON videos(media_type);
"@
        
        # Add new backdrop columns to existing database if they don't exist
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE videos ADD COLUMN backdrop_path TEXT" -ErrorAction SilentlyContinue
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE videos ADD COLUMN backdrop_url TEXT" -ErrorAction SilentlyContinue
        } catch {
            # Columns already exist, ignore
        }
    }
    elseif ($Type -eq "music") {
        Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
CREATE TABLE IF NOT EXISTS music (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename TEXT NOT NULL,
    filepath TEXT NOT NULL UNIQUE,
    title TEXT,
    artist TEXT,
    album TEXT,
    year INTEGER,
    duration INTEGER,
    size_bytes INTEGER,
    format TEXT,
    bitrate INTEGER,
    sample_rate INTEGER,
    channels INTEGER,
    album_art_url TEXT,
    album_art_cached TEXT,
    has_embedded_art BOOLEAN DEFAULT 0,
    musicbrainz_id TEXT,
    genre TEXT,
    track_number INTEGER,
    is_low_quality BOOLEAN DEFAULT 0,
    needs_metadata BOOLEAN DEFAULT 1,
    date_added DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_modified DATETIME,
    last_played DATETIME
);

CREATE INDEX IF NOT EXISTS idx_music_title ON music(title);
CREATE INDEX IF NOT EXISTS idx_music_artist ON music(artist);
CREATE INDEX IF NOT EXISTS idx_music_album ON music(album);
CREATE INDEX IF NOT EXISTS idx_music_filepath ON music(filepath);
CREATE INDEX IF NOT EXISTS idx_music_quality ON music(is_low_quality);
CREATE INDEX IF NOT EXISTS idx_music_metadata ON music(needs_metadata);
"@
        
        # Add new columns to existing database if they don't exist
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE music ADD COLUMN album_art_cached TEXT" -ErrorAction SilentlyContinue
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE music ADD COLUMN has_embedded_art BOOLEAN DEFAULT 0" -ErrorAction SilentlyContinue
        } catch {
            # Columns already exist, ignore
        }
    }
    elseif ($Type -eq "pictures") {
        Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
CREATE TABLE IF NOT EXISTS images (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename TEXT NOT NULL,
    filepath TEXT NOT NULL UNIQUE,
    width INTEGER,
    height INTEGER,
    size_bytes INTEGER,
    format TEXT,
    date_taken DATETIME,
    camera_make TEXT,
    camera_model TEXT,
    date_added DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_modified DATETIME,
    category TEXT,
    thumbnail_path TEXT
);

CREATE INDEX IF NOT EXISTS idx_images_filepath ON images(filepath);
CREATE INDEX IF NOT EXISTS idx_images_date_taken ON images(date_taken);
CREATE INDEX IF NOT EXISTS idx_images_category ON images(category);
"@
        # Migration: Add category and thumbnail_path columns if they don't exist (for existing databases)
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE images ADD COLUMN category TEXT" -ErrorAction SilentlyContinue
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "CREATE INDEX IF NOT EXISTS idx_images_category ON images(category)" -ErrorAction SilentlyContinue
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE images ADD COLUMN thumbnail_path TEXT" -ErrorAction SilentlyContinue
        } catch {
            # Columns already exist, ignore
        }
    }
    elseif ($Type -eq "ebooks") {
        Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
CREATE TABLE IF NOT EXISTS pdfs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename TEXT NOT NULL,
    filepath TEXT NOT NULL UNIQUE,
    title TEXT,
    author TEXT,
    subject TEXT,
    keywords TEXT,
    creator TEXT,
    producer TEXT,
    page_count INTEGER,
    size_bytes INTEGER,
    preview_image TEXT,
    date_created DATETIME,
    date_modified DATETIME,
    date_added DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_pdfs_filepath ON pdfs(filepath);
CREATE INDEX IF NOT EXISTS idx_pdfs_filename ON pdfs(filename);
CREATE INDEX IF NOT EXISTS idx_pdfs_title ON pdfs(title);
"@
    }
    elseif ($Type -eq "musicvideos") {
        Invoke-SqliteQuery -DataSource $DatabasePath -Query @"
CREATE TABLE IF NOT EXISTS musicvideos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    filename TEXT NOT NULL,
    filepath TEXT NOT NULL UNIQUE,
    title TEXT,
    artist TEXT,
    album TEXT,
    year INTEGER,
    duration INTEGER,
    size_bytes INTEGER,
    format TEXT,
    resolution TEXT,
    width INTEGER,
    height INTEGER,
    codec TEXT,
    bitrate INTEGER,
    genre TEXT,
    thumbnail_path TEXT,
    moov_position TEXT,
    stream_order TEXT,
    needs_optimization INTEGER DEFAULT 0,
    mp4_compliant INTEGER DEFAULT 1,
    date_added DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_modified DATETIME,
    last_played DATETIME
);

CREATE INDEX IF NOT EXISTS idx_musicvideos_title ON musicvideos(title);
CREATE INDEX IF NOT EXISTS idx_musicvideos_artist ON musicvideos(artist);
CREATE INDEX IF NOT EXISTS idx_musicvideos_filepath ON musicvideos(filepath);
CREATE INDEX IF NOT EXISTS idx_musicvideos_needs_optimization ON musicvideos(needs_optimization);
CREATE INDEX IF NOT EXISTS idx_musicvideos_mp4_compliant ON musicvideos(mp4_compliant);
"@
        
        # Add thumbnail_path column to existing database if it doesn't exist
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE musicvideos ADD COLUMN thumbnail_path TEXT" -ErrorAction SilentlyContinue
        } catch {
            # Column already exists, ignore
        }
        
        # v7.54: Add MP4 compliance columns to existing database
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE musicvideos ADD COLUMN moov_position TEXT" -ErrorAction SilentlyContinue
        } catch { }
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE musicvideos ADD COLUMN stream_order TEXT" -ErrorAction SilentlyContinue
        } catch { }
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE musicvideos ADD COLUMN needs_optimization INTEGER DEFAULT 0" -ErrorAction SilentlyContinue
        } catch { }
        
        # v7.65: Add mp4_compliant column for detecting problematic MP4 structures
        try {
            Invoke-SqliteQuery -DataSource $DatabasePath -Query "ALTER TABLE musicvideos ADD COLUMN mp4_compliant INTEGER DEFAULT 1" -ErrorAction SilentlyContinue
        } catch { }
    }
    
    Write-NexusMLog "Database initialized successfully: $Type"
}

# ============================================================================
# TMDB API FUNCTIONS
# ============================================================================

function Get-TMDBMoviePoster {
    param(
        [string]$MovieTitle,
        [int]$Year = $null,
        [int]$VideoId,
        [switch]$Silent = $false
    )
    
    # Skip if no API key configured
    if ([string]::IsNullOrWhiteSpace($CONFIG.TMDB_APIKey)) {
        return $null
    }
    
    # Create poster cache folder if it doesn't exist
    if (-not (Test-Path $CONFIG.PosterCacheFolder)) {
        New-Item -ItemType Directory -Path $CONFIG.PosterCacheFolder -Force | Out-Null
    }
    
    # Aggressive title cleaning
    $cleanTitle = $MovieTitle
    
    # Remove everything after season/episode markers (S01E01, etc.)
    $cleanTitle = $cleanTitle -replace 'S\d{2}E\d{2}.*$', ''
    $cleanTitle = $cleanTitle -replace 'Season\s*\d+.*$', ''
    $cleanTitle = $cleanTitle -replace 'Episode\s*\d+.*$', ''
    
    # Remove year in parentheses if it exists (we'll use the year parameter instead)
    $cleanTitle = $cleanTitle -replace '\(\d{4}\)', ''
    $cleanTitle = $cleanTitle -replace '\[\d{4}\]', ''
    
    # Remove common release group tags first [xxx] or (xxx)
    $cleanTitle = $cleanTitle -replace '\[[\w\.\-]+\]', ''
    $cleanTitle = $cleanTitle -replace '\([\w\s\.\-]+\)$', ''
    
    # Remove quality indicators and everything after them (more comprehensive)
    $cleanTitle = $cleanTitle -replace '(1080p|720p|480p|2160p|4K|HDR|HDR10|HDR10Plus|DV|Dolby|HEVC|x264|x265|h264|h265|BluRay|BRRip|WEB-DL|WEBRip|WEB|HDTV|DVDRip|BRRip|AMZN|NF|DSNP|iP|DDP5|AAC|H\.264|H\.265|REPACK|PROPER|RERIP|10Bit|8Bit|IMAX|EXTENDED|UNRATED|DC).*$', ''
    
    # Remove streaming service tags
    $cleanTitle = $cleanTitle -replace '(AMZN|Netflix|NF|DSNP|HMAX|ATVP|PCOK|PMTP).*$', ''
    
    # Remove encoder/release group patterns
    $cleanTitle = $cleanTitle -replace '(ETHEL|RGB|PSA|WADU|ViTO|BYNDR|Ghost|RAWR|EZTVx).*$', ''
    
    # Remove file extensions
    $cleanTitle = $cleanTitle -replace '\.(mkv|mp4|avi|m4v|wmv|flv|webm)$', ''
    
    # Replace dots, underscores, and dashes with spaces BEFORE removing years
    $cleanTitle = $cleanTitle -replace '[\.\-_]+', ' '
    
    # Remove resolution numbers in parentheses like (1080) or (720)
    $cleanTitle = $cleanTitle -replace '\(1080\)', ''
    $cleanTitle = $cleanTitle -replace '\(720\)', ''
    $cleanTitle = $cleanTitle -replace '\(480\)', ''
    $cleanTitle = $cleanTitle -replace '\(2160\)', ''
    $cleanTitle = $cleanTitle -replace '\(4K\)', ''
    
    # Remove standalone resolution numbers like " 1080 ", " 720 ", " 2160 ", " 480 "
    $cleanTitle = $cleanTitle -replace '\s+(1080|720|480|2160|4K)\s*', ' '
    
    # Remove standalone year numbers (2024, 2025, etc.)
    $cleanTitle = $cleanTitle -replace '\s+20\d{2}\s*', ' '
    $cleanTitle = $cleanTitle -replace '\s+19\d{2}\s*', ' '
    
    # Remove "to" at the end (from torrents like "EZTVx.to")
    $cleanTitle = $cleanTitle -replace '\s+to\s*$', ''
    
    # Remove multiple spaces
    $cleanTitle = $cleanTitle -replace '\s{2,}', ' '
    
    # Trim whitespace
    $cleanTitle = $cleanTitle.Trim()
    
    try {
        # Search for the movie/TV show
        $searchUrl = "https://api.themoviedb.org/3/search/multi?api_key=$($CONFIG.TMDB_APIKey)&query=$([System.Web.HttpUtility]::UrlEncode($cleanTitle))"
        
        if ($Year) {
            # Try movie search first with year
            $movieSearchUrl = "https://api.themoviedb.org/3/search/movie?api_key=$($CONFIG.TMDB_APIKey)&query=$([System.Web.HttpUtility]::UrlEncode($cleanTitle))&year=$Year"
            $searchResponse = Invoke-RestMethod -Uri $movieSearchUrl -Method Get -ErrorAction Stop
            
            # If no movie results, try TV search
            if (-not $searchResponse.results -or $searchResponse.results.Count -eq 0) {
                $tvSearchUrl = "https://api.themoviedb.org/3/search/tv?api_key=$($CONFIG.TMDB_APIKey)&query=$([System.Web.HttpUtility]::UrlEncode($cleanTitle))&first_air_date_year=$Year"
                $searchResponse = Invoke-RestMethod -Uri $tvSearchUrl -Method Get -ErrorAction Stop
            }
        }
        else {
            # No year provided, use multi search
            $searchResponse = Invoke-RestMethod -Uri $searchUrl -Method Get -ErrorAction Stop
        }
        
        if (-not $Silent) {
            Write-Host "Searching TMDB for: $cleanTitle $(if($Year){"($Year)"})" -ForegroundColor Gray
        }
        
        if ($searchResponse.results -and $searchResponse.results.Count -gt 0) {
            $item = $searchResponse.results[0]
            
            # Get poster path (works for both movies and TV shows)
            $posterPath = $item.poster_path
            $backdropPath = $item.backdrop_path
            $itemTitle = if ($item.title) { $item.title } else { $item.name }
            $itemRating = if ($item.vote_average) { $item.vote_average } else { 0 }
            $tmdbId = $item.id
            $mediaType = if ($item.media_type) { $item.media_type } else { if ($item.title) { "movie" } else { "tv" } }
            
            # Fetch full details to get genres
            $genreString = $null
            $overview = $null
            $director = $null
            $castString = $null
            $runtime = $null
            try {
                # Add delay before detail fetch to avoid rate limiting
                Start-Sleep -Milliseconds 500
                
                # Build URL with explicit variable expansion to avoid substitution bugs
                $apiKey = $CONFIG.TMDB_APIKey
                if ($mediaType -eq "movie") {
                    $detailsUrl = "https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${apiKey}&append_to_response=credits"
                } else {
                    $detailsUrl = "https://api.themoviedb.org/3/tv/${tmdbId}?api_key=${apiKey}&append_to_response=credits"
                }
                
                if (-not $Silent) {
                    Write-Host "  Fetching $mediaType details..." -ForegroundColor Gray
                }
                $details = Invoke-RestMethod -Uri $detailsUrl -Method Get -ErrorAction Stop
                
                # Extract overview
                if ($details.overview) {
                    $overview = $details.overview
                    if (-not $Silent) {
                        Write-Host "  ✓ Overview retrieved" -ForegroundColor Green
                    }
                }
                
                # Extract runtime
                if ($details.runtime) {
                    $runtime = $details.runtime
                    if (-not $Silent) {
                        Write-Host "  ✓ Runtime: $runtime minutes" -ForegroundColor Green
                    }
                } elseif ($details.episode_run_time -and $details.episode_run_time.Count -gt 0) {
                    $runtime = $details.episode_run_time[0]
                    if (-not $Silent) {
                        Write-Host "  ✓ Runtime: $runtime minutes (TV episode)" -ForegroundColor Green
                    }
                }
                
                # Extract director (for movies)
                if ($mediaType -eq "movie" -and $details.credits -and $details.credits.crew) {
                    $directorObj = $details.credits.crew | Where-Object { $_.job -eq "Director" } | Select-Object -First 1
                    if ($directorObj) {
                        $director = $directorObj.name
                        if (-not $Silent) {
                            Write-Host "  ✓ Director: $director" -ForegroundColor Green
                        }
                    }
                } elseif ($mediaType -eq "tv" -and $details.created_by -and $details.created_by.Count -gt 0) {
                    $director = $details.created_by[0].name
                    if (-not $Silent) {
                        Write-Host "  ✓ Creator: $director" -ForegroundColor Green
                    }
                }
                
                # Extract cast (top 10 actors)
                $castString = $null
                if ($details.credits -and $details.credits.cast) {
                    $topCast = $details.credits.cast | Select-Object -First 10
                    if ($topCast) {
                        $castNames = $topCast | ForEach-Object { $_.name }
                        $castString = $castNames -join ", "
                        $castCount = $castNames.Count
                        if (-not $Silent) {
                            Write-Host "  ✓ Cast: $castCount actors retrieved" -ForegroundColor Green
                        }
                    }
                }
                
                # Extract genre names and join with commas
                if ($details.genres -and $details.genres.Count -gt 0) {
                    $genreNames = $details.genres | ForEach-Object { $_.name }
                    $genreString = $genreNames -join ", "
                    if (-not $Silent) {
                        Write-Host "  ✓ Genres: $genreString" -ForegroundColor Green
                    }
                } else {
                    if (-not $Silent) {
                        Write-Host "  ⚠ No genres found in TMDB data" -ForegroundColor Yellow
                    }
                }
            }
            catch {
                if (-not $Silent) {
                    Write-Host "  ⚠ Could not fetch genre details: $($_.Exception.Message)" -ForegroundColor Yellow
                }
            }
            
            if ($posterPath) {
                $posterUrl = "https://image.tmdb.org/t/p/w500$posterPath"
                # Use TMDB ID and media type for filename to avoid duplicates for same show/movie
                $posterFileName = "${mediaType}_${tmdbId}.jpg"
                $posterFullPath = Join-Path $CONFIG.PosterCacheFolder $posterFileName
                
                # Download poster if not already cached
                if (-not (Test-Path $posterFullPath)) {
                    if (-not $Silent) {
                        Write-Host "  ✓ Downloading poster: $itemTitle" -ForegroundColor Green
                    }
                    Invoke-WebRequest -Uri $posterUrl -OutFile $posterFullPath -ErrorAction Stop
                }
                else {
                    if (-not $Silent) {
                        Write-Host "  ✓ Poster already cached: $itemTitle" -ForegroundColor Cyan
                    }
                }
                
                # Download backdrop if available
                $backdropFileName = $null
                if ($backdropPath) {
                    $backdropUrl = "https://image.tmdb.org/t/p/w1280$backdropPath"
                    # Use TMDB ID and media type for filename to avoid duplicates for same show/movie
                    $backdropFileName = "backdrop_${mediaType}_${tmdbId}.jpg"
                    $backdropFullPath = Join-Path $CONFIG.PosterCacheFolder $backdropFileName
                    
                    # Download backdrop if not already cached
                    if (-not (Test-Path $backdropFullPath)) {
                        if (-not $Silent) {
                            Write-Host "  ✓ Downloading backdrop: $itemTitle" -ForegroundColor Green
                        }
                        Invoke-WebRequest -Uri $backdropUrl -OutFile $backdropFullPath -ErrorAction Stop
                    }
                    else {
                        if (-not $Silent) {
                            Write-Host "  ✓ Backdrop already cached: $itemTitle" -ForegroundColor Cyan
                        }
                    }
                }
                else {
                    if (-not $Silent) {
                        Write-Host "  ⚠ No backdrop available for: $itemTitle" -ForegroundColor Yellow
                    }
                }
                
                # Update database with poster info AND genres - only if not manually edited
                Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
UPDATE videos 
SET poster_url = CASE WHEN manually_edited = 1 THEN poster_url ELSE @url END, 
    backdrop_path = CASE WHEN manually_edited = 1 THEN backdrop_path ELSE @backdrop_path END,
    backdrop_url = CASE WHEN manually_edited = 1 THEN backdrop_url ELSE @backdrop_url END,
    tmdb_id = CASE WHEN manually_edited = 1 THEN tmdb_id ELSE @tmdb_id END,
    media_type = CASE WHEN manually_edited = 1 THEN media_type ELSE @media_type END,
    rating = CASE WHEN manually_edited = 1 THEN rating ELSE @rating END,
    genre = CASE WHEN manually_edited = 1 THEN genre ELSE @genre END,
    overview = CASE WHEN manually_edited = 1 THEN overview ELSE @overview END,
    director = CASE WHEN manually_edited = 1 THEN director ELSE @director END,
    "cast" = CASE WHEN manually_edited = 1 THEN "cast" ELSE @cast END,
    runtime = CASE WHEN manually_edited = 1 THEN runtime ELSE @runtime END,
    needs_metadata = CASE WHEN manually_edited = 1 THEN needs_metadata ELSE 0 END
WHERE id = @id
"@ -SqlParameters @{
                    url = $posterFileName
                    backdrop_path = $backdropPath
                    backdrop_url = $backdropFileName
                    tmdb_id = $tmdbId
                    media_type = $mediaType
                    rating = $itemRating
                    genre = $genreString
                    overview = $overview
                    director = $director
                    cast = $castString
                    runtime = $runtime
                    id = $VideoId
                }
                
                return $posterFileName
            }
            else {
                if (-not $Silent) {
                    Write-Host "  ⚠ No poster available for: $itemTitle" -ForegroundColor Yellow
                }
            }
        }
        else {
            if (-not $Silent) {
                Write-Host "  ✗ No results found for: $cleanTitle $(if($Year){"($Year)"})" -ForegroundColor Yellow
            }
        }
    }
    catch {
        if (-not $Silent) {
            Write-Host "  ✗ Error fetching poster: $_" -ForegroundColor Red
        }
    }
    
    return $null
}

function Update-AllMoviePosters {
    param(
        [switch]$Silent = $false
    )
    
    if (-not $Silent) {
        Write-Host "`n=== Fetching Movie Posters from TMDB ===" -ForegroundColor Cyan
    }
    
    if ([string]::IsNullOrWhiteSpace($CONFIG.TMDB_APIKey)) {
        if (-not $Silent) {
            Write-Host "`n[!] TMDB API key not configured!" -ForegroundColor Yellow
            Write-Host "    Add your API key to the config to enable poster downloads." -ForegroundColor Gray
            Write-Host "    Get free API key at: https://www.themoviedb.org/settings/api" -ForegroundColor Gray
        }
        return
    }
    
    # Get UNIQUE titles without posters - GROUP BY title to avoid duplicates for TV series
    # For each unique title, get one representative video ID to use for poster download
    $videosNeedingPosters = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
SELECT 
    MIN(id) as id,
    title, 
    year 
FROM videos 
WHERE poster_url IS NULL OR poster_url = ''
GROUP BY title, year
LIMIT 50
"@
    
    if (-not $videosNeedingPosters) {
        if (-not $Silent) {
            Write-Host "All videos already have posters!" -ForegroundColor Green
        }
        return
    }
    
    if (-not $Silent) {
        Write-Host "Fetching posters for $($videosNeedingPosters.Count) unique titles..." -ForegroundColor Cyan
    }
    
    $count = 0
    foreach ($video in $videosNeedingPosters) {
        $count++
        if (-not $Silent) {
            Write-Host "[$count/$($videosNeedingPosters.Count)] " -NoNewline -ForegroundColor Gray
        }
        $posterFileName = Get-TMDBMoviePoster -MovieTitle $video.title -Year $video.year -VideoId $video.id -Silent:$Silent
        
        # If poster was downloaded successfully, update ALL videos with the same title
        if ($posterFileName) {
            # Update all videos with the same title to use this poster
            $allVideosWithTitle = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
SELECT id FROM videos 
WHERE title = @title AND year = @year AND (poster_url IS NULL OR poster_url = '')
"@ -SqlParameters @{
                title = $video.title
                year = $video.year
            }
            
            foreach ($relatedVideo in $allVideosWithTitle) {
                if ($relatedVideo.id -ne $video.id) {
                    # Update related videos to use the same poster
                    Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
UPDATE videos 
SET poster_url = @poster_url,
    needs_metadata = 0
WHERE id = @id
"@ -SqlParameters @{
                        poster_url = $posterFileName
                        id = $relatedVideo.id
                    }
                }
            }
        }
        
        # Rate limiting - TMDB allows 40 requests per 10 seconds
        Start-Sleep -Milliseconds 300
    }
    
    if (-not $Silent) {
        Write-Host "`n[✓] Poster fetch complete!" -ForegroundColor Green
    }
}

function Update-AllGenres {
    Write-Host "`n=== Refreshing Genres from TMDB ===" -ForegroundColor Cyan
    
    if ([string]::IsNullOrWhiteSpace($CONFIG.TMDB_APIKey)) {
        Write-Host "`n[!] TMDB API key not configured!" -ForegroundColor Yellow
        Write-Host "    Add your API key to the config to enable genre fetching." -ForegroundColor Gray
        Write-Host "    Get free API key at: https://www.themoviedb.org/settings/api" -ForegroundColor Gray
        return
    }
    
    # Get ALL videos (or videos without genres)
    $allVideos = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT id, title, year, genre FROM videos ORDER BY date_added DESC"
    
    if (-not $allVideos) {
        Write-Host "No videos found in database!" -ForegroundColor Yellow
        return
    }
    
    # Count how many need genre updates
    $videosNeedingGenres = $allVideos | Where-Object { [string]::IsNullOrWhiteSpace($_.genre) }
    $totalToUpdate = $allVideos.Count
    
    if ($videosNeedingGenres.Count -eq 0) {
        Write-Host "`nAll videos already have genres!" -ForegroundColor Green
        $refreshAll = Read-Host "Would you like to refresh all genres anyway? (Y/N)"
        if ($refreshAll -ne 'Y' -and $refreshAll -ne 'y') {
            return
        }
    }
    
    Write-Host "Fetching genres for $totalToUpdate videos..." -ForegroundColor Cyan
    Write-Host "(This will also update posters if missing)`n" -ForegroundColor Gray
    
    $count = 0
    $updated = 0
    foreach ($video in $allVideos) {
        $count++
        Write-Host "[$count/$totalToUpdate] " -NoNewline -ForegroundColor Gray
        
        # Use existing poster fetch function which now also gets genres
        $result = Get-TMDBMoviePoster -MovieTitle $video.title -Year $video.year -VideoId $video.id
        
        if ($result) {
            $updated++
        }
        
        # Rate limiting - TMDB allows 40 requests per 10 seconds
        # With 2 API calls per movie (search + details), we need more delay
        Start-Sleep -Milliseconds 800
    }
    
    Write-Host "`n[✓] Genre refresh complete! Updated $updated movies." -ForegroundColor Green
}

# ============================================================================
# MEDIA SCANNING FUNCTIONS
# ============================================================================

function Get-MediaFiles {
    param(
        [string]$Path,
        [string[]]$Extensions
    )
    
    if (-not (Test-Path $Path)) {
        Write-NexusMLog "Path not found: $Path" -Level "WARNING"
        return @()
    }
    
    Write-NexusMLog "Scanning: $Path"
    Get-ChildItem -Path $Path -File -Recurse -ErrorAction SilentlyContinue |
        Where-Object { $_.Extension -in $Extensions }
}

function Get-VideoMetadata {
    param([System.IO.FileInfo]$File)
    
    $metadata = @{
        filename = $File.Name
        filepath = $File.FullName
        title = [System.IO.Path]::GetFileNameWithoutExtension($File.Name)
        size_bytes = $File.Length
        format = $File.Extension.TrimStart('.')
        last_modified = $File.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
        needs_metadata = 1
        year = $null
        resolution = $null
        height = $null
        is_low_quality = 0
    }
    
    # Try to extract basic info from filename - only valid years (19xx or 20xx)
    if ($File.Name -match '(19\d{2}|20\d{2})') {
        $possibleYear = [int]$matches[1]
        # Exclude common resolution numbers
        if ($possibleYear -notin @(1080, 2160, 720, 480)) {
            $metadata.year = $possibleYear
        }
    }
    
    # Determine quality based on filename patterns
    if ($File.Name -match '(\d{3,4})p') {
        $height = [int]$matches[1]
        $metadata.height = $height
        $metadata.resolution = "${height}p"
        $metadata.is_low_quality = if ($height -lt $CONFIG.LowQualityVideoThreshold) { 1 } else { 0 }
    }
    
    return $metadata
}

function Get-AudioMetadata {
    param([System.IO.FileInfo]$File)
    
    # Initialize default metadata
    $metadata = @{
        filename = $File.Name
        filepath = $File.FullName
        title = $null
        size_bytes = $File.Length
        format = $File.Extension.TrimStart('.')
        last_modified = $File.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
        needs_metadata = 1
        artist = $null
        album = $null
        album_artist = $null
        year = $null
        genre = $null
        track_number = $null
        duration = $null
        bitrate = $null
        sample_rate = $null
        channels = $null
        composer = $null
    }
    
    try {
        # Use Shell.Application to read metadata
        $shell = New-Object -ComObject Shell.Application
        $folder = $shell.Namespace($File.DirectoryName)
        $item = $folder.ParseName($File.Name)
        
        if ($item) {
            # Extract metadata using Shell property indices
            # Note: These indices are consistent across Windows systems
            
            # Title (index 21)
            $title = $folder.GetDetailsOf($item, 21)
            if (-not [string]::IsNullOrWhiteSpace($title)) {
                $metadata.title = $title
                $metadata.needs_metadata = 0
            } else {
                $metadata.title = [System.IO.Path]::GetFileNameWithoutExtension($File.Name)
            }
            
            # Contributing artists (index 13)
            $artist = $folder.GetDetailsOf($item, 13)
            if (-not [string]::IsNullOrWhiteSpace($artist)) {
                $metadata.artist = $artist
            }
            
            # Album artist (index 20) - Falls back to contributing artists if not set
            $albumArtist = $folder.GetDetailsOf($item, 20)
            if (-not [string]::IsNullOrWhiteSpace($albumArtist)) {
                $metadata.album_artist = $albumArtist
            } elseif (-not [string]::IsNullOrWhiteSpace($artist)) {
                $metadata.album_artist = $artist
            }
            
            # Album (index 14)
            $album = $folder.GetDetailsOf($item, 14)
            if (-not [string]::IsNullOrWhiteSpace($album)) {
                $metadata.album = $album
            }
            
            # Year (index 15)
            $year = $folder.GetDetailsOf($item, 15)
            if ($year -match '(\d{4})') {
                $metadata.year = [int]$matches[1]
            }
            
            # Genre (index 16)
            $genre = $folder.GetDetailsOf($item, 16)
            if (-not [string]::IsNullOrWhiteSpace($genre)) {
                $metadata.genre = $genre
            }
            
            # Track number (index 26)
            $track = $folder.GetDetailsOf($item, 26)
            if ($track -match '(\d+)') {
                $metadata.track_number = [int]$matches[1]
            }
            
            # Duration (index 27) - format: HH:MM:SS or MM:SS
            $duration = $folder.GetDetailsOf($item, 27)
            if ($duration -match '(\d+):(\d+):(\d+)') {
                # HH:MM:SS format
                $metadata.duration = ([int]$matches[1] * 3600) + ([int]$matches[2] * 60) + [int]$matches[3]
            } elseif ($duration -match '(\d+):(\d+)') {
                # MM:SS format
                $metadata.duration = ([int]$matches[1] * 60) + [int]$matches[2]
            }
            
            # Bit rate (index 28)
            $bitrate = $folder.GetDetailsOf($item, 28)
            if ($bitrate -match '(\d+)') {
                $metadata.bitrate = [int]$matches[1]
            }
            
            # Sample rate (index 318) - may vary by system, try common indices
            $sampleRate = $folder.GetDetailsOf($item, 318)
            if ([string]::IsNullOrWhiteSpace($sampleRate)) {
                $sampleRate = $folder.GetDetailsOf($item, 43)
            }
            if ($sampleRate -match '(\d+)') {
                $metadata.sample_rate = [int]$matches[1]
            }
            
            # Channels (index 319) - may vary, look for pattern
            $channels = $folder.GetDetailsOf($item, 319)
            if ([string]::IsNullOrWhiteSpace($channels)) {
                $channels = $folder.GetDetailsOf($item, 44)
            }
            if ($channels -match '(\d+)') {
                $metadata.channels = [int]$matches[1]
            } elseif ($channels -match 'stereo') {
                $metadata.channels = 2
            } elseif ($channels -match 'mono') {
                $metadata.channels = 1
            }
            
            # Composers (index 19)
            $composer = $folder.GetDetailsOf($item, 19)
            if (-not [string]::IsNullOrWhiteSpace($composer)) {
                $metadata.composer = $composer
            }
        }
        
        # Release COM object
        [System.Runtime.Interopservices.Marshal]::ReleaseComObject($shell) | Out-Null
        [System.GC]::Collect()
        [System.GC]::WaitForPendingFinalizers()
    }
    catch {
        Write-Verbose "Could not extract metadata from $($File.Name): $_"
        # Fall back to filename as title
        if (-not $metadata.title) {
            $metadata.title = [System.IO.Path]::GetFileNameWithoutExtension($File.Name)
        }
    }
    
    # DON'T use folder path as fallback for artist/album
    # Leave them as $null if not found in ID3 tags
    
    # Check for year in filename if not found in tags
    if (-not $metadata.year -and $File.Name -match '(\d{4})') {
        $metadata.year = [int]$matches[1]
    }
    
    return $metadata
}

function Get-ImageMetadata {
    param([System.IO.FileInfo]$File)
    
    return @{
        filename = $File.Name
        filepath = $File.FullName
        size_bytes = $File.Length
        format = $File.Extension.TrimStart('.')
        last_modified = $File.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
    }
}

function Get-PDFMetadata {
    param([System.IO.FileInfo]$File)
    
    # Basic metadata - we'll extract more detailed PDF info if needed
    $metadata = @{
        filename = $File.Name
        filepath = $File.FullName
        size_bytes = $File.Length
        title = $File.BaseName  # Use filename without extension as title
        date_modified = $File.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
        date_created = $File.CreationTime.ToString("yyyy-MM-dd HH:mm:ss")
    }
    
    # Try to extract PDF properties using .NET if available
    try {
        # We could add more sophisticated PDF parsing here if needed
        # For now, just using file properties
    }
    catch {
        # Silently continue with basic metadata
    }
    
    return $metadata
}

# ============================================================================
# ALBUM ARTWORK EXTRACTION (NEW)
# ============================================================================

function Extract-AlbumArtwork {
    param(
        [string]$MusicFilePath,
        [int]$MusicId
    )
    
    # Check if ffmpeg is available
    if (-not $Global:FFmpegPath -or -not (Test-Path $Global:FFmpegPath)) {
        return $null
    }
    
    # Create album art cache folder
    if (-not (Test-Path $CONFIG.AlbumArtCacheFolder)) {
        New-Item -ItemType Directory -Path $CONFIG.AlbumArtCacheFolder -Force | Out-Null
    }
    
    # Generate cache filename
    $artFileName = "albumart_$MusicId.jpg"
    $artFilePath = Join-Path $CONFIG.AlbumArtCacheFolder $artFileName
    
    # Check if already extracted
    if (Test-Path $artFilePath) {
        return $artFileName
    }
    
    # Extract embedded artwork using ffmpeg
    try {
        $process = Start-Process -FilePath $Global:FFmpegPath `
            -ArgumentList @(
                "-i", "`"$MusicFilePath`""
                "-an"
                "-vcodec", "copy"
                "`"$artFilePath`""
                "-y"
            ) `
            -NoNewWindow -Wait -PassThru `
            -RedirectStandardError "$env:TEMP\ffmpeg_err_$MusicId.txt" `
            -RedirectStandardOutput "$env:TEMP\ffmpeg_out_$MusicId.txt"
        
        if ($process.ExitCode -eq 0 -and (Test-Path $artFilePath)) {
            # Verify it's a valid image
            try {
                Add-Type -AssemblyName System.Drawing -ErrorAction SilentlyContinue
                $img = [System.Drawing.Image]::FromFile($artFilePath)
                $img.Dispose()
                
                # Update database
                Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
UPDATE music 
SET album_art_cached = @artFileName, has_embedded_art = 1
WHERE id = @musicId
"@ -SqlParameters @{ artFileName = $artFileName; musicId = $MusicId }
                
                Write-Verbose "  ✓ Extracted album art for ID $MusicId"
                return $artFileName
            }
            catch {
                # Not a valid image, delete it
                Remove-Item $artFilePath -Force -ErrorAction SilentlyContinue
                return $null
            }
        }
        return $null
    }
    catch {
        Write-Verbose "Failed to extract artwork: $_"
        return $null
    }
    finally {
        # Clean up temp files
        Remove-Item "$env:TEMP\ffmpeg_err_$MusicId.txt" -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:TEMP\ffmpeg_out_$MusicId.txt" -Force -ErrorAction SilentlyContinue
    }
}

function Extract-AllAlbumArtwork {
    param(
        [switch]$Force
    )
    
    Write-Host "`n=== Extracting Album Artwork ===" -ForegroundColor Cyan
    
    if ($Force) {
        Write-Host "[!] Force mode enabled - will re-extract all artwork" -ForegroundColor Yellow
    }
    
    # Check if ffmpeg is available
    if (-not $Global:FFmpegPath) {
        Write-Host "[!] ffmpeg is not available. Album artwork extraction requires ffmpeg." -ForegroundColor Yellow
        
        # Try to install ffmpeg automatically (non-interactive)
        # Only prompt if running interactively (not from web)
        if ([Environment]::UserInteractive -and $Host.UI.RawUI.KeyAvailable -ne $null) {
            $install = Read-Host "`nWould you like to download ffmpeg now? (Y/N)"
            if ($install -eq 'Y' -or $install -eq 'y') {
                if (-not (Install-FFmpeg)) {
                    Write-Host "[✗] Cannot extract album artwork without ffmpeg" -ForegroundColor Red
                    return
                }
            }
            else {
                Write-Host "[i] Skipping album artwork extraction" -ForegroundColor Gray
                return
            }
        }
        else {
            # Non-interactive mode (web request) - just return without extraction
            Write-Host "[✗] Cannot extract album artwork without ffmpeg (non-interactive mode)" -ForegroundColor Red
            return
        }
    }
    
    # Check if album_artist column exists in the database
    $hasAlbumArtist = $false
    try {
        $tableInfo = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "PRAGMA table_info(music);"
        $hasAlbumArtist = ($tableInfo | Where-Object { $_.name -eq 'album_artist' }).Count -gt 0
    }
    catch {
        Write-Host "[!] Warning: Could not check database schema" -ForegroundColor Yellow
    }
    
    # Get all music files - if Force, get all files; otherwise only get files without artwork
    $musicFiles = $null
    $whereClause = if ($Force) { "" } else { "WHERE album_art_cached IS NULL OR album_art_cached = ''" }
    
    try {
        if ($hasAlbumArtist) {
            $musicFiles = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
SELECT id, filepath, filename, artist, album, album_artist 
FROM music 
$whereClause
ORDER BY album, artist
"@
        }
        else {
            Write-Host "[i] Using database schema without album_artist column" -ForegroundColor Gray
            $musicFiles = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
SELECT id, filepath, filename, artist, album 
FROM music 
$whereClause
ORDER BY album, artist
"@
        }
    }
    catch {
        Write-Host "[✗] Error querying database: $_" -ForegroundColor Red
        Write-Host "[!] Please ensure the music database exists and has been scanned" -ForegroundColor Yellow
        return
    }
    
    if (-not $musicFiles -or $musicFiles.Count -eq 0) {
        Write-Host "[✓] All music files already have artwork extracted (or none available)" -ForegroundColor Green
        return
    }
    
    Write-Host "Found $($musicFiles.Count) music files to process..." -ForegroundColor Cyan
    
    # Group files by album to avoid duplicate extractions
    # FIXED: Group by album name only (not artist) to handle compilation albums properly
    # Albums like "Now 115" or "Summer Indie 2025" have different artists per track
    $albumGroups = @{}
    $ungroupedFiles = @()
    
    foreach ($music in $musicFiles) {
        # Check if we have valid album metadata
        $hasValidAlbum = -not [string]::IsNullOrWhiteSpace($music.album)
        
        if ($hasValidAlbum) {
            # We have album metadata - group by album name
            # Use album_artist if available for more precise grouping, otherwise just album
            $albumArtist = if ($music.PSObject.Properties.Name -contains 'album_artist' -and -not [string]::IsNullOrWhiteSpace($music.album_artist)) { 
                $music.album_artist 
            } else { 
                $null 
            }
            
            # For album key, use album_artist::album if album_artist exists, otherwise just album
            # This handles compilation albums (Various Artists) properly
            $albumKey = if ($albumArtist) { 
                "${albumArtist}::$($music.album)" 
            } else { 
                # Just use album name - this groups all tracks of "Now 115" together
                # regardless of individual track artists
                $music.album 
            }
            
            if (-not $albumGroups.ContainsKey($albumKey)) {
                $albumGroups[$albumKey] = @()
            }
            $albumGroups[$albumKey] += $music
        }
        else {
            # No album metadata - extract individually
            $ungroupedFiles += $music
        }
    }
    
    $totalToProcess = $albumGroups.Count + $ungroupedFiles.Count
    Write-Host "Processing $($albumGroups.Count) albums and $($ungroupedFiles.Count) individual files..." -ForegroundColor Cyan
    Write-Host "Using parallel processing ($($CONFIG.AlbumArtFactor) concurrent extractions)..." -ForegroundColor Green
    
    if ($albumGroups.Count -gt 0) {
        Write-Host "Grouped files will save time by avoiding duplicate artwork extraction!" -ForegroundColor Green
    }
    
    # Use thread-safe concurrent collections for counters
    $extractedBag = [System.Collections.Concurrent.ConcurrentBag[int]]::new()
    $sharedBag = [System.Collections.Concurrent.ConcurrentBag[int]]::new()
    $skippedBag = [System.Collections.Concurrent.ConcurrentBag[int]]::new()
    $processedCounter = [System.Threading.Interlocked]::Exchange([ref]$null, 0)
    
    # Capture throttle limit for use in parallel with fallback default (v7.9)
    $albumArtThrottle = if ($CONFIG.AlbumArtFactor) { $CONFIG.AlbumArtFactor } else { 10 }
    
    # Process grouped albums first (in parallel)
    if ($albumGroups.Count -gt 0) {
        $albumGroups.GetEnumerator() | ForEach-Object -ThrottleLimit $albumArtThrottle -Parallel {
            # Import required variables into parallel scope
            $CONFIG = $using:CONFIG
            $Global:FFmpegPath = $using:Global:FFmpegPath
            $extractedBag = $using:extractedBag
            $sharedBag = $using:sharedBag
            $skippedBag = $using:skippedBag
            $totalToProcess = $using:totalToProcess
            
            # Load the Extract-AlbumArtwork function in parallel scope
            function Extract-AlbumArtwork {
                param(
                    [string]$MusicFilePath,
                    [int]$MusicId,
                    [string]$AlbumKey = $null  # Optional album key for shared naming
                )
                
                if (-not $Global:FFmpegPath -or -not (Test-Path $Global:FFmpegPath)) {
                    return $null
                }
                
                if (-not (Test-Path $CONFIG.AlbumArtCacheFolder)) {
                    New-Item -ItemType Directory -Path $CONFIG.AlbumArtCacheFolder -Force | Out-Null
                }
                
                # FIXED: Use album-based naming if album key provided, otherwise use track ID
                # This prevents duplicate files for the same album
                if ($AlbumKey) {
                    # Create a hash of the album key for consistent filename
                    $albumHash = [System.BitConverter]::ToString(
                        [System.Security.Cryptography.MD5]::Create().ComputeHash(
                            [System.Text.Encoding]::UTF8.GetBytes($AlbumKey)
                        )
                    ).Replace("-", "").Substring(0, 12).ToLower()
                    $artFileName = "album_$albumHash.jpg"
                } else {
                    $artFileName = "albumart_$MusicId.jpg"
                }
                $artFilePath = Join-Path $CONFIG.AlbumArtCacheFolder $artFileName
                
                # If file already exists, just update the database reference and return
                if (Test-Path $artFilePath) {
                    try {
                        Import-Module PSSQLite -ErrorAction SilentlyContinue
                        Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
UPDATE music 
SET album_art_cached = @artFileName, has_embedded_art = 1
WHERE id = @musicId
"@ -SqlParameters @{ artFileName = $artFileName; musicId = $MusicId }
                    } catch { }
                    return $artFileName
                }
                
                try {
                    $process = Start-Process -FilePath $Global:FFmpegPath `
                        -ArgumentList @(
                            "-i", "`"$MusicFilePath`""
                            "-an"
                            "-vcodec", "copy"
                            "`"$artFilePath`""
                            "-y"
                        ) `
                        -NoNewWindow -Wait -PassThru `
                        -RedirectStandardError "$env:TEMP\ffmpeg_err_$MusicId.txt" `
                        -RedirectStandardOutput "$env:TEMP\ffmpeg_out_$MusicId.txt"
                    
                    if ($process.ExitCode -eq 0 -and (Test-Path $artFilePath)) {
                        try {
                            Add-Type -AssemblyName System.Drawing -ErrorAction SilentlyContinue
                            $img = [System.Drawing.Image]::FromFile($artFilePath)
                            $img.Dispose()
                            
                            Import-Module PSSQLite -ErrorAction SilentlyContinue
                            Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
UPDATE music 
SET album_art_cached = @artFileName, has_embedded_art = 1
WHERE id = @musicId
"@ -SqlParameters @{ artFileName = $artFileName; musicId = $MusicId }
                            
                            return $artFileName
                        }
                        catch {
                            Remove-Item $artFilePath -Force -ErrorAction SilentlyContinue
                            return $null
                        }
                    }
                    return $null
                }
                catch {
                    return $null
                }
                finally {
                    Remove-Item "$env:TEMP\ffmpeg_err_$MusicId.txt" -Force -ErrorAction SilentlyContinue
                    Remove-Item "$env:TEMP\ffmpeg_out_$MusicId.txt" -Force -ErrorAction SilentlyContinue
                }
            }
            
            # Process this album
            $albumKey = $_.Key
            $albumTracks = $_.Value
            $firstTrack = $albumTracks[0]
            
            $albumName = if ($firstTrack.album) { $firstTrack.album } else { "Unknown Album" }
            $artistName = if ($firstTrack.PSObject.Properties.Name -contains 'album_artist' -and $firstTrack.album_artist) { 
                $firstTrack.album_artist 
            } elseif ($firstTrack.artist) { 
                $firstTrack.artist 
            } else { 
                "Unknown Artist" 
            }
            
            $currentCount = [System.Threading.Interlocked]::Increment([ref]$using:processedCounter)
            Write-Host "[$currentCount/$totalToProcess] $artistName - $albumName ($($albumTracks.Count) tracks)" -ForegroundColor Gray
            
            if (Test-Path -LiteralPath $firstTrack.filepath) {
                # Pass album key to use album-based naming (prevents duplicate files)
                $artFileName = Extract-AlbumArtwork -MusicFilePath $firstTrack.filepath -MusicId $firstTrack.id -AlbumKey $albumKey
                
                if ($artFileName) {
                    $extractedBag.Add(1)
                    Write-Host "  ✓ Extracted artwork" -ForegroundColor Green
                    
                    if ($albumTracks.Count -gt 1) {
                        foreach ($track in $albumTracks[1..($albumTracks.Count - 1)]) {
                            try {
                                Import-Module PSSQLite -ErrorAction SilentlyContinue
                                Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
UPDATE music 
SET album_art_cached = @artFileName, has_embedded_art = 1
WHERE id = @musicId
"@ -SqlParameters @{ artFileName = $artFileName; musicId = $track.id }
                                $sharedBag.Add(1)
                            }
                            catch {
                                Write-Host "  ! Failed to share artwork for track ID $($track.id)" -ForegroundColor Yellow
                            }
                        }
                        Write-Host "  ✓ Shared with $($albumTracks.Count - 1) other tracks" -ForegroundColor Cyan
                    }
                }
                else {
                    $skippedBag.Add(1)
                    Write-Host "  ✗ No embedded artwork found" -ForegroundColor Yellow
                }
            }
            else {
                $skippedBag.Add(1)
                Write-Host "  ✗ File not found: $($firstTrack.filepath)" -ForegroundColor Red
            }
        }
    }
    
    # Process ungrouped files (in parallel)
    if ($ungroupedFiles.Count -gt 0) {
        $ungroupedFiles | ForEach-Object -ThrottleLimit $albumArtThrottle -Parallel {
            $CONFIG = $using:CONFIG
            $Global:FFmpegPath = $using:Global:FFmpegPath
            $extractedBag = $using:extractedBag
            $skippedBag = $using:skippedBag
            $totalToProcess = $using:totalToProcess
            
            function Extract-AlbumArtwork {
                param(
                    [string]$MusicFilePath,
                    [int]$MusicId
                )
                
                if (-not $Global:FFmpegPath -or -not (Test-Path $Global:FFmpegPath)) {
                    return $null
                }
                
                if (-not (Test-Path $CONFIG.AlbumArtCacheFolder)) {
                    New-Item -ItemType Directory -Path $CONFIG.AlbumArtCacheFolder -Force | Out-Null
                }
                
                $artFileName = "albumart_$MusicId.jpg"
                $artFilePath = Join-Path $CONFIG.AlbumArtCacheFolder $artFileName
                
                if (Test-Path $artFilePath) {
                    return $artFileName
                }
                
                try {
                    $process = Start-Process -FilePath $Global:FFmpegPath `
                        -ArgumentList @(
                            "-i", "`"$MusicFilePath`""
                            "-an"
                            "-vcodec", "copy"
                            "`"$artFilePath`""
                            "-y"
                        ) `
                        -NoNewWindow -Wait -PassThru `
                        -RedirectStandardError "$env:TEMP\ffmpeg_err_$MusicId.txt" `
                        -RedirectStandardOutput "$env:TEMP\ffmpeg_out_$MusicId.txt"
                    
                    if ($process.ExitCode -eq 0 -and (Test-Path $artFilePath)) {
                        try {
                            Add-Type -AssemblyName System.Drawing -ErrorAction SilentlyContinue
                            $img = [System.Drawing.Image]::FromFile($artFilePath)
                            $img.Dispose()
                            
                            Import-Module PSSQLite -ErrorAction SilentlyContinue
                            Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
UPDATE music 
SET album_art_cached = @artFileName, has_embedded_art = 1
WHERE id = @musicId
"@ -SqlParameters @{ artFileName = $artFileName; musicId = $MusicId }
                            
                            return $artFileName
                        }
                        catch {
                            Remove-Item $artFilePath -Force -ErrorAction SilentlyContinue
                            return $null
                        }
                    }
                    return $null
                }
                catch {
                    return $null
                }
                finally {
                    Remove-Item "$env:TEMP\ffmpeg_err_$MusicId.txt" -Force -ErrorAction SilentlyContinue
                    Remove-Item "$env:TEMP\ffmpeg_out_$MusicId.txt" -Force -ErrorAction SilentlyContinue
                }
            }
            
            $music = $_
            $currentCount = [System.Threading.Interlocked]::Increment([ref]$using:processedCounter)
            
            Write-Host "[$currentCount/$totalToProcess] $($music.filename) (no metadata)" -ForegroundColor Gray
            
            if (Test-Path -LiteralPath $music.filepath) {
                $artFileName = Extract-AlbumArtwork -MusicFilePath $music.filepath -MusicId $music.id
                
                if ($artFileName) {
                    $extractedBag.Add(1)
                    Write-Host "  ✓ Extracted artwork" -ForegroundColor Green
                }
                else {
                    $skippedBag.Add(1)
                    Write-Host "  ✗ No embedded artwork found" -ForegroundColor Yellow
                }
            }
            else {
                $skippedBag.Add(1)
                Write-Host "  ✗ File not found: $($music.filepath)" -ForegroundColor Red
            }
        }
    }
    
    # Calculate final counts from concurrent bags
    $totalExtracted = $extractedBag.Count
    $totalShared = $sharedBag.Count
    $totalSkipped = $skippedBag.Count
    
    Write-Host "`n[✓] Album artwork extraction complete!" -ForegroundColor Green
    Write-Host "  Albums processed: $($albumGroups.Count)" -ForegroundColor Cyan
    Write-Host "  Individual files processed: $($ungroupedFiles.Count)" -ForegroundColor Cyan
    Write-Host "  Artwork extracted: $totalExtracted" -ForegroundColor Cyan
    Write-Host "  Artwork shared across tracks: $totalShared" -ForegroundColor Cyan
    Write-Host "  Files with no artwork: $totalSkipped" -ForegroundColor Yellow
    Write-Host "  Total files processed: $($musicFiles.Count)" -ForegroundColor Cyan
    
    $savedExtractions = $totalShared
    if ($savedExtractions -gt 0) {
        Write-Host "`n  💾 Saved $savedExtractions duplicate extractions!" -ForegroundColor Green
    }
}


function Analyze-MP4File {
    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath
    )
    
    $result = @{
        moov_position = 'unknown'
        stream_order = 'unknown'
        needs_optimization = 0
        mp4_compliant = 1           # 1 = compliant, 0 = non-compliant (problematic structure)
        moov_size = 0               # Size of moov atom in bytes
        video_codec = $null
        audio_codec = $null
        file_size = 0
        error = $null
    }
    
    # Check if file exists and is MP4
    if (-not (Test-Path -LiteralPath $FilePath)) {
        $result.error = "File not found"
        return $result
    }
    
    $extension = [System.IO.Path]::GetExtension($FilePath).ToLower()
    if ($extension -notin @('.mp4', '.m4v', '.mov', '.m4a')) {
        # Not an MP4-family file, skip analysis
        $result.moov_position = 'n/a'
        $result.stream_order = 'n/a'
        return $result
    }
    
    # Get file size for reference
    try {
        $fileInfo = Get-Item -LiteralPath $FilePath
        $result.file_size = $fileInfo.Length
    }
    catch {
        # Continue even if we can't get file size
    }
    
    # Get FFprobe path - try multiple sources
    $ffprobePath = $null
    
    # Option 1: From Global FFmpegCapabilities
    if ($Global:FFmpegCapabilities -and $Global:FFmpegCapabilities.FFprobePath) {
        $ffprobePath = $Global:FFmpegCapabilities.FFprobePath
    }
    
    # Option 2: From Global FFprobePath
    if (-not $ffprobePath -and $Global:FFprobePath) {
        $ffprobePath = $Global:FFprobePath
    }
    
    # Option 3: From CONFIG.ToolsFolder
    if (-not $ffprobePath -and $Global:CONFIG -and $Global:CONFIG.ToolsFolder) {
        $possibleProbe = Join-Path $Global:CONFIG.ToolsFolder "ffmpeg\bin\ffprobe.exe"
        if (Test-Path $possibleProbe) {
            $ffprobePath = $possibleProbe
        }
    }
    
    # Option 4: From CONFIG.ScriptRoot\tools
    if (-not $ffprobePath -and $Global:CONFIG -and $Global:CONFIG.ScriptRoot) {
        $possibleProbe = Join-Path $Global:CONFIG.ScriptRoot "tools\ffmpeg\bin\ffprobe.exe"
        if (Test-Path $possibleProbe) {
            $ffprobePath = $possibleProbe
        }
    }
    
    # Option 5: From CONFIG.FFmpegPath (derive ffprobe from ffmpeg location)
    if (-not $ffprobePath -and $Global:CONFIG -and $Global:CONFIG.FFmpegPath) {
        $ffmpegDir = [System.IO.Path]::GetDirectoryName($Global:CONFIG.FFmpegPath)
        $possibleProbe = Join-Path $ffmpegDir "ffprobe.exe"
        if (Test-Path $possibleProbe) {
            $ffprobePath = $possibleProbe
        }
    }
    
    # Option 6: From Global FFmpegPath
    if (-not $ffprobePath -and $Global:FFmpegPath) {
        $ffmpegDir = [System.IO.Path]::GetDirectoryName($Global:FFmpegPath)
        $possibleProbe = Join-Path $ffmpegDir "ffprobe.exe"
        if (Test-Path $possibleProbe) {
            $ffprobePath = $possibleProbe
        }
    }
    
    # Option 7: Check system PATH
    if (-not $ffprobePath) {
        $ffprobeCmd = Get-Command ffprobe -ErrorAction SilentlyContinue
        if ($ffprobeCmd) {
            $ffprobePath = $ffprobeCmd.Source
        }
    }
    
    if (-not $ffprobePath -or -not (Test-Path $ffprobePath)) {
        $result.error = "FFprobe not available"
        return $result
    }
    
    try {
        # ═══════════════════════════════════════════════════════════════════════════
        # RELIABLE METHOD: Use FFprobe to detect faststart via format probing
        # 
        # Key insight: FFprobe can tell us if the moov atom is at the start by checking
        # the "probe_score" and whether it can read format info without seeking to end.
        # 
        # Method: Check first packet position - if moov is at start, first packet pos is small
        # For non-faststart files, ffprobe must seek to end first, causing delays/issues
        # ═══════════════════════════════════════════════════════════════════════════
        
        # Step 1: Get basic stream and format info
        $ffprobeArgs = @(
            "-v", "quiet",
            "-print_format", "json",
            "-show_format",
            "-show_streams",
            "`"$FilePath`""
        )
        
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = $ffprobePath
        $processInfo.Arguments = $ffprobeArgs -join " "
        $processInfo.UseShellExecute = $false
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.CreateNoWindow = $true
        
        $process = [System.Diagnostics.Process]::Start($processInfo)
        $stdout = $process.StandardOutput.ReadToEnd()
        $process.WaitForExit(30000)  # 30 second timeout
        
        if ($process.ExitCode -eq 0 -and $stdout) {
            $probeData = $stdout | ConvertFrom-Json
            
            # Analyze stream order and get codec info
            if ($probeData.streams -and $probeData.streams.Count -gt 0) {
                $firstStream = $probeData.streams[0]
                
                if ($firstStream.codec_type -eq 'video') {
                    $result.stream_order = 'video_first'
                }
                elseif ($firstStream.codec_type -eq 'audio') {
                    $result.stream_order = 'audio_first'
                }
                
                # Get codec info
                foreach ($stream in $probeData.streams) {
                    if ($stream.codec_type -eq 'video' -and -not $result.video_codec) {
                        $result.video_codec = $stream.codec_name
                    }
                    elseif ($stream.codec_type -eq 'audio' -and -not $result.audio_codec) {
                        $result.audio_codec = $stream.codec_name
                    }
                }
            }
        }
        
   
        $packetArgs = @(
            "-v", "error",
            "-select_streams", "v:0",
            "-show_entries", "packet=pos",
            "-read_intervals", "%+#1",  # Read only first packet
            "-of", "csv=p=0",
            "`"$FilePath`""
        )
        
        $processInfo2 = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo2.FileName = $ffprobePath
        $processInfo2.Arguments = $packetArgs -join " "
        $processInfo2.UseShellExecute = $false
        $processInfo2.RedirectStandardOutput = $true
        $processInfo2.RedirectStandardError = $true
        $processInfo2.CreateNoWindow = $true
        
        $process2 = [System.Diagnostics.Process]::Start($processInfo2)
        $packetOutput = $process2.StandardOutput.ReadToEnd().Trim()
        $process2.WaitForExit(10000)
        
        $firstPacketPos = -1
        if ($process2.ExitCode -eq 0 -and $packetOutput -match '^\d+$') {
            $firstPacketPos = [int64]$packetOutput
        }
        
        # Step 3: Alternative method - check format start_time
        # Fast-start files typically report start_time very close to 0
        # Non-fast-start files may show delays or different values
        $startTimeArgs = @(
            "-v", "error",
            "-select_streams", "v:0",
            "-show_entries", "format=start_time",
            "-of", "default=noprint_wrappers=1:nokey=1",
            "`"$FilePath`""
        )
        
        $processInfo3 = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo3.FileName = $ffprobePath
        $processInfo3.Arguments = $startTimeArgs -join " "
        $processInfo3.UseShellExecute = $false
        $processInfo3.RedirectStandardOutput = $true
        $processInfo3.RedirectStandardError = $true
        $processInfo3.CreateNoWindow = $true
        
        $process3 = [System.Diagnostics.Process]::Start($processInfo3)
        $process3.WaitForExit(10000)
        
      
        $moovBeforeMdat = $null  # null = unknown, $true = faststart, $false = needs optimization
        
        $fileStream = $null
        $reader = $null
        try {
            $fileStream = [System.IO.File]::OpenRead($FilePath)
            $reader = New-Object System.IO.BinaryReader($fileStream)
            $fileSize = $fileStream.Length
            
            $currentPosition = [int64]0
            $boxesChecked = 0
            $maxBoxes = 50  # Safety limit - most files have moov/mdat in first few boxes
            
            while ($currentPosition -lt $fileSize -and $boxesChecked -lt $maxBoxes) {
                # Check if we can read box header (8 bytes minimum)
                if (($fileSize - $currentPosition) -lt 8) {
                    break
                }
                
                $fileStream.Position = $currentPosition
                
                # Read box size (4 bytes, big-endian)
                $sizeBytes = $reader.ReadBytes(4)
                [Array]::Reverse($sizeBytes)
                $boxSize = [uint64][BitConverter]::ToUInt32($sizeBytes, 0)
                
                # Read box type (4 bytes ASCII)
                $typeBytes = $reader.ReadBytes(4)
                $boxType = [System.Text.Encoding]::ASCII.GetString($typeBytes)
                
                # Handle extended size (if boxSize == 1, next 8 bytes are 64-bit size)
                if ($boxSize -eq 1) {
                    $extSizeBytes = $reader.ReadBytes(8)
                    [Array]::Reverse($extSizeBytes)
                    $boxSize = [BitConverter]::ToUInt64($extSizeBytes, 0)
                }
                elseif ($boxSize -eq 0) {
                    # Box extends to end of file
                    $boxSize = [uint64]($fileSize - $currentPosition)
                }
                
                # Check for moov and mdat - FIRST ONE FOUND DETERMINES RESULT
                if ($boxType -eq 'moov') {
                    # moov found first - file IS optimized (faststart)
                    $moovBeforeMdat = $true
                    $result.moov_size = $boxSize
                    
                    # Check for problematic moov - if moov size is tiny relative to file size,
                    # it's likely a fragmented MP4 or has an unusual structure
                    # A proper moov should be at least 0.1% of file size for most videos
                    $moovPercentage = if ($fileSize -gt 0) { ($boxSize / $fileSize) * 100 } else { 0 }
                    if ($boxSize -lt 1024 -or $moovPercentage -lt 0.05) {
                        # moov is suspiciously small - likely fragmented/DASH or problematic structure
                        $result.mp4_compliant = 0
                        Write-NexusMLog "Suspicious moov size for $FilePath : $boxSize bytes ($($moovPercentage.ToString('F3'))% of file) - marking as non-compliant" -Level "WARNING"
                    }
                    break
                }
                elseif ($boxType -eq 'mdat') {
                    # mdat found first - file is NOT optimized (needs faststart)
                    $moovBeforeMdat = $false
                    break
                }
                
                # Skip to next box
                if ($boxSize -lt 8) {
                    # Invalid box, stop
                    break
                }
                
                $currentPosition += $boxSize
                $boxesChecked++
            }
        }
        catch {
            # Box parsing failed, will fall back to packet position method
            Write-NexusMLog "Box parsing failed for $FilePath, using packet position fallback: $_" -Level "DEBUG"
        }
        finally {
            if ($reader) { try { $reader.Close() } catch {} }
            if ($fileStream) { try { $fileStream.Close() } catch {} }
        }
        
        # Step 5: Determine final result using all available data
        if ($moovBeforeMdat -eq $true) {
            # Definitive: moov comes before mdat
            $result.moov_position = 'start'
            $result.needs_optimization = 0
        }
        elseif ($moovBeforeMdat -eq $false) {
            # Definitive: mdat comes before moov
            $result.moov_position = 'end'
            $result.needs_optimization = 1
        }
        elseif ($firstPacketPos -ge 0) {
            # Fallback: Use first packet position heuristic
            # For faststart files, first video packet is typically within first few MB
            # For non-faststart files, seeking is required, position may be anomalous
            # Threshold: if first packet is within first 5MB of file, consider it faststart
            if ($firstPacketPos -lt 5242880) {  # 5MB
                $result.moov_position = 'start'
                $result.needs_optimization = 0
            }
            else {
                $result.moov_position = 'end'
                $result.needs_optimization = 1
            }
        }
        else {
            # Last resort: Assume files need checking - mark as needing optimization
            # This is safe because the fix operation is lossless and fast
            $result.moov_position = 'unknown'
            $result.needs_optimization = 1
            Write-NexusMLog "Could not determine moov position for $FilePath - marking for review" -Level "WARNING"
        }
    }
    catch {
        $result.error = $_.Exception.Message
        Write-NexusMLog "Error analyzing MP4 file $FilePath : $_" -Level "WARNING"
    }
    
    return $result
}

function Test-MP4NeedsRemux {

    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath
    )
    
    # Quick extension check before full analysis
    if (-not (Test-Path -LiteralPath $FilePath)) {
        return $false
    }
    
    $ext = [System.IO.Path]::GetExtension($FilePath).ToLower()
    if ($ext -notin @('.mp4', '.m4a', '.m4v', '.mov')) {
        return $false
    }
    
    # Perform full analysis
    $analysis = Analyze-MP4File -FilePath $FilePath
    
    # Return true if needs optimization
    return ($analysis.needs_optimization -eq 1)
}

function Fix-MP4FastStart {

    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath,
        [int]$VideoId = 0
    )
    
    $result = @{
        success = $false
        message = ""
        new_filepath = $null
    }
    
    # Validate file exists
    if (-not (Test-Path -LiteralPath $FilePath)) {
        $result.message = "File not found: $FilePath"
        return $result
    }
    
    # Get FFmpeg path
    $ffmpegPath = $null
    if ($Global:FFmpegCapabilities -and $Global:FFmpegCapabilities.FFmpegPath) {
        $ffmpegPath = $Global:FFmpegCapabilities.FFmpegPath
    }
    elseif ($Global:FFmpegPath) {
        $ffmpegPath = $Global:FFmpegPath
    }
    
    if (-not $ffmpegPath -or -not (Test-Path $ffmpegPath)) {
        $result.message = "FFmpeg not available"
        return $result
    }
    
    try {
        $directory = [System.IO.Path]::GetDirectoryName($FilePath)
        $filename = [System.IO.Path]::GetFileNameWithoutExtension($FilePath)
        $extension = [System.IO.Path]::GetExtension($FilePath)
        
        # Create temp output file
        $tempFile = Join-Path $directory "$filename.faststart.temp$extension"
        
        # FFmpeg command to remux with faststart (no re-encoding)
        $ffmpegArgs = @(
            "-hide_banner"
            "-loglevel", "warning"
            "-i", "`"$FilePath`""
            "-c", "copy"
            "-movflags", "+faststart"
            "-y"
            "`"$tempFile`""
        )
        
        Write-NexusMLog "Fixing MP4 faststart: $FilePath"
        
        $processInfo = New-Object System.Diagnostics.ProcessStartInfo
        $processInfo.FileName = $ffmpegPath
        $processInfo.Arguments = $ffmpegArgs -join " "
        $processInfo.UseShellExecute = $false
        $processInfo.RedirectStandardOutput = $true
        $processInfo.RedirectStandardError = $true
        $processInfo.CreateNoWindow = $true
        
        $process = [System.Diagnostics.Process]::Start($processInfo)
        $stderr = $process.StandardError.ReadToEnd()
        $process.WaitForExit(600000)  # 10 minute timeout
        
        if ($process.ExitCode -ne 0) {
            # Clean up temp file if it exists
            if (Test-Path $tempFile) { Remove-Item $tempFile -Force -ErrorAction SilentlyContinue }
            $result.message = "FFmpeg failed: $stderr"
            return $result
        }
        
        # Verify temp file was created and has reasonable size
        if (-not (Test-Path $tempFile)) {
            $result.message = "Output file was not created"
            return $result
        }
        
        $originalSize = (Get-Item -LiteralPath $FilePath).Length
        $newSize = (Get-Item -LiteralPath $tempFile).Length
        
        # New file should be roughly the same size (within 5%)
        $sizeDiff = [Math]::Abs($newSize - $originalSize) / $originalSize
        if ($sizeDiff -gt 0.05) {
            Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
            $result.message = "Output file size differs significantly - possible corruption"
            return $result
        }
        
        # Replace original with optimized version
        # First, delete the original
        Remove-Item -LiteralPath $FilePath -Force
        
        # Rename temp to original
        Rename-Item -LiteralPath $tempFile -NewName ([System.IO.Path]::GetFileName($FilePath))
        
        # Update database if VideoId provided
        if ($VideoId -gt 0 -and $CONFIG.MusicVideosDB) {
            $updateQuery = "UPDATE musicvideos SET moov_position = 'start', needs_optimization = 0, size_bytes = @size WHERE id = @id"
            Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query $updateQuery -SqlParameters @{
                size = $newSize
                id = $VideoId
            }
        }
        
        $result.success = $true
        $result.message = "Successfully optimized MP4 file"
        $result.new_filepath = $FilePath
        
        Write-NexusMLog "MP4 faststart fix complete: $FilePath (saved $('{0:N2}' -f ($sizeDiff * 100))% size diff)"
    }
    catch {
        $result.message = "Error: $($_.Exception.Message)"
        Write-NexusMLog "Error fixing MP4 $FilePath : $_" -Level "ERROR"
    }
    
    return $result
}


function Generate-MusicVideoThumbnail {

    param(
        [string]$VideoFilePath,
        [int]$VideoId,
        [string]$ThumbsFolder
    )
    
    # Check if ffmpeg is available
    if (-not $Global:FFmpegPath -or -not (Test-Path $Global:FFmpegPath)) {
        return $null
    }
    
    # Create thumbnails folder if it doesn't exist
    if (-not (Test-Path $ThumbsFolder)) {
        New-Item -ItemType Directory -Path $ThumbsFolder -Force | Out-Null
    }
    
    # Generate thumbnail filename
    $thumbFileName = "mvthumb_$VideoId.jpg"
    $thumbFilePath = Join-Path $ThumbsFolder $thumbFileName
    
    # Skip if thumbnail already exists
    if (Test-Path $thumbFilePath) {
        return $thumbFileName
    }
    
    try {
        # First, get video duration to extract frame from middle
        $durationArgs = @(
            "-i", "`"$VideoFilePath`"",
            "-hide_banner"
        )
        
        $durationResult = & $Global:FFmpegPath $durationArgs 2>&1 | Out-String
        
        # Parse duration from ffmpeg output (format: Duration: HH:MM:SS.ms)
        $seekTime = "00:00:05"  # Default to 5 seconds if we can't determine duration
        if ($durationResult -match 'Duration:\s*(\d+):(\d+):(\d+)') {
            $hours = [int]$matches[1]
            $minutes = [int]$matches[2]
            $seconds = [int]$matches[3]
            $totalSeconds = ($hours * 3600) + ($minutes * 60) + $seconds
            
            # Seek to 30% of the video (usually past intro/logo)
            $seekSeconds = [math]::Floor($totalSeconds * 0.30)
            $seekTime = "{0:D2}:{1:D2}:{2:D2}" -f [math]::Floor($seekSeconds / 3600), [math]::Floor(($seekSeconds % 3600) / 60), ($seekSeconds % 60)
        }
        
        # Extract thumbnail frame using ffmpeg
        $process = Start-Process -FilePath $Global:FFmpegPath `
            -ArgumentList @(
                "-ss", $seekTime,
                "-i", "`"$VideoFilePath`"",
                "-vframes", "1",
                "-vf", "scale=640:-1",
                "-q:v", "3",
                "`"$thumbFilePath`"",
                "-y"
            ) `
            -NoNewWindow -Wait -PassThru `
            -RedirectStandardError "$env:TEMP\ffmpeg_mvthumb_err_$VideoId.txt" `
            -RedirectStandardOutput "$env:TEMP\ffmpeg_mvthumb_out_$VideoId.txt"
        
        if ($process.ExitCode -eq 0 -and (Test-Path $thumbFilePath)) {
            # Verify it's a valid image
            try {
                Add-Type -AssemblyName System.Drawing -ErrorAction SilentlyContinue
                $img = [System.Drawing.Image]::FromFile($thumbFilePath)
                $img.Dispose()
                return $thumbFileName
            }
            catch {
                Remove-Item $thumbFilePath -Force -ErrorAction SilentlyContinue
                return $null
            }
        }
        return $null
    }
    catch {
        Write-Verbose "Failed to generate thumbnail: $_"
        return $null
    }
    finally {
        # Clean up temp files
        Remove-Item "$env:TEMP\ffmpeg_mvthumb_err_$VideoId.txt" -Force -ErrorAction SilentlyContinue
        Remove-Item "$env:TEMP\ffmpeg_mvthumb_out_$VideoId.txt" -Force -ErrorAction SilentlyContinue
    }
}

function Generate-AllMusicVideoThumbnails {

    param(
        [switch]$Force
    )
    
    Write-Host "`n=== Generating Music Video Thumbnails ===" -ForegroundColor Cyan
    
    # Check if Music Videos feature is enabled
    if (-not $CONFIG.MusicVideosEnabled) {
        Write-Host "[!] Music Videos feature is not enabled in NexusM.conf" -ForegroundColor Yellow
        return @{ success = $false; error = "Music Videos feature not enabled" }
    }
    
    # Check if ffmpeg is available
    if (-not $Global:FFmpegPath) {
        Write-Host "[!] ffmpeg is not available. Thumbnail generation requires ffmpeg." -ForegroundColor Yellow
        return @{ success = $false; error = "ffmpeg not available" }
    }
    
    # Create thumbnails folder
    if (-not (Test-Path $CONFIG.MusicVideoThumbsFolder)) {
        New-Item -ItemType Directory -Path $CONFIG.MusicVideoThumbsFolder -Force | Out-Null
        Write-Host "[✓] Created thumbnails folder: $($CONFIG.MusicVideoThumbsFolder)" -ForegroundColor Green
    }
    
    # Get music videos that need thumbnails
    $whereClause = if ($Force) { "" } else { "WHERE thumbnail_path IS NULL OR thumbnail_path = ''" }
    
    try {
        $musicVideos = Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query @"
SELECT id, filepath, filename, title, artist 
FROM musicvideos 
$whereClause
ORDER BY title
"@
    }
    catch {
        Write-Host "[✗] Error querying database: $_" -ForegroundColor Red
        return @{ success = $false; error = "Database error: $_" }
    }
    
    if (-not $musicVideos -or $musicVideos.Count -eq 0) {
        Write-Host "[✓] All music videos already have thumbnails (or none in database)" -ForegroundColor Green
        return @{ success = $true; processed = 0; generated = 0; skipped = 0 }
    }
    
    Write-Host "Found $($musicVideos.Count) music videos to process..." -ForegroundColor Cyan
    
    $generated = 0
    $skipped = 0
    $errors = 0
    $count = 0
    
    foreach ($video in $musicVideos) {
        $count++
        $displayTitle = if ($video.artist -and $video.title) { "$($video.artist) - $($video.title)" } 
                        elseif ($video.title) { $video.title } 
                        else { $video.filename }
        
        Write-Host "[$count/$($musicVideos.Count)] $displayTitle" -ForegroundColor Gray
        
        if (-not (Test-Path -LiteralPath $video.filepath)) {
            Write-Host "  ✗ File not found: $($video.filepath)" -ForegroundColor Red
            $skipped++
            continue
        }
        
        $thumbFileName = Generate-MusicVideoThumbnail `
            -VideoFilePath $video.filepath `
            -VideoId $video.id `
            -ThumbsFolder $CONFIG.MusicVideoThumbsFolder
        
        if ($thumbFileName) {
            # Update database with thumbnail path
            try {
                Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query @"
UPDATE musicvideos 
SET thumbnail_path = @thumbPath
WHERE id = @id
"@ -SqlParameters @{ thumbPath = $thumbFileName; id = $video.id }
                
                $generated++
                Write-Host "  ✓ Generated thumbnail" -ForegroundColor Green
            }
            catch {
                Write-Host "  ✗ Failed to update database: $_" -ForegroundColor Red
                $errors++
            }
        }
        else {
            Write-Host "  ✗ Failed to generate thumbnail" -ForegroundColor Yellow
            $skipped++
        }
    }
    
    Write-Host "`n[✓] Music video thumbnail generation complete!" -ForegroundColor Green
    Write-Host "  Processed: $count" -ForegroundColor Cyan
    Write-Host "  Generated: $generated" -ForegroundColor Cyan
    Write-Host "  Skipped: $skipped" -ForegroundColor Yellow
    if ($errors -gt 0) {
        Write-Host "  Errors: $errors" -ForegroundColor Red
    }
    
    return @{ 
        success = $true
        processed = $count
        generated = $generated
        skipped = $skipped
        errors = $errors
    }
}


function Generate-PictureThumbnail {

    param(
        [string]$ImageFilePath,
        [int]$ImageId,
        [string]$ThumbsFolder,
        [int]$MaxWidth = 400,
        [int]$MaxHeight = 300
    )
    
    # Create thumbnails folder if it doesn't exist
    if (-not (Test-Path $ThumbsFolder)) {
        New-Item -ItemType Directory -Path $ThumbsFolder -Force | Out-Null
    }
    
    # Generate thumbnail filename
    $thumbFileName = "picthumb_$ImageId.jpg"
    $thumbFilePath = Join-Path $ThumbsFolder $thumbFileName
    
    # Skip if thumbnail already exists
    if (Test-Path $thumbFilePath) {
        return $thumbFileName
    }
    
    # Skip very large files (>50MB) to prevent memory issues
    $fileSize = (Get-Item -LiteralPath $ImageFilePath -ErrorAction SilentlyContinue).Length
    if ($fileSize -gt (50 * 1024 * 1024)) {
        Write-Verbose "Skipping large file: $ImageFilePath"
        return $null
    }
    
    $originalImage = $null
    $thumbnail = $null
    $graphics = $null
    $fileStream = $null
    
    try {
        Add-Type -AssemblyName System.Drawing -ErrorAction SilentlyContinue
        
        # Use FileStream to load image (more memory efficient)
        $fileStream = [System.IO.File]::OpenRead($ImageFilePath)
        $originalImage = [System.Drawing.Image]::FromStream($fileStream, $false, $false)
        
        # Calculate new dimensions maintaining aspect ratio
        $ratioX = $MaxWidth / $originalImage.Width
        $ratioY = $MaxHeight / $originalImage.Height
        $ratio = [Math]::Min($ratioX, $ratioY)
        
        # Don't upscale - if image is smaller, use original size
        if ($ratio -gt 1) { $ratio = 1 }
        
        $newWidth = [int]($originalImage.Width * $ratio)
        $newHeight = [int]($originalImage.Height * $ratio)
        
        # Minimum size check
        if ($newWidth -lt 1) { $newWidth = 1 }
        if ($newHeight -lt 1) { $newHeight = 1 }
        
        # Create thumbnail
        $thumbnail = New-Object System.Drawing.Bitmap($newWidth, $newHeight)
        $graphics = [System.Drawing.Graphics]::FromImage($thumbnail)
        
        # High quality settings
        $graphics.InterpolationMode = [System.Drawing.Drawing2D.InterpolationMode]::HighQualityBicubic
        $graphics.SmoothingMode = [System.Drawing.Drawing2D.SmoothingMode]::HighQuality
        $graphics.PixelOffsetMode = [System.Drawing.Drawing2D.PixelOffsetMode]::HighQuality
        $graphics.CompositingQuality = [System.Drawing.Drawing2D.CompositingQuality]::HighQuality
        
        # Draw resized image
        $graphics.DrawImage($originalImage, 0, 0, $newWidth, $newHeight)
        
        # Save as JPEG with good quality
        $jpegEncoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object { $_.MimeType -eq 'image/jpeg' }
        $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
        $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, 85L)
        
        $thumbnail.Save($thumbFilePath, $jpegEncoder, $encoderParams)
        
        return $thumbFileName
    }
    catch {
        Write-Verbose "Failed to generate picture thumbnail: $_"
        # Clean up failed thumbnail file
        if (Test-Path $thumbFilePath) {
            Remove-Item $thumbFilePath -Force -ErrorAction SilentlyContinue
        }
        return $null
    }
    finally {
        # Always dispose resources
        if ($graphics) { $graphics.Dispose() }
        if ($thumbnail) { $thumbnail.Dispose() }
        if ($originalImage) { $originalImage.Dispose() }
        if ($fileStream) { $fileStream.Close(); $fileStream.Dispose() }
    }
}

function Generate-AllPictureThumbnails {
    param(
        [switch]$Force
    )
    
    Write-Host "`n=== Generating Picture Thumbnails ===" -ForegroundColor Cyan
    
    # Create thumbnails folder
    if (-not (Test-Path $CONFIG.PictureThumbsFolder)) {
        New-Item -ItemType Directory -Path $CONFIG.PictureThumbsFolder -Force | Out-Null
        Write-Host "[✓] Created thumbnails folder: $($CONFIG.PictureThumbsFolder)" -ForegroundColor Green
    }
    
    # Get pictures that need thumbnails, ordered by size (smallest first for better memory handling)
    $whereClause = if ($Force) { "" } else { "WHERE thumbnail_path IS NULL OR thumbnail_path = ''" }
    $query = "SELECT id, filepath, filename, size_bytes FROM images $whereClause ORDER BY size_bytes ASC"
    $pictures = @(Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $query)
    
    if ($pictures.Count -eq 0) {
        Write-Host "[i] No pictures need thumbnail generation" -ForegroundColor Yellow
        return @{ success = $true; processed = 0; generated = 0; skipped = 0; errors = 0 }
    }
    
    Write-Host "[i] Found $($pictures.Count) pictures to process" -ForegroundColor Cyan
    
    $count = 0
    $generated = 0
    $skipped = 0
    $errors = 0
    
    foreach ($picture in $pictures) {
        $count++
        Write-Host "[$count/$($pictures.Count)] Processing: $($picture.filename)" -ForegroundColor Gray
        
        # Check if source file exists
        if (-not (Test-Path $picture.filepath)) {
            Write-Host "  ✗ Source file not found" -ForegroundColor Yellow
            $skipped++
            continue
        }
        
        # Generate thumbnail
        $thumbFileName = Generate-PictureThumbnail `
            -ImageFilePath $picture.filepath `
            -ImageId $picture.id `
            -ThumbsFolder $CONFIG.PictureThumbsFolder
        
        if ($thumbFileName) {
            # Update database
            try {
                $updateQuery = "UPDATE images SET thumbnail_path = @thumb WHERE id = @id"
                Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $updateQuery -SqlParameters @{
                    thumb = $thumbFileName
                    id = $picture.id
                }
                Write-Host "  ✓ Generated: $thumbFileName" -ForegroundColor Green
                $generated++
            }
            catch {
                Write-Host "  ✗ Failed to update database: $_" -ForegroundColor Red
                $errors++
            }
        }
        else {
            Write-Host "  ✗ Failed to generate thumbnail (file may be too large or corrupt)" -ForegroundColor Yellow
            $skipped++
        }
        
        # Force garbage collection every 10 images to free memory
        if ($count % 10 -eq 0) {
            [System.GC]::Collect()
            [System.GC]::WaitForPendingFinalizers()
        }
    }
    
    # Final garbage collection
    [System.GC]::Collect()
    
    Write-Host "`n[✓] Picture thumbnail generation complete!" -ForegroundColor Green
    Write-Host "  Processed: $count" -ForegroundColor Cyan
    Write-Host "  Generated: $generated" -ForegroundColor Cyan
    Write-Host "  Skipped: $skipped" -ForegroundColor Yellow
    if ($errors -gt 0) {
        Write-Host "  Errors: $errors" -ForegroundColor Red
    }
    
    return @{ 
        success = $true
        processed = $count
        generated = $generated
        skipped = $skipped
        errors = $errors
    }
}

function Get-PaginationHtml {

    param(
        [int]$CurrentPage = 1,
        [int]$TotalPages = 1,
        [int]$TotalItems = 0,
        [string]$BaseUrl = "",
        [int]$ItemsPerPage = 100
    )
    
    if ($TotalPages -le 1) {
        return ""
    }
    
    # Calculate item range for display
    $startItem = (($CurrentPage - 1) * $ItemsPerPage) + 1
    $endItem = [math]::Min($CurrentPage * $ItemsPerPage, $TotalItems)
    
    # Determine separator for URL
    $separator = if ($BaseUrl -match '\?') { '&' } else { '?' }
    
    # Build page numbers HTML
    $pageNumbersHtml = ""
    
    # Determine which page numbers to show (max 7 with ellipsis)
    $pagesToShow = @()
    
    if ($TotalPages -le 7) {
        # Show all pages if 7 or fewer
        $pagesToShow = 1..$TotalPages
    }
    else {
        # Always show first page
        $pagesToShow += 1
        
        if ($CurrentPage -gt 4) {
            $pagesToShow += "..."
        }
        
        # Pages around current page
        $startRange = [math]::Max(2, $CurrentPage - 1)
        $endRange = [math]::Min($TotalPages - 1, $CurrentPage + 1)
        
        # Adjust range if at edges
        if ($CurrentPage -le 4) {
            $startRange = 2
            $endRange = [math]::Min(5, $TotalPages - 1)
        }
        elseif ($CurrentPage -ge $TotalPages - 3) {
            $startRange = [math]::Max(2, $TotalPages - 4)
            $endRange = $TotalPages - 1
        }
        
        for ($i = $startRange; $i -le $endRange; $i++) {
            $pagesToShow += $i
        }
        
        if ($CurrentPage -lt $TotalPages - 3) {
            $pagesToShow += "..."
        }
        
        # Always show last page
        $pagesToShow += $TotalPages
    }
    
    # Generate page number buttons
    foreach ($pg in $pagesToShow) {
        if ($pg -eq "...") {
            $pageNumbersHtml += @"
      <span class="pagination-ellipsis">...</span>
"@
        }
        else {
            $isActive = if ($pg -eq $CurrentPage) { "active" } else { "" }
            $pageNumbersHtml += @"
      <a href="${BaseUrl}${separator}page=$pg" class="pagination-page $isActive">$pg</a>
"@
        }
    }
    
    # Previous/Next button states
    $prevDisabled = if ($CurrentPage -le 1) { "disabled" } else { "" }
    $nextDisabled = if ($CurrentPage -ge $TotalPages) { "disabled" } else { "" }
    $prevHref = if ($CurrentPage -gt 1) { "${BaseUrl}${separator}page=$($CurrentPage - 1)" } else { "#" }
    $nextHref = if ($CurrentPage -lt $TotalPages) { "${BaseUrl}${separator}page=$($CurrentPage + 1)" } else { "#" }
    
    $paginationHtml = @"
<div class="pagination-container">
  <div class="pagination-info">
    Showing $startItem-$endItem of $TotalItems items
  </div>
  <div class="pagination-controls">
    <a href="$prevHref" class="pagination-btn $prevDisabled">← Previous</a>
    <div class="pagination-pages">
$pageNumbersHtml
    </div>
    <a href="$nextHref" class="pagination-btn $nextDisabled">Next →</a>
  </div>
</div>

<style>
.pagination-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    margin-top: 24px;
    padding: 20px;
}
.pagination-info {
    font-size: 13px;
    color: var(--muted);
}
.pagination-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}
.pagination-btn {
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--text);
    text-decoration: none;
    font-size: 13px;
    transition: all 0.2s ease;
}
.pagination-btn:hover:not(.disabled) {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.2);
}
.pagination-btn.disabled {
    opacity: 0.4;
    pointer-events: none;
    cursor: not-allowed;
}
.pagination-pages {
    display: flex;
    align-items: center;
    gap: 4px;
}
.pagination-page {
    min-width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--text);
    text-decoration: none;
    font-size: 13px;
    font-weight: 500;
    transition: all 0.2s ease;
}
.pagination-page:hover:not(.active) {
    background: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.2);
}
.pagination-page.active {
    background: linear-gradient(135deg, var(--accent), #22c55e);
    border-color: transparent;
    color: white;
    font-weight: 600;
}
.pagination-ellipsis {
    padding: 0 8px;
    color: var(--muted);
    font-size: 14px;
}
@media (max-width: 600px) {
    .pagination-controls {
        flex-wrap: wrap;
        justify-content: center;
    }
    .pagination-pages {
        order: -1;
        width: 100%;
        justify-content: center;
        margin-bottom: 8px;
    }
}
</style>
"@
    
    return $paginationHtml
}

# ============================================================================
# EPUB COVER EXTRACTION
# ============================================================================

function Generate-EPUBCoverThumbnail {
    param(
        [string]$EPUBFilePath,
        [int]$EPUBId
    )
    
    # Create ebook cover cache folder (unified folder for PDF and EPUB)
    $coverCacheFolder = if ($CONFIG.EbookCoverCacheFolder) { $CONFIG.EbookCoverCacheFolder } else { $CONFIG.EPUBCoverCacheFolder }
    if (-not (Test-Path $coverCacheFolder)) {
        New-Item -ItemType Directory -Path $coverCacheFolder -Force | Out-Null
    }
    
    # Generate cache filename
    $coverFileName = "epub_cover_$EPUBId.jpg"
    $coverFilePath = Join-Path $coverCacheFolder $coverFileName
    
    # Check if already generated
    if (Test-Path $coverFilePath) {
        Write-Verbose "  → EPUB cover already exists: $coverFileName"
        return $coverFileName
    }
    
    try {
        # EPUB files are ZIP archives - extract cover image
        $tempDir = Join-Path $env:TEMP "epub_extract_$(Get-Random)"
        New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
        
        try {
            Add-Type -AssemblyName System.IO.Compression.FileSystem
            [System.IO.Compression.ZipFile]::ExtractToDirectory($EPUBFilePath, $tempDir)
            
            $coverFound = $false
            $sourceImagePath = $null
            
            # METHOD 1: Parse container.xml to find OPF, then parse OPF to find cover
            $containerPath = Join-Path $tempDir "META-INF\container.xml"
            if (Test-Path $containerPath) {
                try {
                    [xml]$containerXml = Get-Content $containerPath -Raw
                    $opfPath = $containerXml.container.rootfiles.rootfile.'full-path'
                    if ($opfPath) {
                        $fullOpfPath = Join-Path $tempDir $opfPath
                        $opfDir = [System.IO.Path]::GetDirectoryName($fullOpfPath)
                        
                        if (Test-Path $fullOpfPath) {
                            [xml]$opfXml = Get-Content $fullOpfPath -Raw
                            
                            # Find cover in manifest by id or properties
                            $coverItem = $opfXml.package.manifest.item | Where-Object { 
                                $_.id -match 'cover' -or 
                                $_.properties -match 'cover-image' -or
                                $_.href -match 'cover'
                            } | Select-Object -First 1
                            
                            if ($coverItem -and $coverItem.href) {
                                $coverHref = $coverItem.href
                                # Handle relative paths
                                $potentialCover = Join-Path $opfDir $coverHref
                                if (Test-Path $potentialCover) {
                                    $sourceImagePath = $potentialCover
                                    $coverFound = $true
                                    Write-Verbose "  ✓ Cover found via OPF manifest: $coverHref"
                                }
                            }
                            
                            # Also check metadata for cover reference
                            if (-not $coverFound) {
                                $coverMeta = $opfXml.package.metadata.meta | Where-Object { $_.name -eq 'cover' }
                                if ($coverMeta) {
                                    $coverId = $coverMeta.content
                                    $coverManifestItem = $opfXml.package.manifest.item | Where-Object { $_.id -eq $coverId }
                                    if ($coverManifestItem -and $coverManifestItem.href) {
                                        $potentialCover = Join-Path $opfDir $coverManifestItem.href
                                        if (Test-Path $potentialCover) {
                                            $sourceImagePath = $potentialCover
                                            $coverFound = $true
                                            Write-Verbose "  ✓ Cover found via OPF metadata: $($coverManifestItem.href)"
                                        }
                                    }
                                }
                            }
                        }
                    }
                } catch {
                    Write-Verbose "  [!] Error parsing OPF: $_"
                }
            }
            
            # METHOD 2: Try common cover image locations
            if (-not $coverFound) {
                $coverPatterns = @(
                    "cover.jpg", "cover.jpeg", "cover.png", "cover.gif",
                    "Cover.jpg", "Cover.jpeg", "Cover.png", "Cover.gif",
                    "COVER.jpg", "COVER.jpeg", "COVER.png",
                    "OEBPS/cover.jpg", "OEBPS/cover.jpeg", "OEBPS/cover.png",
                    "OEBPS/Cover.jpg", "OEBPS/Cover.jpeg", "OEBPS/Cover.png",
                    "OEBPS/images/cover.jpg", "OEBPS/images/cover.jpeg", "OEBPS/images/cover.png",
                    "OEBPS/Images/cover.jpg", "OEBPS/Images/cover.jpeg", "OEBPS/Images/cover.png",
                    "OEBPS/image/cover.jpg", "OEBPS/image/cover.jpeg", "OEBPS/image/cover.png",
                    "EPUB/cover.jpg", "EPUB/cover.jpeg", "EPUB/cover.png",
                    "Images/cover.jpg", "Images/cover.jpeg", "Images/cover.png",
                    "images/cover.jpg", "images/cover.jpeg", "images/cover.png",
                    "image/cover.jpg", "image/cover.jpeg", "image/cover.png",
                    "OPS/cover.jpg", "OPS/cover.jpeg", "OPS/cover.png",
                    "OPS/images/cover.jpg", "OPS/images/cover.jpeg", "OPS/images/cover.png"
                )
                
                foreach ($pattern in $coverPatterns) {
                    $coverPath = Join-Path $tempDir $pattern
                    if (Test-Path $coverPath) {
                        $sourceImagePath = $coverPath
                        $coverFound = $true
                        Write-Verbose "  ✓ Cover found: $pattern"
                        break
                    }
                }
            }
            
            # METHOD 3: Search for any file with "cover" in the name
            if (-not $coverFound) {
                $coverFiles = Get-ChildItem -Path $tempDir -Recurse -Include "*cover*" -File | 
                    Where-Object { $_.Extension -match '\.(jpg|jpeg|png|gif)$' -and $_.Length -gt 5KB } |
                    Sort-Object -Property Length -Descending |
                    Select-Object -First 1
                
                if ($coverFiles) {
                    $sourceImagePath = $coverFiles.FullName
                    $coverFound = $true
                    Write-Verbose "  ✓ Cover found via name search: $($coverFiles.Name)"
                }
            }
            
            # METHOD 4: Find the largest image file (likely the cover)
            if (-not $coverFound) {
                $imageFiles = Get-ChildItem -Path $tempDir -Recurse -Include "*.jpg", "*.jpeg", "*.png" -File | 
                    Where-Object { $_.Length -gt 10KB } |
                    Sort-Object -Property Length -Descending |
                    Select-Object -First 1
                
                if ($imageFiles) {
                    $sourceImagePath = $imageFiles.FullName
                    $coverFound = $true
                    Write-Verbose "  ✓ Cover found via size search: $($imageFiles.Name)"
                }
            }
            
            # Copy the found cover image
            if ($coverFound -and $sourceImagePath) {
                # Check if we need to convert to JPG
                $sourceExt = [System.IO.Path]::GetExtension($sourceImagePath).ToLower()
                if ($sourceExt -eq '.png' -or $sourceExt -eq '.gif') {
                    try {
                        Add-Type -AssemblyName System.Drawing
                        $img = [System.Drawing.Image]::FromFile($sourceImagePath)
                        $jpegEncoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object { $_.MimeType -eq 'image/jpeg' }
                        $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
                        $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, 90L)
                        $img.Save($coverFilePath, $jpegEncoder, $encoderParams)
                        $img.Dispose()
                    } catch {
                        # Fallback: just copy the file
                        Copy-Item -Path $sourceImagePath -Destination $coverFilePath -Force
                    }
                } else {
                    Copy-Item -Path $sourceImagePath -Destination $coverFilePath -Force
                }
                
                # Update database
                Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @coverFileName
WHERE id = @epubId
"@ -SqlParameters @{ coverFileName = $coverFileName; epubId = $EPUBId }
                
                Write-Verbose "  ✓ Extracted EPUB cover successfully"
                return $coverFileName
            }
            else {
                Write-Verbose "  ✗ No cover image found in EPUB"
                return $null
            }
        }
        finally {
            # Clean up temp directory
            if (Test-Path $tempDir) {
                Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
            }
        }
    }
    catch {
        Write-Verbose "  ✗ Error extracting EPUB cover: $_"
        return $null
    }
}

# ============================================================================
# PDF THUMBNAIL GENERATION
# ============================================================================

function Generate-PDFThumbnail {
    param(
        [string]$PDFFilePath,
        [int]$PDFId
    )
    
    # Create PDF preview cache folder
    if (-not (Test-Path $CONFIG.PDFPreviewCacheFolder)) {
        New-Item -ItemType Directory -Path $CONFIG.PDFPreviewCacheFolder -Force | Out-Null
    }
    
    # Generate cache filename
    $previewFileName = "pdf_preview_$PDFId.jpg"
    $previewFilePath = Join-Path $CONFIG.PDFPreviewCacheFolder $previewFileName
    
    # Check if already generated
    if (Test-Path $previewFilePath) {
        return $previewFileName
    }
    
    # METHOD 1: Try using Windows.Data.Pdf (Windows 10+ native)
    try {
        # Load Windows Runtime assemblies
        [Windows.Data.Pdf.PdfDocument,Windows.Data.Pdf,ContentType=WindowsRuntime] | Out-Null
        [Windows.Storage.StorageFile,Windows.Storage,ContentType=WindowsRuntime] | Out-Null
        [Windows.Storage.Streams.RandomAccessStreamReference,Windows.Storage.Streams,ContentType=WindowsRuntime] | Out-Null
        
        # Open the PDF
        $pdfFile = [System.IO.FileInfo]::new($PDFFilePath)
        $storageFile = [Windows.Storage.StorageFile]::GetFileFromPathAsync($pdfFile.FullName).GetAwaiter().GetResult()
        $pdfDocument = [Windows.Data.Pdf.PdfDocument]::LoadFromFileAsync($storageFile).GetAwaiter().GetResult()
        
        if ($pdfDocument.PageCount -gt 0) {
            # Get first page
            $pdfPage = $pdfDocument.GetPage(0)
            
            # Create a temporary file for the rendered page
            
            # Render to PNG first
            Add-Type -AssemblyName System.Drawing
            
            # Calculate dimensions (maintain aspect ratio, max 400x600)
            $maxWidth = 400
            $maxHeight = 600
            $pageWidth = $pdfPage.Size.Width
            $pageHeight = $pdfPage.Size.Height
            
            $scale = [Math]::Min($maxWidth / $pageWidth, $maxHeight / $pageHeight)
            $renderWidth = [int]($pageWidth * $scale)
            $renderHeight = [int]($pageHeight * $scale)
            
            # Create render options
            $renderOptions = [Windows.Data.Pdf.PdfPageRenderOptions]::new()
            $renderOptions.DestinationWidth = $renderWidth
            $renderOptions.DestinationHeight = $renderHeight
            
            # Create a temp file to render to
            $storageFolder = [Windows.Storage.ApplicationData]::Current.TemporaryFolder
            $outputFile = $storageFolder.CreateFileAsync("pdf_render_$PDFId.png", [Windows.Storage.CreationCollisionOption]::ReplaceExisting).GetAwaiter().GetResult()
            
            # Render the page
            $stream = $outputFile.OpenAsync([Windows.Storage.FileAccessMode]::ReadWrite).GetAwaiter().GetResult()
            $pdfPage.RenderToStreamAsync($stream, $renderOptions).GetAwaiter().GetResult()
            $stream.Dispose()
            
            # Copy the rendered file to our cache location as JPEG
            $renderedPath = $outputFile.Path
            
            # Convert PNG to JPEG using .NET
            $img = [System.Drawing.Image]::FromFile($renderedPath)
            
            # Create JPEG encoder
            $jpegEncoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object { $_.MimeType -eq 'image/jpeg' }
            $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
            $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, 85)
            
            # Save as JPEG
            $img.Save($previewFilePath, $jpegEncoder, $encoderParams)
            $img.Dispose()
            
            # Cleanup temp file
            Remove-Item $renderedPath -Force -ErrorAction SilentlyContinue
            
            # Cleanup PDF objects
            $pdfPage.Dispose()
            $pdfDocument.Dispose()
            
            # Update database
            Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @previewFileName
WHERE id = @pdfId
"@ -SqlParameters @{ previewFileName = $previewFileName; pdfId = $PDFId }
            
            Write-Verbose "  ✓ Generated PDF thumbnail using Windows native renderer"
            return $previewFileName
        }
    }
    catch {
        Write-Verbose "Windows PDF rendering failed: $_"
        # Fall through to other methods
    }
    
    # METHOD 2: Try using COM/Shell.Application (Windows Explorer thumbnails)
    try {
        Add-Type -AssemblyName System.Drawing
        
        # Use Windows Shell to get the thumbnail that Explorer would show
        $shell = New-Object -ComObject Shell.Application
        $folder = $shell.NameSpace([System.IO.Path]::GetDirectoryName($PDFFilePath))
        $file = $folder.ParseName([System.IO.Path]::GetFileName($PDFFilePath))
        
        # Get thumbnail (this uses the same system Windows Explorer uses)
        $thumbnail = $file.GetThumbnail(400, 1) # 400px width, format = bitmap
        
        if ($thumbnail) {
            # Save the thumbnail
            $thumbnail.Save($previewFilePath, [System.Drawing.Imaging.ImageFormat]::Jpeg)
            $thumbnail.Dispose()
            
            # Update database
            Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @previewFileName
WHERE id = @pdfId
"@ -SqlParameters @{ previewFileName = $previewFileName; pdfId = $PDFId }
            
            Write-Verbose "  ✓ Generated PDF thumbnail using Windows Shell"
            return $previewFileName
        }
    }
    catch {
        Write-Verbose "Windows Shell thumbnail failed: $_"
        # Fall through to other methods
    }
    
    # METHOD 1: Try using Ghostscript directly (BEST - standalone, no dependencies)
    $gsPath = Get-Command gs -ErrorAction SilentlyContinue
    if (-not $gsPath) {
        $gsPath = Get-Command gswin64c -ErrorAction SilentlyContinue
    }
    if (-not $gsPath) {
        $gsPath = Get-Command gswin32c -ErrorAction SilentlyContinue
    }
    
    if ($gsPath) {
        try {
            $arguments = @(
                "-dNOPAUSE"
                "-dBATCH"
                "-dSAFER"
                "-sDEVICE=jpeg"
                "-r150"
                "-dJPEGQ=85"
                "-dFirstPage=1"
                "-dLastPage=1"
                "-dTextAlphaBits=4"
                "-dGraphicsAlphaBits=4"
                "-sOutputFile=`"$previewFilePath`""
                "`"$PDFFilePath`""
            )
            
            $process = Start-Process -FilePath $gsPath.Source `
                -ArgumentList $arguments `
                -NoNewWindow -Wait -PassThru `
                -RedirectStandardError "$env:TEMP\gs_err_$PDFId.txt"
            
            if ($process.ExitCode -eq 0 -and (Test-Path $previewFilePath)) {
                Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @previewFileName
WHERE id = @pdfId
"@ -SqlParameters @{ previewFileName = $previewFileName; pdfId = $PDFId }
                
                Remove-Item "$env:TEMP\gs_err_$PDFId.txt" -Force -ErrorAction SilentlyContinue
                Write-Verbose "  ✓ Generated PDF thumbnail using Ghostscript"
                return $previewFileName
            }
        }
        catch {
            Write-Verbose "Ghostscript conversion failed: $_"
        }
    }
    
    # If all methods fail, return null (will show placeholder)
    Write-Verbose "  ✗ Could not generate eBooks thumbnail - Ghostscript conversion failed"
    return $null
}

function Generate-AllPDFThumbnails {
    param(
        [switch]$Force
    )
    
    Write-Host "`n=== Generating eBook Thumbnails ===" -ForegroundColor Cyan
    
    if ($Force) {
        Write-Host "[!] Force mode enabled - will re-generate all thumbnails" -ForegroundColor Yellow
    }
    
    # Check for rendering tools
    $windowsNative = $PSVersionTable.PSVersion.Major -ge 5 -and [Environment]::OSVersion.Version.Major -ge 10
    $gsAvailable = (Get-Command gs -ErrorAction SilentlyContinue) -or (Get-Command gswin64c -ErrorAction SilentlyContinue) -or (Get-Command gswin32c -ErrorAction SilentlyContinue)
    
    Write-Host "`nDetected eBook rendering capabilities:" -ForegroundColor Cyan
    
    if ($gsAvailable) {
        Write-Host "[✓] Ghostscript available (best option)" -ForegroundColor Green
    }
    
    if ($windowsNative) {
        Write-Host "[✓] Windows 10+ native eBook rendering (fallback option)" -ForegroundColor Green
    }
    else {
        Write-Host "[!] Windows native eBook rendering not available (requires Windows 10+)" -ForegroundColor Yellow
    }
    
    if (-not $windowsNative -and -not $gsAvailable) {
        Write-Host "`n[!] No eBook rendering capability detected." -ForegroundColor Yellow
        Write-Host "    For best results, install Ghostscript:" -ForegroundColor Gray
        Write-Host "    • winget install Ghostscript.Ghostscript" -ForegroundColor Gray
        Write-Host "    • Or download from: https://www.ghostscript.com/releases/gsdnld.html" -ForegroundColor Gray
        Write-Host "`n    eBooks will display with placeholder icons instead." -ForegroundColor Gray
        return
    }
    
    # Get all PDFs - if Force, get all files; otherwise only get files without previews
    $whereClause = if ($Force) { "" } else { "WHERE preview_image IS NULL OR preview_image = ''" }
    
    $pdfsNeedingPreviews = Invoke-SqliteQuery -DataSource $CONFIG.PDFDB `
        -Query "SELECT * FROM pdfs $whereClause"
    
    if ($pdfsNeedingPreviews.Count -eq 0) {
        Write-Host "`n[i] All eBooks already have thumbnails!" -ForegroundColor Cyan
        return
    }
    
    Write-Host "`nGenerating thumbnails for $($pdfsNeedingPreviews.Count) eBook(s)..." -ForegroundColor Cyan
    Write-Host "Using parallel processing ($($CONFIG.PDFScanFactor) concurrent generations)..." -ForegroundColor Green
    
    # Use thread-safe concurrent collections for counters
    $generatedBag = [System.Collections.Concurrent.ConcurrentBag[int]]::new()
    $failedBag = [System.Collections.Concurrent.ConcurrentBag[int]]::new()
    $processedCounter = [System.Threading.Interlocked]::Exchange([ref]$null, 0)
    
    # Capture throttle limit for parallel with fallback default (v7.9)
    $pdfThrottle = if ($CONFIG.PDFScanFactor) { $CONFIG.PDFScanFactor } else { 10 }
    
    # Process PDFs in parallel
    $pdfsNeedingPreviews | ForEach-Object -ThrottleLimit $pdfThrottle -Parallel {
        # Import required variables into parallel scope
        $CONFIG = $using:CONFIG
        $generatedBag = $using:generatedBag
        $failedBag = $using:failedBag
        $totalToProcess = $using:pdfsNeedingPreviews.Count
        
        # Load the Generate-EPUBCoverThumbnail function in parallel scope
        function Generate-EPUBCoverThumbnail {
            param(
                [string]$EPUBFilePath,
                [int]$EPUBId
            )
            
            # Create ebook cover cache folder (unified folder for PDF and EPUB)
            $coverCacheFolder = if ($CONFIG.EbookCoverCacheFolder) { $CONFIG.EbookCoverCacheFolder } else { $CONFIG.EPUBCoverCacheFolder }
            if (-not (Test-Path $coverCacheFolder)) {
                New-Item -ItemType Directory -Path $coverCacheFolder -Force | Out-Null
            }
            
            # Generate cache filename
            $coverFileName = "epub_cover_$EPUBId.jpg"
            $coverFilePath = Join-Path $coverCacheFolder $coverFileName
            
            # Check if already generated
            if (Test-Path $coverFilePath) {
                return $coverFileName
            }
            
            try {
                # EPUB files are ZIP archives - extract cover image
                $tempDir = Join-Path $env:TEMP "epub_extract_$(Get-Random)"
                New-Item -ItemType Directory -Path $tempDir -Force | Out-Null
                
                try {
                    Add-Type -AssemblyName System.IO.Compression.FileSystem
                    [System.IO.Compression.ZipFile]::ExtractToDirectory($EPUBFilePath, $tempDir)
                    
                    $coverFound = $false
                    $sourceImagePath = $null
                    
                    # METHOD 1: Parse container.xml to find OPF, then parse OPF to find cover
                    $containerPath = Join-Path $tempDir "META-INF\container.xml"
                    if (Test-Path $containerPath) {
                        try {
                            [xml]$containerXml = Get-Content $containerPath -Raw
                            $opfPath = $containerXml.container.rootfiles.rootfile.'full-path'
                            if ($opfPath) {
                                $fullOpfPath = Join-Path $tempDir $opfPath
                                $opfDir = [System.IO.Path]::GetDirectoryName($fullOpfPath)
                                
                                if (Test-Path $fullOpfPath) {
                                    [xml]$opfXml = Get-Content $fullOpfPath -Raw
                                    
                                    # Find cover in manifest by id or properties
                                    $coverItem = $opfXml.package.manifest.item | Where-Object { 
                                        $_.id -match 'cover' -or 
                                        $_.properties -match 'cover-image' -or
                                        $_.href -match 'cover'
                                    } | Select-Object -First 1
                                    
                                    if ($coverItem -and $coverItem.href) {
                                        $coverHref = $coverItem.href
                                        $potentialCover = Join-Path $opfDir $coverHref
                                        if (Test-Path $potentialCover) {
                                            $sourceImagePath = $potentialCover
                                            $coverFound = $true
                                        }
                                    }
                                    
                                    # Also check metadata for cover reference
                                    if (-not $coverFound) {
                                        $coverMeta = $opfXml.package.metadata.meta | Where-Object { $_.name -eq 'cover' }
                                        if ($coverMeta) {
                                            $coverId = $coverMeta.content
                                            $coverManifestItem = $opfXml.package.manifest.item | Where-Object { $_.id -eq $coverId }
                                            if ($coverManifestItem -and $coverManifestItem.href) {
                                                $potentialCover = Join-Path $opfDir $coverManifestItem.href
                                                if (Test-Path $potentialCover) {
                                                    $sourceImagePath = $potentialCover
                                                    $coverFound = $true
                                                }
                                            }
                                        }
                                    }
                                }
                            }
                        } catch { }
                    }
                    
                    # METHOD 2: Try common cover image locations
                    if (-not $coverFound) {
                        $coverPatterns = @(
                            "cover.jpg", "cover.jpeg", "cover.png", "cover.gif",
                            "Cover.jpg", "Cover.jpeg", "Cover.png",
                            "OEBPS/cover.jpg", "OEBPS/cover.jpeg", "OEBPS/cover.png",
                            "OEBPS/Cover.jpg", "OEBPS/Cover.jpeg", "OEBPS/Cover.png",
                            "OEBPS/images/cover.jpg", "OEBPS/images/cover.jpeg", "OEBPS/images/cover.png",
                            "OEBPS/Images/cover.jpg", "OEBPS/Images/cover.jpeg", "OEBPS/Images/cover.png",
                            "Images/cover.jpg", "images/cover.jpg", "image/cover.jpg",
                            "OPS/cover.jpg", "OPS/images/cover.jpg"
                        )
                        
                        foreach ($pattern in $coverPatterns) {
                            $coverPath = Join-Path $tempDir $pattern
                            if (Test-Path $coverPath) {
                                $sourceImagePath = $coverPath
                                $coverFound = $true
                                break
                            }
                        }
                    }
                    
                    # METHOD 3: Search for any file with "cover" in the name
                    if (-not $coverFound) {
                        $coverFiles = Get-ChildItem -Path $tempDir -Recurse -Include "*cover*" -File | 
                            Where-Object { $_.Extension -match '\.(jpg|jpeg|png|gif)$' -and $_.Length -gt 5KB } |
                            Sort-Object -Property Length -Descending |
                            Select-Object -First 1
                        
                        if ($coverFiles) {
                            $sourceImagePath = $coverFiles.FullName
                            $coverFound = $true
                        }
                    }
                    
                    # METHOD 4: Find the largest image file (likely the cover)
                    if (-not $coverFound) {
                        $imageFiles = Get-ChildItem -Path $tempDir -Recurse -Include "*.jpg", "*.jpeg", "*.png" -File | 
                            Where-Object { $_.Length -gt 10KB } |
                            Sort-Object -Property Length -Descending |
                            Select-Object -First 1
                        
                        if ($imageFiles) {
                            $sourceImagePath = $imageFiles.FullName
                            $coverFound = $true
                        }
                    }
                    
                    # Copy the found cover image
                    if ($coverFound -and $sourceImagePath) {
                        $sourceExt = [System.IO.Path]::GetExtension($sourceImagePath).ToLower()
                        if ($sourceExt -eq '.png' -or $sourceExt -eq '.gif') {
                            try {
                                Add-Type -AssemblyName System.Drawing
                                $img = [System.Drawing.Image]::FromFile($sourceImagePath)
                                $jpegEncoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object { $_.MimeType -eq 'image/jpeg' }
                                $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
                                $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, 90L)
                                $img.Save($coverFilePath, $jpegEncoder, $encoderParams)
                                $img.Dispose()
                            } catch {
                                Copy-Item -Path $sourceImagePath -Destination $coverFilePath -Force
                            }
                        } else {
                            Copy-Item -Path $sourceImagePath -Destination $coverFilePath -Force
                        }
                        
                        # Update database
                        Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @coverFileName
WHERE id = @epubId
"@ -SqlParameters @{ coverFileName = $coverFileName; epubId = $EPUBId }
                        
                        return $coverFileName
                    }
                }
                finally {
                    if (Test-Path $tempDir) {
                        Remove-Item -Path $tempDir -Recurse -Force -ErrorAction SilentlyContinue
                    }
                }
            }
            catch {
            }
            
            return $null
        }
        
        # Load the Generate-PDFThumbnail function in parallel scope
        function Generate-PDFThumbnail {
            param(
                [string]$PDFFilePath,
                [int]$PDFId
            )
            
            # Create PDF preview cache folder
            if (-not (Test-Path $CONFIG.PDFPreviewCacheFolder)) {
                New-Item -ItemType Directory -Path $CONFIG.PDFPreviewCacheFolder -Force | Out-Null
            }
            
            # Generate cache filename
            $previewFileName = "pdf_preview_$PDFId.jpg"
            $previewFilePath = Join-Path $CONFIG.PDFPreviewCacheFolder $previewFileName
            
            # Check if already generated
            if (Test-Path $previewFilePath) {
                return $previewFileName
            }
            
            # METHOD 1: Try using Windows.Data.Pdf (Windows 10+ native)
            try {
                # Load Windows Runtime assemblies
                [Windows.Data.Pdf.PdfDocument,Windows.Data.Pdf,ContentType=WindowsRuntime] | Out-Null
                [Windows.Storage.StorageFile,Windows.Storage,ContentType=WindowsRuntime] | Out-Null
                [Windows.Storage.Streams.RandomAccessStreamReference,Windows.Storage.Streams,ContentType=WindowsRuntime] | Out-Null
                
                # Open the PDF
                $pdfFile = [System.IO.FileInfo]::new($PDFFilePath)
                $storageFile = [Windows.Storage.StorageFile]::GetFileFromPathAsync($pdfFile.FullName).GetAwaiter().GetResult()
                $pdfDocument = [Windows.Data.Pdf.PdfDocument]::LoadFromFileAsync($storageFile).GetAwaiter().GetResult()
                
                if ($pdfDocument.PageCount -gt 0) {
                    # Get first page
                    $pdfPage = $pdfDocument.GetPage(0)
                    
                    # Render to PNG first
                    Add-Type -AssemblyName System.Drawing
                    
                    # Calculate dimensions (maintain aspect ratio, max 400x600)
                    $maxWidth = 400
                    $maxHeight = 600
                    $pageWidth = $pdfPage.Size.Width
                    $pageHeight = $pdfPage.Size.Height
                    
                    $scale = [Math]::Min($maxWidth / $pageWidth, $maxHeight / $pageHeight)
                    $renderWidth = [int]($pageWidth * $scale)
                    $renderHeight = [int]($pageHeight * $scale)
                    
                    # Create render options
                    $renderOptions = [Windows.Data.Pdf.PdfPageRenderOptions]::new()
                    $renderOptions.DestinationWidth = $renderWidth
                    $renderOptions.DestinationHeight = $renderHeight
                    
                    # Create a temp file to render to
                    $storageFolder = [Windows.Storage.ApplicationData]::Current.TemporaryFolder
                    $outputFile = $storageFolder.CreateFileAsync("pdf_render_$PDFId.png", [Windows.Storage.CreationCollisionOption]::ReplaceExisting).GetAwaiter().GetResult()
                    
                    # Render the page
                    $stream = $outputFile.OpenAsync([Windows.Storage.FileAccessMode]::ReadWrite).GetAwaiter().GetResult()
                    $pdfPage.RenderToStreamAsync($stream, $renderOptions).GetAwaiter().GetResult()
                    $stream.Dispose()
                    
                    # Copy the rendered file to our cache location as JPEG
                    $renderedPath = $outputFile.Path
                    
                    # Convert PNG to JPEG using .NET
                    $img = [System.Drawing.Image]::FromFile($renderedPath)
                    
                    # Create JPEG encoder
                    $jpegEncoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object { $_.MimeType -eq 'image/jpeg' }
                    $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
                    $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, 85)
                    
                    # Save as JPEG
                    $img.Save($previewFilePath, $jpegEncoder, $encoderParams)
                    $img.Dispose()
                    
                    # Cleanup temp file
                    Remove-Item $renderedPath -Force -ErrorAction SilentlyContinue
                    
                    # Cleanup PDF objects
                    $pdfPage.Dispose()
                    $pdfDocument.Dispose()
                    
                    # Update database
                    Import-Module PSSQLite -ErrorAction SilentlyContinue
                    Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @previewFileName
WHERE id = @pdfId
"@ -SqlParameters @{ previewFileName = $previewFileName; pdfId = $PDFId }
                    
                    return $previewFileName
                }
            }
            catch {
                # Fall through to other methods
            }
            
            # METHOD 2: Try using COM/Shell.Application (Windows Explorer thumbnails)
            try {
                Add-Type -AssemblyName System.Drawing
                
                # Use Windows Shell to get the thumbnail that Explorer would show
                $shell = New-Object -ComObject Shell.Application
                $folder = $shell.NameSpace([System.IO.Path]::GetDirectoryName($PDFFilePath))
                $file = $folder.ParseName([System.IO.Path]::GetFileName($PDFFilePath))
                
                # Get thumbnail (this uses the same system Windows Explorer uses)
                $thumbnail = $file.GetThumbnail(400, 1) # 400px width, format = bitmap
                
                if ($thumbnail) {
                    # Save the thumbnail
                    $thumbnail.Save($previewFilePath, [System.Drawing.Imaging.ImageFormat]::Jpeg)
                    $thumbnail.Dispose()
                    
                    # Update database
                    Import-Module PSSQLite -ErrorAction SilentlyContinue
                    Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @previewFileName
WHERE id = @pdfId
"@ -SqlParameters @{ previewFileName = $previewFileName; pdfId = $PDFId }
                    
                    return $previewFileName
                }
            }
            catch {
                # Fall through to other methods
            }
            
            # METHOD 3: Try using Ghostscript directly (BEST - standalone, no dependencies)
            $gsPath = Get-Command gs -ErrorAction SilentlyContinue
            if (-not $gsPath) {
                $gsPath = Get-Command gswin64c -ErrorAction SilentlyContinue
            }
            if (-not $gsPath) {
                $gsPath = Get-Command gswin32c -ErrorAction SilentlyContinue
            }
            
            if ($gsPath) {
                try {
                    $arguments = @(
                        "-dNOPAUSE"
                        "-dBATCH"
                        "-dSAFER"
                        "-sDEVICE=jpeg"
                        "-r150"
                        "-dJPEGQ=85"
                        "-dFirstPage=1"
                        "-dLastPage=1"
                        "-dTextAlphaBits=4"
                        "-dGraphicsAlphaBits=4"
                        "-sOutputFile=`"$previewFilePath`""
                        "`"$PDFFilePath`""
                    )
                    
                    $process = Start-Process -FilePath $gsPath.Source `
                        -ArgumentList $arguments `
                        -NoNewWindow -Wait -PassThru `
                        -RedirectStandardError "$env:TEMP\gs_err_$PDFId.txt"
                    
                    if ($process.ExitCode -eq 0 -and (Test-Path $previewFilePath)) {
                        Import-Module PSSQLite -ErrorAction SilentlyContinue
                        Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
UPDATE pdfs 
SET preview_image = @previewFileName
WHERE id = @pdfId
"@ -SqlParameters @{ previewFileName = $previewFileName; pdfId = $PDFId }
                        
                        Remove-Item "$env:TEMP\gs_err_$PDFId.txt" -Force -ErrorAction SilentlyContinue
                        return $previewFileName
                    }
                }
                catch {
                    # Error in Ghostscript conversion
                }
            }
            
            # If all methods fail, return null (will show placeholder)
            return $null
        }
        
        # Process this document (PDF or EPUB)
        $pdf = $_
        $currentCount = [System.Threading.Interlocked]::Increment([ref]$using:processedCounter)
        
        Write-Host "[$currentCount/$totalToProcess] Processing: $($pdf.filename)" -ForegroundColor Gray
        
        if (Test-Path -LiteralPath $pdf.filepath) {
            # Check file extension to determine processing method
            $fileExt = [System.IO.Path]::GetExtension($pdf.filepath).ToLower()
            
            if ($fileExt -eq '.epub') {
                # Handle EPUB files - extract cover
                $previewFileName = Generate-EPUBCoverThumbnail -EPUBFilePath $pdf.filepath -EPUBId $pdf.id
            }
            else {
                # Handle PDF files - generate thumbnail
                $previewFileName = Generate-PDFThumbnail -PDFFilePath $pdf.filepath -PDFId $pdf.id
            }
            
            if ($previewFileName) {
                $generatedBag.Add(1)
                Write-Host "  ✓ Generated preview" -ForegroundColor Green
            }
            else {
                $failedBag.Add(1)
                Write-Host "  ✗ Failed to generate preview" -ForegroundColor Yellow
            }
        }
        else {
            $failedBag.Add(1)
            Write-Host "  ✗ File not found: $($pdf.filepath)" -ForegroundColor Red
        }
    }
    
    # Calculate final counts from concurrent bags
    $totalGenerated = $generatedBag.Count
    $totalFailed = $failedBag.Count
    
    Write-Host "`n[✓] eBook thumbnail generation complete!" -ForegroundColor Green
    Write-Host "  Generated: $totalGenerated" -ForegroundColor Cyan
    Write-Host "  Failed: $totalFailed" -ForegroundColor Yellow
    Write-Host "  Total processed: $($pdfsNeedingPreviews.Count)" -ForegroundColor Cyan
}

# ============================================================================
# SCAN AND INDEX FUNCTIONS
# ============================================================================

function Invoke-MediaScan {
    Write-Host "`n=== Starting Media Scan ===" -ForegroundColor Cyan
    Write-Host "[i] Media paths loaded from Settings > Media Shares (v1.7)" -ForegroundColor Gray
    $scanStart = Get-Date
    
    # Get paths from database (v1.7, updated v6.96 to use SharesDB)
    $moviesPaths = Get-AllMediaPaths -MediaType 'movies' -DatabasePath $CONFIG.SharesDB
    $musicPaths = Get-AllMediaPaths -MediaType 'music' -DatabasePath $CONFIG.SharesDB
    $picturesPaths = Get-AllMediaPaths -MediaType 'pictures' -DatabasePath $CONFIG.SharesDB
    $pdfPaths = Get-AllMediaPaths -MediaType 'pdfs' -DatabasePath $CONFIG.SharesDB
    
    # Scan Videos
    Write-Host "`n[1/4] Scanning videos..." -ForegroundColor Yellow
    $videoCount = 0
    $videoSize = 0
    
    foreach ($moviesPath in $moviesPaths) {
        if ([string]::IsNullOrWhiteSpace($moviesPath)) { continue }
        
        Write-Host "  → Scanning: $moviesPath" -ForegroundColor Gray
        
        # Ensure network share is connected (v1.6, updated v6.96)
        $null = Ensure-NetworkShareConnected -FilePath $moviesPath -DatabasePath $CONFIG.SharesDB
        
        if (-not (Test-Path $moviesPath)) {
            Write-Host "  [!] Path not accessible: $moviesPath" -ForegroundColor Yellow
            continue
        }
        
        $videoFiles = Get-MediaFiles -Path $moviesPath -Extensions $CONFIG.VideoExtensions
        
        foreach ($file in $videoFiles) {
            try {
                $metadata = Get-VideoMetadata -File $file
                
                # Check if already exists
                $exists = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
                    -Query "SELECT id FROM videos WHERE filepath = @path" `
                    -SqlParameters @{ path = $file.FullName }
                
                if (-not $exists) {
                    # Try to get detailed video info including audio tracks (only if FFmpeg is available)
                    $videoInfo = $null
                    if ($Global:FFmpegPath) {
                        try {
                            $videoInfo = Get-VideoInfo -FilePath $file.FullName
                        }
                        catch {
                            Write-Verbose "Could not extract detailed video info: $_"
                        }
                    }
                    
                    # Build the INSERT query dynamically based on available metadata
                    $fields = @('filename', 'filepath', 'title', 'size_bytes', 'format', 'last_modified', 'needs_metadata', 'is_low_quality')
                    $params = @{
                        filename = $metadata.filename
                        filepath = $metadata.filepath
                        title = $metadata.title
                        size_bytes = $metadata.size_bytes
                        format = $metadata.format
                        last_modified = $metadata.last_modified
                        needs_metadata = $metadata.needs_metadata
                        is_low_quality = $metadata.is_low_quality
                    }
                    
                    # Add optional fields if they exist
                    if ($metadata.year) {
                        $fields += 'year'
                        $params.year = $metadata.year
                    }
                    if ($metadata.resolution) {
                        $fields += 'resolution'
                        $params.resolution = $metadata.resolution
                    }
                    if ($metadata.height) {
                        $fields += 'height'
                        $params.height = $metadata.height
                    }
                    
                    # Add video info from FFprobe if available (v6.92 - adds duration for DVR seeking)
                    if ($videoInfo) {
                        # Duration - CRITICAL for HLS DVR-style seeking
                        if ($videoInfo.Duration -and $videoInfo.Duration -gt 0) {
                            $fields += 'duration'
                            $params.duration = [int]$videoInfo.Duration
                        }
                        
                        # Audio tracks
                        if ($videoInfo.AudioTracks) {
                            $fields += 'audio_tracks'
                            $params.audio_tracks = $videoInfo.AudioTracks
                        }
                        
                        # Video codec
                        if ($videoInfo.VideoCodec) {
                            $fields += 'codec'
                            $params.codec = $videoInfo.VideoCodec
                        }
                        
                        # Bitrate
                        if ($videoInfo.Bitrate -and $videoInfo.Bitrate -gt 0) {
                            $fields += 'bitrate'
                            $params.bitrate = $videoInfo.Bitrate
                        }
                        
                        # Width (if not already set from filename parsing)
                        if ($videoInfo.VideoWidth -and $videoInfo.VideoWidth -gt 0 -and -not $params.ContainsKey('width')) {
                            $fields += 'width'
                            $params.width = $videoInfo.VideoWidth
                        }
                        
                        # Height from FFprobe (more accurate than filename parsing)
                        if ($videoInfo.VideoHeight -and $videoInfo.VideoHeight -gt 0) {
                            if (-not $params.ContainsKey('height')) {
                                $fields += 'height'
                            }
                            $params.height = $videoInfo.VideoHeight
                        }
                    }
                    
                    $fieldList = $fields -join ', '
                    $paramList = ($fields | ForEach-Object { "@$_" }) -join ', '
                    
                    $query = "INSERT INTO videos ($fieldList) VALUES ($paramList)"
                    Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query $query -SqlParameters $params
                    $videoCount++
                }
                
                $videoSize += $file.Length
            }
            catch {
                Write-Host "[!] Error processing $($file.Name): $_" -ForegroundColor Red
            }
        }
    }
    
    if ($moviesPaths.Count -eq 0) {
        Write-Host "  [!] No movies path configured. Go to Settings > Media Shares to add one." -ForegroundColor Yellow
    }
    
    # Scan Music
    Write-Host "`n[2/4] Scanning music..." -ForegroundColor Yellow
    $musicCount = 0
    $musicSize = 0
    
    # Use thread-safe counters for parallel processing
    $addedCount = [System.Collections.Concurrent.ConcurrentBag[int]]::new()
    $totalSize = [System.Collections.Concurrent.ConcurrentBag[long]]::new()
    
    foreach ($musicPath in $musicPaths) {
        if ([string]::IsNullOrWhiteSpace($musicPath)) { continue }
        
        Write-Host "  → Scanning: $musicPath" -ForegroundColor Gray
        
        # Ensure network share is connected (v1.6, updated v6.96)
        $null = Ensure-NetworkShareConnected -FilePath $musicPath -DatabasePath $CONFIG.SharesDB
        
        if (-not (Test-Path $musicPath)) {
            Write-Host "  [!] Path not accessible: $musicPath" -ForegroundColor Yellow
            continue
        }
        
        $musicFiles = Get-MediaFiles -Path $musicPath -Extensions $CONFIG.AudioExtensions
        
        # Capture throttle limit with fallback default (v7.9)
        $musicThrottle = if ($CONFIG.MusicScanFactor) { $CONFIG.MusicScanFactor } else { 50 }
        
        $musicFiles | ForEach-Object -ThrottleLimit $musicThrottle -Parallel {
            $file = $_
            $CONFIG = $using:CONFIG
            $addedBag = $using:addedCount
            $sizeBag = $using:totalSize
        
        try {
            # Extract metadata inline (simplified version using Shell.Application)
            $metadata = @{
                filename = $file.Name
                filepath = $file.FullName
                title = $null
                size_bytes = $file.Length
                format = $file.Extension.TrimStart('.')
                last_modified = $file.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
                needs_metadata = 1
                artist = $null
                album = $null
                year = $null
                duration = $null
                bitrate = $null
            }
            
            try {
                $shell = New-Object -ComObject Shell.Application
                $folder = $shell.Namespace($file.DirectoryName)
                $item = $folder.ParseName($file.Name)
                
                if ($item) {
                    # Title (index 21)
                    $title = $folder.GetDetailsOf($item, 21)
                    if (-not [string]::IsNullOrWhiteSpace($title)) {
                        $metadata.title = $title
                        $metadata.needs_metadata = 0
                    } else {
                        $metadata.title = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                    }
                    
                    # Artist (index 13)
                    $artist = $folder.GetDetailsOf($item, 13)
                    if (-not [string]::IsNullOrWhiteSpace($artist)) {
                        $metadata.artist = $artist
                    }
                    
                    # Album (index 14)
                    $album = $folder.GetDetailsOf($item, 14)
                    if (-not [string]::IsNullOrWhiteSpace($album)) {
                        $metadata.album = $album
                    }
                    
                    # Year (index 15)
                    $year = $folder.GetDetailsOf($item, 15)
                    if ($year -match '(\d{4})') {
                        $metadata.year = [int]$matches[1]
                    }
                    
                    # Duration (index 27) - Format: "00:03:45" or "03:45"
                    $durationStr = $folder.GetDetailsOf($item, 27)
                    if (-not [string]::IsNullOrWhiteSpace($durationStr)) {
                        # Parse duration string to seconds
                        if ($durationStr -match '(\d+):(\d+):(\d+)') {
                            # Format: HH:MM:SS
                            $hours = [int]$matches[1]
                            $minutes = [int]$matches[2]
                            $seconds = [int]$matches[3]
                            $metadata.duration = ($hours * 3600) + ($minutes * 60) + $seconds
                        }
                        elseif ($durationStr -match '(\d+):(\d+)') {
                            # Format: MM:SS
                            $minutes = [int]$matches[1]
                            $seconds = [int]$matches[2]
                            $metadata.duration = ($minutes * 60) + $seconds
                        }
                    }
                    
                    # Bitrate (index 28) - Format: "320kbps" or "128 kbps"
                    $bitrateStr = $folder.GetDetailsOf($item, 28)
                    if (-not [string]::IsNullOrWhiteSpace($bitrateStr)) {
                        # Extract numeric value from string like "320kbps"
                        if ($bitrateStr -match '(\d+)') {
                            $metadata.bitrate = [int]$matches[1]
                        }
                    }
                }
                
                [System.Runtime.Interopservices.Marshal]::ReleaseComObject($shell) | Out-Null
            }
            catch {
                if (-not $metadata.title) {
                    $metadata.title = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                }
            }
            
            $exists = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB `
                -Query "SELECT id FROM music WHERE filepath = @path" `
                -SqlParameters @{ path = $file.FullName }
            
            if (-not $exists) {
                # Build the INSERT query dynamically
                $fields = @('filename', 'filepath', 'title', 'size_bytes', 'format', 'last_modified', 'needs_metadata')
                $params = @{
                    filename = $metadata.filename
                    filepath = $metadata.filepath
                    title = $metadata.title
                    size_bytes = $metadata.size_bytes
                    format = $metadata.format
                    last_modified = $metadata.last_modified
                    needs_metadata = $metadata.needs_metadata
                }
                
                # Add optional fields if they exist
                if ($metadata.artist) {
                    $fields += 'artist'
                    $params.artist = $metadata.artist
                }
                if ($metadata.album) {
                    $fields += 'album'
                    $params.album = $metadata.album
                }
                if ($metadata.year) {
                    $fields += 'year'
                    $params.year = $metadata.year
                }
                if ($metadata.duration) {
                    $fields += 'duration'
                    $params.duration = $metadata.duration
                }
                if ($metadata.bitrate) {
                    $fields += 'bitrate'
                    $params.bitrate = $metadata.bitrate
                }
                
                $fieldList = $fields -join ', '
                $paramList = ($fields | ForEach-Object { "@$_" }) -join ', '
                
                $query = "INSERT INTO music ($fieldList) VALUES ($paramList)"
                Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query $query -SqlParameters $params
                $addedBag.Add(1)
            }
            
            $sizeBag.Add($file.Length)
        }
        catch {
            Write-Host "[!] Error processing $($file.Name): $_" -ForegroundColor Red
        }
    }
    }  # End foreach musicPath
    
    if ($musicPaths.Count -eq 0) {
        Write-Host "  [!] No music path configured. Go to Settings > Media Shares to add one." -ForegroundColor Yellow
    }
    
    # Calculate totals from concurrent bags
    $musicCount = $addedCount.Count
    $musicSize = ($totalSize | Measure-Object -Sum).Sum
    
    # Scan Pictures
    Write-Host "`n[3/4] Scanning pictures..." -ForegroundColor Yellow
    $imageCount = 0
    $imageSize = 0
    
    foreach ($picturesPath in $picturesPaths) {
        if ([string]::IsNullOrWhiteSpace($picturesPath)) { continue }
        
        Write-Host "  → Scanning: $picturesPath" -ForegroundColor Gray
        
        # Ensure network share is connected (v1.6, updated v6.96)
        $null = Ensure-NetworkShareConnected -FilePath $picturesPath -DatabasePath $CONFIG.SharesDB
        
        if (-not (Test-Path $picturesPath)) {
            Write-Host "  [!] Path not accessible: $picturesPath" -ForegroundColor Yellow
            continue
        }
        
        # Normalize the base path for category extraction
        $normalizedBasePath = $picturesPath.TrimEnd('\', '/')
        
        $imageFiles = Get-MediaFiles -Path $picturesPath -Extensions $CONFIG.ImageExtensions
        
        foreach ($file in $imageFiles) {
            try {
                $metadata = Get-ImageMetadata -File $file
                
                # Determine category from subfolder (v4.0)
                # Category is the immediate subfolder name, or empty if file is in root
                $fileDir = $file.DirectoryName
                $category = $null
                
                if ($fileDir -ne $normalizedBasePath) {
                    # File is in a subfolder - extract the first-level subfolder name
                    $relativePath = $fileDir.Substring($normalizedBasePath.Length).TrimStart('\', '/')
                    $parts = $relativePath -split '[\\/]'
                    if ($parts.Count -gt 0 -and -not [string]::IsNullOrWhiteSpace($parts[0])) {
                        $category = $parts[0]
                    }
                }
                
                # Add category to metadata
                $metadata['category'] = $category
                
                $exists = Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB `
                    -Query "SELECT id FROM images WHERE filepath = @path" `
                    -SqlParameters @{ path = $file.FullName }
                
                if (-not $exists) {
                    $query = @"
INSERT INTO images (filename, filepath, size_bytes, format, last_modified, category)
VALUES (@filename, @filepath, @size_bytes, @format, @last_modified, @category)
"@
                    Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $query -SqlParameters $metadata
                    $imageCount++
                }
                else {
                    # Update category for existing records (migration support)
                    $updateQuery = "UPDATE images SET category = @category WHERE filepath = @filepath"
                    Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $updateQuery -SqlParameters @{
                        category = $category
                        filepath = $file.FullName
                    }
                }
                
                $imageSize += $file.Length
            }
            catch {
                Write-Host "[!] Error processing $($file.Name): $_" -ForegroundColor Red
            }
        }
    }
    
    if ($picturesPaths.Count -eq 0) {
        Write-Host "  [!] No pictures path configured. Go to Settings > Media Shares to add one." -ForegroundColor Yellow
    }
    
    # Scan eBooks
    Write-Host "`n[4/4] Scanning eBooks..." -ForegroundColor Yellow
    # Get eBook files - build array of extensions
    $pdfExtensions = $CONFIG.PDFExtensions -split ','
    $allExtensions = $pdfExtensions + @('.epub')
    $pdfCount = 0
    $pdfSize = 0
    
    foreach ($pdfPath in $pdfPaths) {
        if ([string]::IsNullOrWhiteSpace($pdfPath)) { continue }
        
        Write-Host "  → Scanning: $pdfPath" -ForegroundColor Gray
        
        # Ensure network share is connected (v1.6, updated v6.96)
        $null = Ensure-NetworkShareConnected -FilePath $pdfPath -DatabasePath $CONFIG.SharesDB
        
        if (-not (Test-Path $pdfPath)) {
            Write-Host "  [!] Path not accessible: $pdfPath" -ForegroundColor Yellow
            continue
        }
        
        $documentFiles = Get-MediaFiles -Path $pdfPath -Extensions $allExtensions
        
        foreach ($file in $documentFiles) {
            try {
                $metadata = Get-PDFMetadata -File $file
                
                $exists = Invoke-SqliteQuery -DataSource $CONFIG.PDFDB `
                    -Query "SELECT id FROM pdfs WHERE filepath = @path" `
                    -SqlParameters @{ path = $file.FullName }
                
                if (-not $exists) {
                    $query = @"
INSERT INTO pdfs (filename, filepath, title, size_bytes, date_modified, date_created)
VALUES (@filename, @filepath, @title, @size_bytes, @date_modified, @date_created)
"@
                    Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query $query -SqlParameters $metadata
                    $pdfCount++
                }
                
                $pdfSize += $file.Length
            }
            catch {
                Write-Host "[!] Error processing $($file.Name): $_" -ForegroundColor Red
            }
        }
    }
    
    if ($pdfPaths.Count -eq 0) {
        Write-Host "  [!] No eBooks path configured. Go to Settings > Media Shares to add one." -ForegroundColor Yellow
    }
    
    # Scan Music Videos if enabled (v7.10)
    $musicVideoCount = 0
    $musicVideoSize = 0
    
    if ($CONFIG.MusicVideosEnabled) {
        # Get music videos path from database (updated v6.96)
        $musicVideosPaths = Get-AllMediaPaths -MediaType 'musicvideos' -DatabasePath $CONFIG.SharesDB
        
        if ($musicVideosPaths.Count -gt 0) {
            Write-Host "`n[5/5] Scanning music videos..." -ForegroundColor Yellow
            
            foreach ($mvPath in $musicVideosPaths) {
                if ([string]::IsNullOrWhiteSpace($mvPath)) { continue }
                
                Write-Host "  → Scanning: $mvPath" -ForegroundColor Gray
                
                # Ensure network share is connected (updated v6.96)
                $null = Ensure-NetworkShareConnected -FilePath $mvPath -DatabasePath $CONFIG.SharesDB
                
                if (-not (Test-Path $mvPath)) {
                    Write-Host "  [!] Path not accessible: $mvPath" -ForegroundColor Yellow
                    continue
                }
                
                $musicVideoFiles = Get-MediaFiles -Path $mvPath -Extensions $CONFIG.VideoExtensions
        
                foreach ($file in $musicVideoFiles) {
                    try {
                        # Get basic video metadata
                        $metadata = @{
                            filename = $file.Name
                            filepath = $file.FullName
                            title = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                            size_bytes = $file.Length
                            format = $file.Extension.TrimStart('.')
                            last_modified = $file.LastWriteTime.ToString("yyyy-MM-dd HH:mm:ss")
                        }
                        
                        # Try to extract artist from filename (common format: "Artist - Title")
                        $baseName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
                        if ($baseName -match '^(.+?)\s*-\s*(.+)$') {
                            $metadata.artist = $matches[1].Trim()
                            $metadata.title = $matches[2].Trim()
                        }
                        
                        # Try to extract year from filename
                        if ($baseName -match '\((\d{4})\)' -or $baseName -match '\[(\d{4})\]' -or $baseName -match '(\d{4})') {
                            $metadata.year = [int]$matches[1]
                        }
                        
                        $exists = Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB `
                            -Query "SELECT id FROM musicvideos WHERE filepath = @path" `
                            -SqlParameters @{ path = $file.FullName }
                        
                        if (-not $exists) {
                            # v7.56: MP4 analysis removed from scan - use "Analyze Videos" button instead
                            $fields = @('filename', 'filepath', 'title', 'size_bytes', 'format', 'last_modified')
                            $params = @{
                                filename = $metadata.filename
                                filepath = $metadata.filepath
                                title = $metadata.title
                                size_bytes = $metadata.size_bytes
                                format = $metadata.format
                                last_modified = $metadata.last_modified
                            }
                            
                            if ($metadata.artist) {
                                $fields += 'artist'
                                $params.artist = $metadata.artist
                            }
                            if ($metadata.year) {
                                $fields += 'year'
                                $params.year = $metadata.year
                            }
                            
                            $fieldList = $fields -join ', '
                            $paramList = ($fields | ForEach-Object { "@$_" }) -join ', '
                            
                            $query = "INSERT INTO musicvideos ($fieldList) VALUES ($paramList)"
                            Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query $query -SqlParameters $params
                            $musicVideoCount++
                        }
                        # v7.56: Removed automatic MP4 analysis for existing records - use "Analyze Videos" button
                        
                        $musicVideoSize += $file.Length
                    }
                    catch {
                        Write-Host "[!] Error processing $($file.Name): $_" -ForegroundColor Red
                    }
                }
            }  # End foreach mvPath
        }
        else {
            Write-Host "  [!] No music videos path configured. Go to Settings > Media Shares to add one." -ForegroundColor Yellow
        }
    }
    
    # Update global stats - initialize if not exists (for Pode runspace)
    if ($null -eq $Global:MediaStats) {
        $Global:MediaStats = @{
            TotalVideos = 0
            TotalMusic = 0
            TotalPictures = 0
            TotalPDFs = 0
            TotalMusicVideos = 0
            TotalSizeGB = 0
            VideoSizeGB = 0
            MusicSizeGB = 0
            PicturesSizeGB = 0
            PDFSizeGB = 0
            MusicVideosSizeGB = 0
            LastScanDate = $null
        }
    }
    
    $Global:MediaStats.TotalVideos = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos").count
    $Global:MediaStats.TotalMusic = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music").count
    $Global:MediaStats.TotalPictures = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT COUNT(*) as count FROM images").count
    $Global:MediaStats.TotalPDFs = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs").count
    
    # Update Music Videos stats if enabled
    if ($CONFIG.MusicVideosEnabled -and (Test-Path $CONFIG.MusicVideosDB)) {
        $Global:MediaStats.TotalMusicVideos = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos").count
        $Global:MediaStats.MusicVideosSizeGB = [math]::Round($musicVideoSize / 1GB, 2)
    }
    
    $Global:MediaStats.VideoSizeGB = [math]::Round($videoSize / 1GB, 2)
    $Global:MediaStats.MusicSizeGB = [math]::Round($musicSize / 1GB, 2)
    $Global:MediaStats.PicturesSizeGB = [math]::Round($imageSize / 1GB, 2)
    $Global:MediaStats.PDFSizeGB = [math]::Round($pdfSize / 1GB, 2)
    $Global:MediaStats.TotalSizeGB = [math]::Round(($videoSize + $musicSize + $imageSize + $pdfSize + $musicVideoSize) / 1GB, 2)
    $Global:MediaStats.LastScanDate = Get-Date
    
    $scanDuration = (Get-Date) - $scanStart
    
    Write-Host "`n=== Scan Complete ===" -ForegroundColor Green
    Write-Host "Videos:   $videoCount new files indexed ($($Global:MediaStats.TotalVideos) total)" -ForegroundColor Gray
    Write-Host "Music:    $musicCount new files indexed ($($Global:MediaStats.TotalMusic) total)" -ForegroundColor Gray
    Write-Host "Pictures: $imageCount new files indexed ($($Global:MediaStats.TotalPictures) total)" -ForegroundColor Gray
    Write-Host "eBooks:   $pdfCount new files indexed ($($Global:MediaStats.TotalPDFs) total)" -ForegroundColor Gray
    if ($CONFIG.MusicVideosEnabled) {
        Write-Host "Music Videos: $musicVideoCount new files indexed ($($Global:MediaStats.TotalMusicVideos) total)" -ForegroundColor Gray
    }
    Write-Host "Duration: $([math]::Round($scanDuration.TotalSeconds, 2)) seconds" -ForegroundColor Gray
    Write-Host "Total Size: $($Global:MediaStats.TotalSizeGB) GB" -ForegroundColor Cyan
}

# ============================================================================
# INTELLIGENT ANALYSIS FUNCTIONS
# ============================================================================

function Get-LowQualityMedia {
    Write-Host "`n=== Low Quality Media Analysis ===" -ForegroundColor Cyan
    
    $lowQualityVideos = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT title, resolution, filepath FROM videos WHERE is_low_quality = 1 ORDER BY title"
    
    if ($lowQualityVideos) {
        Write-Host "`nLow Quality Videos (< $($CONFIG.LowQualityVideoThreshold)p):" -ForegroundColor Yellow
        foreach ($video in $lowQualityVideos) {
            Write-Host "  • $($video.title) [$($video.resolution)]" -ForegroundColor Gray
        }
    }
    else {
        Write-Host "✓ No low quality videos detected" -ForegroundColor Green
    }
}

function Get-IncompleteMetadata {
    Write-Host "`n=== Incomplete Metadata Analysis ===" -ForegroundColor Cyan
    
    $videosNeedingMetadata = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT COUNT(*) as count FROM videos WHERE needs_metadata = 1"
    
    $musicNeedingMetadata = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB `
        -Query "SELECT COUNT(*) as count FROM music WHERE needs_metadata = 1"
    
    Write-Host "`nItems needing metadata:" -ForegroundColor Yellow
    Write-Host "  Videos: $($videosNeedingMetadata.count)" -ForegroundColor Gray
    Write-Host "  Music:  $($musicNeedingMetadata.count)" -ForegroundColor Gray
    
    if ($videosNeedingMetadata.count -gt 0 -or $musicNeedingMetadata.count -gt 0) {
        Write-Host "`n💡 Tip: Add TMDB and Last.FM API keys to auto-fetch metadata" -ForegroundColor Cyan
    }
}

function Get-WatchRecommendations {
    Write-Host "`n=== Smart Recommendations ===" -ForegroundColor Cyan
    
    # Get unwatched recent additions
    $recentUnwatched = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT title, date_added FROM videos WHERE last_played IS NULL ORDER BY date_added DESC LIMIT 5"
    
    if ($recentUnwatched) {
        Write-Host "`nRecent additions you haven't watched:" -ForegroundColor Yellow
        foreach ($item in $recentUnwatched) {
            $daysAgo = [math]::Round(((Get-Date) - [datetime]$item.date_added).TotalDays)
            Write-Host "  • $($item.title) (added $daysAgo days ago)" -ForegroundColor Gray
        }
    }
    
    # Get highly rated content
    $topRated = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT title, rating FROM videos WHERE rating >= 7.5 AND last_played IS NULL ORDER BY rating DESC LIMIT 3"
    
    if ($topRated) {
        Write-Host "`nHighly rated unwatched content:" -ForegroundColor Yellow
        foreach ($item in $topRated) {
            Write-Host "  • $($item.title) ⭐ $($item.rating)/10" -ForegroundColor Gray
        }
    }
}

function Get-CleanupSuggestions {
    Write-Host "`n=== Cleanup & Improvement Suggestions ===" -ForegroundColor Cyan
    
    # Find duplicate filenames
    $duplicates = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query @"
SELECT filename, COUNT(*) as count 
FROM videos 
GROUP BY filename 
HAVING count > 1
"@
    
    if ($duplicates) {
        Write-Host "`nPossible duplicates found:" -ForegroundColor Yellow
        foreach ($dup in $duplicates) {
            Write-Host "  • $($dup.filename) ($($dup.count) copies)" -ForegroundColor Gray
        }
    }
    
    # Find very small files (might be samples or corrupted)
    $smallFiles = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT title, size_bytes FROM videos WHERE size_bytes < 10485760 ORDER BY size_bytes"  # < 10MB
    
    if ($smallFiles) {
        Write-Host "`nSuspiciously small video files (< 10MB):" -ForegroundColor Yellow
        foreach ($file in $smallFiles) {
            $sizeMB = [math]::Round($file.size_bytes / 1MB, 2)
            Write-Host "  • $($file.title) (${sizeMB}MB)" -ForegroundColor Gray
        }
    }
}

# ============================================================================
# WEB SERVER HTML GENERATION
# ============================================================================

function Get-HTMLPage {
    param(
        [string]$Content,
        [string]$Title = "PSMediaLibrary",
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    # Get statistics for the page - fetch from database if not available in global scope (PODE runspace)
    $stats = $Global:MediaStats
    
    # If stats are empty or all zeros (PODE runspace issue), fetch from database
    if ($null -eq $stats -or ($stats.TotalVideos -eq 0 -and $stats.TotalMusic -eq 0 -and $stats.TotalPictures -eq 0 -and $stats.TotalPDFs -eq 0)) {
        try {
            $config = $Global:CONFIG
            if ($null -eq $config) {
                $config = Get-PodeState -Name 'MediaConfig'
            }
            
            if ($config) {
                # Query counts from database
                $videoCount = (Invoke-SqliteQuery -DataSource $config.MoviesDB -Query "SELECT COUNT(*) as count FROM videos").count
                $musicCount = (Invoke-SqliteQuery -DataSource $config.MusicDB -Query "SELECT COUNT(*) as count FROM music").count
                $picturesCount = (Invoke-SqliteQuery -DataSource $config.PicturesDB -Query "SELECT COUNT(*) as count FROM images").count
                $pdfsCount = (Invoke-SqliteQuery -DataSource $config.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs").count
                
                # Query sizes from database
                $videoSize = (Invoke-SqliteQuery -DataSource $config.MoviesDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM videos").total
                $musicSize = (Invoke-SqliteQuery -DataSource $config.MusicDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM music").total
                $picturesSize = (Invoke-SqliteQuery -DataSource $config.PicturesDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM images").total
                $pdfsSize = (Invoke-SqliteQuery -DataSource $config.PDFDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM pdfs").total
                
                $stats = @{
                    TotalVideos = $videoCount
                    TotalMusic = $musicCount
                    TotalPictures = $picturesCount
                    TotalPDFs = $pdfsCount
                    TotalMusicVideos = 0
                    VideoSizeGB = [math]::Round($videoSize / 1GB, 2)
                    MusicSizeGB = [math]::Round($musicSize / 1GB, 2)
                    PicturesSizeGB = [math]::Round($picturesSize / 1GB, 2)
                    PDFSizeGB = [math]::Round($pdfsSize / 1GB, 2)
                    MusicVideosSizeGB = 0
                    TotalSizeGB = [math]::Round(($videoSize + $musicSize + $picturesSize + $pdfsSize) / 1GB, 2)
                }
                
                # Add Music Videos stats if enabled
                if ($config.MusicVideosEnabled -and $config.MusicVideosDB -and (Test-Path $config.MusicVideosDB)) {
                    $musicVideosCount = (Invoke-SqliteQuery -DataSource $config.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos").count
                    $musicVideosSize = (Invoke-SqliteQuery -DataSource $config.MusicVideosDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM musicvideos").total
                    $stats.TotalMusicVideos = $musicVideosCount
                    $stats.MusicVideosSizeGB = [math]::Round($musicVideosSize / 1GB, 2)
                    $stats.TotalSizeGB = [math]::Round(($videoSize + $musicSize + $picturesSize + $pdfsSize + $musicVideosSize) / 1GB, 2)
                }
            }
        }
        catch {
            # Fallback to zeros if database query fails
            $stats = @{
                TotalVideos = 0
                TotalMusic = 0
                TotalPictures = 0
                TotalPDFs = 0
                TotalMusicVideos = 0
                VideoSizeGB = 0
                MusicSizeGB = 0
                PicturesSizeGB = 0
                PDFSizeGB = 0
                MusicVideosSizeGB = 0
                TotalSizeGB = 0
            }
        }
    }
    
    # Get media share status - fetch from database if not available in global scope (PODE runspace) (v3.7)
    $shareStatusHtml = ""
    try {
        $config = $Global:CONFIG
        if ($null -eq $config) {
            $config = Get-PodeState -Name 'MediaConfig'
        }
        
        # v6.96: Use SharesDB for share status
        $sharesDb = if ($config.SharesDB) { $config.SharesDB } else { $config.UsersDB }
        if ($config -and $sharesDb -and (Test-Path $sharesDb)) {
            # Query share status from database
            $shares = Invoke-SqliteQuery -DataSource $sharesDb -Query @"
SELECT share_type, share_name, share_path, last_test_status, enabled 
FROM network_shares 
WHERE enabled = 1 
ORDER BY share_type
"@
            
            if ($shares) {
                # Ensure it's an array
                if ($shares -isnot [System.Array]) {
                    $shares = @($shares)
                }
                
                $mediaLabels = @{
                    'movies' = 'Videos'
                    'music' = 'Music'
                    'pictures' = 'Pictures'
                    'pdfs' = 'PDFs'
                    'musicvideos' = 'Music Videos'
                }
                
                foreach ($share in $shares) {
                    $label = $mediaLabels[$share.share_type]
                    if (-not $label) { $label = $share.share_type }
                    
                    # Determine online/offline based on last_test_status
                    $isOnline = $false
                    if ($share.last_test_status) {
                        if ($share.last_test_status -match 'accessible|Connected|successful|reachable') {
                            $isOnline = $true
                        }
                    }
                    
                    if ($isOnline) {
                        $shareStatusHtml += "$label - <span style='color: #22c55e !important; font-weight: 600;'>ONLINE</span><br/>"
                    } else {
                        $shareStatusHtml += "$label - <span style='color: #ef4444 !important; font-weight: 600;'>OFFLINE</span><br/>"
                    }
                }
            }
        }
    }
    catch {
        $shareStatusHtml = "<span style='color: rgba(255,255,255,0.5);'>Unable to load status</span>"
    }
    
    # If no shares configured, show message
    if ([string]::IsNullOrWhiteSpace($shareStatusHtml)) {
        $shareStatusHtml = "<span style='color: rgba(255,255,255,0.5); font-size: 11px;'>No shares configured</span>"
    }
    
    # Generate Settings link for admin users
    $settingsLink = ""
    if ($UserSession -and $UserSession.UserType -eq 'admin') {
        $settingsLink = @"
<a href="/settings">
  <div class="left"><span class="ico">⚙️</span><span>Settings</span></div>
  <span class="pill" style="background: rgba(251,191,36,0.2); color: #fbbf24; border-color: #fbbf24;">ADMIN</span>
</a>
"@
    }
    
    # Generate Music Videos menu link if enabled (v7.10)
    $musicVideosLink = ""
    $config = $Global:CONFIG
    if ($null -eq $config) {
        $config = Get-PodeState -Name 'MediaConfig'
    }
    if ($config -and $config.MusicVideosEnabled) {
        $mvCount = if ($stats.TotalMusicVideos) { $stats.TotalMusicVideos } else { 0 }
        $musicVideosLink = @"
        <a href="/musicvideos">
          <div class="left"><span class="ico"><img src="/menu/music.png" alt="Music Videos"></span><span>Music Videos</span></div>
          <span class="pill" style="background: rgba(168,85,247,0.2); color: #a855f7; border-color: #a855f7;">$mvCount</span>
        </a>
"@
    }
    
    # Generate Radio menu link if enabled (v7.19)
    $radioLink = ""
    if (-not $config -or $config.RadioEnabled) {
        $radioLink = @"
        <a href="/radio">
          <div class="left"><span class="ico"><img src="/menu/radio.png" alt="Radio"></span><span>Radio</span></div>
          <span class="pill" style="background: rgba(52,211,153,0.2); color: var(--accent); border-color: var(--accent);">LIVE</span>
        </a>
"@
    }
    
    # Generate Internet TV menu link if enabled (v7.19)
    $internetTVLink = ""
    if (-not $config -or $config.InternetTVEnabled) {
        $internetTVLink = @"
        <a href="/tv">
          <div class="left"><span class="ico"><img src="/menu/tv.png" alt="TV"></span><span>Internet TV</span></div>
          <span class="pill" style="background: rgba(96,165,250,0.2); color: #60a5fa; border-color: #60a5fa;">LIVE</span>
        </a>
"@
    }
    
    # Generate Pictures menu link if enabled (v7.19)
    $picturesLink = ""
    if (-not $config -or $config.PicturesEnabled) {
        $picturesLink = @"
        <a href="/pictures">
          <div class="left"><span class="ico"><img src="/menu/pictures.png" alt="Pictures"></span><span>Pictures</span></div>
          <span class="pill">$($stats.TotalPictures)</span>
        </a>
"@
    }
    
    # Generate eBooks menu link if enabled (v7.19)
    $ebooksLink = ""
    if (-not $config -or $config.EbooksEnabled) {
        $ebooksLink = @"
        <a href="/pdfs">
          <div class="left"><span class="ico"><img src="/menu/pdf.png" alt="Documents"></span><span>eBooks</span></div>
          <span class="pill">$($stats.TotalPDFs)</span>
        </a>
"@
    }
    
    return @"
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <title>$Title</title>
  <style>
    :root{
      --bg:#0d1410;
      --panel:#141f18;
      --panel2:#0f1612;
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --accent:#34d399;
      --accent2:#34d399;
      --accent3:#fbbf24;
      --glow1: rgba(52,211,153,.18);
      --glow2: rgba(34,197,94,.12);
      --radius: 18px;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
    }
    /* Blue Theme */
    body.theme-blue{
      --bg:#0a0f1a;
      --panel:#131b2e;
      --panel2:#0e1420;
        --accent:#3b82f6;
      --accent2:#60a5fa;
      --accent3:#fbbf24;
      --glow1: rgba(59,130,246,.25);
      --glow2: rgba(37,99,235,.18);
    }
    /* Purple Theme */
    body.theme-purple{
      --bg:#0f0a1a;
      --panel:#1a1329;
      --panel2:#130e20;
        --accent:#8b5cf6;
      --accent2:#a78bfa;
      --accent3:#fbbf24;
      --glow1: rgba(139,92,246,.25);
      --glow2: rgba(124,58,237,.18);
    }
    /* Red Theme */
    body.theme-red{
      --bg:#1a0a0a;
      --panel:#2e1313;
      --panel2:#200e0e;
      --accent:#ef4444;
      --accent2:#f87171;
      --accent3:#fbbf24;
      --glow1: rgba(239,68,68,.25);
      --glow2: rgba(220,38,38,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
      radial-gradient(950px 600px at 10% 15%, var(--glow1), transparent 55%),
      radial-gradient(800px 520px at 90% 85%, var(--glow2), transparent 55%),
      linear-gradient(180deg, #0a1410, var(--bg));
      color: var(--text);
      min-height:100vh;
      transition: background 0.4s ease;
    }
    .app{
      display:grid;
      grid-template-columns: 280px 1fr;
      min-height:100vh;
    }
    @media (max-width: 980px){
      .app{grid-template-columns: 1fr}
    }
    .sidebar{
      padding:18px;
      border-right: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      /* backdrop-filter removed for performance */
      /* transform removed */
    }
    .brand{
      display:flex; gap:12px; align-items:center;
      padding:14px;
      border:1px solid rgba(255,255,255,.15);
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      /* backdrop-filter removed for performance */
      box-shadow: 0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);
    }
    .logo{
      width:40px; height:40px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(96,165,250,.9), rgba(52,211,153,.7));
      box-shadow: 0 4px 12px rgba(96,165,250,.3);
    }
    .brand strong{display:block; font-size:16px}
    .brand span{display:block; font-size:12px; color:var(--muted); margin-top:2px}
    .nav{
      margin-top:14px;
      display:flex; flex-direction:column; gap:10px;
    }
    .nav a{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.10);
      /* backdrop-filter removed for performance */
      text-decoration:none;
      color: var(--text);
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    .nav a:hover{
      transform: translateY(-1px); 
      background: rgba(255,255,255,.10); 
      border-color: rgba(255,255,255,.22);
    }
    .nav .left{display:flex; align-items:center; gap:12px}
    .nav .ico{font-size:20px}
    .nav .ico img{width:24px; height:24px; display:block}
    .btn .ico img{width:20px; height:20px; display:block}
    .nav .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      color: var(--muted);
      background: rgba(0,0,0,.35);
    }

    .sidebar .cta{
      margin-top:14px;
      display:grid;
      gap:10px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.08);
      color: var(--text);
      padding:14px 14px;
      border-radius: 16px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      text-decoration:none;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    .btn:hover{
      transform: translateY(-1px); 
      background: rgba(255,255,255,.12); 
      border-color: rgba(255,255,255,.22);
    }
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.25), rgba(52,211,153,.18));
      border-color: rgba(96,165,250,.3);
      box-shadow: 0 4px 16px rgba(96,165,250,.2);
    }
    .btn .ico{font-size:18px}

    .main{
      padding:18px;
    }
    .top{
      display:flex; gap:12px; align-items:center;
      padding:14px;
      border-radius: var(--radius);
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.08);
      /* backdrop-filter removed for performance */
      /* transform removed */
      box-shadow: 0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);
    }
    .search{
      flex:1;
      display:flex; gap:10px; align-items:center;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.35);
      /* backdrop-filter removed for performance */
      box-shadow: inset 0 2px 8px rgba(0,0,0,.2);
    }
    .search input{
      width:100%; border:0; outline:none;
      background: transparent; color: var(--text);
      font-size:14px;
    }
    .seg{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .chip{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(255,255,255,.10);
      color: rgba(255,255,255,.80);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
    }
    .chip:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.12);
      border-color: rgba(255,255,255,.25);
    }
    .chip.on{
      border-color: rgba(96,165,250,.4); 
      background: rgba(96,165,250,.15);
      box-shadow: 0 4px 12px rgba(96,165,250,.25);
    }
    .content{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }

    .card{
      border:1px solid rgba(255,255,255,.15);
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      /* backdrop-filter removed for performance */
      /* transform removed */
      box-shadow: 0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);
      overflow:hidden;
    }
    .card .head{
      padding:14px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    .title{
      display:flex; align-items:baseline; gap:10px;
    }
    .title strong{font-size:15px}
    .title span{font-size:12px; color:var(--muted)}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .small{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.86);
      cursor:pointer;
      user-select:none;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      transition: transform .08s ease, background .15s ease;
    }
    .small:hover{
      transform: translateY(-1px);
      background: rgba(0,0,0,.35);
      border-color: rgba(255,255,255,.22);
    }
    .grid{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
    }
    @media (max-width: 1200px){ .grid{grid-template-columns: repeat(6, 1fr)} }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(4, 1fr)} }
    @media (max-width: 560px){ .grid{grid-template-columns: repeat(2, 1fr)} }

    .item{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.15);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      /* backdrop-filter removed for performance */
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease;
      position:relative;
      min-height: 170px;
      text-decoration: none;
      color: var(--text);
      box-shadow: 0 4px 16px rgba(0,0,0,.2);
    }
    .item:hover{
      transform: translateY(-2px); 
      border-color: rgba(255,255,255,.25);
      box-shadow: 0 8px 24px rgba(0,0,0,.3);
    }
    .thumb{
      height: 380px;
      background:
        radial-gradient(280px 160px at 30% 20%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(135deg, rgba(96,165,250,.22), rgba(251,191,36,.10));
      background-size: cover;
      background-position: center;
    }
    .meta{
      padding:10px 10px 12px;
      background: rgba(0,0,0,.35);
      /* backdrop-filter removed for performance */
    }
    .meta strong{
      display:block;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .meta span{
      display:block;
      font-size:12px;
      color: var(--muted);
      margin-top:3px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .flag{
      position:absolute;
      top:10px; left:10px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.55);
      /* backdrop-filter removed for performance */
      font-size:11px;
      color: rgba(255,255,255,.90);
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
    .flag.video{border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.2)}
    .flag.audio{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.2)}
    .flag.pdf{border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.2)}
    .flag.epub{border-color: rgba(99,102,241,.35); background: rgba(99,102,241,.2)}
    .flag.picture{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.2)}
    .flag.other{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.2)}
    .corner{
      position:absolute;
      top:10px; right:10px;
      width:36px; height:36px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.55);
      /* backdrop-filter removed for performance */
      display:flex; align-items:center; justify-content:center;
      font-size:16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.25);
    }
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .footerbar{
      margin-top:14px;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:12px;
    }
    @media (max-width: 1400px){ .footerbar{grid-template-columns: repeat(3, 1fr)} }
    @media (max-width: 980px){ .footerbar{grid-template-columns: 1fr} }
    .mini{
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .mini .row{display:flex; align-items:center; justify-content:space-between}
    .mini .k{font-size:12px; color:var(--muted)}
    .mini .v{font-size:18px}
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,.08);
      border-radius: 999px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border-radius: 999px;
      transition: width 0.3s ease;
    }
    .status-panel {
      margin-top: 14px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .status-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .status-title {
      font-size:14px;
      font-weight:600;
      color: var(--text);
    }
    .status-ok {
      font-size:12px;
      padding:6px 12px;
      border-radius:8px;
      background: rgba(52,211,153,.15);
      color: var(--accent2);
      border:1px solid rgba(52,211,153,.25);
    }
    .theme-switcher {
      margin-top: 14px;
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      padding:18px;
    }
    .theme-title {
      font-size:14px;
      font-weight:600;
      color: var(--text);
      margin-bottom:12px;
    }
    .theme-buttons {
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap:8px;
    }
    .theme-btn {
      padding:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      cursor:pointer;
      text-align:center;
      font-size:12px;
      transition: all 0.2s ease;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .theme-btn:hover {
      background: rgba(255,255,255,.08);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }
    .theme-btn.active {
      border-color: var(--accent);
      background: rgba(255,255,255,.12);
    }
    .theme-color {
      width:32px;
      height:32px;
      border-radius:8px;
      border:2px solid rgba(255,255,255,.20);
    }
    .theme-color.green { background: linear-gradient(135deg, #34d399, #22c55e); }
    .theme-color.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .theme-color.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .theme-color.red { background: linear-gradient(135deg, #ef4444, #dc2626); }
    
    /* User Panel */
    .user-panel {
      margin-top: auto;
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      color: #0d1410;
    }
    .user-details {
      flex: 1;
      min-width: 0;
    }
    .user-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .user-role {
      font-size: 12px;
      color: rgba(255,255,255,0.5);
      text-transform: capitalize;
    }
    .logout-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 10px;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      color: #ef4444;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
    }
    .logout-btn:hover {
      background: rgba(239,68,68,0.25);
      border-color: rgba(239,68,68,0.5);
      transform: translateY(-1px);
    }
    
    /* Notification Banner System */
    .notification-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10000;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-weight: 600;
      font-size: 15px;
      transform: translateY(-100%);
      opacity: 0;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s ease;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .notification-banner.show {
      transform: translateY(0);
      opacity: 1;
    }
    .notification-banner.success {
      background: rgba(34, 197, 94, 0.85);
      color: #fff;
      box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
    }
    .notification-banner.error {
      background: rgba(220, 38, 38, 0.85);
      color: #fff;
      box-shadow: 0 4px 20px rgba(220, 38, 38, 0.4);
    }
    .notification-banner.info {
      background: rgba(52, 211, 153, 0.85);
      color: #0d1410;
      box-shadow: 0 4px 20px rgba(52, 211, 153, 0.4);
    }
    .notification-banner .spinner-small {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    .notification-banner.info .spinner-small {
      border-color: rgba(13,20,16,0.3);
      border-top-color: #0d1410;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ============================================================================
       PREMIUM MOBILE UI (v7.37) - Clean dark design with NexusM green accent
       ============================================================================ */
    
    /* Import Inter font for mobile */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    /* Mobile color scheme - NexusM Green accent */
    @media (max-width: 768px) {
      :root {
        --mobile-accent: #34d399;
        --mobile-accent-glow: rgba(52, 211, 153, 0.4);
        --mobile-bg: #0a0a0a;
        --mobile-surface: #161616;
        --mobile-card: rgba(30, 30, 30, 0.6);
        --mobile-glass: rgba(255, 255, 255, 0.03);
        --mobile-glass-border: rgba(255, 255, 255, 0.08);
        --mobile-text: #f1f5f9;
        --mobile-text-muted: #64748b;
      }
      
      html, body {
        overflow-x: hidden !important;
        max-width: 100vw !important;
      }
      
      body {
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, sans-serif !important;
        background: var(--mobile-bg) !important;
      }
    }
    
    /* Glass effect utility */
    .mobile-glass {
      background: var(--mobile-glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid var(--mobile-glass-border);
    }
    
    /* Hide scrollbar utility */
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    
    /* ==================== MOBILE HEADER ==================== */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      padding: 12px 16px;
      padding-top: calc(12px + env(safe-area-inset-top, 0));
      background: rgba(10, 10, 10, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--mobile-glass-border);
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .mobile-header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .mobile-logo {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mobile-logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #34d399, #22c55e);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mobile-logo-icon svg {
      width: 20px;
      height: 20px;
      fill: #0a0a0a;
    }
    
    .mobile-logo-text {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--mobile-text);
    }
    
    .mobile-logo-text span {
      color: #34d399;
    }
    
    .mobile-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mobile-header-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--mobile-text);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 22px;
    }
    
    .mobile-header-btn:hover,
    .mobile-header-btn:active {
      background: rgba(255,255,255,0.1);
    }
    
    .mobile-profile-btn {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid rgba(52, 211, 153, 0.3);
      background: linear-gradient(135deg, #34d399, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: #0a0a0a;
    }
    
    .mobile-profile-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* ==================== MOBILE MAIN CONTENT ==================== */
    .mobile-main {
      display: none;
      padding: 70px 0 90px 0; /* Top padding for fixed header */
      padding-top: calc(70px + env(safe-area-inset-top, 0));
      padding-bottom: calc(90px + env(safe-area-inset-bottom, 0));
      min-height: 100vh;
      overflow-x: hidden; /* Prevent horizontal page scroll */
    }
    
    /* Force cards to stay in place on mobile home */
    .mobile-main .card {
      overflow: hidden;
      width: calc(100% - 24px); /* Account for margin */
      max-width: calc(100vw - 24px);
    }
    
    /* Only the scroll container inside should scroll horizontally */
    .mobile-main .mobile-recent-scroll,
    .mobile-main .mobile-continue-scroll {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
    }
    
    /* ==================== FEATURED HERO SECTION ==================== */
    .mobile-hero {
      padding: 20px;
      padding-top: 0;
    }
    
    .mobile-hero-card {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 16px;
      overflow: hidden;
    }
    
    .mobile-hero-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .mobile-hero-overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.4) 40%, transparent 100%);
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      padding: 20px;
    }
    
    .mobile-hero-badge {
      color: var(--mobile-accent);
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 6px;
    }
    
    .mobile-hero-title {
      font-size: 22px;
      font-weight: 700;
      color: white;
      margin-bottom: 12px;
      line-height: 1.2;
    }
    
    .mobile-hero-actions {
      display: flex;
      gap: 10px;
    }
    
    .mobile-hero-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 18px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: transform 0.2s, opacity 0.2s;
    }
    
    .mobile-hero-btn:active {
      transform: scale(0.95);
    }
    
    .mobile-hero-btn.primary {
      background: var(--mobile-accent);
      color: #0a0a0a;
    }
    
    .mobile-hero-btn.secondary {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      color: white;
    }
    
    /* ==================== SECTION CARDS (v7.68 - Match Library .card styling exactly) ==================== */
    .mobile-section {
      margin: 0 12px 16px 12px;
      border: 1px solid rgba(255,255,255,.15);
      border-radius: var(--radius);
      background: rgba(255,255,255,.08);
      box-shadow: 0 8px 32px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.1);
      overflow: hidden;
    }
    
    .mobile-section-header {
      padding: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    
    .mobile-section-title {
      font-size: 15px;
      font-weight: 700;
      color: var(--mobile-text);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .mobile-section-title .icon {
      font-size: 18px;
    }
    
    .mobile-section-count {
      font-size: 12px;
      color: var(--mobile-text-muted);
      font-weight: 400;
      margin-left: 8px;
    }
    
    .mobile-section-link {
      color: var(--mobile-accent);
      font-size: 13px;
      font-weight: 600;
      text-decoration: none;
    }
    
    /* Content area inside mobile sections */
    .mobile-section-content {
      padding: 14px;
    }
    
    /* ==================== CONTINUE WATCHING CARDS (Portrait) ==================== */
    .mobile-continue-scroll {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 14px;
      padding-top: 0;
      scroll-snap-type: x mandatory;
    }
    
    .mobile-continue-card {
      flex-shrink: 0;
      width: 140px;
      scroll-snap-align: start;
      text-decoration: none;
    }
    
    .mobile-continue-poster {
      position: relative;
      width: 100%;
      aspect-ratio: 2/3;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 10px;
      background: var(--mobile-surface);
    }
    
    .mobile-continue-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .mobile-continue-progress {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: rgba(255,255,255,0.2);
    }
    
    .mobile-continue-progress-fill {
      height: 100%;
      background: var(--mobile-accent);
      box-shadow: 0 0 8px var(--mobile-accent-glow);
    }
    
    .mobile-continue-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    
    .mobile-continue-card:hover .mobile-continue-overlay,
    .mobile-continue-card:active .mobile-continue-overlay {
      opacity: 1;
    }
    
    .mobile-continue-play {
      font-size: 48px;
      color: white;
    }
    
    .mobile-continue-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--mobile-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-continue-meta {
      font-size: 11px;
      color: var(--mobile-text-muted);
      margin-top: 2px;
    }
    
    /* ==================== RECENTLY ADDED CARDS (Portrait Poster) ==================== */
    .mobile-recent-scroll {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 14px;
      padding-top: 0;
      scroll-snap-type: x mandatory;
    }
    
    .mobile-recent-card {
      flex-shrink: 0;
      width: 115px;
      scroll-snap-align: start;
      text-decoration: none;
    }
    
    .mobile-recent-poster {
      position: relative;
      width: 100%;
      aspect-ratio: 2/3;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
      background: var(--mobile-surface);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .mobile-recent-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .mobile-recent-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 24px;
      height: 24px;
      border-radius: 6px;
      background: var(--mobile-glass);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--mobile-glass-border);
    }
    
    .mobile-recent-badge.watched {
      color: #4ade80;
    }
    
    .mobile-recent-badge.new {
      background: #dc2626;
      color: white;
      font-size: 8px;
      font-weight: 700;
    }
    
    .mobile-recent-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--mobile-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-recent-year {
      font-size: 10px;
      color: var(--mobile-text-muted);
      margin-top: 2px;
    }
    
    /* ==================== FAVORITES SECTION ==================== */
    .mobile-favorites-scroll {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 0 20px;
      scroll-snap-type: x mandatory;
    }
    
    .mobile-favorites-card {
      flex-shrink: 0;
      width: 160px;
      scroll-snap-align: start;
      text-decoration: none;
    }
    
    .mobile-favorites-poster {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 8px;
      background: var(--mobile-surface);
    }
    
    .mobile-favorites-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .mobile-favorites-heart {
      position: absolute;
      top: 8px;
      left: 8px;
      color: #ef4444;
      font-size: 16px;
    }
    
    .mobile-favorites-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--mobile-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* ==================== BOTTOM NAVIGATION ==================== */
    .mobile-bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 9998;
      background: rgba(10, 10, 10, 0.98);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--mobile-glass-border);
      padding-bottom: env(safe-area-inset-bottom, 0);
      padding-top: 8px;
      padding-left: 16px;
      padding-right: 16px;
      touch-action: none;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    
    .mobile-nav-items {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .mobile-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      text-decoration: none;
      color: var(--mobile-text-muted);
      transition: color 0.2s;
      padding: 4px 12px 8px;
    }
    
    .mobile-nav-item.active {
      color: var(--mobile-accent);
    }
    
    .mobile-nav-item:hover {
      color: var(--mobile-text);
    }
    
    .mobile-nav-icon {
      font-size: 24px;
    }
    
    .mobile-nav-label {
      font-size: 10px;
      font-weight: 600;
    }
    
    .mobile-nav-item.active .mobile-nav-label {
      font-weight: 700;
    }
    
    /* ==================== MOBILE SEARCH OVERLAY ==================== */
    .mobile-search-overlay {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10001;
      background: var(--mobile-bg);
      padding: 20px;
      padding-top: calc(20px + env(safe-area-inset-top, 0));
    }
    
    .mobile-search-overlay.show {
      display: block;
    }
    
    .mobile-search-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .mobile-search-back {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255,255,255,0.08);
      border: none;
      color: var(--mobile-text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .mobile-search-input {
      flex: 1;
      padding: 14px 18px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      color: var(--mobile-text);
      font-size: 16px;
      font-family: 'Inter', sans-serif;
      outline: none;
    }
    
    .mobile-search-input:focus {
      border-color: var(--mobile-accent);
      background: rgba(255,255,255,0.12);
    }
    
    .mobile-search-input::placeholder {
      color: var(--mobile-text-muted);
    }
    
    /* ==================== MOBILE USER MENU ==================== */
    .mobile-user-menu {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10001;
      background: rgba(0,0,0,0.7);
    }
    
    .mobile-user-menu.show {
      display: flex;
      justify-content: flex-end;
    }
    
    .mobile-user-panel {
      width: 300px;
      max-width: 85%;
      height: 100%;
      background: var(--mobile-surface);
      padding: 24px 20px;
      padding-top: calc(24px + env(safe-area-inset-top, 0));
      animation: slideInRight 0.3s ease;
      overflow-y: auto;
    }
    
    @keyframes slideInRight {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }
    
    .mobile-user-header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      margin-bottom: 20px;
    }
    
    .mobile-user-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #34d399, #22c55e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 22px;
      color: #0a0a0a;
      overflow: hidden;
    }
    
    .mobile-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .mobile-user-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--mobile-text);
    }
    
    .mobile-user-role {
      font-size: 12px;
      color: var(--mobile-text-muted);
      text-transform: capitalize;
      margin-top: 2px;
    }
    
    .mobile-menu-items {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .mobile-menu-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border-radius: 12px;
      background: rgba(255,255,255,0.04);
      color: var(--mobile-text);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .mobile-menu-item:hover {
      background: rgba(255,255,255,0.08);
    }
    
    .mobile-menu-item.danger {
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .mobile-menu-icon {
      font-size: 20px;
    }
    
    /* ==================== BACKGROUND GLOW EFFECTS ==================== */
    .mobile-bg-glow {
      display: none;
      position: fixed;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      overflow: hidden;
    }
    
    .mobile-bg-glow::before {
      content: '';
      position: absolute;
      top: -100px;
      left: -100px;
      width: 300px;
      height: 300px;
      background: rgba(52, 211, 153, 0.06);
      border-radius: 50%;
      filter: blur(100px);
    }
    
    .mobile-bg-glow::after {
      content: '';
      position: absolute;
      bottom: 20%;
      right: -100px;
      width: 350px;
      height: 350px;
      background: rgba(59, 130, 246, 0.05);
      border-radius: 50%;
      filter: blur(120px);
    }
    
    /* ==================== MOBILE MINI-PLAYER BAR (v7.68) ==================== */
    .mobile-mini-player {
      display: none;
      position: fixed;
      bottom: 56px; /* Above bottom nav */
      bottom: calc(56px + env(safe-area-inset-bottom, 0));
      left: 0;
      right: 0;
      z-index: 9997;
      background: linear-gradient(to top, rgba(20, 20, 20, 0.98), rgba(30, 30, 30, 0.95));
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid var(--mobile-glass-border);
      padding: 8px 12px;
      touch-action: manipulation;
    }
    
    .mobile-mini-player.active {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .mobile-mini-player-art {
      width: 44px;
      height: 44px;
      border-radius: 6px;
      background: linear-gradient(135deg, rgba(52, 211, 153, 0.3), rgba(34, 197, 94, 0.3));
      background-size: cover;
      background-position: center;
      flex-shrink: 0;
    }
    
    .mobile-mini-player-info {
      flex: 1;
      min-width: 0;
      overflow: hidden;
    }
    
    .mobile-mini-player-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--mobile-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-mini-player-artist {
      font-size: 11px;
      color: var(--mobile-text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .mobile-mini-player-controls {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .mobile-mini-player-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: transparent;
      border: none;
      color: var(--mobile-text);
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      touch-action: manipulation;
    }
    
    .mobile-mini-player-btn.play-btn {
      background: var(--mobile-accent);
      color: #0a0a0a;
    }
    
    .mobile-mini-player-progress {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .mobile-mini-player-progress-fill {
      height: 100%;
      background: var(--mobile-accent);
      width: 0%;
      transition: width 0.3s linear;
    }
    
    /* ==================== RESPONSIVE BREAKPOINT ==================== */
    @media (max-width: 768px) {
      /* Prevent zoom on double-tap */
      * {
        touch-action: manipulation;
      }
      
      /* Hide desktop sidebar */
      .sidebar {
        display: none !important;
      }
      
      .app {
        grid-template-columns: 1fr !important;
      }
      
      /* Style .main for mobile - add padding for header and bottom nav */
      .main {
        padding-top: 60px !important;
        padding-bottom: calc(70px + env(safe-area-inset-bottom, 0)) !important;
        padding-left: 10px !important;
        padding-right: 10px !important;
      }
      
      /* When mini-player is active, add more bottom padding */
      body.mini-player-active .main {
        padding-bottom: calc(130px + env(safe-area-inset-bottom, 0)) !important;
      }
      
      /* Hide desktop home header on mobile (replaced by mobile-header) */
      .home-header {
        display: none !important;
      }
      
      /* Show mobile elements */
      .mobile-header {
        display: block;
      }
      
      .mobile-main {
        display: block;
      }
      
      .mobile-bottom-nav {
        display: block;
      }
      
      .mobile-bg-glow {
        display: block;
      }
      
      /* Hide desktop genres-container on mobile - mobile-main replaces it */
      .genres-container {
        display: none !important;
      }
      
      /* ==================== SIMPLIFIED MOBILE CARDS (v7.68) ==================== */
      /* Hide badges and extra buttons on mobile cards */
      .flag,
      .corner,
      .media-actions,
      .favorite-btn,
      .menu-btn {
        display: none !important;
      }
      
      /* Cleaner card appearance */
      .item {
        border-radius: 10px !important;
        overflow: hidden;
        min-height: auto !important;
      }
      
      /* Match home page poster sizes - smaller for mobile */
      .thumb {
        height: 160px !important;
        border-radius: 10px 10px 0 0 !important;
        aspect-ratio: 2/3;
      }
      
      /* For grid items, make posters proportional */
      .grid .item .thumb {
        height: auto !important;
        aspect-ratio: 2/3;
      }
      
      /* Show only simple play overlay on tap */
      .play-overlay {
        opacity: 0;
        background: rgba(0, 0, 0, 0.5) !important;
      }
      
      .item:active .play-overlay {
        opacity: 1;
      }
      
      /* Compact metadata */
      .meta {
        padding: 8px !important;
      }
      
      .meta strong {
        font-size: 12px !important;
        line-height: 1.3 !important;
      }
      
      .meta span {
        font-size: 10px !important;
      }
      
      /* Hide desktop music player bar on mobile */
      .music-player-bar {
        display: none !important;
      }
      
      /* ==================== HIDE SECONDARY SEARCH BOXES ON MOBILE (v7.68) ==================== */
      /* The global search in header is sufficient - hide page-specific search boxes */
      .search {
        display: none !important;
      }
      
      /* ==================== MOBILE MUSIC PAGE ACTIONS (v7.68) ==================== */
      /* Hide desktop-only actions */
      .actions .small:not(.mobile-action) {
        display: none !important;
      }
      
      /* Show only essential mobile actions */
      .mobile-shuffle-btn,
      .mobile-playlist-btn {
        display: inline-flex !important;
      }
      
      /* Mobile-friendly genre cards */
      .genre-item {
        min-width: 130px !important;
        max-width: 130px !important;
      }
      
      .genre-poster {
        height: 75px !important;
      }
      
      .genre-title {
        font-size: 11px !important;
      }
      
      .genre-name {
        font-size: 16px !important;
      }
      
      .genre-count {
        font-size: 11px !important;
      }
      
      /* Hide scroll buttons on mobile */
      .scroll-btn {
        display: none !important;
      }
      
      /* Mobile-friendly video grid */
      .video-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      .video-card {
        border-radius: 10px !important;
      }
      
      /* Mobile-friendly music grid */
      .music-grid, .track-grid {
        grid-template-columns: repeat(2, 1fr) !important;
        gap: 12px !important;
      }
      
      /* Mobile-friendly settings */
      .settings-container {
        padding: 16px !important;
      }
      
      .settings-card {
        padding: 16px !important;
      }
      
      /* Page titles on mobile */
      h1 {
        font-size: 22px !important;
      }
      
      h2 {
        font-size: 18px !important;
      }
      
      /* Hide desktop-only elements */
      .desktop-only {
        display: none !important;
      }
      
      /* Simplify page headers on mobile */
      .head {
        flex-direction: column !important;
        align-items: flex-start !important;
        gap: 12px !important;
      }
      
      .head .title {
        width: 100% !important;
      }
      
      .head .actions {
        width: 100% !important;
        display: flex !important;
        gap: 10px !important;
        flex-wrap: wrap !important;
      }
      
      /* Compact search on mobile */
      .search {
        padding: 10px 14px !important;
      }
      
      .search input {
        font-size: 14px !important;
      }
      
      /* Filter chips on mobile */
      .seg {
        flex-wrap: wrap !important;
        gap: 8px !important;
      }
      
      .chip {
        padding: 8px 14px !important;
        font-size: 12px !important;
      }
      
      /* Hide pagination info text on mobile, keep buttons */
      .pagination-info {
        display: none !important;
      }
    }
    
    /* Extra small screens */
    @media (max-width: 380px) {
      .mobile-continue-card {
        width: 120px;
      }
      
      .mobile-recent-card {
        width: 100px;
      }
      
      .mobile-favorites-card {
        width: 140px;
      }
      
      .mobile-hero-title {
        font-size: 18px;
      }
      
      .mobile-section-title {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- Notification Banner -->
  <div id="notification-banner" class="notification-banner"></div>
  
  <!-- Material Icons for Mobile -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  
  <!-- Mobile Background Glow Effects (v7.37) -->
  <div class="mobile-bg-glow"></div>
  
  <!-- Mobile Header (v7.68 - Simplified) -->
  <header class="mobile-header">
    <div class="mobile-header-content">
      <div class="mobile-logo">
        <div class="mobile-logo-icon">
          <span class="material-icons-round" style="font-size:20px;color:#0a0a0a;">play_arrow</span>
        </div>
        <span class="mobile-logo-text">Nexus<span>M</span></span>
      </div>
      <div class="mobile-header-actions">
        <button class="mobile-header-btn" onclick="openMobileSearch()" aria-label="Search">
          <span class="material-icons-round">search</span>
        </button>
        <button class="mobile-profile-btn" onclick="openMobileUserMenu()">
          $(if ($UserSession -and $UserSession.AvatarPath) { "<img src='/avatar/$($UserSession.AvatarPath)' alt='Profile'>" } elseif ($UserSession) { $UserSession.DisplayName.Substring(0,1).ToUpper() } else { "?" })
        </button>
      </div>
    </div>
  </header>
  
  <!-- Mobile Search Overlay (v7.37) -->
  <div id="mobile-search-overlay" class="mobile-search-overlay">
    <div class="mobile-search-header">
      <button class="mobile-search-back" onclick="closeMobileSearch()">
        <span class="material-icons-round">arrow_back</span>
      </button>
      <input type="text" id="mobile-search-input" class="mobile-search-input" placeholder="Search movies, TV shows, music...">
    </div>
    <div id="mobile-search-results"></div>
  </div>
  
  <!-- Mobile User Menu (v7.68 - Simplified) -->
  <div id="mobile-user-menu" class="mobile-user-menu" onclick="closeMobileUserMenu(event)">
    <div class="mobile-user-panel" onclick="event.stopPropagation()">
      <div class="mobile-user-header">
        <div class="mobile-user-avatar">
          $(if ($UserSession -and $UserSession.AvatarPath) { "<img src='/avatar/$($UserSession.AvatarPath)' alt='Profile'>" } elseif ($UserSession) { $UserSession.DisplayName.Substring(0,1).ToUpper() } else { "?" })
        </div>
        <div>
          <div class="mobile-user-name">$(if ($UserSession) { $UserSession.DisplayName } else { "Guest" })</div>
          <div class="mobile-user-role">$(if ($UserSession) { $UserSession.UserType } else { "Not logged in" })</div>
        </div>
      </div>
      <div class="mobile-menu-items">
        <a href="/" class="mobile-menu-item">
          <span class="material-icons-round mobile-menu-icon">home</span>
          Home
        </a>
        <a href="/videos" class="mobile-menu-item">
          <span class="material-icons-round mobile-menu-icon">movie</span>
          Movies & TV
        </a>
        <a href="/music" class="mobile-menu-item">
          <span class="material-icons-round mobile-menu-icon">library_music</span>
          Music
        </a>
        <a href="/playlists" class="mobile-menu-item">
          <span class="material-icons-round mobile-menu-icon">queue_music</span>
          Playlists
        </a>
        <a href="/analysis" class="mobile-menu-item">
          <span class="material-icons-round mobile-menu-icon">analytics</span>
          My Activity
        </a>
        $(if ($UserSession) { '<a href="/logout" class="mobile-menu-item danger" onclick="return confirm(''Are you sure you want to logout?'')"><span class="material-icons-round mobile-menu-icon">logout</span>Logout</a>' })
      </div>
    </div>
  </div>
  
  <!-- Mobile Bottom Navigation (v7.68) -->
  <nav class="mobile-bottom-nav">
    <div class="mobile-nav-items">
      <a href="/" class="mobile-nav-item$(if ($Title -eq 'NexusM - Home' -or $Title -eq 'PSMediaLibrary') { ' active' })">
        <span class="material-icons-round mobile-nav-icon">home</span>
        <span class="mobile-nav-label">Home</span>
      </a>
      <a href="/videos" class="mobile-nav-item$(if ($Title -match 'Movies|Videos') { ' active' })">
        <span class="material-icons-round mobile-nav-icon">video_library</span>
        <span class="mobile-nav-label">Library</span>
      </a>
      <a href="/music" class="mobile-nav-item$(if ($Title -match 'Music' -and $Title -notmatch 'Music Videos') { ' active' })">
        <span class="material-icons-round mobile-nav-icon">library_music</span>
        <span class="mobile-nav-label">Music</span>
      </a>
      $(if (-not $config -or $config.EbooksEnabled) { '<a href="/pdfs" class="mobile-nav-item' + $(if ($Title -match 'eBook|PDF') { ' active' } else { '' }) + '"><span class="material-icons-round mobile-nav-icon">menu_book</span><span class="mobile-nav-label">eBooks</span></a>' })
      <a href="/analysis" class="mobile-nav-item$(if ($Title -match 'Analysis') { ' active' })">
        <span class="material-icons-round mobile-nav-icon">person</span>
        <span class="mobile-nav-label">Profile</span>
      </a>
    </div>
  </nav>
  
  <!-- Mobile Mini Player (v7.68) -->
  <div class="mobile-mini-player" id="mobileMiniPlayer">
    <div class="mobile-mini-player-progress">
      <div class="mobile-mini-player-progress-fill" id="mobileProgressFill"></div>
    </div>
    <div class="mobile-mini-player-art" id="mobilePlayerArt"></div>
    <div class="mobile-mini-player-info" onclick="openFullPlayer()">
      <div class="mobile-mini-player-title" id="mobilePlayerTitle">No track playing</div>
      <div class="mobile-mini-player-artist" id="mobilePlayerArtist">-</div>
    </div>
    <div class="mobile-mini-player-controls">
      <button class="mobile-mini-player-btn play-btn" id="mobilePlayPauseBtn" onclick="toggleMobilePlayPause()">
        <span class="material-icons-round">play_arrow</span>
      </button>
      <button class="mobile-mini-player-btn" onclick="nextMobileTrack()">
        <span class="material-icons-round">skip_next</span>
      </button>
    </div>
  </div>
  
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <div>
          <strong>NexusM BETA v0.9</strong>
          <span>PowerShell Media Manager</span>
        </div>
      </div>

      <nav class="nav">
        <a href="/">
          <div class="left"><span class="ico"><img src="/menu/home.png" alt="Home"></span><span>Home</span></div>
          <span class="pill">Now</span>
        </a>
        <a href="/videos">
          <div class="left"><span class="ico"><img src="/menu/movie.png" alt="Videos"></span><span>Movies/TV Shows</span></div>
          <span class="pill">$($stats.TotalVideos)</span>
        </a>
        <a href="/music">
          <div class="left"><span class="ico"><img src="/menu/music.png" alt="Music"></span><span>Music</span></div>
          <span class="pill">$($stats.TotalMusic)</span>
        </a>
        $musicVideosLink
        $radioLink
        $internetTVLink
        $picturesLink
        $ebooksLink
        <a href="/analysis">
          <div class="left"><span class="ico"><img src="/menu/analysis.png" alt="Analysis"></span><span>Analysis</span></div>
          <span class="pill">Smart</span>
        </a>
        $settingsLink
      </nav>

      <div class="cta">
        <a class="btn" href="#" onclick="startRescan(); return false;"><span class="ico"><img src="/menu/scan.png" alt="Rescan"></span><span>Rescan Folders</span><span>➜</span></a>
        <a class="btn primary" href="/fetch-posters"><span class="ico"><img src="/menu/fetch.png" alt="Fetch"></span><span>Fetch Posters</span><span>➜</span></a>
      </div>
      
      <div class="status-panel">
        <div class="status-header">
          <div class="status-title">Status</div>
          <div class="status-ok">OK</div>
        </div>
        <div class="k">Storage used</div>
        <div class="v" style="margin-top:4px;">$($stats.TotalSizeGB) GB</div>
        <div class="k" style="margin-top:12px; line-height:1.6;">
          Video $($stats.VideoSizeGB) GB<br/>
          Music $($stats.MusicSizeGB) GB<br/>
          Pictures $($stats.PicturesSizeGB) GB<br/>
          PDFs $($stats.PDFSizeGB) GB
        </div>
        <div class="k" style="margin-top:16px; padding-top:12px; border-top: 1px solid rgba(255,255,255,0.1);">Media Shares</div>
        <div class="k" style="margin-top:8px; line-height:1.8; font-size: 12px;">
          $shareStatusHtml
        </div>
      </div>
      
      <div class="theme-switcher">
        <div class="theme-title">Color Theme</div>
        <div class="theme-buttons">
          <div class="theme-btn active" onclick="setTheme('green')" id="theme-green">
            <div class="theme-color green"></div>
            <span>Green</span>
          </div>
          <div class="theme-btn" onclick="setTheme('blue')" id="theme-blue">
            <div class="theme-color blue"></div>
            <span>Blue</span>
          </div>
          <div class="theme-btn" onclick="setTheme('purple')" id="theme-purple">
            <div class="theme-color purple"></div>
            <span>Purple</span>
          </div>
          <div class="theme-btn" onclick="setTheme('red')" id="theme-red">
            <div class="theme-color red"></div>
            <span>Red</span>
          </div>
        </div>
      </div>
      
      <!-- User Info & Logout -->
      $(if ($UserSession) {
        $avatarContent = if ($UserSession.AvatarPath) {
            "<img src='/avatar/$($UserSession.AvatarPath)' style='width:100%; height:100%; object-fit:cover; border-radius:50%;'>"
        } else {
            $UserSession.DisplayName.Substring(0,1).ToUpper()
        }
        @"
      <div class="user-panel">
        <div class="user-info">
          <div class="user-avatar">$avatarContent</div>
          <div class="user-details">
            <div class="user-name">$($UserSession.DisplayName)</div>
            <div class="user-role">$($UserSession.UserType)</div>
          </div>
        </div>
        <a href="/logout" class="logout-btn" onclick="return confirm('Are you sure you want to logout?')">
          <span>🚪</span> Logout
        </a>
      </div>
"@
      })
    </aside>

    <main class="main">
      $Content
    </main>
  </div>
  <script>
    // Load saved theme on page load
    (function() {
      const savedTheme = localStorage.getItem('psmedia-theme') || 'green';
      setTheme(savedTheme);
    })();
    
    function setTheme(theme) {
      // Remove all theme classes
      document.body.classList.remove('theme-blue', 'theme-purple', 'theme-red');
      
      // Add new theme class (green is default, no class needed)
      if (theme !== 'green') {
        document.body.classList.add('theme-' + theme);
      }
      
      // Update active button
      document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      const btn = document.getElementById('theme-' + theme);
      if (btn) btn.classList.add('active');
      
      // Save to localStorage
      localStorage.setItem('psmedia-theme', theme);
    }
    
    // ============================================
    // Notification Banner System
    // ============================================
    function showNotification(message, type, duration) {
      const banner = document.getElementById('notification-banner');
      if (!banner) return;
      
      // Set content based on type
      let icon = '';
      if (type === 'info') {
        icon = '<div class="spinner-small"></div>';
      } else if (type === 'success') {
        icon = '✓';
      } else if (type === 'error') {
        icon = '✗';
      }
      
      banner.innerHTML = icon + ' ' + message;
      banner.className = 'notification-banner ' + type;
      
      // Trigger reflow for animation
      banner.offsetHeight;
      banner.classList.add('show');
      
      // Auto-hide after duration (if specified)
      if (duration && duration > 0) {
        setTimeout(function() {
          hideNotification();
        }, duration);
      }
    }
    
    function hideNotification() {
      const banner = document.getElementById('notification-banner');
      if (banner) {
        banner.classList.remove('show');
      }
    }
    
    // ============================================
    // Rescan Folders Function
    // ============================================
    let isScanning = false;
    
    function startRescan() {
      if (isScanning) {
        showNotification('Scan already in progress...', 'info', 2000);
        return;
      }
      
      isScanning = true;
      
      // Show "scanning started" banner
      showNotification('Scanning media folders...', 'info', 0);
      
      // Hide the initial banner after 3.5 seconds
      setTimeout(function() {
        hideNotification();
      }, 3500);
      
      // Start the actual scan via API
      fetch('/api/rescan', { method: 'POST' })
        .then(function(response) { return response.json(); })
        .then(function(data) {
          isScanning = false;
          if (data.success) {
            showNotification('Media scan completed successfully!', 'success', 4000);
          } else {
            showNotification('Scan failed: ' + (data.error || 'Unknown error'), 'error', 4000);
          }
        })
        .catch(function(err) {
          isScanning = false;
          showNotification('Scan failed: ' + err.message, 'error', 4000);
        });
    }
    
    // ============================================
    // Mobile Navigation Functions (v7.37)
    // ============================================
    
    // Mobile Search
    function openMobileSearch() {
      const overlay = document.getElementById('mobile-search-overlay');
      if (overlay) {
        overlay.classList.add('show');
        const input = document.getElementById('mobile-search-input');
        if (input) {
          setTimeout(() => input.focus(), 100);
        }
      }
    }
    
    function closeMobileSearch() {
      const overlay = document.getElementById('mobile-search-overlay');
      if (overlay) {
        overlay.classList.remove('show');
      }
    }
    
    // Mobile search input handler
    const mobileSearchInput = document.getElementById('mobile-search-input');
    if (mobileSearchInput) {
      mobileSearchInput.addEventListener('keyup', function(e) {
        if (e.key === 'Enter' && this.value.trim()) {
          window.location.href = '/search?q=' + encodeURIComponent(this.value.trim());
        }
      });
    }
    
    // Close overlays on escape
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeMobileSearch();
        closeMobileUserMenu();
      }
    });
    
    // Mobile User Menu
    function openMobileUserMenu() {
      const menu = document.getElementById('mobile-user-menu');
      if (menu) {
        menu.classList.add('show');
        document.body.style.overflow = 'hidden';
      }
    }
    
    function closeMobileUserMenu(event) {
      const menu = document.getElementById('mobile-user-menu');
      if (menu) {
        menu.classList.remove('show');
        document.body.style.overflow = '';
      }
    }
    
    // ==================== MOBILE MINI-PLAYER (v7.68) ====================
    // These functions integrate with the music page player when on mobile
    var mobileMiniPlayer = document.getElementById('mobileMiniPlayer');
    var mobilePlayerTitle = document.getElementById('mobilePlayerTitle');
    var mobilePlayerArtist = document.getElementById('mobilePlayerArtist');
    var mobilePlayerArt = document.getElementById('mobilePlayerArt');
    var mobilePlayPauseBtn = document.getElementById('mobilePlayPauseBtn');
    var mobileProgressFill = document.getElementById('mobileProgressFill');
    
    function showMobileMiniPlayer(title, artist, artUrl) {
      if (mobileMiniPlayer && window.innerWidth <= 768) {
        mobilePlayerTitle.textContent = title || 'Unknown';
        mobilePlayerArtist.textContent = artist || 'Unknown Artist';
        if (artUrl) {
          mobilePlayerArt.style.backgroundImage = 'url(' + artUrl + ')';
        }
        mobileMiniPlayer.classList.add('active');
        document.body.classList.add('mini-player-active');
      }
    }
    
    function hideMobileMiniPlayer() {
      if (mobileMiniPlayer) {
        mobileMiniPlayer.classList.remove('active');
        document.body.classList.remove('mini-player-active');
      }
    }
    
    function updateMobileMiniPlayer(isPlaying, progress) {
      if (mobilePlayPauseBtn) {
        mobilePlayPauseBtn.innerHTML = isPlaying ? 
          '<span class="material-icons-round">pause</span>' : 
          '<span class="material-icons-round">play_arrow</span>';
      }
      if (mobileProgressFill && typeof progress === 'number') {
        mobileProgressFill.style.width = progress + '%';
      }
    }
    
    function toggleMobilePlayPause() {
      // This will be overridden by the music page's player
      if (typeof togglePlayPause === 'function') {
        togglePlayPause();
      }
    }
    
    function nextMobileTrack() {
      // This will be overridden by the music page's player
      if (typeof nextTrack === 'function') {
        nextTrack();
      }
    }
    
    function openFullPlayer() {
      // Navigate to music page or expand player (can be customized)
      window.location.href = '/music';
    }
    
    // Detect mobile and adjust UI
    function isMobileDevice() {
      return window.innerWidth <= 768;
    }
    
    // Handle resize events
    window.addEventListener('resize', function() {
      if (!isMobileDevice()) {
        hideMobileMiniPlayer();
      }
    });
  </script>
</body>
</html>
"@
}

function Get-HomePage {
    param(
        [string[]]$SortParams = @('rating', 'date')
    )
    
    # Calculate date 7 days ago for "recently added" queries
    $sevenDaysAgo = (Get-Date).AddDays(-7).ToString("yyyy-MM-dd HH:mm:ss")
    
    # Build ORDER BY clause based on selected sort options
    $orderByParts = @()
    if ($SortParams -contains 'rating') {
        $orderByParts += 'rating DESC'
    }
    if ($SortParams -contains 'date') {
        $orderByParts += 'date_added DESC'
    }
    
    # Default to rating if nothing selected
    if ($orderByParts.Count -eq 0) {
        $orderByParts += 'date_added DESC'
    }
    
    
    # Set checkbox states based on parameters
    $bestRatedChecked = if ($SortParams -contains 'rating') { 'checked' } else { '' }
    $newestChecked = if ($SortParams -contains 'date') { 'checked' } else { '' }
    
    # ============================================================================
    # USER FAVORITES & WATCHED STATUS (v3.8)
    # ============================================================================
    
    $userFavorites = @()
    $userWatched = @()
    $favoritesLookup = @{}
    $watchedLookup = @{}
    
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get all favorites
                $userFavorites = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM favorites ORDER BY added_date DESC")
                foreach ($fav in $userFavorites) {
                    $key = "$($fav.media_type)_$($fav.media_id)"
                    $favoritesLookup[$key] = $true
                }
                
                # Get all watched items
                $userWatched = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM watched ORDER BY watched_date DESC")
                foreach ($w in $userWatched) {
                    $key = "$($w.media_type)_$($w.media_id)"
                    $watchedLookup[$key] = $true
                }
            } catch {
                Write-Host "[!] Error loading user favorites/watched: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # ============================================================================
    # FAVORITES SECTION - Show all user favorites at top (v6.99 - increased limits)
    # ============================================================================
    
    $favoritesSectionHtml = ""
    
    if ($userFavorites -and $userFavorites.Count -gt 0) {
        # v6.99: Group favorites by media type, limit 100 per category
        $favoritesByType = @{}
        foreach ($fav in $userFavorites) {
            $type = $fav.media_type
            if (-not $favoritesByType.ContainsKey($type)) {
                $favoritesByType[$type] = @()
            }
            # Limit to 100 per category
            if ($favoritesByType[$type].Count -lt 100) {
                $favoritesByType[$type] += $fav
            }
        }
        
        $favItemsHtml = ""
        $favCount = 0
        
        # Process favorites (limited to 100 per type)
        $allLimitedFavorites = @()
        foreach ($type in $favoritesByType.Keys) {
            $allLimitedFavorites += $favoritesByType[$type]
        }
        $favCount = $allLimitedFavorites.Count
        
        foreach ($fav in $allLimitedFavorites) {
            # v5.3 FIX: ALWAYS look up poster from source database for accurate thumbnails
            # The favorites table may have stale or incorrect poster_url values
            $posterUrl = $null
            
            # Get current poster from source database
            switch ($fav.media_type) {
                'movie' {
                    if ($fav.media_id) {
                        $sourceVideo = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT poster_url, backdrop_url FROM videos WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceVideo) {
                            $posterUrl = if ($sourceVideo.backdrop_url) { $sourceVideo.backdrop_url } elseif ($sourceVideo.poster_url) { $sourceVideo.poster_url } else { $null }
                        }
                    }
                }
                'tv' {
                    if ($fav.media_id) {
                        $sourceVideo = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT poster_url, backdrop_url FROM videos WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceVideo) {
                            $posterUrl = if ($sourceVideo.backdrop_url) { $sourceVideo.backdrop_url } elseif ($sourceVideo.poster_url) { $sourceVideo.poster_url } else { $null }
                        }
                    }
                }
                'music' {
                    if ($fav.media_id) {
                        $sourceMusic = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT album_art_cached, album_art_url FROM music WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceMusic) {
                            $posterUrl = if ($sourceMusic.album_art_cached) { $sourceMusic.album_art_cached } elseif ($sourceMusic.album_art_url) { $sourceMusic.album_art_url } else { $null }
                        }
                    }
                }
                'musicvideo' {
                    if ($fav.media_id -and $CONFIG.MusicVideosEnabled -and (Test-Path $CONFIG.MusicVideosDB)) {
                        $sourceMV = Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT thumbnail_path FROM musicvideos WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceMV -and $sourceMV.thumbnail_path) {
                            $posterUrl = $sourceMV.thumbnail_path
                        }
                    }
                }
                'picture' {
                    if ($fav.media_id) {
                        $sourcePic = Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT thumbnail_path FROM images WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourcePic -and $sourcePic.thumbnail_path) {
                            $posterUrl = $sourcePic.thumbnail_path
                        }
                    }
                }
                'pdf' {
                    if ($fav.media_id) {
                        $sourcePdf = Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT preview_image FROM pdfs WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourcePdf -and $sourcePdf.preview_image) {
                            $posterUrl = $sourcePdf.preview_image
                        }
                    }
                }
            }
            
            # Determine poster style based on media type with correct URL prefixes
            $posterStyle = if ($posterUrl -and -not [string]::IsNullOrWhiteSpace($posterUrl)) {
                switch ($fav.media_type) {
                    'movie' { "background-image: url('/poster/$posterUrl');" }
                    'tv' { "background-image: url('/poster/$posterUrl');" }
                    'musicvideo' { "background-image: url('/mvthumb/$posterUrl');" }
                    'music' { 
                        # Music can use albumart or poster depending on what was stored
                        if ($posterUrl -match '\.jpg$|\.png$|\.jpeg$') {
                            "background-image: url('/albumart/$posterUrl');"
                        } else {
                            "background-image: url('/poster/$posterUrl');"
                        }
                    }
                    'picture' { "background-image: url('/picthumb/$posterUrl');" }
                    'pdf' { "background-image: url('/pdfthumb/$posterUrl');" }
                    default { "background-image: url('/poster/$posterUrl');" }
                }
            } else {
                # Fallback gradient colors based on media type
                switch ($fav.media_type) {
                    'movie' { "background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.2));" }
                    'tv' { "background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(37,99,235,0.2));" }
                    'musicvideo' { "background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(99,102,241,0.2));" }
                    'music' { "background: linear-gradient(135deg, rgba(251,146,60,0.3), rgba(234,88,12,0.2));" }
                    'picture' { "background: linear-gradient(135deg, rgba(236,72,153,0.3), rgba(219,39,119,0.2));" }
                    'pdf' { "background: linear-gradient(135deg, rgba(245,158,11,0.3), rgba(217,119,6,0.2));" }
                    'radio' { "background: linear-gradient(135deg, rgba(16,185,129,0.3), rgba(5,150,105,0.2));" }
                    'tvchannel' { "background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(79,70,229,0.2));" }
                    default { "background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.2));" }
                }
            }
            
            # Determine link based on media type (v5.1 fix - movies/tv go directly to player, radio uses stream URL)
            $link = switch ($fav.media_type) {
                'movie' { "/player/$($fav.media_id)" }
                'tv' { "/player/$($fav.media_id)" }
                'musicvideo' { "/play-musicvideo/$($fav.media_id)" }
                'music' { "/play-audio/$($fav.media_id)" }
                'picture' { "/view-image?path=$([Uri]::EscapeDataString($fav.filepath))" }
                'pdf' { "/view-pdf?path=$([System.Web.HttpUtility]::UrlEncode($fav.filepath))" }
                'radio' { "/radio?play=$([Uri]::EscapeDataString($fav.filepath))" }
                'tvchannel' { "/tv?play=$([Uri]::EscapeDataString($fav.filepath))" }
                default { "#" }
            }
            
            $badge = switch ($fav.media_type) {
                'movie' { "🎬" }
                'tv' { "📺" }
                'musicvideo' { "🎵" }
                'music' { "🎧" }
                'picture' { "🖼️" }
                'pdf' { "📚" }
                'radio' { "📻" }
                'tvchannel' { "📡" }
                default { "⭐" }
            }
            
            
            $favItemsHtml += @"
<div class="genre-item favorite-item" data-media-type="$($fav.media_type)" data-media-id="$($fav.media_id)">
    <a href="$link" class="genre-poster-link">
        <div class="genre-poster" style="$posterStyle">
            <div class="genre-overlay">
                <div class="genre-title">$($fav.title)</div>
            </div>
            <div class="genre-badge">$badge</div>
            <div class="fav-badge">♥</div>
        </div>
    </a>
</div>
"@
        }
        
        $showArrows = $favCount -gt 5
        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
        
        $favoritesSectionHtml = @"
<section class="genre-row recent-section favorites-section">
    <div class="genre-header">
        <span class="section-icon">❤️</span>
        <h2 class="genre-name">My Favorites</h2>
        <span class="genre-count">$favCount items</span>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $favItemsHtml
        </div>
    </div>
</section>
"@
    }
    
    # ============================================================================
    # CONTINUE WATCHING SECTION - Videos in progress (v5.6)
    # ============================================================================
    
    $continueWatchingSectionHtml = ""
    
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get videos that are in progress (not completed, have position > 30 seconds, < 90% watched)
                $inProgressVideos = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT * FROM video_progress 
WHERE completed = 0 
  AND last_position_seconds > 30 
  AND percent_watched < 90
  AND percent_watched > 0
ORDER BY last_watched DESC 
LIMIT 10
"@
                if ($inProgressVideos -and @($inProgressVideos).Count -gt 0) {
                    $continueCount = @($inProgressVideos).Count
                    $continueItemsHtml = ""
                    
                    # Build lists of video IDs for batch query
                    $videoIds = @($inProgressVideos | Where-Object { $_.video_id -and $_.video_id -gt 0 } | ForEach-Object { $_.video_id }) -join ','
                    
                    # Create a hashtable for quick lookup of video details
                    $videoDetailsMap = @{}
                    
                    # Batch query by ID
                    if ($videoIds) {
                        $idQuery = "SELECT * FROM videos WHERE id IN ($videoIds)"
                        $videosByIds = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query $idQuery
                        foreach ($vid in $videosByIds) {
                            $videoDetailsMap[$vid.id.ToString()] = $vid
                            $videoDetailsMap[$vid.filepath] = $vid
                        }
                    }
                    
                    # For any videos not found by ID, try by filepath
                    foreach ($prog in $inProgressVideos) {
                        $found = $false
                        if ($prog.video_id -and $videoDetailsMap.ContainsKey($prog.video_id.ToString())) {
                            $found = $true
                        } elseif ($prog.video_path -and $videoDetailsMap.ContainsKey($prog.video_path)) {
                            $found = $true
                        }
                        
                        if (-not $found -and $prog.video_path) {
                            $videoDetails = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE filepath = @path LIMIT 1" -SqlParameters @{ path = $prog.video_path }
                            if ($videoDetails) {
                                $videoDetailsMap[$prog.video_path] = $videoDetails
                            }
                        }
                    }
                    
                    # Build the HTML
                    foreach ($prog in $inProgressVideos) {
                        $videoDetails = $null
                        if ($prog.video_id -and $videoDetailsMap.ContainsKey($prog.video_id.ToString())) {
                            $videoDetails = $videoDetailsMap[$prog.video_id.ToString()]
                        } elseif ($prog.video_path -and $videoDetailsMap.ContainsKey($prog.video_path)) {
                            $videoDetails = $videoDetailsMap[$prog.video_path]
                        }
                        
                        if ($videoDetails) {
                            $posterUrl = if ($videoDetails.poster_url) { "/poster/$($videoDetails.poster_url)" } else { "" }
                            $posterStyle = if ($posterUrl) { "background-image: url('$posterUrl');" } else { "background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.2));" }
                            $progressPercent = [math]::Round($prog.percent_watched, 0)
                            $remainingMins = if ($prog.duration_seconds -and $prog.last_position_seconds) {
                                [math]::Round(($prog.duration_seconds - $prog.last_position_seconds) / 60, 0)
                            } else { "?" }
                            
                            $continueItemsHtml += @"
<div class="genre-item continue-item-home">
    <a href="/player/$($videoDetails.id)?resume=1" class="genre-poster-link">
        <div class="genre-poster" style="$posterStyle">
            <div class="continue-progress-bar-home">
                <div class="continue-progress-fill-home" style="width: ${progressPercent}%"></div>
            </div>
            <div class="genre-overlay">
                <div class="genre-title">$($videoDetails.title)</div>
                <div class="continue-meta-home">${remainingMins} min left</div>
            </div>
            <div class="genre-badge">▶</div>
        </div>
    </a>
</div>
"@
                        }
                    }
                    
                    if ($continueItemsHtml) {
                        $showArrows = $continueCount -gt 5
                        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
                        
                        $continueWatchingSectionHtml = @"
<section class="genre-row recent-section continue-watching-home-section">
    <div class="genre-header">
        <span class="section-icon">▶️</span>
        <h2 class="genre-name">Continue Watching</h2>
        <span class="genre-count">$continueCount items</span>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $continueItemsHtml
        </div>
    </div>
</section>
"@
                    }
                }
            } catch {
                Write-Host "[!] Home page Continue Watching error: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # ============================================================================
    # RECENTLY ADDED SECTIONS - Last 7 days, limited to 30 items each
    # ============================================================================
    
    $recentSectionsHtml = ""
    
    # --- RECENT MOVIES (last 7 days) ---
    $recentMovies = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
SELECT * FROM videos 
WHERE (media_type = 'movie' OR media_type IS NULL) 
  AND date_added >= @cutoffDate
ORDER BY date_added DESC
LIMIT 30
"@ -SqlParameters @{ cutoffDate = $sevenDaysAgo }
    
    if ($recentMovies -and @($recentMovies).Count -gt 0) {
        $movieItemsHtml = ""
        $movieCount = @($recentMovies).Count
        
        foreach ($video in $recentMovies) {
            $posterUrl = if ($video.poster_url) { "/poster/$($video.poster_url)" } else { "" }
            $backdropUrl = if ($video.backdrop_url) { "/poster/$($video.backdrop_url)" } else { $posterUrl }
            $imageUrl = if ($backdropUrl) { $backdropUrl } elseif ($posterUrl) { $posterUrl } else { "" }
            $imageStyle = if ($imageUrl) { "background-image: url('$imageUrl');" } else { "background: linear-gradient(135deg, rgba(239,68,68,0.3), rgba(220,38,38,0.2));" }
            
            $posterUrlEscaped = ($video.poster_url -replace "'", "\'") -replace '"', '&quot;'
            $isWatched = $watchedLookup["movie_$($video.id)"]
            
            $movieItemsHtml += @"
<div class="genre-item" data-media-type="movie" data-media-id="$($video.id)">
    <a href="/movie/$($video.id)" class="genre-poster-link">
        <div class="genre-poster" style="$imageStyle">
            <div class="genre-overlay">
                <div class="genre-title">$($video.title)</div>
            </div>
            <div class="genre-badge">🎬</div>
            <div class="new-badge">NEW</div>
        </div>
    </a>
</div>
"@
        }
        
        $showArrows = $movieCount -gt 5
        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
        
        $recentSectionsHtml += @"
<section class="genre-row recent-section">
    <div class="genre-header">
        <span class="section-icon">🎬</span>
        <h2 class="genre-name">Recently Added Movies</h2>
        <span class="genre-count">$movieCount new this week</span>
        <a href="/videos?filter=movies" class="see-all-link">See All →</a>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $movieItemsHtml
        </div>
    </div>
</section>
"@
    }
    
    # --- RECENT TV SERIES (last 7 days) ---
    $recentTV = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
SELECT * FROM videos 
WHERE media_type = 'tv' 
  AND date_added >= @cutoffDate
ORDER BY date_added DESC
LIMIT 30
"@ -SqlParameters @{ cutoffDate = $sevenDaysAgo }
    
    if ($recentTV -and @($recentTV).Count -gt 0) {
        $tvItemsHtml = ""
        $tvCount = @($recentTV).Count
        
        foreach ($video in $recentTV) {
            $posterUrl = if ($video.poster_url) { "/poster/$($video.poster_url)" } else { "" }
            $backdropUrl = if ($video.backdrop_url) { "/poster/$($video.backdrop_url)" } else { $posterUrl }
            $imageUrl = if ($backdropUrl) { $backdropUrl } elseif ($posterUrl) { $posterUrl } else { "" }
            $imageStyle = if ($imageUrl) { "background-image: url('$imageUrl');" } else { "background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(37,99,235,0.2));" }
            
            $posterUrlEscaped = ($video.poster_url -replace "'", "\'") -replace '"', '&quot;'
            $isWatched = $watchedLookup["tv_$($video.id)"]
            
            $tvItemsHtml += @"
<div class="genre-item" data-media-type="tv" data-media-id="$($video.id)">
    <a href="/movie/$($video.id)" class="genre-poster-link">
        <div class="genre-poster" style="$imageStyle">
            <div class="genre-overlay">
                <div class="genre-title">$($video.title)</div>
            </div>
            <div class="genre-badge">📺</div>
            <div class="new-badge">NEW</div>
        </div>
    </a>
</div>
"@
        }
        
        $showArrows = $tvCount -gt 5
        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
        
        $recentSectionsHtml += @"
<section class="genre-row recent-section">
    <div class="genre-header">
        <span class="section-icon">📺</span>
        <h2 class="genre-name">Recently Added TV Series</h2>
        <span class="genre-count">$tvCount new this week</span>
        <a href="/videos?filter=tvshows" class="see-all-link">See All →</a>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $tvItemsHtml
        </div>
    </div>
</section>
"@
    }
    
    # --- LATEST EBOOKS/PDFs - Only if enabled in config ---
    if (-not $CONFIG -or $CONFIG.EbooksEnabled) {
        $latestEbooks = Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query @"
SELECT * FROM pdfs 
ORDER BY date_added DESC
LIMIT 30
"@
        
        if ($latestEbooks -and @($latestEbooks).Count -gt 0) {
        $ebookItemsHtml = ""
        $ebookCount = @($latestEbooks).Count
        
        foreach ($ebook in $latestEbooks) {
            $previewStyle = if ($ebook.preview_image -and -not [string]::IsNullOrWhiteSpace($ebook.preview_image)) {
                "background-image: url('/ebookcover/$($ebook.preview_image)');"
            } else {
                "background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(22,163,74,0.2));"
            }
            
            $displayTitle = if ($ebook.title -and -not [string]::IsNullOrWhiteSpace($ebook.title)) { $ebook.title } else { $ebook.filename }
            $authorDisplay = if ($ebook.author -and -not [string]::IsNullOrWhiteSpace($ebook.author)) { $ebook.author } else { "" }
            
            # Determine file type and correct link
            $fileExt = [System.IO.Path]::GetExtension($ebook.filename).ToLower()
            $encodedPath = [System.Web.HttpUtility]::UrlEncode($ebook.filepath)
            $ebookLink = if ($fileExt -eq ".epub") {
                "/read-epub?path=$encodedPath"
            } else {
                "/view-pdf?path=$encodedPath"
            }
            $linkTarget = if ($fileExt -eq ".epub") { "" } else { "target='_blank'" }
            
            $typeBadge = switch ($fileExt) {
                ".epub" { "📖" }
                ".pdf" { "📄" }
                ".mobi" { "📱" }
                default { "📚" }
            }
            
            
            $ebookItemsHtml += @"
<div class="genre-item" data-media-type="pdf" data-media-id="$($ebook.id)">
    <a href="$ebookLink" $linkTarget class="genre-poster-link">
        <div class="genre-poster ebook-poster" style="$previewStyle">
            <div class="genre-overlay">
                <div class="genre-title">$displayTitle</div>
                $(if ($authorDisplay) { "<div class='genre-subtitle'>$authorDisplay</div>" })
            </div>
            <div class="genre-badge">$typeBadge</div>
        </div>
    </a>
</div>
"@
        }
        
        $showArrows = $ebookCount -gt 5
        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
        
        $recentSectionsHtml += @"
<section class="genre-row recent-section">
    <div class="genre-header">
        <span class="section-icon">📚</span>
        <h2 class="genre-name">Latest eBooks</h2>
        <span class="genre-count">$ebookCount items</span>
        <a href="/pdfs" class="see-all-link">See All →</a>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $ebookItemsHtml
        </div>
    </div>
</section>
"@
        }
    }
    
    # --- LATEST PICTURES - Only if enabled in config ---
    if (-not $CONFIG -or $CONFIG.PicturesEnabled) {
        $latestPictures = Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query @"
SELECT * FROM images 
ORDER BY date_added DESC
LIMIT 30
"@
        
        if ($latestPictures -and @($latestPictures).Count -gt 0) {
        $pictureItemsHtml = ""
        $pictureCount = @($latestPictures).Count
        
        foreach ($picture in $latestPictures) {
            # Use EscapeDataString for proper encoding of UNC paths
            $encodedPath = [Uri]::EscapeDataString($picture.filepath)
            
            # v5.3 FIX: Use thumbnail if available, otherwise fall back to on-the-fly thumb
            $thumbStyle = ""
            if ($picture.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($picture.thumbnail_path)) {
                $thumbStyle = "background-image: url('/picthumb/$($picture.thumbnail_path)');"
            } else {
                # Fallback to on-the-fly thumbnail (slower)
                $thumbStyle = "background-image: url('/thumb/$encodedPath');"
            }
            
            
            $pictureItemsHtml += @"
<div class="genre-item" data-media-type="picture" data-media-id="$($picture.id)">
    <a href="/view-image?path=$encodedPath" target="_blank" class="genre-poster-link">
        <div class="genre-poster picture-poster" style="$thumbStyle">
            <div class="genre-overlay picture-overlay">
                <div class="genre-title">$($picture.filename)</div>
                <div class="genre-subtitle">$($picture.width)x$($picture.height)</div>
            </div>
            <div class="genre-badge">🖼️</div>
        </div>
    </a>
</div>
"@
        }
        
        $showArrows = $pictureCount -gt 5
        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
        
        $recentSectionsHtml += @"
<section class="genre-row recent-section">
    <div class="genre-header">
        <span class="section-icon">🖼️</span>
        <h2 class="genre-name">Latest Pictures</h2>
        <span class="genre-count">$pictureCount items</span>
        <a href="/pictures" class="see-all-link">See All →</a>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $pictureItemsHtml
        </div>
    </div>
</section>
"@
        }
    }
    
    # --- RECENT MUSIC VIDEOS (last 7 days) - Only if enabled ---
    if ($CONFIG.MusicVideosEnabled -and $CONFIG.MusicVideosDB -and (Test-Path $CONFIG.MusicVideosDB)) {
        $recentMusicVideos = Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query @"
SELECT * FROM musicvideos 
WHERE date_added >= @cutoffDate
ORDER BY date_added DESC
LIMIT 30
"@ -SqlParameters @{ cutoffDate = $sevenDaysAgo }
        
        if ($recentMusicVideos -and @($recentMusicVideos).Count -gt 0) {
            $mvItemsHtml = ""
            $mvCount = @($recentMusicVideos).Count
            
            foreach ($mv in $recentMusicVideos) {
                # v5.3 FIX: Use correct column name thumbnail_path (not thumbnail)
                $thumbStyle = if ($mv.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($mv.thumbnail_path)) {
                    "background-image: url('/mvthumb/$($mv.thumbnail_path)');"
                } elseif ($mv.poster_url -and -not [string]::IsNullOrWhiteSpace($mv.poster_url)) {
                    "background-image: url('/poster/$($mv.poster_url)');"
                } else {
                    "background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(139,92,246,0.2));"
                }
                
                $artistDisplay = if ($mv.artist -and -not [string]::IsNullOrWhiteSpace($mv.artist)) { $mv.artist } else { "Unknown Artist" }
                
                $posterUrlEscaped = if ($mv.thumbnail_path) { $mv.thumbnail_path } elseif ($mv.poster_url) { $mv.poster_url } else { "" }
                $posterUrlEscaped = ($posterUrlEscaped -replace "'", "\'") -replace '"', '&quot;'
                $isWatched = $watchedLookup["musicvideo_$($mv.id)"]
                
                $mvItemsHtml += @"
<div class="genre-item" data-media-type="musicvideo" data-media-id="$($mv.id)">
    <a href="/play-musicvideo/$($mv.id)" class="genre-poster-link">
        <div class="genre-poster" style="$thumbStyle">
            <div class="genre-overlay">
                <div class="genre-title">$($mv.title)</div>
                <div class="genre-subtitle">$artistDisplay</div>
            </div>
            <div class="genre-badge">🎵</div>
            <div class="new-badge">NEW</div>
        </div>
    </a>
</div>
"@
            }
            
            $showArrows = $mvCount -gt 5
            $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
            
            $recentSectionsHtml += @"
<section class="genre-row recent-section">
    <div class="genre-header">
        <span class="section-icon">🎵</span>
        <h2 class="genre-name">Recently Added Music Videos</h2>
        <span class="genre-count">$mvCount new this week</span>
        <a href="/musicvideos" class="see-all-link">See All →</a>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $mvItemsHtml
        </div>
    </div>
</section>
"@
        }
    }
    
    # --- RECENT MUSIC (last 7 days) ---
    $recentMusic = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
SELECT * FROM music 
WHERE date_added >= @cutoffDate
ORDER BY date_added DESC
LIMIT 30
"@ -SqlParameters @{ cutoffDate = $sevenDaysAgo }
    
    if ($recentMusic -and @($recentMusic).Count -gt 0) {
        $musicItemsHtml = ""
        $musicCount = @($recentMusic).Count
        
        foreach ($track in $recentMusic) {
            $artStyle = ""
            if ($track.album_art_cached -and -not [string]::IsNullOrWhiteSpace($track.album_art_cached)) {
                $artStyle = "background-image: url('/albumart/$($track.album_art_cached)');"
            } elseif ($track.album_art_url -and -not [string]::IsNullOrWhiteSpace($track.album_art_url)) {
                $artStyle = "background-image: url('/poster/$($track.album_art_url)');"
            } else {
                $artStyle = "background: linear-gradient(135deg, rgba(251,146,60,0.3), rgba(234,88,12,0.2));"
            }
            
            $artistDisplay = if ($track.artist -and -not [string]::IsNullOrWhiteSpace($track.artist)) { $track.artist } else { "Unknown Artist" }
            
            $posterUrlEscaped = if ($track.album_art_cached) { $track.album_art_cached } elseif ($track.album_art_url) { $track.album_art_url } else { "" }
            $posterUrlEscaped = ($posterUrlEscaped -replace "'", "\'") -replace '"', '&quot;'
            
            $musicItemsHtml += @"
<div class="genre-item" data-media-type="music" data-media-id="$($track.id)">
    <a href="/play-audio/$($track.id)" class="genre-poster-link">
        <div class="genre-poster music-poster" style="$artStyle">
            <div class="genre-overlay">
                <div class="genre-title">$($track.title)</div>
                <div class="genre-subtitle">$artistDisplay</div>
            </div>
            <div class="genre-badge">🎧</div>
            <div class="new-badge">NEW</div>
        </div>
    </a>
</div>
"@
        }
        
        $showArrows = $musicCount -gt 5
        $arrowsHtml = if ($showArrows) { '<button class="scroll-btn scroll-left" onclick="scrollGenre(this, -1)">‹</button><button class="scroll-btn scroll-right" onclick="scrollGenre(this, 1)">›</button>' } else { "" }
        
        $recentSectionsHtml += @"
<section class="genre-row recent-section">
    <div class="genre-header">
        <span class="section-icon">🎧</span>
        <h2 class="genre-name">Recently Added Music</h2>
        <span class="genre-count">$musicCount new this week</span>
        <a href="/music" class="see-all-link">See All →</a>
    </div>
    <div class="genre-scroll-container">
        $arrowsHtml
        <div class="genre-items">
            $musicItemsHtml
        </div>
    </div>
</section>
"@
    }
    
    # ============================================================================
    # MOBILE HTML GENERATION (v7.37) - Premium mobile layout with portrait cards
    # ============================================================================
    
    # Mobile Hero Section - Featured content (show top-rated or most recent movie)
    $mobileHeroHtml = ""
    $featuredVideo = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE poster_url IS NOT NULL ORDER BY rating DESC, date_added DESC LIMIT 1"
    if ($featuredVideo) {
        $heroImage = if ($featuredVideo.backdrop_url) { "/poster/$($featuredVideo.backdrop_url)" } elseif ($featuredVideo.poster_url) { "/poster/$($featuredVideo.poster_url)" } else { "" }
        if ($heroImage) {
            $mobileHeroHtml = @"
<section class="mobile-hero">
    <div class="mobile-hero-card">
        <img src="$heroImage" alt="$($featuredVideo.title)" class="mobile-hero-image">
        <div class="mobile-hero-overlay">
            <span class="mobile-hero-badge">Featured</span>
            <h2 class="mobile-hero-title">$($featuredVideo.title)</h2>
            <div class="mobile-hero-actions">
                <a href="/player/$($featuredVideo.id)" class="mobile-hero-btn primary">
                    <span class="material-icons-round" style="font-size:18px;">play_arrow</span> Play
                </a>
                <a href="/movie/$($featuredVideo.id)" class="mobile-hero-btn secondary">
                    <span class="material-icons-round" style="font-size:18px;">info</span> Info
                </a>
            </div>
        </div>
    </div>
</section>
"@
        }
    }
    
    # Mobile Favorites Section
    $mobileFavoritesHtml = ""
    if ($userFavorites -and $userFavorites.Count -gt 0) {
        $mobileFavCards = ""
        $favLimit = [Math]::Min($userFavorites.Count, 10)
        for ($i = 0; $i -lt $favLimit; $i++) {
            $fav = $userFavorites[$i]
            $posterUrl = $null
            $link = "#"
            
            switch ($fav.media_type) {
                'movie' {
                    if ($fav.media_id) {
                        $sourceVideo = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT poster_url, backdrop_url FROM videos WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceVideo) {
                            $posterUrl = if ($sourceVideo.backdrop_url) { "/poster/$($sourceVideo.backdrop_url)" } elseif ($sourceVideo.poster_url) { "/poster/$($sourceVideo.poster_url)" } else { $null }
                        }
                        $link = "/player/$($fav.media_id)"
                    }
                }
                'tv' {
                    if ($fav.media_id) {
                        $sourceVideo = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT poster_url, backdrop_url FROM videos WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceVideo) {
                            $posterUrl = if ($sourceVideo.backdrop_url) { "/poster/$($sourceVideo.backdrop_url)" } elseif ($sourceVideo.poster_url) { "/poster/$($sourceVideo.poster_url)" } else { $null }
                        }
                        $link = "/player/$($fav.media_id)"
                    }
                }
                'musicvideo' {
                    if ($fav.media_id -and $CONFIG.MusicVideosEnabled -and (Test-Path $CONFIG.MusicVideosDB)) {
                        $sourceMV = Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT thumbnail_path FROM musicvideos WHERE id = @id" -SqlParameters @{ id = $fav.media_id }
                        if ($sourceMV -and $sourceMV.thumbnail_path) {
                            $posterUrl = "/mvthumb/$($sourceMV.thumbnail_path)"
                        }
                        $link = "/play-musicvideo/$($fav.media_id)"
                    }
                }
            }
            
            if ($posterUrl) {
                $mobileFavCards += @"
<a href="$link" class="mobile-favorites-card">
    <div class="mobile-favorites-poster">
        <img src="$posterUrl" alt="$($fav.title)">
        <span class="mobile-favorites-heart">❤️</span>
    </div>
    <div class="mobile-favorites-title">$($fav.title)</div>
</a>
"@
            }
        }
        
        if ($mobileFavCards) {
            $mobileFavoritesHtml = @"
<section class="mobile-section">
    <div class="mobile-section-header">
        <h3 class="mobile-section-title"><span class="icon">❤️</span> My Favorites</h3>
        <span class="mobile-section-count">$($userFavorites.Count) items</span>
    </div>
    <div class="mobile-favorites-scroll hide-scrollbar">
        $mobileFavCards
    </div>
</section>
"@
        }
    }
    
    # Mobile Continue Watching Section
    $mobileContinueWatchingHtml = ""
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                $inProgressVideos = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT * FROM video_progress 
WHERE completed = 0 AND last_position_seconds > 30 AND percent_watched < 90 AND percent_watched > 0
ORDER BY last_watched DESC LIMIT 10
"@
                if ($inProgressVideos -and @($inProgressVideos).Count -gt 0) {
                    $mobileContinueCards = ""
                    $continueCount = @($inProgressVideos).Count
                    
                    foreach ($prog in $inProgressVideos) {
                        $videoDetails = $null
                        if ($prog.video_id) {
                            $videoDetails = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE id = @id LIMIT 1" -SqlParameters @{ id = $prog.video_id }
                        }
                        if (-not $videoDetails -and $prog.video_path) {
                            $videoDetails = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE filepath = @path LIMIT 1" -SqlParameters @{ path = $prog.video_path }
                        }
                        
                        if ($videoDetails) {
                            $posterUrl = if ($videoDetails.poster_url) { "/poster/$($videoDetails.poster_url)" } else { "" }
                            $progressPercent = [math]::Round($prog.percent_watched, 0)
                            $remainingMins = if ($prog.duration_seconds -and $prog.last_position_seconds) {
                                [math]::Round(($prog.duration_seconds - $prog.last_position_seconds) / 60, 0)
                            } else { "?" }
                            
                            $mobileContinueCards += @"
<a href="/player/$($videoDetails.id)?resume=1" class="mobile-continue-card">
    <div class="mobile-continue-poster">
        $(if ($posterUrl) { "<img src='$posterUrl' alt='$($videoDetails.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#1e1e1e,#2d2d2d);'></div>" })
        <div class="mobile-continue-progress">
            <div class="mobile-continue-progress-fill" style="width:${progressPercent}%;"></div>
        </div>
        <div class="mobile-continue-overlay">
            <span class="material-icons-round mobile-continue-play">play_circle_filled</span>
        </div>
    </div>
    <div class="mobile-continue-title">$($videoDetails.title)</div>
    <div class="mobile-continue-meta">${remainingMins} min left</div>
</a>
"@
                        }
                    }
                    
                    if ($mobileContinueCards) {
                        $mobileContinueWatchingHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>▶️ Continue Watching</strong>
        </div>
        <a href="/videos" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-continue-scroll hide-scrollbar">
        $mobileContinueCards
    </div>
</section>
"@
                    }
                }
            } catch { }
        }
    }
    
    # Mobile Recently Added Movies
    $mobileRecentMoviesHtml = ""
    if ($recentMovies -and @($recentMovies).Count -gt 0) {
        $mobileMovieCards = ""
        foreach ($video in $recentMovies) {
            $posterUrl = if ($video.poster_url) { "/poster/$($video.poster_url)" } else { "" }
            $year = if ($video.year) { $video.year } else { "" }
            $isWatched = $watchedLookup["movie_$($video.id)"]
            
            $mobileMovieCards += @"
<a href="/movie/$($video.id)" class="mobile-recent-card">
    <div class="mobile-recent-poster">
        $(if ($posterUrl) { "<img src='$posterUrl' alt='$($video.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#dc2626,#991b1b);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>🎬</div>" })
        $(if ($isWatched) { "<div class='mobile-recent-badge watched'><span class='material-icons-round' style='font-size:12px;'>check</span></div>" } else { "<div class='mobile-recent-badge new'>NEW</div>" })
    </div>
    <div class="mobile-recent-title">$($video.title)</div>
    <div class="mobile-recent-year">$year</div>
</a>
"@
        }
        
        $mobileRecentMoviesHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>🎬 Recently Added Movies</strong>
        </div>
        <a href="/videos?filter=movies" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileMovieCards
    </div>
</section>
"@
    }
    
    # Mobile Recently Added TV
    $mobileRecentTVHtml = ""
    if ($recentTV -and @($recentTV).Count -gt 0) {
        $mobileTVCards = ""
        foreach ($video in $recentTV) {
            $posterUrl = if ($video.poster_url) { "/poster/$($video.poster_url)" } else { "" }
            $year = if ($video.year) { $video.year } else { "" }
            $isWatched = $watchedLookup["tv_$($video.id)"]
            
            $mobileTVCards += @"
<a href="/movie/$($video.id)" class="mobile-recent-card">
    <div class="mobile-recent-poster">
        $(if ($posterUrl) { "<img src='$posterUrl' alt='$($video.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#3b82f6,#1d4ed8);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>📺</div>" })
        $(if ($isWatched) { "<div class='mobile-recent-badge watched'><span class='material-icons-round' style='font-size:12px;'>check</span></div>" } else { "<div class='mobile-recent-badge new'>NEW</div>" })
    </div>
    <div class="mobile-recent-title">$($video.title)</div>
    <div class="mobile-recent-year">$year</div>
</a>
"@
        }
        
        $mobileRecentTVHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>📺 Recently Added TV Shows</strong>
        </div>
        <a href="/videos?filter=tvshows" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileTVCards
    </div>
</section>
"@
    }
    
    # Mobile Recently Added eBooks (only if enabled)
    $mobileRecentEbooksHtml = ""
    if ((-not $CONFIG -or $CONFIG.EbooksEnabled) -and $recentEbooks -and @($recentEbooks).Count -gt 0) {
        $mobileEbookCards = ""
        foreach ($ebook in $recentEbooks) {
            $previewUrl = if ($ebook.preview_image -and -not [string]::IsNullOrWhiteSpace($ebook.preview_image)) { "/ebookcover/$($ebook.preview_image)" } else { "" }
            $displayTitle = if ($ebook.title -and -not [string]::IsNullOrWhiteSpace($ebook.title)) { $ebook.title } else { $ebook.filename }
            $fileExt = [System.IO.Path]::GetExtension($ebook.filename).ToLower()
            $encodedPath = [System.Web.HttpUtility]::UrlEncode($ebook.filepath)
            $ebookLink = if ($fileExt -eq ".epub") { "/read-epub?path=$encodedPath" } else { "/view-pdf?path=$encodedPath" }
            
            $mobileEbookCards += @"
<a href="$ebookLink" class="mobile-recent-card">
    <div class="mobile-recent-poster">
        $(if ($previewUrl) { "<img src='$previewUrl' alt='$displayTitle'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#22c55e,#15803d);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>📚</div>" })
    </div>
    <div class="mobile-recent-title">$displayTitle</div>
    <div class="mobile-recent-year">eBook</div>
</a>
"@
        }
        
        $mobileRecentEbooksHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>📚 Recently Added eBooks</strong>
        </div>
        <a href="/pdfs" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileEbookCards
    </div>
</section>
"@
    }
    
    # Mobile Recently Added Pictures (only if enabled)
    $mobileRecentPicturesHtml = ""
    if ((-not $CONFIG -or $CONFIG.PicturesEnabled) -and $recentPictures -and @($recentPictures).Count -gt 0) {
        $mobilePictureCards = ""
        foreach ($picture in $recentPictures) {
            $encodedPath = [Uri]::EscapeDataString($picture.filepath)
            $thumbUrl = if ($picture.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($picture.thumbnail_path)) { "/picthumb/$($picture.thumbnail_path)" } else { "/thumb/$encodedPath" }
            
            $mobilePictureCards += @"
<a href="/view-image?path=$encodedPath" target="_blank" class="mobile-recent-card">
    <div class="mobile-recent-poster" style="aspect-ratio:1/1;">
        <img src="$thumbUrl" alt="$($picture.filename)" style="object-fit:cover;">
    </div>
    <div class="mobile-recent-title">$($picture.filename)</div>
    <div class="mobile-recent-year">$($picture.width)x$($picture.height)</div>
</a>
"@
        }
        
        $mobileRecentPicturesHtml = @"
<section class="mobile-section">
    <div class="mobile-section-header">
        <h3 class="mobile-section-title">Recently Added Pictures</h3>
        <span class="material-icons-round" style="color:#64748b;">chevron_right</span>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobilePictureCards
    </div>
</section>
"@
    }
    
    # Mobile Recently Added Music Videos (only if enabled)
    $mobileRecentMusicVideosHtml = ""
    if ($CONFIG.MusicVideosEnabled -and $recentMusicVideos -and @($recentMusicVideos).Count -gt 0) {
        $mobileMVCards = ""
        foreach ($mv in $recentMusicVideos) {
            $thumbUrl = if ($mv.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($mv.thumbnail_path)) { "/mvthumb/$($mv.thumbnail_path)" } else { "" }
            $artistDisplay = if ($mv.artist -and -not [string]::IsNullOrWhiteSpace($mv.artist)) { $mv.artist } else { "Unknown" }
            
            $mobileMVCards += @"
<a href="/play-musicvideo/$($mv.id)" class="mobile-recent-card">
    <div class="mobile-recent-poster">
        $(if ($thumbUrl) { "<img src='$thumbUrl' alt='$($mv.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#a855f7,#7c3aed);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>🎵</div>" })
    </div>
    <div class="mobile-recent-title">$($mv.title)</div>
    <div class="mobile-recent-year">$artistDisplay</div>
</a>
"@
        }
        
        $mobileRecentMusicVideosHtml = @"
<section class="mobile-section">
    <div class="mobile-section-header">
        <h3 class="mobile-section-title">Recently Added Music Videos</h3>
        <span class="material-icons-round" style="color:#64748b;">chevron_right</span>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileMVCards
    </div>
</section>
"@
    }
    
    # Mobile Recently Added Music
    $mobileRecentMusicHtml = ""
    if ($recentMusic -and @($recentMusic).Count -gt 0) {
        $mobileMusicCards = ""
        foreach ($track in $recentMusic) {
            $artUrl = ""
            if ($track.album_art_cached -and -not [string]::IsNullOrWhiteSpace($track.album_art_cached)) {
                $artUrl = "/albumart/$($track.album_art_cached)"
            } elseif ($track.album_art_url -and -not [string]::IsNullOrWhiteSpace($track.album_art_url)) {
                $artUrl = "/poster/$($track.album_art_url)"
            }
            $artistDisplay = if ($track.artist -and -not [string]::IsNullOrWhiteSpace($track.artist)) { $track.artist } else { "Unknown" }
            
            $mobileMusicCards += @"
<a href="/play-audio/$($track.id)" class="mobile-recent-card">
    <div class="mobile-recent-poster" style="aspect-ratio:1/1;">
        $(if ($artUrl) { "<img src='$artUrl' alt='$($track.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#f97316,#ea580c);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>🎧</div>" })
    </div>
    <div class="mobile-recent-title">$($track.title)</div>
    <div class="mobile-recent-year">$artistDisplay</div>
</a>
"@
        }
        
        $mobileRecentMusicHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>🎵 Recently Added Music</strong>
        </div>
        <a href="/music" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileMusicCards
    </div>
</section>
"@
    }
    
    # Mobile All Movies Section (fallback when no recent content)
    $mobileAllMoviesHtml = ""
    if ([string]::IsNullOrWhiteSpace($mobileRecentMoviesHtml)) {
        # Get all movies if no recent ones
        $allMovies = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE media_type = 'movie' OR media_type IS NULL ORDER BY title LIMIT 20"
        if ($allMovies -and @($allMovies).Count -gt 0) {
            $mobileAllCards = ""
            foreach ($video in $allMovies) {
                $posterUrl = if ($video.poster_url) { "/poster/$($video.poster_url)" } else { "" }
                $year = if ($video.year) { $video.year } else { "" }
                
                $mobileAllCards += @"
<a href="/movie/$($video.id)" class="mobile-recent-card">
    <div class="mobile-recent-poster">
        $(if ($posterUrl) { "<img src='$posterUrl' alt='$($video.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#dc2626,#991b1b);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>🎬</div>" })
    </div>
    <div class="mobile-recent-title">$($video.title)</div>
    <div class="mobile-recent-year">$year</div>
</a>
"@
            }
            
            $mobileAllMoviesHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>🎬 Movies</strong>
        </div>
        <a href="/videos?filter=movies" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileAllCards
    </div>
</section>
"@
        }
    }
    
    # Mobile All TV Shows Section (fallback when no recent content)
    $mobileAllTVHtml = ""
    if ([string]::IsNullOrWhiteSpace($mobileRecentTVHtml)) {
        # Get all TV shows if no recent ones
        $allTV = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE media_type = 'tv' ORDER BY title LIMIT 20"
        if ($allTV -and @($allTV).Count -gt 0) {
            $mobileAllTVCards = ""
            foreach ($video in $allTV) {
                $posterUrl = if ($video.poster_url) { "/poster/$($video.poster_url)" } else { "" }
                $year = if ($video.year) { $video.year } else { "" }
                
                $mobileAllTVCards += @"
<a href="/movie/$($video.id)" class="mobile-recent-card">
    <div class="mobile-recent-poster">
        $(if ($posterUrl) { "<img src='$posterUrl' alt='$($video.title)'>" } else { "<div style='width:100%;height:100%;background:linear-gradient(135deg,#3b82f6,#1d4ed8);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;'>📺</div>" })
    </div>
    <div class="mobile-recent-title">$($video.title)</div>
    <div class="mobile-recent-year">$year</div>
</a>
"@
            }
            
            $mobileAllTVHtml = @"
<section class="card" style="margin: 12px;">
    <div class="head">
        <div class="title">
            <strong>📺 TV Shows</strong>
        </div>
        <a href="/videos?filter=tvshows" class="mobile-section-link">See All</a>
    </div>
    <div class="mobile-recent-scroll hide-scrollbar">
        $mobileAllTVCards
    </div>
</section>
"@
        }
    }
    
    # Mobile empty state
    $mobileEmptyHtml = ""
    $hasAnyMobileContent = $mobileHeroHtml -or $mobileFavoritesHtml -or $mobileContinueWatchingHtml -or $mobileRecentMoviesHtml -or $mobileRecentTVHtml -or $mobileAllMoviesHtml -or $mobileAllTVHtml -or $mobileRecentEbooksHtml -or $mobileRecentPicturesHtml -or $mobileRecentMusicVideosHtml -or $mobileRecentMusicHtml
    if (-not $hasAnyMobileContent) {
        $mobileEmptyHtml = @"
<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:60vh;padding:40px 20px;text-align:center;">
    <span class="material-icons-round" style="font-size:64px;color:#64748b;margin-bottom:16px;">movie_filter</span>
    <h3 style="font-size:20px;font-weight:600;color:#f1f5f9;margin-bottom:8px;">No Media Yet</h3>
    <p style="font-size:14px;color:#64748b;max-width:280px;">Add some media to your library or scan your folders to get started.</p>
</div>
"@
    }
    
    $content = @"
<style>
.home-header {
    padding: 20px 40px;
    background: rgba(0,0,0,0.3);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
}

.search-container {
    flex: 1;
    max-width: 600px;
}

.search-input {
    width: 100%;
    padding: 12px 20px 12px 45px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 25px;
    color: var(--text);
    font-size: 15px;
    transition: all 0.3s ease;
}

.search-input:focus {
    outline: none;
    background: rgba(255,255,255,0.12);
    border-color: var(--accent);
}

.search-icon {
    position: absolute;
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
    opacity: 0.6;
    font-size: 18px;
}

.filter-buttons {
    display: flex;
    gap: 10px;
}

.filter-btn {
    padding: 10px 20px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    color: var(--text);
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 600;
}

.filter-btn:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
}

.filter-btn.active {
    background: var(--accent);
    color: #000;
    border-color: var(--accent);
}

.sort-toggles {
    display: flex;
    gap: 15px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 25px;
    border: 1px solid rgba(255,255,255,0.1);
}

.toggle-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    user-select: none;
}

.toggle-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
    accent-color: var(--accent);
}

.toggle-text {
    color: var(--text);
    font-size: 14px;
    font-weight: 600;
    white-space: nowrap;
}

/* Recently Added Section Styles */
.recent-section {
    background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, transparent 100%);
    border-radius: 16px;
    padding: 25px 40px 30px !important;
    margin: 0 20px 30px !important;
    border: 1px solid rgba(255,255,255,0.05);
}

.section-icon {
    font-size: 28px;
    margin-right: 5px;
}

.see-all-link {
    margin-left: auto;
    color: var(--accent);
    text-decoration: none;
    font-size: 14px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 20px;
    background: rgba(96,165,250,0.1);
    border: 1px solid rgba(96,165,250,0.2);
    transition: all 0.3s ease;
}

.see-all-link:hover {
    background: rgba(96,165,250,0.2);
    transform: translateX(3px);
}

.new-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    font-size: 10px;
    font-weight: 800;
    padding: 3px 8px;
    border-radius: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 8px rgba(239,68,68,0.4);
    animation: pulse-badge 2s infinite;
}

@keyframes pulse-badge {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

.genre-subtitle {
    color: rgba(255,255,255,0.7);
    font-size: 12px;
    font-weight: 500;
    margin-top: 3px;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.8);
}

.ebook-poster, .music-poster, .picture-poster {
    background-size: cover;
    background-position: center;
}

.picture-overlay {
    padding: 30px 15px 12px !important;
}

.genre-row {
    margin-bottom: 50px;
    padding: 0 40px;
}

.genre-header {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
}

.genre-name {
    font-size: 22px;
    font-weight: 700;
    color: var(--text);
    margin: 0;
}

.genre-count {
    font-size: 14px;
    color: rgba(255,255,255,0.5);
}

.genre-scroll-container {
    position: relative;
    display: flex;
    align-items: center;
    overflow: hidden;
    max-width: calc(100vw - 80px);
}

.genre-items {
    display: flex;
    gap: 12px;
    overflow-x: scroll;
    overflow-y: hidden;
    scroll-behavior: smooth;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 10px 0;
    max-width: 1448px;
}

.genre-items::-webkit-scrollbar {
    display: none;
}

.genre-item {
    flex: 0 0 280px;
    text-decoration: none;
    transition: transform 0.3s ease;
}

.genre-item:hover {
    transform: scale(1.05);
    z-index: 10;
}

.genre-poster {
    width: 280px;
    height: 158px;
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
}

.genre-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 40px 15px 15px;
    background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 50%, transparent 100%);
    opacity: 1;
    transition: opacity 0.3s ease;
}

.genre-item:hover .genre-overlay {
    opacity: 1;
}

.genre-title {
    color: white;
    font-size: 15px;
    font-weight: 700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.genre-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.8));
}

.scroll-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 50px;
    height: 100px;
    background: rgba(0,0,0,0.8);
    border: none;
    color: white;
    font-size: 40px;
    cursor: pointer;
    z-index: 100;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0.7;
}

.scroll-btn:hover {
    background: rgba(0,0,0,0.95);
    opacity: 1;
}

.scroll-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
}

.scroll-left {
    left: 0;
    border-radius: 0 8px 8px 0;
}

.scroll-right {
    left: 1398px;
    border-radius: 8px 0 0 8px;
}

.genres-container {
    padding: 40px 0;
    min-height: calc(100vh - 200px);
}

/* Empty state for no recent items */
.no-recent-message {
    text-align: center;
    padding: 60px 40px;
    color: rgba(255,255,255,0.5);
}

.no-recent-message h3 {
    font-size: 24px;
    margin-bottom: 10px;
    color: rgba(255,255,255,0.7);
}

.no-recent-message p {
    font-size: 16px;
}

@media (max-width: 1024px) {
    .genre-item {
        flex: 0 0 220px;
    }
    
    .genre-poster {
        width: 220px;
        height: 124px;
    }
    
    .genre-items {
        max-width: 684px;
    }
    
    .scroll-right {
        left: 634px;
    }
    
    .genre-row {
        padding: 0 20px;
    }
    
    .recent-section {
        margin: 0 10px 20px !important;
        padding: 20px 20px 25px !important;
    }
    
    .home-header {
        padding: 15px 20px;
        flex-direction: column;
    }
    
    .search-container {
        max-width: 100%;
    }
    
    .genre-header {
        flex-wrap: wrap;
    }
    
    .see-all-link {
        margin-left: 0;
        margin-top: 10px;
    }
}

/* Media Action Buttons (v3.8) */
.genre-item {
    position: relative;
    display: flex;
    flex-direction: column;
}

.genre-poster-link {
    text-decoration: none;
    display: block;
}

.media-actions {
    display: flex;
    gap: 4px;
    padding: 5px 8px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(22, 163, 74, 0.5));
    border-radius: 0 0 8px 8px;
    justify-content: flex-start;
    opacity: 0;
    transition: opacity 0.2s ease;
    position: absolute;
    bottom: -29px;
    left: 0;
    right: 0;
    z-index: 20;
}

.genre-item:hover .media-actions {
    opacity: 1;
}

.action-btn {
    width: 22px;
    height: 22px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: rgba(255,255,255,0.35);
    transform: scale(1.1);
}

.action-btn.active {
    background: rgba(255,255,255,0.9);
    color: #16a34a;
}

.favorite-btn.active {
    color: #ef4444;
}

.watched-btn.active {
    color: #3b82f6;
}

/* v7.54: Fix MP4 button styling */
.fix-mp4-btn {
    background: rgba(245,158,11,0.4) !important;
    color: #fbbf24 !important;
}

.fix-mp4-btn:hover {
    background: rgba(245,158,11,0.6) !important;
}

.fav-badge {
    position: absolute;
    top: 10px;
    left: 10px;
    font-size: 16px;
    color: #ef4444;
    filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.8));
}

/* Favorites Section Styling */
.favorites-section {
    background: linear-gradient(180deg, rgba(239,68,68,0.08) 0%, transparent 100%) !important;
    border-color: rgba(239,68,68,0.2) !important;
}

.favorites-section .section-icon {
    animation: heartbeat 1.5s ease-in-out infinite;
}

@keyframes heartbeat {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

/* Continue Watching Section Styling (Home Page) */
.continue-watching-home-section {
    background: linear-gradient(180deg, rgba(251,146,60,0.08) 0%, transparent 100%) !important;
    border-color: rgba(251,146,60,0.2) !important;
}

.continue-watching-home-section .section-icon {
    animation: pulse-play 2s ease-in-out infinite;
}

@keyframes pulse-play {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}

.continue-item-home .genre-poster {
    position: relative;
}

.continue-progress-bar-home {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(0,0,0,0.6);
    z-index: 5;
}

.continue-progress-fill-home {
    height: 100%;
    background: linear-gradient(90deg, #f97316, #fb923c);
    transition: width 0.3s;
}

.continue-meta-home {
    font-size: 11px;
    color: rgba(255,255,255,0.7);
    margin-top: 4px;
}

/* Adjust genre-item to have room for action bar on hover */
.genre-scroll-container {
    padding-bottom: 40px;
    margin-bottom: -40px;
}
</style>

<div class="home-header">
    <div class="search-container" style="position: relative;">
        <span class="search-icon">🔎</span>
        <input class="search-input" id="searchInput" placeholder="Search movies, TV shows, music, books..." />
    </div>
    <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap;">
        <div class="sort-toggles">
            <label class="toggle-label">
                <input type="checkbox" id="sortBestRated" $bestRatedChecked onchange="updateSort()">
                <span class="toggle-text">⭐ Best Rated</span>
            </label>
            <label class="toggle-label">
                <input type="checkbox" id="sortNewest" $newestChecked onchange="updateSort()">
                <span class="toggle-text">🕒 Newest</span>
            </label>
        </div>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterContent('all')">All</button>
            <button class="filter-btn" onclick="filterContent('video')">Videos</button>
            <button class="filter-btn" onclick="filterContent('audio')">Music</button>
            <button class="filter-btn" onclick="filterContent('ebooks')">eBooks</button>
            <button class="filter-btn" onclick="filterContent('pictures')">Pictures</button>
        </div>
    </div>
</div>

<div class="genres-container" id="genresContainer">
    <!-- Favorites Section -->
    $favoritesSectionHtml
    
    <!-- Continue Watching Section -->
    $continueWatchingSectionHtml
    
    <!-- Recently Added Sections -->
    $recentSectionsHtml
    
    $(if ([string]::IsNullOrWhiteSpace($recentSectionsHtml) -and [string]::IsNullOrWhiteSpace($favoritesSectionHtml) -and [string]::IsNullOrWhiteSpace($continueWatchingSectionHtml)) {
        '<div class="no-recent-message"><h3>📭 No Recent Additions</h3><p>No new media has been added in the last 7 days. Use the buttons above to browse your full library!</p></div>'
    })
</div>

<!-- ==================== MOBILE MAIN CONTENT (v7.68 - Simplified) ==================== -->
<main class="mobile-main">
    $mobileContinueWatchingHtml
    
    $mobileRecentMoviesHtml
    
    $mobileAllMoviesHtml
    
    $mobileRecentTVHtml
    
    $mobileAllTVHtml
    
    $mobileRecentMusicHtml
    
    $mobileRecentEbooksHtml
    
    $mobileEmptyHtml
</main>

<script>
function scrollGenre(button, direction) {
    const container = button.parentElement.querySelector('.genre-items');
    const scrollAmount = (280 + 12) * 5;
    container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
    });
}

function updateSort() {
    const bestRated = document.getElementById('sortBestRated').checked;
    const newest = document.getElementById('sortNewest').checked;
    
    let params = [];
    if (bestRated) params.push('sort=rating');
    if (newest) params.push('sort=date');
    
    const queryString = params.length > 0 ? '?' + params.join('&') : '';
    window.location.href = '/' + queryString;
}

function filterContent(type) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    switch(type) {
        case 'video': window.location.href = '/videos'; break;
        case 'audio': window.location.href = '/music'; break;
        case 'ebooks': window.location.href = '/pdfs'; break;
        case 'pictures': window.location.href = '/pictures'; break;
        // 'all' stays on home page
    }
}

document.getElementById('searchInput').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        window.location.href = '/search?q=' + encodeURIComponent(this.value);
    }
});

// Toggle Favorite (v3.8)
async function toggleFavorite(mediaType, mediaId, title, posterUrl, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/favorite/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: mediaType,
                mediaId: mediaId,
                title: title,
                posterUrl: posterUrl
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isFavorite);
            // If we're in favorites section and unfavorited, remove the item
            const item = btn.closest('.genre-item');
            if (!result.isFavorite && item.closest('.favorites-section')) {
                item.style.transition = 'opacity 0.3s, transform 0.3s';
                item.style.opacity = '0';
                item.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    item.remove();
                    // Check if favorites section is now empty
                    const favSection = document.querySelector('.favorites-section');
                    if (favSection && favSection.querySelectorAll('.genre-item').length === 0) {
                        favSection.remove();
                    }
                }, 300);
            }
        }
    } catch (err) {
        console.error('Favorite toggle error:', err);
    }
}

// Toggle Watched (v3.8)
async function toggleWatched(mediaType, mediaId, title, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/watched/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: mediaType,
                mediaId: mediaId,
                title: title
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isWatched);
        }
    } catch (err) {
        console.error('Watched toggle error:', err);
    }
}

// Show Media Menu (v3.8 - placeholder for future Edit Metadata)
function showMediaMenu(event) {
    event.preventDefault();
    event.stopPropagation();
    alert('Edit Metadata feature coming soon!');
}
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Home"
}

function Get-VideosPage {
    param(
        [string]$Filter = "all"
    )
    
    # ============================================================================
    # USER FAVORITES & WATCHED STATUS (v3.8)
    # ============================================================================
    
    $favoritesLookup = @{}
    $watchedLookup = @{}
    
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get all favorites for movies/tv
                $userFavorites = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT media_type, media_id FROM favorites WHERE media_type IN ('movie', 'tv')")
                foreach ($fav in $userFavorites) {
                    $key = "$($fav.media_type)_$($fav.media_id)"
                    $favoritesLookup[$key] = $true
                }
                
                # Get all watched items
                $userWatched = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT media_type, media_id FROM watched WHERE media_type IN ('movie', 'tv')")
                foreach ($w in $userWatched) {
                    $key = "$($w.media_type)_$($w.media_id)"
                    $watchedLookup[$key] = $true
                }
            } catch {
                Write-Host "[!] Error loading user favorites/watched: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # Get continue watching items from user database
    $continueWatchingHtml = ""
    $continueWatchingCount = 0
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get videos that are in progress (not completed, have position > 30 seconds, < 90% watched)
                $inProgress = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT * FROM video_progress 
WHERE completed = 0 
  AND last_position_seconds > 30 
  AND percent_watched < 90
  AND percent_watched > 0
ORDER BY last_watched DESC 
LIMIT 10
"@
                if ($inProgress) {
                    $continueWatchingCount = @($inProgress).Count
                    Write-Host "[i] Found $continueWatchingCount videos in progress" -ForegroundColor Cyan
                    
                    # FIXED: Batch fetch video details instead of N+1 queries
                    # Build lists of video IDs and paths for batch query
                    $videoIds = @($inProgress | Where-Object { $_.video_id -and $_.video_id -gt 0 } | ForEach-Object { $_.video_id }) -join ','
                    
                    # Create a hashtable for quick lookup of video details
                    $videoDetailsMap = @{}
                    
                    # Batch query by ID (fast, uses primary key index)
                    if ($videoIds) {
                        $idQuery = "SELECT * FROM videos WHERE id IN ($videoIds)"
                        $videosByIds = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query $idQuery
                        foreach ($vid in $videosByIds) {
                            $videoDetailsMap[$vid.id.ToString()] = $vid
                            $videoDetailsMap[$vid.filepath] = $vid
                        }
                    }
                    
                    # For any videos not found by ID, try by filepath (only if needed)
                    foreach ($prog in $inProgress) {
                        $found = $false
                        if ($prog.video_id -and $videoDetailsMap.ContainsKey($prog.video_id.ToString())) {
                            $found = $true
                        } elseif ($prog.video_path -and $videoDetailsMap.ContainsKey($prog.video_path)) {
                            $found = $true
                        }
                        
                        if (-not $found -and $prog.video_path) {
                            # Fallback: query by filepath only (uses index on filepath)
                            $videoDetails = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT * FROM videos WHERE filepath = @path LIMIT 1" -SqlParameters @{ path = $prog.video_path }
                            if ($videoDetails) {
                                $videoDetailsMap[$prog.video_path] = $videoDetails
                            }
                        }
                    }
                    
                    # Now build the HTML using the cached video details
                    foreach ($prog in $inProgress) {
                        $videoDetails = $null
                        if ($prog.video_id -and $videoDetailsMap.ContainsKey($prog.video_id.ToString())) {
                            $videoDetails = $videoDetailsMap[$prog.video_id.ToString()]
                        } elseif ($prog.video_path -and $videoDetailsMap.ContainsKey($prog.video_path)) {
                            $videoDetails = $videoDetailsMap[$prog.video_path]
                        }
                        
                        if ($videoDetails) {
                            $posterStyle = if ($videoDetails.poster_url) { "background-image: url('/poster/$($videoDetails.poster_url)');" } else { "" }
                            $progressPercent = [math]::Round($prog.percent_watched, 0)
                            $remainingMins = if ($prog.duration_seconds -and $prog.last_position_seconds) {
                                [math]::Round(($prog.duration_seconds - $prog.last_position_seconds) / 60, 0)
                            } else { "?" }
                            
                            $continueWatchingHtml += @"
<a class="continue-item" href="/player/$($videoDetails.id)?resume=1">
    <div class="continue-poster" style="$posterStyle">
        <div class="continue-progress-bar">
            <div class="continue-progress-fill" style="width: ${progressPercent}%"></div>
        </div>
        <div class="continue-play-icon">▶</div>
    </div>
    <div class="continue-info">
        <div class="continue-title">$($videoDetails.title)</div>
        <div class="continue-meta">${remainingMins} min left</div>
    </div>
</a>
"@
                        }
                    }
                }
            } catch {
                Write-Host "[!] Continue Watching error: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # Get videos based on filter
    $query = switch ($Filter) {
        "movies" {
            "SELECT * FROM videos WHERE media_type = 'movie' OR media_type IS NULL ORDER BY date_added DESC"
        }
        "tvshows" {
            "SELECT * FROM videos WHERE media_type = 'tv' ORDER BY date_added DESC"
        }
        "recent" {
            "SELECT * FROM videos ORDER BY date_added DESC LIMIT 50"
        }
        default {  # "all"
            "SELECT * FROM videos ORDER BY date_added DESC"
        }
    }
    
    $allVideos = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query $query
    
    # Count movies and TV shows
    $movieCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE media_type = 'movie' OR media_type IS NULL").count
    $tvCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE media_type = 'tv'").count
    
    $videoItems = ""
    foreach ($video in $allVideos) {
        $size = [math]::Round($video.size_bytes / 1GB, 2)
        
        # Check if poster exists
        $posterStyle = if ($video.poster_url -and -not [string]::IsNullOrWhiteSpace($video.poster_url)) {
            "background-image: url('/poster/$($video.poster_url)');"
        } else {
            ""
        }
        
        # Determine media type for favorites/watched
        $mediaType = if ($video.media_type -eq 'tv') { 'tv' } else { 'movie' }
        
        # Media type badge
        $mediaTypeBadge = if ($video.media_type -eq 'tv') {
            "<div class='flag tv'>TV Show</div>"
        } else {
            "<div class='flag video'>Movie</div>"
        }
        
        # Check favorite/watched status
        $isFavorite = $favoritesLookup["${mediaType}_$($video.id)"]
        $isWatched = $watchedLookup["${mediaType}_$($video.id)"]
        $favClass = if ($isFavorite) { 'active' } else { '' }
        $watchedClass = if ($isWatched) { 'active' } else { '' }
        
        # Escape title for JavaScript
        $titleEscaped = ($video.title -replace "'", "\'") -replace '"', '&quot;'
        $posterUrlEscaped = ($video.poster_url -replace "'", "\'") -replace '"', '&quot;'
        
        $videoItems += @"
<div class="item video-item" data-media-type="$mediaType" data-media-id="$($video.id)">
  <a href="/movie/$($video.id)" class="item-link">
    <div class="thumb" style="$posterStyle">
      <div class="media-actions">
        <button class="action-btn favorite-btn $favClass" onclick="toggleFavorite('$mediaType', $($video.id), '$titleEscaped', '$posterUrlEscaped', this, event); return false;" title="Add to Favorites">♥</button>
        <button class="action-btn watched-btn $watchedClass" onclick="toggleWatched('$mediaType', $($video.id), '$titleEscaped', this, event); return false;" title="Mark as Watched">✓</button>
        <button class="action-btn menu-btn" onclick="showMediaMenu(event); return false;" title="More Options">⋮</button>
      </div>
    </div>
    $mediaTypeBadge
    <div class="corner">▶</div>
    <div class="meta">
      <strong>$($video.title)</strong>
      <span>$($video.format) • ${size}GB</span>
    </div>
  </a>
</div>
"@
    }
    
    # Determine which chip is active
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    $moviesActive = if ($Filter -eq "movies") { "on" } else { "" }
    $tvActive = if ($Filter -eq "tvshows") { "on" } else { "" }
    
    # Determine title based on filter
    $titleText = switch ($Filter) {
        "movies" { "Movies" }
        "tvshows" { "TV Shows" }
        "recent" { "Recently Added" }
        default { "All Videos" }
    }
    
    # Continue Watching section HTML
    $continueWatchingSection = ""
    if ($continueWatchingHtml) {
        $continueWatchingSection = @"
<section class="card continue-watching-section">
    <div class="head">
        <div class="title">
            <strong>▶ Continue Watching</strong>
            <span>$continueWatchingCount items</span>
        </div>
    </div>
    <div class="continue-watching-grid">
        $continueWatchingHtml
    </div>
</section>
"@
    }
    
    $content = @"
<style>
/* Continue Watching Styles */
.continue-watching-section {
    margin-bottom: 24px;
}
.continue-watching-grid {
    display: flex;
    gap: 16px;
    overflow-x: auto;
    padding: 16px 0;
    scrollbar-width: thin;
}
.continue-watching-grid::-webkit-scrollbar {
    height: 6px;
}
.continue-watching-grid::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 3px;
}
.continue-item {
    flex: 0 0 auto;
    width: 180px;
    text-decoration: none;
    color: inherit;
    transition: transform 0.2s;
}
.continue-item:hover {
    transform: scale(1.05);
}
.continue-poster {
    width: 180px;
    height: 100px;
    background: rgba(255,255,255,0.1);
    background-size: cover;
    background-position: center top;
    border-radius: 8px;
    position: relative;
    overflow: hidden;
}
.continue-progress-bar {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: rgba(0,0,0,0.5);
}
.continue-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ef4444, #f97316);
    transition: width 0.3s;
}
.continue-play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: rgba(0,0,0,0.7);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
}
.continue-item:hover .continue-play-icon {
    opacity: 1;
}
.continue-info {
    padding: 8px 4px;
}
.continue-title {
    font-size: 13px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.continue-meta {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    margin-top: 2px;
}

/* TV Show flag color */
.flag.tv {
    background: #8b5cf6;
}

/* Type toggle button */
.type-toggle {
    display: inline-flex;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
}
.type-toggle .toggle-btn {
    padding: 8px 16px;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
    background: transparent;
    color: rgba(255,255,255,0.6);
}
.type-toggle .toggle-btn:hover {
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.9);
}
.type-toggle .toggle-btn.active {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
}
.type-toggle .toggle-btn:first-child {
    border-radius: 7px 0 0 7px;
}
.type-toggle .toggle-btn:last-child {
    border-radius: 0 7px 7px 0;
}

/* Media Action Buttons (v3.8) */
.video-item {
    position: relative;
    display: flex;
    flex-direction: column;
}

.video-item .item-link {
    text-decoration: none;
    color: inherit;
    display: block;
    flex: 1;
}

.video-item .thumb {
    aspect-ratio: 2/3;
    background-size: cover;
    background-position: center;
    border-radius: 12px;
    position: relative;
    overflow: hidden;
}

.video-item .media-actions {
    display: flex;
    gap: 4px;
    padding: 6px 8px;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    justify-content: flex-start;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.video-item:hover .media-actions {
    opacity: 1;
}

.video-item .action-btn {
    width: 26px;
    height: 26px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    transition: all 0.2s ease;
}

.video-item .action-btn:hover {
    background: rgba(255,255,255,0.45);
    transform: scale(1.1);
}

.video-item .action-btn.active {
    background: rgba(255,255,255,0.9);
    color: #16a34a;
}

.video-item .favorite-btn.active {
    color: #ef4444;
}

.video-item .watched-btn.active {
    color: #3b82f6;
}
</style>

<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search videos…" id="searchInput" />
  </div>
  <div class="seg">
    <div class="type-toggle">
        <button class="toggle-btn $allActive" onclick="window.location.href='/videos?filter=all'">All ($($movieCount + $tvCount))</button>
        <button class="toggle-btn $moviesActive" onclick="window.location.href='/videos?filter=movies'">🎬 Movies ($movieCount)</button>
        <button class="toggle-btn $tvActive" onclick="window.location.href='/videos?filter=tvshows'">📺 TV Shows ($tvCount)</button>
    </div>
    <div class="chip" onclick="window.location.href='/videos/genres'" style="margin-left: 12px;">🎭 By Genre</div>
  </div>
</div>

<div class="content">
  $continueWatchingSection
  
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$($allVideos.Count) items • $($Global:MediaStats.VideoSizeGB) GB</span>
      </div>
      <div class="actions">
        <a href="/refresh-genres" class="small" style="text-decoration:none; color:inherit;">🎭 Refresh Genres</a>
        <a href="/fetch-posters" class="small" style="text-decoration:none; color:inherit;">🎨 Fetch Posters</a>
        <div class="small">🔄 Refresh</div>
      </div>
    </div>
    <div class="grid">
      $videoItems
    </div>
  </section>
</div>

<script>
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=videos';
  }
});

// Toggle Favorite (v3.8)
async function toggleFavorite(mediaType, mediaId, title, posterUrl, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/favorite/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: mediaType,
                mediaId: mediaId,
                title: title,
                posterUrl: posterUrl
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isFavorite);
        }
    } catch (err) {
        console.error('Favorite toggle error:', err);
    }
}

// Toggle Watched (v3.8)
async function toggleWatched(mediaType, mediaId, title, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/watched/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: mediaType,
                mediaId: mediaId,
                title: title
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isWatched);
        }
    } catch (err) {
        console.error('Watched toggle error:', err);
    }
}

// Show Media Menu (v3.8 - placeholder for future Edit Metadata)
function showMediaMenu(event) {
    event.preventDefault();
    event.stopPropagation();
    alert('Edit Metadata feature coming soon!');
}
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Videos"
}

function Get-GenreListPage {
    # Get all unique genres from database
    $allVideos = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT genre FROM videos WHERE genre IS NOT NULL AND genre != ''"
    
    # Extract and count all genres
    $genreCount = @{}
    foreach ($video in $allVideos) {
        if ($video.genre) {
            # Split by comma since movies can have multiple genres
            $genres = $video.genre -split ',' | ForEach-Object { $_.Trim() }
            foreach ($genre in $genres) {
                if ($genre) {
                    if ($genreCount.ContainsKey($genre)) {
                        $genreCount[$genre]++
                    } else {
                        $genreCount[$genre] = 1
                    }
                }
            }
        }
    }
    
    # Sort genres by count (most popular first)
    $sortedGenres = $genreCount.GetEnumerator() | Sort-Object -Property Value -Descending
    
    # Create genre cards
    $genreCards = ""
    foreach ($genreEntry in $sortedGenres) {
        $genreName = $genreEntry.Key
        $count = $genreEntry.Value
        $encodedGenre = [System.Web.HttpUtility]::UrlEncode($genreName)
        
        # Pick an emoji based on genre
        $emoji = switch -Regex ($genreName) {
            "Action"      { "💥" }
            "Adventure"   { "🗺️" }
            "Animation"   { "🎨" }
            "Comedy"      { "😂" }
            "Crime"       { "🔫" }
            "Documentary" { "📹" }
            "Drama"       { "🎭" }
            "Fantasy"     { "🧙" }
            "Horror"      { "👻" }
            "Mystery"     { "🔍" }
            "Romance"     { "💕" }
            "Sci-Fi"      { "🚀" }
            "Thriller"    { "😱" }
            "War"         { "⚔️" }
            "Western"     { "🤠" }
            "Family"      { "👨‍👩‍👧‍👦" }
            "History"     { "📜" }
            "Music"       { "🎵" }
            default       { "🎬" }
        }
        
        $genreCards += @"
<a class="genre-card" href="/videos/genre/$encodedGenre" style="text-decoration:none;">
  <div class="genre-icon">$emoji</div>
  <div class="genre-info">
    <strong style="font-size:16px; color:var(--text);">$genreName</strong>
    <span style="font-size:13px; color:var(--muted); margin-top:4px; display:block;">$count movies</span>
  </div>
</a>
"@
    }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search videos…" id="searchInput" />
  </div>
  <div class="seg">
    <div class="chip" onclick="window.location.href='/videos?filter=all'">All Videos</div>
    <div class="chip" onclick="window.location.href='/videos?filter=recent'">Recently Added</div>
    <div class="chip" onclick="window.location.href='/videos?filter=unwatched'">Unwatched</div>
    <div class="chip on">🎭 By Genre</div>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>Browse by Genre</strong>
        <span>$($sortedGenres.Count) genres available</span>
      </div>
      <div class="actions">
        <a href="/videos" class="small" style="text-decoration:none; color:inherit;">← Back to Videos</a>
      </div>
    </div>
    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:14px; padding:20px;">
      $genreCards
    </div>
  </section>
</div>

<style>
.genre-card {
  padding: 20px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  display: flex;
  align-items: center;
  gap: 14px;
  transition: transform .08s ease, background .2s ease, border-color .2s ease;
}
.genre-card:hover {
  transform: translateY(-2px);
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.18);
}
.genre-icon {
  font-size: 32px;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(96,165,250,.12);
  border-radius: 12px;
}
.genre-info {
  display: flex;
  flex-direction: column;
}
</style>

<script>
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=videos';
  }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Browse by Genre"
}

function Get-GenreVideosPage {
    param(
        [string]$Genre
    )
    
    # Get all videos with this genre
    $allVideos = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
        -Query "SELECT * FROM videos WHERE genre LIKE @genre ORDER BY title" `
        -SqlParameters @{ genre = "%$Genre%" }
    
    $videoItems = ""
    foreach ($video in $allVideos) {
        $size = [math]::Round($video.size_bytes / 1GB, 2)
        
        # Check if poster exists
        $posterStyle = if ($video.poster_url -and -not [string]::IsNullOrWhiteSpace($video.poster_url)) {
            "background-image: url('/poster/$($video.poster_url)');"
        } else {
            ""
        }
        
        # Show genre badges
        $genreBadges = ""
        if ($video.genre) {
            $genres = $video.genre -split ',' | ForEach-Object { $_.Trim() } | Select-Object -First 3
            foreach ($g in $genres) {
                $genreBadges += "<span style='display:inline-block; padding:4px 8px; background:rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.3); border-radius:6px; font-size:11px; margin-right:4px; margin-top:4px;'>$g</span>"
            }
        }
        
        $videoItems += @"
<a class="item" href="/movie/$($video.id)">
  <div class="thumb" style="$posterStyle"></div>
  <div class="flag video">Video</div>
  <div class="corner">▶</div>
  <div class="meta">
    <strong>$($video.title)</strong>
    <span>$($video.format) • ${size}GB</span>
    <div style="margin-top:6px;">$genreBadges</div>
  </div>
</a>
"@
    }
    
    # Pick emoji for this genre
    $emoji = switch -Regex ($Genre) {
        "Action"      { "💥" }
        "Adventure"   { "🗺️" }
        "Animation"   { "🎨" }
        "Comedy"      { "😂" }
        "Crime"       { "🔫" }
        "Documentary" { "📹" }
        "Drama"       { "🎭" }
        "Fantasy"     { "🧙" }
        "Horror"      { "👻" }
        "Mystery"     { "🔍" }
        "Romance"     { "💕" }
        "Sci-Fi"      { "🚀" }
        "Thriller"    { "😱" }
        "War"         { "⚔️" }
        "Western"     { "🤠" }
        "Family"      { "👨‍👩‍👧‍👦" }
        "History"     { "📜" }
        "Music"       { "🎵" }
        default       { "🎬" }
    }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search videos…" id="searchInput" />
  </div>
  <div class="seg">
    <div class="chip" onclick="window.location.href='/videos?filter=all'">All Videos</div>
    <div class="chip" onclick="window.location.href='/videos/genres'">🎭 By Genre</div>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$emoji $Genre</strong>
        <span>$($allVideos.Count) movies</span>
      </div>
      <div class="actions">
        <a href="/videos/genres" class="small" style="text-decoration:none; color:inherit;">← All Genres</a>
        <a href="/videos" class="small" style="text-decoration:none; color:inherit;">← Videos</a>
      </div>
    </div>
    <div class="grid">
      $videoItems
    </div>
  </section>
</div>

<script>
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=videos';
  }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - $Genre Movies"
}

function Get-MusicPage {
    param(
        [string]$Filter = "all",
        [int]$Page = 1
    )
    
    # Pagination settings (v4.9)
    $itemsPerPage = 100
    
    # Get total count first for pagination
    $totalMusic = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music").count
    $totalPages = [math]::Ceiling($totalMusic / $itemsPerPage)
    if ($Page -lt 1) { $Page = 1 }
    if ($Page -gt $totalPages -and $totalPages -gt 0) { $Page = $totalPages }
    
    $skipCount = ($Page - 1) * $itemsPerPage
    
    # Get music based on filter with pagination
    $query = switch ($Filter) {
        "artist" {
            "SELECT * FROM music ORDER BY artist, album, track_number LIMIT $itemsPerPage OFFSET $skipCount"
        }
        "album" {
            "SELECT * FROM music ORDER BY album, track_number LIMIT $itemsPerPage OFFSET $skipCount"
        }
        default {  # "all"
            "SELECT * FROM music ORDER BY title LIMIT $itemsPerPage OFFSET $skipCount"
        }
    }
    
    $allMusic = @(Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query $query)
    
    # Get user's playlists count for display
    $playlistCount = 0
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                $playlistCount = (Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT COUNT(*) as count FROM playlists").count
            } catch { $playlistCount = 0 }
        }
    }
    
    # ============================================================================
    # USER FAVORITES (v5.4 - Restored favorite button for music)
    # ============================================================================
    
    $favoritesLookup = @{}
    
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get all favorites for music
                $userFavorites = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT media_id FROM favorites WHERE media_type = 'music'")
                foreach ($fav in $userFavorites) {
                    $favoritesLookup[$fav.media_id] = $true
                }
            } catch {
                Write-Host "[!] Error loading user favorites: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # Build music data array for JavaScript - properly escape for embedding in HTML/JS
    $musicDataJson = @()
    foreach ($music in $allMusic) {
        $artist = if ($music.artist) { $music.artist } else { "Unknown Artist" }
        $album = if ($music.album) { $music.album } else { "Unknown Album" }
        $title = if ($music.title) { $music.title } else { "Unknown" }
        $artUrl = ""
        if ($music.album_art_cached -and -not [string]::IsNullOrWhiteSpace($music.album_art_cached)) {
            $artUrl = "/albumart/$($music.album_art_cached)"
        }
        elseif ($music.album_art_url -and -not [string]::IsNullOrWhiteSpace($music.album_art_url)) {
            $artUrl = "/poster/$($music.album_art_url)"
        }
        
        $musicDataJson += @{
            id = $music.id
            title = $title
            artist = $artist
            album = $album
            art = $artUrl
            duration = if ($music.duration_seconds) { $music.duration_seconds } else { 0 }
            path = $music.filepath
        }
    }
    # Convert to JSON and encode as base64 to avoid all escaping issues
    $jsonRaw = $musicDataJson | ConvertTo-Json -Compress -Depth 3
    $jsonBytes = [System.Text.Encoding]::UTF8.GetBytes($jsonRaw)
    $musicJsonBase64 = [Convert]::ToBase64String($jsonBytes)
    
    $musicItems = ""
    $index = 0
    foreach ($music in $allMusic) {
        $artist = if ($music.artist) { $music.artist } else { "Unknown Artist" }
        $album = if ($music.album) { $music.album } else { "Unknown Album" }
        
        # Check for cached album art first
        $artStyle = ""
        if ($music.album_art_cached -and -not [string]::IsNullOrWhiteSpace($music.album_art_cached)) {
            $artStyle = "background-image: url('/albumart/$($music.album_art_cached)');"
        }
        elseif ($music.album_art_url -and -not [string]::IsNullOrWhiteSpace($music.album_art_url)) {
            $artStyle = "background-image: url('/poster/$($music.album_art_url)');"
        }
        
        # Check favorite status (v5.4 - restored)
        $isFavorite = $favoritesLookup[$music.id]
        $favClass = if ($isFavorite) { 'active' } else { '' }
        
        # Escape title for JavaScript
        $titleEscaped = ($music.title -replace "'", "\'") -replace '"', '&quot;'
        $posterUrlEscaped = if ($music.album_art_cached) { $music.album_art_cached } elseif ($music.album_art_url) { $music.album_art_url } else { "" }
        $posterUrlEscaped = ($posterUrlEscaped -replace "'", "\'") -replace '"', '&quot;'
        
        $musicItems += @"
<div class="item music-item" data-media-id="$($music.id)" draggable="true" data-music-id="$($music.id)" data-index="$index" data-title="$($music.title -replace '"', '&quot;')" data-artist="$($artist -replace '"', '&quot;')" data-album="$($album -replace '"', '&quot;')" data-path="$($music.filepath -replace '"', '&quot;')">
  <div class="music-item-link" onclick="playTrack($($music.id), $index, event)">
    <div class="thumb" style="$artStyle">
      <div class="play-overlay"><span>▶</span></div>
      <div class="media-actions">
        <button class="action-btn favorite-btn $favClass" onclick="toggleFavorite('music', $($music.id), '$titleEscaped', '$posterUrlEscaped', this, event)" title="Add to Favorites">♥</button>
        <button class="action-btn menu-btn" onclick="showMediaMenu(event)" title="More Options">⋮</button>
      </div>
    </div>
    <div class="flag audio">Audio</div>
    <div class="corner">♫</div>
    <div class="meta">
      <strong>$($music.title)</strong>
      <span>$artist</span>
      <span style="font-size:11px; opacity:0.7;">$album</span>
    </div>
  </div>
</div>
"@
        $index++
    }
    
    # Determine which chip is active
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    $artistActive = if ($Filter -eq "artist") { "on" } else { "" }
    $albumActive = if ($Filter -eq "album") { "on" } else { "" }
    
    # Determine title based on filter
    $titleText = switch ($Filter) {
        "artist" { "Music - Sorted by Artist" }
        "album" { "Music - Sorted by Album" }
        default { "All Music" }
    }
    
    # Generate pagination HTML (v4.9)
    $baseUrl = "/music?filter=$Filter"
    $paginationHtml = Get-PaginationHtml -CurrentPage $Page -TotalPages $totalPages -TotalItems $totalMusic -BaseUrl $baseUrl -ItemsPerPage $itemsPerPage
    
    # Calculate displayed item range
    $startItem = $skipCount + 1
    $endItem = [math]::Min($skipCount + @($allMusic).Count, $totalMusic)
    $itemCountText = if ($totalPages -gt 1) { "Showing $startItem-$endItem of $totalMusic tracks" } else { "$totalMusic tracks" }
    
    $content = @"
<style>
/* Persistent Music Player Styles */
.music-player-bar {
    position: fixed;
    bottom: 0;
    left: 280px;
    right: 0;
    background: linear-gradient(to top, rgba(10, 20, 16, 0.98), rgba(20, 31, 24, 0.95));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255,255,255,0.1);
    padding: 12px 24px;
    z-index: 1000;
    display: none;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.4);
}
.music-player-bar.active {
    display: flex;
    align-items: center;
    gap: 16px;
}
.player-art {
    width: 56px;
    height: 56px;
    border-radius: 8px;
    background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.3));
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}
.player-info {
    flex: 0 0 200px;
    min-width: 0;
}
.player-title {
    font-weight: 600;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.player-artist {
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.player-controls {
    display: flex;
    align-items: center;
    gap: 12px;
}
.player-btn {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    transition: all 0.2s;
}
.player-btn:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.05);
}
.player-btn.play-pause {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), #22c55e);
    font-size: 20px;
}
.player-btn.play-pause:hover {
    transform: scale(1.1);
}
.player-progress-container {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 200px;
}
.player-time {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    min-width: 40px;
    text-align: center;
}
.player-progress {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
}
.player-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), #22c55e);
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s linear;
}
.player-volume {
    display: flex;
    align-items: center;
    gap: 8px;
}
.volume-slider {
    width: 80px;
    height: 4px;
    -webkit-appearance: none;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    outline: none;
}
.volume-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
}
.player-close {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: rgba(239,68,68,0.2);
    color: #ef4444;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    margin-left: 8px;
}
.player-close:hover {
    background: rgba(239,68,68,0.4);
}

/* Play overlay on hover */
.music-item {
    cursor: pointer;
}
.music-item .play-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
    border-radius: 12px;
}
.music-item .play-overlay span {
    width: 50px;
    height: 50px;
    background: rgba(255,255,255,0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #0d1410;
}
.music-item:hover .play-overlay {
    opacity: 1;
}
.music-item.now-playing {
    border: 2px solid var(--accent);
    border-radius: 14px;
}
.music-item .thumb {
    position: relative;
    aspect-ratio: 1 / 1; /* Square aspect ratio for album art */
    height: auto;
}

/* Music item action buttons - transparent style (v5.4) */
.music-item {
    position: relative;
}

.music-item .music-item-link {
    display: block;
    cursor: pointer;
}

.music-item .thumb {
    position: relative;
    aspect-ratio: 1 / 1; /* Square aspect ratio for album art */
    height: auto;
}

.music-item .thumb .media-actions {
    display: flex;
    gap: 4px;
    padding: 6px 8px;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.7), transparent);
    justify-content: flex-start;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s ease;
    border-radius: 0 0 12px 12px;
}

.music-item:hover .thumb .media-actions {
    opacity: 1;
}

.music-item .thumb .action-btn {
    width: 26px;
    height: 26px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    transition: all 0.2s ease;
}

.music-item .thumb .action-btn:hover {
    background: rgba(255,255,255,0.45);
    transform: scale(1.1);
}

.music-item .thumb .action-btn.active {
    background: rgba(255,255,255,0.9);
    color: #16a34a;
}

.music-item .thumb .favorite-btn.active {
    color: #ef4444;
}

/* Adjust content padding when player is visible */
body.player-active .content {
    padding-bottom: 100px;
}

@media (max-width: 980px) {
    .music-player-bar {
        left: 0;
    }
}
</style>

<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search music…" id="searchInput" />
  </div>
  <div class="seg">
    <div class="chip $allActive" onclick="window.location.href='/music?filter=all'">All Music</div>
    <div class="chip $artistActive" onclick="window.location.href='/music?filter=artist'">By Artist</div>
    <div class="chip $albumActive" onclick="window.location.href='/music?filter=album'">By Album</div>
    <div class="chip" onclick="window.location.href='/playlists'" style="background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(99,102,241,0.3)); border-color: rgba(139,92,246,0.5);">📋 Playlists ($playlistCount)</div>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$itemCountText • $($Global:MediaStats.MusicSizeGB) GB</span>
      </div>
      <div class="actions">
        <!-- Mobile-only simplified actions -->
        <div class="small mobile-action mobile-shuffle-btn" onclick="shufflePlay()" style="cursor:pointer; background: linear-gradient(135deg, rgba(52,211,153,0.3), rgba(34,197,94,0.3)); padding: 10px 16px; border-radius: 20px; border: 1px solid rgba(52,211,153,0.4); font-weight: 600;">🔀 Shuffle</div>
        <a href="/playlists" class="small mobile-action mobile-playlist-btn" style="text-decoration:none; color:inherit; background: linear-gradient(135deg, rgba(139,92,246,0.3), rgba(99,102,241,0.3)); padding: 10px 16px; border-radius: 20px; border: 1px solid rgba(139,92,246,0.4); font-weight: 600;">📋 Playlists</a>
        <!-- Desktop-only actions (hidden on mobile via CSS) -->
        <div class="small desktop-only" onclick="shufflePlay()" style="cursor:pointer;">🔀 Shuffle Play</div>
        <a href="/playlists" class="small desktop-only" style="text-decoration:none; color:inherit;">📋 My Playlists</a>
        <a href="/extract-artwork" class="small desktop-only" style="text-decoration:none; color:inherit;">🎨 Extract Album Art</a>
        <div class="small desktop-only">🔄 Refresh</div>
      </div>
    </div>
    <div class="grid" id="musicGrid">
      $musicItems
    </div>
    $paginationHtml
  </section>
</div>

<!-- Persistent Audio Player Bar -->
<div class="music-player-bar" id="musicPlayerBar">
    <div class="player-art" id="playerArt"></div>
    <div class="player-info">
        <div class="player-title" id="playerTitle">No track selected</div>
        <div class="player-artist" id="playerArtist">-</div>
    </div>
    <div class="player-controls">
        <button class="player-btn" onclick="prevTrack()" title="Previous">⏮</button>
        <button class="player-btn play-pause" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">▶</button>
        <button class="player-btn" onclick="nextTrack()" title="Next">⏭</button>
        <button class="player-btn" onclick="shufflePlay()" title="Shuffle">🔀</button>
    </div>
    <div class="player-progress-container">
        <span class="player-time" id="currentTime">0:00</span>
        <div class="player-progress" id="progressBar" onclick="seekTo(event)">
            <div class="player-progress-fill" id="progressFill"></div>
        </div>
        <span class="player-time" id="totalTime">0:00</span>
    </div>
    <div class="player-volume">
        <span style="font-size: 14px;">🔊</span>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.01" value="1" onchange="setVolume(this.value)">
    </div>
    <button class="player-close" onclick="closePlayer()" title="Close Player">✕</button>
</div>

<!-- Hidden Audio Element -->
<audio id="audioPlayer" preload="auto"></audio>

<script>
// Music data from server (base64 encoded to avoid escaping issues)
var musicDataBase64 = '$musicJsonBase64';
var musicData = JSON.parse(atob(musicDataBase64));
var currentTrackIndex = -1;
var isPlaying = false;
var shuffleMode = false;
var playHistory = [];

var audio = document.getElementById('audioPlayer');
var playerBar = document.getElementById('musicPlayerBar');
var playPauseBtn = document.getElementById('playPauseBtn');
var progressFill = document.getElementById('progressFill');
var currentTimeEl = document.getElementById('currentTime');
var totalTimeEl = document.getElementById('totalTime');
var playerTitle = document.getElementById('playerTitle');
var playerArtist = document.getElementById('playerArtist');
var playerArt = document.getElementById('playerArt');

// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=music';
  }
});

// Toggle Favorite (v5.4 - restored)
async function toggleFavorite(mediaType, mediaId, title, posterUrl, btn, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    try {
        const response = await fetch('/api/favorite/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                media_type: mediaType,
                media_id: mediaId,
                title: title,
                poster_url: posterUrl
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active');
        }
    } catch (err) {
        console.error('Error toggling favorite:', err);
    }
}

// Show Media Menu (placeholder for future edit functionality)
function showMediaMenu(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    // Future: Show context menu with Edit Metadata option
    console.log('Media menu - coming soon');
}

// Play a specific track - Firefox compatible (direct user click triggers play)
function playTrack(id, index, event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Track previous track before switching (if played for at least 10 seconds)
    if (currentTrackInfo && currentTrackInfo.path && musicStartTime) {
        var playDuration = (Date.now() - musicStartTime) / 1000;
        if (playDuration >= 10) {
            fetch('/api/track/music', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    path: currentTrackInfo.path,
                    artist: currentTrackInfo.artist,
                    title: currentTrackInfo.title,
                    album: currentTrackInfo.album,
                    playTime: playDuration
                })
            }).catch(err => console.error('Music tracking error:', err));
        }
    }
    
    currentTrackIndex = index;
    var track = musicData[index];
    
    // Set up tracking for the new track
    currentTrackInfo = {
        path: track.path,
        artist: track.artist,
        title: track.title,
        album: track.album
    };
    musicStartTime = Date.now();
    console.log('Music tracking started:', currentTrackInfo);
    
    // Update UI
    playerTitle.textContent = track.title;
    playerArtist.textContent = track.artist;
    if (track.art) {
        playerArt.style.backgroundImage = 'url(' + track.art + ')';
    } else {
        playerArt.style.backgroundImage = 'linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.3))';
    }
    
    // Highlight current track
    document.querySelectorAll('.music-item').forEach(function(item) {
        item.classList.remove('now-playing');
    });
    var currentItem = document.querySelector('.music-item[data-index="' + index + '"]');
    if (currentItem) currentItem.classList.add('now-playing');
    
    // Show player bar
    playerBar.classList.add('active');
    document.body.classList.add('player-active');
    
    // MOBILE: Show mobile mini-player (v7.68)
    if (typeof showMobileMiniPlayer === 'function') {
        showMobileMiniPlayer(track.title, track.artist, track.art);
    }
    
    // Set source and play - THIS IS THE KEY FOR FIREFOX
    // The play() call is directly triggered by user click event
    audio.src = '/stream-audio/' + id;
    audio.load();
    
    var playPromise = audio.play();
    if (playPromise !== undefined) {
        playPromise.then(function() {
            isPlaying = true;
            playPauseBtn.textContent = '⏸';
        }).catch(function(error) {
            console.log('Play failed:', error);
            // Show a play button overlay if autoplay fails
            isPlaying = false;
            playPauseBtn.textContent = '▶';
        });
    }
    
    // Track in history
    playHistory.push(index);
}

// Toggle play/pause
function togglePlayPause() {
    if (audio.src === '' || audio.src === window.location.href) {
        // No track loaded, play first one
        if (musicData.length > 0) {
            playTrack(musicData[0].id, 0);
        }
        return;
    }
    
    if (isPlaying) {
        audio.pause();
        isPlaying = false;
        playPauseBtn.textContent = '▶';
    } else {
        audio.play().then(function() {
            isPlaying = true;
            playPauseBtn.textContent = '⏸';
        }).catch(function(e) {
            console.log('Play failed:', e);
        });
    }
}

// Next track
function nextTrack() {
    if (musicData.length === 0) return;
    
    var nextIndex;
    if (shuffleMode) {
        nextIndex = Math.floor(Math.random() * musicData.length);
    } else {
        nextIndex = (currentTrackIndex + 1) % musicData.length;
    }
    playTrack(musicData[nextIndex].id, nextIndex);
}

// Previous track
function prevTrack() {
    if (musicData.length === 0) return;
    
    if (playHistory.length > 1) {
        playHistory.pop(); // Remove current
        var prevIndex = playHistory[playHistory.length - 1];
        currentTrackIndex = prevIndex;
        playTrack(musicData[prevIndex].id, prevIndex);
    } else {
        var prevIndex = (currentTrackIndex - 1 + musicData.length) % musicData.length;
        playTrack(musicData[prevIndex].id, prevIndex);
    }
}

// Shuffle play
function shufflePlay() {
    if (musicData.length === 0) return;
    shuffleMode = true;
    var randomIndex = Math.floor(Math.random() * musicData.length);
    playTrack(musicData[randomIndex].id, randomIndex);
}

// Seek to position
function seekTo(event) {
    var rect = event.target.getBoundingClientRect();
    var percent = (event.clientX - rect.left) / rect.width;
    audio.currentTime = percent * audio.duration;
}

// Set volume
function setVolume(val) {
    audio.volume = val;
}

// Close player
function closePlayer() {
    audio.pause();
    audio.src = '';
    isPlaying = false;
    playerBar.classList.remove('active');
    document.body.classList.remove('player-active');
    document.querySelectorAll('.music-item').forEach(function(item) {
        item.classList.remove('now-playing');
    });
    currentTrackIndex = -1;
}

// Format time helper
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    var mins = Math.floor(seconds / 60);
    var secs = Math.floor(seconds % 60);
    return mins + ':' + (secs < 10 ? '0' : '') + secs;
}

// Audio event listeners
audio.addEventListener('timeupdate', function() {
    if (audio.duration) {
        var percent = (audio.currentTime / audio.duration) * 100;
        progressFill.style.width = percent + '%';
        currentTimeEl.textContent = formatTime(audio.currentTime);
        
        // MOBILE: Update mobile mini-player progress (v7.68)
        if (typeof updateMobileMiniPlayer === 'function') {
            updateMobileMiniPlayer(isPlaying, percent);
        }
    }
});

audio.addEventListener('loadedmetadata', function() {
    totalTimeEl.textContent = formatTime(audio.duration);
});

// ============= MUSIC TRACKING =============
var musicStartTime = null;
var currentTrackInfo = null;

function trackMusicPlay() {
    // Track previous track if exists
    if (currentTrackInfo && musicStartTime) {
        var playDuration = (Date.now() - musicStartTime) / 1000; // seconds
        
        // Only track if played for at least 10 seconds
        if (playDuration >= 10) {
            fetch('/api/track/music', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    path: currentTrackInfo.path,
                    artist: currentTrackInfo.artist,
                    title: currentTrackInfo.title,
                    album: currentTrackInfo.album,
                    playTime: playDuration
                })
            }).catch(err => console.error('Music tracking error:', err));
        }
    }
    
    // Start tracking new track
    if (currentTrackIndex >= 0 && musicData[currentTrackIndex]) {
        var track = musicData[currentTrackIndex];
        currentTrackInfo = {
            path: track.path,
            artist: track.artist,
            title: track.title,
            album: track.album
        };
        musicStartTime = Date.now();
    }
}

audio.addEventListener('ended', function() {
    // Track the completed track before moving to next
    if (currentTrackInfo && currentTrackInfo.path && musicStartTime) {
        var playDuration = (Date.now() - musicStartTime) / 1000;
        fetch('/api/track/music', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                path: currentTrackInfo.path,
                artist: currentTrackInfo.artist,
                title: currentTrackInfo.title,
                album: currentTrackInfo.album,
                playTime: playDuration
            })
        }).catch(err => console.error('Music tracking error:', err));
        musicStartTime = null;
    }
    nextTrack();
});

audio.addEventListener('play', function() {
    isPlaying = true;
    playPauseBtn.textContent = '⏸';
    // MOBILE: Sync mobile mini-player (v7.68)
    if (typeof updateMobileMiniPlayer === 'function') {
        updateMobileMiniPlayer(true, null);
    }
    // Start tracking when play begins
    if (!musicStartTime && currentTrackIndex >= 0 && musicData[currentTrackIndex]) {
        var track = musicData[currentTrackIndex];
        currentTrackInfo = {
            path: track.path,
            artist: track.artist,
            title: track.title,
            album: track.album
        };
        musicStartTime = Date.now();
    }
});

audio.addEventListener('pause', function() {
    isPlaying = false;
    playPauseBtn.textContent = '▶';
    // MOBILE: Sync mobile mini-player (v7.68)
    if (typeof updateMobileMiniPlayer === 'function') {
        updateMobileMiniPlayer(false, null);
    }
});

// Track on page unload
window.addEventListener('beforeunload', function() {
    if (currentTrackInfo && currentTrackInfo.path && musicStartTime) {
        var playDuration = (Date.now() - musicStartTime) / 1000;
        if (playDuration >= 10) {
            navigator.sendBeacon('/api/track/music', JSON.stringify({
                path: currentTrackInfo.path,
                artist: currentTrackInfo.artist,
                title: currentTrackInfo.title,
                album: currentTrackInfo.album,
                playTime: playDuration
            }));
        }
    }
});

// Enable drag functionality for music items
document.querySelectorAll('.music-item').forEach(function(item) {
    item.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('application/json', JSON.stringify({
            musicId: this.dataset.musicId,
            title: this.dataset.title,
            artist: this.dataset.artist,
            album: this.dataset.album,
            path: this.dataset.path
        }));
        e.dataTransfer.effectAllowed = 'copy';
        this.style.opacity = '0.5';
    });
    item.addEventListener('dragend', function(e) {
        this.style.opacity = '1';
    });
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Music"
}

function Get-PlaylistsPage {
    # Check if user is logged in
    if (-not $Global:CurrentUser -or -not $Global:CurrentUser.Username) {
        return Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Please log in to manage playlists</h1><p><a href='/login'>← Login</a></p></div>" -Title "Playlists"
    }
    
    $username = $Global:CurrentUser.Username
    $userDbPath = Join-Path $CONFIG.UsersDBPath "$username.db"
    
    # Ensure playlist tables exist
    try {
        Invoke-SqliteQuery -DataSource $userDbPath -Query @"
CREATE TABLE IF NOT EXISTS playlists (
    playlist_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    created_date TEXT NOT NULL,
    modified_date TEXT NOT NULL,
    track_count INTEGER DEFAULT 0
);
"@
        Invoke-SqliteQuery -DataSource $userDbPath -Query @"
CREATE TABLE IF NOT EXISTS playlist_tracks (
    track_id INTEGER PRIMARY KEY AUTOINCREMENT,
    playlist_id INTEGER NOT NULL,
    music_id INTEGER NOT NULL,
    music_path TEXT NOT NULL,
    title TEXT,
    artist TEXT,
    album TEXT,
    track_order INTEGER NOT NULL,
    added_date TEXT NOT NULL,
    FOREIGN KEY (playlist_id) REFERENCES playlists(playlist_id) ON DELETE CASCADE
);
"@
    } catch { }
    
    # Get all playlists
    $playlists = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM playlists ORDER BY modified_date DESC"
    $playlistCount = if ($playlists) { @($playlists).Count } else { 0 }
    
    # Build playlist cards
    $playlistItems = ""
    if ($playlists) {
        foreach ($pl in $playlists) {
            $trackCount = $pl.track_count
            $createdDate = if ($pl.created_date) { 
                try { ([datetime]$pl.created_date).ToString("MMM d, yyyy") } catch { "Unknown" }
            } else { "Unknown" }
            
            $playlistItems += @"
<a href="/playlist/$($pl.playlist_id)" class="playlist-card" data-playlist-id="$($pl.playlist_id)" ondrop="dropOnPlaylist(event, $($pl.playlist_id)); return false;" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
    <div class="playlist-icon">📋</div>
    <div class="playlist-info">
        <h3 class="playlist-name">$($pl.name)</h3>
        <span class="playlist-meta">$trackCount tracks • Created $createdDate</span>
        <span class="playlist-hint">Click to view & add music</span>
    </div>
    <div class="playlist-actions" onclick="event.stopPropagation(); event.preventDefault();">
        <button class="playlist-btn edit" onclick="editPlaylist($($pl.playlist_id), '$($pl.name -replace "'", "\'")')" title="Rename">✏️</button>
        <button class="playlist-btn delete" onclick="deletePlaylist($($pl.playlist_id), '$($pl.name -replace "'", "\'")')" title="Delete">🗑️</button>
    </div>
</a>
"@
        }
    }
    
    if (-not $playlistItems) {
        $playlistItems = @"
<div class="no-playlists">
    <div style="font-size: 64px; margin-bottom: 20px;">📋</div>
    <h3>No Playlists Yet</h3>
    <p>Create your first playlist to organize your favorite music!</p>
</div>
"@
    }
    
    $content = @"
<style>
.playlists-container { padding: 24px; max-width: 1200px; margin: 0 auto; }
.playlists-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.playlists-header h1 {
    font-size: 28px;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}
.playlists-header .count {
    font-size: 14px;
    color: rgba(255,255,255,0.5);
    font-weight: normal;
}

.create-playlist-btn {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}
.create-playlist-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(99,102,241,0.4);
}
.create-playlist-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.playlists-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 20px;
}

.playlist-card {
    background: rgba(255,255,255,0.03);
    border: 2px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    transition: all 0.3s ease;
    cursor: pointer;
    text-decoration: none;
    color: inherit;
}
.playlist-card:hover {
    background: rgba(255,255,255,0.06);
    border-color: rgba(99,102,241,0.3);
    transform: translateY(-2px);
}
.playlist-card:hover .playlist-hint {
    opacity: 1;
}
.playlist-card.drag-over {
    border-color: #22c55e;
    background: rgba(34,197,94,0.1);
    box-shadow: 0 0 20px rgba(34,197,94,0.3);
}

.playlist-icon {
    font-size: 40px;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(139,92,246,0.2));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.playlist-info { flex: 1; }
.playlist-name {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 6px 0;
    color: #fff;
}
.playlist-meta {
    font-size: 13px;
    color: rgba(255,255,255,0.5);
    display: block;
}
.playlist-hint {
    font-size: 12px;
    color: #6366f1;
    display: block;
    margin-top: 4px;
    opacity: 0;
    transition: opacity 0.2s;
}

.playlist-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}
.playlist-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    text-decoration: none;
}
.playlist-btn.play {
    background: rgba(34,197,94,0.2);
    color: #22c55e;
}
.playlist-btn.play:hover { background: rgba(34,197,94,0.3); }
.playlist-btn.edit {
    background: rgba(99,102,241,0.2);
    color: #6366f1;
}
.playlist-btn.edit:hover { background: rgba(99,102,241,0.3); }
.playlist-btn.delete {
    background: rgba(239,68,68,0.2);
    color: #ef4444;
}
.playlist-btn.delete:hover { background: rgba(239,68,68,0.3); }

.no-playlists {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.5);
}
.no-playlists h3 { color: rgba(255,255,255,0.7); margin-bottom: 10px; }

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    margin-bottom: 24px;
    font-size: 14px;
    transition: color 0.2s;
}
.back-link:hover { color: #fff; }

.drag-hint {
    background: rgba(99,102,241,0.1);
    border: 1px dashed rgba(99,102,241,0.3);
    border-radius: 12px;
    padding: 16px;
    text-align: center;
    margin-bottom: 24px;
    color: rgba(255,255,255,0.6);
    font-size: 14px;
}
.drag-hint strong { color: #6366f1; }

/* Modal styles */
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    z-index: 9999;
    align-items: center;
    justify-content: center;
}
.modal-overlay.show { display: flex; }
.modal {
    background: #1a1a2e;
    border-radius: 20px;
    padding: 32px;
    width: 90%;
    max-width: 450px;
    border: 1px solid rgba(255,255,255,0.1);
}
.modal h2 {
    margin: 0 0 24px 0;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}
.modal input {
    width: 100%;
    padding: 14px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 16px;
    margin-bottom: 8px;
}
.modal input:focus {
    outline: none;
    border-color: #6366f1;
}
.modal .char-count {
    font-size: 12px;
    color: rgba(255,255,255,0.4);
    text-align: right;
    margin-bottom: 24px;
}
.modal-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
}
.modal-btn {
    padding: 12px 24px;
    border-radius: 10px;
    border: none;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}
.modal-btn.cancel {
    background: rgba(255,255,255,0.1);
    color: #fff;
}
.modal-btn.cancel:hover { background: rgba(255,255,255,0.15); }
.modal-btn.confirm {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    color: #fff;
}
.modal-btn.confirm:hover { transform: translateY(-1px); }
.modal-btn.delete {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: #fff;
}

@media (max-width: 768px) {
    .playlists-header { flex-direction: column; gap: 16px; align-items: flex-start; }
    .playlists-grid { grid-template-columns: 1fr; }
}
</style>

<div class="playlists-container">
    <a href="/music" class="back-link">← Back to Music</a>
    
    <div class="playlists-header">
        <h1>📋 My Playlists <span class="count">($playlistCount/20)</span></h1>
        <button class="create-playlist-btn" onclick="showCreateModal()" $(if ($playlistCount -ge 20) { "disabled title='Maximum 20 playlists reached'" })>
            <span>+</span> Create Playlist
        </button>
    </div>
    
    <div class="drag-hint">
        💡 <strong>Tip:</strong> Drag music tracks from the Music page and drop them onto a playlist to add them!
    </div>
    
    <div class="playlists-grid">
        $playlistItems
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal-overlay" id="playlistModal">
    <div class="modal">
        <h2 id="modalTitle">📋 Create Playlist</h2>
        <input type="text" id="playlistName" placeholder="Enter playlist name..." maxlength="30" oninput="updateCharCount()">
        <div class="char-count"><span id="charCount">0</span>/30 characters</div>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="hideModal()">Cancel</button>
            <button class="modal-btn confirm" id="modalConfirm" onclick="confirmAction()">Create</button>
        </div>
    </div>
</div>

<!-- Delete Confirm Modal -->
<div class="modal-overlay" id="deleteModal">
    <div class="modal">
        <h2>🗑️ Delete Playlist</h2>
        <p id="deleteMessage" style="color: rgba(255,255,255,0.7); margin-bottom: 24px;">Are you sure you want to delete this playlist?</p>
        <div class="modal-buttons">
            <button class="modal-btn cancel" onclick="hideDeleteModal()">Cancel</button>
            <button class="modal-btn delete" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<script>
var modalMode = 'create';
var editingPlaylistId = null;
var deletingPlaylistId = null;

function showCreateModal() {
    modalMode = 'create';
    document.getElementById('modalTitle').textContent = '📋 Create Playlist';
    document.getElementById('playlistName').value = '';
    document.getElementById('modalConfirm').textContent = 'Create';
    document.getElementById('charCount').textContent = '0';
    document.getElementById('playlistModal').classList.add('show');
    document.getElementById('playlistName').focus();
}

function editPlaylist(id, name) {
    modalMode = 'edit';
    editingPlaylistId = id;
    document.getElementById('modalTitle').textContent = '✏️ Rename Playlist';
    document.getElementById('playlistName').value = name;
    document.getElementById('modalConfirm').textContent = 'Save';
    document.getElementById('charCount').textContent = name.length;
    document.getElementById('playlistModal').classList.add('show');
    document.getElementById('playlistName').focus();
}

function hideModal() {
    document.getElementById('playlistModal').classList.remove('show');
}

function updateCharCount() {
    var len = document.getElementById('playlistName').value.length;
    document.getElementById('charCount').textContent = len;
}

function confirmAction() {
    var name = document.getElementById('playlistName').value.trim();
    if (!name || name.length < 1 || name.length > 30) {
        alert('Playlist name must be between 1 and 30 characters');
        return;
    }
    
    if (modalMode === 'create') {
        fetch('/api/playlist/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: name })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to create playlist');
            }
        });
    } else {
        fetch('/api/playlist/rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ playlistId: editingPlaylistId, name: name })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert(data.error || 'Failed to rename playlist');
            }
        });
    }
}

function deletePlaylist(id, name) {
    deletingPlaylistId = id;
    document.getElementById('deleteMessage').textContent = 'Are you sure you want to delete "' + name + '"? This cannot be undone.';
    document.getElementById('deleteModal').classList.add('show');
}

function hideDeleteModal() {
    document.getElementById('deleteModal').classList.remove('show');
}

function confirmDelete() {
    fetch('/api/playlist/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ playlistId: deletingPlaylistId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Failed to delete playlist');
        }
    });
}

// Drag and drop handlers
function allowDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function dragLeave(e) {
    e.currentTarget.classList.remove('drag-over');
}

function dropOnPlaylist(e, playlistId) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    try {
        var data = JSON.parse(e.dataTransfer.getData('application/json'));
        if (data && data.musicId) {
            fetch('/api/playlist/add-track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    playlistId: playlistId,
                    musicId: data.musicId,
                    title: data.title,
                    artist: data.artist,
                    album: data.album,
                    path: data.path
                })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    // Show success feedback
                    var card = e.currentTarget;
                    card.style.borderColor = '#22c55e';
                    card.style.boxShadow = '0 0 20px rgba(34,197,94,0.5)';
                    setTimeout(function() {
                        card.style.borderColor = '';
                        card.style.boxShadow = '';
                        window.location.reload();
                    }, 500);
                } else {
                    alert(result.error || 'Failed to add track');
                }
            });
        }
    } catch (err) {
        console.error('Drop error:', err);
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        hideModal();
        hideDeleteModal();
    }
    if (e.key === 'Enter' && document.getElementById('playlistModal').classList.contains('show')) {
        confirmAction();
    }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "My Playlists - NexusM"
}

function Get-PlaylistDetailPage {
    param([int]$PlaylistId)
    
    # Check if user is logged in
    if (-not $Global:CurrentUser -or -not $Global:CurrentUser.Username) {
        return Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Please log in</h1><p><a href='/login'>← Login</a></p></div>" -Title "Playlist"
    }
    
    $username = $Global:CurrentUser.Username
    $userDbPath = Join-Path $CONFIG.UsersDBPath "$username.db"
    
    # Get playlist info
    $playlist = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM playlists WHERE playlist_id = @id" -SqlParameters @{ id = $PlaylistId }
    
    if (-not $playlist) {
        return Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Playlist not found</h1><p><a href='/playlists'>← Back to Playlists</a></p></div>" -Title "Not Found"
    }
    
    # Get tracks in playlist
    $tracks = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM playlist_tracks WHERE playlist_id = @id ORDER BY track_order" -SqlParameters @{ id = $PlaylistId }
    
    # Get track IDs already in playlist for filtering
    $existingTrackIds = @()
    if ($tracks) {
        $existingTrackIds = @($tracks | ForEach-Object { $_.music_id })
    }
    
    $trackItems = ""
    $trackIndex = 0
    if ($tracks) {
        foreach ($track in $tracks) {
            $trackIndex++
            # Get album art from main music database
            $musicInfo = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT album_art_cached, album_art_url FROM music WHERE id = @id" -SqlParameters @{ id = $track.music_id }
            
            $artStyle = ""
            if ($musicInfo) {
                if ($musicInfo.album_art_cached -and -not [string]::IsNullOrWhiteSpace($musicInfo.album_art_cached)) {
                    $artStyle = "background-image: url('/albumart/$($musicInfo.album_art_cached)');"
                } elseif ($musicInfo.album_art_url -and -not [string]::IsNullOrWhiteSpace($musicInfo.album_art_url)) {
                    $artStyle = "background-image: url('/poster/$($musicInfo.album_art_url)');"
                }
            }
            
            $trackItems += @"
<div class="track-item" data-track-id="$($track.track_id)" data-order="$($track.track_order)">
    <div class="track-num">$trackIndex</div>
    <div class="track-art" style="$artStyle"></div>
    <div class="track-info">
        <div class="track-title">$($track.title)</div>
        <div class="track-artist">$($track.artist) $(if ($track.album) { "• $($track.album)" })</div>
    </div>
    <div class="track-actions">
        <a href="/play-audio/$($track.music_id)" class="track-btn play" title="Play">▶</a>
        <button class="track-btn remove" onclick="removeTrack($($track.track_id))" title="Remove">✕</button>
    </div>
</div>
"@
        }
    }
    
    if (-not $trackItems) {
        $trackItems = @"
<div class="no-tracks">
    <div style="font-size: 48px; margin-bottom: 16px;">🎵</div>
    <h3>No tracks yet</h3>
    <p>Click <strong>"+ Add Music"</strong> above to browse and add tracks!</p>
</div>
"@
    }
    
    $trackCount = if ($tracks) { @($tracks).Count } else { 0 }
    
    # Get all music for the browser panel
    $allMusic = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT id, title, artist, album, album_art_cached, album_art_url FROM music ORDER BY title LIMIT 500"
    
    $musicBrowserItems = ""
    foreach ($music in $allMusic) {
        $artist = if ($music.artist) { $music.artist } else { "Unknown Artist" }
        $album = if ($music.album) { $music.album } else { "" }
        $isInPlaylist = $existingTrackIds -contains $music.id
        $disabledClass = if ($isInPlaylist) { "in-playlist" } else { "" }
        $disabledAttr = if ($isInPlaylist) { "disabled" } else { "" }
        
        $artStyle = ""
        if ($music.album_art_cached -and -not [string]::IsNullOrWhiteSpace($music.album_art_cached)) {
            $artStyle = "background-image: url('/albumart/$($music.album_art_cached)');"
        } elseif ($music.album_art_url -and -not [string]::IsNullOrWhiteSpace($music.album_art_url)) {
            $artStyle = "background-image: url('/poster/$($music.album_art_url)');"
        }
        
        $musicBrowserItems += @"
<div class="browser-item $disabledClass" data-music-id="$($music.id)" data-title="$($music.title -replace '"', '&quot;')" data-artist="$($artist -replace '"', '&quot;')" data-album="$($album -replace '"', '&quot;')">
    <div class="browser-art" style="$artStyle"></div>
    <div class="browser-info">
        <div class="browser-title">$($music.title)</div>
        <div class="browser-artist">$artist</div>
    </div>
    <button class="browser-add-btn" onclick="addTrackToPlaylist(this, $($music.id), '$($music.title -replace "'", "\'")', '$($artist -replace "'", "\'")', '$($album -replace "'", "\'")')" $disabledAttr>
        $(if ($isInPlaylist) { "✓" } else { "+" })
    </button>
</div>
"@
    }
    
    $content = @"
<style>
.playlist-page { display: flex; height: calc(100vh - 60px); }
.playlist-main { flex: 1; padding: 24px; overflow-y: auto; }
.music-browser { 
    width: 400px; 
    background: rgba(0,0,0,0.3); 
    border-left: 1px solid rgba(255,255,255,0.1);
    display: none;
    flex-direction: column;
}
.music-browser.open { display: flex; }

.playlist-header {
    display: flex;
    align-items: center;
    gap: 24px;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.playlist-cover {
    width: 140px;
    height: 140px;
    background: linear-gradient(135deg, rgba(99,102,241,0.3), rgba(139,92,246,0.3));
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 56px;
    flex-shrink: 0;
}
.playlist-details { flex: 1; }
.playlist-details h1 {
    font-size: 28px;
    margin: 0 0 8px 0;
}
.playlist-details .meta {
    color: rgba(255,255,255,0.5);
    font-size: 14px;
    margin-bottom: 16px;
}
.playlist-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
}
.control-btn {
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s;
    text-decoration: none;
    color: white;
}
.control-btn.play {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}
.control-btn.play:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34,197,94,0.4); }
.control-btn.shuffle {
    background: rgba(255,255,255,0.1);
}
.control-btn.shuffle:hover { background: rgba(255,255,255,0.15); }
.control-btn.add-music {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
}
.control-btn.add-music:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(99,102,241,0.4); }
.control-btn.add-music.active {
    background: linear-gradient(135deg, #8b5cf6, #6366f1);
    box-shadow: 0 0 20px rgba(99,102,241,0.5);
}

.back-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: rgba(255,255,255,0.7);
    text-decoration: none;
    margin-bottom: 24px;
    font-size: 14px;
}
.back-link:hover { color: #fff; }

.tracks-list {
    background: rgba(255,255,255,0.02);
    border-radius: 16px;
    overflow: hidden;
}

.track-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    gap: 16px;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    transition: background 0.2s;
}
.track-item:hover { background: rgba(255,255,255,0.03); }
.track-item:last-child { border-bottom: none; }

.track-num {
    width: 32px;
    text-align: center;
    color: rgba(255,255,255,0.4);
    font-size: 14px;
}
.track-art {
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.1);
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    flex-shrink: 0;
}
.track-info { flex: 1; min-width: 0; }
.track-title {
    font-weight: 500;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.track-artist {
    font-size: 13px;
    color: rgba(255,255,255,0.5);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.track-actions {
    display: flex;
    gap: 8px;
    opacity: 0;
    transition: opacity 0.2s;
    flex-shrink: 0;
}
.track-item:hover .track-actions { opacity: 1; }
.track-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    text-decoration: none;
    color: inherit;
}
.track-btn.play {
    background: rgba(34,197,94,0.2);
    color: #22c55e;
}
.track-btn.play:hover { background: rgba(34,197,94,0.3); }
.track-btn.remove {
    background: rgba(239,68,68,0.2);
    color: #ef4444;
}
.track-btn.remove:hover { background: rgba(239,68,68,0.3); }

.track-item.new-track {
    animation: trackAdded 0.5s ease;
    background: rgba(34,197,94,0.1);
}
@keyframes trackAdded {
    0% { opacity: 0; transform: translateX(20px); }
    100% { opacity: 1; transform: translateX(0); }
}

.no-tracks {
    text-align: center;
    padding: 60px 20px;
    color: rgba(255,255,255,0.5);
}
.no-tracks h3 { color: rgba(255,255,255,0.7); margin-bottom: 8px; }

/* Music Browser Panel */
.browser-header {
    padding: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.browser-header h2 {
    margin: 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.browser-close {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 24px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
}
.browser-close:hover { background: rgba(255,255,255,0.1); color: #fff; }

.browser-search {
    padding: 16px 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.browser-search input {
    width: 100%;
    padding: 12px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    color: #fff;
    font-size: 14px;
}
.browser-search input:focus {
    outline: none;
    border-color: #6366f1;
}
.browser-search input::placeholder { color: rgba(255,255,255,0.4); }

.browser-list {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
}

.browser-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    gap: 12px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    margin-bottom: 4px;
}
.browser-item:hover { background: rgba(255,255,255,0.05); }
.browser-item.in-playlist {
    opacity: 0.5;
    cursor: default;
}

.browser-art {
    width: 44px;
    height: 44px;
    background: rgba(255,255,255,0.1);
    background-size: cover;
    background-position: center;
    border-radius: 8px;
    flex-shrink: 0;
}
.browser-info { flex: 1; min-width: 0; }
.browser-title {
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}
.browser-artist {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.browser-add-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: rgba(99,102,241,0.2);
    color: #6366f1;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    flex-shrink: 0;
}
.browser-add-btn:hover:not(:disabled) { 
    background: rgba(99,102,241,0.4); 
    transform: scale(1.1);
}
.browser-add-btn:disabled {
    background: rgba(34,197,94,0.2);
    color: #22c55e;
    cursor: default;
}
.browser-add-btn.adding {
    background: rgba(234,179,8,0.3);
    color: #eab308;
}

.browser-count {
    padding: 12px 20px;
    border-top: 1px solid rgba(255,255,255,0.1);
    font-size: 13px;
    color: rgba(255,255,255,0.5);
    text-align: center;
}

@media (max-width: 900px) {
    .playlist-page { flex-direction: column; }
    .music-browser { 
        width: 100%; 
        height: 50vh;
        border-left: none;
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .playlist-header { flex-direction: column; text-align: center; }
    .playlist-controls { justify-content: center; }
}
</style>

<div class="playlist-page">
    <div class="playlist-main">
        <a href="/playlists" class="back-link">← Back to Playlists</a>
        
        <div class="playlist-header">
            <div class="playlist-cover">📋</div>
            <div class="playlist-details">
                <h1>$($playlist.name)</h1>
                <div class="meta">$trackCount tracks • Created $(try { ([datetime]$playlist.created_date).ToString("MMMM d, yyyy") } catch { "Unknown" })</div>
                <div class="playlist-controls">
                    $(if ($trackCount -gt 0) {
                        "<a href='/play-playlist/$PlaylistId' class='control-btn play'>▶ Play All</a>
                        <a href='/play-playlist/$PlaylistId/shuffle' class='control-btn shuffle'>🔀 Shuffle</a>"
                    })
                    <button class="control-btn add-music" id="addMusicBtn" onclick="toggleMusicBrowser()">
                        <span>+</span> Add Music
                    </button>
                </div>
            </div>
        </div>
        
        <div class="tracks-list" id="tracksList">
            $trackItems
        </div>
    </div>
    
    <div class="music-browser" id="musicBrowser">
        <div class="browser-header">
            <h2>🎵 Add Music</h2>
            <button class="browser-close" onclick="toggleMusicBrowser()">×</button>
        </div>
        <div class="browser-search">
            <input type="text" id="browserSearch" placeholder="Search music..." oninput="filterMusic(this.value)">
        </div>
        <div class="browser-list" id="browserList">
            $musicBrowserItems
        </div>
        <div class="browser-count" id="browserCount">
            Showing $($allMusic.Count) tracks
        </div>
    </div>
</div>

<script>
var playlistId = $PlaylistId;

function toggleMusicBrowser() {
    var browser = document.getElementById('musicBrowser');
    var btn = document.getElementById('addMusicBtn');
    browser.classList.toggle('open');
    btn.classList.toggle('active');
    
    if (browser.classList.contains('open')) {
        document.getElementById('browserSearch').focus();
    }
}

function filterMusic(query) {
    var items = document.querySelectorAll('.browser-item');
    var visibleCount = 0;
    query = query.toLowerCase();
    
    items.forEach(function(item) {
        var title = item.querySelector('.browser-title').textContent.toLowerCase();
        var artist = item.querySelector('.browser-artist').textContent.toLowerCase();
        
        if (title.includes(query) || artist.includes(query)) {
            item.style.display = 'flex';
            visibleCount++;
        } else {
            item.style.display = 'none';
        }
    });
    
    document.getElementById('browserCount').textContent = 'Showing ' + visibleCount + ' tracks';
}

var addedTracksCount = 0; // Track newly added tracks

function addTrackToPlaylist(btn, musicId, title, artist, album) {
    if (btn.disabled) return;
    
    btn.classList.add('adding');
    btn.textContent = '...';
    
    fetch('/api/playlist/add-track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            playlistId: playlistId,
            musicId: musicId,
            title: title,
            artist: artist,
            album: album,
            path: ''
        })
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            btn.classList.remove('adding');
            btn.textContent = '✓';
            btn.disabled = true;
            btn.parentElement.classList.add('in-playlist');
            
            // Add track to the playlist display without reloading
            addedTracksCount++;
            var tracksList = document.getElementById('tracksList');
            var noTracks = tracksList.querySelector('.no-tracks');
            if (noTracks) {
                noTracks.remove();
            }
            
            // Get current track count
            var currentCount = tracksList.querySelectorAll('.track-item').length;
            var newTrackNum = currentCount + 1;
            
            // Get album art from the browser item
            var browserItem = btn.parentElement;
            var artStyle = browserItem.querySelector('.browser-art').getAttribute('style') || '';
            
            // Create new track element
            var newTrack = document.createElement('div');
            newTrack.className = 'track-item new-track';
            newTrack.innerHTML = 
                '<div class="track-num">' + newTrackNum + '</div>' +
                '<div class="track-art" style="' + artStyle + '"></div>' +
                '<div class="track-info">' +
                    '<div class="track-title">' + escapeHtml(title) + '</div>' +
                    '<div class="track-artist">' + escapeHtml(artist) + (album ? ' • ' + escapeHtml(album) : '') + '</div>' +
                '</div>' +
                '<div class="track-actions">' +
                    '<a href="/play-audio/' + musicId + '" class="track-btn play" title="Play">▶</a>' +
                    '<span class="track-btn" style="background:rgba(34,197,94,0.2);color:#22c55e;">✓</span>' +
                '</div>';
            
            tracksList.appendChild(newTrack);
            
            // Update header track count
            var metaEl = document.querySelector('.playlist-details .meta');
            if (metaEl) {
                var text = metaEl.textContent;
                var match = text.match(/(\d+) tracks/);
                if (match) {
                    var newCount = parseInt(match[1]) + 1;
                    metaEl.textContent = text.replace(/\d+ tracks/, newCount + ' tracks');
                }
            }
            
            // Show Play All and Shuffle buttons if this is the first track
            if (newTrackNum === 1) {
                var controls = document.querySelector('.playlist-controls');
                var addMusicBtn = controls.querySelector('.add-music');
                if (addMusicBtn && !controls.querySelector('.play')) {
                    var playBtn = document.createElement('a');
                    playBtn.href = '/play-playlist/' + playlistId;
                    playBtn.className = 'control-btn play';
                    playBtn.innerHTML = '▶ Play All';
                    controls.insertBefore(playBtn, addMusicBtn);
                    
                    var shuffleBtn = document.createElement('a');
                    shuffleBtn.href = '/play-playlist/' + playlistId + '/shuffle';
                    shuffleBtn.className = 'control-btn shuffle';
                    shuffleBtn.innerHTML = '🔀 Shuffle';
                    controls.insertBefore(shuffleBtn, addMusicBtn);
                }
            }
            
            // Flash animation on new track
            setTimeout(function() {
                newTrack.classList.remove('new-track');
            }, 1000);
            
        } else {
            btn.classList.remove('adding');
            btn.textContent = '+';
            alert(result.error || 'Failed to add track');
        }
    })
    .catch(function(err) {
        btn.classList.remove('adding');
        btn.textContent = '+';
        alert('Error adding track');
    });
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function removeTrack(trackId) {
    if (!confirm('Remove this track from the playlist?')) return;
    
    fetch('/api/playlist/remove-track', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ trackId: trackId })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Failed to remove track');
        }
    });
}

// Keyboard shortcut: Escape to close browser
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        var browser = document.getElementById('musicBrowser');
        if (browser.classList.contains('open')) {
            toggleMusicBrowser();
        }
    }
});

// Auto-open music browser if playlist is empty
document.addEventListener('DOMContentLoaded', function() {
    var tracksList = document.getElementById('tracksList');
    var noTracks = tracksList.querySelector('.no-tracks');
    if (noTracks) {
        // Playlist is empty, auto-open the music browser
        setTimeout(function() {
            toggleMusicBrowser();
        }, 300);
    }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "$($playlist.name) - NexusM"
}

function Get-PicturesPage {
    param(
        [string]$Filter = "all",
        [string]$Category = "",  # v4.0: Category filter (subfolder name)
        [int]$Page = 1  # v4.9: Pagination
    )
    
    # Pagination settings (v4.9)
    $itemsPerPage = 100
    
    # v4.0: Get all categories (subfolders) with counts
    $categoriesQuery = @"
SELECT category, COUNT(*) as count, COALESCE(SUM(size_bytes), 0) as total_size
FROM images 
WHERE category IS NOT NULL AND category != ''
GROUP BY category 
ORDER BY category
"@
    $categories = @(Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $categoriesQuery)
    
    # Get total pictures count (for "All Pictures" category and pagination)
    $categoryCondition = ""
    if (-not [string]::IsNullOrWhiteSpace($Category)) {
        $categoryCondition = " WHERE category = '$($Category -replace "'", "''")'"
    }
    
    $totalCountQuery = "SELECT COUNT(*) as count FROM images$categoryCondition"
    $totalPictures = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $totalCountQuery).count
    
    # Get overall total for "All Pictures" chip
    $overallTotal = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT COUNT(*) as count FROM images").count
    
    # Calculate pagination (v4.9)
    $totalPages = [math]::Ceiling($totalPictures / $itemsPerPage)
    if ($Page -lt 1) { $Page = 1 }
    if ($Page -gt $totalPages -and $totalPages -gt 0) { $Page = $totalPages }
    $skipCount = ($Page - 1) * $itemsPerPage
    
    # Build category filter chips HTML (v4.0) - positioned under search bar on left side
    $categoryChipsHtml = ""
    if ($categories -and @($categories).Count -gt 0) {
        $allPicsActive = if ([string]::IsNullOrWhiteSpace($Category)) { "active" } else { "" }
        $categoryChipsHtml = @"
  <div class="categories-section">
    <div class="categories-label"><span class="folder-icon">📁</span> Categories</div>
    <div class="categories-chips">
      <div class="category-chip $allPicsActive" onclick="window.location.href='/pictures?filter=$Filter'">
        <span class="chip-icon">🖼</span> All Pictures ($overallTotal)
      </div>
"@
        foreach ($cat in $categories) {
            $catName = $cat.category
            $catCount = $cat.count
            $encodedCat = [System.Web.HttpUtility]::UrlEncode($catName)
            $isActive = if ($Category -eq $catName) { "active" } else { "" }
            $categoryChipsHtml += @"
      <div class="category-chip $isActive" onclick="window.location.href='/pictures?filter=$Filter&category=$encodedCat'">
        <span class="chip-icon">📁</span> $catName ($catCount)
      </div>
"@
        }
        $categoryChipsHtml += @"
    </div>
  </div>
"@
    }
    
    # Get pictures based on filter and category with pagination (v4.9)
    $query = switch ($Filter) {
        "recent" {
            if ($categoryCondition) {
                "SELECT * FROM images$categoryCondition ORDER BY date_added DESC LIMIT $itemsPerPage OFFSET $skipCount"
            } else {
                "SELECT * FROM images ORDER BY date_added DESC LIMIT $itemsPerPage OFFSET $skipCount"
            }
        }
        "bydate" {
            if ($categoryCondition) {
                "SELECT * FROM images$categoryCondition ORDER BY date_added DESC LIMIT $itemsPerPage OFFSET $skipCount"
            } else {
                "SELECT * FROM images ORDER BY date_added DESC LIMIT $itemsPerPage OFFSET $skipCount"
            }
        }
        default {  # "all"
            if ($categoryCondition) {
                "SELECT * FROM images$categoryCondition ORDER BY filename LIMIT $itemsPerPage OFFSET $skipCount"
            } else {
                "SELECT * FROM images ORDER BY filename LIMIT $itemsPerPage OFFSET $skipCount"
            }
        }
    }
    
    $allPictures = @(Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query $query)
    
    # Calculate total size for displayed pictures
    $displayedSizeGB = [math]::Round(($allPictures | Measure-Object -Property size_bytes -Sum).Sum / 1GB, 2)
    
    $pictureItems = ""
    foreach ($picture in $allPictures) {
        $size = [math]::Round($picture.size_bytes / 1MB, 1)
        $encodedPath = [System.Web.HttpUtility]::UrlEncode($picture.filepath)
        
        # v4.0: Use thumbnail if available, otherwise fall back to full image
        $thumbStyle = ""
        if ($picture.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($picture.thumbnail_path)) {
            $thumbStyle = "background-image: url('/picthumb/$($picture.thumbnail_path)');"
        } else {
            # Fallback to full image (slower)
            $thumbStyle = "background-image: url('/image/$($encodedPath)');"
        }
        
        $pictureItems += @"
<a class="item" href="/view-image?path=$encodedPath" target="_blank">
  <div class="thumb" style="$thumbStyle background-size: cover; background-position: center;"></div>
  <div class="flag picture">Picture</div>
  <div class="corner">🖼</div>
  <div class="meta">
    <strong>$($picture.filename)</strong>
    <span>$($picture.format) • ${size}MB</span>
  </div>
</a>
"@
    }
    
    # Determine which chip is active
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    $recentActive = if ($Filter -eq "recent") { "on" } else { "" }
    $byDateActive = if ($Filter -eq "bydate") { "on" } else { "" }
    
    # Build filter URL with category preserved
    $categoryParam = if (-not [string]::IsNullOrWhiteSpace($Category)) { "&category=$([System.Web.HttpUtility]::UrlEncode($Category))" } else { "" }
    
    # Determine title based on filter and category (v4.0)
    $categoryTitle = if (-not [string]::IsNullOrWhiteSpace($Category)) { $Category } else { "All Pictures" }
    $titleText = switch ($Filter) {
        "recent" { "$categoryTitle - Recent" }
        "bydate" { "$categoryTitle - Sorted by Date" }
        default { $categoryTitle }
    }
    
    # Generate pagination HTML (v4.9)
    $baseUrl = "/pictures?filter=$Filter$categoryParam"
    $paginationHtml = Get-PaginationHtml -CurrentPage $Page -TotalPages $totalPages -TotalItems $totalPictures -BaseUrl $baseUrl -ItemsPerPage $itemsPerPage
    
    # Calculate displayed item range (v4.9)
    $startItem = $skipCount + 1
    $endItem = [math]::Min($skipCount + @($allPictures).Count, $totalPictures)
    $itemCountText = if ($totalPages -gt 1) { "Showing $startItem-$endItem of $totalPictures items" } else { "$totalPictures items" }
    
    # v4.0: Additional CSS for categories - positioned on the left under search
    $categoriesCSS = @"
<style>
.top-row {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  flex-wrap: wrap;
}
.left-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  flex: 1;
  min-width: 300px;
}
.right-section {
  display: flex;
  align-items: center;
  gap: 10px;
}
.categories-section {
  margin: 0;
  padding: 0;
}
.categories-label {
  font-size: 13px;
  color: rgba(255,255,255,0.7);
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.folder-icon {
  font-size: 14px;
}
.categories-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}
.category-chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 20px;
  font-size: 13px;
  color: rgba(255,255,255,0.85);
  cursor: pointer;
  transition: all 0.2s ease;
}
.category-chip:hover {
  background: rgba(255,255,255,0.15);
  border-color: rgba(255,255,255,0.25);
}
.category-chip.active {
  background: rgba(96, 165, 250, 0.25);
  border-color: rgba(96, 165, 250, 0.5);
  color: #60a5fa;
}
.chip-icon {
  font-size: 14px;
}
</style>
"@
    
    $content = @"
$categoriesCSS
<div class="top">
  <div class="top-row">
    <div class="left-section">
      <div class="search">
        <span style="opacity:.85">🔎</span>
        <input placeholder="Search pictures…" id="searchInput" />
      </div>
      $categoryChipsHtml
    </div>
    <div class="right-section">
      <div class="seg">
        <div class="chip $allActive" onclick="window.location.href='/pictures?filter=all$categoryParam'">All Pictures</div>
        <div class="chip $recentActive" onclick="window.location.href='/pictures?filter=recent$categoryParam'">Recent</div>
        <div class="chip $byDateActive" onclick="window.location.href='/pictures?filter=bydate$categoryParam'">By Date</div>
      </div>
    </div>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$itemCountText • $displayedSizeGB GB total</span>
      </div>
      <div class="actions">
        <div class="small" onclick="generateThumbnails()" id="genThumbsBtn">🖼 Generate Thumbnails</div>
        <div class="small" onclick="window.location.reload()">🔄 Refresh</div>
      </div>
    </div>
    <div class="grid">
      $pictureItems
    </div>
    $paginationHtml
  </section>
</div>

<script>
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=pictures';
  }
});

function generateThumbnails() {
  var btn = document.getElementById('genThumbsBtn');
  var originalText = btn.innerHTML;
  btn.innerHTML = '⏳ Generating...';
  btn.style.pointerEvents = 'none';
  btn.style.opacity = '0.6';
  
  fetch('/api/picture/generate-thumbnails', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      if (data.generated > 0) {
        alert('✓ Thumbnails generated!\\nProcessed: ' + data.processed + '\\nGenerated: ' + data.generated + '\\nSkipped: ' + data.skipped);
        window.location.reload();
      } else {
        alert('All pictures already have thumbnails.');
      }
    } else {
      alert('Error: ' + (data.error || 'Unknown error'));
    }
    btn.innerHTML = originalText;
    btn.style.pointerEvents = '';
    btn.style.opacity = '';
  })
  .catch(err => {
    alert('Error generating thumbnails: ' + err);
    btn.innerHTML = originalText;
    btn.style.pointerEvents = '';
    btn.style.opacity = '';
  });
}
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Pictures"
}

function Get-PDFsPage {
    param(
        [string]$Filter = "all",
        [int]$Page = 1  # v4.9: Pagination
    )
    
    # Pagination settings (v4.9)
    $itemsPerPage = 100
    
    # Get total count first for pagination
    $totalPDFs = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs").count
    $totalPages = [math]::Ceiling($totalPDFs / $itemsPerPage)
    if ($Page -lt 1) { $Page = 1 }
    if ($Page -gt $totalPages -and $totalPages -gt 0) { $Page = $totalPages }
    $skipCount = ($Page - 1) * $itemsPerPage
    
    # Get PDFs based on filter with pagination
    $query = switch ($Filter) {
        "recent" {
            "SELECT * FROM pdfs ORDER BY date_added DESC LIMIT $itemsPerPage OFFSET $skipCount"
        }
        "byname" {
            "SELECT * FROM pdfs ORDER BY title LIMIT $itemsPerPage OFFSET $skipCount"
        }
        default {  # "all"
            "SELECT * FROM pdfs ORDER BY date_added DESC LIMIT $itemsPerPage OFFSET $skipCount"
        }
    }
    
    $allPDFs = @(Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query $query)
    
    $pdfItems = ""
    foreach ($pdf in $allPDFs) {
        $sizeMB = [math]::Round($pdf.size_bytes / 1MB, 1)
        $encodedPath = [System.Web.HttpUtility]::UrlEncode($pdf.filepath)
        
        # Detect file type - check database field or file extension as fallback
        $fileExtension = [System.IO.Path]::GetExtension($pdf.filepath).ToLower()
        $isEpub = ($pdf.PSObject.Properties.Name -contains 'file_type' -and $pdf.file_type -eq 'epub') -or $fileExtension -eq '.epub'
        
        # Set badge text and icon based on file type
        $badgeText = if ($isEpub) { "EPUB" } else { "PDF" }
        $badgeClass = if ($isEpub) { "epub" } else { "pdf" }
        $fileTypeLabel = if ($isEpub) { "EPUB" } else { "PDF" }
        
        # Check if document has generated preview/cover
        $thumbStyle = ""
        if ($pdf.preview_image -and -not [string]::IsNullOrWhiteSpace($pdf.preview_image)) {
            # Use actual preview/cover image - unified ebookcover route
            $thumbStyle = "background-image: url('/ebookcover/$($pdf.preview_image)'); background-size: cover; background-position: center;"
        }
        else {
            # Use placeholder icon with different colors for EPUB
            if ($isEpub) {
                $thumbStyle = "background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.15)); display:flex; align-items:center; justify-content:center; font-size:48px;"
            }
            else {
                $thumbStyle = "background: linear-gradient(135deg, rgba(220,38,38,0.15), rgba(251,191,36,0.15)); display:flex; align-items:center; justify-content:center; font-size:48px;"
            }
        }
        
        # Choose icon based on file type
        $iconPath = if ($isEpub) { "/menu/pdf.png" } else { "/menu/pdf.png" }  # You can create a separate epub.png icon if desired
        $iconHtml = if (-not $pdf.preview_image -or [string]::IsNullOrWhiteSpace($pdf.preview_image)) { "<img src='$iconPath' style='width:48px; height:48px;'>" } else { "" }
        
        # For EPUB files, use reader instead of download
        $clickAction = if ($isEpub) {
            "href='/read-epub?path=$encodedPath'"
        } else {
            "href='/view-pdf?path=$encodedPath' target='_blank'"
        }
        
        $pdfItems += @"
<a class="item" $clickAction>
  <div class="thumb" style="$thumbStyle">$iconHtml</div>
  <div class="flag $badgeClass">$badgeText</div>
  <div class="corner">📖</div>
  <div class="meta">
    <strong>$($pdf.title)</strong>
    <span>$fileTypeLabel • ${sizeMB}MB</span>
  </div>
</a>
"@
    }
    
    # Determine which chip is active
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    $recentActive = if ($Filter -eq "recent") { "on" } else { "" }
    $byNameActive = if ($Filter -eq "byname") { "on" } else { "" }
    
    # Determine title based on filter
    $titleText = switch ($Filter) {
        "recent" { "Recent eBooks" }
        "byname" { "eBooks - Sorted by Name" }
        default { "All eBooks" }
    }
    
    # Generate pagination HTML (v4.9)
    $baseUrl = "/pdfs?filter=$Filter"
    $paginationHtml = Get-PaginationHtml -CurrentPage $Page -TotalPages $totalPages -TotalItems $totalPDFs -BaseUrl $baseUrl -ItemsPerPage $itemsPerPage
    
    # Calculate displayed item range (v4.9)
    $startItem = $skipCount + 1
    $endItem = [math]::Min($skipCount + @($allPDFs).Count, $totalPDFs)
    $itemCountText = if ($totalPages -gt 1) { "Showing $startItem-$endItem of $totalPDFs documents" } else { "$totalPDFs documents" }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search eBooks…" id="searchInput" />
  </div>
  <div class="seg">
    <div class="chip $allActive" onclick="window.location.href='/pdfs?filter=all'">All eBooks</div>
    <div class="chip $recentActive" onclick="window.location.href='/pdfs?filter=recent'">Recent</div>
    <div class="chip $byNameActive" onclick="window.location.href='/pdfs?filter=byname'">By Name</div>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$itemCountText • $($Global:MediaStats.PDFSizeGB) GB</span>
      </div>
      <div class="actions">
        <a href="/generate-pdf-thumbnails" class="small" style="text-decoration:none; color:inherit;">🎨 Generate Thumbnails</a>
        <div class="small">🔄 Refresh</div>
      </div>
    </div>
    <div class="grid">
      $pdfItems
    </div>
    $paginationHtml
  </section>
</div>

<script>
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=pdfs';
  }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - eBooks"
}

function Get-RadioPage {
    param(
        [string]$Filter = "all",
        [int]$Page = 1  # v4.9: Pagination
    )
    
    # Pagination settings (v4.9)
    $itemsPerPage = 100
    
    # ============================================================================
    # USER FAVORITES (v3.8) - Radio stations use URL as identifier
    # ============================================================================
    
    $favoritesLookup = @{}
    
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get all radio favorites (use filepath to store URL)
                $userFavorites = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT filepath FROM favorites WHERE media_type = 'radio'")
                foreach ($fav in $userFavorites) {
                    $favoritesLookup[$fav.filepath] = $true
                }
            } catch {
                Write-Host "[!] Error loading radio favorites: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # Get radio stations based on filter
    $allFilteredStations = switch ($Filter) {
        "usa" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "USA" }
        }
        "uk" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "UK" }
        }
        "france" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "France" }
        }
        "germany" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "Germany" }
        }
        "netherlands" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "Netherlands" }
        }
        "italy" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "Italy" }
        }
        "switzerland" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "Switzerland" }
        }
        "belgium" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "Belgium" }
        }
        "ireland" {
            $CONFIG.RadioStations | Where-Object { $_.Country -eq "Ireland" }
        }
        "europe" {
            $CONFIG.RadioStations | Where-Object { $_.Country -notin @("USA", "UK") }
        }
        "news" {
            $CONFIG.RadioStations | Where-Object { $_.Genre -like "*News*" -or $_.Genre -like "*Talk*" }
        }
        "music" {
            $CONFIG.RadioStations | Where-Object { $_.Genre -notlike "*News*" -and $_.Genre -notlike "*Talk*" }
        }
        "jazz" {
            $CONFIG.RadioStations | Where-Object { $_.Genre -like "*Jazz*" }
        }
        "classical" {
            $CONFIG.RadioStations | Where-Object { $_.Genre -like "*Classical*" }
        }
        default {
            $CONFIG.RadioStations
        }
    }
    
    # Calculate pagination (v4.9)
    $totalStations = @($allFilteredStations).Count
    $totalPages = [math]::Ceiling($totalStations / $itemsPerPage)
    if ($Page -lt 1) { $Page = 1 }
    if ($Page -gt $totalPages -and $totalPages -gt 0) { $Page = $totalPages }
    $skipCount = ($Page - 1) * $itemsPerPage
    
    # Apply pagination to stations
    $stations = $allFilteredStations | Select-Object -Skip $skipCount -First $itemsPerPage
    
    $radioItems = ""
    $index = 0
    foreach ($station in $stations) {
        $index++
        
        # Generate a gradient background based on genre
        $gradientStyle = switch -Regex ($station.Genre) {
            "News|Talk" { "background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.1));" }
            "Jazz" { "background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(147,51,234,0.1));" }
            "Classical" { "background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1));" }
            "Rock|Alternative" { "background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(251,146,60,0.1));" }
            "Pop|Dance" { "background: linear-gradient(135deg, rgba(236,72,153,0.2), rgba(219,39,119,0.1));" }
            "Electronic|Ambient" { "background: linear-gradient(135deg, rgba(34,211,238,0.2), rgba(6,182,212,0.1));" }
            default { "background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(16,185,129,0.1));" }
        }
        
        # Emoji based on genre
        $emoji = switch -Regex ($station.Genre) {
            "News|Talk" { "📻" }
            "Jazz" { "🎷" }
            "Classical" { "🎻" }
            "Rock" { "🎸" }
            "Pop" { "🎤" }
            "Electronic" { "🎛️" }
            default { "📡" }
        }
        
        $encodedURL = [System.Web.HttpUtility]::UrlEncode($station.URL)
        
        # Use logo if available, otherwise use emoji with gradient
        $thumbContent = ""
        if ($station.Logo -and -not [string]::IsNullOrWhiteSpace($station.Logo)) {
            # Check if logo is a local file (no http/https) or external URL
            if ($station.Logo -like "http*") {
                # External URL - use directly (fallback for any we haven't localized)
                $logoURL = $station.Logo
            } else {
                # Local file - serve from root with proper path
                $logoURL = "/$($station.Logo)"
            }
            $thumbContent = "<div class='thumb' style='$gradientStyle background-image: url(""$logoURL""); background-size: 60%; background-repeat: no-repeat; background-position: center;'></div>"
        } else {
            # No logo - use emoji with gradient background
            $thumbContent = "<div class='thumb' style='$gradientStyle display:flex; align-items:center; justify-content:center; font-size:48px;'>$emoji</div>"
        }
        
        $isFavorite = $favoritesLookup[$station.URL]
        $favClass = if ($isFavorite) { 'active' } else { '' }
        $titleEscaped = ($station.Name -replace "'", "\'") -replace '"', '&quot;'
        $urlEscaped = ($station.URL -replace "'", "\'") -replace '"', '&quot;'
        
        $radioItems += @"
<div class="item radio-item" data-url="$($station.URL)" data-name="$($station.Name)" data-description="$($station.Description)">
  <div class="radio-clickable" onclick="playRadio('$encodedURL', '$($station.Name)', '$($station.Description)')">
    $thumbContent
    <div class="flag radio" style="background: rgba(52,211,153,0.9);">LIVE</div>
    <div class="corner">$($station.Country)</div>
    <div class="meta">
      <strong>$($station.Name)</strong>
      <span>$($station.Genre)</span>
      <span style="font-size:11px; opacity:0.7;">$($station.Description)</span>
    </div>
  </div>
  <div class="media-actions radio-actions">
    <button class="action-btn favorite-btn $favClass" onclick="toggleRadioFavorite('$urlEscaped', '$titleEscaped', this, event)" title="Add to Favorites">♥</button>
  </div>
</div>
"@
    }
    
    # Determine which chip is active
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    $usaActive = if ($Filter -eq "usa") { "on" } else { "" }
    $ukActive = if ($Filter -eq "uk") { "on" } else { "" }
    $franceActive = if ($Filter -eq "france") { "on" } else { "" }
    $germanyActive = if ($Filter -eq "germany") { "on" } else { "" }
    $netherlandsActive = if ($Filter -eq "netherlands") { "on" } else { "" }
    $italyActive = if ($Filter -eq "italy") { "on" } else { "" }
    $switzerlandActive = if ($Filter -eq "switzerland") { "on" } else { "" }
    $belgiumActive = if ($Filter -eq "belgium") { "on" } else { "" }
    $irelandActive = if ($Filter -eq "ireland") { "on" } else { "" }
    
    # Determine title based on filter
    $titleText = switch ($Filter) {
        "usa" { "USA Radio Stations" }
        "uk" { "UK Radio Stations" }
        "france" { "French Radio Stations" }
        "germany" { "German Radio Stations" }
        "netherlands" { "Dutch Radio Stations" }
        "italy" { "Italian Radio Stations" }
        "switzerland" { "Swiss Radio Stations" }
        "belgium" { "Belgian Radio Stations" }
        "ireland" { "Irish Radio Stations" }
        "europe" { "European Radio Stations" }
        "news" { "News & Talk Radio" }
        "music" { "Music Radio Stations" }
        "jazz" { "Jazz Radio" }
        "classical" { "Classical Radio" }
        default { "Internet Radio - All Stations" }
    }
    
    # Generate pagination HTML (v4.9)
    $baseUrl = "/radio?filter=$Filter"
    $paginationHtml = Get-PaginationHtml -CurrentPage $Page -TotalPages $totalPages -TotalItems $totalStations -BaseUrl $baseUrl -ItemsPerPage $itemsPerPage
    
    # Calculate displayed item range (v4.9)
    $startItem = $skipCount + 1
    $endItem = [math]::Min($skipCount + @($stations).Count, $totalStations)
    $itemCountText = if ($totalPages -gt 1) { "Showing $startItem-$endItem of $totalStations stations" } else { "$totalStations stations" }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search radio stations…" id="searchInput" />
  </div>
  <div class="seg" style="flex-wrap: wrap; gap: 8px;">
    <div class="chip $allActive" onclick="window.location.href='/radio?filter=all'">All</div>
<div class="chip $usaActive" onclick="window.location.href='/radio?filter=usa'"><img src="/menu/us.png" alt="USA" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> USA</div>
    <div class="chip $ukActive" onclick="window.location.href='/radio?filter=uk'"><img src="/menu/gb.png" alt="UK" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> UK</div>
    <div class="chip $franceActive" onclick="window.location.href='/radio?filter=france'"><img src="/menu/fr.png" alt="France" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> France</div>
    <div class="chip $germanyActive" onclick="window.location.href='/radio?filter=germany'"><img src="/menu/de.png" alt="Germany" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> Germany</div>
    <div class="chip $netherlandsActive" onclick="window.location.href='/radio?filter=netherlands'"><img src="/menu/nl.png" alt="Netherlands" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> Netherlands</div>
    <div class="chip $italyActive" onclick="window.location.href='/radio?filter=italy'"><img src="/menu/it.png" alt="Italy" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> Italy</div>
    <div class="chip $switzerlandActive" onclick="window.location.href='/radio?filter=switzerland'"><img src="/menu/ch.png" alt="Switzerland" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> Switzerland</div>
    <div class="chip $belgiumActive" onclick="window.location.href='/radio?filter=belgium'"><img src="/menu/be.png" alt="Belgium" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> Belgium</div>
    <div class="chip $irelandActive" onclick="window.location.href='/radio?filter=ireland'"><img src="/menu/ie.png" alt="Ireland" style="width:16px; height:12px; vertical-align:middle; margin-right:4px;"> Ireland</div>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$itemCountText</span>
      </div>
      <div class="actions">
        <div class="small" onclick="stopRadio()" style="cursor:pointer;">⏹️ Stop</div>
      </div>
    </div>
    <div class="grid">
      $radioItems
    </div>
    $paginationHtml
  </section>
  
  <!-- Radio Player -->
  <div id="radioPlayer" style="position: fixed; bottom: 20px; right: 20px; background: var(--panel); border: 1px solid var(--stroke); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); display: none; min-width: 300px; z-index: 1000;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
      <div style="font-size: 24px;">📻</div>
      <div style="flex: 1;">
        <div id="radioNowPlaying" style="font-weight: 600; margin-bottom: 4px;">Select a station</div>
        <div id="radioDescription" style="font-size: 12px; color: var(--muted);">Click a station to start</div>
      </div>
      <div onclick="stopRadio()" style="cursor: pointer; font-size: 24px; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">✕</div>
    </div>
    <audio id="radioAudio" controls style="width: 100%; border-radius: 8px;"></audio>
  </div>
  
  <!-- Error Modal -->
  <div id="errorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: var(--panel); border: 1px solid var(--stroke); border-radius: 20px; padding: 32px; max-width: 440px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: modalSlideIn 0.3s ease;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="width: 80px; height: 80px; margin: 0 auto 16px auto; background-image: url('/menu/radio.png'); background-size: contain; background-repeat: no-repeat; background-position: center;"></div>
        <h2 style="margin: 0 0 12px 0; font-size: 22px; font-weight: 600; color: var(--text);">Unable to Play Station</h2>
        <p style="margin: 0; color: var(--muted); font-size: 15px; line-height: 1.6;">
          This radio stream couldn't be played. This may happen if:
        </p>
      </div>
      <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 10px;">
          <div style="font-size: 20px;">🌍</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">Geographic Restriction</div>
            <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">The station may be geo-locked to a specific country or region</div>
          </div>
        </div>
        <div style="display: flex; align-items: start; gap: 12px;">
          <div style="font-size: 20px;">🔗</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">Stream URL Changed</div>
            <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">The direct streaming link may have been updated by the broadcaster</div>
          </div>
        </div>
      </div>
      <button onclick="closeErrorModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(96,165,250,0.9), rgba(59,130,246,0.9)); border: none; border-radius: 12px; color: white; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(96,165,250,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(96,165,250,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(96,165,250,0.3)'">
        OK, Got It
      </button>
    </div>
  </div>
  
  <style>
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  </style>
</div>

<script>
let currentRadio = null;

function showErrorModal() {
  const modal = document.getElementById('errorModal');
  modal.style.display = 'flex';
}

function closeErrorModal() {
  const modal = document.getElementById('errorModal');
  modal.style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('errorModal')?.addEventListener('click', function(e) {
  if (e.target === this) {
    closeErrorModal();
  }
});

function playRadio(url, name, description) {
  const player = document.getElementById('radioPlayer');
  const audio = document.getElementById('radioAudio');
  const nowPlaying = document.getElementById('radioNowPlaying');
  const desc = document.getElementById('radioDescription');
  
  // Decode URL
  url = decodeURIComponent(url);
  
  // Show player
  player.style.display = 'block';
  
  // Update UI
  nowPlaying.textContent = name;
  desc.textContent = description;
  
  // Stop current stream if playing (and track it)
  if (currentRadio) {
    trackRadioStop();
    audio.pause();
    audio.src = '';
  }
  
  // Start new stream
  audio.src = url;
  audio.load();
  audio.play().catch(err => {
    console.error('Playback error:', err);
    showErrorModal();
  });
  
  currentRadio = { url, name, description };
  radioStartTime = Date.now();
}

function stopRadio() {
  const player = document.getElementById('radioPlayer');
  const audio = document.getElementById('radioAudio');
  
  // Track before stopping
  trackRadioStop();
  
  audio.pause();
  audio.src = '';
  player.style.display = 'none';
  currentRadio = null;
}

// ============= RADIO TRACKING =============
var radioStartTime = null;

function trackRadioStop() {
  if (currentRadio && radioStartTime) {
    var listenDuration = (Date.now() - radioStartTime) / 1000; // seconds
    
    // Only track if listened for at least 30 seconds
    if (listenDuration >= 30) {
      fetch('/api/track/radio', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          url: currentRadio.url,
          name: currentRadio.name,
          listenTime: listenDuration
        })
      }).catch(err => console.error('Radio tracking error:', err));
    }
    
    radioStartTime = null;
  }
}

// Track radio on page unload - use sendBeacon for reliability
window.addEventListener('beforeunload', function() {
  if (currentRadio && radioStartTime) {
    var listenDuration = (Date.now() - radioStartTime) / 1000;
    if (listenDuration >= 30) {
      navigator.sendBeacon('/api/track/radio', JSON.stringify({
        url: currentRadio.url,
        name: currentRadio.name,
        listenTime: listenDuration
      }));
    }
  }
});

document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=radio';
  }
});

// Toggle Radio Favorite (v3.8)
async function toggleRadioFavorite(url, title, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/favorite/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: 'radio',
                mediaId: 0,
                filepath: url,
                title: title,
                posterUrl: ''
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isFavorite);
        }
    } catch (err) {
        console.error('Favorite toggle error:', err);
    }
}

// Auto-play from favorites (v5.1)
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const playUrl = urlParams.get('play');
    
    if (playUrl) {
        // Find the radio item with this URL and auto-play it
        const decodedUrl = decodeURIComponent(playUrl);
        const radioItem = document.querySelector('.radio-item[data-url="' + decodedUrl + '"]');
        
        if (radioItem) {
            const name = radioItem.dataset.name || 'Radio Station';
            const description = radioItem.dataset.description || '';
            
            // Scroll to the item
            radioItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            radioItem.style.outline = '3px solid #22c55e';
            
            // Auto-play after a short delay
            setTimeout(function() {
                playRadio(encodeURIComponent(decodedUrl), name, description);
            }, 500);
        } else {
            // Station not found on current page, just play the URL
            setTimeout(function() {
                playRadio(encodeURIComponent(decodedUrl), 'Favorite Station', '');
            }, 500);
        }
    }
});
</script>

<style>
/* Radio Action Buttons (v3.8) */
.radio-item {
    position: relative;
    display: flex;
    flex-direction: column;
}

.radio-clickable {
    cursor: pointer;
    flex: 1;
}

.radio-actions {
    display: flex;
    gap: 4px;
    padding: 6px 10px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(22, 163, 74, 0.5));
    border-radius: 0 0 12px 12px;
    justify-content: flex-start;
}

.action-btn {
    width: 26px;
    height: 26px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: rgba(255,255,255,0.35);
    transform: scale(1.1);
}

.action-btn.active {
    background: rgba(255,255,255,0.9);
    color: #ef4444;
}
</style>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Radio"
}

# ============================================================================
# INTERNET TV PAGE
# ============================================================================

function Get-TVPage {
    param(
        [string]$Filter = "all",
        [int]$Page = 1
    )
    
    # Channels per page (v4.9: increased to 100 for consistency)
    $channelsPerPage = 100
    
    # Get unique countries from TV channels (up to 10)
    $allCountries = ($CONFIG.TVChannels | Select-Object -ExpandProperty Country -Unique | Sort-Object) | Select-Object -First 10
    
    # Get TV channels based on filter
    $allFilteredChannels = switch ($Filter) {
        default {
            if ($Filter -eq "all") {
                $CONFIG.TVChannels
            } else {
                # Filter by country (case-insensitive match)
                $CONFIG.TVChannels | Where-Object { $_.Country -ieq $Filter }
            }
        }
    }
    
    # Calculate pagination
    $totalChannels = @($allFilteredChannels).Count
    $totalPages = [math]::Ceiling($totalChannels / $channelsPerPage)
    if ($Page -lt 1) { $Page = 1 }
    if ($Page -gt $totalPages -and $totalPages -gt 0) { $Page = $totalPages }
    
    $skipCount = ($Page - 1) * $channelsPerPage
    $channels = $allFilteredChannels | Select-Object -Skip $skipCount -First $channelsPerPage
    
    $tvItems = ""
    $index = 0
    foreach ($channel in $channels) {
        $index++
        
        # Generate a gradient background based on genre
        $gradientStyle = switch -Regex ($channel.Genre) {
            "News" { "background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.1));" }
            "Business" { "background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(16,185,129,0.1));" }
            "Sports" { "background: linear-gradient(135deg, rgba(251,146,60,0.2), rgba(234,88,12,0.1));" }
            "Entertainment" { "background: linear-gradient(135deg, rgba(236,72,153,0.2), rgba(219,39,119,0.1));" }
            "Documentary" { "background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(147,51,234,0.1));" }
            "Kids" { "background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.1));" }
            "Music" { "background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1));" }
            default { "background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(59,130,246,0.1));" }
        }
        
        # Emoji based on genre
        $emoji = switch -Regex ($channel.Genre) {
            "News" { "📺" }
            "Business" { "💼" }
            "Sports" { "⚽" }
            "Entertainment" { "🎬" }
            "Documentary" { "🎥" }
            "Kids" { "🧸" }
            "Music" { "🎵" }
            default { "📡" }
        }
        
        $encodedURL = [System.Web.HttpUtility]::UrlEncode($channel.URL)
        $encodedName = [System.Web.HttpUtility]::HtmlEncode($channel.Name)
        $encodedDesc = [System.Web.HttpUtility]::HtmlEncode($channel.Description)
        
        # Use logo if available, otherwise use emoji with gradient
        $thumbContent = ""
        if ($channel.Logo -and -not [string]::IsNullOrWhiteSpace($channel.Logo)) {
            # Check if logo is a local file (no http/https) or external URL
            if ($channel.Logo -like "http*") {
                $logoURL = $channel.Logo
            } else {
                $logoURL = "/$($channel.Logo)"
            }
            $thumbContent = "<div class='thumb' style='$gradientStyle background-image: url(""$logoURL""); background-size: 60%; background-repeat: no-repeat; background-position: center;'></div>"
        } else {
            $thumbContent = "<div class='thumb' style='$gradientStyle display:flex; align-items:center; justify-content:center; font-size:48px;'>$emoji</div>"
        }
        
        $tvItems += @"
<div class="item tv-channel-item" data-url="$($channel.URL)" data-name="$($channel.Name)" data-description="$($channel.Description)" onclick="playTV('$encodedURL', '$encodedName', '$encodedDesc')">
  $thumbContent
  <div class="flag tv" style="background: rgba(96,165,250,0.9);">LIVE</div>
  <div class="corner">$($channel.Country)</div>
  <div class="meta">
    <strong>$($channel.Name)</strong>
    <span>$($channel.Genre)</span>
    <span style="font-size:11px; opacity:0.7;">$($channel.Description)</span>
  </div>
</div>
"@
    }
    
    # Build country filter chips dynamically
    $countryChips = ""
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    
    # Country flag mappings
    $countryFlags = @{
        "France" = "fr"
        "USA" = "us"
        "UK" = "gb"
        "Germany" = "de"
        "Spain" = "es"
        "Italy" = "it"
        "Qatar" = "qa"
        "China" = "cn"
        "Japan" = "jp"
        "South Korea" = "kr"
        "International" = "un"
    }
    
    foreach ($country in $allCountries) {
        $countryActive = if ($Filter -ieq $country) { "on" } else { "" }
        $countryLower = $country.ToLower().Replace(" ", "")
        $flagCode = if ($countryFlags.ContainsKey($country)) { $countryFlags[$country] } else { "un" }
        $countryChips += "<div class='chip $countryActive' onclick=""window.location.href='/tv?filter=$countryLower'""><img src='/menu/$flagCode.png' alt='$country' style='width:16px; height:12px; vertical-align:middle; margin-right:4px;'> $country</div>`n"
    }
    
    # Determine title based on filter
    $titleText = if ($Filter -eq "all") { 
        "Internet TV - All Channels" 
    } else { 
        "$Filter TV Channels"
    }
    
    # Build pagination controls using helper function (v4.9)
    $baseUrl = "/tv?filter=$Filter"
    $paginationHtml = Get-PaginationHtml -CurrentPage $Page -TotalPages $totalPages -TotalItems $totalChannels -BaseUrl $baseUrl -ItemsPerPage $channelsPerPage
    
    # Calculate displayed item range (v4.9)
    $startItem = $skipCount + 1
    $endItem = [math]::Min($skipCount + @($channels).Count, $totalChannels)
    $channelCountText = if ($totalPages -gt 1) { "Showing $startItem-$endItem of $totalChannels channels" } else { "$totalChannels channels" }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search TV channels…" id="searchInput" />
  </div>
  <div class="seg" style="flex-wrap: wrap; gap: 8px;">
    <div class="chip $allActive" onclick="window.location.href='/tv?filter=all'">All</div>
    $countryChips
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$channelCountText</span>
      </div>
      <div class="actions">
        <div class="small" onclick="stopTV()" style="cursor:pointer;">⏹️ Stop</div>
      </div>
    </div>
    <div class="grid">
      $tvItems
    </div>
    $paginationHtml
  </section>
  
  <!-- TV Player Modal -->
  <div id="tvPlayerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 2000; align-items: center; justify-content: center;">
    <div style="width: 90%; max-width: 1200px; background: var(--panel); border-radius: 20px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
      <div style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--stroke);">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="font-size: 24px;">📺</div>
          <div>
            <div id="tvNowPlaying" style="font-weight: 600; font-size: 16px;">Select a channel</div>
            <div id="tvDescription" style="font-size: 12px; color: var(--muted);">Click a channel to start watching</div>
          </div>
        </div>
        <div onclick="stopTV()" style="cursor: pointer; font-size: 28px; opacity: 0.7; transition: opacity 0.2s; padding: 8px;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">✕</div>
      </div>
      <div style="position: relative; padding-top: 56.25%; background: #000;">
        <video id="tvVideo" controls autoplay style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" playsinline></video>
      </div>
    </div>
  </div>
  
  <!-- Error Modal -->
  <div id="tvErrorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: var(--panel); border: 1px solid var(--stroke); border-radius: 20px; padding: 32px; max-width: 440px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: modalSlideIn 0.3s ease;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="font-size: 64px; margin-bottom: 16px;">📺</div>
        <h2 style="margin: 0 0 12px 0; font-size: 22px; font-weight: 600; color: var(--text);">Unable to Play Channel</h2>
        <p style="margin: 0; color: var(--muted); font-size: 15px; line-height: 1.6;">
          This TV stream couldn't be played. This may happen if:
        </p>
      </div>
      <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 10px;">
          <div style="font-size: 20px;">🌍</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">Geographic Restriction</div>
            <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">The channel may be geo-locked to a specific country or region</div>
          </div>
        </div>
        <div style="display: flex; align-items: start; gap: 12px;">
          <div style="font-size: 20px;">🔗</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">Stream URL Changed</div>
            <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">The streaming link may have been updated by the broadcaster</div>
          </div>
        </div>
      </div>
      <button onclick="closeTVErrorModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(96,165,250,0.9), rgba(59,130,246,0.9)); border: none; border-radius: 12px; color: white; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(96,165,250,0.3);" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        OK, Got It
      </button>
    </div>
  </div>
  
  <style>
  @keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-20px) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }
  </style>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
let currentTV = null;
let hlsPlayer = null;

function showTVErrorModal() {
  document.getElementById('tvErrorModal').style.display = 'flex';
}

function closeTVErrorModal() {
  document.getElementById('tvErrorModal').style.display = 'none';
}

document.getElementById('tvErrorModal')?.addEventListener('click', function(e) {
  if (e.target === this) closeTVErrorModal();
});

function playTV(url, name, description) {
  const modal = document.getElementById('tvPlayerModal');
  const video = document.getElementById('tvVideo');
  const nowPlaying = document.getElementById('tvNowPlaying');
  const desc = document.getElementById('tvDescription');
  
  // Decode URL
  url = decodeURIComponent(url);
  
  // Show modal
  modal.style.display = 'flex';
  
  // Update UI
  nowPlaying.textContent = name;
  desc.textContent = description;
  
  // Stop current stream if playing
  if (hlsPlayer) {
    hlsPlayer.destroy();
    hlsPlayer = null;
  }
  video.pause();
  video.src = '';
  
  // Check if it's an HLS stream
  if (url.includes('.m3u8')) {
    if (Hls.isSupported()) {
      hlsPlayer = new Hls({
        enableWorker: true,
        lowLatencyMode: true
      });
      hlsPlayer.loadSource(url);
      hlsPlayer.attachMedia(video);
      hlsPlayer.on(Hls.Events.MANIFEST_PARSED, function() {
        video.play().catch(err => {
          console.error('Playback error:', err);
          showTVErrorModal();
        });
      });
      hlsPlayer.on(Hls.Events.ERROR, function(event, data) {
        if (data.fatal) {
          console.error('HLS error:', data);
          showTVErrorModal();
        }
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      // Safari native HLS support
      video.src = url;
      video.addEventListener('loadedmetadata', function() {
        video.play().catch(err => {
          console.error('Playback error:', err);
          showTVErrorModal();
        });
      });
    } else {
      showTVErrorModal();
    }
  } else {
    // Direct video URL
    video.src = url;
    video.load();
    video.play().catch(err => {
      console.error('Playback error:', err);
      showTVErrorModal();
    });
  }
  
  currentTV = { url, name, description };
}

function stopTV() {
  const modal = document.getElementById('tvPlayerModal');
  const video = document.getElementById('tvVideo');
  
  if (hlsPlayer) {
    hlsPlayer.destroy();
    hlsPlayer = null;
  }
  video.pause();
  video.src = '';
  modal.style.display = 'none';
  currentTV = null;
}

// Close modal when clicking outside video
document.getElementById('tvPlayerModal')?.addEventListener('click', function(e) {
  if (e.target === this) stopTV();
});

// ESC key to close
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && currentTV) stopTV();
});

document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=tv';
  }
});

// Auto-play from favorites (v5.1)
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const playUrl = urlParams.get('play');
    
    if (playUrl) {
        // Find the TV channel item with this URL and auto-play it
        const decodedUrl = decodeURIComponent(playUrl);
        const tvItem = document.querySelector('.tv-channel-item[data-url="' + decodedUrl + '"]');
        
        if (tvItem) {
            const name = tvItem.dataset.name || 'TV Channel';
            const description = tvItem.dataset.description || '';
            
            // Scroll to the item
            tvItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            tvItem.style.outline = '3px solid #60a5fa';
            
            // Auto-play after a short delay
            setTimeout(function() {
                playTV(encodeURIComponent(decodedUrl), name, description);
            }, 500);
        } else {
            // Channel not found on current page, just play the URL
            setTimeout(function() {
                playTV(encodeURIComponent(decodedUrl), 'Favorite Channel', '');
            }, 500);
        }
    }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Internet TV"
}

# ============================================================================
# MUSIC VIDEOS PAGE FUNCTIONS (v7.10)
# ============================================================================

function Get-MusicVideosPage {
    param(
        [string]$Filter = "all",
        [int]$Page = 1  # v4.9: Pagination
    )
    
    # Pagination settings (v4.9)
    $itemsPerPage = 100
    
    # Check if Music Videos is enabled
    if (-not $CONFIG.MusicVideosEnabled) {
        return Get-HTMLPage -Content "<h1>Music Videos Disabled</h1><p>Enable MusicVideos in NexusM.conf to use this feature.</p>" -Title "Feature Disabled"
    }
    
    # Get total count first for pagination (v4.9)
    $totalMusicVideos = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos").count
    $totalPages = [math]::Ceiling($totalMusicVideos / $itemsPerPage)
    if ($Page -lt 1) { $Page = 1 }
    if ($Page -gt $totalPages -and $totalPages -gt 0) { $Page = $totalPages }
    $skipCount = ($Page - 1) * $itemsPerPage
    
    # ============================================================================
    # USER FAVORITES & WATCHED STATUS (v3.8)
    # ============================================================================
    
    $favoritesLookup = @{}
    $watchedLookup = @{}
    
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $userDbPath = Join-Path $CONFIG.UsersDBPath "$($Global:CurrentUser.Username).db"
        if (Test-Path $userDbPath) {
            try {
                # Get all favorites for music videos
                $userFavorites = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT media_id FROM favorites WHERE media_type = 'musicvideo'")
                foreach ($fav in $userFavorites) {
                    $favoritesLookup[$fav.media_id] = $true
                }
                
                # Get all watched items
                $userWatched = @(Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT media_id FROM watched WHERE media_type = 'musicvideo'")
                foreach ($w in $userWatched) {
                    $watchedLookup[$w.media_id] = $true
                }
            } catch {
                Write-Host "[!] Error loading user favorites/watched: $_" -ForegroundColor Yellow
            }
        }
    }
    
    # Get music videos based on filter with pagination (v4.9)
    $query = switch ($Filter) {
        "artist" {
            "SELECT * FROM musicvideos ORDER BY artist, title LIMIT $itemsPerPage OFFSET $skipCount"
        }
        "year" {
            "SELECT * FROM musicvideos ORDER BY year DESC, title LIMIT $itemsPerPage OFFSET $skipCount"
        }
        default {  # "all"
            "SELECT * FROM musicvideos ORDER BY title LIMIT $itemsPerPage OFFSET $skipCount"
        }
    }
    
    $allVideos = @(Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query $query)
    
    # Count videos without thumbnails (from total, not just current page)
    $videosWithoutThumbs = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos WHERE thumbnail_path IS NULL OR thumbnail_path = ''").count
    
    # v7.54: Count videos needing optimization
    $videosNeedingOpt = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos WHERE needs_optimization = 1 AND mp4_compliant = 1").count
    
    # v7.65: Count non-compliant videos (problematic MP4 structure)
    $videosNonCompliant = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos WHERE mp4_compliant = 0").count
    
    # v7.56: Count MP4 videos not yet analyzed (moov_position is NULL)
    $videosUnanalyzed = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos WHERE (moov_position IS NULL OR moov_position = '') AND LOWER(format) IN ('mp4', 'm4v', 'mov', 'm4a')").count
    
    $videoItems = ""
    foreach ($video in $allVideos) {
        $size = [math]::Round($video.size_bytes / 1MB, 1)
        $artist = if ($video.artist) { $video.artist } else { "Unknown Artist" }
        $year = if ($video.year) { " ($($video.year))" } else { "" }
        
        # Check if thumbnail exists
        $thumbStyle = ""
        if ($video.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($video.thumbnail_path)) {
            $thumbStyle = "background-image: url('/mvthumb/$($video.thumbnail_path)'); background-size: cover; background-position: center;"
        } else {
            $thumbStyle = "background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(99,102,241,0.3));"
        }
        
        # Check favorite/watched status (v3.8)
        $isFavorite = $favoritesLookup[$video.id]
        $isWatched = $watchedLookup[$video.id]
        $favClass = if ($isFavorite) { 'active' } else { '' }
        $watchedClass = if ($isWatched) { 'active' } else { '' }
        
        # Escape title and other fields for JavaScript (v6.99)
        $titleEscaped = ($video.title -replace "'", "\'") -replace '"', '&quot;'
        $posterUrlEscaped = ($video.thumbnail_path -replace "'", "\'") -replace '"', '&quot;'
        $artistEscaped = (($video.artist -replace "'", "\'") -replace '"', '&quot;') -replace $null, ''
        $albumEscaped = (($video.album -replace "'", "\'") -replace '"', '&quot;') -replace $null, ''
        $genreEscaped = (($video.genre -replace "'", "\'") -replace '"', '&quot;') -replace $null, ''
        $yearValue = if ($video.year) { $video.year } else { '' }
        
        # v7.65: Check if video is non-compliant (problematic MP4 structure)
        $nonCompliantBadge = ""
        $nonCompliantOverlay = ""
        if ($video.mp4_compliant -eq 0) {
            # Big prominent badge in center of thumbnail for non-compliant files
            $nonCompliantOverlay = '<div class="non-compliant-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(239, 68, 68, 0.85); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 15; pointer-events: none;"><span style="font-size: 48px;">⚠️</span><span style="color: white; font-weight: bold; font-size: 14px; text-align: center; padding: 5px; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">NON-COMPLIANT</span><span style="color: white; font-size: 11px; text-align: center; opacity: 0.9;">May not play correctly</span></div>'
            $nonCompliantBadge = '<div class="flag non-compliant" style="background: linear-gradient(135deg, #ef4444, #b91c1c); left: auto; right: 10px; top: 40px; z-index: 20;" title="This MP4 has a problematic structure and may not play correctly in browsers">❌ Non-Compliant</div>'
        }
        
        # v7.54: Check if video needs optimization (only show if compliant)
        $needsOptBadge = ""
        $fixButton = ""
        if ($video.mp4_compliant -ne 0 -and $video.needs_optimization -eq 1) {
            $needsOptBadge = '<div class="flag slow-start" style="background: linear-gradient(135deg, #f59e0b, #d97706); left: auto; right: 10px; top: 40px;" title="This MP4 has moov atom at end - slow to start streaming">⚠️ Slow Start</div>'
            $fixButton = "<button class=`"action-btn fix-mp4-btn`" onclick=`"fixMP4($($video.id), '$titleEscaped', this, event)`" title=`"Fix MP4 (move moov atom to start)`">🔧</button>"
        }
        
        $videoItems += @"
<div class="item mv-item" data-media-id="$($video.id)" data-needs-opt="$($video.needs_optimization)" data-compliant="$($video.mp4_compliant)">
  <a href="/play-musicvideo/$($video.id)" class="item-link">
    <div class="thumb" style="$thumbStyle">$nonCompliantOverlay</div>
    <div class="flag music-video" style="background: linear-gradient(135deg, #a855f7, #6366f1);">Music Video</div>
    $nonCompliantBadge
    $needsOptBadge
    <div class="corner">🎵</div>
    <div class="meta">
      <strong>$($video.title)$year</strong>
      <span>$artist</span>
      <span style="font-size:11px; opacity:0.7;">$size MB • $($video.format.ToUpper())</span>
    </div>
  </a>
  <div class="media-actions">
    <button class="action-btn favorite-btn $favClass" onclick="toggleFavorite('musicvideo', $($video.id), '$titleEscaped', '$posterUrlEscaped', this, event)" title="Add to Favorites">♥</button>
    <button class="action-btn watched-btn $watchedClass" onclick="toggleWatched('musicvideo', $($video.id), '$titleEscaped', this, event)" title="Mark as Watched">✓</button>
    $fixButton
    <button class="action-btn menu-btn" onclick="showMediaMenu($($video.id), '$titleEscaped', '$artistEscaped', '$albumEscaped', '$yearValue', '$genreEscaped', event)" title="More Options">⋮</button>
  </div>
</div>
"@
    }
    
    # Determine which chip is active
    $allActive = if ($Filter -eq "all") { "on" } else { "" }
    $artistActive = if ($Filter -eq "artist") { "on" } else { "" }
    $yearActive = if ($Filter -eq "year") { "on" } else { "" }
    
    # Get total size
    $totalSize = ($allVideos | Measure-Object -Property size_bytes -Sum).Sum
    $totalSizeGB = [math]::Round($totalSize / 1GB, 2)
    
    $titleText = switch ($Filter) {
        "artist" { "Music Videos - By Artist" }
        "year" { "Music Videos - By Year" }
        default { "All Music Videos" }
    }
    
    # Generate pagination HTML (v4.9)
    $baseUrl = "/musicvideos?filter=$Filter"
    $paginationHtml = Get-PaginationHtml -CurrentPage $Page -TotalPages $totalPages -TotalItems $totalMusicVideos -BaseUrl $baseUrl -ItemsPerPage $itemsPerPage
    
    # Calculate displayed item range (v4.9)
    $startItem = $skipCount + 1
    $endItem = [math]::Min($skipCount + @($allVideos).Count, $totalMusicVideos)
    $itemCountText = if ($totalPages -gt 1) { "Showing $startItem-$endItem of $totalMusicVideos videos" } else { "$totalMusicVideos videos" }
    
    # Show "Generate Thumbnails" button if there are videos without thumbnails
    $generateThumbsButton = ""
    if ($videosWithoutThumbs -gt 0) {
        $generateThumbsButton = @"
<button id="genThumbsBtn" onclick="generateThumbnails()" class="small" style="background: linear-gradient(135deg, rgba(34,197,94,0.3), rgba(16,185,129,0.3)); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(34,197,94,0.5); cursor: pointer;">
  🖼️ Generate Thumbnails ($videosWithoutThumbs)
</button>
"@
    }
    
    # v7.54: Show "Fix All MP4s" button if there are videos needing optimization
    $fixAllButton = ""
    if ($videosNeedingOpt -gt 0) {
        $fixAllButton = @"
<button id="fixAllBtn" onclick="fixAllMP4s()" class="small" style="background: linear-gradient(135deg, rgba(245,158,11,0.3), rgba(217,119,6,0.3)); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(245,158,11,0.5); cursor: pointer;">
  🔧 Fix All MP4s ($videosNeedingOpt)
</button>
"@
    }
    
    # v7.56: Show "Analyze Videos" button if there are unanalyzed MP4 videos
    $analyzeButton = ""
    if ($videosUnanalyzed -gt 0) {
        $analyzeButton = @"
<button id="analyzeBtn" onclick="analyzeVideos()" class="small" style="background: linear-gradient(135deg, rgba(59,130,246,0.3), rgba(37,99,235,0.3)); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(59,130,246,0.5); cursor: pointer;">
  🔍 Analyze Videos ($videosUnanalyzed)
</button>
"@
    }
    
    # v7.65: Show warning banner for non-compliant videos
    $nonCompliantBanner = ""
    if ($videosNonCompliant -gt 0) {
        $nonCompliantBanner = @"
<div style="background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(185,28,28,0.2)); border: 1px solid rgba(239,68,68,0.5); border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
  <span style="font-size: 24px;">⚠️</span>
  <div>
    <strong style="color: #fca5a5;">$videosNonCompliant Non-Compliant Video$(if ($videosNonCompliant -ne 1) { 's' })</strong>
    <p style="margin: 4px 0 0 0; font-size: 13px; opacity: 0.8;">These files have a problematic MP4 structure (fragmented/DASH) and may not play correctly in browsers. Consider re-downloading or re-encoding them.</p>
  </div>
</div>
"@
    }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search music videos…" id="searchInput" />
  </div>
  <div class="seg">
    <div class="chip $allActive" onclick="window.location.href='/musicvideos?filter=all'">All</div>
    <div class="chip $artistActive" onclick="window.location.href='/musicvideos?filter=artist'">By Artist</div>
    <div class="chip $yearActive" onclick="window.location.href='/musicvideos?filter=year'">By Year</div>
  </div>
</div>

<div class="content">
  $nonCompliantBanner
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>$titleText</strong>
        <span>$itemCountText • $totalSizeGB GB</span>
      </div>
      <div class="actions">
        $analyzeButton
        $fixAllButton
        $generateThumbsButton
        <a href="/play-musicvideo/shuffle" class="small" style="text-decoration:none; color:inherit; background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(99,102,241,0.3)); padding: 8px 16px; border-radius: 8px; border: 1px solid rgba(168,85,247,0.5);">🔀 Shuffle Play</a>
      </div>
    </div>
    <div class="grid">
      $videoItems
    </div>
    $paginationHtml
  </section>
</div>

<!-- Thumbnail Generation Modal -->
<div id="thumbModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;">
  <div style="background: var(--panel); border: 1px solid var(--stroke); border-radius: 20px; padding: 32px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
    <div style="text-align: center; margin-bottom: 24px;">
      <div style="font-size: 64px; margin-bottom: 16px;" id="thumbIcon">🖼️</div>
      <h2 style="margin: 0 0 12px 0; font-size: 22px; font-weight: 600;" id="thumbTitle">Generating Thumbnails</h2>
      <p style="margin: 0; color: var(--muted); font-size: 15px;" id="thumbMessage">This may take a few minutes...</p>
    </div>
    <div id="thumbProgress" style="background: rgba(255,255,255,0.1); border-radius: 8px; height: 12px; overflow: hidden; margin-bottom: 16px;">
      <div id="thumbProgressBar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #a855f7, #6366f1); transition: width 0.3s;"></div>
    </div>
    <div id="thumbStats" style="display: flex; justify-content: space-around; font-size: 14px; color: var(--muted);">
      <span>Processed: <strong id="thumbProcessed">0</strong></span>
      <span>Generated: <strong id="thumbGenerated">0</strong></span>
      <span>Skipped: <strong id="thumbSkipped">0</strong></span>
    </div>
    <button id="thumbCloseBtn" onclick="closeThumbModal()" style="display: none; width: 100%; margin-top: 20px; padding: 14px; background: linear-gradient(135deg, #a855f7, #6366f1); border: none; border-radius: 12px; color: white; font-weight: 600; font-size: 15px; cursor: pointer;">
      Done - Refresh Page
    </button>
  </div>
</div>

<script>
document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + '&type=musicvideos';
  }
});

function generateThumbnails() {
  // Show modal
  document.getElementById('thumbModal').style.display = 'flex';
  document.getElementById('thumbCloseBtn').style.display = 'none';
  document.getElementById('thumbIcon').textContent = '⏳';
  document.getElementById('thumbTitle').textContent = 'Generating Thumbnails';
  document.getElementById('thumbMessage').textContent = 'This may take a few minutes...';
  document.getElementById('thumbProgressBar').style.width = '0%';
  
  // Disable button
  var btn = document.getElementById('genThumbsBtn');
  if (btn) {
    btn.disabled = true;
    btn.innerHTML = '⏳ Generating...';
  }
  
  // Start generation
  fetch('/api/musicvideo/generate-thumbnails', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.getElementById('thumbIcon').textContent = '✓';
      document.getElementById('thumbTitle').textContent = 'Thumbnails Generated!';
      document.getElementById('thumbMessage').textContent = 'Click below to see the results';
      document.getElementById('thumbProgressBar').style.width = '100%';
      document.getElementById('thumbProcessed').textContent = data.processed || 0;
      document.getElementById('thumbGenerated').textContent = data.generated || 0;
      document.getElementById('thumbSkipped').textContent = data.skipped || 0;
    } else {
      document.getElementById('thumbIcon').textContent = '⚠️';
      document.getElementById('thumbTitle').textContent = 'Error';
      document.getElementById('thumbMessage').textContent = data.error || 'Failed to generate thumbnails';
    }
    document.getElementById('thumbCloseBtn').style.display = 'block';
  })
  .catch(err => {
    document.getElementById('thumbIcon').textContent = '⚠️';
    document.getElementById('thumbTitle').textContent = 'Error';
    document.getElementById('thumbMessage').textContent = 'Network error: ' + err.message;
    document.getElementById('thumbCloseBtn').style.display = 'block';
  });
}

function closeThumbModal() {
  document.getElementById('thumbModal').style.display = 'none';
  window.location.reload();
}

// v7.56: Analyze MP4 videos for moov atom placement
async function analyzeVideos() {
    // Show the modal
    document.getElementById('thumbModal').style.display = 'flex';
    document.getElementById('thumbCloseBtn').style.display = 'none';
    document.getElementById('thumbIcon').textContent = '🔍';
    document.getElementById('thumbTitle').textContent = 'Analyzing MP4 Videos';
    document.getElementById('thumbMessage').textContent = 'Checking moov atom placement...';
    document.getElementById('thumbProgressBar').style.width = '0%';
    
    // Update labels for this context
    document.querySelector('#thumbStats span:nth-child(1)').innerHTML = 'Analyzed: <strong id="thumbProcessed">0</strong>';
    document.querySelector('#thumbStats span:nth-child(2)').innerHTML = 'Need Fix: <strong id="thumbGenerated">0</strong>';
    document.querySelector('#thumbStats span:nth-child(3)').innerHTML = 'OK: <strong id="thumbSkipped">0</strong>';
    
    // Disable button
    var btn = document.getElementById('analyzeBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '⏳ Analyzing...';
    }
    
    try {
        const response = await fetch('/api/musicvideo/analyze-mp4s', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('thumbIcon').textContent = '✓';
            document.getElementById('thumbTitle').textContent = 'Analysis Complete!';
            if (result.needsOptimization > 0) {
                document.getElementById('thumbMessage').textContent = result.needsOptimization + ' video(s) need optimization. Use "Fix All MP4s" to repair them.';
            } else {
                document.getElementById('thumbMessage').textContent = 'All videos are optimized for streaming!';
            }
            document.getElementById('thumbProgressBar').style.width = '100%';
            document.getElementById('thumbProcessed').textContent = result.analyzed || 0;
            document.getElementById('thumbGenerated').textContent = result.needsOptimization || 0;
            document.getElementById('thumbSkipped').textContent = result.optimized || 0;
        } else {
            document.getElementById('thumbIcon').textContent = '⚠️';
            document.getElementById('thumbTitle').textContent = 'Error';
            document.getElementById('thumbMessage').textContent = result.message || 'Failed to analyze videos';
        }
        document.getElementById('thumbCloseBtn').style.display = 'block';
    } catch (err) {
        document.getElementById('thumbIcon').textContent = '⚠️';
        document.getElementById('thumbTitle').textContent = 'Error';
        document.getElementById('thumbMessage').textContent = 'Network error: ' + err.message;
        document.getElementById('thumbCloseBtn').style.display = 'block';
    }
}

// v7.54: Fix single MP4 file
async function fixMP4(videoId, title, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    if (!confirm('Fix "' + title + '"?\n\nThis will remux the MP4 to move the moov atom to the start for faster streaming. The original file will be replaced.')) {
        return;
    }
    
    // Disable button and show loading
    btn.disabled = true;
    btn.innerHTML = '⏳';
    btn.title = 'Fixing...';
    
    try {
        const response = await fetch('/api/musicvideo/fix-mp4/' + videoId, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            // Remove the fix button and warning badge
            const item = document.querySelector('.mv-item[data-media-id="' + videoId + '"]');
            if (item) {
                const badge = item.querySelector('.slow-start');
                if (badge) badge.remove();
                btn.remove();
                item.dataset.needsOpt = '0';
            }
            
            // Update fix all button count if exists
            const fixAllBtn = document.getElementById('fixAllBtn');
            if (fixAllBtn) {
                const currentCount = parseInt(fixAllBtn.textContent.match(/\d+/)[0]) - 1;
                if (currentCount <= 0) {
                    fixAllBtn.remove();
                } else {
                    fixAllBtn.innerHTML = '🔧 Fix All MP4s (' + currentCount + ')';
                }
            }
        } else {
            alert('Failed to fix MP4: ' + (result.message || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = '🔧';
            btn.title = 'Fix MP4 (move moov atom to start)';
        }
    } catch (err) {
        console.error('Fix MP4 error:', err);
        alert('Network error: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '🔧';
        btn.title = 'Fix MP4 (move moov atom to start)';
    }
}

// v7.54: Fix all MP4 files that need optimization
async function fixAllMP4s() {
    const count = document.querySelectorAll('.mv-item[data-needs-opt="1"]').length;
    if (!confirm('Fix all ' + count + ' MP4 files?\n\nThis will remux each MP4 to move the moov atom to the start for faster streaming. Original files will be replaced.\n\nThis may take several minutes.')) {
        return;
    }
    
    // Show the modal (reuse thumb modal)
    document.getElementById('thumbModal').style.display = 'flex';
    document.getElementById('thumbCloseBtn').style.display = 'none';
    document.getElementById('thumbIcon').textContent = '🔧';
    document.getElementById('thumbTitle').textContent = 'Fixing MP4 Files';
    document.getElementById('thumbMessage').textContent = 'This may take several minutes...';
    document.getElementById('thumbProgressBar').style.width = '0%';
    document.getElementById('thumbProcessed').textContent = '0';
    document.getElementById('thumbGenerated').textContent = '0';
    document.getElementById('thumbSkipped').textContent = '0';
    
    // Update labels for this context
    document.querySelector('#thumbStats span:nth-child(1)').innerHTML = 'Processed: <strong id="thumbProcessed">0</strong>';
    document.querySelector('#thumbStats span:nth-child(2)').innerHTML = 'Fixed: <strong id="thumbGenerated">0</strong>';
    document.querySelector('#thumbStats span:nth-child(3)').innerHTML = 'Failed: <strong id="thumbSkipped">0</strong>';
    
    // Disable button
    var btn = document.getElementById('fixAllBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '⏳ Fixing...';
    }
    
    try {
        const response = await fetch('/api/musicvideo/fix-all-mp4s', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('thumbIcon').textContent = '✓';
            document.getElementById('thumbTitle').textContent = 'MP4 Files Fixed!';
            document.getElementById('thumbMessage').textContent = 'Click below to see the results';
            document.getElementById('thumbProgressBar').style.width = '100%';
            document.getElementById('thumbProcessed').textContent = result.processed || 0;
            document.getElementById('thumbGenerated').textContent = result.fixed || 0;
            document.getElementById('thumbSkipped').textContent = result.failed || 0;
        } else {
            document.getElementById('thumbIcon').textContent = '⚠️';
            document.getElementById('thumbTitle').textContent = 'Error';
            document.getElementById('thumbMessage').textContent = result.message || 'Failed to fix MP4 files';
        }
        document.getElementById('thumbCloseBtn').style.display = 'block';
    } catch (err) {
        document.getElementById('thumbIcon').textContent = '⚠️';
        document.getElementById('thumbTitle').textContent = 'Error';
        document.getElementById('thumbMessage').textContent = 'Network error: ' + err.message;
        document.getElementById('thumbCloseBtn').style.display = 'block';
    }
}

// Toggle Favorite (v3.8)
async function toggleFavorite(mediaType, mediaId, title, posterUrl, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/favorite/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: mediaType,
                mediaId: mediaId,
                title: title,
                posterUrl: posterUrl
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isFavorite);
        }
    } catch (err) {
        console.error('Favorite toggle error:', err);
    }
}

// Toggle Watched (v3.8)
async function toggleWatched(mediaType, mediaId, title, btn, event) {
    event.preventDefault();
    event.stopPropagation();
    
    try {
        const response = await fetch('/api/watched/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mediaType: mediaType,
                mediaId: mediaId,
                title: title
            })
        });
        
        const result = await response.json();
        if (result.success) {
            btn.classList.toggle('active', result.isWatched);
        }
    } catch (err) {
        console.error('Watched toggle error:', err);
    }
}

// Show Media Menu (v6.99 - Context menu with Edit Metadata and Details)
let activeContextMenu = null;
let currentMusicVideoId = null;
let currentMusicVideoData = null;

function showMediaMenu(videoId, title, artist, album, year, genre, event) {
    event.preventDefault();
    event.stopPropagation();
    
    // Close any existing context menu
    closeContextMenu();
    
    currentMusicVideoId = videoId;
    currentMusicVideoData = { title: title, artist: artist, album: album, year: year, genre: genre };
    
    // Create context menu
    const menu = document.createElement('div');
    menu.id = 'mvContextMenu';
    menu.className = 'mv-context-menu';
    menu.innerHTML = '<div class="mv-menu-item" onclick="openEditMusicVideoModal()">' +
        '<span class="mv-menu-icon">✏️</span>' +
        '<span>Edit Metadata</span>' +
        '</div>' +
        '<div class="mv-menu-item" onclick="showMusicVideoDetails(' + videoId + ')">' +
        '<span class="mv-menu-icon">ℹ️</span>' +
        '<span>Details</span>' +
        '</div>';
    
    // Position menu near the button
    const rect = event.target.getBoundingClientRect();
    menu.style.position = 'fixed';
    menu.style.top = (rect.bottom + 5) + 'px';
    menu.style.left = (rect.left - 100) + 'px';
    
    // Ensure menu stays within viewport
    document.body.appendChild(menu);
    const menuRect = menu.getBoundingClientRect();
    if (menuRect.right > window.innerWidth) {
        menu.style.left = (window.innerWidth - menuRect.width - 10) + 'px';
    }
    if (menuRect.bottom > window.innerHeight) {
        menu.style.top = (rect.top - menuRect.height - 5) + 'px';
    }
    
    activeContextMenu = menu;
    
    // Close on outside click
    setTimeout(function() {
        document.addEventListener('click', closeContextMenuOnOutside);
    }, 10);
}

function closeContextMenu() {
    if (activeContextMenu) {
        activeContextMenu.remove();
        activeContextMenu = null;
    }
    document.removeEventListener('click', closeContextMenuOnOutside);
}

function closeContextMenuOnOutside(event) {
    if (activeContextMenu && !activeContextMenu.contains(event.target)) {
        closeContextMenu();
    }
}

function openEditMusicVideoModal() {
    closeContextMenu();
    
    // Fetch current data from server to ensure we have all fields
    fetch('/api/musicvideo/get?id=' + currentMusicVideoId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var v = data.video;
                document.getElementById('mv_edit_id').value = v.id;
                document.getElementById('mv_edit_title').value = v.title || '';
                document.getElementById('mv_edit_artist').value = v.artist || '';
                document.getElementById('mv_edit_album').value = v.album || '';
                document.getElementById('mv_edit_year').value = v.year || '';
                document.getElementById('mv_edit_genre').value = v.genre || '';
                
                // Reset thumbnail upload
                document.getElementById('mv_edit_thumbnail').value = '';
                document.getElementById('mvThumbnailPreview').style.display = 'none';
                mvThumbnailData = null;
                
                document.getElementById('mvEditModal').style.display = 'flex';
            } else {
                alert('Error loading video data: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            alert('Error: ' + err.message);
        });
}

function closeMvEditModal() {
    document.getElementById('mvEditModal').style.display = 'none';
    mvThumbnailData = null;
}

let mvThumbnailData = null;

function handleMvThumbnailUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!file.type.match(/^image\/(jpeg|jpg|png)$/)) {
        alert('Please select a JPG or PNG image');
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            // Create canvas for resizing if needed
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Target size: 320x180 (16:9 aspect ratio for video thumbnails)
            const targetWidth = 320;
            const targetHeight = 180;
            
            canvas.width = targetWidth;
            canvas.height = targetHeight;
            
            // Calculate crop area to maintain aspect ratio
            const srcAspect = img.width / img.height;
            const targetAspect = targetWidth / targetHeight;
            
            let srcX = 0, srcY = 0, srcW = img.width, srcH = img.height;
            
            if (srcAspect > targetAspect) {
                srcW = img.height * targetAspect;
                srcX = (img.width - srcW) / 2;
            } else {
                srcH = img.width / targetAspect;
                srcY = (img.height - srcH) / 2;
            }
            
            ctx.drawImage(img, srcX, srcY, srcW, srcH, 0, 0, targetWidth, targetHeight);
            
            mvThumbnailData = canvas.toDataURL('image/jpeg', 0.9);
            
            // Show preview
            document.getElementById('mvThumbnailPreviewImg').src = mvThumbnailData;
            document.getElementById('mvThumbnailDimensions').textContent = targetWidth + ' x ' + targetHeight + 'px';
            document.getElementById('mvThumbnailPreview').style.display = 'block';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function saveMusicVideoMetadata() {
    var formData = {
        id: document.getElementById('mv_edit_id').value,
        title: document.getElementById('mv_edit_title').value,
        artist: document.getElementById('mv_edit_artist').value,
        album: document.getElementById('mv_edit_album').value,
        year: document.getElementById('mv_edit_year').value,
        genre: document.getElementById('mv_edit_genre').value,
        thumbnailImage: mvThumbnailData
    };
    
    fetch('/api/update-musicvideo', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            alert('Metadata updated successfully!');
            closeMvEditModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(function(err) {
        alert('Error: ' + err.message);
    });
}

function showMusicVideoDetails(videoId) {
    closeContextMenu();
    
    fetch('/api/musicvideo/get?id=' + videoId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.success) {
                var v = data.video;
                
                // Format file size
                var sizeBytes = v.size_bytes || 0;
                var sizeDisplay = '';
                if (sizeBytes >= 1073741824) {
                    sizeDisplay = (sizeBytes / 1073741824).toFixed(2) + ' GB';
                } else if (sizeBytes >= 1048576) {
                    sizeDisplay = (sizeBytes / 1048576).toFixed(1) + ' MB';
                } else {
                    sizeDisplay = (sizeBytes / 1024).toFixed(0) + ' KB';
                }
                
                // Format duration
                var durationDisplay = 'Unknown';
                if (v.duration) {
                    var mins = Math.floor(v.duration / 60);
                    var secs = v.duration % 60;
                    durationDisplay = mins + ':' + String(secs).padStart(2, '0');
                }
                
                // Format resolution
                var resolutionDisplay = v.resolution || 'Unknown';
                if (v.width && v.height) {
                    resolutionDisplay = v.width + ' x ' + v.height;
                    // Add quality badge
                    if (v.height >= 2160) resolutionDisplay += ' (4K)';
                    else if (v.height >= 1080) resolutionDisplay += ' (1080p)';
                    else if (v.height >= 720) resolutionDisplay += ' (720p)';
                    else if (v.height >= 480) resolutionDisplay += ' (480p)';
                    else resolutionDisplay += ' (SD)';
                }
                
                // Format bitrate
                var bitrateDisplay = 'Unknown';
                if (v.bitrate) {
                    if (v.bitrate >= 1000000) {
                        bitrateDisplay = (v.bitrate / 1000000).toFixed(1) + ' Mbps';
                    } else {
                        bitrateDisplay = Math.round(v.bitrate / 1000) + ' kbps';
                    }
                }
                
                document.getElementById('mvDetailsTitle').textContent = v.title || v.filename;
                document.getElementById('mvDetailsContent').innerHTML = 
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">📁 Filename:</span>' +
                        '<span class="mv-detail-value">' + (v.filename || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">🎤 Artist:</span>' +
                        '<span class="mv-detail-value">' + (v.artist || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">💿 Album:</span>' +
                        '<span class="mv-detail-value">' + (v.album || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">📅 Year:</span>' +
                        '<span class="mv-detail-value">' + (v.year || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">🎵 Genre:</span>' +
                        '<span class="mv-detail-value">' + (v.genre || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-divider"></div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">💾 File Size:</span>' +
                        '<span class="mv-detail-value">' + sizeDisplay + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">🎬 Resolution:</span>' +
                        '<span class="mv-detail-value">' + resolutionDisplay + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">⏱️ Duration:</span>' +
                        '<span class="mv-detail-value">' + durationDisplay + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">🎞️ Codec:</span>' +
                        '<span class="mv-detail-value">' + (v.codec || 'Unknown') + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">📊 Bitrate:</span>' +
                        '<span class="mv-detail-value">' + bitrateDisplay + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">📦 Format:</span>' +
                        '<span class="mv-detail-value">' + (v.format || 'Unknown').toUpperCase() + '</span>' +
                    '</div>' +
                    '<div class="mv-detail-divider"></div>' +
                    '<div class="mv-detail-row">' +
                        '<span class="mv-detail-label">📍 Path:</span>' +
                        '<span class="mv-detail-value mv-detail-path">' + (v.filepath || 'Unknown') + '</span>' +
                    '</div>';
                
                document.getElementById('mvDetailsModal').style.display = 'flex';
            } else {
                alert('Error loading details: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(function(err) {
            alert('Error: ' + err.message);
        });
}

function closeMvDetailsModal() {
    document.getElementById('mvDetailsModal').style.display = 'none';
}
</script>

<style>
/* Music Video Action Buttons (v3.8) */
.mv-item {
    position: relative;
    display: flex;
    flex-direction: column;
}

.mv-item .item-link {
    text-decoration: none;
    color: inherit;
    display: block;
    flex: 1;
}

.media-actions {
    display: flex;
    gap: 4px;
    padding: 6px 10px;
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.5), rgba(22, 163, 74, 0.5));
    border-radius: 0 0 12px 12px;
    justify-content: flex-start;
}

.action-btn {
    width: 26px;
    height: 26px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.25);
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 13px;
    transition: all 0.2s ease;
}

.action-btn:hover {
    background: rgba(255,255,255,0.35);
    transform: scale(1.1);
}

.action-btn.active {
    background: rgba(255,255,255,0.9);
    color: #16a34a;
}

.favorite-btn.active {
    color: #ef4444;
}

.watched-btn.active {
    color: #3b82f6;
}

/* Context Menu Styles (v6.99) */
.mv-context-menu {
    background: rgba(20, 30, 26, 0.98);
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 12px;
    padding: 8px 0;
    min-width: 160px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    z-index: 3000;
    animation: menuFadeIn 0.15s ease-out;
}

@keyframes menuFadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.mv-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.15s ease;
    color: #fff;
    font-size: 14px;
}

.mv-menu-item:hover {
    background: rgba(168, 85, 247, 0.2);
}

.mv-menu-icon {
    font-size: 16px;
}

/* Edit Modal Styles (v6.99) */
.mv-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(4px);
    z-index: 3001;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    overflow-y: auto;
}

.mv-modal {
    background: rgba(20, 30, 26, 0.98);
    border: 1px solid rgba(168, 85, 247, 0.3);
    border-radius: 16px;
    max-width: 550px;
    width: 100%;
    padding: 28px;
    position: relative;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
}

.mv-modal-close {
    position: absolute;
    top: 14px;
    right: 14px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}

.mv-modal-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.mv-modal h2 {
    color: #a855f7;
    margin: 0 0 20px 0;
    font-size: 22px;
    font-weight: 600;
}

.mv-form-group {
    margin-bottom: 14px;
}

.mv-form-label {
    display: block;
    color: #a855f7;
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.mv-form-input {
    width: 100%;
    padding: 10px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: #fff;
    font-size: 14px;
    transition: border-color 0.2s;
}

.mv-form-input:focus {
    outline: none;
    border-color: rgba(168, 85, 247, 0.5);
}

.mv-form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.mv-thumbnail-preview {
    margin-top: 10px;
    display: none;
}

.mv-thumbnail-preview img {
    max-width: 160px;
    border-radius: 8px;
    border: 2px solid rgba(168, 85, 247, 0.3);
}

.mv-thumbnail-dimensions {
    margin-top: 5px;
    font-size: 12px;
    color: rgba(255, 255, 255, 0.6);
}

.mv-form-actions {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

.mv-btn {
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.mv-btn-secondary {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
}

.mv-btn-secondary:hover {
    background: rgba(255, 255, 255, 0.15);
}

.mv-btn-primary {
    background: linear-gradient(135deg, #a855f7, #6366f1);
    border: none;
    color: #fff;
}

.mv-btn-primary:hover {
    background: linear-gradient(135deg, #9333ea, #4f46e5);
}

/* Details Modal Styles (v6.99) */
.mv-details-modal {
    max-width: 500px;
}

.mv-detail-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.mv-detail-row:last-child {
    border-bottom: none;
}

.mv-detail-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 13px;
}

.mv-detail-value {
    color: #fff;
    font-size: 13px;
    text-align: right;
    max-width: 280px;
    word-break: break-word;
}

.mv-detail-path {
    font-family: monospace;
    font-size: 11px;
    text-align: left;
    max-width: 100%;
}

.mv-detail-divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, rgba(168, 85, 247, 0.3), transparent);
    margin: 12px 0;
}

.mv-file-hint {
    margin-top: 5px;
    font-size: 11px;
    color: rgba(255, 255, 255, 0.5);
}
</style>

<!-- Edit Metadata Modal (v6.99) -->
<div id="mvEditModal" class="mv-modal-overlay" style="display: none;">
    <div class="mv-modal">
        <button onclick="closeMvEditModal()" class="mv-modal-close">×</button>
        <h2>✏️ Edit Music Video Metadata</h2>
        
        <input type="hidden" id="mv_edit_id">
        
        <div class="mv-form-group">
            <label class="mv-form-label">Title</label>
            <input type="text" id="mv_edit_title" class="mv-form-input" placeholder="Video title">
        </div>
        
        <div class="mv-form-group">
            <label class="mv-form-label">Artist</label>
            <input type="text" id="mv_edit_artist" class="mv-form-input" placeholder="Artist name">
        </div>
        
        <div class="mv-form-row">
            <div class="mv-form-group">
                <label class="mv-form-label">Album</label>
                <input type="text" id="mv_edit_album" class="mv-form-input" placeholder="Album name">
            </div>
            <div class="mv-form-group">
                <label class="mv-form-label">Year</label>
                <input type="number" id="mv_edit_year" class="mv-form-input" placeholder="2024">
            </div>
        </div>
        
        <div class="mv-form-group">
            <label class="mv-form-label">Genre</label>
            <input type="text" id="mv_edit_genre" class="mv-form-input" placeholder="Pop, Rock, Hip-Hop, etc.">
        </div>
        
        <div class="mv-form-group">
            <label class="mv-form-label">Thumbnail Image</label>
            <input type="file" id="mv_edit_thumbnail" accept="image/jpeg,image/jpg,image/png" class="mv-form-input" onchange="handleMvThumbnailUpload(event)">
            <div class="mv-file-hint">JPG/PNG • Will be resized to 320x180px</div>
            <div id="mvThumbnailPreview" class="mv-thumbnail-preview">
                <img id="mvThumbnailPreviewImg">
                <div id="mvThumbnailDimensions" class="mv-thumbnail-dimensions"></div>
            </div>
        </div>
        
        <div class="mv-form-actions">
            <button onclick="closeMvEditModal()" class="mv-btn mv-btn-secondary">Cancel</button>
            <button onclick="saveMusicVideoMetadata()" class="mv-btn mv-btn-primary">Save Changes</button>
        </div>
    </div>
</div>

<!-- Details Modal (v6.99) -->
<div id="mvDetailsModal" class="mv-modal-overlay" style="display: none;">
    <div class="mv-modal mv-details-modal">
        <button onclick="closeMvDetailsModal()" class="mv-modal-close">×</button>
        <h2 id="mvDetailsTitle">Video Details</h2>
        <div id="mvDetailsContent"></div>
        <div class="mv-form-actions">
            <button onclick="closeMvDetailsModal()" class="mv-btn mv-btn-primary">Close</button>
        </div>
    </div>
</div>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Music Videos"
}

function Get-MusicVideoPlayerPage {
    param(
        [object]$Video,
        [bool]$ShuffleMode = $false
    )
    
    # Format info
    $artistDisplay = if ($Video.artist) { $Video.artist } else { "Unknown Artist" }
    $titleDisplay = if ($Video.title) { $Video.title } else { "Unknown" }
    $yearDisplay = if ($Video.year) { " ($($Video.year))" } else { "" }
    $sizeDisplay = "$([math]::Round($Video.size_bytes / 1MB, 2)) MB"
    $formatDisplay = $Video.format.ToUpper()
    
    # v6.99: Variables for favorite button
    $mvVideoId = $Video.id
    $mvTitleJs = ($titleDisplay -replace "'", "\'") -replace '"', '\"'
    $mvThumbnailPath = if ($Video.thumbnail_path) { ($Video.thumbnail_path -replace "'", "\'") } else { '' }
    
    # Use same background images as music player (random from 8 backgrounds)
    $musicBackgroundOpacity = 0.3
    $randomBg = Get-Random -Minimum 1 -Maximum 8
    $backdropStyle = "background-image: linear-gradient(to bottom, rgba(10,20,16,$musicBackgroundOpacity), rgba(10,20,16,$musicBackgroundOpacity)), url('/menu/music-$randomBg.jpg');"
    
    # Shuffle mode indicator
    $shuffleIndicator = if ($ShuffleMode) {
        "<span class='shuffle-mode-indicator'>🔀 SHUFFLE MODE</span>"
    } else { "" }
    
    # Next shuffle button
    $nextButton = if ($ShuffleMode) {
        "<a href='/play-musicvideo/shuffle' class='action-btn primary' style='background: linear-gradient(135deg, #a855f7, #6366f1);'><span style='font-size: 18px;'>🔀</span><span>Next Random</span></a>"
    } else {
        "<a href='/play-musicvideo/shuffle' class='action-btn secondary'><span style='font-size: 18px;'>🔀</span><span>Shuffle Play</span></a>"
    }
    
    $playerContent = @"
<style>
.musicvideo-player-container {
    position: relative;
    min-height: 100vh;
    color: var(--text);
}

.musicvideo-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: -1;
    $backdropStyle
}

.musicvideo-content-wrapper {
    position: relative;
    z-index: 1;
    padding: 40px;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.musicvideo-back-link {
    position: absolute;
    top: 20px;
    left: 20px;
    color: var(--text);
    text-decoration: none;
    font-size: 16px;
    opacity: 0.9;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(0,0,0,0.5);
    padding: 8px 16px;
    border-radius: 8px;
    backdrop-filter: blur(10px);
}

.musicvideo-back-link:hover {
    opacity: 1;
    background: rgba(0,0,0,0.7);
}

.musicvideo-video-container {
    width: 100%;
    max-width: 1000px;
    margin: 60px auto 30px;
    background: #000;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    position: relative;
}

/* v6.99: Favorite button on music video player */
.mv-player-favorite-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 100;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 22px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
}

.mv-player-favorite-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
}

.mv-player-favorite-btn.is-favorite {
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.5);
}

.mv-player-favorite-btn.is-favorite:hover {
    border-color: #ef4444;
}

.musicvideo-video-container video {
    width: 100%;
    display: block;
}

.musicvideo-info {
    text-align: center;
    max-width: 700px;
    margin: 0 auto;
    background: rgba(0,0,0,0.75);
    padding: 24px 40px 32px;
    border-radius: 16px;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 10px 40px rgba(0,0,0,0.4);
}

.musicvideo-title {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #ffffff;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.musicvideo-artist {
    font-size: 20px;
    color: #c084fc;
    margin-bottom: 16px;
    font-weight: 600;
    text-shadow: 0 2px 4px rgba(0,0,0,0.5);
}

.musicvideo-meta {
    display: flex;
    justify-content: center;
    gap: 24px;
    margin-bottom: 24px;
    font-size: 14px;
}

.musicvideo-meta span {
    background: rgba(168,85,247,0.2);
    color: #e9d5ff;
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid rgba(168,85,247,0.3);
}

.musicvideo-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    flex-wrap: wrap;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.2s;
}

.action-btn.primary {
    background: var(--accent);
    color: #000;
}

.action-btn.primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(52,211,153,0.3);
}

.action-btn.secondary {
    background: rgba(255,255,255,0.15);
    color: #ffffff;
    border: 1px solid rgba(255,255,255,0.3);
}

.action-btn.secondary:hover {
    background: rgba(255,255,255,0.25);
    transform: translateY(-2px);
}

.shuffle-mode-indicator {
    display: inline-block;
    margin-bottom: 16px;
    background: linear-gradient(135deg, rgba(168,85,247,0.4), rgba(99,102,241,0.4));
    color: #e9d5ff;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    border: 1px solid rgba(168,85,247,0.6);
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}
</style>

<div class="musicvideo-player-container">
    <div class="musicvideo-backdrop"></div>
    <div class="musicvideo-content-wrapper">
        <a href="/musicvideos" class="musicvideo-back-link">← Back to Music Videos</a>
        
        <div class="musicvideo-video-container">
            <video id="mvPlayer" controls autoplay playsinline preload="auto">
                Your browser does not support video playback.
            </video>
            <!-- v6.99: Favorite button overlay -->
            <button id="mvFavoriteBtn" class="mv-player-favorite-btn" onclick="toggleMvFavorite()" title="Add to Favorites">
                <span id="mvFavIcon">♡</span>
            </button>
        </div>
        
        <div class="musicvideo-info">
            $shuffleIndicator
            <div class="musicvideo-title">$titleDisplay$yearDisplay</div>
            <div class="musicvideo-artist">$artistDisplay</div>
            <div class="musicvideo-meta">
                <span>📦 $sizeDisplay</span>
                <span>🎬 $formatDisplay</span>
            </div>
            <div class="musicvideo-actions">
                $nextButton
                <a href="/musicvideos" class="action-btn secondary">
                    <span style="font-size: 18px;">📋</span>
                    <span>Browse All</span>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- v7.53: Standard HTML5 video player - direct streaming without HLS -->
<script>
var video = document.getElementById('mvPlayer');
var mvVideoId = $($Video.id);

// v7.53: Direct streaming - simple and reliable
video.src = '/stream-musicvideo/' + mvVideoId;

// Handle autoplay
video.play().catch(function(e) {
    console.log('Autoplay blocked, user interaction required:', e);
});

// Auto-advance in shuffle mode
video.addEventListener('ended', function() {
    if ($($ShuffleMode.ToString().ToLower())) {
        setTimeout(function() {
            window.location.href = '/play-musicvideo/shuffle';
        }, 1500);
    }
});

// v6.99: Music Video Favorite functionality
var mvFavoriteData = {
    mediaType: 'musicvideo',
    mediaId: $mvVideoId,
    title: '$mvTitleJs',
    posterUrl: '$mvThumbnailPath'
};

// Check if already favorited on load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/favorite/check?mediaType=' + mvFavoriteData.mediaType + '&mediaId=' + mvFavoriteData.mediaId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.isFavorite) {
                var btn = document.getElementById('mvFavoriteBtn');
                var icon = document.getElementById('mvFavIcon');
                if (btn) btn.classList.add('is-favorite');
                if (icon) icon.textContent = '♥';
            }
        })
        .catch(function(err) { console.log('Favorite check error:', err); });
});

function toggleMvFavorite() {
    var btn = document.getElementById('mvFavoriteBtn');
    var icon = document.getElementById('mvFavIcon');
    
    fetch('/api/favorite/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(mvFavoriteData)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            if (data.isFavorite) {
                btn.classList.add('is-favorite');
                icon.textContent = '♥';
            } else {
                btn.classList.remove('is-favorite');
                icon.textContent = '♡';
            }
        }
    })
    .catch(function(err) { console.error('Favorite toggle error:', err); });
}
</script>
"@
    
    return Get-HTMLPage -Content $playerContent -Title "Music Video - $titleDisplay"
}

function Get-AnalysisPage {
    # Get current logged in user - MUST access .Username property from the session object
    $currentUsername = "guest"
    if ($Global:CurrentUser -and $Global:CurrentUser.Username) {
        $currentUsername = $Global:CurrentUser.Username
    }
    $userDbPath = Join-Path $CONFIG.UsersDBPath "$currentUsername.db"
    
    # Initialize user stats with defaults
    $videoStats = @{ total_watched = 0; completed_count = 0; total_plays = 0; avg_completion = 0 }
    $musicStats = @{ unique_tracks = 0; total_plays = 0; total_time = 0 }
    $radioStats = @{ unique_stations = 0; total_listens = 0; total_time = 0 }
    $topMusic = @()
    
    # Get user stats if database exists
    if (Test-Path $userDbPath) {
        try {
            $videoStatsResult = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as total_watched,
    SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed_count,
    SUM(watch_count) as total_plays,
    AVG(percent_watched) as avg_completion
FROM video_progress
"@
            if ($videoStatsResult) { $videoStats = $videoStatsResult }
            
            $musicStatsResult = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as unique_tracks,
    SUM(play_count) as total_plays,
    SUM(total_play_time_seconds) as total_time
FROM music_history
"@
            if ($musicStatsResult) { $musicStats = $musicStatsResult }
            
            $radioStatsResult = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as unique_stations,
    SUM(listen_count) as total_listens,
    SUM(total_listen_time_seconds) as total_time
FROM radio_history
"@
            if ($radioStatsResult) { $radioStats = $radioStatsResult }
            
            $topMusic = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT artist, title, play_count
FROM music_history
ORDER BY play_count DESC
LIMIT 5
"@
        } catch {
            Write-Host "  [!] Error reading user stats: $_" -ForegroundColor Yellow
        }
    }
    
    # Safely get values with null handling
    $videoWatched = if ($videoStats.total_watched) { $videoStats.total_watched } else { 0 }
    $videoCompleted = if ($videoStats.completed_count) { $videoStats.completed_count } else { 0 }
    $videoPlays = if ($videoStats.total_plays) { $videoStats.total_plays } else { 0 }
    $videoAvgCompletion = if ($videoStats.avg_completion) { [math]::Round($videoStats.avg_completion, 1) } else { 0 }
    
    $musicTracks = if ($musicStats.unique_tracks) { $musicStats.unique_tracks } else { 0 }
    $musicPlays = if ($musicStats.total_plays) { $musicStats.total_plays } else { 0 }
    $musicTime = if ($musicStats.total_time) { $musicStats.total_time } else { 0 }
    $musicHours = [math]::Round(($musicTime / 3600), 1)
    
    $radioStations = if ($radioStats.unique_stations) { $radioStats.unique_stations } else { 0 }
    $radioListens = if ($radioStats.total_listens) { $radioStats.total_listens } else { 0 }
    $radioTime = if ($radioStats.total_time) { $radioStats.total_time } else { 0 }
    $radioHours = [math]::Round(($radioTime / 3600), 1)
    
    # ========== LIBRARY STATISTICS ==========
    
    # Video Stats
    $totalVideos = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos").count
    $totalVideoSize = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM videos").total
    $videoSizeGB = [math]::Round($totalVideoSize / 1GB, 2)
    
    # Low quality video breakdown
    $lowQualityCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE is_low_quality = 1").count
    $hdCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE height >= 720 AND height < 1080").count
    $fullHDCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE height >= 1080 AND height < 2160").count
    $fourKCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE height >= 2160").count
    $unknownResCount = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos WHERE height IS NULL OR height = 0").count
    
    # Video formats breakdown
    $videoFormats = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query @"
SELECT UPPER(format) as format, COUNT(*) as count 
FROM videos 
WHERE format IS NOT NULL AND format != ''
GROUP BY UPPER(format) 
ORDER BY count DESC 
LIMIT 5
"@
    
    # Music Stats
    $totalMusic = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music").count
    $totalMusicSize = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM music").total
    $musicSizeGB = [math]::Round($totalMusicSize / 1GB, 2)
    $uniqueArtists = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(DISTINCT artist) as count FROM music WHERE artist IS NOT NULL AND artist != ''").count
    $uniqueAlbums = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(DISTINCT album) as count FROM music WHERE album IS NOT NULL AND album != ''").count
    
    # Music formats breakdown
    $musicFormats = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query @"
SELECT UPPER(format) as format, COUNT(*) as count 
FROM music 
WHERE format IS NOT NULL AND format != ''
GROUP BY UPPER(format) 
ORDER BY count DESC 
LIMIT 5
"@
    
    # Pictures Stats
    $totalPictures = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT COUNT(*) as count FROM images").count
    $totalPicturesSize = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM images").total
    $picturesSizeGB = [math]::Round($totalPicturesSize / 1GB, 2)
    
    # eBook Stats - count by file extension since there's no format column
    $totalPDFs = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs WHERE LOWER(filepath) LIKE '%.pdf'").count
    $totalEPUBs = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs WHERE LOWER(filepath) LIKE '%.epub'").count
    $totalDocsSize = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM pdfs").total
    $docsSizeGB = [math]::Round($totalDocsSize / 1GB, 2)
    
    # Total library stats
    $totalItems = $totalVideos + $totalMusic + $totalPictures + $totalPDFs + $totalEPUBs
    $totalSizeGB = $videoSizeGB + $musicSizeGB + $picturesSizeGB + $docsSizeGB
    
    # Build top music HTML
    $topMusicHtml = ""
    $rank = 1
    foreach ($track in $topMusic) {
        if ($track) {
            $artistTitle = if ($track.artist -and $track.title) {
                "$($track.artist) - $($track.title)"
            } elseif ($track.title) {
                $track.title
            } else {
                "(Unknown)"
            }
            $topMusicHtml += "<div class='top-item'><span class='rank'>$rank</span><span class='track-name'>$artistTitle</span><span class='plays'>$($track.play_count) plays</span></div>"
            $rank++
        }
    }
    if (-not $topMusicHtml) {
        $topMusicHtml = "<div class='no-data'>No music history yet</div>"
    }
    
    # Build video formats HTML
    $videoFormatsHtml = ""
    foreach ($fmt in $videoFormats) {
        if ($fmt -and $fmt.format) {
            $videoFormatsHtml += "<span class='format-tag'>$($fmt.format) ($($fmt.count))</span>"
        }
    }
    if (-not $videoFormatsHtml) { $videoFormatsHtml = "<span class='format-tag'>N/A</span>" }
    
    # Build music formats HTML
    $musicFormatsHtml = ""
    foreach ($fmt in $musicFormats) {
        if ($fmt -and $fmt.format) {
            $musicFormatsHtml += "<span class='format-tag'>$($fmt.format) ($($fmt.count))</span>"
        }
    }
    if (-not $musicFormatsHtml) { $musicFormatsHtml = "<span class='format-tag'>N/A</span>" }
    
    $content = @"
<style>
.analysis-container { padding: 24px; max-width: 1400px; margin: 0 auto; }
.analysis-header { 
    display: flex; 
    align-items: center; 
    gap: 16px; 
    margin-bottom: 32px;
    padding-bottom: 20px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}
.analysis-header h1 { 
    font-size: 28px; 
    margin: 0; 
    display: flex; 
    align-items: center; 
    gap: 12px;
}
.user-badge {
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
}

.stats-section { margin-bottom: 32px; }
.section-title {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 10px;
    color: rgba(255,255,255,0.9);
}
.section-title img { width: 24px; height: 24px; }

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.stat-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
}
.stat-card:hover {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.15);
    transform: translateY(-2px);
}
.stat-card.highlight {
    background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));
    border-color: rgba(99,102,241,0.3);
}
.stat-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
}
.stat-card-header img { width: 40px; height: 40px; opacity: 0.9; }
.stat-card-header h3 { 
    font-size: 16px; 
    margin: 0; 
    color: rgba(255,255,255,0.7);
    font-weight: 500;
}
.stat-value {
    font-size: 36px;
    font-weight: 700;
    color: #fff;
    margin-bottom: 4px;
    line-height: 1;
}
.stat-value.accent { color: #6366f1; }
.stat-value.green { color: #22c55e; }
.stat-value.yellow { color: #eab308; }
.stat-value.red { color: #ef4444; }
.stat-label {
    font-size: 13px;
    color: rgba(255,255,255,0.5);
    margin-bottom: 16px;
}
.stat-details {
    font-size: 13px;
    color: rgba(255,255,255,0.6);
    line-height: 1.8;
}
.stat-details div { display: flex; justify-content: space-between; }
.stat-details .value { color: rgba(255,255,255,0.9); font-weight: 500; }

.quality-breakdown {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 12px;
}
.quality-item {
    background: rgba(255,255,255,0.03);
    padding: 12px;
    border-radius: 8px;
    text-align: center;
}
.quality-item .q-value {
    font-size: 20px;
    font-weight: 700;
    color: #fff;
}
.quality-item .q-label {
    font-size: 11px;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    margin-top: 4px;
}
.quality-item.low .q-value { color: #ef4444; }
.quality-item.hd .q-value { color: #eab308; }
.quality-item.fhd .q-value { color: #22c55e; }
.quality-item.uhd .q-value { color: #6366f1; }

.format-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.format-tag {
    background: rgba(255,255,255,0.08);
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    color: rgba(255,255,255,0.7);
}

.top-tracks-card {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 24px;
}
.top-item {
    display: flex;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.top-item:last-child { border-bottom: none; }
.top-item .rank {
    width: 28px;
    height: 28px;
    background: rgba(99,102,241,0.2);
    color: #6366f1;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 12px;
    margin-right: 12px;
}
.top-item .track-name { flex: 1; font-size: 14px; }
.top-item .plays { color: rgba(255,255,255,0.5); font-size: 13px; }
.no-data { color: rgba(255,255,255,0.4); font-style: italic; padding: 20px; text-align: center; }

.library-summary {
    background: linear-gradient(135deg, rgba(99,102,241,0.1), rgba(139,92,246,0.05));
    border: 1px solid rgba(99,102,241,0.2);
    border-radius: 20px;
    padding: 32px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 24px;
    text-align: center;
    margin-bottom: 32px;
}
.summary-item .sum-value {
    font-size: 32px;
    font-weight: 700;
    color: #fff;
}
.summary-item .sum-label {
    font-size: 12px;
    color: rgba(255,255,255,0.5);
    text-transform: uppercase;
    margin-top: 4px;
}

@media (max-width: 768px) {
    .stats-grid { grid-template-columns: 1fr; }
    .quality-breakdown { grid-template-columns: 1fr 1fr; }
    .library-summary { grid-template-columns: repeat(2, 1fr); }
}
</style>

<div class="analysis-container">
    <div class="analysis-header">
        <h1>
            <img src="/menu/analysis.png" style="width:36px; height:36px;">
            Statistics & Analysis
        </h1>
        <span class="user-badge">👤 $currentUsername</span>
    </div>

    <!-- Library Summary -->
    <div class="library-summary">
        <div class="summary-item">
            <div class="sum-value">$totalItems</div>
            <div class="sum-label">Total Items</div>
        </div>
        <div class="summary-item">
            <div class="sum-value">$([math]::Round($totalSizeGB, 1)) GB</div>
            <div class="sum-label">Total Size</div>
        </div>
        <div class="summary-item">
            <div class="sum-value">$totalVideos</div>
            <div class="sum-label">Videos</div>
        </div>
        <div class="summary-item">
            <div class="sum-value">$totalMusic</div>
            <div class="sum-label">Music</div>
        </div>
        <div class="summary-item">
            <div class="sum-value">$totalPictures</div>
            <div class="sum-label">Pictures</div>
        </div>
        <div class="summary-item">
            <div class="sum-value">$($totalPDFs + $totalEPUBs)</div>
            <div class="sum-label">Documents</div>
        </div>
    </div>

    <!-- User Activity Section -->
    <div class="stats-section">
        <div class="section-title">👤 Your Activity</div>
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-card-header">
                    <img src="/menu/movie.png">
                    <h3>Videos Watched</h3>
                </div>
                <div class="stat-value accent">$videoWatched</div>
                <div class="stat-label">unique videos</div>
                <div class="stat-details">
                    <div><span>Completed</span><span class="value">$videoCompleted</span></div>
                    <div><span>Total Plays</span><span class="value">$videoPlays</span></div>
                    <div><span>Avg. Completion</span><span class="value">$videoAvgCompletion%</span></div>
                </div>
            </div>
            
            <div class="stat-card highlight">
                <div class="stat-card-header">
                    <img src="/menu/music.png">
                    <h3>Music Listened</h3>
                </div>
                <div class="stat-value accent">$musicTracks</div>
                <div class="stat-label">unique tracks</div>
                <div class="stat-details">
                    <div><span>Total Plays</span><span class="value">$musicPlays</span></div>
                    <div><span>Time Listened</span><span class="value">$musicHours hrs</span></div>
                </div>
            </div>
            
            <div class="stat-card highlight">
                <div class="stat-card-header">
                    <img src="/menu/radio.png">
                    <h3>Radio Stations</h3>
                </div>
                <div class="stat-value accent">$radioStations</div>
                <div class="stat-label">stations tuned</div>
                <div class="stat-details">
                    <div><span>Total Listens</span><span class="value">$radioListens</span></div>
                    <div><span>Time Listened</span><span class="value">$radioHours hrs</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Top Music -->
    <div class="stats-section">
        <div class="section-title">🎵 Your Top 5 Tracks</div>
        <div class="top-tracks-card">
            $topMusicHtml
        </div>
    </div>

    <!-- Library Statistics Section -->
    <div class="stats-section">
        <div class="section-title">📚 Library Statistics</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <img src="/menu/movie.png">
                    <h3>Video Library</h3>
                </div>
                <div class="stat-value">$totalVideos</div>
                <div class="stat-label">$videoSizeGB GB total</div>
                <div class="quality-breakdown">
                    <div class="quality-item low">
                        <div class="q-value">$lowQualityCount</div>
                        <div class="q-label">&lt; 720p</div>
                    </div>
                    <div class="quality-item hd">
                        <div class="q-value">$hdCount</div>
                        <div class="q-label">720p HD</div>
                    </div>
                    <div class="quality-item fhd">
                        <div class="q-value">$fullHDCount</div>
                        <div class="q-label">1080p FHD</div>
                    </div>
                    <div class="quality-item uhd">
                        <div class="q-value">$fourKCount</div>
                        <div class="q-label">4K UHD</div>
                    </div>
                </div>
                <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,0.4);">Unknown resolution: $unknownResCount</div>
                <div class="format-tags">$videoFormatsHtml</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <img src="/menu/music.png">
                    <h3>Music Library</h3>
                </div>
                <div class="stat-value">$totalMusic</div>
                <div class="stat-label">$musicSizeGB GB total</div>
                <div class="stat-details">
                    <div><span>Artists</span><span class="value">$uniqueArtists</span></div>
                    <div><span>Albums</span><span class="value">$uniqueAlbums</span></div>
                </div>
                <div class="format-tags">$musicFormatsHtml</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <img src="/menu/pictures.png">
                    <h3>Pictures Library</h3>
                </div>
                <div class="stat-value">$totalPictures</div>
                <div class="stat-label">$picturesSizeGB GB total</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <img src="/menu/pdf.png">
                    <h3>Documents Library</h3>
                </div>
                <div class="stat-value">$($totalPDFs + $totalEPUBs)</div>
                <div class="stat-label">$docsSizeGB GB total</div>
                <div class="stat-details">
                    <div><span>PDF Files</span><span class="value">$totalPDFs</span></div>
                    <div><span>EPUB Books</span><span class="value">$totalEPUBs</span></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quality Analysis Section -->
    <div class="stats-section">
        <div class="section-title">📈 Quality Analysis</div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>⚠️ Low Quality Videos</h3>
                </div>
                <div class="stat-value $(if ($lowQualityCount -gt 0) { 'yellow' } else { 'green' })">$lowQualityCount</div>
                <div class="stat-label">videos below 720p resolution</div>
                <div class="stat-details">
                    $(if ($lowQualityCount -gt 0) {
                        "<div style='color:rgba(234,179,8,0.8);'>💡 Consider upgrading to higher quality versions</div>"
                    } else {
                        "<div style='color:rgba(34,197,94,0.8);'>✓ All videos are HD quality or better!</div>"
                    })
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-card-header">
                    <h3>🎬 HD Content Ratio</h3>
                </div>
                <div class="stat-value green">$([math]::Round((($hdCount + $fullHDCount + $fourKCount) / [math]::Max(($totalVideos - $unknownResCount), 1)) * 100, 1))%</div>
                <div class="stat-label">of videos with known resolution are 720p or better</div>
                <div class="stat-details">
                    <div><span>4K UHD</span><span class="value" style="color:#6366f1;">$fourKCount videos</span></div>
                    <div><span>1080p Full HD</span><span class="value" style="color:#22c55e;">$fullHDCount videos</span></div>
                    <div><span>720p HD</span><span class="value" style="color:#eab308;">$hdCount videos</span></div>
                </div>
            </div>
        </div>
    </div>
</div>
"@
    
    return Get-HTMLPage -Content $content -Title "NexusM - Statistics & Analysis"
}

function Get-SearchPage {
    param(
        [string]$Query,
        [string]$Type = ""
    )
    
    if ([string]::IsNullOrWhiteSpace($Query)) {
        return Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>No search query provided</h1><p><a href='/'>← Back to Home</a></p></div>" -Title "Search"
    }
    
    $escapedQuery = [System.Web.HttpUtility]::HtmlEncode($Query)
    $resultItems = ""
    $totalResults = 0
    
    # Search based on type or search all if no type specified
    $searchTypes = if ($Type) { @($Type) } else { @('videos', 'music', 'pictures', 'pdfs', 'radio', 'tv', 'musicvideos') }
    
    foreach ($searchType in $searchTypes) {
        switch ($searchType) {
            'videos' {
                # ENHANCED: Search in ALL video metadata fields including cast, director, genre, overview
                # Note: "cast" is a reserved SQL keyword, so we use [cast] or "cast" to escape it
                $results = Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB `
                    -Query "SELECT * FROM videos WHERE title LIKE @query OR filename LIKE @query OR genre LIKE @query OR director LIKE @query OR [cast] LIKE @query OR overview LIKE @query ORDER BY CASE WHEN title LIKE @query THEN 1 WHEN [cast] LIKE @query THEN 2 WHEN director LIKE @query THEN 3 WHEN genre LIKE @query THEN 4 ELSE 5 END, title" `
                    -SqlParameters @{ query = "%$Query%" }
                
                foreach ($video in $results) {
                    $totalResults++
                    $size = [math]::Round($video.size_bytes / 1GB, 2)
                    $encodedPath = [System.Web.HttpUtility]::UrlEncode($video.filepath)
                    
                    $posterStyle = ""
                    if ($video.poster_url -and -not [string]::IsNullOrWhiteSpace($video.poster_url)) {
                        $posterStyle = "background-image: url('/poster/$($video.poster_url)');"
                    }
                    
                    # Build match context (show what matched)
                    $matchContext = @()
                    if ($video.cast -and $video.cast -like "*$Query*") { $matchContext += "Cast: $($video.cast.Substring(0, [Math]::Min(50, $video.cast.Length)))..." }
                    if ($video.director -and $video.director -like "*$Query*") { $matchContext += "Director: $($video.director)" }
                    if ($video.genre -and $video.genre -like "*$Query*") { $matchContext += "Genre: $($video.genre)" }
                    $matchInfo = if ($matchContext.Count -gt 0) { "<span style='font-size:10px; opacity:0.6; display:block; margin-top:2px;'>$($matchContext[0])</span>" } else { "" }
                    
                    $yearInfo = if ($video.year) { " ($($video.year))" } else { "" }
                    
                    $resultItems += @"
<a class="item" href="/player/$($video.id)">
  <div class="thumb" style="$posterStyle"></div>
  <div class="flag video">Video</div>
  <div class="corner">▶</div>
  <div class="meta">
    <strong>$($video.title)$yearInfo</strong>
    <span>$($video.format) • ${size}GB</span>
    $matchInfo
  </div>
</a>
"@
                }
            }
            'music' {
                # ENHANCED: Search in ALL music metadata fields including genre
                $results = Invoke-SqliteQuery -DataSource $CONFIG.MusicDB `
                    -Query "SELECT * FROM music WHERE title LIKE @query OR artist LIKE @query OR album LIKE @query OR genre LIKE @query OR filename LIKE @query ORDER BY CASE WHEN title LIKE @query THEN 1 WHEN artist LIKE @query THEN 2 WHEN album LIKE @query THEN 3 WHEN genre LIKE @query THEN 4 ELSE 5 END, title" `
                    -SqlParameters @{ query = "%$Query%" }
                
                foreach ($music in $results) {
                    $totalResults++
                    $size = [math]::Round($music.size_bytes / 1MB, 1)
                    $artist = if ($music.artist) { $music.artist } else { "Unknown Artist" }
                    $album = if ($music.album) { $music.album } else { "Unknown Album" }
                    
                    $artStyle = ""
                    if ($music.album_art_cached -and -not [string]::IsNullOrWhiteSpace($music.album_art_cached)) {
                        $artStyle = "background-image: url('/albumart/$($music.album_art_cached)');"
                    }
                    elseif ($music.album_art_url -and -not [string]::IsNullOrWhiteSpace($music.album_art_url)) {
                        $artStyle = "background-image: url('/poster/$($music.album_art_url)');"
                    }
                    
                    # Show genre if it matched
                    $genreInfo = if ($music.genre -and $music.genre -like "*$Query*") { "<span style='font-size:10px; opacity:0.6;'>Genre: $($music.genre)</span>" } else { "" }
                    
                    $resultItems += @"
<a class="item" href="/play-audio/$($music.id)">
  <div class="thumb" style="$artStyle"></div>
  <div class="flag audio">Audio</div>
  <div class="corner">♫</div>
  <div class="meta">
    <strong>$($music.title)</strong>
    <span>$artist</span>
    <span style="font-size:11px; opacity:0.7;">$album</span>
    $genreInfo
  </div>
</a>
"@
                }
            }
            'pictures' {
                # ENHANCED: Search in pictures including camera info and filepath
                $results = Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB `
                    -Query "SELECT * FROM images WHERE filename LIKE @query OR filepath LIKE @query OR camera_make LIKE @query OR camera_model LIKE @query ORDER BY filename" `
                    -SqlParameters @{ query = "%$Query%" }
                
                foreach ($picture in $results) {
                    $totalResults++
                    $size = [math]::Round($picture.size_bytes / 1MB, 1)
                    $encodedPath = [System.Web.HttpUtility]::UrlEncode($picture.filepath)
                    $thumbStyle = "background-image: url('/image/$($encodedPath)');"
                    
                    $resultItems += @"
<a class="item" href="/view-image?path=$encodedPath" target="_blank">
  <div class="thumb" style="$thumbStyle background-size: cover; background-position: center;"></div>
  <div class="flag picture">Picture</div>
  <div class="corner">🖼</div>
  <div class="meta">
    <strong>$($picture.filename)</strong>
    <span>$($picture.format) • ${size}MB</span>
  </div>
</a>
"@
                }
            }
            'pdfs' {
                # ENHANCED: Search in ALL PDF metadata fields including author, subject, keywords
                $results = Invoke-SqliteQuery -DataSource $CONFIG.PDFDB `
                    -Query "SELECT * FROM pdfs WHERE title LIKE @query OR filename LIKE @query OR author LIKE @query OR subject LIKE @query OR keywords LIKE @query ORDER BY CASE WHEN title LIKE @query THEN 1 WHEN author LIKE @query THEN 2 ELSE 3 END, title" `
                    -SqlParameters @{ query = "%$Query%" }
                
                foreach ($pdf in $results) {
                    $totalResults++
                    $sizeMB = [math]::Round($pdf.size_bytes / 1MB, 1)
                    $encodedPath = [System.Web.HttpUtility]::UrlEncode($pdf.filepath)
                    
                    # Detect file type
                    $fileExtension = [System.IO.Path]::GetExtension($pdf.filepath).ToLower()
                    $isEpub = ($pdf.PSObject.Properties.Name -contains 'file_type' -and $pdf.file_type -eq 'epub') -or $fileExtension -eq '.epub'
                    
                    # Set badge text and styling
                    $badgeText = if ($isEpub) { "EPUB" } else { "PDF" }
                    $badgeClass = if ($isEpub) { "epub" } else { "pdf" }
                    $fileTypeLabel = if ($isEpub) { "EPUB" } else { "PDF" }
                    
                    $thumbStyle = ""
                    if ($pdf.preview_image -and -not [string]::IsNullOrWhiteSpace($pdf.preview_image)) {
                        $thumbStyle = "background-image: url('/ebookcover/$($pdf.preview_image)'); background-size: cover; background-position: center;"
                    }
                    else {
                        if ($isEpub) {
                            $thumbStyle = "background: linear-gradient(135deg, rgba(99,102,241,0.15), rgba(168,85,247,0.15)); display:flex; align-items:center; justify-content:center; font-size:48px;"
                        }
                        else {
                            $thumbStyle = "background: linear-gradient(135deg, rgba(220,38,38,0.15), rgba(251,191,36,0.15)); display:flex; align-items:center; justify-content:center; font-size:48px;"
                        }
                    }
                    
                    $iconHtml = if (-not $pdf.preview_image -or [string]::IsNullOrWhiteSpace($pdf.preview_image)) { "<img src='/menu/pdf.png' style='width:48px; height:48px;'>" } else { "" }
                    
                    # Different click action for EPUB vs PDF
                    $clickAction = if ($isEpub) {
                        "href='/read-epub?path=$encodedPath'"
                    } else {
                        "href='/view-pdf?path=$encodedPath' target='_blank'"
                    }
                    
                    # Show author if matched
                    $authorInfo = if ($pdf.author -and $pdf.author -like "*$Query*") { "<span style='font-size:10px; opacity:0.6;'>by $($pdf.author)</span>" } else { "" }
                    
                    $resultItems += @"
<a class="item" $clickAction>
  <div class="thumb" style="$thumbStyle">$iconHtml</div>
  <div class="flag $badgeClass">$badgeText</div>
  <div class="corner">📖</div>
  <div class="meta">
    <strong>$($pdf.title)</strong>
    <span>$fileTypeLabel • ${sizeMB}MB</span>
    $authorInfo
  </div>
</a>
"@
                }
            }
            'radio' {
                # Search in radio stations: name, country, genre, description
                $results = $CONFIG.RadioStations | Where-Object {
                    $_.Name -like "*$Query*" -or 
                    $_.Country -like "*$Query*" -or 
                    $_.Genre -like "*$Query*" -or 
                    $_.Description -like "*$Query*"
                }
                
                foreach ($station in $results) {
                    $totalResults++
                    
                    # Generate a gradient background based on genre
                    $gradientStyle = switch -Regex ($station.Genre) {
                        "News|Talk" { "background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.1));" }
                        "Jazz" { "background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(147,51,234,0.1));" }
                        "Classical" { "background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(37,99,235,0.1));" }
                        "Rock|Alternative" { "background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(251,146,60,0.1));" }
                        "Pop|Dance" { "background: linear-gradient(135deg, rgba(236,72,153,0.2), rgba(219,39,119,0.1));" }
                        "Electronic|Ambient" { "background: linear-gradient(135deg, rgba(34,211,238,0.2), rgba(6,182,212,0.1));" }
                        default { "background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(16,185,129,0.1));" }
                    }
                    
                    # Emoji based on genre
                    $emoji = switch -Regex ($station.Genre) {
                        "News|Talk" { "📻" }
                        "Jazz" { "🎷" }
                        "Classical" { "🎻" }
                        "Rock" { "🎸" }
                        "Pop" { "🎤" }
                        "Electronic" { "🎛️" }
                        default { "📡" }
                    }
                    
                    $encodedURL = [System.Web.HttpUtility]::UrlEncode($station.URL)
                    
                    # Use logo if available, otherwise use emoji with gradient
                    $thumbStyle = ""
                    $thumbContent = ""
                    
                    if ($station.Logo -and -not [string]::IsNullOrWhiteSpace($station.Logo)) {
                        # Has logo - use as background image
                        if ($station.Logo -like "http*") {
                            $logoURL = $station.Logo
                        } else {
                            $logoURL = "/$($station.Logo)"
                        }
                        $thumbStyle = "$gradientStyle background-image: url('$logoURL'); background-size: 60%; background-repeat: no-repeat; background-position: center;"
                        $thumbContent = ""  # Empty when using background image
                    } else {
                        # No logo - use emoji with gradient
                        $thumbStyle = "$gradientStyle display:flex; align-items:center; justify-content:center; font-size:48px;"
                        $thumbContent = $emoji
                    }
                    
                    $resultItems += @"
<div class="item" onclick="playRadio('$encodedURL', '$($station.Name)', '$($station.Description)')">
  <div class="thumb" style="$thumbStyle">$thumbContent</div>
  <div class="flag radio" style="background: rgba(52,211,153,0.9);">LIVE</div>
  <div class="corner">$($station.Country)</div>
  <div class="meta">
    <strong>$($station.Name)</strong>
    <span>$($station.Genre)</span>
    <span style="font-size:11px; opacity:0.7;">$($station.Description)</span>
  </div>
</div>
"@
                }
            }
            'tv' {
                # Search in TV channels: name, country, genre, description
                $results = $CONFIG.TVChannels | Where-Object {
                    $_.Name -like "*$Query*" -or 
                    $_.Country -like "*$Query*" -or 
                    $_.Genre -like "*$Query*" -or 
                    $_.Description -like "*$Query*"
                }
                
                foreach ($channel in $results) {
                    $totalResults++
                    
                    # Generate a gradient background based on genre
                    $gradientStyle = switch -Regex ($channel.Genre) {
                        "News" { "background: linear-gradient(135deg, rgba(239,68,68,0.2), rgba(220,38,38,0.1));" }
                        "Business" { "background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(16,185,129,0.1));" }
                        "Sports" { "background: linear-gradient(135deg, rgba(251,146,60,0.2), rgba(234,88,12,0.1));" }
                        default { "background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(59,130,246,0.1));" }
                    }
                    
                    $emoji = switch -Regex ($channel.Genre) {
                        "News" { "📺" }
                        "Business" { "💼" }
                        "Sports" { "⚽" }
                        default { "📡" }
                    }
                    
                    $encodedURL = [System.Web.HttpUtility]::UrlEncode($channel.URL)
                    
                    $thumbStyle = ""
                    $thumbContent = ""
                    
                    if ($channel.Logo -and -not [string]::IsNullOrWhiteSpace($channel.Logo)) {
                        if ($channel.Logo -like "http*") {
                            $logoURL = $channel.Logo
                        } else {
                            $logoURL = "/$($channel.Logo)"
                        }
                        $thumbStyle = "$gradientStyle background-image: url('$logoURL'); background-size: 60%; background-repeat: no-repeat; background-position: center;"
                        $thumbContent = ""
                    } else {
                        $thumbStyle = "$gradientStyle display:flex; align-items:center; justify-content:center; font-size:48px;"
                        $thumbContent = $emoji
                    }
                    
                    $resultItems += @"
<div class="item" onclick="playTV('$encodedURL', '$($channel.Name)', '$($channel.Description)')">
  <div class="thumb" style="$thumbStyle">$thumbContent</div>
  <div class="flag tv" style="background: rgba(96,165,250,0.9);">LIVE</div>
  <div class="corner">$($channel.Country)</div>
  <div class="meta">
    <strong>$($channel.Name)</strong>
    <span>$($channel.Genre)</span>
    <span style="font-size:11px; opacity:0.7;">$($channel.Description)</span>
  </div>
</div>
"@
                }
            }
            'musicvideos' {
                # Search in music videos if enabled (v6.97 fix)
                if ($CONFIG.MusicVideosEnabled -and (Test-Path $CONFIG.MusicVideosDB)) {
                    $results = Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB `
                        -Query "SELECT * FROM musicvideos WHERE title LIKE @query OR artist LIKE @query OR filename LIKE @query ORDER BY CASE WHEN title LIKE @query THEN 1 WHEN artist LIKE @query THEN 2 ELSE 3 END, title" `
                        -SqlParameters @{ query = "%$Query%" }
                    
                    foreach ($mv in $results) {
                        $totalResults++
                        $size = [math]::Round($mv.size_bytes / 1MB, 1)
                        $artist = if ($mv.artist) { $mv.artist } else { "Unknown Artist" }
                        $year = if ($mv.year) { " ($($mv.year))" } else { "" }
                        
                        # Check if thumbnail exists
                        $thumbStyle = ""
                        if ($mv.thumbnail_path -and -not [string]::IsNullOrWhiteSpace($mv.thumbnail_path)) {
                            $thumbStyle = "background-image: url('/mvthumb/$($mv.thumbnail_path)'); background-size: cover; background-position: center;"
                        } else {
                            $thumbStyle = "background: linear-gradient(135deg, rgba(168,85,247,0.3), rgba(99,102,241,0.3));"
                        }
                        
                        $resultItems += @"
<a class="item" href="/play-musicvideo/$($mv.id)">
  <div class="thumb" style="$thumbStyle"></div>
  <div class="flag music-video" style="background: linear-gradient(135deg, #a855f7, #6366f1);">Music Video</div>
  <div class="corner">🎵</div>
  <div class="meta">
    <strong>$($mv.title)$year</strong>
    <span>$artist</span>
    <span style="font-size:11px; opacity:0.7;">$size MB • $($mv.format.ToUpper())</span>
  </div>
</a>
"@
                    }
                }
            }
        }
    }
    
    # Determine what was searched
    $searchScope = if ($Type) {
        switch ($Type) {
            'videos' { "Videos" }
            'music' { "Music" }
            'pictures' { "Pictures" }
            'pdfs' { "eBooks" }
            'radio' { "Radio Stations" }
            'tv' { "TV Channels" }
            'musicvideos' { "Music Videos" }
            default { "All Media" }
        }
    } else {
        "All Media"
    }
    
    $noResultsHtml = if ($totalResults -eq 0) {
        @"
<div style="text-align:center; padding:60px 20px;">
  <div style="font-size:64px; margin-bottom:20px;">🔍</div>
  <h2 style="margin:0 0 10px 0;">No results found</h2>
  <p style="color:var(--muted); margin:0;">Try searching with different keywords</p>
</div>
"@
    } else {
        ""
    }
    
    $content = @"
<div class="top">
  <div class="search">
    <span style="opacity:.85">🔎</span>
    <input placeholder="Search…" id="searchInput" value="$escapedQuery" />
  </div>
  <div style="display:flex; gap:8px; align-items:center;">
    <span style="font-size:14px; color:var(--muted);">in $searchScope</span>
  </div>
</div>

<div class="content">
  <section class="card">
    <div class="head">
      <div class="title">
        <strong>Search Results</strong>
        <span>$totalResults result$(if($totalResults -ne 1){'s'}) for "$escapedQuery"</span>
      </div>
      <div class="actions">
        <a href="/" class="small" style="text-decoration:none; color:inherit;">← Back to Home</a>
      </div>
    </div>
    <div class="grid">
      $resultItems
    </div>
    $noResultsHtml
  </section>
  
  <!-- Radio Player (for radio search results) -->
  <div id="radioPlayer" style="position: fixed; bottom: 20px; right: 20px; background: var(--panel); border: 1px solid var(--stroke); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); display: none; min-width: 300px; z-index: 1000;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
      <div style="font-size: 24px;">📻</div>
      <div style="flex: 1;">
        <div id="radioNowPlaying" style="font-weight: 600; margin-bottom: 4px;">Select a station</div>
        <div id="radioDescription" style="font-size: 12px; color: var(--muted);">Click a station to start</div>
      </div>
      <div onclick="stopRadio()" style="cursor: pointer; font-size: 24px; opacity: 0.7; transition: opacity 0.2s;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">✕</div>
    </div>
    <audio id="radioAudio" controls style="width: 100%; border-radius: 8px;"></audio>
  </div>
  
  <!-- Error Modal -->
  <div id="errorModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: var(--panel); border: 1px solid var(--stroke); border-radius: 20px; padding: 32px; max-width: 440px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.5); animation: modalSlideIn 0.3s ease;">
      <div style="text-align: center; margin-bottom: 24px;">
        <div style="font-size: 64px; margin-bottom: 16px;">📻</div>
        <h2 style="margin: 0 0 12px 0; font-size: 22px; font-weight: 600; color: var(--text);">Unable to Play Station</h2>
        <p style="margin: 0; color: var(--muted); font-size: 15px; line-height: 1.6;">
          This radio stream couldn't be played. This may happen if:
        </p>
      </div>
      <div style="background: rgba(251,191,36,0.1); border: 1px solid rgba(251,191,36,0.3); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 10px;">
          <div style="font-size: 20px;">🌍</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">Geographic Restriction</div>
            <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">The station may be geo-locked to a specific country or region</div>
          </div>
        </div>
        <div style="display: flex; align-items: start; gap: 12px;">
          <div style="font-size: 20px;">🔗</div>
          <div style="flex: 1;">
            <div style="font-weight: 600; margin-bottom: 4px; font-size: 14px;">Stream URL Changed</div>
            <div style="font-size: 13px; color: var(--muted); line-height: 1.5;">The direct streaming link may have been updated by the broadcaster</div>
          </div>
        </div>
      </div>
      <button onclick="closeErrorModal()" style="width: 100%; padding: 14px; background: linear-gradient(135deg, rgba(96,165,250,0.9), rgba(59,130,246,0.9)); border: none; border-radius: 12px; color: white; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(96,165,250,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(96,165,250,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(96,165,250,0.3)'">
        OK, Got It
      </button>
    </div>
  </div>
  
  <style>
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  </style>
</div>

<script>
let currentRadio = null;

function showErrorModal() {
  const modal = document.getElementById('errorModal');
  modal.style.display = 'flex';
}

function closeErrorModal() {
  const modal = document.getElementById('errorModal');
  modal.style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('errorModal')?.addEventListener('click', function(e) {
  if (e.target === this) {
    closeErrorModal();
  }
});

function playRadio(url, name, description) {
  const player = document.getElementById('radioPlayer');
  const audio = document.getElementById('radioAudio');
  const nowPlaying = document.getElementById('radioNowPlaying');
  const desc = document.getElementById('radioDescription');
  
  // Decode URL
  url = decodeURIComponent(url);
  
  // Show player
  player.style.display = 'block';
  
  // Update UI
  nowPlaying.textContent = name;
  desc.textContent = description;
  
  // Stop current stream if playing
  if (currentRadio) {
    audio.pause();
    audio.src = '';
  }
  
  // Start new stream
  audio.src = url;
  audio.load();
  audio.play().catch(err => {
    console.error('Playback error:', err);
    showErrorModal();
  });
  
  currentRadio = { url, name, description };
}

function stopRadio() {
  const player = document.getElementById('radioPlayer');
  const audio = document.getElementById('radioAudio');
  
  audio.pause();
  audio.src = '';
  player.style.display = 'none';
  currentRadio = null;
}

document.getElementById('searchInput').addEventListener('keyup', function(e) {
  if (e.key === 'Enter') {
    var typeParam = '$Type' ? '&type=$Type' : '';
    window.location.href = '/search?q=' + encodeURIComponent(this.value) + typeParam;
  }
});
</script>
"@
    
    return Get-HTMLPage -Content $content -Title "Search: $Query"
}


function Test-IPWhitelist {

    param(
        [string]$RemoteIP
    )
    
    # Filter out empty strings from whitelist
    $validWhitelist = @($CONFIG.IPWhitelist | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
    
    # If whitelist is empty (no valid IPs), allow all IPs
    if ($validWhitelist.Count -eq 0) {
        return $true
    }
    
    # Remove port if present (e.g., "192.168.1.1:12345" -> "192.168.1.1")
    if ($RemoteIP -match '^(.+):(\d+)$') {
        $RemoteIP = $matches[1]
    }
    
    # Remove IPv6 brackets if present (e.g., "[::1]" -> "::1")
    $RemoteIP = $RemoteIP.Trim('[', ']')
    
    # Check if IP is in whitelist
    foreach ($allowedIP in $validWhitelist) {
        if ($RemoteIP -eq $allowedIP) {
            Write-Host "  ✓ IP allowed: $RemoteIP" -ForegroundColor Green
            return $true
        }
    }
    
    # IP not in whitelist
    Write-Host "  ✗ IP blocked: $RemoteIP (not in whitelist)" -ForegroundColor Red
    return $false
}

function Get-LoginPage {
    param(
        [string]$Error = "",
        [string]$SelectedUser = ""
    )
    
    # Get all active users (max 5)
    $users = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query "SELECT username, display_name, avatar_path FROM users WHERE is_active = 1 ORDER BY user_id LIMIT 5"
    
    # Build user cards HTML
    $userCardsHtml = ""
    foreach ($user in $users) {
        $displayName = if ($user.display_name) { $user.display_name } else { $user.username }
        
        # Avatar HTML
        $avatarHtml = if ($user.avatar_path) {
            "<img src='/avatar/$($user.avatar_path)' style='width:100%; height:100%; object-fit:cover;'>"
        } else {
            "<div style='width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:64px; font-weight:700; color:white; background:linear-gradient(135deg, #34d399, #22c55e);'>$($displayName.Substring(0,1).ToUpper())</div>"
        }
        
        $userCardsHtml += @"
        <div class="user-card" onclick="selectUser('$($user.username)', '$displayName')">
          <div class="user-avatar-large">
            $avatarHtml
          </div>
          <div class="user-name">$displayName</div>
        </div>
"@
    }
    
    $errorHtml = ""
    if (-not [string]::IsNullOrWhiteSpace($Error)) {
        $errorHtml = "<div class='error-message'>$Error</div>"
    }
    
    # Show user selection or PIN entry based on SelectedUser
    $showPinEntry = if ($SelectedUser) { 'block' } else { 'none' }
    $showUserSelection = if ($SelectedUser) { 'none' } else { 'block' }
    
    # Get selected user's display name
    $selectedDisplayName = ""
    if ($SelectedUser) {
        $selectedUserData = $users | Where-Object { $_.username -eq $SelectedUser } | Select-Object -First 1
        $selectedDisplayName = if ($selectedUserData.display_name) { $selectedUserData.display_name } else { $SelectedUser }
    }
    
    return @"
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login - NexusM</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: linear-gradient(135deg, rgba(13,20,16,0.85) 0%, rgba(26,44,36,0.85) 100%);
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    color: #fff;
    padding: 20px;
    }
    .login-wrapper {
      width: 100%;
      max-width: 900px;
    }
    .logo {
      text-align: center;
      margin-bottom: 48px;
    }
    .logo h1 {
      font-size: 48px;
      font-weight: 700;
      color: #34d399;
      margin-bottom: 8px;
    }
    .logo p {
      color: rgba(255,255,255,0.6);
      font-size: 18px;
    }
    
    /* User Selection Screen */
    #user-selection {
      text-align: center;
    }
    #user-selection h2 {
      font-size: 32px;
      margin-bottom: 40px;
      font-weight: 400;
      color: rgba(255,255,255,0.9);
    }
    .user-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 32px;
      max-width: 800px;
      margin: 0 auto;
      justify-items: center;
    }
    .user-card {
      cursor: pointer;
      transition: transform 0.2s;
      text-align: center;
    }
    .user-card:hover {
      transform: scale(1.1);
    }
    .user-avatar-large {
      width: 150px;
      height: 150px;
      border-radius: 12px;
      overflow: hidden;
      border: 3px solid transparent;
      transition: border-color 0.2s;
      margin-bottom: 16px;
    }
    .user-card:hover .user-avatar-large {
      border-color: #34d399;
    }
    .user-name {
      font-size: 18px;
      font-weight: 500;
      color: rgba(255,255,255,0.8);
    }
    
    /* PIN Entry Screen */
    #pin-entry {
      max-width: 420px;
      margin: 0 auto;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 48px;
      backdrop-filter: blur(10px);
    }
    #pin-entry h2 {
      font-size: 24px;
      text-align: center;
      margin-bottom: 32px;
      font-weight: 400;
    }
    .form-group {
      margin-bottom: 24px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 500;
      color: rgba(255,255,255,0.8);
    }
    input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      transition: all 0.2s;
    }
    input:focus {
      outline: none;
      border-color: #34d399;
      background: rgba(255,255,255,0.12);
    }
    .pin-input {
      text-align: center;
      letter-spacing: 8px;
      font-size: 24px;
      font-weight: 600;
    }
    .btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #34d399, #22c55e);
      border: none;
      border-radius: 8px;
      color: #0d1410;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(52,211,153,0.3);
    }
    .btn:active {
      transform: translateY(0);
    }
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.8);
      margin-top: 12px;
    }
    .btn-secondary:hover {
      background: rgba(255,255,255,0.15);
      box-shadow: none;
    }
    .error-message {
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      color: #fca5a5;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="login-wrapper">
    <div class="logo">
    <img src="/menu/nslogo.png" alt="NexusM" style="width:120px; height:120px; margin:0 auto 16px;">
    <h1>NexusM</h1>
    <p>MEDIA LIBRARY MANAGER</p>
    </div>
    
    <!-- User Selection Screen -->
    <div id="user-selection" style="display: $showUserSelection;">
      <h2>Who’s jumping in?</h2>
      <div class="user-grid">
        $userCardsHtml
      </div>
    </div>
    
    <!-- PIN Entry Screen -->
    <div id="pin-entry" style="display: $showPinEntry;">
      <h2>Enter PIN for $selectedDisplayName</h2>
      
      $errorHtml
      
      <form method="POST" action="/login">
        <input type="hidden" id="username" name="username" value="$SelectedUser">
        
        <div class="form-group">
          <label for="pin">PIN Code (6 digits)</label>
          <input type="password" id="pin" name="pin" class="pin-input" maxlength="6" pattern="[0-9]{6}" required autofocus autocomplete="current-password">
        </div>
        
        <button type="submit" class="btn">Login</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/login'">← Back to Users</button>
      </form>
    </div>
  </div>
  
  <script>
    var randomBg = Math.floor(Math.random() * 5) + 1;
    document.body.style.backgroundImage = 
        "linear-gradient(135deg, rgba(13,20,16,0.85) 0%, rgba(26,44,36,0.85) 100%), url('/menu/bg-" + randomBg + ".jpg')";
    
    function selectUser(username, displayName) {
      window.location.href = '/login?user=' + encodeURIComponent(username);
    }
  </script>
</body>
</html>
"@
}


function Get-SettingsPage {
    param(
        [Parameter(Mandatory=$false)]
        [object]$UserSession = $Global:CurrentUser
    )
    
    # Check if user is admin
    if (-not $UserSession -or $UserSession.UserType -ne 'admin') {
        return Get-AccessDeniedPage
    }
    
    # Load current configuration - use CONFIG.ScriptRoot for PODE compatibility
    $scriptRoot = if ($CONFIG.ScriptRoot) { $CONFIG.ScriptRoot } else { $PSScriptRoot }
    $configPath = Join-Path $scriptRoot "NexusM.conf"
    $configContent = ""
    if (Test-Path $configPath) {
        $configContent = Get-Content $configPath -Raw
        # Escape HTML special characters
        $configContent = [System.Web.HttpUtility]::HtmlEncode($configContent)
    }
    
    # Get list of users
    $users = Invoke-SqliteQuery -DataSource $CONFIG.UsersDB -Query @"
SELECT user_id, username, display_name, user_type, created_date, last_login, is_active
FROM users
ORDER BY user_type DESC, username
"@
    
    $usersHtml = ""
    foreach ($user in $users) {
        $statusBadge = if ($user.is_active -eq 1) {
            "<span class='badge badge-success'>Active</span>"
        } else {
            "<span class='badge badge-danger'>Disabled</span>"
        }
        
        $typeBadge = if ($user.user_type -eq 'admin') {
            "<span class='badge badge-warning'>Admin</span>"
        } else {
            "<span class='badge badge-info'>Guest</span>"
        }
        
        $lastLogin = if ($user.last_login) { $user.last_login } else { "Never" }
        
        $usersHtml += @"
        <tr>
          <td>$($user.user_id)</td>
          <td>$($user.username)</td>
          <td>$($user.display_name)</td>
          <td>$typeBadge</td>
          <td>$statusBadge</td>
          <td style="font-size: 12px; color: rgba(255,255,255,0.6);">$($user.created_date)</td>
          <td style="font-size: 12px; color: rgba(255,255,255,0.6);">$lastLogin</td>
          <td>
            <button class='btn-small' onclick="viewUserStats('$($user.username)')">📊 Stats</button>
            <button class='btn-small' onclick="editUser('$($user.username)')">✏️ Edit</button>
            <button class='btn-small btn-danger' onclick="deleteUser('$($user.username)')">🗑️ Delete</button>
          </td>
        </tr>
"@
    }
    
    $content = @"
    <div class="settings-container">
      <h1 class="page-title">⚙️ Settings</h1>
      
      <!-- Tabs -->
      <div class="tabs">
        <button class="tab-btn active" onclick="showTab('users')">👥 User Management</button>
        <button class="tab-btn" onclick="showTab('network')">🌐 Media Shares</button>
        <button class="tab-btn" onclick="showTab('config')">🔧 Application Settings</button>
        <button class="tab-btn" onclick="showTab('about')">ℹ️ About</button>
      </div>
      
      <!-- Users Tab -->
      <div id="tab-users" class="tab-content active">
        <div class="section-header">
          <h2>User Management</h2>
          <button class="btn-primary" onclick="showCreateUserModal()">➕ Create New User</button>
        </div>
        
        <div class="table-container">
          <table class="users-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Display Name</th>
                <th>Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Last Login</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              $usersHtml
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Network Shares Tab -->
      <div id="tab-network" class="tab-content">
        <div class="section-header">
          <h2>Media Shares Management</h2>
          <div style="display: flex; gap: 12px;">
            <button class="btn-secondary" onclick="refreshAllShareStatuses()">🔄 Test All Connections</button>
            <button class="btn-primary" onclick="showAddShareModal()">➕ Add Media Share</button>
          </div>
        </div>
        
        <div class="help-box" style="margin-bottom: 24px; background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.3); border-radius: 12px; padding: 20px;">
          <h4 style="margin: 0 0 12px 0; color: #60a5fa;">📝 About Media Paths</h4>
          <p style="margin: 0 0 8px 0; color: rgba(255,255,255,0.8);">Configure local folders (C:\Movies) or network shares (\\server\share) for each media type.</p>
          <p style="margin: 0; color: rgba(255,255,255,0.6); font-size: 13px;">Use one path per media category. Credentials for network shares are encrypted using AES-256.</p>
        </div>
        
        <div id="shares-container" class="table-container">
          <p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">Loading network shares...</p>
        </div>
      </div>
      
      <!-- Config Tab -->
      <div id="tab-config" class="tab-content">
        <div class="section-header">
          <h2>Application Configuration</h2>
          <button class="btn-primary" onclick="saveConfig()">💾 Save Configuration</button>
        </div>
        
        <div class="config-editor">
          <p class="help-text">⚠️ Warning: Incorrect configuration may break the application. Restart required after changes.</p>
          <textarea id="config-editor" rows="30" spellcheck="false">$configContent</textarea>
        </div>
      </div>
      
      <!-- About Tab -->
      <div id="tab-about" class="tab-content">
        <div class="about-section">
          <h2>📚 NexusM Media Library</h2>
          <p><strong>Version:</strong> 9.1.0 (Media Paths from Database)</p>
          <p><strong>Author:</strong> PSMediaLibrary Team</p>
          <p><strong>Description:</strong> Advanced PowerShell-based media library management system with multi-user support.</p>
          
          <h3 style="margin-top: 32px;">Features</h3>
          <ul class="feature-list">
            <li>🎬 Video Library Management</li>
            <li>🎵 Music Collection with Album Art</li>
            <li>📻 Internet Radio Streaming</li>
            <li>🖼️ Picture Gallery</li>
            <li>📄 eBook Document Library</li>
            <li>👥 Multi-user Support with Encrypted Authentication</li>
            <li>📊 Per-user Watch Progress & Statistics</li>
            <li>🔒 Role-based Access Control (Admin/Guest)</li>
            <li>🎨 Customizable Themes</li>
            <li>🔍 Advanced Search & Analysis</li>
            <li>🌐 Media Shares with Encrypted Credentials (v1.6)</li>
            <li>📂 Database-driven Media Paths (v1.7)</li>
          </ul>
          
          <h3 style="margin-top: 32px;">Current User</h3>
          <div class="user-info-card">
            <p><strong>Username:</strong> $($UserSession.Username)</p>
            <p><strong>Display Name:</strong> $($UserSession.DisplayName)</p>
            <p><strong>Role:</strong> $($UserSession.UserType)</p>
            <p><strong>Session ID:</strong> $($UserSession.SessionId)</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Create User Modal -->
    <div id="createUserModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New User</h3>
          <button class="close-btn" onclick="closeCreateUserModal()">✕</button>
        </div>
        <form id="createUserForm" onsubmit="createUser(event)">
          <div class="form-group">
            <label>Username</label>
            <input type="text" id="new_username" required pattern="[a-zA-Z0-9_\-]+" title="Letters, numbers, underscore, and hyphen only">
          </div>
          <div class="form-group">
            <label>Display Name</label>
            <input type="text" id="new_displayname" required>
          </div>
          <div class="form-group">
            <label>User Type</label>
            <select id="new_usertype" required>
              <option value="guest">Guest (Read-only settings)</option>
              <option value="admin">Admin (Full access)</option>
            </select>
          </div>
          <div class="form-group">
            <label>PIN Code (6 digits)</label>
            <input type="password" id="new_pin" maxlength="6" pattern="[0-9]{6}" required>
          </div>
          <div class="form-group">
            <label>Confirm PIN</label>
            <input type="password" id="new_pin_confirm" maxlength="6" pattern="[0-9]{6}" required>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeCreateUserModal()">Cancel</button>
            <button type="submit" class="btn-primary">Create User</button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Add Network Share Modal -->
    <div id="addShareModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Media Share</h3>
          <button class="close-btn" onclick="closeAddShareModal()">✕</button>
        </div>
        <form id="addShareForm" onsubmit="createNetworkShare(event)">
          <div class="form-group">
            <label>Share Name</label>
            <input type="text" id="share_name" required placeholder="e.g., NAS_Movies">
          </div>
          <div class="form-group">
            <label>Share Type</label>
            <select id="share_type" required>
              <option value="">-- Select Type --</option>
              <option value="movies">Movies/Videos</option>
              <option value="music">Music</option>
              <option value="pictures">Pictures</option>
              <option value="pdfs">eBooks</option>
              <option value="musicvideos">Music Videos</option>
            </select>
          </div>
          <div class="form-group">
            <label>Media Path (Local or Network)</label>
            <input type="text" id="share_path" required placeholder="C:\Movies or \\NAS\Movies">
            <small style="color: rgba(255,255,255,0.5); font-size: 12px; display: block; margin-top: 4px;">Examples: C:\Movies, D:\Music, \\NAS\Videos, \\192.168.1.50\media</small>
          </div>
          <div class="form-group">
            <label>Username (optional)</label>
            <input type="text" id="share_username" placeholder="DOMAIN\username or username">
            <small style="color: rgba(255,255,255,0.5); font-size: 12px; display: block; margin-top: 4px;">Leave empty if no authentication required</small>
          </div>
          <div class="form-group">
            <label>Password (optional)</label>
            <input type="password" id="share_password" placeholder="Password">
            <small style="color: rgba(255,255,255,0.5); font-size: 12px; display: block; margin-top: 4px;">Will be encrypted before storage</small>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="closeAddShareModal()">Cancel</button>
            <button type="submit" class="btn-primary">Add Share</button>
          </div>
        </form>
      </div>
    </div>
    
    <style>
    .settings-container { padding: 20px; max-width: 1400px; margin: 0 auto; }
    .page-title { font-size: 32px; margin-bottom: 32px; color: var(--accent); }
    
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 32px;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .tab-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: rgba(255,255,255,0.9); }
    .tab-btn.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .section-header h2 { font-size: 24px; margin: 0; }
    
    .table-container {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      overflow: hidden;
    }
    .users-table {
      width: 100%;
      border-collapse: collapse;
    }
    .users-table th {
      background: rgba(255,255,255,0.05);
      padding: 16px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid rgba(255,255,255,0.1);
    }
    .users-table td {
      padding: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .users-table tr:hover {
      background: rgba(255,255,255,0.02);
    }
    
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    .badge-success { background: rgba(34,197,94,0.2); color: #22c55e; }
    .badge-danger { background: rgba(239,68,68,0.2); color: #ef4444; }
    .badge-warning { background: rgba(251,191,36,0.2); color: #fbbf24; }
    .badge-info { background: rgba(96,165,250,0.2); color: #60a5fa; }
    
    .btn-primary, .btn-secondary, .btn-small, .btn-danger {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #34d399, #22c55e);
      color: #0d1410;
    }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52,211,153,0.3); }
    
    .btn-secondary {
      background: rgba(255,255,255,0.1);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.15); }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(255,255,255,0.08);
      color: #fff;
      margin-right: 4px;
    }
    .btn-small:hover { background: rgba(255,255,255,0.15); }
    
    .btn-danger {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
      padding: 6px 12px;
      font-size: 12px;
    }
    .btn-danger:hover { background: rgba(239,68,68,0.25); }
    
    .config-editor {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 20px;
    }
    .config-editor textarea {
      width: 100%;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      padding: 16px;
      resize: vertical;
    }
    .help-text {
      color: rgba(251,191,36,0.9);
      margin-bottom: 16px;
      padding: 12px;
      background: rgba(251,191,36,0.1);
      border-left: 4px solid #fbbf24;
      border-radius: 4px;
    }
    
    .about-section {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 32px;
    }
    .about-section h2 { margin-bottom: 16px; }
    .about-section h3 { margin-top: 24px; margin-bottom: 12px; color: var(--accent); }
    .about-section p { margin-bottom: 8px; line-height: 1.6; }
    
    .feature-list {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .feature-list li {
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      border-left: 3px solid var(--accent);
    }
    
    .user-info-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }
    .user-info-card p { margin-bottom: 8px; }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    
    .modal-content {
      background: #0d1410;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .modal-header h3 { margin: 0; font-size: 20px; }
    .close-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.6);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
    }
    .close-btn:hover { color: #fff; }
    
    .modal form { padding: 24px; }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255,255,255,0.8);
    }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
    }
    .form-group select option {
      background: #1a2420;
      color: #fff;
      padding: 12px;
    }
    /* Global select option styling for all selects on settings page */
    select option {
      background: #1a2420;
      color: #fff;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.12);
    }
    
    .modal-footer {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 24px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    </style>
    
    <script>
    function showTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Show selected tab
      document.getElementById('tab-' + tabName).classList.add('active');
      event.target.classList.add('active');
    }
    
    function showCreateUserModal() {
      document.getElementById('createUserModal').classList.add('active');
    }
    
    function closeCreateUserModal() {
      document.getElementById('createUserModal').classList.remove('active');
      document.getElementById('createUserForm').reset();
    }
    
    async function createUser(event) {
      event.preventDefault();
      
      const username = document.getElementById('new_username').value;
      const displayname = document.getElementById('new_displayname').value;
      const usertype = document.getElementById('new_usertype').value;
      const pin = document.getElementById('new_pin').value;
      const pinConfirm = document.getElementById('new_pin_confirm').value;
      
      if (pin !== pinConfirm) {
        alert('PINs do not match!');
        return;
      }
      
      if (pin.length !== 6 || !/^[0-9]+$/.test(pin)) {
        alert('PIN must be exactly 6 digits!');
        return;
      }
      
      try {
        const response = await fetch('/api/users/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, displayname, usertype, pin })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('User created successfully!');
          location.reload();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error creating user: ' + error);
      }
    }
    
    async function deleteUser(username) {
      if (!confirm('Are you sure you want to delete user "' + username + '"?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/users/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('User deleted successfully!');
          location.reload();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error deleting user: ' + error);
      }
    }
    
    function editUser(username) {
      // Fetch current user data
      fetch('/api/users/get?username=' + encodeURIComponent(username))
        .then(response => response.json())
        .then(user => {
          if (!user.success) {
            alert('Error: ' + user.error);
            return;
          }
          
          // Build avatar HTML
          var avatarHtml = user.data.avatar_path ? 
            '<img src="/avatar/' + user.data.avatar_path + '" style="width:64px; height:64px; border-radius:50%; object-fit:cover; border:2px solid var(--accent);">' : 
            '<div style="width:64px; height:64px; border-radius:50%; background:var(--accent); display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; color:white;">' + (user.data.display_name || user.data.username).substring(0,1).toUpperCase() + '</div>';
          
          // Create modal
          var modal = document.createElement('div');
          modal.id = 'editUserModal';
          modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:10000;';
          
          var guestSelected = user.data.user_type === 'guest' ? 'selected' : '';
          var adminSelected = user.data.user_type === 'admin' ? 'selected' : '';
          
          modal.innerHTML = '<div style="background:var(--panel); border:1px solid var(--stroke); border-radius:16px; padding:32px; max-width:500px; width:90%; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.5);">' +
            '<h2 style="margin:0 0 24px 0; color:var(--text);">✏️ Edit User: ' + user.data.username + '</h2>' +
            
            '<div style="margin-bottom:20px;">' +
              '<label style="display:block; margin-bottom:8px; color:var(--text); font-weight:600;">Display Name</label>' +
              '<input type="text" id="editDisplayName" value="' + (user.data.display_name || '') + '" style="width:100%; padding:12px; background:var(--bg); border:1px solid var(--stroke); border-radius:8px; color:var(--text); font-size:14px;">' +
            '</div>' +
            
            '<div style="margin-bottom:20px;">' +
              '<label style="display:block; margin-bottom:8px; color:var(--text); font-weight:600;">New PIN (leave empty to keep current)</label>' +
              '<input type="password" id="editPIN" placeholder="Enter new PIN or leave blank" style="width:100%; padding:12px; background:var(--bg); border:1px solid var(--stroke); border-radius:8px; color:var(--text); font-size:14px;">' +
            '</div>' +
            
            '<div style="margin-bottom:20px;">' +
              '<label style="display:block; margin-bottom:8px; color:var(--text); font-weight:600;">User Type</label>' +
              '<select id="editUserType" style="width:100%; padding:12px; background:var(--bg); border:1px solid var(--stroke); border-radius:8px; color:var(--text); font-size:14px;">' +
                '<option value="guest" ' + guestSelected + '>Guest</option>' +
                '<option value="admin" ' + adminSelected + '>Admin</option>' +
              '</select>' +
            '</div>' +
            
            '<div style="margin-bottom:20px;">' +
              '<label style="display:block; margin-bottom:8px; color:var(--text); font-weight:600;">Avatar</label>' +
              '<div style="display:flex; align-items:center; gap:16px;">' +
                avatarHtml +
                '<div style="flex:1;">' +
                  '<input type="file" id="editAvatar" accept="image/*" style="width:100%; padding:8px; background:var(--bg); border:1px solid var(--stroke); border-radius:8px; color:var(--text); font-size:12px;">' +
                  '<div style="font-size:11px; color:var(--muted); margin-top:4px;">Max 2MB, JPG/PNG recommended</div>' +
                '</div>' +
              '</div>' +
            '</div>' +
            
            '<div style="display:flex; gap:12px; margin-top:24px;">' +
              '<button onclick="saveUserEdit(\'' + user.data.username + '\')" style="flex:1; padding:12px 24px; background:linear-gradient(135deg, var(--accent), var(--accent2)); border:none; border-radius:8px; color:white; font-weight:600; cursor:pointer;">Save Changes</button>' +
              '<button onclick="closeEditModal()" style="flex:1; padding:12px 24px; background:var(--bg); border:1px solid var(--stroke); border-radius:8px; color:var(--text); font-weight:600; cursor:pointer;">Cancel</button>' +
            '</div>' +
          '</div>';
          
          document.body.appendChild(modal);
        })
        .catch(error => {
          alert('Error loading user data: ' + error);
        });
    }
    
    function closeEditModal() {
      var modal = document.getElementById('editUserModal');
      if (modal) modal.remove();
    }
    
    async function saveUserEdit(username) {
      var displayName = document.getElementById('editDisplayName').value;
      var pin = document.getElementById('editPIN').value;
      var userType = document.getElementById('editUserType').value;
      var avatarFile = document.getElementById('editAvatar').files[0];
      
      try {
        // Build update data
        var updateData = {
          username: username,
          displayName: displayName,
          userType: userType
        };
        
        if (pin) {
          updateData.pin = pin;
        }
        
        // Handle avatar upload if provided - convert to base64
        if (avatarFile) {
          if (avatarFile.size > 2 * 1024 * 1024) {
            alert('Avatar file must be less than 2MB');
            return;
          }
          
          // Validate file type
          if (!avatarFile.type.match(/^image\/(jpeg|jpg|png|gif|webp)$/)) {
            alert('Please select a valid image file (JPG, PNG, GIF, or WEBP)');
            return;
          }
          
          // Convert to base64
          var base64Avatar = await new Promise(function(resolve, reject) {
            var reader = new FileReader();
            reader.onload = function(e) {
              // Resize image to reasonable avatar size (128x128)
              var img = new Image();
              img.onload = function() {
                var canvas = document.createElement('canvas');
                var ctx = canvas.getContext('2d');
                var size = 128;
                canvas.width = size;
                canvas.height = size;
                
                // Calculate crop area to maintain aspect ratio (square crop)
                var srcSize = Math.min(img.width, img.height);
                var srcX = (img.width - srcSize) / 2;
                var srcY = (img.height - srcSize) / 2;
                
                ctx.drawImage(img, srcX, srcY, srcSize, srcSize, 0, 0, size, size);
                resolve(canvas.toDataURL('image/jpeg', 0.85));
              };
              img.onerror = function() { reject(new Error('Failed to load image')); };
              img.src = e.target.result;
            };
            reader.onerror = function() { reject(new Error('Failed to read file')); };
            reader.readAsDataURL(avatarFile);
          });
          
          updateData.avatarImage = base64Avatar;
        }
        
        var response = await fetch('/api/users/edit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updateData)
        });
        
        var result = await response.json();
        if (result.success) {
          alert('User updated successfully!');
          closeEditModal();
          location.reload();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error updating user: ' + error);
      }
    }
    
    function viewUserStats(username) {
      window.location.href = '/user-stats?username=' + encodeURIComponent(username);
    }
    
    async function saveConfig() {
      const config = document.getElementById('config-editor').value;
      
      if (!confirm('Are you sure you want to save these configuration changes? The application will need to be restarted.')) {
        return;
      }
      
      try {
        const response = await fetch('/api/config/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ config })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Configuration saved successfully! Please restart the application for changes to take effect.');
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error saving configuration: ' + error);
      }
    }
    
    // ============= Network Shares Management Functions =============
    async function loadNetworkShares() {
      try {
        const response = await fetch('/api/networkshare/list');
        
        if (!response.ok) {
          throw new Error('HTTP ' + response.status);
        }
        
        const result = await response.json();
        
        if (result.success && result.shares) {
          displayNetworkShares(result.shares);
        } else if (result.error) {
          document.getElementById('shares-container').innerHTML = 
            '<p style="text-align: center; padding: 40px; color: #ef4444;">Error: ' + result.error + '</p>';
        } else {
          document.getElementById('shares-container').innerHTML = 
            '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No network shares configured</p>';
        }
      } catch (error) {
        console.error('Error loading network shares:', error);
        document.getElementById('shares-container').innerHTML = 
          '<p style="text-align: center; padding: 40px; color: #ef4444;">Error loading network shares: ' + error.message + '</p>';
      }
    }
    
    function displayNetworkShares(shares) {
      if (!shares || shares.length === 0) {
        document.getElementById('shares-container').innerHTML = 
          '<p style="text-align: center; padding: 40px; color: rgba(255,255,255,0.6);">No network shares configured. Click "Add Media Share" to get started.</p>';
        return;
      }
      
      let html = '<table class="users-table"><thead><tr>';
      html += '<th>Name</th><th>Type</th><th>Path</th><th>Username</th><th>Connection</th><th>Status</th><th>Last Tested</th><th>Actions</th>';
      html += '</tr></thead><tbody>';
      
      shares.forEach(share => {
        // Enabled/Disabled badge
        const statusBadge = share.enabled ? 
          '<span class="badge badge-success">Enabled</span>' : 
          '<span class="badge badge-danger">Disabled</span>';
        
        // Online/Offline badge based on last test
        let connectionBadge = '<span class="badge" style="background: rgba(128,128,128,0.2); color: #9ca3af;">⚪ Unknown</span>';
        if (share.last_test_status) {
          if (share.last_test_status.includes('not accessible') || 
              share.last_test_status.includes('not reachable') ||
              share.last_test_status.includes('failed') || 
              share.last_test_status.includes('Error') ||
              share.last_test_status.includes('denied') ||
              share.last_test_status.includes('unreachable')) {
            connectionBadge = '<span class="badge" style="background: rgba(239,68,68,0.2); color: #ef4444;">🔴 OFFLINE</span>';
          }
          else if (share.last_test_status.includes('accessible') || 
                   share.last_test_status.includes('Connected') || 
                   share.last_test_status.includes('successful') ||
                   share.last_test_status.includes('reachable')) {
            connectionBadge = '<span class="badge" style="background: rgba(34,197,94,0.2); color: #4ade80;">🟢 ONLINE</span>';
          }
        }
        
        // Detect path type (Local vs Network)
        const isNetwork = share.share_path.startsWith('\\\\\\\\') || share.share_path.startsWith('//');
        const pathTypeBadge = isNetwork ? 
          '<span class="badge" style="background: rgba(59,130,246,0.2); color: #60a5fa;">🌐 Network</span>' :
          '<span class="badge" style="background: rgba(139,92,246,0.2); color: #a78bfa;">🏠 Local</span>';
          
        const typeBadge = getTypeBadge(share.share_type);
        const hasCredentials = share.has_credentials ? '🔒' : '🔓';
        const lastTested = share.last_tested || '<em style="color: rgba(255,255,255,0.4);">Never</em>';
        
        html += '<tr>';
        html += '<td><strong>' + share.share_name + '</strong><br>' + pathTypeBadge + '</td>';
        html += '<td>' + typeBadge + '</td>';
        html += '<td style="font-family: monospace; font-size: 12px; word-break: break-all;">' + share.share_path + '</td>';
        html += '<td>' + (share.username || '<em style="color: rgba(255,255,255,0.4);">None</em>') + ' ' + hasCredentials + '</td>';
        html += '<td>' + connectionBadge + '</td>';
        html += '<td>' + statusBadge + '</td>';
        html += '<td style="font-size: 11px; color: rgba(255,255,255,0.5);">' + lastTested + '</td>';
        html += '<td style="white-space: nowrap;">';
        html += '<button class="btn-small" onclick="testNetworkShare(' + share.share_id + ')">🔍 Test</button> ';
        html += '<button class="btn-small" onclick="toggleNetworkShare(' + share.share_id + ',' + share.enabled + ')">' + (share.enabled ? '⏸️ Disable' : '▶️ Enable') + '</button> ';
        html += '<button class="btn-small btn-danger" onclick="deleteNetworkShare(' + share.share_id + ',\'' + share.share_name.replace(/'/g, "\\'") + '\')">🗑️</button>';
        html += '</td>';
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      document.getElementById('shares-container').innerHTML = html;
    }
    
    function getTypeBadge(type) {
      const badges = {
        'movies': '<span class="badge" style="background: rgba(59,130,246,0.2); color: #60a5fa;">🎬 Movies</span>',
        'music': '<span class="badge" style="background: rgba(34,197,94,0.2); color: #4ade80;">🎵 Music</span>',
        'pictures': '<span class="badge" style="background: rgba(168,85,247,0.2); color: #a78bfa;">🖼️ Pictures</span>',
        'pdfs': '<span class="badge" style="background: rgba(249,115,22,0.2); color: #fb923c;">📄 PDFs</span>',
        'musicvideos': '<span class="badge" style="background: rgba(236,72,153,0.2); color: #f472b6;">🎸 Music Videos</span>'
      };
      return badges[type] || type;
    }
    
    function showAddShareModal() {
      document.getElementById('addShareModal').classList.add('active');
    }
    
    function closeAddShareModal() {
      document.getElementById('addShareModal').classList.remove('active');
      document.getElementById('addShareForm').reset();
    }
    
    async function createNetworkShare(event) {
      event.preventDefault();
      
      const share_name = document.getElementById('share_name').value;
      const share_type = document.getElementById('share_type').value;
      const share_path = document.getElementById('share_path').value;
      const username = document.getElementById('share_username').value;
      const password = document.getElementById('share_password').value;
      
      try {
        const response = await fetch('/api/networkshare/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ share_name, share_type, share_path, username, password })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Network share added successfully!');
          closeAddShareModal();
          loadNetworkShares();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error creating network share: ' + error);
      }
    }
    
    async function testNetworkShare(shareId) {
      try {
        const btn = event.target;
        btn.disabled = true;
        btn.textContent = '⏳...';
        
        const response = await fetch('/api/networkshare/test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ share_id: shareId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✓ Connection successful: ' + result.message);
        } else {
          alert('✗ Connection failed: ' + result.message);
        }
        
        loadNetworkShares();
      } catch (error) {
        alert('Error testing network share: ' + error);
      }
    }
    
    async function refreshAllShareStatuses() {
      try {
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '⏳ Testing...';
        
        const response = await fetch('/api/networkshare/refresh-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✓ ' + result.message);
        } else {
          alert('✗ Error: ' + (result.error || 'Unknown error'));
        }
        
        btn.disabled = false;
        btn.innerHTML = originalText;
        loadNetworkShares();
      } catch (error) {
        alert('Error refreshing share statuses: ' + error);
        event.target.disabled = false;
        event.target.innerHTML = '🔄 Test All Connections';
      }
    }
    
    async function toggleNetworkShare(shareId, currentState) {
      const newState = currentState ? 0 : 1;
      
      try {
        const response = await fetch('/api/networkshare/toggle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ share_id: shareId, enabled: newState })
        });
        
        const result = await response.json();
        
        if (result.success) {
          loadNetworkShares();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error toggling network share: ' + error);
      }
    }
    
    async function deleteNetworkShare(shareId, shareName) {
      if (!confirm('Are you sure you want to delete network share "' + shareName + '"?')) {
        return;
      }
      
      try {
        const response = await fetch('/api/networkshare/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ share_id: shareId })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('Network share deleted successfully!');
          loadNetworkShares();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error deleting network share: ' + error);
      }
    }
    
    // Load network shares when page loads or tab is shown
    document.addEventListener('DOMContentLoaded', function() {
      // Only load if we're on the network tab or will be
      setTimeout(loadNetworkShares, 100);
    });
    
    // Ensure PIN inputs only accept numbers
    document.querySelectorAll('input[type="password"][maxlength="6"]').forEach(input => {
      input.addEventListener('input', function() {
        this.value = this.value.replace(/[^0-9]/g, '');
      });
    });
    </script>
"@
    
    return Get-HTMLPage -Content $content -Title "Settings - NexusM"
}


function Get-AccessDeniedPage {
    $content = @"
    <div style="text-align: center; padding: 100px 20px;">
      <h1 style="font-size: 72px; margin-bottom: 24px;">🔒</h1>
      <h2 style="font-size: 32px; margin-bottom: 16px;">Access Denied</h2>
      <p style="font-size: 18px; color: rgba(255,255,255,0.6); margin-bottom: 32px;">
        You don't have permission to access this page.
      </p>
      <a href="/" style="display: inline-block; padding: 12px 24px; background: linear-gradient(135deg, #34d399, #22c55e); color: #0d1410; text-decoration: none; border-radius: 8px; font-weight: 600;">
        Go to Home
      </a>
    </div>
"@
    
    return Get-HTMLPage -Content $content -Title "Access Denied"
}


function Get-UserStatsPage {
    param(
        [Parameter(Mandatory=$true)]
        [string]$Username
    )
    
    $userDbPath = Join-Path $CONFIG.UsersDBPath "$Username.db"
    
    if (-not (Test-Path $userDbPath)) {
        $content = "<div style='text-align:center; padding:100px;'><h2>No statistics available for this user</h2></div>"
        return Get-HTMLPage -Content $content -Title "User Stats"
    }
    
    # Get stats
    $videoStats = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as total_watched,
    SUM(CASE WHEN completed = 1 THEN 1 ELSE 0 END) as completed_count,
    SUM(watch_count) as total_plays,
    AVG(percent_watched) as avg_completion
FROM video_progress
"@
    
    $musicStats = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as unique_tracks,
    SUM(play_count) as total_plays,
    SUM(total_play_time_seconds) as total_time
FROM music_history
"@
    
    $radioStats = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 
    COUNT(*) as unique_stations,
    SUM(listen_count) as total_listens,
    SUM(total_listen_time_seconds) as total_time
FROM radio_history
"@
    
    $topMusic = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT artist, title, play_count
FROM music_history
ORDER BY play_count DESC
LIMIT 10
"@
    
    $topMusicHtml = ""
    $rank = 1
    foreach ($track in $topMusic) {
        $artistTitle = if ($track.artist -and $track.title) {
            "$($track.artist) - $($track.title)"
        } elseif ($track.title) {
            $track.title
        } else {
            "(Unknown)"
        }
        $topMusicHtml += "<div class='stat-item'><span class='rank'>$rank.</span> $artistTitle <span class='plays'>$($track.play_count) plays</span></div>"
        $rank++
    }
    
    $musicHours = [math]::Round($musicStats.total_time / 3600, 1)
    $radioHours = [math]::Round($radioStats.total_time / 3600, 1)
    
    $content = @"
    <div class="stats-container">
      <h1 class="page-title"><img src="/menu/analysis.png" style="width:32px; height:32px; vertical-align:middle;"> Statistics for: $Username</h1>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon"><img src="/menu/movie.png" style="width:48px; height:48px;"></div>
          <div class="stat-content">
            <h3>Videos</h3>
            <div class="stat-value">$($videoStats.total_watched)</div>
            <div class="stat-label">Videos Watched</div>
            <div class="stat-details">
              <div>✓ $($videoStats.completed_count) completed</div>
              <div>▶ $($videoStats.total_plays) total plays</div>
              <div>📈 $([math]::Round($videoStats.avg_completion, 1))% avg completion</div>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon"><img src="/menu/music.png" style="width:48px; height:48px;"></div>
          <div class="stat-content">
            <h3>Music</h3>
            <div class="stat-value">$($musicStats.unique_tracks)</div>
            <div class="stat-label">Unique Tracks</div>
            <div class="stat-details">
              <div>▶ $($musicStats.total_plays) total plays</div>
              <div>⏱ $musicHours hours listened</div>
            </div>
          </div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon"><img src="/menu/radio.png" style="width:48px; height:48px;"></div>
          <div class="stat-content">
            <h3>Radio</h3>
            <div class="stat-value">$($radioStats.unique_stations)</div>
            <div class="stat-label">Stations</div>
            <div class="stat-details">
              <div>▶ $($radioStats.total_listens) total listens</div>
              <div>⏱ $radioHours hours listened</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="top-music-section">
        <h2><img src="/menu/music.png" style="width:28px; height:28px; vertical-align:middle;"> Top 10 Music Tracks</h2>
        <div class="top-music-list">
          $topMusicHtml
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 40px;">
        <a href="/settings" class="btn-back">← Back to Settings</a>
      </div>
    </div>
    
    <style>
    .stats-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
    .page-title { font-size: 32px; margin-bottom: 32px; text-align: center; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      gap: 20px;
    }
    .stat-icon {
      font-size: 48px;
      opacity: 0.8;
    }
    .stat-content { flex: 1; }
    .stat-content h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      color: rgba(255,255,255,0.6);
    }
    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-bottom: 16px;
    }
    .stat-details {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      line-height: 1.8;
    }
    
    .top-music-section {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 32px;
    }
    .top-music-section h2 {
      margin: 0 0 24px 0;
      font-size: 24px;
    }
    .top-music-list {
      display: grid;
      gap: 12px;
    }
    .stat-item {
      padding: 16px;
      background: rgba(255,255,255,0.03);
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .stat-item .rank {
      font-weight: 700;
      color: var(--accent);
      min-width: 30px;
    }
    .stat-item .plays {
      margin-left: auto;
      color: rgba(255,255,255,0.5);
      font-size: 14px;
    }
    
    .btn-back {
      display: inline-block;
      padding: 12px 24px;
      background: rgba(255,255,255,0.1);
      color: #fff;
      text-decoration: none;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      font-weight: 600;
      transition: all 0.2s;
    }
    .btn-back:hover {
      background: rgba(255,255,255,0.15);
      transform: translateY(-2px);
    }
    </style>
"@
    
    return Get-HTMLPage -Content $content -Title "User Statistics"
}


function Start-PodeMediaServer {
    param(
        [int]$Port = $CONFIG.ServerPort
    )
    
    Write-Host "`n=== Starting PODE Web Server ===" -ForegroundColor Cyan
    Write-Host "URL: http://$($CONFIG.ServerHost):$Port" -ForegroundColor Green
    
    # Display IP whitelist status - filter out empty strings
    $validWhitelistIPs = @($CONFIG.IPWhitelist | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
    if ($validWhitelistIPs.Count -gt 0) {
        Write-Host "`n[Security] IP Whitelist: ENABLED" -ForegroundColor Yellow
        Write-Host "  Allowed IPs:" -ForegroundColor Gray
        foreach ($ip in $validWhitelistIPs) {
            Write-Host "    • $ip" -ForegroundColor Gray
        }
    }
    else {
        Write-Host "`n[Security] IP Whitelist: DISABLED (All IPs allowed)" -ForegroundColor Yellow
    }
    
    # Check media share status on startup (v3.7, updated v6.96 to use SharesDB)
    if ($CONFIG.SharesDB -and (Test-Path $CONFIG.SharesDB)) {
        $null = Test-AllMediaSharesStatus -DatabasePath $CONFIG.SharesDB
    }
    
    Write-Host "Press Ctrl+C to stop the server`n" -ForegroundColor Yellow
    
    # Mark server as running
    $Global:ServerRunning = $true
    
    # Capture variables for PODE scriptblock (PODE doesn't support $using: like jobs)
    $serverHost = $CONFIG.ServerHost
    $serverPort = $Port
    $ipWhitelist = $CONFIG.IPWhitelist
    $logsFolder = $CONFIG.LogsFolder
    
    # PODE Performance settings from config with fallback defaults (v7.9)
    $podeThreads = if ($CONFIG.PODEThreads) { $CONFIG.PODEThreads } else { 8 }
    $podeSessionTimeout = if ($CONFIG.PODESessionTimeout) { $CONFIG.PODESessionTimeout } else { 28800 }
    $podeRequestTimeout = if ($CONFIG.PODERequestTimeout) { $CONFIG.PODERequestTimeout } else { 300 }
    
    # Tip: If startup is slow, reduce PODEThreads in NexusM.conf (e.g., 4 instead of 8)
    # Fewer threads = faster startup, but may handle fewer concurrent requests
    
    # Ensure logs folder exists
    if (-not (Test-Path $logsFolder)) {
        New-Item -Path $logsFolder -ItemType Directory -Force | Out-Null
    }
    
    # FIXED: Create/update server.psd1 configuration file BEFORE starting Pode
    # Pode uses this file for request timeouts - default is 30 seconds which causes HTTP 408 errors
    $podeConfigPath = Join-Path $PSScriptRoot 'server.psd1'
    $podeConfig = @"
@{
    Server = @{
        Request = @{
            Timeout = $podeRequestTimeout
            BodySize = 100MB
        }
    }
}
"@
    # Write the config file if it doesn't exist or needs updating
    $needsUpdate = $false
    if (-not (Test-Path $podeConfigPath)) {
        $needsUpdate = $true
    } else {
        try {
            $existingConfig = Import-PowerShellDataFile -Path $podeConfigPath -ErrorAction SilentlyContinue
            if (-not $existingConfig.Server -or -not $existingConfig.Server.Request -or 
                -not $existingConfig.Server.Request.Timeout -or 
                $existingConfig.Server.Request.Timeout -ne $podeRequestTimeout) {
                $needsUpdate = $true
            }
        } catch {
            $needsUpdate = $true
        }
    }
    if ($needsUpdate) {
        $podeConfig | Out-File -FilePath $podeConfigPath -Encoding UTF8 -Force
    }
    
    # Try to start PODE server with error handling for admin privileges
    try {
        # v7.40: Register cleanup handlers to kill FFmpeg when script exits
        Register-TranscodeCleanupHandlers
        
        # Inform user about thread initialization (this can take 10-30 seconds)
        Write-Host "[i] Initializing $podeThreads server threads (this may take 10-30 seconds)..." -ForegroundColor Yellow
        
        # Start PODE server with configurable threads (v7.9)
        Start-PodeServer -Threads $podeThreads {
            
            # HTTP only endpoint
            Add-PodeEndpoint -Address $serverHost -Port $serverPort -Protocol Http
            $script:activeProtocol = "http"
            $script:activePort = $serverPort
        
        # Enable logging based on configuration - errors only
        $errorLogLevels = @('Error')
        
        # Create logs folder path for PODE (must be relative or absolute)
        $podeLogsPath = $logsFolder
        
        # FIXED: Ensure logs folder exists (may have been lost in scriptblock scope)
        if (-not (Test-Path $podeLogsPath)) {
            New-Item -Path $podeLogsPath -ItemType Directory -Force | Out-Null
        }
        
        # FIXED: Create initial empty error log file on startup so it exists even before first error
        $errorLogFile = Join-Path $podeLogsPath "errors_$(Get-Date -Format 'yyyy-MM-dd').log"
        if (-not (Test-Path $errorLogFile)) {
            $startupEntry = "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] [Informational] PSMediaLibrary web server started - Error logging initialized"
            $startupEntry | Out-File -FilePath $errorLogFile -Encoding UTF8

        }
        
        # Enable file-based error logging to /logs folder - errors only
        New-PodeLoggingMethod -File -Path $podeLogsPath -Name 'errors' | Enable-PodeErrorLogging -Levels $errorLogLevels
        
        # Note: Request timeout is configured via server.psd1 (created before Start-PodeServer)
        # Store in state for reference (useful for debugging and API access)
        Set-PodeState -Name 'ServerConfig' -Value @{
            RequestTimeout = $podeRequestTimeout  # Configurable in NexusM.conf
        }
        
        # ===== SESSION MIDDLEWARE =====
        # Session timeout configurable in NexusM.conf (default: 28800 = 8 hours)
        Enable-PodeSessionMiddleware -Duration $podeSessionTimeout -Extend -Generator {
            return [guid]::NewGuid().ToString()
        }
        
        # Verbose logging disabled:
        # $sessionHours = [math]::Round($podeSessionTimeout / 3600, 1)
        # Write-Host "[✓] Session middleware enabled (${sessionHours}h timeout)" -ForegroundColor Green
        
        # ===== PODE STATE: Store CONFIG for access in routes =====
        # Pode runs routes in isolated runspaces, so we use Set-PodeState to share data
        $configForPode = Get-MediaConfig
        Set-PodeState -Name 'MediaConfig' -Value @{
            UsersDB = $configForPode.UsersDB
            UsersDBPath = $configForPode.UsersDBPath
            SharesDB = $configForPode.SharesDB
            MoviesDB = $configForPode.MoviesDB
            MusicDB = $configForPode.MusicDB
            PicturesDB = $configForPode.PicturesDB
            PDFDB = $configForPode.PDFDB
            SecurityByPin = $configForPode.SecurityByPin
            ScriptRoot = $configForPode.ScriptRoot
            ToolsFolder = $configForPode.ToolsFolder
            PosterCacheFolder = $configForPode.PosterCacheFolder
            AlbumArtCacheFolder = $configForPode.AlbumArtCacheFolder
            PDFPreviewCacheFolder = $configForPode.PDFPreviewCacheFolder
            EbookCoverCacheFolder = $configForPode.PDFPreviewCacheFolder
            AvatarFolder = $configForPode.AvatarFolder
            RadioStations = $configForPode.RadioStations
            RadioLogoCacheFolder = $configForPode.RadioLogoCacheFolder
            TVChannels = $configForPode.TVChannels
            TVLogoCacheFolder = $configForPode.TVLogoCacheFolder
            EPUBCoverCacheFolder = $configForPode.EPUBCoverCacheFolder
            # Media folder paths for scanning
            MoviesFolder = $configForPode.MoviesFolder
            MusicFolder = $configForPode.MusicFolder
            PicturesFolder = $configForPode.PicturesFolder
            PDFFolder = $configForPode.PDFFolder
            # File extensions for scanning
            VideoExtensions = $configForPode.VideoExtensions
            AudioExtensions = $configForPode.AudioExtensions
            ImageExtensions = $configForPode.ImageExtensions
            PDFExtensions = $configForPode.PDFExtensions
            # Other config needed for scanning
            LowQualityVideoThreshold = $configForPode.LowQualityVideoThreshold
            TMDB_APIKey = $configForPode.TMDB_APIKey
            # Music Videos Feature (v7.10, v1.7: folder path from database)
            MusicVideosEnabled = $configForPode.MusicVideosEnabled
            MusicVideosFolder = "D:\Share"  # Placeholder - actual path from Get-AllMediaPaths
            MusicVideosDB = $configForPode.MusicVideosDB
            MusicVideoThumbsFolder = $configForPode.MusicVideoThumbsFolder
            # Menu Visibility Settings (v7.19)
            RadioEnabled = $configForPode.RadioEnabled
            InternetTVEnabled = $configForPode.InternetTVEnabled
            PicturesEnabled = $configForPode.PicturesEnabled
            EbooksEnabled = $configForPode.EbooksEnabled
            # Picture Thumbnails (v4.0)
            PictureThumbsFolder = $configForPode.PictureThumbsFolder
            # FFmpeg path for thumbnail generation (v1.8)
            FFmpegPath = $Global:FFmpegPath
        }
        
        # ===== PODE STATE: Store FFmpeg Capabilities for transcoding =====
        # This is CRITICAL for MKV/AVI video playback via HLS transcoding
        if ($Global:FFmpegCapabilities) {
            Set-PodeState -Name 'FFmpegCapabilities' -Value $Global:FFmpegCapabilities
            Write-Host "[✓] FFmpegCapabilities stored in Pode state" -ForegroundColor Green
        }
        else {
            Write-Host "[!] WARNING: FFmpegCapabilities not available for Pode routes!" -ForegroundColor Red
        }
        
        # Store TranscodingConfig for routes
        Set-PodeState -Name 'TranscodingConfig' -Value $Global:TranscodingConfig
        
        # Store ActiveTranscodes dictionary reference
        Set-PodeState -Name 'ActiveTranscodes' -Value $Global:ActiveTranscodes
        
        # Store HLS Cache database path for routes (v3.6)
        if ($Global:HLSCacheDBPath) {
            Set-PodeState -Name 'HLSCacheDBPath' -Value $Global:HLSCacheDBPath
        }
        
        # v7.45: Store TranscodeSemaphore for concurrency control across routes
        if ($Global:TranscodeSemaphore) {
            Set-PodeState -Name 'TranscodeSemaphore' -Value $Global:TranscodeSemaphore
        }
        
        # Store Transcode log path for routes (v7.15)
        if ($Global:TranscodeLogPath) {
            Set-PodeState -Name 'TranscodeLogPath' -Value $Global:TranscodeLogPath
        }
        
        # Verbose logging disabled:
        # Write-Host "[✓] Pode state initialized with config" -ForegroundColor Green
        
        # ===== IP WHITELIST MIDDLEWARE =====
        # Filter out empty strings from whitelist (config may have empty placeholders)
        $validIPs = @($ipWhitelist | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
        
        if ($validIPs.Count -gt 0) {
            # Allow whitelisted IPs
            foreach ($ip in $validIPs) {
                Add-PodeAccessRule -Access Allow -Type IP -Values @($ip)
            }
            
            # Deny all others
            Add-PodeAccessRule -Access Deny -Type IP -Values @('*')
            
            # Verbose logging disabled:
            # Write-Host "[✓] IP whitelist middleware enabled" -ForegroundColor Green
        }
        # Verbose logging disabled:
        # else {
        #     Write-Host "[i] IP whitelist disabled - all IPs allowed" -ForegroundColor Gray
        # }
        
        # ===== PHASE 2: AUTHENTICATION MIDDLEWARE =====
        # Must be added BEFORE routes - checks if user is authenticated
        Add-PodeMiddleware -Name 'AuthCheck' -ScriptBlock {
            $config = Get-PodeState -Name 'MediaConfig'
            
            # Skip auth for these paths (public paths)
            $publicPaths = @('/login', '/logout', '/favicon.ico', '/videojs', '/errors', '/avatar', '/avatars', '/poster', '/posters', '/albumart', '/mvthumb', '/picthumb', '/menu', '/radiologos', '/tvlogos', '/pdfpreview', '/epubjs', '/epubcover', '/image', '/stream-audio', '/serve-epub', '/view-pdf', '/stream')
            $isPublic = $false
            foreach ($path in $publicPaths) {
                if ($WebEvent.Path -like "$path*") {
                    $isPublic = $true
                    break
                }
            }
            
            if ($isPublic) {
                return $true
            }
            
            # Check if SecurityByPin is disabled (auto-login as admin)
            if (-not $config.SecurityByPin) {
                # Auto-login as admin if not already logged in
                if ($null -eq $WebEvent.Session.Data.User) {
                    $usersDbPath = $config.UsersDB
                    $adminUser = Invoke-SqliteQuery -DataSource $usersDbPath `
                        -Query "SELECT user_id, username, display_name, user_type FROM users WHERE user_type = 'admin' LIMIT 1"
                    
                    if ($adminUser) {
                        $userDbPath = Join-Path $config.UsersDBPath "$($adminUser.username).db"
                        
                        # Use a simple hashtable - avoid modifications after creation to prevent race conditions
                        $WebEvent.Session.Data.User = @{
                            UserId = $adminUser.user_id
                            Username = $adminUser.username
                            DisplayName = $adminUser.display_name
                            UserType = $adminUser.user_type
                            UserDB = $userDbPath
                            LoginTime = (Get-Date).ToString('o')
                        }
                    }
                }
                return $true
            }
            
            # Check if user is logged in
            if ($null -eq $WebEvent.Session.Data.User) {
                # Redirect to login
                Move-PodeResponseUrl -Url '/login'
                return $false
            }
            
            # NOTE: Removed LastActivity update - it caused "Collection was modified during enumeration" 
            # errors due to race condition with Pode's session serialization. The -Extend flag on 
            # Enable-PodeSessionMiddleware already handles session extension automatically.
            
            return $true
        }
        
        Write-Host "[✓] Authentication middleware enabled" -ForegroundColor Green
        
        # ===== PHASE 3: CONTENT PAGES =====
        
        # ----- 3.1 Home Page Route -----
        Add-PodeRoute -Method Get -Path '/' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Get sort parameters from query string
            $sortParam = $WebEvent.Query['sort']
            $sortParams = if ($sortParam) { $sortParam -split ',' } else { @('rating', 'date') }
            
            $html = Get-HomePage -SortParams $sortParams
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.2 Avatar Static Route -----
        # Serve user avatars from the avatars folder
        $config = Get-PodeState -Name 'MediaConfig'
        $avatarFolder = $config.AvatarFolder
        if (-not [string]::IsNullOrWhiteSpace($avatarFolder) -and (Test-Path $avatarFolder)) {
            Add-PodeStaticRoute -Path '/avatar' -Source $avatarFolder
            Add-PodeStaticRoute -Path '/avatars' -Source $avatarFolder
        }
        elseif ([string]::IsNullOrWhiteSpace($avatarFolder)) {
            Write-Host "[!] Avatar folder config not yet available - route will be added on next request" -ForegroundColor Yellow
        }
        else {
            Write-Host "[!] Avatar folder not found at: $avatarFolder" -ForegroundColor Yellow
        }
        
        # ----- 3.3 Poster Cache Static Route -----
        $posterCacheFolder = $config.PosterCacheFolder
        if (-not [string]::IsNullOrWhiteSpace($posterCacheFolder) -and (Test-Path $posterCacheFolder)) {
            Add-PodeStaticRoute -Path '/posters' -Source $posterCacheFolder
            Add-PodeStaticRoute -Path '/poster' -Source $posterCacheFolder
        }
        
        # ----- 3.4 Album Art Cache Static Route -----
        $albumArtFolder = $config.AlbumArtCacheFolder
        if (-not [string]::IsNullOrWhiteSpace($albumArtFolder) -and (Test-Path $albumArtFolder)) {
            Add-PodeStaticRoute -Path '/albumart' -Source $albumArtFolder
        }
        
        # ----- 3.4b Music Video Thumbnails Static Route (v1.8) -----
        $mvThumbsFolder = $config.MusicVideoThumbsFolder
        if (-not [string]::IsNullOrWhiteSpace($mvThumbsFolder)) {
            if (-not (Test-Path $mvThumbsFolder)) {
                New-Item -ItemType Directory -Path $mvThumbsFolder -Force | Out-Null
            }
            Add-PodeStaticRoute -Path '/mvthumb' -Source $mvThumbsFolder
        }
        
        # ----- 3.4c Picture Thumbnails Static Route (v4.0) -----
        $picThumbsFolder = $config.PictureThumbsFolder
        if (-not [string]::IsNullOrWhiteSpace($picThumbsFolder)) {
            if (-not (Test-Path $picThumbsFolder)) {
                New-Item -ItemType Directory -Path $picThumbsFolder -Force | Out-Null
            }
            Add-PodeStaticRoute -Path '/picthumb' -Source $picThumbsFolder
        }
        
        # ----- 3.5 Menu Icons Static Route -----
        if (-not [string]::IsNullOrWhiteSpace($config.ScriptRoot)) {
            $menuFolder = Join-Path $config.ScriptRoot "templates\default\menu"
            if (Test-Path $menuFolder) {
                Add-PodeStaticRoute -Path '/menu' -Source $menuFolder
            }
            else {
                Write-Host "[!] Menu folder not found at: $menuFolder" -ForegroundColor Yellow
            }
        }
        
        # ----- 3.5 Videos Page -----
        Add-PodeRoute -Method Get -Path '/videos' -ScriptBlock {
            # Set CONFIG for existing helper functions
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Get filter from query string
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            
            $html = Get-VideosPage -Filter $filter
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.6 Videos Genres List -----
        Add-PodeRoute -Method Get -Path '/videos/genres' -ScriptBlock {
            # Set CONFIG for existing helper functions
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $html = Get-GenreListPage
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.7 Videos by Genre -----
        Add-PodeRoute -Method Get -Path '/videos/genre/:name' -ScriptBlock {
            # Set CONFIG for existing helper functions
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $genreName = [System.Web.HttpUtility]::UrlDecode($WebEvent.Parameters['name'])
            $html = Get-GenreVideosPage -Genre $genreName
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.8 Music Page -----
        Add-PodeRoute -Method Get -Path '/music' -ScriptBlock {
            # Set CONFIG for existing helper functions
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Get filter from query string
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            
            # Get page from query string (v4.9)
            $page = [int]$WebEvent.Query['page']
            if ($page -lt 1) { $page = 1 }
            
            $html = Get-MusicPage -Filter $filter -Page $page
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.9 Pictures Page -----
        Add-PodeRoute -Method Get -Path '/pictures' -ScriptBlock {
            # Set CONFIG for existing helper functions
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Get filter from query string
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            
            # v4.0: Get category from query string
            $category = $WebEvent.Query['category']
            if ([string]::IsNullOrWhiteSpace($category)) { $category = "" }
            
            # Get page from query string (v4.9)
            $page = [int]$WebEvent.Query['page']
            if ($page -lt 1) { $page = 1 }
            
            $html = Get-PicturesPage -Filter $filter -Category $category -Page $page
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.10 PDFs Page -----
        Add-PodeRoute -Method Get -Path '/pdfs' -ScriptBlock {
            # Set CONFIG for existing helper functions
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Get filter from query string
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            
            # Get page from query string (v4.9)
            $page = [int]$WebEvent.Query['page']
            if ($page -lt 1) { $page = 1 }
            
            $html = Get-PDFsPage -Filter $filter -Page $page
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.11 Radio Page -----
        Add-PodeRoute -Method Get -Path '/radio' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            
            # Get page from query string (v4.9)
            $page = [int]$WebEvent.Query['page']
            if ($page -lt 1) { $page = 1 }
            
            $html = Get-RadioPage -Filter $filter -Page $page
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.12 TV Page -----
        Add-PodeRoute -Method Get -Path '/tv' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            $page = $WebEvent.Query['page']
            if ([string]::IsNullOrWhiteSpace($page)) { $page = 1 } else { $page = [int]$page }
            
            $html = Get-TVPage -Filter $filter -Page $page
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.12b Music Videos Page (v7.10) -----
        Add-PodeRoute -Method Get -Path '/musicvideos' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if Music Videos is enabled
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                $html = Get-HTMLPage -Content "<h1>Music Videos Disabled</h1><p>Enable MusicVideos in NexusM.conf to use this feature.</p><p><a href='/'>← Back to Home</a></p>" -Title "Feature Disabled"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            $filter = $WebEvent.Query['filter']
            if ([string]::IsNullOrWhiteSpace($filter)) { $filter = "all" }
            
            # Get page from query string (v4.9)
            $page = [int]$WebEvent.Query['page']
            if ($page -lt 1) { $page = 1 }
            
            $html = Get-MusicVideosPage -Filter $filter -Page $page
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.12c Play Music Video Route (v7.10) -----
        Add-PodeRoute -Method Get -Path '/play-musicvideo/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if Music Videos is enabled
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                $html = Get-HTMLPage -Content "<h1>Music Videos Disabled</h1><p><a href='/'>← Back to Home</a></p>" -Title "Feature Disabled"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            $videoId = $WebEvent.Parameters['id']
            $shuffleMode = $false
            
            # Check if shuffle mode
            if ($videoId -eq "shuffle") {
                $shuffleMode = $true
                $maxAttempts = 10
                $attempt = 0
                $foundValidVideo = $false
                $video = $null
                
                while (-not $foundValidVideo -and $attempt -lt $maxAttempts) {
                    $attempt++
                    $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                        -Query "SELECT * FROM musicvideos ORDER BY RANDOM() LIMIT 1"
                    
                    if ($video -and (Test-Path -LiteralPath $video.filepath)) {
                        $foundValidVideo = $true
                    }
                }
                
                if (-not $foundValidVideo) {
                    $html = Get-HTMLPage -Content "<h1>No music videos found</h1><p><a href='/musicvideos'>← Back to Music Videos</a></p>" -Title "Error"
                    Write-PodeHtmlResponse -Value $html
                    return
                }
                $videoId = $video.id
            }
            else {
                $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                    -Query "SELECT * FROM musicvideos WHERE id = @id" `
                    -SqlParameters @{ id = $videoId }
            }
            
            if ($video) {
                $html = Get-MusicVideoPlayerPage -Video $video -ShuffleMode $shuffleMode
                Write-PodeHtmlResponse -Value $html
            }
            else {
                $html = Get-HTMLPage -Content "<h1>Music video not found</h1><p><a href='/musicvideos'>← Back to Music Videos</a></p>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.12d Stream Music Video Route (v7.10) -----
        Add-PodeRoute -Method Get -Path '/stream-musicvideo/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                Set-PodeResponseStatus -Code 403
                return
            }
            
            $videoId = $WebEvent.Parameters['id']
            
            $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                -Query "SELECT filepath, format, size_bytes FROM musicvideos WHERE id = @id" `
                -SqlParameters @{ id = $videoId }
            
            if (-not $video -or -not (Test-Path -LiteralPath $video.filepath)) {
                Set-PodeResponseStatus -Code 404
                return
            }
            
            $filePath = $video.filepath
            
            $contentType = switch ($video.format.ToLower()) {
                'mp4'  { 'video/mp4' }
                'mkv'  { 'video/x-matroska' }
                'avi'  { 'video/x-msvideo' }
                'webm' { 'video/webm' }
                'mov'  { 'video/quicktime' }
                default { 'video/mp4' }
            }
            
            # Use shared RFC 7233 compliant streaming function
            Send-StreamedFileResponse -WebEvent $WebEvent -FilePath $filePath -ContentType $contentType
        }
        
        # ----- 3.12e Music Video Stream Info API REMOVED in v7.53 -----
        # The HLS remuxing route /api/musicvideo-stream-info/:id has been removed.
        # Music videos now use direct streaming via /stream-musicvideo/:id endpoint.
        # This avoids HLS segment caching which caused inconsistent playback delays
        # for some MP4 files with moov atom placement issues.
        
        # ----- 3.13 Playlists Page -----
        Add-PodeRoute -Method Get -Path '/playlists' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $html = Get-PlaylistsPage
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.14 Playlist Detail Page -----
        Add-PodeRoute -Method Get -Path '/playlist/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $playlistId = [int]$WebEvent.Parameters['id']
            $html = Get-PlaylistDetailPage -PlaylistId $playlistId
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.15 Radio Logos Static Route -----
        $radioLogoFolder = $config.RadioLogoCacheFolder
        if (-not $radioLogoFolder -and -not [string]::IsNullOrWhiteSpace($config.ScriptRoot)) {
            $radioLogoFolder = Join-Path $config.ScriptRoot "assets\radiologos"
        }
        if (-not [string]::IsNullOrWhiteSpace($radioLogoFolder)) {
            if (-not (Test-Path $radioLogoFolder)) {
                New-Item -ItemType Directory -Path $radioLogoFolder -Force | Out-Null
                Write-Host "[i] Created radio logos folder: $radioLogoFolder" -ForegroundColor Yellow
            }
            Add-PodeStaticRoute -Path '/radiologos' -Source $radioLogoFolder
            Write-Host "[✓] Radio logos route registered: /radiologos -> $radioLogoFolder" -ForegroundColor Green
        }
        
        # ----- 3.16 TV Logos Static Route -----
        $tvLogoFolder = $config.TVLogoCacheFolder
        if (-not $tvLogoFolder -and -not [string]::IsNullOrWhiteSpace($config.ScriptRoot)) {
            $tvLogoFolder = Join-Path $config.ScriptRoot "assets\tvlogos"
        }
        if (-not [string]::IsNullOrWhiteSpace($tvLogoFolder)) {
            if (-not (Test-Path $tvLogoFolder)) {
                New-Item -ItemType Directory -Path $tvLogoFolder -Force | Out-Null
                Write-Host "[i] Created TV logos folder: $tvLogoFolder" -ForegroundColor Yellow
            }
            Add-PodeStaticRoute -Path '/tvlogos' -Source $tvLogoFolder
        }
        
        # ----- 3.17 Ebook Cover Static Route (unified for PDF and EPUB) -----
        $ebookCoverFolder = $config.PDFPreviewCacheFolder  # Now points to ebookcovers
        if (-not [string]::IsNullOrWhiteSpace($ebookCoverFolder)) {
            if (-not (Test-Path $ebookCoverFolder)) {
                New-Item -ItemType Directory -Path $ebookCoverFolder -Force | Out-Null
                Write-Host "[i] Created ebook covers folder: $ebookCoverFolder" -ForegroundColor Yellow
            }
            Add-PodeStaticRoute -Path '/ebookcover' -Source $ebookCoverFolder
            # Keep legacy routes for backward compatibility
            Add-PodeStaticRoute -Path '/pdfpreview' -Source $ebookCoverFolder
            Add-PodeStaticRoute -Path '/epubcover' -Source $ebookCoverFolder
        }
        
        # ----- 3.18 EPUB.js Static Route -----
        if (-not [string]::IsNullOrWhiteSpace($config.ToolsFolder)) {
            $epubjsFolder = Join-Path $config.ToolsFolder "epubjs"
            if (Test-Path $epubjsFolder) {
                Add-PodeStaticRoute -Path '/epubjs' -Source $epubjsFolder
            }
        }
        
        
        # ----- 3.20 Settings Page (Admin Only) -----
        Add-PodeRoute -Method Get -Path '/settings' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Move-PodeResponseUrl -Url '/'
                return
            }
            
            $html = Get-SettingsPage
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.20b Save Configuration API -----
        Add-PodeRoute -Method Post -Path '/api/config/save' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Access denied. Admin privileges required." }
                return
            }
            
            try {
                # Get the config content from the request body
                $body = $WebEvent.Data
                $configContent = $body.config
                
                if ([string]::IsNullOrWhiteSpace($configContent)) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Configuration content is empty." }
                    return
                }
                
                # Get the config file path
                $scriptRoot = if ($CONFIG.ScriptRoot) { $CONFIG.ScriptRoot } else { $PSScriptRoot }
                $configPath = Join-Path $scriptRoot "NexusM.conf"
                
                # Create a backup of the current config
                $backupPath = Join-Path $scriptRoot "NexusM.conf.backup"
                if (Test-Path $configPath) {
                    Copy-Item -Path $configPath -Destination $backupPath -Force
                    Write-NexusMLog "Created backup of configuration at $backupPath"
                }
                
                # Validate the CSV format before saving
                try {
                    # Try to parse the content as CSV to validate it
                    $testParse = $configContent | ConvertFrom-Csv
                    if (-not $testParse -or $testParse.Count -eq 0) {
                        Write-PodeJsonResponse -Value @{ success = $false; error = "Invalid configuration format. Must be valid CSV with Setting, Value, Description columns." }
                        return
                    }
                    
                    # Check for required columns
                    $firstRow = $testParse[0]
                    if (-not ($firstRow.PSObject.Properties.Name -contains 'Setting' -and $firstRow.PSObject.Properties.Name -contains 'Value')) {
                        Write-PodeJsonResponse -Value @{ success = $false; error = "Configuration must have 'Setting' and 'Value' columns." }
                        return
                    }
                }
                catch {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Invalid CSV format: $($_.Exception.Message)" }
                    return
                }
                
                # Save the new configuration
                $configContent | Out-File -FilePath $configPath -Encoding UTF8 -Force
                
                Write-NexusMLog "Configuration saved by user: $($user.Username)"
                Write-Host "[CONFIG] Configuration saved by admin: $($user.Username)" -ForegroundColor Green
                
                Write-PodeJsonResponse -Value @{ success = $true; message = "Configuration saved successfully. Please restart the application for changes to take effect." }
            }
            catch {
                Write-NexusMLog "Error saving configuration: $($_.Exception.Message)"
                Write-Host "[CONFIG] Error saving configuration: $($_.Exception.Message)" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to save configuration: $($_.Exception.Message)" }
            }
        }
        
        # ----- 3.21 Analysis Page -----
        Add-PodeRoute -Method Get -Path '/analysis' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $html = Get-AnalysisPage
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.22 Rescan Folders (Legacy route - redirects to home) -----
        # The rescan functionality is now handled via JavaScript and the /api/rescan endpoint
        Add-PodeRoute -Method Get -Path '/rescan' -ScriptBlock {
            # Redirect to home page - rescan is now triggered via JavaScript banner notification
            Move-PodeResponseUrl -Url '/'
        }
        
        # ----- 3.22b Rescan API (background scan) -----
        Add-PodeRoute -Method Post -Path '/api/rescan' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            try {
                Write-Host "`n[RESCAN] Starting media scan..." -ForegroundColor Yellow
                Invoke-MediaScan
                Write-Host "[RESCAN] Scan complete!" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true; message = "Scan complete" }
            }
            catch {
                Write-Host "[RESCAN] Error: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.23 Fetch Posters -----
        Add-PodeRoute -Method Get -Path '/fetch-posters' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            Update-AllMoviePosters -Silent
            
            $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>✅ Poster Fetch Complete!</h1><p>Movie posters have been downloaded.</p><p><a href='/'>← Back to Library</a></p></div>" -Title "Posters Downloaded"
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.24a Extract Album Artwork -----
        Add-PodeRoute -Method Get -Path '/extract-artwork' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if ffmpeg is available - check multiple locations
            # 1. Check if Global:FFmpegPath is already set
            # 2. Check in tools folder (typical location)
            # 3. Check in system PATH
            if (-not $Global:FFmpegPath) {
                # Try to find ffmpeg in the tools folder
                $toolsFFmpeg = Join-Path $CONFIG.ToolsFolder "ffmpeg\bin\ffmpeg.exe"
                if (Test-Path $toolsFFmpeg) {
                    $Global:FFmpegPath = $toolsFFmpeg
                    Write-Host "[✓] Found ffmpeg in tools folder: $toolsFFmpeg" -ForegroundColor Green
                }
                else {
                    # Try system PATH
                    $ffmpegInPath = Get-Command ffmpeg -ErrorAction SilentlyContinue
                    if ($ffmpegInPath) {
                        $Global:FFmpegPath = $ffmpegInPath.Source
                        Write-Host "[✓] Found ffmpeg in system PATH: $($ffmpegInPath.Source)" -ForegroundColor Green
                    }
                }
            }
            
            if (-not $Global:FFmpegPath -or -not (Test-Path $Global:FFmpegPath)) {
                $html = Get-HTMLPage -Content @"
<div style='padding:40px; text-align:center;'>
    <h1>⚠️ FFmpeg Required</h1>
    <p style='color: #f59e0b; margin: 20px 0;'>Album artwork extraction requires FFmpeg which is not currently available.</p>
    <p>Expected location: <code style='background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px;'>$($CONFIG.ToolsFolder)\ffmpeg\bin\ffmpeg.exe</code></p>
    <p style='margin-top: 16px;'>Please install FFmpeg and restart the server, or run the extraction from the command line.</p>
    <p style='margin-top: 30px;'><a href='/music' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>← Back to Music</a></p>
</div>
"@ -Title "FFmpeg Required"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            # Get force parameter from query string
            $forceExtract = $WebEvent.Query['force'] -eq '1'
            
            # Run the extraction (silently - no Read-Host prompts)
            try {
                Write-Host "[i] Starting album artwork extraction from web request..." -ForegroundColor Cyan
                Write-NexusMLog "Using ffmpeg at: $($Global:FFmpegPath)"
                
                # Get count before extraction
                $beforeCount = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music WHERE album_art_cached IS NOT NULL AND album_art_cached != ''").count
                
                # Call the extraction function
                Extract-AllAlbumArtwork -Force:$forceExtract
                
                # Get count after extraction
                $afterCount = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music WHERE album_art_cached IS NOT NULL AND album_art_cached != ''").count
                $newArtwork = $afterCount - $beforeCount
                
                $resultMessage = if ($newArtwork -gt 0) {
                    "<p style='color: #34d399;'>Successfully extracted artwork for $newArtwork tracks!</p>"
                } else {
                    "<p>No new artwork was extracted. All tracks may already have artwork.</p>"
                }
                
                $html = Get-HTMLPage -Content @"
<div style='padding:40px; text-align:center;'>
    <h1>✅ Album Artwork Extraction Complete!</h1>
    $resultMessage
    <p style='color: rgba(255,255,255,0.6); margin-top: 10px;'>Total tracks with artwork: $afterCount</p>
    <div style='margin-top: 30px; display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;'>
        <a href='/music' style='display:inline-block; padding:12px 24px; background: linear-gradient(135deg, #34d399, #059669); border-radius:8px; color:white; text-decoration:none; font-weight: 600;'>← Back to Music</a>
        <a href='/extract-artwork?force=1' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>🔄 Force Re-extract All</a>
    </div>
</div>
"@ -Title "Artwork Extracted"
                Write-PodeHtmlResponse -Value $html
            }
            catch {
                Write-Host "[✗] Error during artwork extraction: $_" -ForegroundColor Red
                $html = Get-HTMLPage -Content @"
<div style='padding:40px; text-align:center;'>
    <h1>❌ Extraction Error</h1>
    <p style='color: #ef4444;'>An error occurred during artwork extraction:</p>
    <p style='background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; font-family: monospace; max-width: 600px; margin: 20px auto; word-break: break-all;'>$($_.Exception.Message)</p>
    <p style='margin-top: 30px;'><a href='/music' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>← Back to Music</a></p>
</div>
"@ -Title "Extraction Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.24b Generate PDF/EPUB Thumbnails -----
        Add-PodeRoute -Method Get -Path '/generate-pdf-thumbnails' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check for rendering tools
            $windowsNative = $PSVersionTable.PSVersion.Major -ge 5 -and [Environment]::OSVersion.Version.Major -ge 10
            $gsAvailable = (Get-Command gs -ErrorAction SilentlyContinue) -or (Get-Command gswin64c -ErrorAction SilentlyContinue) -or (Get-Command gswin32c -ErrorAction SilentlyContinue)
            
            if (-not $windowsNative -and -not $gsAvailable) {
                $html = Get-HTMLPage -Content @"
<div style='padding:40px; text-align:center;'>
    <h1>⚠️ eBook Rendering Not Available</h1>
    <p style='color: #f59e0b; margin: 20px 0;'>No eBook rendering capability detected on this system.</p>
    <p>For eBook thumbnail generation, you need one of the following:</p>
    <div style='background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; max-width: 500px; margin: 20px auto; text-align: left;'>
        <p><strong>Option 1: Ghostscript (Recommended)</strong></p>
        <p style='font-family: monospace; color: #34d399;'>winget install Ghostscript.Ghostscript</p>
        <p style='margin-top: 16px;'><strong>Option 2: Windows 10+</strong></p>
        <p style='color: rgba(255,255,255,0.6);'>Native eBook rendering (requires Windows 10 or later)</p>
    </div>
    <p style='margin-top: 30px;'><a href='/pdfs' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>← Back to eBooks</a></p>
</div>
"@ -Title "eBook Rendering Required"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            # Get force parameter from query string
            $forceGenerate = $WebEvent.Query['force'] -eq '1'
            
            # Run the thumbnail generation
            try {
                Write-Host "[i] Starting eBook thumbnail generation from web request..." -ForegroundColor Cyan
                
                # Get count before generation
                $beforeCount = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs WHERE preview_image IS NOT NULL AND preview_image != ''").count
                
                # Call the generation function
                Generate-AllPDFThumbnails -Force:$forceGenerate
                
                # Get count after generation
                $afterCount = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs WHERE preview_image IS NOT NULL AND preview_image != ''").count
                $newThumbnails = $afterCount - $beforeCount
                
                $resultMessage = if ($newThumbnails -gt 0) {
                    "<p style='color: #34d399;'>Successfully generated thumbnails for $newThumbnails PDFs/EPUBs!</p>"
                } else {
                    "<p>No new thumbnails were generated. All documents may already have thumbnails.</p>"
                }
                
                # Detect which renderer was used
                $rendererInfo = if ($gsAvailable) { "Ghostscript" } else { "Windows Native" }
                
                $html = Get-HTMLPage -Content @"
<div style='padding:40px; text-align:center;'>
    <h1>✅ PDF Thumbnail Generation Complete!</h1>
    $resultMessage
    <p style='color: rgba(255,255,255,0.6); margin-top: 10px;'>Total documents with thumbnails: $afterCount</p>
    <p style='color: rgba(255,255,255,0.4); font-size: 12px;'>Renderer used: $rendererInfo</p>
    <div style='margin-top: 30px; display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;'>
        <a href='/pdfs' style='display:inline-block; padding:12px 24px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius:8px; color:white; text-decoration:none; font-weight: 600;'>← Back to PDFs</a>
        <a href='/generate-pdf-thumbnails?force=1' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>🔄 Force Re-generate All</a>
    </div>
</div>
"@ -Title "Thumbnails Generated"
                Write-PodeHtmlResponse -Value $html
            }
            catch {
                Write-Host "[✗] Error during eBook thumbnail generation: $_" -ForegroundColor Red
                $html = Get-HTMLPage -Content @"
<div style='padding:40px; text-align:center;'>
    <h1>❌ Generation Error</h1>
    <p style='color: #ef4444;'>An error occurred during thumbnail generation:</p>
    <p style='background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; font-family: monospace; max-width: 600px; margin: 20px auto; word-break: break-all;'>$($_.Exception.Message)</p>
    <p style='margin-top: 30px;'><a href='/pdfs' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>← Back to PDFs</a></p>
</div>
"@ -Title "Generation Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.24 Refresh Genres -----
        Add-PodeRoute -Method Get -Path '/refresh-genres' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            Update-AllGenres
            
            $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>✅ Genres Refreshed!</h1><p>Movie genres have been updated from TMDB.</p><p><a href='/videos/genres'>View Genres</a> • <a href='/videos'>← Back to Videos</a></p></div>" -Title "Genres Updated"
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.25 Image Route (serve pictures from filesystem) -----
        # Using wildcard route to capture full file paths including drive letters and backslashes
        Add-PodeRoute -Method Get -Path '/image/*' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            # Get the full path after /image/
            $encodedPath = $WebEvent.Path -replace '^/image/', ''
            
            # Replace + with %20 before decoding, so %2B becomes the only +
            try {
                $step1 = $encodedPath -replace '\+', '%20'
                $imagePath = [System.Uri]::UnescapeDataString($step1)
            }
            catch {
                $imagePath = [System.Web.HttpUtility]::UrlDecode($encodedPath)
            }
            
            if ($imagePath -and (Test-Path -LiteralPath $imagePath)) {
                $extension = [System.IO.Path]::GetExtension($imagePath).ToLower()
                
                $contentType = switch ($extension) {
                    '.jpg'  { 'image/jpeg' }
                    '.jpeg' { 'image/jpeg' }
                    '.png'  { 'image/png' }
                    '.gif'  { 'image/gif' }
                    '.bmp'  { 'image/bmp' }
                    '.webp' { 'image/webp' }
                    default { 'image/jpeg' }
                }
                
                Write-PodeFileResponse -Path $imagePath -ContentType $contentType
            }
            else {
                Set-PodeResponseStatus -Code 404
            }
        }
        
        # ----- 3.26 View Image Route (full screen viewer) -----
        Add-PodeRoute -Method Get -Path '/view-image' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $encodedPath = $WebEvent.Query['path']
            
            # Replace + with %20 before decoding, so %2B becomes the only +
            try {
                $step1 = $encodedPath -replace '\+', '%20'
                $imagePath = [System.Uri]::UnescapeDataString($step1)
            }
            catch {
                $imagePath = [System.Web.HttpUtility]::UrlDecode($encodedPath)
            }
            
            if ($imagePath -and (Test-Path -LiteralPath $imagePath)) {
                $filename = [System.IO.Path]::GetFileName($imagePath)
                # Re-encode the path for use in img src
                $reEncodedPath = [System.Web.HttpUtility]::UrlEncode($imagePath)
                $imageContent = @"
<div style='max-width:100%; margin:0; padding:20px; background:#000;'>
  <div style='margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;'>
    <h2 style='margin:0; color:#fff;'>$filename</h2>
    <a href='/pictures' style='color:#60a5fa; text-decoration:none;'>← Back to Pictures</a>
  </div>
  <img src='/image/$reEncodedPath' style='max-width:100%; height:auto; display:block; margin:0 auto; border-radius:8px;' />
</div>
"@
                $html = Get-HTMLPage -Content $imageContent -Title "$filename"
                Write-PodeHtmlResponse -Value $html
            }
            else {
                $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>❌ Image not found</h1><p><a href='/pictures'>← Back to Pictures</a></p></div>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.27 Play Audio Route (music player page) -----
        Add-PodeRoute -Method Get -Path '/play-audio/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $musicId = $WebEvent.Parameters['id']
            $shuffleMode = $false
            
            # Check if shuffle mode
            if ($musicId -eq "shuffle") {
                $shuffleMode = $true
                $maxAttempts = 10
                $attempt = 0
                $foundValidSong = $false
                $music = $null
                
                while (-not $foundValidSong -and $attempt -lt $maxAttempts) {
                    $attempt++
                    $music = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicDB `
                        -Query "SELECT * FROM music ORDER BY RANDOM() LIMIT 1"
                    
                    if ($music -and (Test-Path -LiteralPath $music.filepath)) {
                        $foundValidSong = $true
                    }
                }
                
                if (-not $foundValidSong) {
                    $html = Get-HTMLPage -Content "<h1>No music found</h1><p><a href='/music'>← Back to Music</a></p>" -Title "Error"
                    Write-PodeHtmlResponse -Value $html
                    return
                }
                $musicId = $music.id
            }
            else {
                $music = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicDB `
                    -Query "SELECT * FROM music WHERE id = @id" `
                    -SqlParameters @{ id = $musicId }
            }
            
            if ($music) {
                # Get album artwork URL
                $albumArtUrl = ""
                if ($music.album_art_cached -and -not [string]::IsNullOrWhiteSpace($music.album_art_cached)) {
                    $albumArtUrl = "/albumart/$($music.album_art_cached)"
                }
                elseif ($music.album_art_url -and -not [string]::IsNullOrWhiteSpace($music.album_art_url)) {
                    $albumArtUrl = "/poster/$($music.album_art_url)"
                }
                
                # Backdrop style with music background image (random from 8 backgrounds)
                $musicBackgroundOpacity = 0.3
                $randomBg = Get-Random -Minimum 1 -Maximum 8
                $backdropStyle = "background-image: linear-gradient(to bottom, rgba(10,20,16,$musicBackgroundOpacity), rgba(10,20,16,$musicBackgroundOpacity)), url('/menu/music-$randomBg.jpg');"
                
                # Format artist
                $artistDisplay = if ($music.artist -and -not [string]::IsNullOrWhiteSpace($music.artist) -and $music.artist -notmatch '^[A-Z]:$') {
                    $music.artist
                } else {
                    "Unknown Artist"
                }
                
                # Format album
                $albumDisplay = if ($music.album -and -not [string]::IsNullOrWhiteSpace($music.album)) {
                    $music.album
                } else {
                    "Unknown Album"
                }
                
                $titleDisplay = if ($music.title) { $music.title } else { "Unknown Track" }
                
                # Format duration
                $durationDisplay = if ($music.duration) {
                    $mins = [math]::Floor($music.duration / 60)
                    $secs = $music.duration % 60
                    "${mins}:$("{0:D2}" -f $secs)"
                } else {
                    "Unknown"
                }
                
                # Format file size
                $sizeDisplay = if ($music.size_bytes) {
                    $sizeMB = [math]::Round($music.size_bytes / 1MB, 2)
                    "${sizeMB} MB"
                } else {
                    "Unknown"
                }
                
                # Format bitrate
                $bitrateDisplay = if ($music.bitrate) {
                    "$($music.bitrate) kbps"
                } else {
                    "Unknown"
                }
                
                # Format codec
                $codecDisplay = if ($music.format) {
                    $music.format.ToUpper()
                } else {
                    "Unknown"
                }
                
                # Full music player HTML with styling
                $playerContent = @"
<style>
.music-player-container {
    position: relative;
    min-height: 100vh;
    color: var(--text);
}

.music-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: -1;
    $backdropStyle
}

.music-content-wrapper {
    position: relative;
    z-index: 1;
    padding: 40px;
    max-width: 1200px;
    margin: 0 auto;
}

.music-nav-tabs {
    display: flex;
    background: rgba(20, 20, 30, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 12px 12px 0 0;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    border-bottom: none;
}

.music-nav-tab {
    padding: 16px 32px;
    background: transparent;
    color: rgba(255,255,255,0.7);
    border: none;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    flex: 1;
    text-align: center;
}

.music-nav-tab:hover {
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.9);
}

.music-nav-tab.active {
    background: rgba(255,255,255,0.08);
    color: #fff;
    border-bottom-color: #60a5fa;
}

.music-main-panel {
    background: rgba(20, 20, 30, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 0 0 16px 16px;
    padding: 40px;
    border: 1px solid rgba(255,255,255,0.1);
    border-top: none;
}

.music-layout {
    display: grid;
    grid-template-columns: 300px 1fr;
    gap: 40px;
    align-items: start;
}

.album-art-wrapper {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
}

.album-art {
    width: 100%;
    display: block;
    background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(52,211,153,0.2));
    aspect-ratio: 1;
    object-fit: cover;
}

.music-status-indicator {
    display: inline-block;
    background: rgba(34,197,94,0.15);
    border: 1px solid rgba(34,197,94,0.3);
    color: #4ade80;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 12px;
}

.music-status-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 12px;
    flex-wrap: wrap;
}

.music-status-row .music-status-indicator {
    margin-top: 0;
}

.shuffle-mode-indicator {
    display: inline-block;
    background: rgba(96,165,250,0.15);
    border: 1px solid rgba(96,165,250,0.3);
    color: #60a5fa;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.song-title {
    font-size: 36px;
    font-weight: 700;
    margin: 0 0 12px 0;
    line-height: 1.2;
    color: #fff;
}

.artist-name {
    font-size: 20px;
    color: #60a5fa;
    margin-bottom: 8px;
}

.album-name {
    font-size: 16px;
    color: rgba(255,255,255,0.6);
    margin-bottom: 24px;
}

.audio-player-wrapper {
    margin: 24px 0;
}

.visualizer-container {
    display: flex;
    justify-content: center;
    align-items: flex-end;
    gap: 4px;
    height: 200px;
    margin: 20px 0;
    background: rgba(0,0,0,0.3);
    border-radius: 8px;
    padding: 10px;
    position: relative;
    cursor: pointer;
    overflow: hidden;
}

.visualizer-container:hover {
    background: rgba(0,0,0,0.4);
}

.visualizer-style-indicator {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(96,165,250,0.2);
    color: #60a5fa;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    pointer-events: none;
    z-index: 10;
}

.visualizer-bar {
    width: 6px;
    background: linear-gradient(to top, #06b6d4, #3b82f6, #8b5cf6);
    border-radius: 3px 3px 0 0;
    transition: height 0.1s ease;
}

.visualizer-container.style-rainbow-dots .visualizer-bar {
    width: 8px;
    height: 8px !important;
    border-radius: 50%;
    position: absolute;
    transition: all 0.15s ease;
}

.visualizer-container.style-waveform {
    align-items: center;
}

.visualizer-container.style-waveform .visualizer-bar {
    width: 3px;
    background: linear-gradient(to bottom, #3b82f6, #06b6d4, #3b82f6);
    border-radius: 2px;
    transition: height 0.08s ease;
}

.visualizer-container.style-circular {
    align-items: center;
    justify-content: center;
}

.visualizer-container.style-circular .visualizer-bar {
    position: absolute;
    width: 4px;
    background: linear-gradient(to top, #06b6d4, #8b5cf6);
    border-radius: 2px;
    transform-origin: center bottom;
    transition: height 0.1s ease;
}

.visualizer-container.style-blocks .visualizer-bar {
    width: 12px;
    background: #3b82f6;
    border-radius: 0;
    transition: height 0.12s ease, background-color 0.2s ease;
}

.visualizer-container.style-mirrored {
    align-items: center;
}

.visualizer-container.style-mirrored .visualizer-bar {
    width: 5px;
    background: linear-gradient(to top, #8b5cf6, #06b6d4, #8b5cf6);
    border-radius: 3px;
    transition: height 0.1s ease;
}

.track-info-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
    margin: 24px 0;
}

.info-card {
    background: rgba(96,165,250,0.1);
    border: 1px solid rgba(96,165,250,0.2);
    padding: 16px;
    border-radius: 8px;
}

.info-label {
    color: #60a5fa;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 6px;
}

.info-value {
    color: rgba(255,255,255,0.9);
    font-size: 16px;
    font-weight: 600;
}

.action-buttons {
    display: flex;
    gap: 12px;
    margin-top: 24px;
}

.action-btn {
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.action-btn.secondary {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
}

.action-btn.secondary:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
}

@media (max-width: 1024px) {
    .music-layout {
        grid-template-columns: 1fr;
    }
    .album-art-wrapper {
        max-width: 300px;
        margin: 0 auto;
    }
}

@media (max-width: 768px) {
    .music-content-wrapper {
        padding: 20px;
    }
    .music-main-panel {
        padding: 24px;
    }
    .song-title {
        font-size: 24px;
    }
    .music-nav-tab {
        padding: 12px 16px;
        font-size: 13px;
    }
}
</style>

<div class="music-player-container">
    <div class="music-backdrop"></div>
    
    <div class="music-content-wrapper">
        <div class="music-nav-tabs">
            <button class="music-nav-tab active" onclick="showMusicTab(event, 'overview')">Overview</button>
            <button class="music-nav-tab" onclick="showMusicTab(event, 'album')">Album Information</button>
            <button class="music-nav-tab" onclick="showMusicTab(event, 'artist')">Artist Information</button>
        </div>
        
        <div class="music-main-panel">
            <div id="overview-tab" class="tab-content">
                <div class="music-layout">
                    <div>
                        <div class="album-art-wrapper">
                            $(if ($albumArtUrl) {
                                "<img src='$albumArtUrl' alt='Album Art' class='album-art'>"
                            } else {
                                "<div class='album-art' style='display: flex; align-items: center; justify-content: center; font-size: 64px;'>🎵</div>"
                            })
                        </div>
                        <div class="music-status-row">
                            <span class="music-status-indicator">● MUSIC</span>
                            $(if ($shuffleMode) {
                                "<span class='shuffle-mode-indicator'>🔀 SHUFFLE MODE</span>"
                            })
                        </div>
                    </div>
                    
                    <div>
                        <h1 class="song-title">$titleDisplay</h1>
                        <div class="artist-name">$artistDisplay</div>
                        <div class="album-name">$albumDisplay</div>
                        
                        <div class="visualizer-container" id="visualizer">
                            <!-- Bars created by JavaScript -->
                        </div>
                        
                        <div class="audio-player-wrapper">
                            <audio id="audioPlayer" controls autoplay preload="auto" style="width: 100%; border-radius: 8px;">
                                <source src="/stream-audio/$musicId" type="audio/mpeg">
                            </audio>
                        </div>
                        
                        <div class="track-info-grid">
                            <div class="info-card">
                                <div class="info-label">Duration</div>
                                <div class="info-value">$durationDisplay</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">File Size</div>
                                <div class="info-value">$sizeDisplay</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Bitrate</div>
                                <div class="info-value">$bitrateDisplay</div>
                            </div>
                            <div class="info-card">
                                <div class="info-label">Format</div>
                                <div class="info-value">$codecDisplay</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <a href="/music" class="action-btn secondary">
                                <span>←</span>
                                <span>Back to Music</span>
                            </a>
                            $(if ($shuffleMode) {
                                "<a href='/play-audio/shuffle' class='action-btn secondary'>
                                    <span>⏭</span>
                                    <span>Next Random</span>
                                </a>"
                            } else {
                                "<a href='/play-audio/shuffle' class='action-btn secondary'>
                                    <span>🔀</span>
                                    <span>Shuffle Play</span>
                                </a>"
                            })
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="album-tab" class="tab-content" style="display: none;">
                <div style="max-width: 900px;">
                    <h2 style="font-size: 28px; margin-bottom: 20px; color: #60a5fa;">Album Information</h2>
                    <div style="font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.85); margin-bottom: 24px;">
                        <strong>Album:</strong> $albumDisplay<br>
                        <strong>Artist:</strong> $artistDisplay<br>
                        <strong>Track:</strong> $titleDisplay
                    </div>
                    $(if ($albumArtUrl) {
                        "<img src='$albumArtUrl' alt='Album Art' style='max-width: 400px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.4);'>"
                    })
                </div>
            </div>
            
            <div id="artist-tab" class="tab-content" style="display: none;">
                <div style="max-width: 900px;">
                    <h2 style="font-size: 28px; margin-bottom: 20px; color: #60a5fa;">Artist Information</h2>
                    <div style="font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.85);">
                        <strong>Artist:</strong> $artistDisplay<br>
                        <strong>Current Track:</strong> $titleDisplay<br>
                        <strong>From Album:</strong> $albumDisplay
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showMusicTab(event, tabName) {
    try {
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => tab.style.display = 'none');
        
        const navTabs = document.querySelectorAll('.music-nav-tab');
        navTabs.forEach(tab => tab.classList.remove('active'));
        
        document.getElementById(tabName + '-tab').style.display = 'block';
        event.target.classList.add('active');
    } catch (error) {
        console.error('Error switching tabs:', error);
    }
}

// Visualizer setup with multiple styles
const audio = document.getElementById('audioPlayer');
const visualizer = document.getElementById('visualizer');

// Music tracking data - path is base64 encoded to avoid escaping issues
const trackInfo = {
    path: atob('$([Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($music.filepath)))'),
    artist: '$($artistDisplay -replace "\\", "\\\\" -replace "'", "\'")',
    title: '$($titleDisplay -replace "\\", "\\\\" -replace "'", "\'")',
    album: '$($albumDisplay -replace "\\", "\\\\" -replace "'", "\'")'
};
let musicStartTime = null;

function trackMusicListen(duration) {
    if (duration >= 10 && trackInfo.path) {
        fetch('/api/track/music', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                path: trackInfo.path,
                artist: trackInfo.artist,
                title: trackInfo.title,
                album: trackInfo.album,
                playTime: duration
            })
        }).catch(err => console.error('Music tracking error:', err));
    }
}

const VISUALIZER_STYLES = [
    { name: 'Classic Bars', className: 'style-classic', barCount: 32 },
    { name: 'Rainbow Dots', className: 'style-rainbow-dots', barCount: 40 },
    { name: 'Waveform', className: 'style-waveform', barCount: 60 },
    { name: 'Circular', className: 'style-circular', barCount: 24 },
    { name: 'Blocks', className: 'style-blocks', barCount: 16 },
    { name: 'Mirrored', className: 'style-mirrored', barCount: 28 }
];

let currentStyleIndex = 0;
let bars = [];
let audioContext = null;
let analyser = null;
let dataArray = null;
let source = null;

// Create style indicator
const styleIndicator = document.createElement('div');
styleIndicator.className = 'visualizer-style-indicator';
visualizer.appendChild(styleIndicator);

function createBars(count) {
    bars.forEach(bar => bar.remove());
    bars = [];
    for (let i = 0; i < count; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        bar.style.height = '4px';
        visualizer.appendChild(bar);
        bars.push(bar);
    }
}

function switchVisualizerStyle() {
    currentStyleIndex = (currentStyleIndex + 1) % VISUALIZER_STYLES.length;
    const style = VISUALIZER_STYLES[currentStyleIndex];
    VISUALIZER_STYLES.forEach(s => visualizer.classList.remove(s.className));
    visualizer.classList.add(style.className);
    styleIndicator.textContent = style.name;
    createBars(style.barCount);
}

visualizer.addEventListener('click', function(e) {
    if (e.target === visualizer || e.target.classList.contains('visualizer-bar')) {
        switchVisualizerStyle();
    }
});

switchVisualizerStyle();

function setupAudioAnalyser() {
    try {
        if (!audioContext) {
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (!AudioContextClass) {
                console.warn('AudioContext not supported');
                return;
            }
            
            audioContext = new AudioContextClass();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 128;
            source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            const bufferLength = analyser.frequencyBinCount;
            dataArray = new Uint8Array(bufferLength);
        }
        if (audioContext && audioContext.state === 'suspended') {
            audioContext.resume();
        }
    } catch (error) {
        console.error('Audio analyser setup failed:', error);
        audioContext = null;
        analyser = null;
        dataArray = null;
    }
}

function cleanupAudioContext() {
    if (audioContext && audioContext.state !== 'closed') {
        try {
            audioContext.close();
        } catch (error) {}
    }
}

function animateVisualizer() {
    if (!analyser || !dataArray) {
        requestAnimationFrame(animateVisualizer);
        return;
    }
    analyser.getByteFrequencyData(dataArray);
    const style = VISUALIZER_STYLES[currentStyleIndex];
    switch(style.className) {
        case 'style-classic': animateClassicBars(); break;
        case 'style-rainbow-dots': animateRainbowDots(); break;
        case 'style-waveform': animateWaveform(); break;
        case 'style-circular': animateCircular(); break;
        case 'style-blocks': animateBlocks(); break;
        case 'style-mirrored': animateMirrored(); break;
    }
    requestAnimationFrame(animateVisualizer);
}

function animateClassicBars() {
    for (let i = 0; i < bars.length; i++) {
        const value = dataArray[i] || 0;
        const height = (value / 255) * 100;
        const minHeight = audio.paused ? 2 : 4;
        bars[i].style.height = Math.max(minHeight, height) + '%';
    }
}

function animateRainbowDots() {
    const centerX = visualizer.offsetWidth / 2;
    const centerY = visualizer.offsetHeight / 2;
    const maxRadius = Math.min(centerX, centerY) - 20;
    for (let i = 0; i < bars.length; i++) {
        const value = dataArray[Math.floor(i * dataArray.length / bars.length)] || 0;
        const angle = (i / bars.length) * Math.PI * 2;
        const radius = 20 + (value / 255) * maxRadius;
        const x = centerX + Math.cos(angle) * radius - 4;
        const y = centerY + Math.sin(angle) * radius - 4;
        bars[i].style.left = x + 'px';
        bars[i].style.top = y + 'px';
        const hue = (i / bars.length) * 360;
        bars[i].style.background = 'hsl(' + hue + ', 70%, 60%)';
        bars[i].style.boxShadow = '0 0 ' + (value / 25) + 'px hsl(' + hue + ', 70%, 60%)';
    }
}

function animateWaveform() {
    for (let i = 0; i < bars.length; i++) {
        const value = dataArray[Math.floor(i * dataArray.length / bars.length)] || 0;
        const height = (value / 255) * 80;
        const minHeight = audio.paused ? 2 : 3;
        bars[i].style.height = Math.max(minHeight, height) + '%';
    }
}

function animateCircular() {
    const centerX = visualizer.offsetWidth / 2;
    const centerY = visualizer.offsetHeight / 2;
    const baseRadius = 40;
    for (let i = 0; i < bars.length; i++) {
        const value = dataArray[Math.floor(i * dataArray.length / bars.length)] || 0;
        const angle = (i / bars.length) * Math.PI * 2 - Math.PI / 2;
        const height = 10 + (value / 255) * 80;
        const x = centerX + Math.cos(angle) * baseRadius;
        const y = centerY + Math.sin(angle) * baseRadius;
        bars[i].style.left = x + 'px';
        bars[i].style.top = y + 'px';
        bars[i].style.height = height + 'px';
        bars[i].style.transform = 'rotate(' + (angle + Math.PI / 2) + 'rad)';
    }
}

function animateBlocks() {
    for (let i = 0; i < bars.length; i++) {
        const value = dataArray[Math.floor(i * dataArray.length / bars.length)] || 0;
        const height = (value / 255) * 100;
        const minHeight = audio.paused ? 2 : 4;
        bars[i].style.height = Math.max(minHeight, height) + '%';
        const intensity = Math.floor((value / 255) * 100);
        if (intensity > 70) {
            bars[i].style.background = '#ef4444';
        } else if (intensity > 40) {
            bars[i].style.background = '#eab308';
        } else {
            bars[i].style.background = '#3b82f6';
        }
    }
}

function animateMirrored() {
    for (let i = 0; i < bars.length; i++) {
        const value = dataArray[Math.floor(i * dataArray.length / bars.length)] || 0;
        const height = (value / 255) * 50;
        const minHeight = audio.paused ? 1 : 2;
        bars[i].style.height = Math.max(minHeight, height * 2) + '%';
    }
}

// Audio events
audio.addEventListener('play', function() {
    setupAudioAnalyser();
    if (!musicStartTime) {
        musicStartTime = Date.now();
    }
});

audio.addEventListener('pause', function() {
    // Track partial listen on pause
    if (musicStartTime) {
        var playDuration = (Date.now() - musicStartTime) / 1000;
        trackMusicListen(playDuration);
        musicStartTime = null;
    }
});

// Auto-advance to next random song when current song ends (shuffle mode)
audio.addEventListener('ended', function() {
    // Track the completed song
    if (musicStartTime) {
        var playDuration = (Date.now() - musicStartTime) / 1000;
        // Use sendBeacon for shuffle mode since page will navigate away soon
        // sendBeacon is more reliable than fetch for page transitions
        if ($($shuffleMode.ToString().ToLower()) && playDuration >= 10 && trackInfo.path) {
            navigator.sendBeacon('/api/track/music', JSON.stringify({
                path: trackInfo.path,
                artist: trackInfo.artist,
                title: trackInfo.title,
                album: trackInfo.album,
                playTime: playDuration
            }));
        } else {
            trackMusicListen(playDuration);
        }
        musicStartTime = null;
    }
    if ($($shuffleMode.ToString().ToLower())) {
        setTimeout(function() {
            window.location.href = '/play-audio/shuffle';
        }, 1500);
    }
});

// Auto-play on page load (fallback for browsers that block autoplay attribute)
audio.addEventListener('canplaythrough', function() {
    if (audio.paused) {
        audio.play().catch(function(e) {
            console.log('Autoplay blocked, waiting for user interaction');
        });
    }
}, { once: true });

// Try to play immediately
document.addEventListener('DOMContentLoaded', function() {
    audio.play().catch(function(e) {
        console.log('Autoplay blocked by browser policy');
    });
});

window.addEventListener('beforeunload', function() {
    cleanupAudioContext();
    // Track music on page unload
    if (musicStartTime && trackInfo.path) {
        var playDuration = (Date.now() - musicStartTime) / 1000;
        if (playDuration >= 10) {
            navigator.sendBeacon('/api/track/music', JSON.stringify({
                path: trackInfo.path,
                artist: trackInfo.artist,
                title: trackInfo.title,
                album: trackInfo.album,
                playTime: playDuration
            }));
        }
    }
});

// Start animation loop
animateVisualizer();
</script>
"@
                $html = Get-HTMLPage -Content $playerContent -Title "Playing: $titleDisplay"
                Write-PodeHtmlResponse -Value $html
            }
            else {
                $html = Get-HTMLPage -Content "<h1>Music not found</h1><p><a href='/music'>← Back to Music</a></p>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.28 Stream Audio Route -----
        Add-PodeRoute -Method Get -Path '/stream-audio/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            $musicId = $WebEvent.Parameters['id']
            
            $music = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicDB `
                -Query "SELECT filepath, format, size_bytes FROM music WHERE id = @id" `
                -SqlParameters @{ id = $musicId }
            
            if ($music -and (Test-Path -LiteralPath $music.filepath)) {
                $filePath = $music.filepath
                
                $contentType = switch ($music.format.ToLower()) {
                    'mp3'  { 'audio/mpeg' }
                    'flac' { 'audio/flac' }
                    'wav'  { 'audio/wav' }
                    'm4a'  { 'audio/mp4' }
                    'aac'  { 'audio/aac' }
                    'ogg'  { 'audio/ogg' }
                    'wma'  { 'audio/x-ms-wma' }
                    'opus' { 'audio/opus' }
                    default { 'audio/mpeg' }
                }
                
                # Use shared RFC 7233 compliant streaming function (64KB buffer for audio)
                Send-StreamedFileResponse -WebEvent $WebEvent -FilePath $filePath -ContentType $contentType -BufferSize 65536
            }
            else {
                Set-PodeResponseStatus -Code 404
            }
        }
        
        # ----- 3.29 View PDF Route -----
        Add-PodeRoute -Method Get -Path '/view-pdf' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            $encodedPath = $WebEvent.Query['path']
            
            # Robust URL decoding that handles:
            # - Plus signs as spaces (from form URL encoding)
            # - %2B as literal + character
            # - Unicode characters (like ®, ©, etc.)
            # 
            # The trick: Replace + with %20 BEFORE decoding
            # This way, %2B decodes to + and original + (now %20) decodes to space
            try {
                $step1 = $encodedPath -replace '\+', '%20'
                $pdfPath = [System.Uri]::UnescapeDataString($step1)
            }
            catch {
                # Fallback: Use HttpUtility which handles + as space natively
                $pdfPath = [System.Web.HttpUtility]::UrlDecode($encodedPath)
            }
            
            if ($pdfPath -and (Test-Path -LiteralPath $pdfPath)) {
                Write-PodeFileResponse -Path $pdfPath -ContentType 'application/pdf'
            }
            else {
                # Return a proper 404 page with the decoded path for debugging
                Write-PodeHtmlResponse -Value "<html><body><h1>404 - File Not Found</h1><p>Path: $([System.Web.HttpUtility]::HtmlEncode($pdfPath))</p><p><a href='/pdfs'>Back to PDFs</a></p></body></html>" -StatusCode 404
            }
        }
        
        # ----- 3.30 Read EPUB Route -----
        Add-PodeRoute -Method Get -Path '/read-epub' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $encodedPath = $WebEvent.Query['path']
            
            # Replace + with %20 before decoding, so %2B becomes the only +
            try {
                $step1 = $encodedPath -replace '\+', '%20'
                $epubPath = [System.Uri]::UnescapeDataString($step1)
            }
            catch {
                $epubPath = [System.Web.HttpUtility]::UrlDecode($encodedPath)
            }
            
            if ($epubPath -and (Test-Path -LiteralPath $epubPath)) {
                $epubTitle = [System.IO.Path]::GetFileNameWithoutExtension($epubPath)
                $encodedForReader = [System.Web.HttpUtility]::UrlEncode($epubPath)
                
                $readerHtml = @"
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>$epubTitle</title>
    <script src="/epubjs/jszip.min.js"></script>
    <script src="/epubjs/epub.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #1a1a1a; color: #fff; }
        #toolbar { background: rgba(30, 30, 30, 0.95); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); }
        #book-title { font-size: 16px; font-weight: 600; max-width: 40%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .toolbar-controls { display: flex; align-items: center; gap: 12px; }
        .btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; }
        .btn:hover { background: rgba(255, 255, 255, 0.2); }
        .page-jump { display: flex; align-items: center; gap: 6px; background: rgba(255,255,255,0.05); padding: 4px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); }
        .page-jump input { width: 60px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 6px 8px; border-radius: 6px; font-size: 14px; text-align: center; }
        .page-jump input:focus { outline: none; border-color: #6366f1; }
        .page-jump span { color: rgba(255,255,255,0.7); font-size: 13px; }
        .page-jump .go-btn { padding: 6px 12px; background: #6366f1; border-color: #6366f1; }
        .page-jump .go-btn:hover { background: #4f46e5; }
        #page-info { color: rgba(255,255,255,0.6); font-size: 13px; min-width: 100px; text-align: center; }
        #viewer { width: 100%; height: calc(100vh - 60px); background: #fff; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 100; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-top: 4px solid #6366f1; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #generating-pages { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(99, 102, 241, 0.9); padding: 10px 20px; border-radius: 8px; font-size: 13px; display: none; z-index: 100; }
    </style>
</head>
<body>
    <div id="toolbar">
        <div id="book-title">$epubTitle</div>
        <div class="toolbar-controls">
            <button class="btn" onclick="goPrev()">← Prev</button>
            <button class="btn" onclick="goNext()">Next →</button>
            <div class="page-jump">
                <input type="number" id="pageInput" min="1" placeholder="Page" onkeydown="if(event.key==='Enter')goToPage()">
                <span id="page-info">-- / --</span>
                <button class="btn go-btn" onclick="goToPage()">Go</button>
            </div>
            <button class="btn" onclick="window.location.href='/pdfs'">✕ Close</button>
        </div>
    </div>
    <div id="loading"><div class="spinner"></div><div>Loading...</div></div>
    <div id="generating-pages">Generating page locations...</div>
    <div id="viewer"></div>
    <script>
        let book, rendition;
        let currentPage = 0;
        let totalPages = 0;
        let locationsReady = false;
        
        function updatePageInfo() {
            const pageInfo = document.getElementById('page-info');
            const pageInput = document.getElementById('pageInput');
            if (locationsReady && totalPages > 0) {
                pageInfo.textContent = currentPage + ' / ' + totalPages;
                pageInput.max = totalPages;
                pageInput.placeholder = currentPage;
            } else {
                pageInfo.textContent = '-- / --';
            }
        }
        
        function goPrev() {
            if (rendition) rendition.prev();
        }
        
        function goNext() {
            if (rendition) rendition.next();
        }
        
        function goToPage() {
            if (!locationsReady || !book || !rendition) {
                alert('Page locations are still being generated. Please wait...');
                return;
            }
            const pageInput = document.getElementById('pageInput');
            const targetPage = parseInt(pageInput.value);
            if (isNaN(targetPage) || targetPage < 1 || targetPage > totalPages) {
                alert('Please enter a valid page number between 1 and ' + totalPages);
                return;
            }
            // Get CFI for target page and navigate
            const cfi = book.locations.cfiFromLocation(targetPage - 1);
            if (cfi) {
                rendition.display(cfi);
            }
            pageInput.value = '';
        }
        
        async function initReader() {
            try {
                const res = await fetch('/serve-epub?path=$encodedForReader');
                const arrayBuffer = await res.arrayBuffer();
                book = ePub(arrayBuffer, { openAs: "binary" });
                rendition = book.renderTo('viewer', { width: '100%', height: '100%', spread: 'none' });
                
                // Track location changes to update page number
                rendition.on('relocated', function(location) {
                    if (locationsReady && location.start) {
                        currentPage = book.locations.locationFromCfi(location.start.cfi) + 1;
                        updatePageInfo();
                    }
                });
                
                await rendition.display();
                document.getElementById('loading').style.display = 'none';
                
                // Generate locations for page navigation (runs in background)
                document.getElementById('generating-pages').style.display = 'block';
                await book.locations.generate(1024); // ~1024 chars per page
                totalPages = book.locations.total;
                locationsReady = true;
                document.getElementById('generating-pages').style.display = 'none';
                
                // Get initial page
                const currentLocation = rendition.currentLocation();
                if (currentLocation && currentLocation.start) {
                    currentPage = book.locations.locationFromCfi(currentLocation.start.cfi) + 1;
                } else {
                    currentPage = 1;
                }
                updatePageInfo();
                
            } catch (err) {
                document.getElementById('loading').innerHTML = '<div style="color:#f87171;">Error loading EPUB: ' + err.message + '</div>';
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT') return; // Don't capture when typing in input
            if (e.key === 'ArrowLeft') goPrev();
            if (e.key === 'ArrowRight') goNext();
        });
        
        initReader();
    </script>
</body>
</html>
"@
                Write-PodeHtmlResponse -Value $readerHtml
            }
            else {
                $html = Get-HTMLPage -Content "<h1>EPUB not found</h1><p><a href='/pdfs'>← Back to PDFs</a></p>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.31 Serve EPUB Route (for epub.js reader) -----
        Add-PodeRoute -Method Get -Path '/serve-epub' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            $encodedPath = $WebEvent.Query['path']
            
            # Replace + with %20 before decoding, so %2B becomes the only +
            try {
                $step1 = $encodedPath -replace '\+', '%20'
                $epubPath = [System.Uri]::UnescapeDataString($step1)
            }
            catch {
                $epubPath = [System.Web.HttpUtility]::UrlDecode($encodedPath)
            }
            
            if ($epubPath -and (Test-Path -LiteralPath $epubPath)) {
                Set-PodeHeader -Name 'Access-Control-Allow-Origin' -Value '*'
                Write-PodeFileResponse -Path $epubPath -ContentType 'application/epub+zip'
            }
            else {
                Set-PodeResponseStatus -Code 404
            }
        }
        
        # ----- 3.32 Search Route -----
        Add-PodeRoute -Method Get -Path '/search' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $searchQuery = $WebEvent.Query['q']
            $searchType = $WebEvent.Query['type']
            
            $html = Get-SearchPage -Query $searchQuery -Type $searchType
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.33 Movie Details Route -----
        Add-PodeRoute -Method Get -Path '/movie/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $videoId = $WebEvent.Parameters['id']
            
            $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                -Query "SELECT * FROM videos WHERE id = @id" `
                -SqlParameters @{ id = $videoId }
            
            if ($video) {
                $size = [math]::Round($video.size_bytes / 1GB, 2)
                
                # Format rating as stars (out of 10)
                $ratingStars = ""
                $ratingScore = ""
                if ($video.rating) {
                    $rating = [math]::Round($video.rating, 1)
                    $fullStars = [math]::Floor($rating)
                    
                    for ($i = 1; $i -le $fullStars; $i++) {
                        $ratingStars += "★"
                    }
                    for ($i = ($fullStars + 1); $i -le 10; $i++) {
                        $ratingStars += "☆"
                    }
                    $ratingStars = $ratingStars.Substring(0, [math]::Min(10, $ratingStars.Length))
                    $ratingScore = "$rating"
                } else {
                    $ratingStars = "No rating available"
                    $ratingScore = ""
                }
                
                # Format runtime
                $runtimeDisplay = if ($video.runtime) {
                    "$($video.runtime) min"
                } elseif ($video.duration) {
                    $mins = [math]::Floor($video.duration / 60)
                    "${mins} min"
                } else {
                    "Unknown"
                }
                
                # Format year
                $yearDisplay = if ($video.year) { $video.year } else { "Unknown" }
                
                # Format genres
                $genreDisplay = if ($video.genre) { $video.genre } else { "Unknown" }
                
                # Format director
                $directorDisplay = if ($video.director -and -not [string]::IsNullOrWhiteSpace($video.director)) {
                    $video.director
                } else {
                    "Unknown"
                }
                
                # Format actors
                $actorsDisplay = if ($video.cast -and -not [string]::IsNullOrWhiteSpace($video.cast)) {
                    $video.cast
                } else {
                    "Not available - fetch metadata from TMDB to populate cast information"
                }
                
                # Poster URL
                $posterUrl = if ($video.poster_url) {
                    "/poster/$($video.poster_url)"
                } else {
                    ""
                }
                
                # Backdrop for background
                $backdropStyle = if ($video.backdrop_url) {
                    "background-image: linear-gradient(to right, rgba(10,20,16,0.75) 0%, rgba(10,20,16,0.65) 50%, rgba(10,20,16,0.55) 100%), url('/poster/$($video.backdrop_url)');"
                } elseif ($video.poster_url) {
                    "background-image: linear-gradient(to right, rgba(10,20,16,0.95) 0%, rgba(10,20,16,0.85) 50%, rgba(10,20,16,0.7) 100%), url('/poster/$($video.poster_url)');"
                } else {
                    "background: linear-gradient(135deg, rgba(52,211,153,0.1), rgba(34,197,94,0.05));"
                }
                
                # Overview/Description
                $overviewText = if ($video.overview -and -not [string]::IsNullOrWhiteSpace($video.overview)) {
                    $video.overview
                } elseif ($video.description -and -not [string]::IsNullOrWhiteSpace($video.description)) {
                    $video.description
                } else {
                    "No description available. Fetch metadata from TMDB to populate the movie synopsis and details."
                }
                
                # Format resolution badge
                $resolutionBadge = if ($video.resolution) {
                    $video.resolution.ToUpper()
                } else {
                    "1080"
                }
                
                # Audio codec
                $audioCodec = if ($video.audio_codec) {
                    $video.audio_codec.ToUpper()
                } else {
                    "H.264"
                }
                
                # Age rating
                $ageRating = "12"
                
                # Format file size
                $fileSizeDisplay = "${size}"
                
                # Parse audio tracks from database
                $languagesDisplay = "Unknown"
                $audioTrackBadges = ""
                
                if ($video.audio_tracks -and -not [string]::IsNullOrWhiteSpace($video.audio_tracks)) {
                    try {
                        $audioTracks = $video.audio_tracks | ConvertFrom-Json
                        if ($audioTracks) {
                            $languages = @()
                            foreach ($track in $audioTracks) {
                                $lang = if ($track.language -and $track.language -ne "und") { 
                                    $track.language.ToUpper() 
                                } else { 
                                    "Unknown" 
                                }
                                if ($languages -notcontains $lang) {
                                    $languages += $lang
                                }
                            }
                            $languagesDisplay = $languages -join ", "
                            
                            foreach ($track in $audioTracks) {
                                $lang = if ($track.language -and $track.language -ne "und") { 
                                    $track.language.ToUpper() 
                                } else { 
                                    "UNK" 
                                }
                                $channels = if ($track.channels) { 
                                    switch ($track.channels) {
                                        1 { "Mono" }
                                        2 { "Stereo" }
                                        6 { "5.1" }
                                        8 { "7.1" }
                                        default { "$($track.channels)ch" }
                                    }
                                } else { 
                                    "" 
                                }
                                $audioTrackBadges += "<span style='display:inline-block; padding:6px 12px; background:rgba(96,165,250,.15); border:1px solid rgba(96,165,250,.3); border-radius:6px; font-size:12px; font-weight:600; margin-right:6px; margin-top:4px;'>🔊 $lang $channels</span>"
                            }
                        }
                    }
                    catch {
                        Write-Verbose "Could not parse audio tracks: $_"
                    }
                }
                
                # Subtitles
                $subtitlesDisplay = "Not available"
                
                $movieContent = @"
<style>
.movie-info-container {
    position: relative;
    min-height: 100vh;
    color: var(--text);
}

.movie-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    z-index: -1;
    $backdropStyle
}

.movie-backdrop::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 0%, rgba(10,20,16,0.5) 50%, var(--bg) 100%);
    z-index: 1;
}

.movie-content-wrapper {
    position: relative;
    z-index: 1;
    padding: 40px;
    max-width: 1400px;
    margin: 0 auto;
}

.movie-nav-tabs {
    display: flex;
    background: rgba(20, 20, 30, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 12px 12px 0 0;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.1);
    border-bottom: none;
}

.nav-tab {
    padding: 16px 32px;
    background: transparent;
    color: rgba(255,255,255,0.7);
    border: none;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
    border-bottom: 3px solid transparent;
    flex: 1;
    text-align: center;
}

.nav-tab:hover {
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.9);
}

.nav-tab.active {
    background: rgba(255,255,255,0.08);
    color: #fff;
    border-bottom-color: #60a5fa;
}

.movie-main-panel {
    background: rgba(20, 20, 30, 0.85);
    backdrop-filter: blur(20px);
    border-radius: 0 0 16px 16px;
    padding: 40px;
    border: 1px solid rgba(255,255,255,0.1);
    border-top: none;
}

.movie-layout {
    display: grid;
    grid-template-columns: 500px 1fr;
    gap: 40px;
    align-items: start;
}

.movie-poster-wrapper {
    position: relative;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0,0,0,0.6);
    transition: transform 0.3s ease;
    cursor: pointer;
}

.movie-poster-wrapper:hover {
    transform: scale(1.02);
}

.movie-poster {
    width: 100%;
    display: block;
    background: rgba(255,255,255,0.05);
    aspect-ratio: 16/9;
    object-fit: cover;
    border-radius: 8px;
}

.play-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80px;
    height: 80px;
    background: rgba(96,165,250,0.9);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    opacity: 0;
}

.movie-poster-wrapper:hover .play-overlay {
    opacity: 1;
}

.play-overlay:hover {
    background: #60a5fa;
    transform: translate(-50%, -50%) scale(1.1);
}

.play-icon {
    color: white;
    font-size: 32px;
    margin-left: 4px;
}

.movie-status-indicators {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.status-indicator {
    background: rgba(34,197,94,0.15);
    border: 1px solid rgba(34,197,94,0.3);
    color: #4ade80;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.movie-title {
    font-size: 42px;
    font-weight: 700;
    margin: 0 0 16px 0;
    line-height: 1.2;
    color: #fff;
    text-shadow: 2px 2px 12px rgba(0,0,0,0.8);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-break: break-word;
}

.movie-metadata-row {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 16px;
}

.metadata-item {
    color: rgba(255,255,255,0.8);
    font-size: 15px;
}

.metadata-label {
    color: #60a5fa;
    font-weight: 600;
}

.metadata-separator {
    color: rgba(255,255,255,0.3);
}

.movie-description {
    line-height: 1.8;
    color: rgba(255,255,255,0.85);
    font-size: 15px;
    margin: 20px 0;
}

.rating-section {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 20px 0;
}

.rating-stars {
    color: #fbbf24;
    font-size: 18px;
    letter-spacing: 2px;
}

.rating-score {
    background: rgba(251,191,36,0.15);
    border: 1px solid rgba(251,191,36,0.3);
    color: #fbbf24;
    padding: 6px 14px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 700;
}

.tech-specs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 12px;
    margin: 20px 0;
}

.tech-spec {
    background: rgba(96,165,250,0.1);
    border: 1px solid rgba(96,165,250,0.2);
    padding: 12px;
    border-radius: 8px;
    text-align: center;
}

.spec-icon {
    font-size: 24px;
    margin-bottom: 8px;
}

.spec-value {
    font-size: 16px;
    font-weight: 700;
    color: #60a5fa;
    margin-bottom: 4px;
}

.spec-label {
    font-size: 11px;
    color: rgba(255,255,255,0.6);
    text-transform: uppercase;
}

.action-buttons {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 24px;
}

.action-btn {
    padding: 14px 28px;
    border-radius: 10px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 10px;
}

.action-btn.primary {
    background: #60a5fa;
    color: #fff;
}

.action-btn.primary:hover {
    background: #3b82f6;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(96,165,250,0.4);
}

.action-btn.secondary {
    background: rgba(255,255,255,0.1);
    color: #fff;
    border: 1px solid rgba(255,255,255,0.2);
}

.action-btn.secondary:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
}

.info-label {
    color: #60a5fa;
    font-size: 13px;
    font-weight: 600;
}

.info-value {
    color: rgba(255,255,255,0.9);
}

@media (max-width: 1024px) {
    .movie-layout {
        grid-template-columns: 1fr;
    }
    .movie-poster-wrapper {
        max-width: 300px;
        margin: 0 auto;
    }
}

@media (max-width: 768px) {
    .movie-content-wrapper {
        padding: 20px;
    }
    .movie-main-panel {
        padding: 24px;
    }
    .movie-title {
        font-size: 28px;
    }
    .nav-tab {
        padding: 12px 16px;
        font-size: 13px;
    }
}
</style>

<div class="movie-info-container">
    <div class="movie-backdrop"></div>
    
    <div class="movie-content-wrapper">
        <div class="movie-nav-tabs">
            <button class="nav-tab active" onclick="showTab(event, 'overview')">Overview/Start</button>
            <button class="nav-tab" onclick="showTab(event, 'description')">Description</button>
            <button class="nav-tab" onclick="showTab(event, 'actors')">Actors</button>
        </div>
        
        <div class="movie-main-panel">
            <div id="overview-tab" class="tab-content">
                <div class="movie-layout">
                    <div class="movie-poster-section">
                        <div class="movie-poster-wrapper" onclick="window.location.href='/player/$videoId'">
                            $(if ($video.backdrop_url) {
                                "<img src='/poster/$($video.backdrop_url)' alt='$([System.Web.HttpUtility]::HtmlEncode($video.title))' class='movie-poster' style='opacity: 0.85;'>"
                            } elseif ($posterUrl) {
                                "<img src='$posterUrl' alt='$([System.Web.HttpUtility]::HtmlEncode($video.title))' class='movie-poster'>"
                            } else {
                                "<div class='movie-poster' style='background: linear-gradient(135deg, rgba(96,165,250,0.2), rgba(52,211,153,0.2)); display: flex; align-items: center; justify-content: center; font-size: 48px;'>🎬</div>"
                            })
                            <div class="play-overlay">
                                <span class="play-icon">▶</span>
                            </div>
                        </div>
                        <div class="movie-status-indicators">
                            <span class="status-indicator">● MOVIE</span>
                        </div>
                    </div>
                    
                    <div class="movie-details-section">
                        <h1 class="movie-title">$([System.Web.HttpUtility]::HtmlEncode($video.title))</h1>
                        
                        <div class="movie-metadata-row">
                            <span class="metadata-item"><span class="metadata-label">Release date</span> $yearDisplay</span>
                            <span class="metadata-separator">|</span>
                            <span class="metadata-item"><span class="metadata-label">Running Time</span> $runtimeDisplay</span>
                        </div>
                        
                        <div class="movie-metadata-row">
                            <span class="metadata-item"><span class="metadata-label">Genre</span> $genreDisplay</span>
                            <span class="metadata-separator">|</span>
                            <span class="metadata-item"><span class="metadata-label">Director</span> $directorDisplay</span>
                        </div>
                        
                        <div class="movie-metadata-row">
                            <span class="metadata-item"><span class="metadata-label">Actors</span> $actorsDisplay</span>
                        </div>
                        
                        <div class="movie-description">
                            $([System.Web.HttpUtility]::HtmlEncode($overviewText))
                        </div>
                        
                        <div class="rating-section">
                            <span class="rating-stars">$ratingStars</span>
                            $(if ($ratingScore) { "<span class='rating-score'>$ratingScore</span>" })
                        </div>
                        
                        <div class="tech-specs-grid">
                            <div class="tech-spec">
                                <div class="spec-icon">$ageRating</div>
                                <div class="spec-value">$ageRating</div>
                                <div class="spec-label">Age Rating</div>
                            </div>
                            <div class="tech-spec">
                                <div class="spec-icon">🎬</div>
                                <div class="spec-value">$resolutionBadge</div>
                                <div class="spec-label">Quality</div>
                            </div>
                            <div class="tech-spec">
                                <div class="spec-icon">🔊</div>
                                <div class="spec-value">$audioCodec</div>
                                <div class="spec-label">Audio</div>
                            </div>
                            <div class="tech-spec">
                                <div class="spec-icon">💾</div>
                                <div class="spec-value">$fileSizeDisplay</div>
                                <div class="spec-label">File Size</div>
                            </div>
                        </div>
                        
                        <div style="margin: 20px 0; padding: 16px; background: rgba(96,165,250,0.08); border: 1px solid rgba(96,165,250,0.15); border-radius: 10px;">
                            <div style="margin-bottom: 8px;">
                                <span class="info-label">Audio Tracks:</span> <span class="info-value">$languagesDisplay</span>
                                $(if ($audioTrackBadges) { "<div style='margin-top:8px;'>$audioTrackBadges</div>" })
                            </div>
                            <div>
                                <span class="info-label">Subtitles:</span> <span class="info-value">$subtitlesDisplay</span>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <a href="/player/$videoId" class="action-btn primary" id="playBtn">
                                <span style="font-size: 18px;">▶</span>
                                <span id="playBtnText">Resume</span>
                            </a>
                            <button onclick="toggleWatched()" class="action-btn" id="watchedBtn" style="background: rgba(139,92,246,0.2); color: #a78bfa; border: 1px solid rgba(139,92,246,0.3);">
                                <span id="watchedIcon">👁</span>
                                <span id="watchedText">Mark as Watched</span>
                            </button>
                            <button onclick="openEditModal()" class="action-btn" style="background: #10b981; color: #fff;">
                                <span>✏️</span>
                                <span>Edit Metadata</span>
                            </button>
                            <a href="/stream/$videoId" download="$([System.Web.HttpUtility]::HtmlAttributeEncode($video.filename))" class="action-btn secondary">
                                <span>⬇</span>
                                <span>Download</span>
                            </a>
                            <a href="/videos" class="action-btn secondary">
                                <span>←</span>
                                <span>Back to Library</span>
                            </a>
                        </div>
                        
                        <div id="progressInfo" style="display: none; margin-top: 16px; padding: 12px 16px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); border-radius: 8px;">
                            <span style="color: #f87171;">▶ Resume from </span>
                            <span id="progressTime" style="color: #fff; font-weight: 600;"></span>
                            <span style="color: rgba(255,255,255,0.5);"> (<span id="progressPercent"></span>% watched)</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="description-tab" class="tab-content" style="display: none;">
                <div style="max-width: 900px;">
                    <h2 style="font-size: 28px; margin-bottom: 20px; color: #60a5fa;">Description</h2>
                    <div style="font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.85);">
                        $([System.Web.HttpUtility]::HtmlEncode($overviewText))
                    </div>
                    
                    <div style="margin-top: 40px;">
                        <h3 style="font-size: 20px; margin-bottom: 16px; color: #60a5fa;">Movie Details</h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                            <div>
                                <div class="info-label">Director</div>
                                <div class="info-value">$directorDisplay</div>
                            </div>
                            <div>
                                <div class="info-label">Year</div>
                                <div class="info-value">$yearDisplay</div>
                            </div>
                            <div>
                                <div class="info-label">Genre</div>
                                <div class="info-value">$genreDisplay</div>
                            </div>
                            <div>
                                <div class="info-label">Runtime</div>
                                <div class="info-value">$runtimeDisplay</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="actors-tab" class="tab-content" style="display: none;">
                <div style="max-width: 900px;">
                    <h2 style="font-size: 28px; margin-bottom: 20px; color: #60a5fa;">Cast</h2>
                    <div style="font-size: 16px; line-height: 1.8; color: rgba(255,255,255,0.85);">
                        $actorsDisplay
                    </div>
                    <div style="margin-top: 20px; padding: 16px; background: rgba(96,165,250,0.08); border: 1px solid rgba(96,165,250,0.15); border-radius: 10px; color: rgba(255,255,255,0.7);">
                        <em>Tip: Fetch metadata from TMDB using "Fetch Posters" in the Videos section to populate complete cast information.</em>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function showTab(event, tabName) {
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.style.display = 'none');
    
    const navTabs = document.querySelectorAll('.nav-tab');
    navTabs.forEach(tab => tab.classList.remove('active'));
    
    document.getElementById(tabName + '-tab').style.display = 'block';
    event.target.classList.add('active');
}

function openEditModal() {
    document.getElementById('editModal').style.display = 'flex';
    
    const posterInput = document.getElementById('edit_poster');
    if (posterInput) posterInput.addEventListener('change', handlePosterUpload);
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
}

let posterImageData = null;

function handlePosterUpload(event) {
    const file = event.target.files[0];
    const errorDiv = document.getElementById('posterError');
    const previewDiv = document.getElementById('posterPreview');
    const previewImg = document.getElementById('posterPreviewImg');
    const dimensionsDiv = document.getElementById('posterDimensions');
    
    if (errorDiv) errorDiv.style.display = 'none';
    if (previewDiv) previewDiv.style.display = 'none';
    posterImageData = null;
    
    if (!file) return;
    
    if (!file.type.match(/image\/(jpeg|jpg|png)/)) {
        if (errorDiv) {
            errorDiv.textContent = 'Invalid file type. Please upload a JPG or PNG image.';
            errorDiv.style.display = 'block';
        }
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
            const width = img.width;
            const height = img.height;
            
            if (width < 500 || height < 750) {
                if (errorDiv) {
                    errorDiv.textContent = 'Image too small! Minimum size is 500x750px. Your image is ' + width + 'x' + height + 'px.';
                    errorDiv.style.display = 'block';
                }
                event.target.value = '';
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = 500;
            canvas.height = 750;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, 500, 750);
            posterImageData = canvas.toDataURL('image/jpeg', 0.9);
            
            if (previewImg) previewImg.src = posterImageData;
            if (dimensionsDiv) dimensionsDiv.textContent = 'Original: ' + width + 'x' + height + 'px → Resized to: 500x750px';
            if (previewDiv) previewDiv.style.display = 'block';
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function saveMetadata() {
    const formData = {
        id: $videoId,
        title: document.getElementById('edit_title')?.value || '',
        year: document.getElementById('edit_year')?.value || '',
        genre: document.getElementById('edit_genre')?.value || '',
        director: document.getElementById('edit_director')?.value || '',
        cast: document.getElementById('edit_cast')?.value || '',
        runtime: document.getElementById('edit_runtime')?.value || '',
        rating: document.getElementById('edit_rating')?.value || '',
        overview: document.getElementById('edit_overview')?.value || '',
        posterImage: posterImageData
    };
    
    fetch('/api/update-movie', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Metadata updated successfully!');
            location.reload();
        } else {
            alert('Error updating metadata: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    });
}

var videoId = $videoId;
var isWatched = false;
var savedPosition = 0;

function formatTime(seconds) {
    var hrs = Math.floor(seconds / 3600);
    var mins = Math.floor((seconds % 3600) / 60);
    var secs = Math.floor(seconds % 60);
    if (hrs > 0) {
        return hrs + ':' + String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    }
    return mins + ':' + String(secs).padStart(2, '0');
}

function checkProgress() {
    fetch('/api/video/get-progress?id=' + videoId)
        .then(r => r.json())
        .then(data => {
            if (data.success && data.position > 0) {
                savedPosition = data.position;
                document.getElementById('playBtnText').textContent = 'Resume';
                document.getElementById('playBtn').href = '/player/' + videoId + '?resume=1';
                document.getElementById('progressInfo').style.display = 'block';
                document.getElementById('progressTime').textContent = formatTime(data.position);
                document.getElementById('progressPercent').textContent = Math.round(data.percent || 0);
                
                if (data.completed) {
                    updateWatchedUI(true);
                }
            }
            if (data.completed) {
                updateWatchedUI(true);
            }
        })
        .catch(function() {});
}

function updateWatchedUI(watched) {
    isWatched = watched;
    var btn = document.getElementById('watchedBtn');
    var icon = document.getElementById('watchedIcon');
    var text = document.getElementById('watchedText');
    
    if (watched) {
        btn.style.background = 'rgba(34,197,94,0.2)';
        btn.style.color = '#22c55e';
        btn.style.borderColor = 'rgba(34,197,94,0.3)';
        icon.textContent = '✓';
        text.textContent = 'Watched';
    } else {
        btn.style.background = 'rgba(139,92,246,0.2)';
        btn.style.color = '#a78bfa';
        btn.style.borderColor = 'rgba(139,92,246,0.3)';
        icon.textContent = '👁';
        text.textContent = 'Mark as Watched';
    }
}

function toggleWatched() {
    var newStatus = !isWatched;
    
    fetch('/api/video/mark-watched', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ videoId: videoId, watched: newStatus })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            updateWatchedUI(data.watched);
            if (data.watched) {
                document.getElementById('progressInfo').style.display = 'none';
                document.getElementById('playBtnText').textContent = 'Play Movie';
                document.getElementById('playBtn').href = '/player/' + videoId;
            }
        } else {
            alert(data.error || 'Failed to update');
        }
    })
    .catch(function() {
        alert('Error updating watched status');
    });
}

document.addEventListener('DOMContentLoaded', checkProgress);
</script>

<!-- Edit Modal -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; padding:20px; overflow-y:auto;">
    <div style="background:rgba(20,30,26,0.98); border:1px solid rgba(255,255,255,0.1); border-radius:16px; max-width:700px; width:100%; padding:32px; position:relative; margin:auto;">
        <button onclick="closeEditModal()" style="position:absolute; top:16px; right:16px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:#fff; width:36px; height:36px; border-radius:8px; cursor:pointer; font-size:20px; line-height:1;">×</button>
        
        <h2 style="color:#60a5fa; margin-bottom:24px; font-size:28px;">Edit Movie Metadata</h2>
        
        <div style="display:grid; gap:16px;">
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Title</label>
                <input type="text" id="edit_title" value="$([System.Web.HttpUtility]::HtmlAttributeEncode($video.title))" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                    <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Year</label>
                    <input type="number" id="edit_year" value="$($video.year)" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
                </div>
                <div>
                    <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Runtime (minutes)</label>
                    <input type="number" id="edit_runtime" value="$($video.runtime)" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
                </div>
            </div>
            
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Genre</label>
                <input type="text" id="edit_genre" value="$([System.Web.HttpUtility]::HtmlAttributeEncode($video.genre))" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
            </div>
            
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Director</label>
                <input type="text" id="edit_director" value="$([System.Web.HttpUtility]::HtmlAttributeEncode($video.director))" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
            </div>
            
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Cast / Actors</label>
                <input type="text" id="edit_cast" value="$([System.Web.HttpUtility]::HtmlAttributeEncode($video.cast))" placeholder="Comma-separated list of actor names" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
            </div>
            
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Rating (0-10)</label>
                <input type="number" step="0.1" min="0" max="10" id="edit_rating" value="$($video.rating)" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
            </div>
            
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Overview / Description</label>
                <textarea id="edit_overview" rows="6" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px; resize:vertical; font-family:inherit;">$([System.Web.HttpUtility]::HtmlEncode($video.overview))</textarea>
            </div>
            
            <div>
                <label style="display:block; color:#60a5fa; font-size:13px; font-weight:600; margin-bottom:6px;">Poster Image</label>
                <div style="display:flex; gap:12px; align-items:end;">
                    <div style="flex:1;">
                        <input type="file" id="edit_poster" accept="image/jpeg,image/jpg,image/png" style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:#fff; font-size:15px;">
                        <div style="margin-top:6px; font-size:12px; color:rgba(255,255,255,0.6);">
                            Required: Min 500x750px • Will be resized to 500x750px if larger • JPG/PNG only
                        </div>
                    </div>
                </div>
                <div id="posterPreview" style="margin-top:12px; display:none;">
                    <img id="posterPreviewImg" style="max-width:150px; border-radius:8px; border:2px solid rgba(96,165,250,0.3);">
                    <div id="posterDimensions" style="margin-top:6px; font-size:13px; color:rgba(255,255,255,0.7);"></div>
                </div>
                <div id="posterError" style="margin-top:8px; padding:12px; background:rgba(239,68,68,0.1); border:1px solid rgba(239,68,68,0.3); border-radius:8px; color:#ef4444; font-size:13px; display:none;"></div>
            </div>
        </div>
        
        <div style="margin-top:24px; display:flex; gap:12px; justify-content:flex-end;">
            <button onclick="closeEditModal()" style="padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:#fff; cursor:pointer; font-size:15px; font-weight:600;">Cancel</button>
            <button onclick="saveMetadata()" style="padding:12px 24px; background:#10b981; border:none; border-radius:8px; color:#fff; cursor:pointer; font-size:15px; font-weight:600;">Save Changes</button>
        </div>
        
        <div style="margin-top:16px; padding:12px; background:rgba(251,191,36,0.1); border:1px solid rgba(251,191,36,0.2); border-radius:8px; color:rgba(255,255,255,0.8); font-size:13px;">
            ⚠️ Note: Manually edited metadata will not be overwritten when fetching from TMDB.
        </div>
    </div>
</div>
"@
                $html = Get-HTMLPage -Content $movieContent -Title "$($video.title)"
                Write-PodeHtmlResponse -Value $html
            }
            else {
                $html = Get-HTMLPage -Content "<h1>Movie not found</h1><p><a href='/videos'>← Back to Videos</a></p>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.34 User Stats Route -----
        Add-PodeRoute -Method Get -Path '/user-stats' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $username = $WebEvent.Query['username']
            if ([string]::IsNullOrWhiteSpace($username) -and $user) {
                $username = $user.Username
            }
            
            $html = Get-UserStatsPage -Username $username
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 3.35 Play Playlist Route -----
        Add-PodeRoute -Method Get -Path '/play-playlist/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            if (-not $user -or -not $user.Username) {
                $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Please log in</h1><p><a href='/login'>← Login</a></p></div>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            $playlistId = [int]$WebEvent.Parameters['id']
            $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
            
            # Get playlist info
            $playlist = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM playlists WHERE playlist_id = @id" -SqlParameters @{ id = $playlistId }
            
            if (-not $playlist) {
                $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Playlist not found</h1><p><a href='/playlists'>← Back to Playlists</a></p></div>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            # Get tracks
            $tracks = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM playlist_tracks WHERE playlist_id = @id ORDER BY track_order" -SqlParameters @{ id = $playlistId }
            
            if (-not $tracks -or @($tracks).Count -eq 0) {
                $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Playlist is empty</h1><p><a href='/playlist/$playlistId'>← Add some music</a></p></div>" -Title "Empty Playlist"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            # Get first track
            $firstTrack = @($tracks)[0]
            Move-PodeResponseUrl -Url "/play-audio/$($firstTrack.music_id)"
        }
        
        # ----- 3.36 Play Playlist Shuffle Route -----
        Add-PodeRoute -Method Get -Path '/play-playlist/:id/shuffle' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            if (-not $user -or -not $user.Username) {
                $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Please log in</h1><p><a href='/login'>← Login</a></p></div>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
                return
            }
            
            $playlistId = [int]$WebEvent.Parameters['id']
            $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
            
            # Get random track from playlist
            $track = Invoke-SqliteQuery -DataSource $userDbPath -Query "SELECT * FROM playlist_tracks WHERE playlist_id = @id ORDER BY RANDOM() LIMIT 1" -SqlParameters @{ id = $playlistId }
            
            if ($track) {
                Move-PodeResponseUrl -Url "/play-audio/$($track.music_id)"
            }
            else {
                $html = Get-HTMLPage -Content "<div style='padding:40px; text-align:center;'><h1>Playlist is empty</h1><p><a href='/playlists'>← Back to Playlists</a></p></div>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 3.37 API: Get User -----
        Add-PodeRoute -Method Get -Path '/api/users/get' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Access denied" }
                return
            }
            
            $username = $WebEvent.Query['username']
            
            $userData = Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                -Query "SELECT user_id, username, display_name, user_type, avatar_path, created_date, last_login FROM users WHERE username = @username" `
                -SqlParameters @{ username = $username }
            
            if ($userData) {
                Write-PodeJsonResponse -Value @{ 
                    success = $true
                    data = @{
                        user_id = $userData.user_id
                        username = $userData.username
                        display_name = $userData.display_name
                        user_type = $userData.user_type
                        avatar_path = $userData.avatar_path
                        created_date = $userData.created_date
                        last_login = $userData.last_login
                    }
                }
            } else {
                Write-PodeJsonResponse -Value @{ success = $false; error = "User not found" }
            }
        }
        
        # ----- 3.38 API: Delete User -----
        Add-PodeRoute -Method Post -Path '/api/users/delete' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Access denied" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                $username = $data.username
                
                # Don't allow deleting yourself
                if ($username -eq $user.Username) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Cannot delete your own account" }
                    return
                }
                
                # Delete user
                Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                    -Query "DELETE FROM users WHERE username = @username" `
                    -SqlParameters @{ username = $username }
                
                Write-Host "[✓] User deleted: $username" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true }
            }
            catch {
                Write-Host "[✗] Error deleting user: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.39 API: Edit User -----
        Add-PodeRoute -Method Post -Path '/api/users/edit' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Access denied" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                
                # Handle avatar image if provided (base64 encoded)
                $avatarFileName = $null
                if ($data.avatarImage -and -not [string]::IsNullOrWhiteSpace($data.avatarImage)) {
                    try {
                        # Extract base64 data (remove data:image/jpeg;base64, prefix)
                        $base64Data = $data.avatarImage -replace '^data:image/[^;]+;base64,', ''
                        $imageBytes = [Convert]::FromBase64String($base64Data)
                        
                        # Ensure avatars folder exists
                        $avatarFolder = $Global:CONFIG.AvatarFolder
                        if (-not (Test-Path $avatarFolder)) {
                            New-Item -Path $avatarFolder -ItemType Directory -Force | Out-Null
                        }
                        
                        # Generate unique filename
                        $avatarFileName = "avatar_$($data.username)_$(Get-Date -Format 'yyyyMMddHHmmss').jpg"
                        $avatarPath = Join-Path $avatarFolder $avatarFileName
                        
                        # Save the image
                        [System.IO.File]::WriteAllBytes($avatarPath, $imageBytes)
                        
                        Write-Host "[✓] Avatar saved for user '$($data.username)': $avatarFileName" -ForegroundColor Green
                    }
                    catch {
                        Write-Host "[✗] Error saving avatar: $_" -ForegroundColor Red
                        # Continue with user update even if avatar fails
                    }
                }
                
                # Update user basic info
                Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                    -Query "UPDATE users SET display_name = @displayname, user_type = @usertype WHERE username = @username" `
                    -SqlParameters @{ 
                        username = $data.username
                        displayname = $data.displayName
                        usertype = $data.userType
                    }
                
                # Update PIN if provided
                if ($data.pin -and -not [string]::IsNullOrWhiteSpace($data.pin)) {
                    $pinResult = New-PINCode -PIN $data.pin
                    Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                        -Query "UPDATE users SET pin_hash = @hash, pin_salt = @salt WHERE username = @username" `
                        -SqlParameters @{ 
                            username = $data.username
                            hash = $pinResult.Hash
                            salt = $pinResult.Salt
                        }
                }
                
                # Update avatar path if new avatar was saved
                if ($avatarFileName) {
                    Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                        -Query "UPDATE users SET avatar_path = @avatar WHERE username = @username" `
                        -SqlParameters @{ 
                            username = $data.username
                            avatar = $avatarFileName
                        }
                }
                
                Write-Host "[✓] User updated: $($data.username)" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true }
            }
            catch {
                Write-Host "[✗] Error updating user: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.40 API: Create User -----
        Add-PodeRoute -Method Post -Path '/api/users/create' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Access denied" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                
                # Create user using existing function
                $success = New-UserAccount -Username $data.username -PIN $data.pin -UserType $data.usertype -DisplayName $data.displayname
                
                if ($success) {
                    Write-Host "[✓] User created: $($data.username)" -ForegroundColor Green
                    Write-PodeJsonResponse -Value @{ success = $true }
                }
                else {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to create user" }
                }
            }
            catch {
                Write-Host "[✗] Error creating user: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ============================================================================
        # NETWORK SHARE API ROUTES (v1.6)
        # ============================================================================
        
        # ----- 3.40a API: List Network Shares -----
        Add-PodeRoute -Method Get -Path '/api/networkshare/list' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Admin access required" }
                return
            }
            
            try {
                $shares = Get-NetworkShares -DatabasePath $Global:CONFIG.SharesDB
                
                # Ensure it's always an array
                if ($null -eq $shares) {
                    $shares = @()
                } elseif ($shares -isnot [System.Array]) {
                    $shares = @($shares)
                }
                
                # Remove sensitive data before sending to client
                $sharesClean = @()
                foreach ($share in $shares) {
                    $sharesClean += @{
                        share_id = $share.share_id
                        share_name = $share.share_name
                        share_type = $share.share_type
                        share_path = $share.share_path
                        username = $share.username
                        has_credentials = (-not [string]::IsNullOrWhiteSpace($share.password_encrypted))
                        enabled = $share.enabled
                        created_date = $share.created_date
                        last_tested = $share.last_tested
                        last_test_status = $share.last_test_status
                    }
                }
                
                Write-PodeJsonResponse -Value @{
                    success = $true
                    shares = $sharesClean
                }
            }
            catch {
                Write-Host "[✗] Error listing network shares: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to retrieve network shares: $_" }
            }
        }
        
        # ----- 3.40b API: Create Network Share -----
        Add-PodeRoute -Method Post -Path '/api/networkshare/create' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Admin access required" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                
                # Validate required fields
                if (-not $data.share_name -or -not $data.share_type -or -not $data.share_path) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Missing required fields: share_name, share_type, share_path" }
                    return
                }
                
                # Validate share_type
                $validTypes = @('movies', 'music', 'pictures', 'pdfs', 'musicvideos')
                if ($validTypes -notcontains $data.share_type) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Invalid share_type. Must be one of: $($validTypes -join ', ')" }
                    return
                }
                
                # Check if an enabled path already exists for this category
                $existingEnabled = Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
SELECT share_id, share_name FROM network_shares WHERE share_type = @type AND enabled = 1
"@ -SqlParameters @{ type = $data.share_type }
                
                if ($existingEnabled) {
                    $existingName = if ($existingEnabled -is [System.Array]) { $existingEnabled[0].share_name } else { $existingEnabled.share_name }
                    Write-PodeJsonResponse -Value @{ success = $false; error = "A path for '$($data.share_type)' already exists ('$existingName'). Only one path per media category is allowed. Please disable or delete the existing path first." }
                    return
                }
                
                # Encrypt password if provided
                $passwordEncrypted = $null
                $passwordSalt = $null
                $passwordIV = $null
                
                if ($data.password -and -not [string]::IsNullOrWhiteSpace($data.password)) {
                    $encrypted = Protect-NetworkCredential -Credential $data.password
                    if ($encrypted) {
                        $passwordEncrypted = $encrypted.Encrypted
                        $passwordSalt = $encrypted.Salt
                        $passwordIV = $encrypted.IV
                    }
                }
                
                # Insert into database (v6.96 - now uses SharesDB)
                Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
INSERT INTO network_shares (share_name, share_type, share_path, username, password_encrypted, password_salt, password_iv, created_date)
VALUES (@name, @type, @path, @username, @pwd_enc, @pwd_salt, @pwd_iv, @created)
"@ -SqlParameters @{
                    name = $data.share_name
                    type = $data.share_type
                    path = $data.share_path
                    username = $data.username
                    pwd_enc = $passwordEncrypted
                    pwd_salt = $passwordSalt
                    pwd_iv = $passwordIV
                    created = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
                }
                
                Write-Host "[✓] Network share created: $($data.share_name)" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true; message = "Network share created successfully" }
            }
            catch {
                Write-Host "[✗] Error creating network share: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to create network share: $_" }
            }
        }
        
        # ----- 3.40c API: Delete Network Share -----
        Add-PodeRoute -Method Post -Path '/api/networkshare/delete' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Admin access required" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                
                if (-not $data.share_id) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Missing required field: share_id" }
                    return
                }
                
                Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
DELETE FROM network_shares WHERE share_id = @id
"@ -SqlParameters @{ id = $data.share_id }
                
                Write-Host "[✓] Network share deleted: ID $($data.share_id)" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true; message = "Network share deleted successfully" }
            }
            catch {
                Write-Host "[✗] Error deleting network share: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to delete network share: $_" }
            }
        }
        
        # ----- 3.40d API: Test Network Share -----
        Add-PodeRoute -Method Post -Path '/api/networkshare/test' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Admin access required" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                
                if (-not $data.share_id) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Missing required field: share_id" }
                    return
                }
                
                # Get share from database (v6.96 - now uses SharesDB)
                $shares = Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
SELECT * FROM network_shares WHERE share_id = @id
"@ -SqlParameters @{ id = $data.share_id }
                
                # Handle single result
                if ($shares -is [System.Array]) {
                    $share = $shares[0]
                } else {
                    $share = $shares
                }
                
                if (-not $share -or -not $share.share_id) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Network share not found" }
                    return
                }
                
                # Decrypt password if exists
                $password = $null
                if ($share.password_encrypted -and $share.password_salt -and $share.password_iv) {
                    $password = Unprotect-NetworkCredential `
                        -EncryptedCredential $share.password_encrypted `
                        -Salt $share.password_salt `
                        -InitVector $share.password_iv
                }
                
                # Test connection
                $testResult = Test-NetworkShareConnection -SharePath $share.share_path -Username $share.username -Password $password
                
                # Update last tested status (v6.96 - now uses SharesDB)
                Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
UPDATE network_shares 
SET last_tested = @tested, last_test_status = @status 
WHERE share_id = @id
"@ -SqlParameters @{
                    tested = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
                    status = if ($testResult.Success) { "Connected" } else { $testResult.Message }
                    id = $share.share_id
                }
                
                # Update global MediaShareStatus (v3.7)
                if ($Global:MediaShareStatus -and $share.share_type) {
                    $Global:MediaShareStatus[$share.share_type] = @{
                        Online = $testResult.Success
                        Path = $share.share_path
                        Message = $testResult.Message
                        ShareName = $share.share_name
                    }
                    $Global:MediaShareStatus.LastChecked = Get-Date
                }
                
                Write-PodeJsonResponse -Value @{
                    success = $testResult.Success
                    message = $testResult.Message
                }
            }
            catch {
                Write-Host "[✗] Error testing network share: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to test network share: $_" }
            }
        }
        
        # ----- 3.40e API: Toggle Network Share -----
        Add-PodeRoute -Method Post -Path '/api/networkshare/toggle' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Admin access required" }
                return
            }
            
            try {
                $data = $WebEvent.Data
                
                if (-not $data.share_id) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Missing required field: share_id" }
                    return
                }
                
                $enabled = if ($data.enabled -eq $true -or $data.enabled -eq 1) { 1 } else { 0 }
                
                # If enabling, check if another path for the same category is already enabled
                if ($enabled -eq 1) {
                    # Get the share type of the share being enabled
                    $shareToEnable = Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
SELECT share_type FROM network_shares WHERE share_id = @id
"@ -SqlParameters @{ id = $data.share_id }
                    
                    if ($shareToEnable) {
                        $shareType = $shareToEnable.share_type
                        
                        # Check if another enabled share exists for this type
                        $existingEnabled = Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
SELECT share_id, share_name FROM network_shares WHERE share_type = @type AND enabled = 1 AND share_id != @id
"@ -SqlParameters @{ type = $shareType; id = $data.share_id }
                        
                        if ($existingEnabled) {
                            $existingName = if ($existingEnabled -is [System.Array]) { $existingEnabled[0].share_name } else { $existingEnabled.share_name }
                            Write-PodeJsonResponse -Value @{ success = $false; error = "Cannot enable: '$existingName' is already enabled for '$shareType'. Only one path per media category is allowed. Please disable it first." }
                            return
                        }
                    }
                }
                
                Invoke-SqliteQuery -DataSource $Global:CONFIG.SharesDB -Query @"
UPDATE network_shares SET enabled = @enabled WHERE share_id = @id
"@ -SqlParameters @{ enabled = $enabled; id = $data.share_id }
                
                Write-PodeJsonResponse -Value @{ success = $true; message = "Network share updated" }
            }
            catch {
                Write-Host "[✗] Error toggling network share: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to toggle network share: $_" }
            }
        }
        
        # ----- 3.40e2 API: Refresh All Share Statuses (v3.7) -----
        Add-PodeRoute -Method Post -Path '/api/networkshare/refresh-all' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if current user is admin
            if (-not $user -or $user.UserType -ne 'admin') {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Admin access required" }
                return
            }
            
            try {
                # Run status check on all shares (v6.96 - now uses SharesDB)
                $statusResult = Test-AllMediaSharesStatus -DatabasePath $Global:CONFIG.SharesDB
                
                # Build summary
                $onlineCount = 0
                $offlineCount = 0
                foreach ($key in @('movies', 'music', 'pictures', 'pdfs', 'musicvideos')) {
                    if ($statusResult[$key] -and $statusResult[$key].Online) {
                        $onlineCount++
                    } elseif ($statusResult[$key] -and $statusResult[$key].Path) {
                        $offlineCount++
                    }
                }
                
                Write-PodeJsonResponse -Value @{
                    success = $true
                    message = "Status refresh complete: $onlineCount online, $offlineCount offline"
                    status = $statusResult
                }
            }
            catch {
                Write-Host "[✗] Error refreshing share statuses: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to refresh share statuses: $_" }
            }
        }
        
        # ----- 3.40f API: Generate Music Video Thumbnails (v1.8) -----
        Add-PodeRoute -Method Post -Path '/api/musicvideo/generate-thumbnails' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            # Check if Music Videos feature is enabled
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Music Videos feature not enabled" }
                return
            }
            
            # Get FFmpeg path - try multiple locations
            $ffmpegPath = $null
            
            # Option 1: From config FFmpegPath
            if ($Global:CONFIG.FFmpegPath -and (Test-Path $Global:CONFIG.FFmpegPath)) {
                $ffmpegPath = $Global:CONFIG.FFmpegPath
            }
            
            # Option 2: From ToolsFolder
            if (-not $ffmpegPath) {
                $toolsFolder = $Global:CONFIG.ToolsFolder
                if ($toolsFolder) {
                    $localFFmpegExe = Join-Path $toolsFolder "ffmpeg\bin\ffmpeg.exe"
                    if (Test-Path $localFFmpegExe) {
                        $ffmpegPath = $localFFmpegExe
                    }
                }
            }
            
            # Option 3: From ScriptRoot\tools
            if (-not $ffmpegPath) {
                $scriptRoot = $Global:CONFIG.ScriptRoot
                if ($scriptRoot) {
                    $localFFmpegExe = Join-Path $scriptRoot "tools\ffmpeg\bin\ffmpeg.exe"
                    if (Test-Path $localFFmpegExe) {
                        $ffmpegPath = $localFFmpegExe
                    }
                }
            }
            
            # Option 4: Check system PATH
            if (-not $ffmpegPath) {
                $ffmpegInPath = Get-Command ffmpeg -ErrorAction SilentlyContinue
                if ($ffmpegInPath) {
                    $ffmpegPath = $ffmpegInPath.Source
                }
            }
            
            # Check if ffmpeg was found
            if (-not $ffmpegPath) {
                Write-PodeJsonResponse -Value @{ success = $false; error = "ffmpeg not found. Please ensure ffmpeg.exe exists in: tools\ffmpeg\bin\ffmpeg.exe" }
                return
            }
            
            try {
                Write-NexusMLog "Starting music video thumbnail generation using: $ffmpegPath"
                
                # Create thumbnails folder
                $thumbsFolder = $Global:CONFIG.MusicVideoThumbsFolder
                if (-not $thumbsFolder) {
                    $thumbsFolder = Join-Path $Global:CONFIG.ScriptRoot "assets\mvthumbs"
                }
                
                if (-not (Test-Path $thumbsFolder)) {
                    New-Item -ItemType Directory -Path $thumbsFolder -Force | Out-Null
                }
                
                # Get music videos without thumbnails
                $musicVideos = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query @"
SELECT id, filepath, filename, title, artist 
FROM musicvideos 
WHERE thumbnail_path IS NULL OR thumbnail_path = ''
ORDER BY title
"@
                
                if (-not $musicVideos -or $musicVideos.Count -eq 0) {
                    Write-PodeJsonResponse -Value @{ success = $true; processed = 0; generated = 0; skipped = 0; message = "All videos already have thumbnails" }
                    return
                }
                
                $generated = 0
                $skipped = 0
                $count = 0
                
                foreach ($video in $musicVideos) {
                    $count++
                    
                    if (-not (Test-Path -LiteralPath $video.filepath)) {
                        $skipped++
                        continue
                    }
                    
                    # Generate thumbnail filename
                    $thumbFileName = "mvthumb_$($video.id).jpg"
                    $thumbFilePath = Join-Path $thumbsFolder $thumbFileName
                    
                    # Skip if already exists
                    if (Test-Path $thumbFilePath) {
                        # Just update the database
                        Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query @"
UPDATE musicvideos SET thumbnail_path = @thumbPath WHERE id = @id
"@ -SqlParameters @{ thumbPath = $thumbFileName; id = $video.id }
                        $generated++
                        continue
                    }
                    
                    try {
                        # Extract frame at 5 seconds (simple and reliable)
                        # Using -ss before -i for fast seeking
                        $process = Start-Process -FilePath $ffmpegPath `
                            -ArgumentList @(
                                "-ss", "5"
                                "-i", "`"$($video.filepath)`""
                                "-vframes", "1"
                                "-vf", "scale=640:-1"
                                "-q:v", "3"
                                "`"$thumbFilePath`""
                                "-y"
                            ) `
                            -NoNewWindow -Wait -PassThru `
                            -RedirectStandardError "$env:TEMP\ffmpeg_mvthumb_err_$($video.id).txt" `
                            -RedirectStandardOutput "$env:TEMP\ffmpeg_mvthumb_out_$($video.id).txt"
                        
                        if ($process.ExitCode -eq 0 -and (Test-Path $thumbFilePath)) {
                            # Update database
                            Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query @"
UPDATE musicvideos SET thumbnail_path = @thumbPath WHERE id = @id
"@ -SqlParameters @{ thumbPath = $thumbFileName; id = $video.id }
                            $generated++
                        }
                        else {
                            # Fallback: try extracting first frame (for very short videos)
                            $process2 = Start-Process -FilePath $ffmpegPath `
                                -ArgumentList @(
                                    "-i", "`"$($video.filepath)`""
                                    "-vframes", "1"
                                    "-vf", "scale=640:-1"
                                    "-q:v", "3"
                                    "`"$thumbFilePath`""
                                    "-y"
                                ) `
                                -NoNewWindow -Wait -PassThru `
                                -RedirectStandardError "$env:TEMP\ffmpeg_mvthumb2_err_$($video.id).txt" `
                                -RedirectStandardOutput "$env:TEMP\ffmpeg_mvthumb2_out_$($video.id).txt"
                            
                            if ($process2.ExitCode -eq 0 -and (Test-Path $thumbFilePath)) {
                                # Update database
                                Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query @"
UPDATE musicvideos SET thumbnail_path = @thumbPath WHERE id = @id
"@ -SqlParameters @{ thumbPath = $thumbFileName; id = $video.id }
                                $generated++
                            }
                            else {
                                $skipped++
                            }
                            
                            # Cleanup fallback temp files
                            Remove-Item "$env:TEMP\ffmpeg_mvthumb2_err_$($video.id).txt" -ErrorAction SilentlyContinue
                            Remove-Item "$env:TEMP\ffmpeg_mvthumb2_out_$($video.id).txt" -ErrorAction SilentlyContinue
                        }
                        
                        # Cleanup temp files
                        Remove-Item "$env:TEMP\ffmpeg_mvthumb_err_$($video.id).txt" -ErrorAction SilentlyContinue
                        Remove-Item "$env:TEMP\ffmpeg_mvthumb_out_$($video.id).txt" -ErrorAction SilentlyContinue
                    }
                    catch {
                        Write-Host "[!] Error generating thumbnail for ID $($video.id): $_" -ForegroundColor Yellow
                        $skipped++
                    }
                }
                
                Write-Host "[✓] Thumbnail generation complete: $generated generated, $skipped skipped" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{
                    success = $true
                    processed = $count
                    generated = $generated
                    skipped = $skipped
                }
            }
            catch {
                Write-Host "[✗] Error generating thumbnails: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to generate thumbnails: $_" }
            }
        }
        
        # ----- 3.40a1b API: Analyze MP4 Videos (v7.56) -----
        Add-PodeRoute -Method Post -Path '/api/musicvideo/analyze-mp4s' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "Music Videos feature not enabled" }
                return
            }
            
            try {
                Write-NexusMLog "Starting MP4 moov atom analysis"
                
                # Get all MP4 videos that haven't been analyzed yet
                $videos = @(Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query @"
SELECT id, filepath, filename, format 
FROM musicvideos 
WHERE (moov_position IS NULL OR moov_position = '') 
AND LOWER(format) IN ('mp4', 'm4v', 'mov', 'm4a')
"@)
                
                if (-not $videos -or $videos.Count -eq 0) {
                    Write-PodeJsonResponse -Value @{ 
                        success = $true
                        analyzed = 0
                        needsOptimization = 0
                        nonCompliant = 0
                        optimized = 0
                        message = "All MP4 videos have already been analyzed" 
                    }
                    return
                }
                
                $analyzed = 0
                $needsOpt = 0
                $nonCompliant = 0
                $optimized = 0
                
                foreach ($video in $videos) {
                    $analyzed++
                    
                    if (-not (Test-Path -LiteralPath $video.filepath)) {
                        # File not accessible, skip
                        continue
                    }
                    
                    try {
                        # Analyze the MP4 file
                        $analysis = Analyze-MP4File -FilePath $video.filepath
                        
                        if ($analysis) {
                            # Update database with results (including 'unknown' which marks files for review)
                            $updateQuery = "UPDATE musicvideos SET moov_position = @moov, stream_order = @stream, needs_optimization = @needs, mp4_compliant = @compliant WHERE id = @id"
                            Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query $updateQuery -SqlParameters @{
                                moov = $analysis.moov_position
                                stream = $analysis.stream_order
                                needs = $analysis.needs_optimization
                                compliant = $analysis.mp4_compliant
                                id = $video.id
                            }
                            
                            if ($analysis.mp4_compliant -eq 0) {
                                $nonCompliant++
                                $sizeInfo = if ($analysis.file_size -gt 0) { " ($('{0:N1}' -f ($analysis.file_size / 1MB)) MB)" } else { "" }
                                Write-NexusMLog "  ❌ $($video.filename)$sizeInfo - NON-COMPLIANT MP4 (problematic structure)"
                            }
                            elseif ($analysis.needs_optimization -eq 1) {
                                $needsOpt++
                                $sizeInfo = if ($analysis.file_size -gt 0) { " ($('{0:N1}' -f ($analysis.file_size / 1MB)) MB)" } else { "" }
                                Write-NexusMLog "  ⚠️ $($video.filename)$sizeInfo - needs optimization (moov at $($analysis.moov_position))"
                            }
                            else {
                                $optimized++
                            }
                        }
                    }
                    catch {
                        Write-NexusMLog "Error analyzing $($video.filename): $_" -Level "WARNING"
                    }
                }
                
                Write-NexusMLog "MP4 analysis complete: $analyzed analyzed, $needsOpt need optimization, $nonCompliant non-compliant, $optimized already optimized"
                Write-Host "[✓] MP4 analysis complete: $needsOpt need optimization, $nonCompliant non-compliant" -ForegroundColor Green
                
                Write-PodeJsonResponse -Value @{
                    success = $true
                    analyzed = $analyzed
                    needsOptimization = $needsOpt
                    nonCompliant = $nonCompliant
                    optimized = $optimized
                }
            }
            catch {
                Write-Host "[✗] Error analyzing MP4 videos: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; message = "Failed to analyze videos: $_" }
            }
        }
        
        # ----- 3.40a2 API: Fix Single MP4 (v7.54) -----
        Add-PodeRoute -Method Post -Path '/api/musicvideo/fix-mp4/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "Music Videos feature not enabled" }
                return
            }
            
            $videoId = $WebEvent.Parameters['id']
            
            # Get video info
            $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                -Query "SELECT id, filepath, filename, needs_optimization FROM musicvideos WHERE id = @id" `
                -SqlParameters @{ id = $videoId }
            
            if (-not $video) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "Video not found" }
                return
            }
            
            if (-not (Test-Path -LiteralPath $video.filepath)) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "Video file not accessible" }
                return
            }
            
            # Get FFmpeg path
            $ffmpegPath = $null
            if ($Global:CONFIG.FFmpegPath -and (Test-Path $Global:CONFIG.FFmpegPath)) {
                $ffmpegPath = $Global:CONFIG.FFmpegPath
            }
            if (-not $ffmpegPath) {
                $toolsFolder = $Global:CONFIG.ToolsFolder
                if ($toolsFolder) {
                    $localFFmpegExe = Join-Path $toolsFolder "ffmpeg\bin\ffmpeg.exe"
                    if (Test-Path $localFFmpegExe) {
                        $ffmpegPath = $localFFmpegExe
                    }
                }
            }
            if (-not $ffmpegPath) {
                $ffmpegInPath = Get-Command ffmpeg -ErrorAction SilentlyContinue
                if ($ffmpegInPath) {
                    $ffmpegPath = $ffmpegInPath.Source
                }
            }
            
            if (-not $ffmpegPath) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "FFmpeg not available" }
                return
            }
            
            try {
                $filePath = $video.filepath
                $directory = [System.IO.Path]::GetDirectoryName($filePath)
                $filename = [System.IO.Path]::GetFileNameWithoutExtension($filePath)
                $extension = [System.IO.Path]::GetExtension($filePath)
                
                # Create temp output file
                $tempFile = Join-Path $directory "$filename.faststart.temp$extension"
                
                Write-NexusMLog "Fixing MP4 faststart for video ID $videoId : $filePath"
                
                # FFmpeg command to remux with faststart (no re-encoding)
                $process = Start-Process -FilePath $ffmpegPath `
                    -ArgumentList @(
                        "-hide_banner"
                        "-loglevel", "warning"
                        "-i", "`"$filePath`""
                        "-c", "copy"
                        "-movflags", "+faststart"
                        "-y"
                        "`"$tempFile`""
                    ) `
                    -NoNewWindow -Wait -PassThru `
                    -RedirectStandardError "$env:TEMP\ffmpeg_fix_$videoId.txt"
                
                if ($process.ExitCode -ne 0 -or -not (Test-Path $tempFile)) {
                    $errContent = Get-Content "$env:TEMP\ffmpeg_fix_$videoId.txt" -Raw -ErrorAction SilentlyContinue
                    Remove-Item "$env:TEMP\ffmpeg_fix_$videoId.txt" -ErrorAction SilentlyContinue
                    Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
                    Write-PodeJsonResponse -Value @{ success = $false; message = "FFmpeg failed: $errContent" }
                    return
                }
                
                # Verify file sizes are similar
                $originalSize = (Get-Item -LiteralPath $filePath).Length
                $newSize = (Get-Item -LiteralPath $tempFile).Length
                $sizeDiff = [Math]::Abs($newSize - $originalSize) / $originalSize
                
                if ($sizeDiff -gt 0.05) {
                    Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
                    Write-PodeJsonResponse -Value @{ success = $false; message = "Output file size differs significantly" }
                    return
                }
                
                # Replace original with optimized version
                Remove-Item -LiteralPath $filePath -Force
                Rename-Item -LiteralPath $tempFile -NewName ([System.IO.Path]::GetFileName($filePath))
                
                # Update database
                $updateQuery = "UPDATE musicvideos SET moov_position = 'start', needs_optimization = 0, size_bytes = @size WHERE id = @id"
                Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query $updateQuery -SqlParameters @{
                    size = $newSize
                    id = $videoId
                }
                
                # Cleanup
                Remove-Item "$env:TEMP\ffmpeg_fix_$videoId.txt" -ErrorAction SilentlyContinue
                
                Write-NexusMLog "MP4 faststart fix complete for video ID $videoId"
                Write-PodeJsonResponse -Value @{ success = $true; message = "MP4 file optimized successfully" }
            }
            catch {
                Write-NexusMLog "Error fixing MP4 for video ID $videoId : $_" -Level "ERROR"
                Write-PodeJsonResponse -Value @{ success = $false; message = "Error: $($_.Exception.Message)" }
            }
        }
        
        # ----- 3.40a3 API: Fix All MP4s (v7.54) -----
        Add-PodeRoute -Method Post -Path '/api/musicvideo/fix-all-mp4s' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            if (-not $Global:CONFIG.MusicVideosEnabled) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "Music Videos feature not enabled" }
                return
            }
            
            # Get all videos needing optimization
            $videos = @(Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                -Query "SELECT id, filepath, filename FROM musicvideos WHERE needs_optimization = 1")
            
            if ($videos.Count -eq 0) {
                Write-PodeJsonResponse -Value @{ success = $true; processed = 0; fixed = 0; failed = 0; message = "No videos need optimization" }
                return
            }
            
            # Get FFmpeg path
            $ffmpegPath = $null
            if ($Global:CONFIG.FFmpegPath -and (Test-Path $Global:CONFIG.FFmpegPath)) {
                $ffmpegPath = $Global:CONFIG.FFmpegPath
            }
            if (-not $ffmpegPath) {
                $toolsFolder = $Global:CONFIG.ToolsFolder
                if ($toolsFolder) {
                    $localFFmpegExe = Join-Path $toolsFolder "ffmpeg\bin\ffmpeg.exe"
                    if (Test-Path $localFFmpegExe) {
                        $ffmpegPath = $localFFmpegExe
                    }
                }
            }
            if (-not $ffmpegPath) {
                $ffmpegInPath = Get-Command ffmpeg -ErrorAction SilentlyContinue
                if ($ffmpegInPath) {
                    $ffmpegPath = $ffmpegInPath.Source
                }
            }
            
            if (-not $ffmpegPath) {
                Write-PodeJsonResponse -Value @{ success = $false; message = "FFmpeg not available" }
                return
            }
            
            Write-NexusMLog "Starting batch MP4 faststart fix for $($videos.Count) videos"
            
            $processed = 0
            $fixed = 0
            $failed = 0
            
            foreach ($video in $videos) {
                $processed++
                
                if (-not (Test-Path -LiteralPath $video.filepath)) {
                    $failed++
                    continue
                }
                
                try {
                    $filePath = $video.filepath
                    $directory = [System.IO.Path]::GetDirectoryName($filePath)
                    $filename = [System.IO.Path]::GetFileNameWithoutExtension($filePath)
                    $extension = [System.IO.Path]::GetExtension($filePath)
                    
                    $tempFile = Join-Path $directory "$filename.faststart.temp$extension"
                    
                    $process = Start-Process -FilePath $ffmpegPath `
                        -ArgumentList @(
                            "-hide_banner"
                            "-loglevel", "warning"
                            "-i", "`"$filePath`""
                            "-c", "copy"
                            "-movflags", "+faststart"
                            "-y"
                            "`"$tempFile`""
                        ) `
                        -NoNewWindow -Wait -PassThru `
                        -RedirectStandardError "$env:TEMP\ffmpeg_fixall_$($video.id).txt"
                    
                    if ($process.ExitCode -eq 0 -and (Test-Path $tempFile)) {
                        $originalSize = (Get-Item -LiteralPath $filePath).Length
                        $newSize = (Get-Item -LiteralPath $tempFile).Length
                        $sizeDiff = [Math]::Abs($newSize - $originalSize) / $originalSize
                        
                        if ($sizeDiff -le 0.05) {
                            # Replace original
                            Remove-Item -LiteralPath $filePath -Force
                            Rename-Item -LiteralPath $tempFile -NewName ([System.IO.Path]::GetFileName($filePath))
                            
                            # Update database
                            Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                                -Query "UPDATE musicvideos SET moov_position = 'start', needs_optimization = 0, size_bytes = @size WHERE id = @id" `
                                -SqlParameters @{ size = $newSize; id = $video.id }
                            
                            $fixed++
                        }
                        else {
                            Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
                            $failed++
                        }
                    }
                    else {
                        Remove-Item $tempFile -Force -ErrorAction SilentlyContinue
                        $failed++
                    }
                    
                    Remove-Item "$env:TEMP\ffmpeg_fixall_$($video.id).txt" -ErrorAction SilentlyContinue
                }
                catch {
                    Write-NexusMLog "Error fixing MP4 ID $($video.id): $_" -Level "WARNING"
                    $failed++
                }
            }
            
            Write-NexusMLog "Batch MP4 fix complete: $fixed fixed, $failed failed out of $processed processed"
            Write-PodeJsonResponse -Value @{
                success = $true
                processed = $processed
                fixed = $fixed
                failed = $failed
            }
        }
        
        # ----- 3.40b API: Generate Picture Thumbnails (v4.0) -----
        Add-PodeRoute -Method Post -Path '/api/picture/generate-thumbnails' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            try {
                Write-Host "[i] Starting picture thumbnail generation" -ForegroundColor Cyan
                
                # Create thumbnails folder
                $thumbsFolder = $Global:CONFIG.PictureThumbsFolder
                if (-not $thumbsFolder) {
                    $thumbsFolder = Join-Path $Global:CONFIG.ScriptRoot "assets\thumbs"
                }
                
                if (-not (Test-Path $thumbsFolder)) {
                    New-Item -ItemType Directory -Path $thumbsFolder -Force | Out-Null
                }
                
                # Get pictures without thumbnails
                $pictures = Invoke-SqliteQuery -DataSource $Global:CONFIG.PicturesDB -Query @"
SELECT id, filepath, filename, size_bytes 
FROM images 
WHERE thumbnail_path IS NULL OR thumbnail_path = ''
ORDER BY size_bytes ASC
"@
                
                if (-not $pictures -or @($pictures).Count -eq 0) {
                    Write-PodeJsonResponse -Value @{ success = $true; processed = 0; generated = 0; skipped = 0; message = "All pictures already have thumbnails" }
                    return
                }
                
                Add-Type -AssemblyName System.Drawing -ErrorAction SilentlyContinue
                
                $generated = 0
                $skipped = 0
                $count = 0
                $maxWidth = 400
                $maxHeight = 300
                
                # Maximum file size to process (50MB) - skip very large files to prevent memory issues
                $maxFileSize = 50 * 1024 * 1024
                
                foreach ($picture in $pictures) {
                    $count++
                    
                    if (-not (Test-Path -LiteralPath $picture.filepath)) {
                        $skipped++
                        continue
                    }
                    
                    # Skip very large files to prevent memory issues
                    $fileSize = (Get-Item -LiteralPath $picture.filepath).Length
                    if ($fileSize -gt $maxFileSize) {
                        Write-Host "[!] Skipping large file ($('{0:N0}' -f ($fileSize/1MB))MB): $($picture.filename)" -ForegroundColor Yellow
                        $skipped++
                        continue
                    }
                    
                    # Generate thumbnail filename
                    $thumbFileName = "picthumb_$($picture.id).jpg"
                    $thumbFilePath = Join-Path $thumbsFolder $thumbFileName
                    
                    # Skip if already exists on disk
                    if (Test-Path $thumbFilePath) {
                        # Just update the database
                        Invoke-SqliteQuery -DataSource $Global:CONFIG.PicturesDB -Query @"
UPDATE images SET thumbnail_path = @thumbPath WHERE id = @id
"@ -SqlParameters @{ thumbPath = $thumbFileName; id = $picture.id }
                        $generated++
                        continue
                    }
                    
                    $originalImage = $null
                    $thumbnail = $null
                    $graphics = $null
                    $fileStream = $null
                    
                    try {
                        # Use FileStream to load image (more memory efficient for large files)
                        $fileStream = [System.IO.File]::OpenRead($picture.filepath)
                        $originalImage = [System.Drawing.Image]::FromStream($fileStream, $false, $false)
                        
                        # Calculate new dimensions maintaining aspect ratio
                        $ratioX = $maxWidth / $originalImage.Width
                        $ratioY = $maxHeight / $originalImage.Height
                        $ratio = [Math]::Min($ratioX, $ratioY)
                        
                        # Don't upscale - if image is smaller, use original size
                        if ($ratio -gt 1) { $ratio = 1 }
                        
                        $newWidth = [int]($originalImage.Width * $ratio)
                        $newHeight = [int]($originalImage.Height * $ratio)
                        
                        # Minimum size check
                        if ($newWidth -lt 1) { $newWidth = 1 }
                        if ($newHeight -lt 1) { $newHeight = 1 }
                        
                        # Create thumbnail
                        $thumbnail = New-Object System.Drawing.Bitmap($newWidth, $newHeight)
                        $graphics = [System.Drawing.Graphics]::FromImage($thumbnail)
                        
                        # High quality settings
                        $graphics.InterpolationMode = [System.Drawing.Drawing2D.InterpolationMode]::HighQualityBicubic
                        $graphics.SmoothingMode = [System.Drawing.Drawing2D.SmoothingMode]::HighQuality
                        $graphics.PixelOffsetMode = [System.Drawing.Drawing2D.PixelOffsetMode]::HighQuality
                        $graphics.CompositingQuality = [System.Drawing.Drawing2D.CompositingQuality]::HighQuality
                        
                        # Draw resized image
                        $graphics.DrawImage($originalImage, 0, 0, $newWidth, $newHeight)
                        
                        # Save as JPEG with good quality
                        $jpegEncoder = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object { $_.MimeType -eq 'image/jpeg' }
                        $encoderParams = New-Object System.Drawing.Imaging.EncoderParameters(1)
                        $encoderParams.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter([System.Drawing.Imaging.Encoder]::Quality, 85L)
                        
                        $thumbnail.Save($thumbFilePath, $jpegEncoder, $encoderParams)
                        
                        # Update database
                        Invoke-SqliteQuery -DataSource $Global:CONFIG.PicturesDB -Query @"
UPDATE images SET thumbnail_path = @thumbPath WHERE id = @id
"@ -SqlParameters @{ thumbPath = $thumbFileName; id = $picture.id }
                        $generated++
                    }
                    catch {
                        Write-Host "[!] Error generating thumbnail for ID $($picture.id): $_" -ForegroundColor Yellow
                        $skipped++
                        # Clean up failed thumbnail file
                        if (Test-Path $thumbFilePath) {
                            Remove-Item $thumbFilePath -Force -ErrorAction SilentlyContinue
                        }
                    }
                    finally {
                        # Always dispose resources
                        if ($graphics) { $graphics.Dispose() }
                        if ($thumbnail) { $thumbnail.Dispose() }
                        if ($originalImage) { $originalImage.Dispose() }
                        if ($fileStream) { $fileStream.Close(); $fileStream.Dispose() }
                        
                        # Force garbage collection every 10 images to free memory
                        if ($count % 10 -eq 0) {
                            [System.GC]::Collect()
                            [System.GC]::WaitForPendingFinalizers()
                        }
                    }
                }
                
                # Final garbage collection
                [System.GC]::Collect()
                
                Write-Host "[✓] Picture thumbnail generation complete: $generated generated, $skipped skipped" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{
                    success = $true
                    processed = $count
                    generated = $generated
                    skipped = $skipped
                }
            }
            catch {
                Write-Host "[✗] Error generating picture thumbnails: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = "Failed to generate thumbnails: $_" }
            }
        }
        
        # ----- 3.41 API: Update Movie Metadata -----
        Add-PodeRoute -Method Post -Path '/api/update-movie' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            try {
                $data = $WebEvent.Data
                
                # Handle poster image if provided
                $posterFileName = $null
                if ($data.posterImage -and -not [string]::IsNullOrWhiteSpace($data.posterImage)) {
                    try {
                        # Extract base64 data (remove data:image/jpeg;base64, prefix)
                        $base64Data = $data.posterImage -replace '^data:image/[^;]+;base64,', ''
                        $imageBytes = [Convert]::FromBase64String($base64Data)
                        
                        # Create poster filename
                        $posterFileName = "movie_$($data.id).jpg"
                        $posterPath = Join-Path $Global:CONFIG.PosterCacheFolder $posterFileName
                        
                        # Save the image
                        [System.IO.File]::WriteAllBytes($posterPath, $imageBytes)
                        
                        Write-Host "[✓] Poster saved: $posterFileName" -ForegroundColor Green
                    }
                    catch {
                        Write-Host "[✗] Error saving poster: $_" -ForegroundColor Red
                        # Continue with metadata update even if poster fails
                    }
                }
                
                # Prepare SQL parameters
                $sqlParams = @{
                    id = $data.id
                    title = $data.title
                    year = if ($data.year) { [int]$data.year } else { $null }
                    genre = $data.genre
                    director = $data.director
                    cast = $data.cast
                    runtime = if ($data.runtime) { [int]$data.runtime } else { $null }
                    rating = if ($data.rating) { [double]$data.rating } else { $null }
                    overview = $data.overview
                }
                
                # Build UPDATE query - include poster_url if new poster was uploaded
                if ($posterFileName) {
                    $updateQuery = @"
UPDATE videos 
SET title = @title,
    year = @year,
    genre = @genre,
    director = @director,
    "cast" = @cast,
    runtime = @runtime,
    rating = @rating,
    overview = @overview,
    poster_url = @poster_url,
    manually_edited = 1
WHERE id = @id
"@
                    $sqlParams['poster_url'] = $posterFileName
                }
                else {
                    $updateQuery = @"
UPDATE videos 
SET title = @title,
    year = @year,
    genre = @genre,
    director = @director,
    "cast" = @cast,
    runtime = @runtime,
    rating = @rating,
    overview = @overview,
    manually_edited = 1
WHERE id = @id
"@
                }
                
                # Update database with manually edited flag
                Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB -Query $updateQuery -SqlParameters $sqlParams
                
                Write-Host "[✓] Movie metadata updated: ID $($data.id)" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true }
            }
            catch {
                Write-Host "[✗] Error updating movie metadata: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.41aa API: Get Music Video (v6.99) -----
        Add-PodeRoute -Method Get -Path '/api/musicvideo/get' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            try {
                $videoId = $WebEvent.Query['id']
                
                if (-not $videoId) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Video ID required" }
                    return
                }
                
                $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB `
                    -Query "SELECT * FROM musicvideos WHERE id = @id" `
                    -SqlParameters @{ id = [int]$videoId }
                
                if ($video) {
                    Write-PodeJsonResponse -Value @{
                        success = $true
                        video = @{
                            id = $video.id
                            filename = $video.filename
                            filepath = $video.filepath
                            title = $video.title
                            artist = $video.artist
                            album = $video.album
                            year = $video.year
                            duration = $video.duration
                            size_bytes = $video.size_bytes
                            format = $video.format
                            resolution = $video.resolution
                            width = $video.width
                            height = $video.height
                            codec = $video.codec
                            bitrate = $video.bitrate
                            genre = $video.genre
                            thumbnail_path = $video.thumbnail_path
                        }
                    }
                }
                else {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Video not found" }
                }
            }
            catch {
                Write-Host "[✗] Error getting music video: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.41ab API: Update Music Video Metadata (v6.99) -----
        Add-PodeRoute -Method Post -Path '/api/update-musicvideo' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            try {
                $data = $WebEvent.Data
                
                # Handle thumbnail image if provided
                $thumbnailFileName = $null
                if ($data.thumbnailImage -and -not [string]::IsNullOrWhiteSpace($data.thumbnailImage)) {
                    try {
                        # Extract base64 data (remove data:image/jpeg;base64, prefix)
                        $base64Data = $data.thumbnailImage -replace '^data:image/[^;]+;base64,', ''
                        $imageBytes = [Convert]::FromBase64String($base64Data)
                        
                        # Create thumbnail filename
                        $thumbnailFileName = "mv_$($data.id)_$(Get-Date -Format 'yyyyMMddHHmmss').jpg"
                        
                        # Ensure thumbnail folder exists
                        $thumbFolder = Join-Path $Global:CONFIG.DataFolder "musicvideo_thumbs"
                        if (-not (Test-Path $thumbFolder)) {
                            New-Item -Path $thumbFolder -ItemType Directory -Force | Out-Null
                        }
                        
                        $thumbPath = Join-Path $thumbFolder $thumbnailFileName
                        
                        # Save the image
                        [System.IO.File]::WriteAllBytes($thumbPath, $imageBytes)
                        
                        Write-Host "[✓] Music video thumbnail saved: $thumbnailFileName" -ForegroundColor Green
                    }
                    catch {
                        Write-Host "[✗] Error saving thumbnail: $_" -ForegroundColor Red
                        # Continue with metadata update even if thumbnail fails
                    }
                }
                
                # Prepare SQL parameters
                $sqlParams = @{
                    id = [int]$data.id
                    title = $data.title
                    artist = $data.artist
                    album = $data.album
                    year = if ($data.year -and $data.year -ne '') { [int]$data.year } else { $null }
                    genre = $data.genre
                }
                
                # Build UPDATE query - include thumbnail_path if new thumbnail was uploaded
                if ($thumbnailFileName) {
                    $updateQuery = @"
UPDATE musicvideos 
SET title = @title,
    artist = @artist,
    album = @album,
    year = @year,
    genre = @genre,
    thumbnail_path = @thumbnail_path
WHERE id = @id
"@
                    $sqlParams['thumbnail_path'] = $thumbnailFileName
                }
                else {
                    $updateQuery = @"
UPDATE musicvideos 
SET title = @title,
    artist = @artist,
    album = @album,
    year = @year,
    genre = @genre
WHERE id = @id
"@
                }
                
                # Update database
                Invoke-SqliteQuery -DataSource $Global:CONFIG.MusicVideosDB -Query $updateQuery -SqlParameters $sqlParams
                
                Write-Host "[✓] Music video metadata updated: ID $($data.id)" -ForegroundColor Green
                Write-PodeJsonResponse -Value @{ success = $true }
            }
            catch {
                Write-Host "[✗] Error updating music video metadata: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.42 Stream Video Route (with chunked streaming for large files) -----
        
        # ----- 3.41a Favorite Toggle API (v3.8) -----
        Add-PodeRoute -Method Post -Path '/api/favorite/toggle' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            if (-not $user -or -not $user.Username) {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Not logged in" } -StatusCode 401
                return
            }
            
            try {
                $data = $WebEvent.Data
                $mediaType = $data.mediaType      # movie, tv, musicvideo, music, picture, pdf, radio, tvchannel
                $mediaId = $data.mediaId          # ID from the respective database
                $filepath = $data.filepath        # Optional filepath for fallback
                $title = $data.title              # Display title
                $posterUrl = $data.posterUrl      # Poster/thumbnail URL
                
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                
                # v6.99 FIX: Build query dynamically based on whether we have mediaId or filepath
                # This fixes the issue where NULL filepath caused incorrect matching
                $existingFav = $null
                
                if ($mediaId -and $mediaId -ne '' -and $mediaId -ne 0) {
                    # Prefer matching by media_id
                    $existingFav = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT favorite_id FROM favorites WHERE media_type = @mediaType AND media_id = @mediaId
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId }
                }
                elseif ($filepath -and $filepath -ne '') {
                    # Fallback to filepath for radio/tv channels
                    $existingFav = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT favorite_id FROM favorites WHERE media_type = @mediaType AND filepath = @filepath
"@ -SqlParameters @{ mediaType = $mediaType; filepath = $filepath }
                }
                
                if ($existingFav) {
                    # Remove from favorites - use same logic
                    if ($mediaId -and $mediaId -ne '' -and $mediaId -ne 0) {
                        Invoke-SqliteQuery -DataSource $userDbPath -Query @"
DELETE FROM favorites WHERE media_type = @mediaType AND media_id = @mediaId
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId }
                    }
                    elseif ($filepath -and $filepath -ne '') {
                        Invoke-SqliteQuery -DataSource $userDbPath -Query @"
DELETE FROM favorites WHERE media_type = @mediaType AND filepath = @filepath
"@ -SqlParameters @{ mediaType = $mediaType; filepath = $filepath }
                    }
                    
                    Write-Host "[♡] $($user.Username) unfavorited: $title ($mediaType)" -ForegroundColor Yellow
                    Write-PodeJsonResponse -Value @{ success = $true; isFavorite = $false }
                }
                else {
                    # Add to favorites
                    Invoke-SqliteQuery -DataSource $userDbPath -Query @"
INSERT OR REPLACE INTO favorites (media_type, media_id, filepath, title, poster_url, added_date)
VALUES (@mediaType, @mediaId, @filepath, @title, @posterUrl, @addedDate)
"@ -SqlParameters @{ 
                        mediaType = $mediaType
                        mediaId = if ($mediaId) { $mediaId } else { $null }
                        filepath = if ($filepath) { $filepath } else { $null }
                        title = $title
                        posterUrl = $posterUrl
                        addedDate = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                    }
                    
                    Write-Host "[♥] $($user.Username) favorited: $title ($mediaType)" -ForegroundColor Magenta
                    Write-PodeJsonResponse -Value @{ success = $true; isFavorite = $true }
                }
            }
            catch {
                Write-Host "[✗] Favorite toggle error: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.41b Watched Toggle API (v3.8) -----
        Add-PodeRoute -Method Post -Path '/api/watched/toggle' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            if (-not $user -or -not $user.Username) {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Not logged in" } -StatusCode 401
                return
            }
            
            try {
                $data = $WebEvent.Data
                $mediaType = $data.mediaType      # movie, tv, musicvideo only
                $mediaId = $data.mediaId          # ID from the respective database
                $filepath = $data.filepath        # Optional filepath for fallback
                $title = $data.title              # Display title
                
                # Validate media type
                if ($mediaType -notin @('movie', 'tv', 'musicvideo')) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Watched status only for movies, TV shows, and music videos" }
                    return
                }
                
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                
                # Check if already marked as watched
                $existingWatched = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT watched_id FROM watched WHERE media_type = @mediaType AND (media_id = @mediaId OR filepath = @filepath)
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId; filepath = $filepath }
                
                if ($existingWatched) {
                    # Remove watched status
                    Invoke-SqliteQuery -DataSource $userDbPath -Query @"
DELETE FROM watched WHERE media_type = @mediaType AND (media_id = @mediaId OR filepath = @filepath)
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId; filepath = $filepath }
                    
                    Write-Host "[○] $($user.Username) unmarked watched: $title ($mediaType)" -ForegroundColor Yellow
                    Write-PodeJsonResponse -Value @{ success = $true; isWatched = $false }
                }
                else {
                    # Mark as watched
                    Invoke-SqliteQuery -DataSource $userDbPath -Query @"
INSERT OR REPLACE INTO watched (media_type, media_id, filepath, title, watched_date)
VALUES (@mediaType, @mediaId, @filepath, @title, @watchedDate)
"@ -SqlParameters @{ 
                        mediaType = $mediaType
                        mediaId = $mediaId
                        filepath = $filepath
                        title = $title
                        watchedDate = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                    }
                    
                    Write-Host "[✓] $($user.Username) marked watched: $title ($mediaType)" -ForegroundColor Cyan
                    Write-PodeJsonResponse -Value @{ success = $true; isWatched = $true }
                }
            }
            catch {
                Write-Host "[✗] Watched toggle error: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.41c Get Favorites API (v3.8) -----
        Add-PodeRoute -Method Get -Path '/api/favorites' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            if (-not $user -or -not $user.Username) {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Not logged in" } -StatusCode 401
                return
            }
            
            try {
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                
                $favorites = Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT * FROM favorites ORDER BY added_date DESC
"@
                
                Write-PodeJsonResponse -Value @{ success = $true; favorites = @($favorites) }
            }
            catch {
                Write-Host "[✗] Get favorites error: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.41d Check Favorite/Watched Status API (v3.8) -----
        Add-PodeRoute -Method Get -Path '/api/media/status' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            if (-not $user -or -not $user.Username) {
                Write-PodeJsonResponse -Value @{ success = $false; error = "Not logged in" } -StatusCode 401
                return
            }
            
            try {
                $mediaType = $WebEvent.Query['mediaType']
                $mediaId = $WebEvent.Query['mediaId']
                
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                
                $isFavorite = $null -ne (Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 1 FROM favorites WHERE media_type = @mediaType AND media_id = @mediaId LIMIT 1
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId })
                
                $isWatched = $null -ne (Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 1 FROM watched WHERE media_type = @mediaType AND media_id = @mediaId LIMIT 1
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId })
                
                Write-PodeJsonResponse -Value @{ 
                    success = $true
                    isFavorite = $isFavorite
                    isWatched = $isWatched
                }
            }
            catch {
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.41e Check Favorite Status API (v6.99) -----
        Add-PodeRoute -Method Get -Path '/api/favorite/check' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            if (-not $user -or -not $user.Username) {
                Write-PodeJsonResponse -Value @{ isFavorite = $false }
                return
            }
            
            try {
                $mediaType = $WebEvent.Query['mediaType']
                $mediaId = $WebEvent.Query['mediaId']
                
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                
                $isFavorite = $null -ne (Invoke-SqliteQuery -DataSource $userDbPath -Query @"
SELECT 1 FROM favorites WHERE media_type = @mediaType AND media_id = @mediaId LIMIT 1
"@ -SqlParameters @{ mediaType = $mediaType; mediaId = $mediaId })
                
                Write-PodeJsonResponse -Value @{ isFavorite = $isFavorite }
            }
            catch {
                Write-PodeJsonResponse -Value @{ isFavorite = $false }
            }
        }
        
        Add-PodeRoute -Method Get -Path '/stream/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            $videoId = $WebEvent.Parameters['id']
            
            $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                -Query "SELECT filepath, format, size_bytes FROM videos WHERE id = @id" `
                -SqlParameters @{ id = $videoId }
            
            if (-not $video -or -not (Test-Path -LiteralPath $video.filepath)) {
                Set-PodeResponseStatus -Code 404
                return
            }
            
            $filePath = $video.filepath
            
            $contentType = switch ($video.format.ToLower()) {
                'mp4'  { 'video/mp4' }
                'mkv'  { 'video/x-matroska' }
                'avi'  { 'video/x-msvideo' }
                'webm' { 'video/webm' }
                'mov'  { 'video/quicktime' }
                default { 'video/mp4' }
            }
            
            # Use shared RFC 7233 compliant streaming function
            # CRITICAL: Never modify requested Range - video.js requires exact range responses
            Send-StreamedFileResponse -WebEvent $WebEvent -FilePath $filePath -ContentType $contentType
        }
        
        # ----- 3.43 API: Stream Info (Check if transcode needed) -----
        Add-PodeRoute -Method Get -Path '/api/stream-info/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $Global:FFmpegCapabilities = Get-PodeState -Name 'FFmpegCapabilities'
            $Global:TranscodingConfig = Get-PodeState -Name 'TranscodingConfig'
            $Global:ActiveTranscodes = Get-PodeState -Name 'ActiveTranscodes'
            
            $videoId = $WebEvent.Parameters['id']
            $selectedAudioTrack = if ($WebEvent.Query['audioTrack']) { [int]$WebEvent.Query['audioTrack'] } else { 0 }
            
            $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                -Query "SELECT id, filepath, format, duration FROM videos WHERE id = @id" `
                -SqlParameters @{ id = $videoId }
            
            if ($video -and (Test-Path -LiteralPath $video.filepath)) {
                # Use Get-SmartVideoStream which handles all modes (direct, remux, transcode)
                $streamInfo = Get-SmartVideoStream -FilePath $video.filepath -VideoId $videoId -AudioTrackIndex $selectedAudioTrack
                
                # Get duration from database or transcode info
                $videoDuration = 0
                if ($video.duration) {
                    $videoDuration = [double]$video.duration
                }
                # If transcoding, get duration from active transcode info
                if ($streamInfo -and $streamInfo.TranscodeId -and $Global:ActiveTranscodes.ContainsKey($streamInfo.TranscodeId)) {
                    $transcodeInfo = $Global:ActiveTranscodes[$streamInfo.TranscodeId]
                    if ($transcodeInfo.Duration -and $transcodeInfo.Duration -gt 0) {
                        $videoDuration = $transcodeInfo.Duration
                    }
                }
                
                if ($streamInfo) {
                    if ($streamInfo.Mode -eq "direct" -or $streamInfo.Mode -eq "direct-fallback") {
                        # Direct streaming - no FFmpeg needed
                        Write-PodeJsonResponse -Value @{ 
                            type = "direct"
                            duration = $videoDuration
                        }
                    }
                    elseif ($streamInfo.PlaylistURL) {
                        # HLS streaming (remux or transcode)
                        # Include duration so client can enable DVR-style seeking
                        Write-PodeJsonResponse -Value @{
                            type = "hls"
                            playlistUrl = $streamInfo.PlaylistURL
                            transcodeId = $streamInfo.TranscodeId
                            mode = $streamInfo.Mode
                            duration = $videoDuration  # CRITICAL: enables DVR-style seeking in video.js
                        }
                    }
                    else {
                        # Fallback to direct if something unexpected happened
                        Write-Host "[!] Unexpected streamInfo, falling back to direct" -ForegroundColor Yellow
                        Write-PodeJsonResponse -Value @{ type = "direct"; duration = $videoDuration }
                    }
                } else {
                    Set-PodeResponseStatus -Code 500
                    Write-PodeJsonResponse -Value @{ error = "Failed to determine streaming mode" }
                }
            }
            else {
                Set-PodeResponseStatus -Code 404
                Write-PodeJsonResponse -Value @{
                    error = if ($video) { "Video file not found" } else { "Video not in database" }
                }
            }
        }
        
        Add-PodeRoute -Method Get -Path '/hls/:transcodeId/playlist.m3u8' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $Global:ActiveTranscodes = Get-PodeState -Name 'ActiveTranscodes'
            $transcodeId = $WebEvent.Parameters['transcodeId']
            
            # CRITICAL: $PSScriptRoot is EMPTY in Pode runspaces!
            $scriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { 
                $Global:CONFIG.ScriptRoot 
            } else { 
                "C:\NexusM" ## Use variable next version!
            }
            
            # Check if transcode exists in ActiveTranscodes
            $inActiveTranscodes = $Global:ActiveTranscodes -and $Global:ActiveTranscodes.ContainsKey($transcodeId)
            
            # For music videos (mv- prefix) or regular videos, also check if cached playlist exists
            $hlsCacheFolder = Join-Path $scriptRoot "hls_cache"
            $cachedHlsDir = Join-Path $hlsCacheFolder $transcodeId
            $cachedPlaylistPath = Join-Path $cachedHlsDir "playlist.m3u8"
            $hasCachedPlaylist = Test-Path $cachedPlaylistPath
            
            if (-not $inActiveTranscodes -and -not $hasCachedPlaylist) {
                Write-Host "[HLS] Transcode not found and no cache: $transcodeId" -ForegroundColor Red
                Set-PodeResponseStatus -Code 404
                return
            }
            
            # Determine HLS directory
            $hlsDir = $null
            $playlistPath = $null
            $transcodeInfo = $null
            
            if ($inActiveTranscodes) {
                $transcodeInfo = $Global:ActiveTranscodes[$transcodeId]
                
                # v3.6: Get HLS directory from transcodeInfo (supports both hls_cache and hls_temp)
                $hlsDir = if ($transcodeInfo.HLSDirectory) {
                    $transcodeInfo.HLSDirectory
                } else {
                    # Fallback to old path
                    Join-Path $scriptRoot "hls_temp\$transcodeId"
                }
                $playlistPath = Join-Path $hlsDir "playlist.m3u8"
            }
            elseif ($hasCachedPlaylist) {
                # Use cached playlist directly
                $hlsDir = $cachedHlsDir
                $playlistPath = $cachedPlaylistPath
                
                # Check if playlist is complete (has #EXT-X-ENDLIST)
                $playlistContent = Get-Content -Path $playlistPath -Raw -ErrorAction SilentlyContinue
                if ($playlistContent -and $playlistContent -match '#EXT-X-ENDLIST') {
                    # Cached and complete - serve immediately
                    Add-PodeHeader -Name 'Content-Type' -Value 'application/vnd.apple.mpegurl'
                    Add-PodeHeader -Name 'Cache-Control' -Value 'no-cache'
                    Write-PodeTextResponse -Value $playlistContent
                    return
                }
            }
            
            
            $waited = 0
            $maxWait = 30  # 30 seconds max wait for first segment (full transcode can be slow)
            $hlsReady = $false
            
            while ($waited -lt $maxWait -and -not $hlsReady) {
                # Re-check ActiveTranscodes from Pode state (may have been updated)
                $Global:ActiveTranscodes = Get-PodeState -Name 'ActiveTranscodes'
                $inActiveTranscodes = $Global:ActiveTranscodes -and $Global:ActiveTranscodes.ContainsKey($transcodeId)
                
                # Check 1: Playlist exists with segment entries (works for both active and cached)
                if (Test-Path $playlistPath) {
                    $playlistContent = Get-Content -Path $playlistPath -Raw -ErrorAction SilentlyContinue
                    if ($playlistContent -and $playlistContent -match '#EXTINF') {
                        # Playlist is ready
                        $hlsReady = $true
                        break
                    }
                }
                
                $segmentFiles = Get-ChildItem -Path $hlsDir -Filter '*.m4s' -ErrorAction SilentlyContinue
                if (-not $segmentFiles) {
                    $segmentFiles = Get-ChildItem -Path $hlsDir -Filter '*.ts' -ErrorAction SilentlyContinue
                }
                # Also check for init.mp4 (fMP4 initialization segment)
                $initFile = Join-Path $hlsDir "init.mp4"
                $hasInit = Test-Path $initFile
                
                if (($segmentFiles -and $segmentFiles.Count -gt 0) -or $hasInit) {
                    
                    # If segments exist but no playlist after 5s, log it
                    if ($waited -gt 5 -and -not (Test-Path $playlistPath)) {
                        Write-NexusMLog "HLS: Segments exist but playlist delayed for $transcodeId" -Level "WARNING"
                    }
                }
                
                # Check 3: If we have transcodeInfo, check if FFmpeg process is still alive
                if ($transcodeInfo -and $transcodeInfo.Process) {
                    $processAlive = $false
                    try {
                        $processAlive = -not $transcodeInfo.Process.HasExited
                    } catch {
                        $processAlive = $false
                    }
                    
                    if (-not $processAlive -and $waited -gt 3 -and -not (Test-Path $playlistPath)) {
                        # Process died and no playlist - check if there are segments at least
                        $hasSegments = ($segmentFiles -and $segmentFiles.Count -gt 0)
                        if (-not $hasSegments) {
                            Write-Host "[HLS] FFmpeg process died without creating files" -ForegroundColor Red
                            Set-PodeResponseStatus -Code 500
                            return
                        }
                    }
                }
                
                # If not in ActiveTranscodes but folder exists with content, keep waiting for playlist
                if (-not $inActiveTranscodes -and -not $transcodeInfo) {
                    # Check if we have any content in the cache folder
                    $hasAnyContent = (Test-Path $playlistPath) -or ($segmentFiles -and $segmentFiles.Count -gt 0)
                    if (-not $hasAnyContent -and $waited -gt 5) {
                        # No active transcode and no cached content - give up
                        Write-Host "[HLS] No active transcode and no cached content: $transcodeId" -ForegroundColor Yellow
                        Set-PodeResponseStatus -Code 404
                        return
                    }
                }
                
                Start-Sleep -Milliseconds 500
                $waited += 0.5
            }
            
            # Final check - serve playlist if it exists
            if (Test-Path $playlistPath) {
                $content = Get-Content -Path $playlistPath -Raw
                
                # Verify playlist has content
                if (-not $content -or $content.Length -lt 10) {
                    Write-Host "[HLS] Playlist file exists but is empty/invalid" -ForegroundColor Yellow
                    # Wait a bit more and retry once
                    Start-Sleep -Milliseconds 500
                    $content = Get-Content -Path $playlistPath -Raw -ErrorAction SilentlyContinue
                }
                
                if ($content -and $content.Length -gt 10) {
                    # Check if FFmpeg is still running
                    $processRunning = $false
                    if ($transcodeInfo.Process) {
                        try {
                            $processRunning = -not $transcodeInfo.Process.HasExited
                        } catch {
                            $processRunning = $false
                        }
                    }
                    
                    if (-not $processRunning -and $content -notmatch '#EXT-X-ENDLIST') {
                        # Remove EVENT type and add VOD type + ENDLIST
                        $content = $content -replace '#EXT-X-PLAYLIST-TYPE:EVENT', '#EXT-X-PLAYLIST-TYPE:VOD'
                        $content = $content.TrimEnd() + "`n#EXT-X-ENDLIST`n"
                        
                        try {
                            $tempPlaylist = "$playlistPath.tmp"
                            [System.IO.File]::WriteAllText($tempPlaylist, $content, [System.Text.Encoding]::UTF8)
                            
                            # Atomic rename (overwrites existing)
                            [System.IO.File]::Delete($playlistPath)
                            [System.IO.File]::Move($tempPlaylist, $playlistPath)
                            
                            Write-Host "[HLS] Converted playlist to VOD (transcode complete) - saved to disk" -ForegroundColor Green
                        }
                        catch {
                            Write-Host "[HLS] Warning: Could not persist VOD playlist: $_" -ForegroundColor Yellow
                            # Continue anyway - we still have the modified content in memory
                        }
                        
                        if ($Global:TranscodingConfig.HLSCacheEnabled -and $Global:HLSCacheDBPath) {
                            # Calculate total size of cached files
                            $cacheSize = 0
                            $segmentCount = 0
                            if (Test-Path $hlsDir) {
                                $files = Get-ChildItem -Path $hlsDir -File -ErrorAction SilentlyContinue
                                $cacheSize = ($files | Measure-Object -Property Length -Sum).Sum
                                $segmentCount = ($files | Where-Object { $_.Extension -in @('.m4s', '.ts') }).Count
                            }
                            
                            Update-HLSCacheEntry -TranscodeId $transcodeId -SegmentCount $segmentCount `
                                -TotalSizeBytes $cacheSize -Completed $true
                            Write-NexusMLog "HLS cache entry updated: $transcodeId (completed, $([math]::Round($cacheSize / 1MB, 1)) MB)"
                        }
                        
                        if ($transcodeInfo -and $transcodeInfo.FromCache -ne $true) {
                            $semaphore = $Global:TranscodeSemaphore
                            if (-not $semaphore) {
                                try { $semaphore = Get-PodeState -Name 'TranscodeSemaphore' } catch { }
                            }
                            if ($semaphore) {
                                try {
                                    $semaphore.Release()
                                    Write-NexusMLog "Transcode semaphore released for completed: $transcodeId"
                                } catch { }
                            }
                            
                            # Mark as complete in ActiveTranscodes to prevent double-release
                            if ($Global:ActiveTranscodes -and $Global:ActiveTranscodes.ContainsKey($transcodeId)) {
                                $Global:ActiveTranscodes[$transcodeId].IsComplete = $true
                            }
                        }
                    }
                    
                    Add-PodeHeader -Name 'Cache-Control' -Value 'no-cache, no-store, must-revalidate'
                    Add-PodeHeader -Name 'Content-Type' -Value 'application/vnd.apple.mpegurl'
                    Add-PodeHeader -Name 'Access-Control-Allow-Origin' -Value '*'
                    
                    Write-PodeTextResponse -Value $content -ContentType 'application/vnd.apple.mpegurl'
                    return
                }
            }
            
            # If we get here, HLS failed to start
            Write-Host "[HLS] Playlist NOT FOUND after ${waited}s: $playlistPath" -ForegroundColor Red
            
            # Log what files DO exist for debugging
            if (Test-Path $hlsDir) {
                $files = Get-ChildItem -Path $hlsDir -ErrorAction SilentlyContinue
                Write-Host "[HLS] Files in HLS dir: $($files.Name -join ', ')" -ForegroundColor Gray
            }
            
            Set-PodeResponseStatus -Code 404
        }
        
        # ----- 3.45 HLS Segment Route -----
        # Supports both fMP4/CMAF (.m4s, init.mp4) and legacy MPEG-TS (.ts)
        Add-PodeRoute -Method Get -Path '/hls/:transcodeId/:segment' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $Global:ActiveTranscodes = Get-PodeState -Name 'ActiveTranscodes'
            $transcodeId = $WebEvent.Parameters['transcodeId']
            $segment = $WebEvent.Parameters['segment']
            
            # CRITICAL: $PSScriptRoot is EMPTY in Pode runspaces!
            $scriptRoot = if ($Global:CONFIG -and $Global:CONFIG.ScriptRoot) { 
                $Global:CONFIG.ScriptRoot 
            } else { 
                "C:\NexusM" ## Use variable next version!
            }
            
            # v3.6: Get HLS directory from transcodeInfo (supports both hls_cache and hls_temp)
            $hlsDir = $null
            if ($Global:ActiveTranscodes -and $Global:ActiveTranscodes.ContainsKey($transcodeId)) {
                $transcodeInfo = $Global:ActiveTranscodes[$transcodeId]
                $hlsDir = $transcodeInfo.HLSDirectory
            }
            if (-not $hlsDir) {
                # Check hls_cache first (for music videos and cached transcodes)
                $cacheDir = Join-Path $scriptRoot "hls_cache\$transcodeId"
                if (Test-Path $cacheDir) {
                    $hlsDir = $cacheDir
                } else {
                    # Fallback to hls_temp
                    $hlsDir = Join-Path $scriptRoot "hls_temp\$transcodeId"
                }
            }
            
            # Validate segment name pattern (supports fMP4/CMAF and MPEG-TS)
            $validSegment = $false
            $contentType = 'video/mp4'  # Default for fMP4
            
            if ($segment -eq "init.mp4") {
                $validSegment = $true
                $contentType = 'video/mp4'
            }
            # fMP4/CMAF media segment: {transcodeId}N.m4s
            elseif ($segment -match "^$([regex]::Escape($transcodeId))\d+\.m4s$") {
                $validSegment = $true
                $contentType = 'video/mp4'
            }
            # Legacy: fMP4 init segment {transcodeId}-1.mp4
            elseif ($segment -match "^$([regex]::Escape($transcodeId))-1\.mp4$") {
                $validSegment = $true
                $contentType = 'video/mp4'
            }
            # Legacy: fMP4 regular segment {transcodeId}N.mp4
            elseif ($segment -match "^$([regex]::Escape($transcodeId))\d+\.mp4$") {
                $validSegment = $true
                $contentType = 'video/mp4'
            }
            # Legacy: MPEG-TS segment {transcodeId}N.ts
            elseif ($segment -match "^$([regex]::Escape($transcodeId))\d+\.ts$") {
                $validSegment = $true
                $contentType = 'video/mp2t'  # Correct MIME type for MPEG-TS
            }
            # Music video style: segmentN.ts (used by music video HLS remux)
            elseif ($segment -match "^segment\d+\.ts$") {
                $validSegment = $true
                $contentType = 'video/mp2t'
            }
            
            if (-not $validSegment) {
                Set-PodeResponseStatus -Code 404
                return
            }
            
            $segmentPath = Join-Path $hlsDir $segment
            
            if (Test-Path $segmentPath) {
                Add-PodeHeader -Name 'Cache-Control' -Value 'public, max-age=31536000'
                Add-PodeHeader -Name 'Content-Type' -Value $contentType
                
                # Use buffered streaming instead of ReadAllBytes for better memory efficiency
                try {
                    $fileInfo = Get-Item -LiteralPath $segmentPath
                    Add-PodeHeader -Name 'Content-Length' -Value $fileInfo.Length.ToString()
                    
                    $fileStream = [System.IO.File]::OpenRead($segmentPath)
                    try {
                        $bufferSize = 65536  # 64KB buffer for segments
                        $buffer = New-Object byte[] $bufferSize
                        $outputStream = $WebEvent.Response.OutputStream
                        
                        while ($true) {
                            $bytesRead = $fileStream.Read($buffer, 0, $bufferSize)
                            if ($bytesRead -le 0) { break }
                            $outputStream.Write($buffer, 0, $bytesRead)
                        }
                        
                        $outputStream.Flush()
                    }
                    finally {
                        $fileStream.Close()
                        $fileStream.Dispose()
                    }
                }
                catch {
                    # Client disconnected
                }
            }
            else {
                Set-PodeResponseStatus -Code 404
            }
        }
        
        # ----- 3.46 API: Stop Transcode -----
        Add-PodeRoute -Method Get -Path '/api/stop-transcode/:transcodeId' -ScriptBlock {
            $transcodeId = $WebEvent.Parameters['transcodeId']
            
            # v7.40 FIX: Retrieve ActiveTranscodes from Pode state (required for cross-runspace access)
            $Global:ActiveTranscodes = Get-PodeState -Name 'ActiveTranscodes'
            
            if ($Global:ActiveTranscodes -and $Global:ActiveTranscodes.ContainsKey($transcodeId)) {
                $transcodeInfo = $Global:ActiveTranscodes[$transcodeId]
                
                # v7.40: Use PID-based killing for cross-runspace reliability
                # The Process object may not work correctly across runspaces, but PID always works
                $processKilled = $false
                $wasActiveTranscode = $transcodeInfo.FromCache -ne $true -and ($transcodeInfo.ProcessId -or $transcodeInfo.Process)
                
                # Try PID-based killing first (more reliable across runspaces)
                if ($transcodeInfo.ProcessId) {
                    $pid = $transcodeInfo.ProcessId
                    try {

                        $processKilled = $true
                        Write-Host "[✓] Stopped FFmpeg transcode (PID: $pid) via taskkill" -ForegroundColor Green
                    } catch {
                        # Fallback to .NET Kill if taskkill fails
                        try {
                            $ffmpegProcess = Get-Process -Id $pid -ErrorAction SilentlyContinue
                            if ($ffmpegProcess -and -not $ffmpegProcess.HasExited) {
                                $ffmpegProcess.Kill()
                                $ffmpegProcess.WaitForExit(2000) | Out-Null
                                $processKilled = $true
                                Write-Host "[✓] Stopped FFmpeg transcode (PID: $pid) via .Kill()" -ForegroundColor Green
                            }
                        } catch { }
                    }
                }
                
                # Fallback: Try the Process object if PID didn't work
                if (-not $processKilled -and $transcodeInfo.Process) {
                    try {
                        if (-not $transcodeInfo.Process.HasExited) {
                            $transcodeInfo.Process.Kill()
                            Start-Sleep -Milliseconds 500
                        }
                    } catch { }
                }
                
                # v7.45: Release semaphore if this was an active transcode (not from cache)
                if ($wasActiveTranscode -and $transcodeInfo.IsComplete -ne $true) {
                    $semaphore = Get-PodeState -Name 'TranscodeSemaphore'
                    if ($semaphore) {
                        try {
                            $semaphore.Release()
                            Write-NexusMLog "Transcode semaphore released for stopped: $transcodeId"
                        } catch { }
                    }
                }
                
                # Remove from active transcodes
                $Global:ActiveTranscodes.TryRemove($transcodeId, [ref]$null) | Out-Null
                
                # v7.15 FIX: Only clean up TEMP directories, NOT cache directories
                # Cache folders should persist for reuse on next play
                $hlsDir = $transcodeInfo.HLSDirectory
                if ($hlsDir -and (Test-Path $hlsDir)) {
                    $isCache = $hlsDir -match '[/\\]hls_cache[/\\]'
                    $fromCache = $transcodeInfo.FromCache -eq $true
                    
                    if (-not $isCache -and -not $fromCache) {
                        Remove-Item -Path $hlsDir -Recurse -Force -ErrorAction SilentlyContinue
                    }
                }
            }
            
            # Always return success (204 No Content)
            Set-PodeResponseStatus -Code 204
        }
        
        # Also handle POST for sendBeacon compatibility
        Add-PodeRoute -Method Post -Path '/api/stop-transcode/:transcodeId' -ScriptBlock {
            $transcodeId = $WebEvent.Parameters['transcodeId']
            
            # v7.40 FIX: Retrieve ActiveTranscodes from Pode state (required for cross-runspace access)
            $Global:ActiveTranscodes = Get-PodeState -Name 'ActiveTranscodes'
            
            if ($Global:ActiveTranscodes -and $Global:ActiveTranscodes.ContainsKey($transcodeId)) {
                $transcodeInfo = $Global:ActiveTranscodes[$transcodeId]
                
                # v7.40: Use PID-based killing for cross-runspace reliability
                $processKilled = $false
                $wasActiveTranscode = $transcodeInfo.FromCache -ne $true -and ($transcodeInfo.ProcessId -or $transcodeInfo.Process)
                
                # Try PID-based killing first (more reliable across runspaces)
                if ($transcodeInfo.ProcessId) {
                    $pid = $transcodeInfo.ProcessId
                    try {

                        $processKilled = $true
                        Write-Host "[✓] Stopped FFmpeg transcode (PID: $pid) via taskkill" -ForegroundColor Green
                    } catch {
                        # Fallback to .NET Kill if taskkill fails
                        try {
                            $ffmpegProcess = Get-Process -Id $pid -ErrorAction SilentlyContinue
                            if ($ffmpegProcess -and -not $ffmpegProcess.HasExited) {
                                $ffmpegProcess.Kill()
                                $ffmpegProcess.WaitForExit(2000) | Out-Null
                                $processKilled = $true
                                Write-Host "[✓] Stopped FFmpeg transcode (PID: $pid) via .Kill()" -ForegroundColor Green
                            }
                        } catch { }
                    }
                }
                
                # Fallback: Try the Process object if PID didn't work
                if (-not $processKilled -and $transcodeInfo.Process) {
                    try {
                        if (-not $transcodeInfo.Process.HasExited) {
                            $transcodeInfo.Process.Kill()
                            Start-Sleep -Milliseconds 500
                        }
                    } catch { }
                }
                
                # v7.45: Release semaphore if this was an active transcode (not from cache)
                if ($wasActiveTranscode -and $transcodeInfo.IsComplete -ne $true) {
                    $semaphore = Get-PodeState -Name 'TranscodeSemaphore'
                    if ($semaphore) {
                        try {
                            $semaphore.Release()
                            Write-NexusMLog "Transcode semaphore released for stopped: $transcodeId"
                        } catch { }
                    }
                }
                
                $Global:ActiveTranscodes.TryRemove($transcodeId, [ref]$null) | Out-Null
                
                # v7.15 FIX: Only clean up TEMP directories, NOT cache directories
                $hlsDir = $transcodeInfo.HLSDirectory
                if ($hlsDir -and (Test-Path $hlsDir)) {
                    $isCache = $hlsDir -match '[/\\]hls_cache[/\\]'
                    $fromCache = $transcodeInfo.FromCache -eq $true
                    
                    if (-not $isCache -and -not $fromCache) {
                        Remove-Item -Path $hlsDir -Recurse -Force -ErrorAction SilentlyContinue
                    }
                }
            }
            
            Set-PodeResponseStatus -Code 204
        }
        
        # ----- 3.46a API: Track Music Play -----
        Add-PodeRoute -Method Post -Path '/api/track/music' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            try {
                # Handle both regular POST and sendBeacon (which sends as text/plain)
                $data = $WebEvent.Data
                if (-not $data -or ($data.Count -eq 0)) {
                    # Try parsing from raw body (sendBeacon sends as text/plain)
                    # $WebEvent.Request.Body is a Stream, need to read it with StreamReader
                    $bodyStream = $WebEvent.Request.Body
                    if ($bodyStream -and $bodyStream.CanRead) {
                        try {
                            $reader = [System.IO.StreamReader]::new($bodyStream)
                            $rawBody = $reader.ReadToEnd()
                            if ($rawBody) {
                                $data = $rawBody | ConvertFrom-Json
                            }
                        } catch {
                            Write-Host "[!] Failed to parse beacon body: $_" -ForegroundColor Yellow
                        }
                    }
                }
                
                if ($user -and $user.Username) {
                    $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                    
                    $musicPath = $data.path
                    $artist = $data.artist
                    $title = $data.title
                    $album = $data.album
                    $playTime = if ($data.playTime) { [double]$data.playTime } else { 0 }
                    
                    if (-not [string]::IsNullOrWhiteSpace($musicPath)) {
                        $upsertQuery = @"
INSERT INTO music_history (music_path, artist, title, album, play_count, last_played, total_play_time_seconds)
VALUES (@music_path, @artist, @title, @album, 1, @timestamp, @play_time)
ON CONFLICT(music_path) DO UPDATE SET
    play_count = play_count + 1,
    last_played = @timestamp,
    total_play_time_seconds = total_play_time_seconds + @play_time,
    artist = COALESCE(@artist, artist),
    title = COALESCE(@title, title),
    album = COALESCE(@album, album);
"@
                        
                        $params = @{
                            music_path = $musicPath
                            artist = $artist
                            title = $title
                            album = $album
                            timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
                            play_time = $playTime
                        }
                        
                        Invoke-SqliteQuery -DataSource $userDbPath -Query $upsertQuery -SqlParameters $params
                        Write-Host "[✓] Music tracked: $title by $artist (${playTime}s)" -ForegroundColor Green
                        Write-PodeJsonResponse -Value @{ success = $true }
                    } else {
                        Write-Host "[!] Music tracking failed: empty path" -ForegroundColor Yellow
                        Write-PodeJsonResponse -Value @{ success = $false; error = "Music path required" }
                    }
                } else {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Not authenticated" }
                }
            }
            catch {
                Write-Host "[✗] Music tracking error: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.46b API: Track Radio Listen -----
        Add-PodeRoute -Method Post -Path '/api/track/radio' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            try {
                # Handle both regular POST and sendBeacon (which sends as text/plain)
                $data = $WebEvent.Data
                if (-not $data -or ($data.Count -eq 0)) {
                    # Try parsing from raw body (sendBeacon sends as text/plain)
                    # $WebEvent.Request.Body is a Stream, need to read it with StreamReader
                    $bodyStream = $WebEvent.Request.Body
                    if ($bodyStream -and $bodyStream.CanRead) {
                        try {
                            $reader = [System.IO.StreamReader]::new($bodyStream)
                            $rawBody = $reader.ReadToEnd()
                            if ($rawBody) {
                                $data = $rawBody | ConvertFrom-Json
                            }
                        } catch {
                            Write-Host "[!] Failed to parse beacon body: $_" -ForegroundColor Yellow
                        }
                    }
                }
                
                if ($user -and $user.Username) {
                    $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                    
                    $radioUrl = $data.url
                    $radioName = $data.name
                    $listenTime = if ($data.listenTime) { [double]$data.listenTime } else { 0 }
                    
                    if (-not [string]::IsNullOrWhiteSpace($radioUrl)) {
                        $upsertQuery = @"
INSERT INTO radio_history (radio_url, radio_name, listen_count, last_listened, total_listen_time_seconds)
VALUES (@radio_url, @radio_name, 1, @timestamp, @listen_time)
ON CONFLICT(radio_url) DO UPDATE SET
    listen_count = listen_count + 1,
    last_listened = @timestamp,
    total_listen_time_seconds = total_listen_time_seconds + @listen_time,
    radio_name = COALESCE(@radio_name, radio_name);
"@
                        
                        $params = @{
                            radio_url = $radioUrl
                            radio_name = $radioName
                            timestamp = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
                            listen_time = $listenTime
                        }
                        
                        Invoke-SqliteQuery -DataSource $userDbPath -Query $upsertQuery -SqlParameters $params
                        Write-Host "[✓] Radio tracked: $radioName (${listenTime}s)" -ForegroundColor Green
                        Write-PodeJsonResponse -Value @{ success = $true }
                    } else {
                        Write-Host "[!] Radio tracking failed: empty URL" -ForegroundColor Yellow
                        Write-PodeJsonResponse -Value @{ success = $false; error = "Radio URL required" }
                    }
                } else {
                    Write-Host "[!] Radio tracking failed: not authenticated" -ForegroundColor Yellow
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Not authenticated" }
                }
            }
            catch {
                Write-Host "[✗] Radio tracking error: $_" -ForegroundColor Red
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.47 API: Track Video Progress -----
        Add-PodeRoute -Method Post -Path '/api/track/video' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            try {
                $data = $WebEvent.Data
                
                if ($user -and $user.Username) {
                    # If path is empty but we have ID, look up the path and other info
                    $videoPath = $data.path
                    $videoId = $data.id
                    $posterUrl = $data.posterUrl
                    $mediaType = $data.mediaType
                    
                    if ([string]::IsNullOrWhiteSpace($videoPath) -and $data.id) {
                        $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                            -Query "SELECT filepath, poster_url, media_type FROM videos WHERE id = @id" `
                            -SqlParameters @{ id = $data.id }
                        if ($video) {
                            $videoPath = $video.filepath
                            if (-not $posterUrl) { $posterUrl = $video.poster_url }
                            if (-not $mediaType) { $mediaType = $video.media_type }
                        }
                    }
                    
                    if (-not [string]::IsNullOrWhiteSpace($videoPath)) {
                        Update-VideoProgress `
                            -VideoPath $videoPath `
                            -PositionSeconds $data.position `
                            -DurationSeconds $data.duration `
                            -VideoTitle $data.title `
                            -VideoId $videoId `
                            -PosterUrl $posterUrl `
                            -MediaType $mediaType `
                            -UserSession $user
                        
                        Write-PodeJsonResponse -Value @{ success = $true }
                    } else {
                        Write-PodeJsonResponse -Value @{ success = $false; error = "Video path not found" }
                    }
                } else {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Not authenticated" }
                }
            }
            catch {
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.48 API: Get Video Progress -----
        Add-PodeRoute -Method Get -Path '/api/video/get-progress' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            $videoId = $WebEvent.Query['id']
            
            try {
                $result = @{ success = $false; position = 0 }
                
                if ($user -and $user.Username -and $videoId) {
                    $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                    
                    # Get video path first
                    $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                        -Query "SELECT filepath FROM videos WHERE id = @id" `
                        -SqlParameters @{ id = $videoId }
                    
                    if ($video) {
                        $progress = Invoke-SqliteQuery -DataSource $userDbPath `
                            -Query "SELECT * FROM video_progress WHERE video_path = @path OR video_id = @id LIMIT 1" `
                            -SqlParameters @{ path = $video.filepath; id = $videoId }
                        
                        if ($progress) {
                            if ($progress.last_position_seconds -gt 30 -and $progress.percent_watched -lt 90 -and $progress.completed -ne 1) {
                                $result = @{
                                    success = $true
                                    position = $progress.last_position_seconds
                                    duration = $progress.duration_seconds
                                    percent = $progress.percent_watched
                                    completed = $progress.completed
                                }
                            }
                            else {
                                $result = @{ success = $true; position = 0 }
                            }
                        }
                        else {
                            $result = @{ success = $true; position = 0 }
                        }
                    }
                }
                
                Write-PodeJsonResponse -Value $result
            }
            catch {
                Write-PodeJsonResponse -Value @{ success = $false; position = 0 }
            }
        }
        
        # ----- 3.49 API: Mark Video Watched/Unwatched -----
        Add-PodeRoute -Method Post -Path '/api/video/mark-watched' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            
            try {
                $data = $WebEvent.Data
                $result = @{ success = $false; error = "Unknown error" }
                
                if (-not $user -or -not $user.Username) {
                    Write-PodeJsonResponse -Value @{ success = $false; error = "Not authenticated" }
                    return
                }
                
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.Username).db"
                $videoId = $data.videoId
                $watched = $data.watched  # true = watched, false = unwatched
                
                # Get video info from main database
                $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                    -Query "SELECT * FROM videos WHERE id = @id" `
                    -SqlParameters @{ id = $videoId }
                
                if ($video) {
                    $now = (Get-Date).ToString("yyyy-MM-dd HH:mm:ss")
                    
                    if ($watched) {
                        # Mark as watched - set to 100% complete
                        Invoke-SqliteQuery -DataSource $userDbPath -Query @"
INSERT INTO video_progress (video_id, video_path, video_title, poster_url, media_type, last_position_seconds, duration_seconds, percent_watched, watch_count, last_watched, completed, manually_marked)
VALUES (@video_id, @video_path, @video_title, @poster_url, @media_type, @duration, @duration, 100, 1, @timestamp, 1, 1)
ON CONFLICT(video_path) DO UPDATE SET
    percent_watched = 100,
    completed = 1,
    manually_marked = 1,
    last_watched = @timestamp,
    watch_count = watch_count + 1;
"@ -SqlParameters @{
                            video_id = $videoId
                            video_path = $video.filepath
                            video_title = $video.title
                            poster_url = $video.poster_url
                            media_type = if ($video.media_type) { $video.media_type } else { "movie" }
                            duration = if ($video.duration) { $video.duration } else { 0 }
                            timestamp = $now
                        }
                    }
                    else {
                        # Mark as unwatched - reset progress
                        Invoke-SqliteQuery -DataSource $userDbPath -Query @"
UPDATE video_progress 
SET percent_watched = 0, 
    completed = 0, 
    manually_marked = 1,
    last_position_seconds = 0
WHERE video_path = @video_path OR video_id = @video_id;
"@ -SqlParameters @{ video_path = $video.filepath; video_id = $videoId }
                    }
                    
                    $result = @{ success = $true; watched = $watched }
                }
                else {
                    $result = @{ success = $false; error = "Video not found" }
                }
                
                Write-PodeJsonResponse -Value $result
            }
            catch {
                Write-PodeJsonResponse -Value @{ success = $false; error = $_.Exception.Message }
            }
        }
        
        # ----- 3.50 Video Player Page Route -----
        Add-PodeRoute -Method Get -Path '/player/:id' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            $user = $WebEvent.Session.Data.User
            $Global:CurrentUser = $user
            
            $videoId = $WebEvent.Parameters['id']
            
            $video = Invoke-SqliteQuery -DataSource $Global:CONFIG.MoviesDB `
                -Query "SELECT * FROM videos WHERE id = @id" `
                -SqlParameters @{ id = $videoId }
            
            if ($video) {
                $size = [math]::Round($video.size_bytes / 1GB, 2)
                $title = if ($video.title) { $video.title } else { [System.IO.Path]::GetFileNameWithoutExtension($video.filepath) }
                $titleEscaped = [System.Web.HttpUtility]::HtmlEncode($title)
                $titleJs = $title -replace "'", "\'" -replace '"', '\"'
                $filepathJs = $video.filepath -replace "'", "\'" -replace '"', '\"' -replace "\\", "\\\\"
                
                # Determine video format and MIME type for direct streaming fallback
                $format = $video.format.ToLower().TrimStart('.')
                $videoMimeType = switch ($format) {
                    'mp4'  { 'video/mp4' }
                    'webm' { 'video/webm' }
                    'ogg'  { 'video/ogg' }
                    default { 'video/mp4' }
                }
                
                # Parse audio tracks for pre-playback selection
                $audioTracksJson = "[]"
                $hasMultipleAudioTracks = $false
                if ($video.audio_tracks -and -not [string]::IsNullOrWhiteSpace($video.audio_tracks)) {
                    try {
                        $audioTracksData = $video.audio_tracks | ConvertFrom-Json
                        if ($audioTracksData -and $audioTracksData.Count -gt 1) {
                            $hasMultipleAudioTracks = $true
                            $audioTracksJson = $video.audio_tracks
                        }
                    }
                    catch {
                        Write-Verbose "Could not parse audio tracks for player: $_"
                    }
                }
                
                # v6.99: Variables for favorite button
                $mediaType = if ($video.is_tvseries -eq 1) { 'tv' } else { 'movie' }
                $posterUrlForFav = if ($video.poster_url) { ($video.poster_url -replace "'", "\'") } else { '' }
                
                $playerContent = @"
<link href="/videojs/video-js.min.css" rel="stylesheet" />

<div style='max-width:1400px; margin:40px auto; padding:20px;'>
  <h1 style='margin-bottom:10px;'>$titleEscaped</h1>
  <p style='color:rgba(255,255,255,0.6); margin-bottom:30px;'>$($video.format.ToUpper()) • ${size}GB</p>
  
  <div id='audio-selector-overlay' style='display:$(if ($hasMultipleAudioTracks) { "flex" } else { "none" }); position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:1000; align-items:center; justify-content:center; border-radius:12px;'>
    <div style='text-align:center; max-width:500px; padding:40px;'>
      <h2 style='color:#60a5fa; margin-bottom:12px; font-size:28px;'>🔊 Select Audio Track</h2>
      <p style='color:rgba(255,255,255,0.7); margin-bottom:32px; font-size:15px;'>Choose your preferred language before playback starts</p>
      <div id='audio-track-buttons' style='display:flex; flex-direction:column; gap:12px;'></div>
    </div>
  </div>
  
  <div style='position:relative; padding-bottom:56.25%; height:0; overflow:hidden; border-radius:12px; background:#000;'>
    <video id='my-video' controls preload='auto' 
           style='position:absolute; top:0; left:0; width:100%; height:100%;'>
      <p class='vjs-no-js'>
        To view this video please enable JavaScript, and consider upgrading to a web browser that
        <a href='https://videojs.com/html5-video-support/' target='_blank'>supports HTML5 video</a>
      </p>
    </video>
    <!-- v6.99: Favorite button overlay -->
    <button id='videoFavoriteBtn' class='video-player-favorite-btn' onclick='toggleVideoFavorite()' title='Add to Favorites'>
      <span id='videoFavIcon'>♡</span>
    </button>
  </div>
  
  <div style='margin-top:20px; padding:16px; background:rgba(96,165,250,.1); border:1px solid rgba(96,165,250,.2); border-radius:12px;'>
    <div style='display:grid; grid-template-columns:1fr auto; gap:16px; align-items:center;'>
      <div style='font-size:13px; color:white;'>
        <div style='margin-bottom:8px;'>
          <strong>Resolution:</strong> <span id='videoResolution'>Loading...</span> • 
          <strong>Duration:</strong> <span id='videoDuration'>--:--</span>
        </div>
        <div style='font-size:12px; color:rgba(255,255,255,0.6);'>
          <strong>Format:</strong> $($video.format.ToUpper()) • 
          <strong>Size:</strong> ${size}GB • 
          <strong>Player:</strong> Video.js + HLS
        </div>
      </div>
      <div style='font-size:12px; color:rgba(255,255,255,0.6); text-align:right;'>
        <div>⚙️ Settings for playback speed</div>
        <div style='margin-top:4px;'>⌨️ Space=Play F=Fullscreen M=Mute</div>
      </div>
    </div>
  </div>
  
  <div style='margin-top:20px; display:flex; gap:12px; flex-wrap:wrap;'>
    <a href='/stream/$videoId' download='$([System.Web.HttpUtility]::HtmlAttributeEncode($video.filename))' style='display:inline-block; padding:12px 24px; background:rgba(96,165,250,0.2); border:1px solid rgba(96,165,250,0.4); border-radius:8px; color:#60a5fa; text-decoration:none;'>
      ⬇️ Download File
    </a>
    <a href='/movie/$videoId' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>
      ← Back to Movie Info
    </a>
    <a href='/videos' style='display:inline-block; padding:12px 24px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:white; text-decoration:none;'>
      ← Back to Videos
    </a>
  </div>
</div>

<script src="/videojs/video.min.js"></script>
<script>
// Audio track data from server
var audioTracks = $audioTracksJson;
var selectedAudioTrack = 0;

// Populate audio track selector if multiple tracks exist
if (audioTracks.length > 1) {
    var buttonContainer = document.getElementById('audio-track-buttons');
    audioTracks.forEach(function(track, index) {
        var lang = track.language && track.language !== 'und' ? track.language.toUpperCase() : 'Track ' + (index + 1);
        var title = track.title || '';
        var channels = '';
        if (track.channels) {
            switch(track.channels) {
                case 1: channels = 'Mono'; break;
                case 2: channels = 'Stereo'; break;
                case 6: channels = '5.1'; break;
                case 8: channels = '7.1'; break;
                default: channels = track.channels + 'ch';
            }
        }
        
        var label = lang + (channels ? ' • ' + channels : '') + (title ? ' (' + title + ')' : '');
        
        var button = document.createElement('button');
        button.textContent = label;
        button.style.cssText = 'padding:16px 24px; background:linear-gradient(135deg, rgba(96,165,250,0.2), rgba(52,211,153,0.2)); border:2px solid rgba(96,165,250,0.4); border-radius:12px; color:#fff; font-size:16px; font-weight:600; cursor:pointer;';
        button.onclick = function() {
            selectedAudioTrack = index;
            hideAudioSelectorAndPlay();
        };
        buttonContainer.appendChild(button);
    });
}

function hideAudioSelectorAndPlay() {
    document.getElementById('audio-selector-overlay').style.display = 'none';
    console.log('Selected audio track:', selectedAudioTrack);
    initializePlayer();
}

// If no audio selector needed, initialize immediately
if (audioTracks.length <= 1) {
    initializePlayer();
}

var playerInitialized = false;

function initializePlayer() {
    if (playerInitialized) {
        console.log('Player already initialized, skipping...');
        return;
    }
    playerInitialized = true;
    
    var videoEl = document.getElementById('my-video');
    videoEl.classList.add('video-js');
    videoEl.classList.add('vjs-big-play-centered');
    
    var player = videojs('my-video', {
        controls: true,
        autoplay: false,
        preload: 'auto',
        responsive: true,
        playbackRates: [0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2],
        liveui: false,  // CRITICAL: Disable live UI to allow seeking during HLS transcode
        liveTracker: {
            trackingThreshold: 0,  // Always show as seekable
            liveTolerance: 15      // Allow 15 seconds of live edge tolerance
        },
        html5: {
            vhs: {
                overrideNative: true,
                enableLowInitialPlaylist: true,  // Start with lower quality for faster startup
                smoothQualityChange: true,
                allowSeeksWithinUnsafeLiveWindow: true  // Allow seeking in live streams
            },
            nativeVideoTracks: false,
            nativeAudioTracks: false,
            nativeTextTracks: false
        }
    });
    
    // Track transcode ID for cleanup
    var currentTranscodeId = null;
    var videoId = '$videoId';
    var hlsDuration = 0;  // Store duration for DVR-style seeking
    
    // Check if video needs HLS transcoding
    fetch('/api/stream-info/' + videoId + '?audioTrack=' + selectedAudioTrack)
        .then(response => response.json())
        .then(data => {
            if (data.type === 'hls') {
                console.log('Loading HLS stream:', data.playlistUrl);
                console.log('Stream mode:', data.mode);
                currentTranscodeId = data.transcodeId;
                console.log('Tracking transcode:', currentTranscodeId);
                
                // Store duration for DVR-style seeking
                if (data.duration && data.duration > 0) {
                    hlsDuration = data.duration;
                    console.log('Video duration hint:', hlsDuration, 'seconds');
                }
                
                player.src({
                    src: data.playlistUrl,
                    type: 'application/x-mpegURL'
                });
                
                // Set duration hint after source is loaded (enables seeking during transcode)
                player.one('loadedmetadata', function() {
                    if (hlsDuration > 0) {
                        // Check if player thinks this is live (duration is Infinity)
                        var currentDuration = player.duration();
                        console.log('Player reports duration:', currentDuration);
                        
                        if (!isFinite(currentDuration) || currentDuration <= 0) {
                            console.log('Setting DVR duration hint:', hlsDuration);
                            // Override the duration for DVR-style seeking
                            try {
                                player.duration(hlsDuration);
                            } catch(e) {
                                console.log('Could not set duration directly, using tech');
                            }
                        }
                    }
                });
                
            } else if (data.type === 'direct') {
                console.log('Using direct stream');
                player.src({
                    src: '/stream/$videoId',
                    type: '$videoMimeType'
                });
            } else if (data.error) {
                console.error('Stream info error:', data.error);
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error checking stream type:', error);
            // Fallback to direct stream
            player.src({
                src: '/stream/$videoId',
                type: '$videoMimeType'
            });
        });
    
    // Display video information when metadata loads
    player.on('loadedmetadata', function() {
        var videoWidth = player.videoWidth();
        var videoHeight = player.videoHeight();
        var resolution = videoWidth + 'x' + videoHeight + ' (' + videoHeight + 'p)';
        document.getElementById('videoResolution').textContent = resolution;
        
        var duration = player.duration();
        var minutes = Math.floor(duration / 60);
        var seconds = Math.floor(duration % 60);
        document.getElementById('videoDuration').textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
        
        // Check for saved position
        var urlParams = new URLSearchParams(window.location.search);
        var autoResume = urlParams.get('resume') === '1';
        
        fetch('/api/video/get-progress?id=' + videoId)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success && data.position > 0 && data.position < duration - 30) {
                    if (autoResume) {
                        console.log('Auto-resuming from position:', data.position);
                        player.currentTime(data.position);
                        player.play();
                    } else {
                        showResumeDialog(data.position, data.percent);
                    }
                }
            })
            .catch(function(err) { console.error('Error checking progress:', err); });
    });
    
    function formatTimeForDisplay(seconds) {
        var hrs = Math.floor(seconds / 3600);
        var mins = Math.floor((seconds % 3600) / 60);
        var secs = Math.floor(seconds % 60);
        if (hrs > 0) {
            return hrs + ':' + String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
        }
        return mins + ':' + String(secs).padStart(2, '0');
    }
    
    function showResumeDialog(position, percent) {
        var dialog = document.createElement('div');
        dialog.id = 'resumeDialog';
        dialog.style.cssText = 'position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:1000;';
        dialog.innerHTML = 
            '<div style="background:rgba(30,40,35,0.98); border:1px solid rgba(255,255,255,0.1); border-radius:16px; padding:32px; text-align:center; max-width:400px;">' +
                '<div style="font-size:48px; margin-bottom:16px;">▶️</div>' +
                '<h3 style="color:#fff; margin:0 0 8px 0; font-size:20px;">Resume Watching?</h3>' +
                '<p style="color:rgba(255,255,255,0.7); margin:0 0 24px 0;">You were at <strong style="color:#ef4444;">' + formatTimeForDisplay(position) + '</strong> (' + Math.round(percent) + '% watched)</p>' +
                '<div style="display:flex; gap:12px; justify-content:center;">' +
                    '<button id="resumeBtn" style="padding:12px 24px; background:#ef4444; color:#fff; border:none; border-radius:8px; font-size:15px; font-weight:600; cursor:pointer;">Resume</button>' +
                    '<button id="startOverBtn" style="padding:12px 24px; background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); border-radius:8px; font-size:15px; cursor:pointer;">Start Over</button>' +
                '</div>' +
            '</div>';
        
        player.el().appendChild(dialog);
        
        document.getElementById('resumeBtn').onclick = function() {
            dialog.remove();
            player.currentTime(position);
            player.play();
        };
        
        document.getElementById('startOverBtn').onclick = function() {
            dialog.remove();
            player.currentTime(0);
            player.play();
        };
    }
    
    // Error handling
    player.on('error', function() {
        var error = player.error();
        console.error('Playback error:', error);
        
        if (error && error.code === 4) {
            var errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; color:white; padding:20px; background:rgba(0,0,0,0.8); border-radius:12px;';
            errorDiv.innerHTML = '<h3>Format Not Supported</h3><p>This video format cannot be played in the browser.</p><p><a href="/stream/$videoId" download style="color:#60a5fa;">Download the file</a> and use VLC.</p>';
            player.el().appendChild(errorDiv);
        }
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key.toLowerCase()) {
            case ' ':
                e.preventDefault();
                if (player.paused()) player.play();
                else player.pause();
                break;
            case 'f':
                if (player.isFullscreen()) player.exitFullscreen();
                else player.requestFullscreen();
                break;
            case 'm':
                player.muted(!player.muted());
                break;
            case 'arrowleft':
                player.currentTime(player.currentTime() - 10);
                break;
            case 'arrowright':
                player.currentTime(player.currentTime() + 10);
                break;
        }
    });
    
    // Video progress tracking
    var videoPath = '$filepathJs';
    var videoTitle = '$titleJs';
    var lastTrackedPosition = 0;
    var trackingInterval;
    
    player.on('play', function() {
        if (trackingInterval) clearInterval(trackingInterval);
        
        trackingInterval = setInterval(function() {
            var currentTime = player.currentTime();
            var duration = player.duration();
            
            if (Math.abs(currentTime - lastTrackedPosition) > 5) {
                trackVideoProgress(currentTime, duration);
                lastTrackedPosition = currentTime;
            }
        }, 10000);
    });
    
    player.on('pause', function() {
        if (trackingInterval) {
            clearInterval(trackingInterval);
            trackingInterval = null;
        }
        trackVideoProgress(player.currentTime(), player.duration());
    });
    
    player.on('ended', function() {
        if (trackingInterval) {
            clearInterval(trackingInterval);
            trackingInterval = null;
        }
        trackVideoProgress(player.duration(), player.duration());
    });
    
    function trackVideoProgress(position, duration) {
        fetch('/api/track/video', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                id: videoId,
                path: videoPath,
                title: videoTitle,
                position: position,
                duration: duration
            })
        }).catch(err => console.error('Tracking error:', err));
    }
    
    // Stop transcode when page unloads
    window.addEventListener('beforeunload', function() {
        if (player && !player.paused()) {
            navigator.sendBeacon('/api/track/video', JSON.stringify({
                id: videoId,
                path: videoPath,
                title: videoTitle,
                position: player.currentTime(),
                duration: player.duration()
            }));
        }
        
        if (currentTranscodeId) {
            navigator.sendBeacon('/api/stop-transcode/' + currentTranscodeId);
            console.log('Stopping transcode:', currentTranscodeId);
        }
    });
    
    window.addEventListener('pagehide', function() {
        if (currentTranscodeId) {
            navigator.sendBeacon('/api/stop-transcode/' + currentTranscodeId);
        }
    });
}
</script>

<style>
.video-js .vjs-big-play-button {
    background-color: rgba(96,165,250,0.9) !important;
    border: none !important;
    border-radius: 50% !important;
    width: 80px !important;
    height: 80px !important;
    line-height: 80px !important;
}
.video-js .vjs-big-play-button:hover {
    background-color: rgba(96,165,250,1) !important;
}

/* v6.99: Favorite button overlay on video player */
.video-player-favorite-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 100;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-size: 22px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(10px);
}

.video-player-favorite-btn:hover {
    background: rgba(0, 0, 0, 0.8);
    border-color: rgba(255, 255, 255, 0.5);
    transform: scale(1.1);
}

.video-player-favorite-btn.is-favorite {
    color: #ef4444;
    border-color: rgba(239, 68, 68, 0.5);
}

.video-player-favorite-btn.is-favorite:hover {
    border-color: #ef4444;
}
</style>

<script>
// v6.99: Video Favorite functionality
var videoFavoriteData = {
    mediaType: '$mediaType',
    mediaId: $videoId,
    title: '$titleJs',
    posterUrl: '$posterUrlForFav'
};

// Check if already favorited on load
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/favorite/check?mediaType=' + videoFavoriteData.mediaType + '&mediaId=' + videoFavoriteData.mediaId)
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.isFavorite) {
                var btn = document.getElementById('videoFavoriteBtn');
                var icon = document.getElementById('videoFavIcon');
                if (btn) btn.classList.add('is-favorite');
                if (icon) icon.textContent = '♥';
            }
        })
        .catch(function(err) { console.log('Favorite check error:', err); });
});

function toggleVideoFavorite() {
    var btn = document.getElementById('videoFavoriteBtn');
    var icon = document.getElementById('videoFavIcon');
    
    fetch('/api/favorite/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(videoFavoriteData)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.success) {
            if (data.isFavorite) {
                btn.classList.add('is-favorite');
                icon.textContent = '♥';
            } else {
                btn.classList.remove('is-favorite');
                icon.textContent = '♡';
            }
        }
    })
    .catch(function(err) { console.error('Favorite toggle error:', err); });
}
</script>
"@
                $html = Get-HTMLPage -Content $playerContent -Title "Playing: $title"
                Write-PodeHtmlResponse -Value $html
            }
            else {
                $html = Get-HTMLPage -Content "<h1>Video not found</h1><p><a href='/videos'>← Back to Videos</a></p>" -Title "Error"
                Write-PodeHtmlResponse -Value $html
            }
        }
        
       
        # ----- 1.1 Favicon Route -----
        # Pre-resolve the favicon path outside the scriptblock
        $config = Get-MediaConfig
        $faviconFullPath = Join-Path $config.ScriptRoot "favicon.ico"
        
        if (Test-Path $faviconFullPath) {
            # Use -ArgumentList to pass the resolved path into the scriptblock
            Add-PodeRoute -Method Get -Path '/favicon.ico' -ArgumentList @($faviconFullPath) -ScriptBlock {
                param($FaviconPath)
                
                # Use Write-PodeFileResponse to serve the file (per Pode documentation)
                Write-PodeFileResponse -Path $FaviconPath -ContentType 'image/x-icon'
            }
        }
        else {
            Write-Host "[!] Favicon not found at: $faviconFullPath" -ForegroundColor Yellow
            Write-Host "    Favicon route will not be available" -ForegroundColor Gray
        }
        
        # ----- 1.2 Video.js Static Route -----
        # Serve video.js library files from tools/videojs folder
        $config = Get-MediaConfig
        $videojsSource = Join-Path $config.ToolsFolder "videojs"
        if (Test-Path $videojsSource) {
            Add-PodeStaticRoute -Path '/videojs' -Source $videojsSource -Defaults @('video.min.js')
        }
        else {
            Write-Host "[!] Video.js folder not found at: $videojsSource" -ForegroundColor Yellow
            Write-Host "    Static route /videojs/* will not be available" -ForegroundColor Gray
        }
        
        # ----- 1.3 Error Handlers -----
        
        # Create custom error pages directory for Pode
        $errorsDir = Join-Path $config.ScriptRoot "errors"
        if (-not (Test-Path $errorsDir)) {
            New-Item -ItemType Directory -Path $errorsDir -Force | Out-Null
        }
        
        # Create custom 500 error page (HTML file for Pode to use)
        $error500Page = @"
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <title>500 - Server Error</title>
    <style>
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 60px 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 600px;
        }
        h1 { margin: 0 0 20px 0; font-size: 72px; }
        h2 { margin: 0 0 20px 0; font-size: 28px; font-weight: 400; }
        p { font-size: 16px; color: rgba(255,255,255,0.8); margin: 20px 0; }
        .btn {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class='container'>
        <h1>⚠️</h1>
        <h2>500 - Server Error</h2>
        <p>An error occurred while processing your request.</p>
        <p>Please try again later or contact support.</p>
        <a href='/' class='btn'>← Back to Home</a>
        <a href='javascript:location.reload()' class='btn'>🔄 Retry</a>
    </div>
</body>
</html>
"@
        $error500Page | Out-File -FilePath (Join-Path $errorsDir "500.html") -Encoding UTF8 -Force
        
        # Create custom 404 error page (HTML file for Pode to use)
        $error404Page = @"
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <title>404 - Not Found</title>
    <style>
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 60px 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 600px;
        }
        h1 { margin: 0 0 20px 0; font-size: 72px; }
        h2 { margin: 0 0 20px 0; font-size: 28px; font-weight: 400; }
        p { font-size: 16px; color: rgba(255,255,255,0.8); margin: 20px 0; }
        .btn {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class='container'>
        <h1>404</h1>
        <h2>Page Not Found</h2>
        <p>The requested URL was not found on this server.</p>
        <a href='/' class='btn'>← Back to Home</a>
    </div>
</body>
</html>
"@
        $error404Page | Out-File -FilePath (Join-Path $errorsDir "404.html") -Encoding UTF8 -Force
        
        # Create default error page
        $errorDefaultPage = @"
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <title>Error</title>
    <style>
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 60px 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 600px;
        }
        h1 { margin: 0 0 20px 0; font-size: 72px; }
        h2 { margin: 0 0 20px 0; font-size: 28px; font-weight: 400; }
        p { font-size: 16px; color: rgba(255,255,255,0.8); margin: 20px 0; }
        .btn {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: all 0.2s;
        }
        .btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class='container'>
        <h1>⚠️</h1>
        <h2>Error</h2>
        <p>Something went wrong while processing your request.</p>
        <a href='/' class='btn'>← Back to Home</a>
    </div>
</body>
</html>
"@
        $errorDefaultPage | Out-File -FilePath (Join-Path $errorsDir "default.html") -Encoding UTF8 -Force
        
        
        
        # ----- 2.1 Login Page (GET) -----
        Add-PodeRoute -Method Get -Path '/login' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            # If already logged in, redirect to home
            if ($WebEvent.Session.Data.User) {
                Move-PodeResponseUrl -Url '/'
                return
            }
            
            # Check if SecurityByPin is disabled - auto redirect to home
            if (-not $Global:CONFIG.SecurityByPin) {
                Move-PodeResponseUrl -Url '/'
                return
            }
            
            # Get selected user from query string (if any)
            $selectedUser = $WebEvent.Query['user']
            
            $html = Get-LoginPage -SelectedUser $selectedUser
            Write-PodeHtmlResponse -Value $html
        }
        
        # ----- 2.2 Login Handler (POST) -----
        Add-PodeRoute -Method Post -Path '/login' -ScriptBlock {
            $Global:CONFIG = Get-PodeState -Name 'MediaConfig'
            
            # Get form data - handle both JSON and form-urlencoded
            $username = $null
            $pin = $null
            
            if ($WebEvent.Data) {
                $username = $WebEvent.Data.username
                $pin = $WebEvent.Data.pin
            }
            
            try {
                # Get user from database
                $user = Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                    -Query "SELECT * FROM users WHERE username = @username AND is_active = 1" `
                    -SqlParameters @{ username = $username }
                
                if (-not $user) {
                    # Redirect back to login with error
                    $html = Get-LoginPage -Error "User not found" -SelectedUser $username
                    Write-PodeHtmlResponse -Value $html
                    return
                }
                
                # Verify PIN using the existing Test-PINCode function
                $pinValid = Test-PINCode -PIN $pin -Hash $user.pin_hash -Salt $user.pin_salt
                
                if (-not $pinValid) {
                    # Redirect back to login with error
                    $html = Get-LoginPage -Error "Invalid PIN" -SelectedUser $username
                    Write-PodeHtmlResponse -Value $html
                    return
                }
                
                # Update last login timestamp
                Invoke-SqliteQuery -DataSource $Global:CONFIG.UsersDB `
                    -Query "UPDATE users SET last_login = @now WHERE user_id = @id" `
                    -SqlParameters @{
                        now = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
                        id = $user.user_id
                    }
                
                # Set session data
                $userDbPath = Join-Path $Global:CONFIG.UsersDBPath "$($user.username).db"
                
                # Use string for LoginTime to avoid serialization race conditions
                $WebEvent.Session.Data.User = @{
                    UserId = $user.user_id
                    Username = $user.username
                    DisplayName = $user.display_name
                    UserType = $user.user_type
                    UserDB = $userDbPath
                    LoginTime = (Get-Date).ToString('o')
                }
                
                Write-Host "[✓] User logged in: $($user.username)" -ForegroundColor Green
                
                # Redirect to home page
                Move-PodeResponseUrl -Url '/'
            }
            catch {
                Write-Host "[✗] Login error: $_" -ForegroundColor Red
                $html = Get-LoginPage -Error "Login failed: $($_.Exception.Message)" -SelectedUser $username
                Write-PodeHtmlResponse -Value $html
            }
        }
        
        # ----- 2.3 Logout Handler (GET) -----
        Add-PodeRoute -Method Get -Path '/logout' -ScriptBlock {
            if ($WebEvent.Session.Data.User) {
                $username = $WebEvent.Session.Data.User.Username
                Write-Host "[i] User logged out: $username" -ForegroundColor Yellow
            }
            
            # Clear all session data
            $WebEvent.Session.Data.Clear()
            
            # Redirect to login page
            Move-PodeResponseUrl -Url '/login'
        }
        
        Write-Host "`n[✓] PODE server is running!" -ForegroundColor Green
        Write-Host "    HTTP: http://$serverHost`:$script:activePort" -ForegroundColor Cyan
    }
    }
    catch {
        # Check if this is the admin privileges error
        if ($_.Exception.Message -match "administrator privileges" -or $_.Exception.Message -match "admin") {
            Write-Host "`n[✗] PODE Server Error: Administrator Privileges Required" -ForegroundColor Red
            Write-Host "" -ForegroundColor Yellow
            Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Yellow
            Write-Host "  Current Configuration:" -ForegroundColor Cyan
            Write-Host "    ServerHost: $($CONFIG.ServerHost)" -ForegroundColor White
            Write-Host "" -ForegroundColor Yellow
            Write-Host "  PODE requires administrator privileges to bind to non-localhost" -ForegroundColor Yellow
            Write-Host "  addresses like '+' (all interfaces) or specific network IPs." -ForegroundColor Yellow
            Write-Host "" -ForegroundColor Yellow
            
            # Check what type of binding is configured
            $isSpecificIP = $CONFIG.ServerHost -match '^\d+\.\d+\.\d+\.\d+$'
            $isAllInterfaces = $CONFIG.ServerHost -eq '+'
            
            if ($isSpecificIP) {
                Write-Host "  ⚠️  You have configured a specific IP address: $($CONFIG.ServerHost)" -ForegroundColor Yellow
                Write-Host "     Binding to specific IPs ALWAYS requires administrator privileges." -ForegroundColor Yellow
                Write-Host "" -ForegroundColor Yellow
            }
            
            Write-Host "  Solutions:" -ForegroundColor Cyan
            if ($isSpecificIP -or $isAllInterfaces) {
                Write-Host "    1. ⭐ Run PowerShell as Administrator (REQUIRED for IP: $($CONFIG.ServerHost))" -ForegroundColor White
                Write-Host "    2. Change ServerHost to 'localhost' for local-only access (no admin needed)" -ForegroundColor White
            }
            else {
                Write-Host "    1. Run PowerShell as Administrator (recommended for network access)" -ForegroundColor White
                Write-Host "    2. Change ServerHost to 'localhost' for local-only access (no admin needed)" -ForegroundColor White
            }
            Write-Host "" -ForegroundColor Yellow
            
            # Get local IP addresses to suggest
            $localIPs = @()
            try {
                $networkAdapters = Get-NetIPAddress -AddressFamily IPv4 | Where-Object { $_.IPAddress -ne '127.0.0.1' -and $_.PrefixOrigin -ne 'WellKnown' }
                $localIPs = $networkAdapters | Select-Object -ExpandProperty IPAddress
            }
            catch {
                # Fallback if Get-NetIPAddress fails
                $localIPs = @((Get-NetIPConfiguration | Where-Object { $_.IPv4Address.IPAddress -ne '127.0.0.1' }).IPv4Address.IPAddress)
            }
            
            if ($localIPs.Count -gt 0) {
                Write-Host "  Your machine's available IP addresses:" -ForegroundColor Cyan
                foreach ($ip in $localIPs) {
                    if ($ip -eq $CONFIG.ServerHost) {
                        Write-Host "    • $ip  ← Currently configured (requires admin)" -ForegroundColor Yellow
                    }
                    else {
                        Write-Host "    • $ip" -ForegroundColor Green
                    }
                }
                Write-Host "" -ForegroundColor Yellow
            }
            
            Write-Host "  To change ServerHost, edit NexusM.conf and set:" -ForegroundColor White
            Write-Host "    ServerHost=localhost  (local-only, no admin needed)" -ForegroundColor Gray
            if ($localIPs.Count -gt 0) {
                Write-Host "    ServerHost=$($localIPs[0])  (network access, admin required)" -ForegroundColor Gray
            }
            Write-Host "" -ForegroundColor Yellow
            Write-Host "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" -ForegroundColor Yellow
            Write-Host "" -ForegroundColor Yellow
            
            # Only offer localhost retry if not already trying localhost
            if ($CONFIG.ServerHost -ne 'localhost' -and $CONFIG.ServerHost -ne '127.0.0.1') {
                # Offer to automatically retry with localhost
                $retryChoice = Read-Host "Would you like to retry with localhost binding (no admin required)? (Y/N)"
            
            if ($retryChoice -eq 'Y' -or $retryChoice -eq 'y') {
                Write-Host "`n[i] Retrying with localhost binding..." -ForegroundColor Cyan
                
                # Ask if user wants to save this permanently
                $saveChoice = Read-Host "Save 'localhost' to NexusM.conf permanently? (Y/N)"
                if ($saveChoice -eq 'Y' -or $saveChoice -eq 'y') {
                    Update-ServerHostInConfig -NewServerHost 'localhost'
                }
                
                # Update variables and retry
                $serverHost = 'localhost'
                $Global:ServerRunning = $true
                
                Start-PodeServer -Threads $podeThreads {
                    Add-PodeEndpoint -Address 'localhost' -Port $serverPort -Protocol Http
                    
                    # Enable logging - errors only
                    $errorLogLevels = @('Error')
                    
                    if (-not (Test-Path $logsFolder)) {
                        New-Item -Path $logsFolder -ItemType Directory -Force | Out-Null
                    }
                    
                    $errorLogFile = Join-Path $logsFolder "errors_$(Get-Date -Format 'yyyy-MM-dd').log"
                    if (-not (Test-Path $errorLogFile)) {
                        $startupEntry = "[$(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')] [Informational] PSMediaLibrary web server started (localhost fallback) - Error logging initialized"
                        $startupEntry | Out-File -FilePath $errorLogFile -Encoding UTF8
                    }
                    
                    # Enable file-based error logging - errors only
                    New-PodeLoggingMethod -File -Path $logsFolder -Name 'errors' | Enable-PodeErrorLogging -Levels $errorLogLevels
                    
                    Enable-PodeSessionMiddleware -Duration $podeSessionTimeout -Extend -Generator {
                        return [guid]::NewGuid().ToString()
                    }
                    
                    # Initialize Pode state for localhost fallback
                    $configForPode = Get-MediaConfig
                    Set-PodeState -Name 'MediaConfig' -Value @{
                        UsersDB = $configForPode.UsersDB
                        UsersDBPath = $configForPode.UsersDBPath
                        MoviesDB = $configForPode.MoviesDB
                        MusicDB = $configForPode.MusicDB
                        PicturesDB = $configForPode.PicturesDB
                        PDFDB = $configForPode.PDFDB
                        SecurityByPin = $configForPode.SecurityByPin
                        ScriptRoot = $configForPode.ScriptRoot
                        ToolsFolder = $configForPode.ToolsFolder
                        PosterCacheFolder = $configForPode.PosterCacheFolder
                        AlbumArtCacheFolder = $configForPode.AlbumArtCacheFolder
                        PDFPreviewCacheFolder = $configForPode.PDFPreviewCacheFolder
                        EbookCoverCacheFolder = $configForPode.PDFPreviewCacheFolder
                        AvatarFolder = $configForPode.AvatarFolder
                        RadioStations = $configForPode.RadioStations
                        RadioLogoCacheFolder = $configForPode.RadioLogoCacheFolder
                        TVChannels = $configForPode.TVChannels
                        TVLogoCacheFolder = $configForPode.TVLogoCacheFolder
                        EPUBCoverCacheFolder = $configForPode.EPUBCoverCacheFolder
                        # Media folder paths for scanning
                        MoviesFolder = $configForPode.MoviesFolder
                        MusicFolder = $configForPode.MusicFolder
                        PicturesFolder = $configForPode.PicturesFolder
                        PDFFolder = $configForPode.PDFFolder
                        # File extensions for scanning
                        VideoExtensions = $configForPode.VideoExtensions
                        AudioExtensions = $configForPode.AudioExtensions
                        ImageExtensions = $configForPode.ImageExtensions
                        PDFExtensions = $configForPode.PDFExtensions
                        # Other config needed for scanning
                        LowQualityVideoThreshold = $configForPode.LowQualityVideoThreshold
                        TMDB_APIKey = $configForPode.TMDB_APIKey
                        # Music Videos Feature (v7.10, v1.7: folder path from database)
                        MusicVideosEnabled = $configForPode.MusicVideosEnabled
                        MusicVideosFolder = "D:\Share"  # Placeholder - actual path from Get-AllMediaPaths
                        MusicVideosDB = $configForPode.MusicVideosDB
                        # Menu Visibility Settings (v7.19)
                        RadioEnabled = $configForPode.RadioEnabled
                        InternetTVEnabled = $configForPode.InternetTVEnabled
                        PicturesEnabled = $configForPode.PicturesEnabled
                        EbooksEnabled = $configForPode.EbooksEnabled
                    }
                    
                    # Filter out empty strings from whitelist
                    $validIPs = @($ipWhitelist | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
                    if ($validIPs.Count -gt 0) {
                        foreach ($ip in $validIPs) {
                            Add-PodeAccessRule -Access Allow -Type IP -Values @($ip)
                        }
                        Add-PodeAccessRule -Access Deny -Type IP -Values @('*')
                    }
                    else {
                        Write-Host "[i] IP whitelist disabled - all IPs allowed" -ForegroundColor Gray
                    }
                    
                    Add-PodeRoute -Method Get -Path '/pode-test' -ScriptBlock {
                        $config = Get-PodeState -Name 'MediaConfig'
                        Write-PodeJsonResponse -Value @{
                            status = 'OK'
                            message = 'PODE server is running successfully!'
                            phase = 'Phase 1: Static Assets & Simple Routes'
                            mode = 'Localhost Fallback'
                            timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
                            server_info = @{
                                pode_version = (Get-Module Pode).Version.ToString()
                                powershell_version = $PSVersionTable.PSVersion.ToString()
                                config_loaded = ($null -ne $config)
                                databases = @{
                                    movies = (Test-Path $config.MoviesDB)
                                    music = (Test-Path $config.MusicDB)
                                    pictures = (Test-Path $config.PicturesDB)
                                    pdfs = (Test-Path $config.PDFDB)
                                    users = (Test-Path $config.UsersDB)
                                }
                                phase1_routes = @{
                                    favicon = '/favicon.ico'
                                    videojs = '/videojs/*'
                                    error_404 = 'Catch-all enabled'
                                    error_500 = 'Error page enabled'
                                }
                            }
                            next_steps = @(
                                "Phase 2: Authentication & sessions"
                                "Phase 3: Content pages"
                                "Phase 4: API endpoints"
                            )
                        }
                    }
                    
                    Add-PodeRoute -Method Get -Path '/' -ScriptBlock {
                        Write-PodeHtmlResponse -Value @"
<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='utf-8' />
    <meta name='viewport' content='width=device-width,initial-scale=1' />
    <title>PODE Server - Phase 1 (Localhost)</title>
    <style>
        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(0,0,0,0.6);
            padding: 60px 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            max-width: 600px;
        }
        h1 { margin: 0 0 20px 0; font-size: 48px; }
        .badge {
            display: inline-block;
            background: rgba(16,185,129,0.2);
            border: 1px solid rgba(16,185,129,0.5);
            color: #10b981;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 20px 5px;
        }
        .phase-complete {
            background: rgba(34,197,94,0.2);
            border: 1px solid rgba(34,197,94,0.5);
            color: #22c55e;
        }
        .localhost-badge {
            background: rgba(251,191,36,0.2);
            border: 1px solid rgba(251,191,36,0.5);
            color: #fbbf24;
        }
        .info {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 30px 0;
            text-align: left;
        }
        .info-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .info-item:last-child { border-bottom: none; }
        .label { color: rgba(255,255,255,0.7); font-size: 14px; }
        .value { color: white; font-weight: 600; font-size: 16px; }
        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 14px 28px;
            border-radius: 12px;
            text-decoration: none;
            font-weight: 600;
            margin: 10px;
            transition: transform 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .route-list {
            text-align: left;
            background: rgba(0,0,0,0.2);
            padding: 15px 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .route-item {
            padding: 5px 0;
            font-family: monospace;
            font-size: 14px;
            color: #a5b4fc;
        }
        .route-item .status { color: #10b981; margin-right: 8px; }
    </style>
</head>
<body>
    <div class='container'>
        <h1>🚀 PODE Server</h1>
        <div class='badge'>Phase 1: Static Assets</div>
        <span class='badge phase-complete'>✓ Phase 0</span>
        <span class='badge localhost-badge'>📍 Localhost Mode</span>
        
        <div class='info'>
            <div class='info-item'>
                <div class='label'>Status</div>
                <div class='value' style='color:#10b981;'>✓ Running Successfully</div>
            </div>
            <div class='info-item'>
                <div class='label'>Migration Phase</div>
                <div class='value'>Phase 1: Static Assets & Routes</div>
            </div>
            <div class='info-item'>
                <div class='label'>Port</div>
                <div class='value'>$serverPort</div>
            </div>
            <div class='info-item'>
                <div class='label'>Access</div>
                <div class='value' style='color:#fbbf24;'>Localhost Only (No Admin)</div>
            </div>
        </div>
        
        <div class='route-list'>
            <strong style='color:white;'>Phase 1 Routes:</strong>
            <div class='route-item'><span class='status'>✓</span>/favicon.ico</div>
            <div class='route-item'><span class='status'>✓</span>/videojs/* (static files)</div>
            <div class='route-item'><span class='status'>✓</span>404 error handler</div>
            <div class='route-item'><span class='status'>✓</span>500 error handler</div>
        </div>
        
        <p style='font-size: 18px; line-height: 1.6;'>
            PODE server is running in localhost mode.<br/>
            Run as Administrator for network access.
        </p>
        
        <a href='/pode-test' class='btn'>📊 View Server Info</a>
        <a href='/nonexistent-test-404' class='btn'>🔍 Test 404</a>
    </div>
</body>
</html>
"@
                    }
                    
                    # ----- Phase 1: Favicon Route (Localhost Fallback) -----
                    $config = Get-PodeState -Name 'MediaConfig'
                    $faviconFullPath = Join-Path $config.ScriptRoot "favicon.ico"
                    
                    if (Test-Path $faviconFullPath) {
                        Add-PodeRoute -Method Get -Path '/favicon.ico' -ArgumentList @($faviconFullPath) -ScriptBlock {
                            param($FaviconPath)
                            Write-PodeFileResponse -Path $FaviconPath -ContentType 'image/x-icon'
                        }
                    }
                    
                    # ----- Phase 1: Video.js Static Route (Localhost Fallback) -----
                    $videojsSource = Join-Path $config.ToolsFolder "videojs"
                    if (Test-Path $videojsSource) {
                        Add-PodeStaticRoute -Path '/videojs' -Source $videojsSource -Defaults @('video.min.js')
                    }
                    
                    # ----- Phase 1: Create Error Pages Directory (Localhost Fallback) -----
                    $errorsDir = Join-Path $config.ScriptRoot "errors"
                    if (-not (Test-Path $errorsDir)) {
                        New-Item -ItemType Directory -Path $errorsDir -Force | Out-Null
                        
                        # Create 500 error page
                        @"
<!DOCTYPE html>
<html><head><title>500 - Server Error</title>
<style>body{margin:0;font-family:system-ui;background:#dc2626;min-height:100vh;display:flex;align-items:center;justify-content:center;color:white}
.container{text-align:center;background:rgba(0,0,0,0.6);padding:60px 40px;border-radius:20px;max-width:600px}
h1{font-size:72px;margin:0}h2{margin:20px 0}
.btn{display:inline-block;background:rgba(255,255,255,0.2);color:white;padding:14px 28px;border-radius:12px;text-decoration:none;margin:10px}</style></head>
<body><div class='container'><h1>⚠️</h1><h2>500 - Server Error</h2><p>An error occurred.</p><a href='/' class='btn'>← Back to Home</a></div></body></html>
"@ | Out-File -FilePath (Join-Path $errorsDir "500.html") -Encoding UTF8 -Force
                        
                        # Create 404 error page
                        @"
<!DOCTYPE html>
<html><head><title>404 - Not Found</title>
<style>body{margin:0;font-family:system-ui;background:#6366f1;min-height:100vh;display:flex;align-items:center;justify-content:center;color:white}
.container{text-align:center;background:rgba(0,0,0,0.6);padding:60px 40px;border-radius:20px;max-width:600px}
h1{font-size:72px;margin:0}h2{margin:20px 0}
.btn{display:inline-block;background:rgba(255,255,255,0.2);color:white;padding:14px 28px;border-radius:12px;text-decoration:none;margin:10px}</style></head>
<body><div class='container'><h1>404</h1><h2>Page Not Found</h2><a href='/' class='btn'>← Back to Home</a></div></body></html>
"@ | Out-File -FilePath (Join-Path $errorsDir "404.html") -Encoding UTF8 -Force
                        
                        # Create default error page
                        @"
<!DOCTYPE html>
<html><head><title>Error</title>
<style>body{margin:0;font-family:system-ui;background:#f59e0b;min-height:100vh;display:flex;align-items:center;justify-content:center;color:white}
.container{text-align:center;background:rgba(0,0,0,0.6);padding:60px 40px;border-radius:20px;max-width:600px}
h1{font-size:72px;margin:0}h2{margin:20px 0}
.btn{display:inline-block;background:rgba(255,255,255,0.2);color:white;padding:14px 28px;border-radius:12px;text-decoration:none;margin:10px}</style></head>
<body><div class='container'><h1>⚠️</h1><h2>Error</h2><p>Something went wrong.</p><a href='/' class='btn'>← Back to Home</a></div></body></html>
"@ | Out-File -FilePath (Join-Path $errorsDir "default.html") -Encoding UTF8 -Force
                    }
                    
                    # ----- Phase 1: 404 Catch-All (Localhost Fallback) - MUST BE LAST -----
                    Add-PodeRoute -Method * -Path '*' -ScriptBlock {
                        Set-PodeResponseStatus -Code 404
                        Write-PodeHtmlResponse -Value @"
<!DOCTYPE html>
<html><head><title>404 - Not Found</title>
<style>body{margin:0;font-family:system-ui;background:#6366f1;min-height:100vh;display:flex;align-items:center;justify-content:center;color:white}
.container{text-align:center;background:rgba(0,0,0,0.6);padding:60px 40px;border-radius:20px;max-width:600px}
h1{font-size:72px;margin:0}h2{margin:20px 0}
.url{background:rgba(0,0,0,0.3);padding:10px 20px;border-radius:8px;font-family:monospace;color:#a5b4fc;margin:20px 0}
.btn{display:inline-block;background:rgba(255,255,255,0.2);color:white;padding:14px 28px;border-radius:12px;text-decoration:none;margin:10px}</style></head>
<body><div class='container'><h1>404</h1><h2>Page Not Found</h2><div class='url'>$($WebEvent.Request.Url.PathAndQuery)</div><a href='/' class='btn'>← Back to Home</a></div></body></html>
"@
                    }
                    
                    
                    Write-Host "`n[✓] PODE server is running!" -ForegroundColor Green
                    Write-Host "    HTTP: http://localhost:$serverPort" -ForegroundColor Cyan
                }
            }
            else {
                Write-Host "`n[!] Server startup cancelled." -ForegroundColor Yellow
                Write-Host "    To use network IP $($CONFIG.ServerHost), run PowerShell as Administrator.`n" -ForegroundColor Gray
            }
            }
            else {
                Write-Host "`n[!] Cannot retry - already configured for localhost." -ForegroundColor Yellow
                Write-Host "    Please run PowerShell as Administrator if you need network access.`n" -ForegroundColor Gray
            }
        }
        else {
            # Other error - show it
            Write-Host "`n[✗] PODE Server Error:" -ForegroundColor Red
            Write-Host $_.Exception.Message -ForegroundColor Red
            Write-Host $_.ScriptStackTrace -ForegroundColor Gray
        }
    }
}


# ============================================================================
# MAIN EXECUTION
# ============================================================================

function Start-PSMediaLibrary {
    param(
        [bool]$DoAutoScan = $false,
        [bool]$AutoScanSpecified = $false,
        [bool]$DoFetchPosters = $false,
        [bool]$FetchPostersSpecified = $false,
        [bool]$DoExtractAlbumArt = $false,
        [bool]$ExtractAlbumArtSpecified = $false,
        [bool]$DoGeneratePDFThumbnails = $false,
        [bool]$GeneratePDFThumbnailsSpecified = $false,
        [bool]$DoStartServer = $false,
        [bool]$StartServerSpecified = $false,
        [bool]$IsSilent = $false
    )
    
    Clear-Host
    Write-Host @"
╔══════════════════════════════════════════════════════════════╗
║                        NexusM                                ║
║            PowerShell Media Library Manager                  ║
╚══════════════════════════════════════════════════════════════╝
"@ -ForegroundColor Cyan

    if ($IsSilent) {
        Write-Host "`n[Silent Mode] Starting with minimal output..." -ForegroundColor Gray
    }

    # Check dependencies
    if (-not (Test-PSSQLiteModule)) {
        Write-Host "`nExiting due to missing dependencies." -ForegroundColor Red
        return
    }
    
    # Check Pode module (required for web server)
    if (-not (Test-PodeModule)) {
        Write-Host "`nExiting due to missing dependencies." -ForegroundColor Red
        return
    }
    
    # Check FFmpeg (optional - for album artwork)
    if (-not $IsSilent) {
        Test-FFmpegAvailability | Out-Null
    }
    
    # Check Ghostscript (optional - for eBook preview generation)
    if (-not $IsSilent) {
        Test-GhostscriptAvailability | Out-Null
    }
    
    # Check Video.js (optional - for enhanced video player)
    if (-not $IsSilent) {
        Test-VideoJSAvailability | Out-Null
    }
    
    # Check Epub.js (optional - for enhanced eBook reader)
    if (-not $IsSilent) {
        Test-EpubjsAvailability | Out-Null
    }
    
    Write-Host "`n" ("═" * 70) -ForegroundColor DarkGray
    
    # Initialize FFmpeg transcoding (ALWAYS - required for MKV/AVI/MOV support)
    Write-Host "" # Blank line
    Write-Host "[i] Initializing FFmpeg for video transcoding..." -ForegroundColor Cyan
    Write-NexusMLog "Initializing FFmpeg for video transcoding..."
    try {
        $ffmpegResult = Initialize-FFmpegTranscoding
        if (-not $ffmpegResult) {
            Write-NexusMLog "FFmpeg initialization returned false" -Level "WARNING"
        }
        if (-not $Global:FFmpegCapabilities) {
            Write-Host "[!] WARNING: FFmpeg not available - MKV/AVI transcoding will NOT work!" -ForegroundColor Red
            Write-NexusMLog "FFmpegCapabilities is still null after initialization!" -Level "ERROR"
        }
        else {
            Write-Host "[✓] FFmpeg ready" -ForegroundColor Green
            Write-NexusMLog "FFmpegCapabilities is set: $($Global:FFmpegCapabilities.FFmpegPath)"
        }
    }
    catch {
        Write-Host "[✗] FFmpeg initialization failed - transcoding will not be available" -ForegroundColor Red
        Write-NexusMLog "EXCEPTION during FFmpeg initialization: $_" -Level "ERROR"
        Write-NexusMLog "Exception Type: $($_.Exception.GetType().FullName)" -Level "ERROR"
        Write-NexusMLog "Stack Trace: $($_.ScriptStackTrace)" -Level "ERROR"
    }
    
    Write-Host "`n" ("═" * 70) -ForegroundColor DarkGray
    
    # Initialize databases
    Write-Host "`n[i] Initializing databases..." -ForegroundColor Cyan
    
    # Initialize user management database FIRST
    Initialize-UsersDatabase -DatabasePath $CONFIG.UsersDB
    
    # Initialize shares database (v6.96 - separate from users.db)
    Initialize-SharesDatabase -DatabasePath $CONFIG.SharesDB
    Write-NexusMLog "Shares database initialized"
    
    # Migrate shares from old users.db to new shares.db if needed (v6.96)
    Migrate-SharesToNewDatabase -OldDatabasePath $CONFIG.UsersDB -NewDatabasePath $CONFIG.SharesDB
    
    # Initialize default media paths if none exist (v1.6)
    $existingShares = Get-NetworkShares -DatabasePath $CONFIG.SharesDB
    if (-not $existingShares -or $existingShares.Count -eq 0) {
        Write-NexusMLog "No media shares configured. Initializing defaults..."
        Initialize-DefaultMediaPaths -DatabasePath $CONFIG.SharesDB
    }
    
    # Initialize media databases
    Initialize-Database -DatabasePath $CONFIG.MoviesDB -Type "movies"
    Initialize-Database -DatabasePath $CONFIG.MusicDB -Type "music"
    Initialize-Database -DatabasePath $CONFIG.PicturesDB -Type "pictures"
    Initialize-Database -DatabasePath $CONFIG.PDFDB -Type "ebooks"
    
    # Initialize Music Videos database if feature is enabled (v7.10)
    if ($CONFIG.MusicVideosEnabled) {
        Initialize-Database -DatabasePath $CONFIG.MusicVideosDB -Type "musicvideos"
        Write-NexusMLog "Music Videos feature is ENABLED"
    }
    
    if ($CONFIG.ContainsKey('HLSCacheEnabled')) {
        $Global:TranscodingConfig.HLSCacheEnabled = $CONFIG.HLSCacheEnabled
    }
    if ($CONFIG.ContainsKey('HLSCacheMaxSizeGB')) {
        $Global:TranscodingConfig.HLSCacheMaxSizeGB = [int]$CONFIG.HLSCacheMaxSizeGB
    }
    if ($CONFIG.ContainsKey('HLSCacheRetentionDays')) {
        $Global:TranscodingConfig.HLSCacheRetentionDays = [int]$CONFIG.HLSCacheRetentionDays
    }
    
    if ($Global:TranscodingConfig.HLSCacheEnabled) {
        Initialize-HLSCacheDatabase -ScriptRoot $PSScriptRoot
        
        # Run cleanup on startup
        Invoke-HLSCacheCleanup -RetentionDays $Global:TranscodingConfig.HLSCacheRetentionDays `
            -MaxSizeGB $Global:TranscodingConfig.HLSCacheMaxSizeGB
        
        # Show cache stats
        $cacheStats = Get-HLSCacheStats
        Write-Host "[✓] HLS Cache: $($cacheStats.TotalEntries) entries, $($cacheStats.TotalSizeGB) GB used" -ForegroundColor Green
        Write-Host "    Max Size: $($Global:TranscodingConfig.HLSCacheMaxSizeGB) GB | Retention: $($Global:TranscodingConfig.HLSCacheRetentionDays) days" -ForegroundColor Gray
    }
    else {
        Write-Host "[i] HLS Cache: Disabled" -ForegroundColor Gray
    }
    
    Write-Host "[✓] Databases ready" -ForegroundColor Green
    
    Write-Host "`n" ("═" * 70) -ForegroundColor DarkGray
    Write-Host "`n┌─ MEDIA SCAN ─────────────────────────────────────────────────────┐" -ForegroundColor Yellow
    
    # Handle media scan - skip prompt if parameter was explicitly specified (either way)
    $shouldScan = $DoAutoScan
    if (-not $IsSilent -and -not $AutoScanSpecified) {
        $scanChoice = Read-Host "│ Would you like to scan your media folders now? (Y/N)"
        Write-Host "└──────────────────────────────────────────────────────────────────┘" -ForegroundColor Yellow
        $shouldScan = ($scanChoice -eq 'Y' -or $scanChoice -eq 'y')
    }
    elseif ($AutoScanSpecified) {
        Write-Host "│ Media scan: $(if ($DoAutoScan) { 'Yes (auto)' } else { 'Skipped (parameter)' })" -ForegroundColor Gray
        Write-Host "└──────────────────────────────────────────────────────────────────┘" -ForegroundColor Yellow
    }
    
    if ($shouldScan) {
        Invoke-MediaScan
    }
    else {
        # Load stats from database
        $Global:MediaStats.TotalVideos = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COUNT(*) as count FROM videos").count
        $Global:MediaStats.TotalMusic = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music").count
        $Global:MediaStats.TotalPictures = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT COUNT(*) as count FROM images").count
        $Global:MediaStats.TotalPDFs = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs").count
        
        # Load Music Videos stats if enabled (v7.10)
        if ($CONFIG.MusicVideosEnabled -and (Test-Path $CONFIG.MusicVideosDB)) {
            $Global:MediaStats.TotalMusicVideos = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COUNT(*) as count FROM musicvideos").count
            $musicVideosSizeQuery = (Invoke-SqliteQuery -DataSource $CONFIG.MusicVideosDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM musicvideos").total
            $Global:MediaStats.MusicVideosSizeGB = [math]::Round($musicVideosSizeQuery / 1GB, 2)
        }
        
        # Calculate sizes
        $videoSizeQuery = (Invoke-SqliteQuery -DataSource $CONFIG.MoviesDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM videos").total
        $musicSizeQuery = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM music").total
        $pictureSizeQuery = (Invoke-SqliteQuery -DataSource $CONFIG.PicturesDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM images").total
        $pdfSizeQuery = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COALESCE(SUM(size_bytes), 0) as total FROM pdfs").total
        
        $Global:MediaStats.VideoSizeGB = [math]::Round($videoSizeQuery / 1GB, 2)
        $Global:MediaStats.MusicSizeGB = [math]::Round($musicSizeQuery / 1GB, 2)
        $Global:MediaStats.PicturesSizeGB = [math]::Round($pictureSizeQuery / 1GB, 2)
        $Global:MediaStats.PDFSizeGB = [math]::Round($pdfSizeQuery / 1GB, 2)
        $Global:MediaStats.TotalSizeGB = [math]::Round(($videoSizeQuery + $musicSizeQuery + $pictureSizeQuery + $pdfSizeQuery) / 1GB, 2)
    }
    
    Write-Host "`n" ("═" * 70) -ForegroundColor DarkGray
    Write-Host "`n┌─ OPTIONAL ENHANCEMENTS ──────────────────────────────────────────┐" -ForegroundColor Magenta
    
    # Handle poster fetching - skip prompt if parameter was explicitly specified
    if (-not [string]::IsNullOrWhiteSpace($CONFIG.TMDB_APIKey)) {
        $shouldFetchPosters = $DoFetchPosters
        if (-not $IsSilent -and -not $FetchPostersSpecified) {
            $fetchPostersChoice = Read-Host "│ Fetch movie posters from TMDB? (Y/N)"
            $shouldFetchPosters = ($fetchPostersChoice -eq 'Y' -or $fetchPostersChoice -eq 'y')
        }
        elseif ($FetchPostersSpecified) {
            Write-Host "│ Fetch posters: $(if ($DoFetchPosters) { 'Yes (auto)' } else { 'Skipped (parameter)' })" -ForegroundColor Gray
        }
        
        if ($shouldFetchPosters) {
            Update-AllMoviePosters
        }
    }
    
    # Handle album artwork extraction - skip prompt if parameter was explicitly specified
    if ($Global:FFmpegPath) {
        $musicCount = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music").count
        if ($musicCount -gt 0) {
            $shouldExtractArt = $DoExtractAlbumArt
            if (-not $IsSilent -and -not $ExtractAlbumArtSpecified) {
                $extractArtChoice = Read-Host "│ Extract album artwork from music files? (Y/N)"
                $shouldExtractArt = ($extractArtChoice -eq 'Y' -or $extractArtChoice -eq 'y')
            }
            elseif ($ExtractAlbumArtSpecified) {
                Write-Host "│ Extract artwork: $(if ($DoExtractAlbumArt) { 'Yes (auto)' } else { 'Skipped (parameter)' })" -ForegroundColor Gray
            }
            
            if ($shouldExtractArt) {
                # Check if any artwork already exists
                $existingArtCount = (Invoke-SqliteQuery -DataSource $CONFIG.MusicDB -Query "SELECT COUNT(*) as count FROM music WHERE album_art_cached IS NOT NULL AND album_art_cached != ''").count
                
                $forceExtract = $false
                if ($existingArtCount -gt 0 -and -not $IsSilent) {
                    Write-Host "[i] Found $existingArtCount files with existing artwork" -ForegroundColor Yellow
                    $forceChoice = Read-Host "Force re-extract all artwork (ignoring existing)? (Y/N)"
                    $forceExtract = ($forceChoice -eq 'Y' -or $forceChoice -eq 'y')
                }
                
                Extract-AllAlbumArtwork -Force:$forceExtract
            }
        }
    }
    
    # Handle eBook thumbnail generation - skip prompt if parameter was explicitly specified
    $pdfCount = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs").count
    if ($pdfCount -gt 0) {
        # Check if Ghostscript or Windows native eBook rendering is available
        $windowsNative = $PSVersionTable.PSVersion.Major -ge 5 -and [Environment]::OSVersion.Version.Major -ge 10
        $gsAvailable = (Get-Command gs -ErrorAction SilentlyContinue) -or (Get-Command gswin64c -ErrorAction SilentlyContinue) -or (Get-Command gswin32c -ErrorAction SilentlyContinue)
        
        if ($windowsNative -or $gsAvailable) {
            $shouldGeneratePDFThumbnails = $DoGeneratePDFThumbnails
            if (-not $IsSilent -and -not $GeneratePDFThumbnailsSpecified) {
                $generatePDFChoice = Read-Host "│ Generate eBooks preview thumbnails? (Y/N)"
                $shouldGeneratePDFThumbnails = ($generatePDFChoice -eq 'Y' -or $generatePDFChoice -eq 'y')
            }
            elseif ($GeneratePDFThumbnailsSpecified) {
                Write-Host "│ Generate thumbnails: $(if ($DoGeneratePDFThumbnails) { 'Yes (auto)' } else { 'Skipped (parameter)' })" -ForegroundColor Gray
            }
            
            if ($shouldGeneratePDFThumbnails) {
                # Check if any thumbnails already exist
                $existingThumbnailCount = (Invoke-SqliteQuery -DataSource $CONFIG.PDFDB -Query "SELECT COUNT(*) as count FROM pdfs WHERE preview_image IS NOT NULL AND preview_image != ''").count
                
                $forceGenerate = $false
                if ($existingThumbnailCount -gt 0 -and -not $IsSilent) {
                    Write-Host "[i] Found $existingThumbnailCount eBooks with existing thumbnails" -ForegroundColor Yellow
                    $forceChoice = Read-Host "Force re-generate all thumbnails (ignoring existing)? (Y/N)"
                    $forceGenerate = ($forceChoice -eq 'Y' -or $forceChoice -eq 'y')
                }
                
                Generate-AllPDFThumbnails -Force:$forceGenerate
            }
        }
    }
    
    Write-Host "└──────────────────────────────────────────────────────────────────┘" -ForegroundColor Magenta
    Write-Host "`n" ("═" * 70) -ForegroundColor DarkGray
    Write-Host "`n┌─ WEB SERVER ─────────────────────────────────────────────────────┐" -ForegroundColor Green
    
    # Handle web server startup - skip prompt if parameter was explicitly specified
    $shouldStartServer = $DoStartServer -or $IsSilent  # Silent mode always starts server
    if (-not $IsSilent -and -not $StartServerSpecified) {
        $startServerChoice = Read-Host "│ Start web server? (Y/N)"
        Write-Host "└──────────────────────────────────────────────────────────────────┘" -ForegroundColor Green
        $shouldStartServer = ($startServerChoice -eq 'Y' -or $startServerChoice -eq 'y')
    }
    elseif ($StartServerSpecified -or $IsSilent) {
        Write-Host "│ Start server: $(if ($shouldStartServer) { 'Yes (auto)' } else { 'Skipped (parameter)' })" -ForegroundColor Gray
        Write-Host "└──────────────────────────────────────────────────────────────────┘" -ForegroundColor Green
    }
    
    if ($shouldStartServer) {
        Write-Host "`n[✓] Starting web server..." -ForegroundColor Green
        Start-PodeMediaServer -Port $CONFIG.ServerPort
    }
    else {
        Write-Host "`nTo start the server later, run: Start-PodeMediaServer" -ForegroundColor Gray
    }
}

# Auto-start if run directly
if ($MyInvocation.InvocationName -ne '.') {
    # Debug: Log the received parameters
    Write-NexusMLog "=== PARAMETER DEBUG ==="
    Write-NexusMLog "AutoScan.IsPresent: $($AutoScan.IsPresent)"
    Write-NexusMLog "NoScan.IsPresent: $($NoScan.IsPresent)"
    Write-NexusMLog "FetchPosters.IsPresent: $($FetchPosters.IsPresent)"
    Write-NexusMLog "NoPosters.IsPresent: $($NoPosters.IsPresent)"
    Write-NexusMLog "ExtractAlbumArt.IsPresent: $($ExtractAlbumArt.IsPresent)"
    Write-NexusMLog "NoAlbumArt.IsPresent: $($NoAlbumArt.IsPresent)"
    Write-NexusMLog "GeneratePDFThumbnails.IsPresent: $($GeneratePDFThumbnails.IsPresent)"
    Write-NexusMLog "NoPDFThumbnails.IsPresent: $($NoPDFThumbnails.IsPresent)"
    Write-NexusMLog "StartServer.IsPresent: $($StartServer.IsPresent)"
    Write-NexusMLog "NoServer.IsPresent: $($NoServer.IsPresent)"
    Write-NexusMLog "Silent.IsPresent: $($Silent.IsPresent)"
    Write-NexusMLog "======================="
    
    # Handle Silent mode
    if ($Silent) {
        Start-PSMediaLibrary -IsSilent $true
    }
    else {
        # Determine if each parameter was explicitly specified on command line
        # A parameter is "specified" if either the positive or negative switch was used
        $autoScanSpecified = $AutoScan.IsPresent -or $NoScan.IsPresent
        $fetchPostersSpecified = $FetchPosters.IsPresent -or $NoPosters.IsPresent
        $extractAlbumArtSpecified = $ExtractAlbumArt.IsPresent -or $NoAlbumArt.IsPresent
        $generatePDFThumbnailsSpecified = $GeneratePDFThumbnails.IsPresent -or $NoPDFThumbnails.IsPresent
        $startServerSpecified = $StartServer.IsPresent -or $NoServer.IsPresent
        
        # Determine the actual values (positive switch wins if both specified)
        $doAutoScan = $AutoScan.IsPresent -and -not $NoScan.IsPresent
        $doFetchPosters = $FetchPosters.IsPresent -and -not $NoPosters.IsPresent
        $doExtractAlbumArt = $ExtractAlbumArt.IsPresent -and -not $NoAlbumArt.IsPresent
        $doGeneratePDFThumbnails = $GeneratePDFThumbnails.IsPresent -and -not $NoPDFThumbnails.IsPresent
        $doStartServer = $StartServer.IsPresent -and -not $NoServer.IsPresent
        
        Write-NexusMLog "Computed values:"
        Write-NexusMLog "  autoScanSpecified: $autoScanSpecified, doAutoScan: $doAutoScan"
        Write-NexusMLog "  fetchPostersSpecified: $fetchPostersSpecified, doFetchPosters: $doFetchPosters"
        Write-NexusMLog "  extractAlbumArtSpecified: $extractAlbumArtSpecified, doExtractAlbumArt: $doExtractAlbumArt"
        Write-NexusMLog "  generatePDFThumbnailsSpecified: $generatePDFThumbnailsSpecified, doGeneratePDFThumbnails: $doGeneratePDFThumbnails"
        Write-NexusMLog "  startServerSpecified: $startServerSpecified, doStartServer: $doStartServer"
        
        Start-PSMediaLibrary `
            -DoAutoScan $doAutoScan `
            -AutoScanSpecified $autoScanSpecified `
            -DoFetchPosters $doFetchPosters `
            -FetchPostersSpecified $fetchPostersSpecified `
            -DoExtractAlbumArt $doExtractAlbumArt `
            -ExtractAlbumArtSpecified $extractAlbumArtSpecified `
            -DoGeneratePDFThumbnails $doGeneratePDFThumbnails `
            -GeneratePDFThumbnailsSpecified $generatePDFThumbnailsSpecified `
            -DoStartServer $doStartServer `
            -StartServerSpecified $startServerSpecified
    }
}
